<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/safari_pinned_tab.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css">
  <script src="//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.liaoheng.me","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="A developer">
<meta property="og:type" content="website">
<meta property="og:title" content="liaoheng&#96;s blog">
<meta property="og:url" content="https://blog.liaoheng.me/index.html">
<meta property="og:site_name" content="liaoheng&#96;s blog">
<meta property="og:description" content="A developer">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="liaoheng">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://blog.liaoheng.me/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>liaoheng`s blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-64FL8LWFL8"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-64FL8LWFL8');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="liaoheng`s blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">liaoheng`s blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/liaoheng" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.liaoheng.me/2024/02/21/android-ripple/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="liaoheng">
      <meta itemprop="description" content="A developer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liaoheng`s blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/02/21/android-ripple/" class="post-title-link" itemprop="url">Android Ripple(波纹效果)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-02-21 13:49:59 / 修改时间：14:11:49" itemprop="dateCreated datePublished" datetime="2024-02-21T13:49:59+08:00">2024-02-21</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>控件中的Ripple标签，即对应一个RippleDrawable，当它被设置为一个控件的background属性时，控件在按下时，即会显示水波效果</p>
</blockquote>
<h1 id="自定义"><a href="#自定义" class="headerlink" title="自定义"></a>自定义</h1><h2 id="没有边界的Ripple（Ripple-With-No-Mask）"><a href="#没有边界的Ripple（Ripple-With-No-Mask）" class="headerlink" title="没有边界的Ripple（Ripple With No Mask）"></a>没有边界的Ripple（Ripple With No Mask）</h2><p>波纹的内直径<code>就是</code>控件的长或者宽，实现内容如下，不需要任何操作即可。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ripple</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:color</span>=<span class="string">&quot;?attr/colorControlHighlight&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p><img data-src="https://pic.liaoheng.me/hc-pic/2024/02/fb5e3c11b575fa8e46d0847e7d3eea49.gif"></p>
<h2 id="有边界的Ripple（Ripple-With-Mask）"><a href="#有边界的Ripple（Ripple-With-Mask）" class="headerlink" title="有边界的Ripple（Ripple With Mask）"></a>有边界的Ripple（Ripple With Mask）</h2><p>波纹<code>不超过</code>控件的显示范围，实现内容如下，需要增加一个@android:id&#x2F;mask配置，配置中的颜色就是波纹的背景色，会与ripple颜色重叠显示。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ripple</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:color</span>=<span class="string">&quot;?attr/colorControlHighlight&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:id</span>=<span class="string">&quot;@android:id/mask&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">color</span> <span class="attr">android:color</span>=<span class="string">&quot;@color/white&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ripple</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img data-src="https://pic.liaoheng.me/hc-pic/2024/02/cb0c71e1f80ff24750032f3c05d2289c.gif"></p>
<h2 id="用图片作边界的Ripple（Ripple-With-Picture-Mask）"><a href="#用图片作边界的Ripple（Ripple-With-Picture-Mask）" class="headerlink" title="用图片作边界的Ripple（Ripple With Picture Mask）"></a>用图片作边界的Ripple（Ripple With Picture Mask）</h2><p>波纹<code>不超过</code>图片的显示范围，实现内容如下，需要增加一个@android:id&#x2F;mask配置，配置中的图片就是波纹的背景，会与ripple颜色重叠显示。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ripple</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:color</span>=<span class="string">&quot;?attr/colorControlHighlight&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:id</span>=<span class="string">&quot;@android:id/mask&quot;</span> <span class="attr">android:drawable</span>=<span class="string">&quot;@drawable/icon&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ripple</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img data-src="https://pic.liaoheng.me/hc-pic/2024/02/bd440efc6f351d0cb406b131a7c69e59.gif"></p>
<h2 id="用形状作边界的Ripple（Ripple-With-Shape-Mask）"><a href="#用形状作边界的Ripple（Ripple-With-Shape-Mask）" class="headerlink" title="用形状作边界的Ripple（Ripple With Shape Mask）"></a>用形状作边界的Ripple（Ripple With Shape Mask）</h2><p>波纹<code>不超过</code>形状的显示范围，实现内容如下，需要增加一个@android:id&#x2F;mask配置，配置中的形状就是波纹的背景，会与ripple颜色重叠显示。</p>
<ul>
<li>shape.xml<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">shape</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">android:shape</span>=<span class="string">&quot;rectangle&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">solid</span> <span class="attr">android:color</span>=<span class="string">&quot;#ff9d77&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">corners</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:bottomRightRadius</span>=<span class="string">&quot;100dp&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">shape</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ripple</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:color</span>=<span class="string">&quot;#FF0000&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@android:id/mask&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:drawable</span>=<span class="string">&quot;@drawable/shape&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ripple</span>&gt;</span></span><br></pre></td></tr></table></figure>
<img data-src="https://pic.liaoheng.me/hc-pic/2024/02/ae148630116fff2c868330bbcd1c8cbb.gif"></li>
</ul>
<h2 id="搭配selector作为Ripple（Ripple-With-Selector）"><a href="#搭配selector作为Ripple（Ripple-With-Selector）" class="headerlink" title="搭配selector作为Ripple（Ripple With Selector）"></a>搭配selector作为Ripple（Ripple With Selector）</h2><blockquote>
<p>如果在一个ripple标签中，添加一个item，在item的内部写上<selector>标签，那么这个RippleDrawable在按下的时候，同时具有水波效果和selector指定的图层。</p>
</blockquote>
<p>波纹<code>不超过</code>Selector的显示范围，实现内容如下，需要增加一个@android:id&#x2F;mask配置，配置中的Selector就是波纹的背景，会与ripple颜色重叠显示。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ripple</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:color</span>=<span class="string">&quot;#FF0000&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">selector</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:drawable</span>=<span class="string">&quot;@drawable/icon_p&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:state_pressed</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:drawable</span>=<span class="string">&quot;@drawable/icon_n&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:state_pressed</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">selector</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ripple</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img data-src="https://pic.liaoheng.me/hc-pic/2024/02/171202fd7e581ad3d0d53296332cedb9.gif"></p>
<h1 id="系统默认"><a href="#系统默认" class="headerlink" title="系统默认"></a>系统默认</h1><p>在控件中设置背景如下:</p>
<ul>
<li>有边界:<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ImageView</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:background</span>=<span class="string">&quot;?selectableItemBackground&quot;</span></span></span><br><span class="line"><span class="tag"> /&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>无边界:<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ImageView</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:background</span>=<span class="string">&quot;?selectableItemBackgroundBorderless&quot;</span></span></span><br><span class="line"><span class="tag"> /&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="selectableItemBackground"><a href="#selectableItemBackground" class="headerlink" title="selectableItemBackground"></a>selectableItemBackground</h2><p>文件位于：<br><code>/sdk/android/platforms/android-29/data/res/drawable/item_background_material.xml</code></p>
<p>文件内容如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ripple</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:color</span>=<span class="string">&quot;?attr/colorControlHighlight&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:id</span>=<span class="string">&quot;@id/mask&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">color</span> <span class="attr">android:color</span>=<span class="string">&quot;@color/white&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ripple</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>文件中的mask参数，用来控制波纹动画的背景或者说是边界，这里波纹动画只会在mask中显示，也就达到动画不超过控件的目的。</p>
<h2 id="selectableItemBackgroundBorderless"><a href="#selectableItemBackgroundBorderless" class="headerlink" title="selectableItemBackgroundBorderless"></a>selectableItemBackgroundBorderless</h2><p>文件位于：<br><code>/sdk/android/platforms/android-29/data/res/drawable/item_background_borderless_material.xml</code><br>文件内容如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ripple</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:color</span>=<span class="string">&quot;?attr/colorControlHighlight&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>文件中的没有mask参数，波纹动画效果会超过控件的大小。</p>
<h2 id="colorControlHighlight-attr-x2F-colorControlHighlight"><a href="#colorControlHighlight-attr-x2F-colorControlHighlight" class="headerlink" title="colorControlHighlight(?attr&#x2F;colorControlHighlight)"></a>colorControlHighlight(?attr&#x2F;colorControlHighlight)</h2><p>文件位于：<br><code>/sdk/android/platforms/android-29/data/res/color/ripple_material_light.xml</code>这里的light与<code>Theme.AppCompat.Light</code>有关。<br>文件内容如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">selector</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:alpha</span>=<span class="string">&quot;@dimen/highlight_alpha_material_light&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:color</span>=<span class="string">&quot;@color/foreground_material_light&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">selector</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/64654113/where-can-i-found-definition-for-selectableitembackgroundborderless-reference-at">where-can-i-found-definition-for-selectableitembackgroundborderless-reference-at</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.liaoheng.me/2022/04/11/traditional-bluetooth-protocol-stack-simple/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="liaoheng">
      <meta itemprop="description" content="A developer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liaoheng`s blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/11/traditional-bluetooth-protocol-stack-simple/" class="post-title-link" itemprop="url">传统蓝牙协议栈初探</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-11 17:05:36" itemprop="dateCreated datePublished" datetime="2022-04-11T17:05:36+08:00">2022-04-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-02-21 10:32:28" itemprop="dateModified" datetime="2024-02-21T10:32:28+08:00">2024-02-21</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>此文主要是简单的探索一下蓝牙电话和蓝牙音乐相关协议栈，所以很多细节并未涉及。</p>
<p>一般而言，我们把某个协议的实现代码称为协议栈(protocol stack)，要理解协议栈需要先了解蓝牙的核心系统架构，如下图：</p>
<p><img data-src="https://s1.ax1x.com/2022/04/11/LV6Ybd.png"></p>
<p>也可简单的<strong>抽象为3层</strong>：<img data-src="https://s1.ax1x.com/2022/04/11/LV6JDH.png"></p>
<ul>
<li>**User Application(Host)**：User Application即应用层，也被称为Host，我们调用Bluetooth API就属于应用层，例如，<a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/bluetooth/BluetoothAdapter.html">BluetoothAdapter</a>中提供的接口。</li>
<li><strong>HCI (Host controller Interface)<strong>：上层在调用蓝牙API时，</strong>不会直接操作蓝牙底层</strong>(Controller)相关接口，而是<strong>通过HCI下发对应操作的Command给Controller</strong>，然后底层执行命令后返回执行结果，<strong>即Controller发送Event给HCI，HCI再通知给应用层</strong>，HCI起到了一个<strong>中间层</strong>的作用。</li>
<li><strong>Controller</strong>：Controller是在最底层，硬件驱动。</li>
</ul>
<p>按照上面的定义，HCI与Host层中的协议实现就是<strong>蓝牙协议栈</strong>。</p>
<h2 id="HCI"><a href="#HCI" class="headerlink" title="HCI"></a>HCI</h2><blockquote>
<p> BLUETOOTH SPECIFICATION Version 4.2 [Vol 2, Part E] page 400  </p>
<p> HCI（HOST CONTROLLER INTERFACE）：主机控制层接口，主要负责透过transport把协议栈的数据发送给蓝牙芯片，并且接受来自蓝牙芯片的数据，数据主要分为HCI COMMAND(HOST-&gt;CONTROLLER),HCI EVENT(HOST&lt;-CONTROLLER),HCI ACL(HOST&lt;-&gt;CONTROLLER),HCI SCO(这个有点些微差异，因为部分芯片的SCO数据不是透过TRANSPORT直接跟HOST沟通，而是通过特殊的引脚，PCM IN&#x2F;OUT&#x2F;SYNC&#x2F;CLK脚来传输数据)</p>
</blockquote>
<p>HOST层的几乎所有数据最后都会通过HCI，所以我们通过HCI的日志就可以了解蓝牙协议栈中每个协议，手机中可以通过开发者模式打开HCI日志开关，推荐使用<strong>wireshark</strong>或者<strong>Frontline ComProbe Protocol Analysis System</strong>来分析HCI日志，下面给出来的的日志都是<strong>wireshark</strong>的结果。</p>
<p>HCI日志由各种数据包组成，我们需要了解其中的两种数据包如下：</p>
<h3 id="Command-数据包"><a href="#Command-数据包" class="headerlink" title="Command 数据包"></a>Command 数据包</h3><p>HCI Command数据包格式如下，开头的<strong>Opcode是区分不同类型的命令的唯一标识</strong>，Opcode由<strong>OpCode Group Field (OGF)</strong> 和 **OpCode Command Field (OCF)**组成。根据OGF的值，可以将HCI commands进行分类。OpCode 的计算公式为：<code>OpCode = OGF &lt;&lt; 6 + OCF</code> <strong>。有了OpCode计算的方式，我们就可以</strong>通过OpCode过滤HCI log里面的指定类型的HCI Command。</p>
<p><img data-src="https://s1.ax1x.com/2022/04/11/LV608f.png"></p>
<p>一次HCI Command指令发送完成，通常两条数据包，一条是host给controller的指令，一条是controller给host的指令反馈，可以确定指令发送是成功的。</p>
<h3 id="Event-数据包"><a href="#Event-数据包" class="headerlink" title="Event 数据包"></a>Event 数据包</h3><p>HCI Event 数据包由controller发送给Host，其中可以是蓝牙设备的消息也可以是连接的蓝牙设备的消息。</p>
<p><img data-src="https://s1.ax1x.com/2022/04/11/LV6B28.png"></p>
<h1 id="设备连接"><a href="#设备连接" class="headerlink" title="设备连接"></a>设备连接</h1><h2 id="蓝牙设备状态"><a href="#蓝牙设备状态" class="headerlink" title="蓝牙设备状态"></a>蓝牙设备状态</h2><blockquote>
<p>BLUETOOTH SPECIFICATION Version 4.2 [Vol 2, Part B] page 159  </p>
</blockquote>
<p>扫描设备然后与之建立连接是蓝牙工作流程的第一步，所以先要了解一下蓝牙的状态如下图：</p>
<p><img data-src="https://s1.ax1x.com/2022/04/11/LV6wPP.png"></p>
<p>从<u>蓝牙状态转换图</u>中可以看出 STANDBY状体是蓝牙设备的默认状态。</p>
<p><strong>Page</strong>：这个子状态就是我们通常称为的连接(寻呼)，进行连接&#x2F;激活对应的slave的操作我们就称为page。</p>
<p><strong>Page scan</strong>：这个子状态是和page对应的，它就是等待被page的slave所处的状态，换句话说，若想被page到，我们就要处于page scan的状态。</p>
<p><strong>inquiry</strong>：这就是我们通常所说的扫描状态，这个状态的设备就是去扫描周围的设备。</p>
<p><strong>inquiry scan</strong>：这就是我们通常看到的可被发现的设备。体现在上层就是我们在android系统中点击设备可被周围什么发现，那设备就处于这样的状态。</p>
<h2 id="逻辑链路传输协议"><a href="#逻辑链路传输协议" class="headerlink" title="逻辑链路传输协议"></a>逻辑链路传输协议</h2><h3 id="ACL"><a href="#ACL" class="headerlink" title="ACL"></a>ACL</h3><blockquote>
<p>BLUETOOTH SPECIFICATION Version 4.2 [Vol 1, Part A]  page  63  </p>
<p>The asynchronous connection-oriented (ACL) logical transport is used to carry<br>LMP and L2CAP control signaling and best effort asynchronous user data. The<br>ACL logical transport uses a 1-bit ARQN&#x2F;SEQN scheme to provide simple<br>channel reliability. Every active slave device within a piconet has one ACL<br>logical transport to the piconet master, known as the default ACL.  </p>
</blockquote>
<p>ACL全称<strong>BR&#x2F;EDR Asynchronous Connection-oriented</strong>，定向连接，它既支持对称连接，也支持不对称连接（既可以一对一，也可以一对多）。主设备负责控制链路带宽，并决定微微网中的每个从设备可以占用多少带宽和连接的对称性。从设备只有被选中时才能传送数据。ACL链路也支持接收主设备发给微微网中所有从设备的广播消息。</p>
<p>建立ACL需要设备HCI之间进行的下面的操作，这个也与<strong>蓝牙状态</strong>息息相关。</p>
<h4 id="开始扫描"><a href="#开始扫描" class="headerlink" title="开始扫描"></a>开始扫描</h4><ul>
<li><p><strong>Host</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LocalBluetoothManager.getInstance().getBluetoothAdapter().startScanning(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Controller</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">#发送扫描指令</span><br><span class="line">&gt; 103	4.351128	host	controller	HCI_CMD	9	Sent Inquiry</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Command - Inquiry</span><br><span class="line">    Command Opcode: Inquiry (0x0401)</span><br><span class="line">        0000 01.. .... .... = Opcode Group Field: Link Control Commands (0x01)</span><br><span class="line">        .... ..00 0000 0001 = Opcode Command Field: Inquiry (0x001)</span><br><span class="line">    Parameter Total Length: 5</span><br><span class="line">    LAP: 0x9e8b33</span><br><span class="line">    Inquiry Length: 10 (12.8 sec)</span><br><span class="line">    Num Responses: 0</span><br><span class="line">    [Pending in frame: 104]</span><br><span class="line">    [Command-Pending Delta: 0.846ms]</span><br><span class="line">    [Response in frame: 429]</span><br><span class="line">    [Command-Response Delta: 12811.07ms]</span><br><span class="line"></span><br><span class="line">#HCI反馈扫描指令状态</span><br><span class="line">&gt; 104	4.351974	controller	host	HCI_EVT	7	Rcvd Command Status (Inquiry)</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Event - Command Status</span><br><span class="line">    Event Code: Command Status (0x0f)</span><br><span class="line">    Parameter Total Length: 4</span><br><span class="line">    Status: Pending (0x00)</span><br><span class="line">    Number of Allowed Command Packets: 1</span><br><span class="line">    Command Opcode: Inquiry (0x0401)</span><br><span class="line">    [Command in frame: 103]</span><br><span class="line">    [Response in frame: 429]</span><br><span class="line">    [Command-Pending Delta: 0.846ms]</span><br><span class="line">    [Pending-Response Delta: 12810.224ms]</span><br><span class="line"></span><br><span class="line">#HCI发送的扫描到的设备信息</span><br><span class="line">&gt; 114	4.505582	controller	host	HCI_EVT	258	Rcvd Extended Inquiry Result</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Event - Extended Inquiry Result</span><br><span class="line">    Event Code: Extended Inquiry Result (0x2f)</span><br><span class="line">    Parameter Total Length: 255</span><br><span class="line">    Number of responses: 1</span><br><span class="line">    BD_ADDR: XiaomiCo_77:c2:35 (00:00:00:00:00:00)</span><br><span class="line">    Page Scan Repetition Mode: R1 (0x01)</span><br><span class="line">    Reserved: 0x02</span><br><span class="line">    Class of Device: 0x5a020c (Phone:Smartphone - services: Networking Capturing ObjectTransfer Telephony)</span><br><span class="line">    .000 0000 0011 0100 = Clock Offset: 0x0034</span><br><span class="line">    RSSI: -88 dBm</span><br><span class="line">    Extended Inquiry Response Data</span><br><span class="line">        Device Name: +My Phone1234567890123456789012</span><br><span class="line">        16-bit Service Class UUIDs</span><br><span class="line">        32-bit Service Class UUIDs</span><br><span class="line">        128-bit Service Class UUIDs</span><br><span class="line">        Unused</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="停止扫描"><a href="#停止扫描" class="headerlink" title="停止扫描"></a>停止扫描</h4><ul>
<li><p><strong>Host</strong>:</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LocalBluetoothManager.getInstance().getBluetoothAdapter().stopScanning();</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Controller</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&gt; 85	2.202129	host	controller	HCI_CMD	4	Sent Inquiry Cancel</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Command - Inquiry Cancel</span><br><span class="line">    Command Opcode: Inquiry Cancel (0x0402)</span><br><span class="line">        0000 01.. .... .... = Opcode Group Field: Link Control Commands (0x01)</span><br><span class="line">        .... ..00 0000 0010 = Opcode Command Field: Inquiry Cancel (0x002)</span><br><span class="line">    Parameter Total Length: 0</span><br><span class="line">    [Response in frame: 86]</span><br><span class="line">    [Command-Response Delta: 2.051ms]</span><br><span class="line"></span><br><span class="line">&gt; 86	2.204180	controller	host	HCI_EVT	7	Rcvd Command Complete (Inquiry Cancel)</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Event - Command Complete</span><br><span class="line">    Event Code: Command Complete (0x0e)</span><br><span class="line">    Parameter Total Length: 4</span><br><span class="line">    Number of Allowed Command Packets: 1</span><br><span class="line">    Command Opcode: Inquiry Cancel (0x0402)</span><br><span class="line">    Status: Success (0x00)</span><br><span class="line">    [Command in frame: 85]</span><br><span class="line">    [Command-Response Delta: 2.051ms]</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="完成扫描"><a href="#完成扫描" class="headerlink" title="完成扫描"></a>完成扫描</h4><ul>
<li><p><strong>Host</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LocalBluetoothManager.getInstance().getEventManager().registerCallback(<span class="keyword">new</span> <span class="title class_">BluetoothCallback</span>() &#123;</span><br><span class="line">   		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onScanningStateChanged</span><span class="params">(<span class="type">boolean</span> started)</span> &#123;</span><br><span class="line">		&#125; </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Controller</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; 429	17.162198	controller	host	HCI_EVT	4	Rcvd Inquiry Complete</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Event - Inquiry Complete</span><br><span class="line">    Event Code: Inquiry Complete (0x01)</span><br><span class="line">    Parameter Total Length: 1</span><br><span class="line">    Status: Success (0x00)</span><br><span class="line">    [Command in frame: 103]</span><br><span class="line">    [Pending in frame: 104]</span><br><span class="line">    [Pending-Response Delta: 12810.224ms]</span><br><span class="line">    [Command-Response Delta: 12811.07ms]</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="设备配对"><a href="#设备配对" class="headerlink" title="设备配对"></a>设备配对</h4><p><img data-src="https://s1.ax1x.com/2022/04/11/LV6GKe.png"></p>
<h5 id="配对"><a href="#配对" class="headerlink" title="配对"></a>配对</h5><ul>
<li><p><strong>Host</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CachedBluetoothDevice.startPairing();</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Controller</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line">#删除需要连接设备本地记忆的Link Key</span><br><span class="line">&gt; 685	33.812149	host	controller	HCI_CMD	11	Sent Delete Stored Link Key</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Command - Delete Stored Link Key</span><br><span class="line">    Command Opcode: Delete Stored Link Key (0x0c12)</span><br><span class="line">        0000 11.. .... .... = Opcode Group Field: Host Controller &amp; Baseband Commands (0x03)</span><br><span class="line">        .... ..00 0001 0010 = Opcode Command Field: Delete Stored Link Key (0x012)</span><br><span class="line">    Parameter Total Length: 7</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line">    Delete All Flag: Delete only Link Key for specified BD_ADDR (0x00)</span><br><span class="line">    [Response in frame: 686]</span><br><span class="line">    [Command-Response Delta: 2.147ms]</span><br><span class="line"></span><br><span class="line">#建立ACL连接</span><br><span class="line">&gt; 687	33.814531	host	controller	HCI_CMD	17	Sent Create Connection</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Command - Create Connection</span><br><span class="line">    Command Opcode: Create Connection (0x0405)</span><br><span class="line">    Parameter Total Length: 13</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line">    Packet Type: 0xcc18, DH5, DM5, DH3, DM3, DH1, DM1</span><br><span class="line">    Page Scan Repetition Mode: R1 (0x01)</span><br><span class="line">    Page Scan Mode: Mandatory Page Scan Mode (0x00)</span><br><span class="line">    .000 0010 0000 1000 = Clock Offset: 0x0208 (650 msec)</span><br><span class="line">    1... .... .... .... = Clock_Offset_Valid_Flag: true (1)</span><br><span class="line">    Allow Role Switch: Local device may be master, or may become slave after accepting a master slave switch. (0x01)</span><br><span class="line">    [Pending in frame: 688]</span><br><span class="line">    [Command-Pending Delta: 0.965ms]</span><br><span class="line">    [Response in frame: 690]</span><br><span class="line">    [Command-Response Delta: 1118.609ms]</span><br><span class="line"></span><br><span class="line">#建立ACL连接成功</span><br><span class="line">&gt; 690	34.933140	controller	host	HCI_EVT	14	Rcvd Connect Complete</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Event - Connect Complete</span><br><span class="line">    Event Code: Connect Complete (0x03)</span><br><span class="line">    Parameter Total Length: 11</span><br><span class="line">    Status: Success (0x00)</span><br><span class="line">    Connection Handle: 0x0033</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line">    Link Type: ACL connection (Data Channels) (0x01)</span><br><span class="line">    Encryption Mode: Encryption Disabled (0x00)</span><br><span class="line">    [Command in frame: 687]</span><br><span class="line">    [Pending in frame: 688]</span><br><span class="line">    [Pending-Response Delta: 1117.644ms]</span><br><span class="line">    [Command-Response Delta: 1118.609ms]</span><br><span class="line"></span><br><span class="line">#改变当前设备的角色，这里当前设备为从(Slave)，连接设备为主(Master)</span><br><span class="line">&gt; 689	34.929964	controller	host	HCI_EVT	11	Rcvd Role Change</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Event - Role Change</span><br><span class="line">    Event Code: Role Change (0x12)</span><br><span class="line">    Parameter Total Length: 8</span><br><span class="line">    Status: Success (0x00)</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line">    Role: Currently the Slave for specified BD_ADDR (0x01)</span><br><span class="line"></span><br><span class="line">#与设备建立连接之后，准备开始验证</span><br><span class="line">&gt; 697	34.935615	host	controller	HCI_CMD	6	Sent Authentication Requested</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Command - Authentication Requested</span><br><span class="line">    Command Opcode: Authentication Requested (0x0411)</span><br><span class="line">    Parameter Total Length: 2</span><br><span class="line">    Connection Handle: 0x0033</span><br><span class="line">    [Pending in frame: 699]</span><br><span class="line">    [Command-Pending Delta: 0.917ms]</span><br><span class="line">    [Response in frame: 743]</span><br><span class="line">    [Command-Response Delta: 4291.694ms]</span><br><span class="line"></span><br><span class="line">#连接设备询问Link Key</span><br><span class="line">&gt; 701	34.936976	controller	host	HCI_EVT	9	Rcvd Link Key Request</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Event - Link Key Request</span><br><span class="line">    Event Code: Link Key Request (0x17)</span><br><span class="line">    Parameter Total Length: 6</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line"></span><br><span class="line">#当前设备无Link Key，也就是未于连接设备配对过</span><br><span class="line">&gt; 705	34.938603	host	controller	HCI_CMD	10	Sent Link Key Request Negative Reply</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Command - Link Key Request Negative Reply</span><br><span class="line">    Command Opcode: Link Key Request Negative Reply (0x040c)</span><br><span class="line">        0000 01.. .... .... = Opcode Group Field: Link Control Commands (0x01)</span><br><span class="line">        .... ..00 0000 1100 = Opcode Command Field: Link Key Request Negative Reply (0x00c)</span><br><span class="line">    Parameter Total Length: 6</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line">    [Response in frame: 706]</span><br><span class="line">    [Command-Response Delta: 0.87ms]</span><br><span class="line"></span><br><span class="line">#使用的配对方式是`简单安全配对`SSP(Simple Secure Pairng), 就是直接弹配对码</span><br><span class="line"></span><br><span class="line">#连接设备询问当前设备的IO能力</span><br><span class="line">&gt; 707	34.939729	controller	host	HCI_EVT	9	Rcvd IO Capability Request</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Event - IO Capability Request</span><br><span class="line">    Event Code: IO Capability Request (0x31)</span><br><span class="line">    Parameter Total Length: 6</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line"></span><br><span class="line">#回复当前设备的IO能力</span><br><span class="line">&gt;708	34.939897	host	controller	HCI_CMD	13	Sent IO Capability Request Reply</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Command - IO Capability Request Reply</span><br><span class="line">    Command Opcode: IO Capability Request Reply (0x042b)</span><br><span class="line">        0000 01.. .... .... = Opcode Group Field: Link Control Commands (0x01)</span><br><span class="line">        .... ..00 0010 1011 = Opcode Command Field: IO Capability Request Reply (0x02b)</span><br><span class="line">    Parameter Total Length: 9</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line">    IO Capability: Display Yes/No (1)</span><br><span class="line">    OOB Data Present: OOB Authentication Data Not Present (0)</span><br><span class="line">    Authentication Requirements: MITM Protection Required - Dedicated Bonding. Use IO Capability To Determine Procedure, No Secure Connection (3)</span><br><span class="line">    [Response in frame: 709]</span><br><span class="line">    [Command-Response Delta: 0.811ms]</span><br><span class="line"></span><br><span class="line">######其它参数同步</span><br><span class="line"></span><br><span class="line">#连接设备的IO能力，io能力参数为Display Yes/No (0x01)，需要用户确认</span><br><span class="line">&gt; 737	36.532369	controller	host	HCI_EVT	12	Rcvd IO Capability Response</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Event - IO Capability Response</span><br><span class="line">    Event Code: IO Capability Response (0x32)</span><br><span class="line">    Parameter Total Length: 9</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line">    IO Capability: Display Yes/No (0x01)</span><br><span class="line">    OOB Data Present: OOB Authentication Data Not Present (0)</span><br><span class="line">    Authentication Requirements: MITM Protection Required - Dedicated Bonding. Use IO Capability To Determine Procedure, No Secure Connection (3)</span><br><span class="line"></span><br><span class="line">#当前设备接收到配对码信息，Numeric Value就是显示的配对码</span><br><span class="line">&gt; 738	37.066181	controller	host	HCI_EVT	13	Rcvd User Confirmation Request</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Event - User Confirmation Request</span><br><span class="line">    Event Code: User Confirmation Request (0x33)</span><br><span class="line">    Parameter Total Length: 10</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line">    Numeric Value: 446514</span><br><span class="line"></span><br><span class="line">#回复连接设备已接收到配对码信息</span><br><span class="line">&gt; 739	37.096306	host	controller	HCI_CMD	10	Sent User Confirmation Request Reply</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Command - User Confirmation Request Reply</span><br><span class="line">    Command Opcode: User Confirmation Request Reply (0x042c)</span><br><span class="line">        0000 01.. .... .... = Opcode Group Field: Link Control Commands (0x01)</span><br><span class="line">        .... ..00 0010 1100 = Opcode Command Field: User Confirmation Request Reply (0x02c)</span><br><span class="line">    Parameter Total Length: 6</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line">    [Response in frame: 740]</span><br><span class="line">    [Command-Response Delta: 1.46ms]</span><br><span class="line"></span><br><span class="line">#连接设备SSP验证成功</span><br><span class="line">&gt; 741	39.215747	controller	host	HCI_EVT	10	Rcvd Simple Pairing Complete</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Event - Simple Pairing Complete</span><br><span class="line">    Event Code: Simple Pairing Complete (0x36)</span><br><span class="line">    Parameter Total Length: 7</span><br><span class="line">    Status: Success (0x00)</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line"></span><br><span class="line">#连接设备的Link Key，需要保存，用于下次连接</span><br><span class="line">&gt; 742	39.226970	controller	host	HCI_EVT	26	Rcvd Link Key Notification</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Event - Link Key Notification</span><br><span class="line">    Event Code: Link Key Notification (0x18)</span><br><span class="line">    Parameter Total Length: 23</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line">    Link Key: bc31fb070e91eec2f2296fbf9bc8b518</span><br><span class="line">    Key Type: Unknown (0x08)</span><br><span class="line"></span><br><span class="line">#验证完成</span><br><span class="line">&gt; 743	39.227309	controller	host	HCI_EVT	6	Rcvd Authentication Complete</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Event - Authentication Complete</span><br><span class="line">    Event Code: Authentication Complete (0x06)</span><br><span class="line">    Parameter Total Length: 3</span><br><span class="line">    Status: Success (0x00)</span><br><span class="line">    Connection Handle: 0x0033</span><br><span class="line">    [Command in frame: 697]</span><br><span class="line">    [Pending in frame: 699]</span><br><span class="line">    [Pending-Response Delta: 4290.777ms]</span><br><span class="line">    [Command-Response Delta: 4291.694ms]</span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="被配对"><a href="#被配对" class="headerlink" title="被配对"></a>被配对</h5><ul>
<li><p><strong>Host</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LocalBluetoothManager.getInstance().getEventManager().registerCallback(<span class="keyword">new</span> <span class="title class_">BluetoothCallback</span>() &#123;</span><br><span class="line">   		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onDeviceBondStateChanged</span><span class="params">(CachedBluetoothDevice cachedDevice, <span class="type">int</span> bondState)</span> &#123;</span><br><span class="line">		&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Controller</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">#请求ACL连接</span><br><span class="line">&gt; 326	21.946869	controller	host	HCI_EVT	13	Rcvd Connect Request</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Event - Connect Request</span><br><span class="line">    Event Code: Connect Request (0x04)</span><br><span class="line">    Parameter Total Length: 10</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line">    Class of Device: 0x5a020c (Phone:Smartphone - services: Networking Capturing ObjectTransfer Telephony)</span><br><span class="line">    Link Type: ACL connection (Data Channels) (0x01)</span><br><span class="line"></span><br><span class="line">#允许ACL连接</span><br><span class="line">&gt; 327	21.947178	host	controller	HCI_CMD	11	Sent Accept Connection Request</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Command - Accept Connection Request</span><br><span class="line">    Command Opcode: Accept Connection Request (0x0409)</span><br><span class="line">    Parameter Total Length: 7</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line">    Role: Remain the Slave for this connection. The LM will NOT perform the role switch. (0x01)</span><br><span class="line">    [Pending in frame: 328]</span><br><span class="line">    [Command-Pending Delta: 0.685ms]</span><br><span class="line">    [Response in frame: 329]</span><br><span class="line">    [Command-Response Delta: 4.432ms]</span><br><span class="line"></span><br><span class="line">#ACL连接成功</span><br><span class="line">&gt; 329	21.951610	controller	host	HCI_EVT	14	Rcvd Connect Complete</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Event - Connect Complete</span><br><span class="line">    Event Code: Connect Complete (0x03)</span><br><span class="line">    Parameter Total Length: 11</span><br><span class="line">    Status: Success (0x00)</span><br><span class="line">    Connection Handle: 0x0033</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line">    Link Type: ACL connection (Data Channels) (0x01)</span><br><span class="line">    Encryption Mode: Encryption Disabled (0x00)</span><br><span class="line">    [Command in frame: 327]</span><br><span class="line">    [Pending in frame: 328]</span><br><span class="line">    [Pending-Response Delta: 3.747ms]</span><br><span class="line">    [Command-Response Delta: 4.432ms]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; 370	22.259461	controller	host	HCI_EVT	12	Rcvd IO Capability Response</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Event - IO Capability Response</span><br><span class="line">    Event Code: IO Capability Response (0x32)</span><br><span class="line">    Parameter Total Length: 9</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line">    IO Capability: Display Yes/No (0x01)</span><br><span class="line">    OOB Data Present: OOB Authentication Data Not Present (0)</span><br><span class="line">    Authentication Requirements: MITM Protection Required - Dedicated Bonding. Use IO Capability To Determine Procedure, No Secure Connection (3)</span><br><span class="line"></span><br><span class="line">&gt; 371	22.259809	controller	host	HCI_EVT	9	Rcvd IO Capability Request</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Event - IO Capability Request</span><br><span class="line">    Event Code: IO Capability Request (0x31)</span><br><span class="line">    Parameter Total Length: 6</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line"></span><br><span class="line">&gt; 372	22.259982	host	controller	HCI_CMD	13	Sent IO Capability Request Reply</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Command - IO Capability Request Reply</span><br><span class="line">    Command Opcode: IO Capability Request Reply (0x042b)</span><br><span class="line">    Parameter Total Length: 9</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line">    IO Capability: Display Yes/No (1)</span><br><span class="line">    OOB Data Present: OOB Authentication Data Not Present (0)</span><br><span class="line">    Authentication Requirements: MITM Protection Required - Dedicated Bonding. Use IO Capability To Determine Procedure, No Secure Connection (3)</span><br><span class="line">    [Response in frame: 373]</span><br><span class="line">    [Command-Response Delta: 0.619ms]</span><br><span class="line"></span><br><span class="line">&gt; 374	22.958223	controller	host	HCI_EVT	13	Rcvd User Confirmation Request</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Event - User Confirmation Request</span><br><span class="line">    Event Code: User Confirmation Request (0x33)</span><br><span class="line">    Parameter Total Length: 10</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line">    Numeric Value: 804568</span><br><span class="line"></span><br><span class="line">&gt; 375	23.069385	host	controller	HCI_CMD	10	Sent User Confirmation Request Reply</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Command - User Confirmation Request Reply</span><br><span class="line">    Command Opcode: User Confirmation Request Reply (0x042c)</span><br><span class="line">    Parameter Total Length: 6</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line">    [Response in frame: 376]</span><br><span class="line">    [Command-Response Delta: 1.81ms]</span><br><span class="line"></span><br><span class="line">#连接设备SSP验证成功</span><br><span class="line">&gt; 377	26.919540	controller	host	HCI_EVT	10	Rcvd Simple Pairing Complete</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Event - Simple Pairing Complete</span><br><span class="line">    Event Code: Simple Pairing Complete (0x36)</span><br><span class="line">    Parameter Total Length: 7</span><br><span class="line">    Status: Success (0x00)</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line"></span><br><span class="line">#连接设备的Link Key，需要保存，用于下次连接</span><br><span class="line">&gt; 378	26.926691	controller	host	HCI_EVT	26	Rcvd Link Key Notification</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Event - Link Key Notification</span><br><span class="line">    Event Code: Link Key Notification (0x18)</span><br><span class="line">    Parameter Total Length: 23</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line">    Link Key: 2160acf6b7403a97050f64de72570b1d</span><br><span class="line">    Key Type: Unknown (0x08)</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="设备连接-1"><a href="#设备连接-1" class="headerlink" title="设备连接"></a>设备连接</h4><p><img data-src="https://s1.ax1x.com/2022/04/11/LV63vD.png"></p>
<h5 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h5><ul>
<li><p><strong>Host</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CachedBluetoothDevice.conntect(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Controller</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">&gt; 1214	47.023224	host	controller	HCI_CMD	17	Sent Create Connection</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Command - Create Connection</span><br><span class="line">    Command Opcode: Create Connection (0x0405)</span><br><span class="line">    Parameter Total Length: 13</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line">    Packet Type: 0xcc18, DH5, DM5, DH3, DM3, DH1, DM1</span><br><span class="line">    Page Scan Repetition Mode: R1 (0x01)</span><br><span class="line">    Page Scan Mode: Mandatory Page Scan Mode (0x00)</span><br><span class="line">    .011 1001 0100 0100 = Clock Offset: 0x3944 (18325 msec)</span><br><span class="line">    1... .... .... .... = Clock_Offset_Valid_Flag: true (1)</span><br><span class="line">    Allow Role Switch: Local device may be master, or may become slave after accepting a master slave switch. (0x01)</span><br><span class="line">    [Pending in frame: 1215]</span><br><span class="line">    [Command-Pending Delta: 1.458ms]</span><br><span class="line">    [Response in frame: 1217]</span><br><span class="line">    [Command-Response Delta: 1630.81ms]</span><br><span class="line"></span><br><span class="line">&gt; 1216	48.646874	controller	host	HCI_EVT	11	Rcvd Role Change</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Event - Role Change</span><br><span class="line">    Event Code: Role Change (0x12)</span><br><span class="line">    Parameter Total Length: 8</span><br><span class="line">    Status: Success (0x00)</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line">    Role: Currently the Slave for specified BD_ADDR (0x01)</span><br><span class="line"></span><br><span class="line">&gt; 1217	48.654034	controller	host	HCI_EVT	14	Rcvd Connect Complete</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Event - Connect Complete</span><br><span class="line">    Event Code: Connect Complete (0x03)</span><br><span class="line">    Parameter Total Length: 11</span><br><span class="line">    Status: Success (0x00)</span><br><span class="line">    Connection Handle: 0x0033</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line">    Link Type: ACL connection (Data Channels) (0x01)</span><br><span class="line">    Encryption Mode: Encryption Disabled (0x00)</span><br><span class="line">    [Command in frame: 1214]</span><br><span class="line">    [Pending in frame: 1215]</span><br><span class="line">    [Pending-Response Delta: 1629.352ms]</span><br><span class="line">    [Command-Response Delta: 1630.81ms]</span><br><span class="line"></span><br><span class="line">&gt; 1278	48.812485	host	controller	HCI_CMD	6	Sent Authentication Requested</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Command - Authentication Requested</span><br><span class="line">    Command Opcode: Authentication Requested (0x0411)</span><br><span class="line">    Parameter Total Length: 2</span><br><span class="line">    Connection Handle: 0x0033</span><br><span class="line">    [Pending in frame: 1279]</span><br><span class="line">    [Command-Pending Delta: 0.945ms]</span><br><span class="line">    [Response in frame: 1283]</span><br><span class="line">    [Command-Response Delta: 16.693ms]</span><br><span class="line"></span><br><span class="line">&gt; 1280	48.813892	controller	host	HCI_EVT	9	Rcvd Link Key Request</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Event - Link Key Request</span><br><span class="line">    Event Code: Link Key Request (0x17)</span><br><span class="line">    Parameter Total Length: 6</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line"></span><br><span class="line">&gt; 1281	48.814039	host	controller	HCI_CMD	26	Sent Link Key Request Reply</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Command - Link Key Request Reply</span><br><span class="line">    Command Opcode: Link Key Request Reply (0x040b)</span><br><span class="line">    Parameter Total Length: 22</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line">    Link Key: 2160acf6b7403a97050f64de72570b1d</span><br><span class="line">    [Response in frame: 1282]</span><br><span class="line">    [Command-Response Delta: 1.336ms]</span><br><span class="line"></span><br><span class="line">&gt; 1282	48.815375	controller	host	HCI_EVT	13	Rcvd Command Complete (Link Key Request Reply)</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Event - Command Complete</span><br><span class="line">    Event Code: Command Complete (0x0e)</span><br><span class="line">    Parameter Total Length: 10</span><br><span class="line">    Number of Allowed Command Packets: 1</span><br><span class="line">    Command Opcode: Link Key Request Reply (0x040b)</span><br><span class="line">    Status: Success (0x00)</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line">    [Command in frame: 1281]</span><br><span class="line">    [Command-Response Delta: 1.336ms]</span><br><span class="line"></span><br><span class="line">&gt; 1283	48.829178	controller	host	HCI_EVT	6	Rcvd Authentication Complete</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Event - Authentication Complete</span><br><span class="line">    Event Code: Authentication Complete (0x06)</span><br><span class="line">    Parameter Total Length: 3</span><br><span class="line">    Status: Success (0x00)</span><br><span class="line">    Connection Handle: 0x0033</span><br><span class="line">    [Command in frame: 1278]</span><br><span class="line">    [Pending in frame: 1279]</span><br><span class="line">    [Pending-Response Delta: 15.748ms]</span><br><span class="line">    [Command-Response Delta: 16.693ms]</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="被连接"><a href="#被连接" class="headerlink" title="被连接"></a>被连接</h5><ul>
<li><p><strong>Host</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LocalBluetoothManager.getInstance().getEventManager().registerCallback(<span class="keyword">new</span> <span class="title class_">BluetoothCallback</span>() &#123;</span><br><span class="line">   		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onConnectionStateChanged</span><span class="params">(CachedBluetoothDevice cachedDevice, <span class="type">int</span> bondState)</span> &#123;</span><br><span class="line">		&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Controller</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">&gt; 1900	62.151696	controller	host	HCI_EVT	13	Rcvd Connect Request</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Event - Connect Request</span><br><span class="line">    Event Code: Connect Request (0x04)</span><br><span class="line">    Parameter Total Length: 10</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line">    Class of Device: 0x5a020c (Phone:Smartphone - services: Networking Capturing ObjectTransfer Telephony)</span><br><span class="line">    Link Type: ACL connection (Data Channels) (0x01)</span><br><span class="line"></span><br><span class="line">&gt; 1901	62.152042	host	controller	HCI_CMD	11	Sent Accept Connection Request</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Command - Accept Connection Request</span><br><span class="line">    Command Opcode: Accept Connection Request (0x0409)</span><br><span class="line">    Parameter Total Length: 7</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line">    Role: Remain the Slave for this connection. The LM will NOT perform the role switch. (0x01)</span><br><span class="line">    [Pending in frame: 1902]</span><br><span class="line">    [Command-Pending Delta: 0.748ms]</span><br><span class="line">    [Response in frame: 1903]</span><br><span class="line">    [Command-Response Delta: 4.455ms]</span><br><span class="line"></span><br><span class="line">&gt; 1903	62.156497	controller	host	HCI_EVT	14	Rcvd Connect Complete</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Event - Connect Complete</span><br><span class="line">    Event Code: Connect Complete (0x03)</span><br><span class="line">    Parameter Total Length: 11</span><br><span class="line">    Status: Success (0x00)</span><br><span class="line">    Connection Handle: 0x0032</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line">    Link Type: ACL connection (Data Channels) (0x01)</span><br><span class="line">    Encryption Mode: Encryption Disabled (0x00)</span><br><span class="line">    [Command in frame: 1901]</span><br><span class="line">    [Pending in frame: 1902]</span><br><span class="line">    [Pending-Response Delta: 3.707ms]</span><br><span class="line">    [Command-Response Delta: 4.455ms]</span><br><span class="line"></span><br><span class="line">&gt; 1968	62.415419	controller	host	HCI_EVT	9	Rcvd Link Key Request</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Event - Link Key Request</span><br><span class="line">    Event Code: Link Key Request (0x17)</span><br><span class="line">    Parameter Total Length: 6</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line"></span><br><span class="line">&gt; 1969	62.415629	host	controller	HCI_CMD	26	Sent Link Key Request Reply</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Command - Link Key Request Reply</span><br><span class="line">    Command Opcode: Link Key Request Reply (0x040b)</span><br><span class="line">    Parameter Total Length: 22</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line">    Link Key: 2160acf6b7403a97050f64de72570b1d</span><br><span class="line">    [Response in frame: 1971]</span><br><span class="line">    [Command-Response Delta: 0.934ms]</span><br><span class="line"></span><br><span class="line">&gt; 1971	62.416563	controller	host	HCI_EVT	13	Rcvd Command Complete (Link Key Request Reply)</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Event - Command Complete</span><br><span class="line">    Event Code: Command Complete (0x0e)</span><br><span class="line">    Parameter Total Length: 10</span><br><span class="line">    Number of Allowed Command Packets: 1</span><br><span class="line">    Command Opcode: Link Key Request Reply (0x040b)</span><br><span class="line">    Status: Success (0x00)</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line">    [Command in frame: 1969]</span><br><span class="line">    [Command-Response Delta: 0.934ms]</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="SCO"><a href="#SCO" class="headerlink" title="SCO"></a>SCO</h3><blockquote>
<p>BLUETOOTH SPECIFICATION Version 4.2 [Vol 1, Part A] page 64  </p>
<p>The synchronous connection-oriented (SCO) logical transport is a symmetric,<br>point-to-point transport between the master and a specific slave. The SCO<br>logical transport reserves slots on the physical channel and can therefore be<br>considered as a circuit-switched connection between the master and the slave.<br>SCO logical transports carry 64 kb&#x2F;s of information synchronized with the<br>piconet clock. Typically this information is an encoded voice stream. Three<br>different SCO configurations exist, offering a balance between robustness,<br>delay and bandwidth consumption.  </p>
</blockquote>
<p>SCO全称<strong>BR&#x2F;EDR Synchronous Connection-Oriented</strong>，利用保留时隙传送数据包。连接建立后，主设备和从设备可以不被选中就发送SCO数据包。SCO数据包既可以传送话音，也可以传送数据，但在传送数据时，只用于重发被损坏的那部分的数据。</p>
<h3 id="L2CAP"><a href="#L2CAP" class="headerlink" title="L2CAP"></a>L2CAP</h3><blockquote>
<p>BLUETOOTH SPECIFICATION Version 4.2 [Vol 3, Part A] page 30  </p>
<p>L2CAP（Logical Link Control and Adaptation Protocol）：逻辑链路控制与适配协议，将ACL数据分组交换为便于高层应用的数据分组格式，并提供协议复用和服务质量交换等功能。</p>
<p>通过协议多路复用、分段重组操作和组概念,向高层提供面向连接的和无连接的数据服务,L2CAP还屏蔽了低层传输协议中的很多特性，使得高层协议应用开发人员可以不必了解基层协议而进行开发。</p>
</blockquote>
<p><img data-src="https://s1.ax1x.com/2022/04/11/LV6sKg.png"></p>
<p>从架构图可以看出，L2CAP位于HCI与上层业务之间，在建立物理连接(ACL)之后，上层业务的通信和控制都由L2CAP协议与微微网(piconet )中其它蓝牙设备进行交互，类似HTTP协议的存在。</p>
<p>下图概括了两个设备L2CAP之间的连接过程：</p>
<p><img data-src="https://s1.ax1x.com/2022/04/11/LV6UUI.png"></p>
<h3 id="SDP"><a href="#SDP" class="headerlink" title="SDP"></a>SDP</h3><blockquote>
<p>BLUETOOTH SPECIFICATION Version 4.2 [Vol 3, Part B] page 222  </p>
<p>The service discovery mechanism provides the means for client applications to<br>discover the existence of services provided by server applications as well as<br>the attributes of those services. The attributes of a service include the type or<br>class of service offered and the mechanism or protocol information needed to<br>utilize the service.  </p>
</blockquote>
<p>全称是<strong>Service Discovery Protocol</strong>，服务发现协议，服务发现协议(SDP)为应用程序提供了一种方法来发现哪些服务可用，并确定这些可用服务的特征。</p>
<p><img data-src="https://s1.ax1x.com/2022/04/11/LV66bj.png"></p>
<p>从上图可知蓝牙设备中同时存在一个Client和Server，通过L2CAP协议与别的设备时行交互，通过<code>Service Search Attribute Request   </code>命令查询对方设备支持的蓝牙服务，其工作流程如图：</p>
<p><img data-src="https://s1.ax1x.com/2022/04/11/LV6a5t.png"></p>
<p>通过HCI可以看到发现蓝牙服务过过程中的数据：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">&gt; 455	22.824346	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	SDP	29	Sent Service Search Attribute Request : L2CAP: Attribute Range (0x0000 - 0xffff) </span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Frame 455: 29 bytes on wire (232 bits), 29 bytes captured (232 bits)</span><br><span class="line">Bluetooth</span><br><span class="line">Bluetooth HCI H4</span><br><span class="line">Bluetooth HCI ACL Packet</span><br><span class="line">Bluetooth L2CAP Protocol</span><br><span class="line">Bluetooth SDP Protocol</span><br><span class="line">    PDU: Service Search Attribute Request (0x06)</span><br><span class="line">    Transaction Id: 0x0000</span><br><span class="line">    Parameter Length: 15</span><br><span class="line">    Service Search Pattern: L2CAP</span><br><span class="line">    Maximum Attribute Byte Count: 1008</span><br><span class="line">    Attribute ID List</span><br><span class="line">        Data Element: Sequence uint8 5 bytes</span><br><span class="line">            0011 0... = Data Element Type: Sequence (6)</span><br><span class="line">            .... .101 = Data Element Size: uint8 (5)</span><br><span class="line">            Data Element Var Size: 5</span><br><span class="line">            Data Value</span><br><span class="line">                Data Element: Unsigned Integer 4 bytes</span><br><span class="line">                    0000 1... = Data Element Type: Unsigned Integer (1)</span><br><span class="line">                    .... .010 = Data Element Size: 4 bytes (2)</span><br><span class="line">                    Data Value</span><br><span class="line">                        Attribute Range: 0x0000ffff</span><br><span class="line">                            Attribute Range From: 0x0000</span><br><span class="line">                            Attribute Range To: 0xffff</span><br><span class="line">    Continuation State: no (00)</span><br><span class="line"></span><br><span class="line">&gt; 471	22.896191	XiaomiCo_6e:38:c5 (PHONE)	localhost ()	SDP	281	Rcvd Service Search Attribute Response</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Frame 471: 281 bytes on wire (2248 bits), 281 bytes captured (2248 bits)</span><br><span class="line">Bluetooth</span><br><span class="line">Bluetooth HCI H4</span><br><span class="line">Bluetooth HCI ACL Packet</span><br><span class="line">Bluetooth L2CAP Protocol</span><br><span class="line">Bluetooth SDP Protocol</span><br><span class="line">    PDU: Service Search Attribute Response (0x07)</span><br><span class="line">    Transaction Id: 0x0001</span><br><span class="line">    Parameter Length: 267</span><br><span class="line">    Attribute List Byte Count: 264</span><br><span class="line">    Data Fragment</span><br><span class="line">    Continuation State: no (00)</span><br><span class="line">    [Reassembled Attribute List]</span><br><span class="line">        Attribute Lists [count = 14]</span><br><span class="line">            Data Element: Sequence uint16 1269 bytes</span><br><span class="line">                0011 0... = Data Element Type: Sequence (6)</span><br><span class="line">                .... .110 = Data Element Size: uint16 (6)</span><br><span class="line">                Data Element Var Size: 1269</span><br><span class="line">                Data Value</span><br><span class="line">                    Attribute List [count =  4] (Generic Attribute Profile)</span><br><span class="line">                    Attribute List [count =  4] (Generic Access Profile)</span><br><span class="line">                    Attribute List [count =  6] (Headset Audio Gateway)</span><br><span class="line">                    Attribute List [count =  8] (Handsfree Audio Gateway)</span><br><span class="line">                    Attribute List [count =  8] (A/V Remote Control Target)</span><br><span class="line">                    Attribute List [count =  7] (Audio Source)</span><br><span class="line">                    Attribute List [count = 11] (PAN NAP)</span><br><span class="line">                    Attribute List [count =  9] (PAN PANU)</span><br><span class="line">                    Attribute List [count =  7] (Phonebook Access Server)</span><br><span class="line">                    Attribute List [count = 10] (Message Access Server)</span><br><span class="line">                    Attribute List [count =  4] (Xiaomi Inc.)</span><br><span class="line">                    Attribute List [count =  5] (CustomUUID: Unknown)</span><br><span class="line">                    Attribute List [count =  8] (OBEX Object Push)</span><br><span class="line">                    Attribute List [count =  4] (Unknown)</span><br></pre></td></tr></table></figure>



<h1 id="蓝牙电话"><a href="#蓝牙电话" class="headerlink" title="蓝牙电话"></a>蓝牙电话</h1><h2 id="PBAP-RFCOMM-x2F-OBEX"><a href="#PBAP-RFCOMM-x2F-OBEX" class="headerlink" title="PBAP(RFCOMM&#x2F;OBEX)"></a>PBAP(RFCOMM&#x2F;OBEX)</h2><blockquote>
<p>RFCOMM协议提供了对L2CAP协议上的串行端口的模拟。该协议基于ETSI标准GSM 07.10。</p>
<p>OBEX：Object Exchange的简称，对象交换协议，来源于红外通讯协议，但又不局限于具体的传输方式，后来被蓝牙组织SIG吸纳其中部分并进行优化处理作为蓝牙协议中的OBEX层用于蓝牙设备间的文件数据传输，如蓝牙传输文件（OPP）、同步电话簿（PBAP）和同步短信（MAP）等场景下都是以OBEX协议组织相关数据进行传输的。</p>
</blockquote>
<p>PBAP: Phone Book Access Profile的简称，<strong>电话本访问协议</strong>，用于同步手机这些具有电话本功能设备上的通讯录和通话记录等。</p>
<p>RFCOMM&#x2F;OBEX和协议不属于蓝牙定义的规范 ，只是被蓝牙采纳，而PBAP协议包在OBEX协议之上封装而成。</p>
<h3 id="PBAP虚拟文件夹架构"><a href="#PBAP虚拟文件夹架构" class="headerlink" title="PBAP虚拟文件夹架构"></a>PBAP虚拟文件夹架构</h3><p>PBAP中通话数据文件是在虚拟文件夹架构下，访问通话数据时需要指定路径，下图为官方架构图：</p>
<p><img data-src="https://s1.ax1x.com/2022/04/11/LV6yrQ.png"></p>
<p>其中vcf的文件名称意义如下：</p>
<p><img data-src="https://s1.ax1x.com/2022/04/11/LV6gVs.png"></p>
<h3 id="建立连接-x2F-断开连接"><a href="#建立连接-x2F-断开连接" class="headerlink" title="建立连接&#x2F;断开连接"></a>建立连接&#x2F;断开连接</h3><p>只使用OBEX协议</p>
<h4 id="连接-1"><a href="#连接-1" class="headerlink" title="连接"></a>连接</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&gt; 798	23.907353	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	OBEX	40	Sent Connect - Phone Book Access Profile</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Frame 798: 40 bytes on wire (320 bits), 40 bytes captured (320 bits)</span><br><span class="line">Bluetooth</span><br><span class="line">Bluetooth HCI H4</span><br><span class="line">Bluetooth HCI ACL Packet</span><br><span class="line">Bluetooth L2CAP Protocol</span><br><span class="line">Bluetooth RFCOMM Protocol</span><br><span class="line">OBEX Protocol</span><br><span class="line">    [Profile: PBAP (4)]</span><br><span class="line">    [Current Path: ?]</span><br><span class="line">    .000 0000 = Opcode: Connect (0x00)</span><br><span class="line">    1... .... = Final Flag: True</span><br><span class="line">    Packet Length: 26</span><br><span class="line">    [Response in Frame: 803]</span><br><span class="line">    Version: 1.0 (0x10)</span><br><span class="line">    Flags: 0x00</span><br><span class="line">    Max. Packet Length: 65534</span><br><span class="line">    Headers</span><br><span class="line">        Target: Phone Book Access Profile</span><br><span class="line">            Header Id: Target (0x46)</span><br><span class="line">            Length: 19</span><br><span class="line">            Value: 796135f0f0c511d809660800200c9a66: Phone Book Access Profile</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; 803	23.917550	XiaomiCo_6e:38:c5 (PHONE)	localhost ()	OBEX	45	Rcvd Success - Phone Book Access Profile</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Frame 803: 45 bytes on wire (360 bits), 45 bytes captured (360 bits)</span><br><span class="line">Bluetooth</span><br><span class="line">Bluetooth HCI H4</span><br><span class="line">Bluetooth HCI ACL Packet</span><br><span class="line">Bluetooth L2CAP Protocol</span><br><span class="line">Bluetooth RFCOMM Protocol</span><br><span class="line">OBEX Protocol</span><br><span class="line">    [Profile: PBAP (4)]</span><br><span class="line">    [Current Path: /]</span><br><span class="line">    .010 0000 = Response Code: Success (0x20)</span><br><span class="line">    1... .... = Final Flag: True</span><br><span class="line">    Packet Length: 31</span><br><span class="line">    [Request in Frame: 798]</span><br><span class="line">    Version: 1.0 (0x10)</span><br><span class="line">    Flags: 0x00</span><br><span class="line">    Max. Packet Length: 65534</span><br><span class="line">    Headers</span><br><span class="line">        Connection Id: 1</span><br><span class="line">            Header Id: Connection Id (0xcb)</span><br><span class="line">            Connection ID: 1</span><br><span class="line">        Who: Phone Book Access Profile</span><br><span class="line">            Header Id: Who (0x4a)</span><br><span class="line">            Length: 19</span><br><span class="line">            Value: 796135f0f0c511d809660800200c9a66: Phone Book Access Profile</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="断开"><a href="#断开" class="headerlink" title="断开"></a>断开</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&gt; 1142	58.752933	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	OBEX	22	Sent Disconnect</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">OBEX Protocol</span><br><span class="line">    [Profile: PBAP (4)]</span><br><span class="line">    [Current Path: /]</span><br><span class="line">    .000 0001 = Opcode: Disconnect (0x01)</span><br><span class="line">    1... .... = Final Flag: True</span><br><span class="line">    Packet Length: 8</span><br><span class="line">    [Response in Frame: 1164]</span><br><span class="line">    Headers</span><br><span class="line">        Connection Id: 1</span><br><span class="line">            Header Id: Connection Id (0xcb)</span><br><span class="line">            Connection ID: 1</span><br><span class="line"></span><br><span class="line">&gt; 1164	59.162598	XiaomiCo_6e:38:c5 (PHONE)	localhost ()	OBEX	22	Rcvd Success</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">OBEX Protocol</span><br><span class="line">    [Profile: PBAP (4)]</span><br><span class="line">    [Current Path: /]</span><br><span class="line">    .010 0000 = Response Code: Success (0x20)</span><br><span class="line">    1... .... = Final Flag: True</span><br><span class="line">    Packet Length: 8</span><br><span class="line">    [Request in Frame: 1142]</span><br><span class="line">    Headers</span><br><span class="line">        Connection Id: 1</span><br><span class="line">            Header Id: Connection Id (0xcb)</span><br><span class="line">            Connection ID: 1</span><br></pre></td></tr></table></figure>

<h3 id="设置访问虚拟文件夹路径"><a href="#设置访问虚拟文件夹路径" class="headerlink" title="设置访问虚拟文件夹路径"></a>设置访问虚拟文件夹路径</h3><p>在[PBAP协议规范]的<code>5.2 SetPhoneBook Function</code>章节，使用OBEX协议SetPath命令，通过obex.opcode&#x3D;<strong>0x05</strong>判断。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"># $/</span><br><span class="line">&gt; 808	24.023528	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	OBEX	27	Sent Set Path &quot;&quot;</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">OBEX Protocol</span><br><span class="line">    [Profile: PBAP (4)]</span><br><span class="line">    [Current Path: /]</span><br><span class="line">    .000 0101 = Opcode: Set Path (0x05)</span><br><span class="line">    1... .... = Final Flag: True</span><br><span class="line">    Packet Length: 13</span><br><span class="line">    [Response in Frame: 810]</span><br><span class="line">    Flags: 0x02</span><br><span class="line">    .... ...0 = Go back one folder (../) first: False</span><br><span class="line">    .... ..1. = Do not create folder, if not existing: True</span><br><span class="line">    Constants: 0x00</span><br><span class="line">    Headers</span><br><span class="line">        Connection Id: 1</span><br><span class="line">            Header Id: Connection Id (0xcb)</span><br><span class="line">            Connection ID: 1</span><br><span class="line">        Name: &quot;&quot;</span><br><span class="line">            Header Id: Name (0x01)</span><br><span class="line">            Length: 3</span><br><span class="line">            Name: </span><br><span class="line"></span><br><span class="line">&gt; 810	24.065127	XiaomiCo_6e:38:c5 (PHONE)	localhost ()	OBEX	22	Rcvd Success</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">OBEX Protocol</span><br><span class="line">    [Profile: PBAP (4)]</span><br><span class="line">    [Current Path: /]</span><br><span class="line">    .010 0000 = Response Code: Success (0x20)</span><br><span class="line">    1... .... = Final Flag: True</span><br><span class="line">    Packet Length: 8</span><br><span class="line">    [Request in Frame: 808]</span><br><span class="line">    Headers</span><br><span class="line">        Connection Id: 1</span><br><span class="line">            Header Id: Connection Id (0xcb)</span><br><span class="line">            Connection ID: 1</span><br><span class="line"></span><br><span class="line"># $/telecom/</span><br><span class="line">&gt; 811	24.078180	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	OBEX	43	Sent Set Path &quot;telecom&quot;</span><br></pre></td></tr></table></figure>



<h3 id="获取通讯录数量"><a href="#获取通讯录数量" class="headerlink" title="获取通讯录数量"></a>获取通讯录数量</h3><p>在[PBAP协议规范]的<code>5.3 PullvCardListing Function</code>章节，通过obex.header&#x3D;**&lt;x-bt&#x2F;vcard-listing&gt;**判断。</p>
<h4 id="手机"><a href="#手机" class="headerlink" title="手机"></a>手机</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">&gt; 808	24.023528	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	OBEX	27	Sent Set Path &quot;&quot;</span><br><span class="line">&gt; 811	24.078180	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	OBEX	43	Sent Set Path &quot;telecom&quot;</span><br><span class="line"># $/telecom/pb/</span><br><span class="line">&gt; 816	24.118267	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	OBEX	70	Sent Get final &quot;pb&quot;</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">OBEX Protocol</span><br><span class="line">    [Profile: PBAP (4)]</span><br><span class="line">    [Current Path: /telecom]</span><br><span class="line">    .000 0011 = Opcode: Get (0x03)</span><br><span class="line">    1... .... = Final Flag: True</span><br><span class="line">    Packet Length: 56</span><br><span class="line">    [Response in Frame: 818]</span><br><span class="line">    Headers</span><br><span class="line">        Connection Id: 1</span><br><span class="line">            Header Id: Connection Id (0xcb)</span><br><span class="line">            Connection ID: 1</span><br><span class="line">        Name: &quot;pb&quot;</span><br><span class="line">            Header Id: Name (0x01)</span><br><span class="line">            Length: 9</span><br><span class="line">            Name: pb</span><br><span class="line">        Type: &quot;x-bt/vcard-listing&quot;</span><br><span class="line">            Header Id: Type (0x42)</span><br><span class="line">            Length: 22</span><br><span class="line">            Type: x-bt/vcard-listing</span><br><span class="line">        Application Parameters</span><br><span class="line">            Header Id: Application Parameters (0x4c)</span><br><span class="line">            Length: 17</span><br><span class="line">            Parameter: Order #排序规则: &#123; Alphabetical | Indexed | Phonetical &#125;</span><br><span class="line">                Parameter Id: Order (0x01)</span><br><span class="line">                Parameter Length: 1</span><br><span class="line">                Max List Count: Indexed (0x00)</span><br><span class="line">            Parameter: Search Attribute #搜索:  &#123;Name | Number | Sound &#125; 与 SearchValue配合，默认为Name</span><br><span class="line">                Parameter Id: Search Attribute (0x03)</span><br><span class="line">                Parameter Length: 1</span><br><span class="line">                Search Attribute: Name (0x00)</span><br><span class="line">            Parameter: Max List Count #最大条目数</span><br><span class="line">                Parameter Id: Max List Count (0x04)</span><br><span class="line">                Parameter Length: 2</span><br><span class="line">                Max List Count: 0 (0x0000)</span><br><span class="line">            Parameter: List Start Offset #偏移量</span><br><span class="line">                Parameter Id: List Start Offset (0x05)</span><br><span class="line">                Parameter Length: 2</span><br><span class="line">                List Start Offset: 0 (0x0000)</span><br><span class="line"></span><br><span class="line">&gt; 818	24.332995	XiaomiCo_6e:38:c5 (PHONE)	localhost ()	OBEX	29	Rcvd Success</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">OBEX Protocol</span><br><span class="line">    [Profile: PBAP (4)]</span><br><span class="line">    [Current Path: /telecom]</span><br><span class="line">    .010 0000 = Response Code: Success (0x20)</span><br><span class="line">    1... .... = Final Flag: True</span><br><span class="line">    Packet Length: 15</span><br><span class="line">    [Request in Frame: 816]</span><br><span class="line">    Headers</span><br><span class="line">        Connection Id: 1</span><br><span class="line">            Header Id: Connection Id (0xcb)</span><br><span class="line">            Connection ID: 1</span><br><span class="line">        Application Parameters</span><br><span class="line">            Header Id: Application Parameters (0x4c)</span><br><span class="line">            Length: 7</span><br><span class="line">            Parameter: Phonebook Size</span><br><span class="line">                Parameter Id: Phonebook Size (0x08)</span><br><span class="line">                Parameter Length: 2</span><br><span class="line">                Phonebook Size: 71 (0x0047)</span><br></pre></td></tr></table></figure>

<h4 id="SIM1"><a href="#SIM1" class="headerlink" title="SIM1"></a>SIM1</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&gt; 819	24.336294	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	OBEX	27	Sent Set Path &quot;&quot;</span><br><span class="line">&gt; 822	24.379640	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	OBEX	27	Sent Set Path &quot;&quot;</span><br><span class="line">&gt; 825	24.430836	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	OBEX	37	Sent Set Path &quot;SIM1&quot;</span><br><span class="line">&gt; 828	24.481559	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	OBEX	43	Sent Set Path &quot;telecom&quot;</span><br><span class="line"># $/SIM1/telecom/pb/</span><br><span class="line">&gt; 831	24.532312	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	OBEX	70	Sent Get final &quot;pb&quot;</span><br><span class="line"></span><br><span class="line">&gt; 833	24.578831	XiaomiCo_6e:38:c5 (PHONE)	localhost ()	OBEX	29	Rcvd Success</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">OBEX Protocol</span><br><span class="line">    [Profile: PBAP (4)]</span><br><span class="line">    [Current Path: /SIM1/telecom]</span><br><span class="line">    .010 0000 = Response Code: Success (0x20)</span><br><span class="line">    1... .... = Final Flag: True</span><br><span class="line">    Packet Length: 15</span><br><span class="line">    [Request in Frame: 831]</span><br><span class="line">    Headers</span><br><span class="line">        Connection Id: 1</span><br><span class="line">            Header Id: Connection Id (0xcb)</span><br><span class="line">            Connection ID: 1</span><br><span class="line">        Application Parameters</span><br><span class="line">            Header Id: Application Parameters (0x4c)</span><br><span class="line">            Length: 7</span><br><span class="line">            Parameter: Phonebook Size</span><br><span class="line">                Parameter Id: Phonebook Size (0x08)</span><br><span class="line">                Parameter Length: 2</span><br><span class="line">                Phonebook Size: 1 (0x0001)</span><br></pre></td></tr></table></figure>

<h3 id="获取通讯录"><a href="#获取通讯录" class="headerlink" title="获取通讯录"></a>获取通讯录</h3><p>在[PBAP协议规范]的<code>5.3 PullvCardListing Function</code>章节，通过obex.header&#x3D;<strong>&lt;x-bt&#x2F;phonebook&gt;</strong> 判断，分页获取vCard格式。</p>
<h4 id="手机-1"><a href="#手机-1" class="headerlink" title="手机"></a>手机</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line">&gt; 834	24.580643	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	OBEX	27	Sent Set Path &quot;&quot;</span><br><span class="line">#分页请求获取通讯录，从第1条数据开始，每页最多50条</span><br><span class="line">&gt; 837	24.632264	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	OBEX	97	Sent Get final &quot;telecom/pb.vcf&quot;</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">OBEX Protocol</span><br><span class="line">    [Profile: PBAP (4)]</span><br><span class="line">    [Current Path: /]</span><br><span class="line">    .000 0011 = Opcode: Get (0x03)</span><br><span class="line">    1... .... = Final Flag: True</span><br><span class="line">    Packet Length: 83</span><br><span class="line">    [Response in Frame: 844]</span><br><span class="line">    Headers</span><br><span class="line">        Connection Id: 1</span><br><span class="line">            Header Id: Connection Id (0xcb)</span><br><span class="line">            Connection ID: 1</span><br><span class="line">        Name: &quot;telecom/pb.vcf&quot;</span><br><span class="line">            Header Id: Name (0x01)</span><br><span class="line">            Length: 33</span><br><span class="line">            Name: telecom/pb.vcf</span><br><span class="line">        Type: &quot;x-bt/phonebook&quot;</span><br><span class="line">            Header Id: Type (0x42)</span><br><span class="line">            Length: 18</span><br><span class="line">            Type: x-bt/phonebook</span><br><span class="line">        Application Parameters</span><br><span class="line">            Header Id: Application Parameters (0x4c)</span><br><span class="line">            Length: 24</span><br><span class="line">            Parameter: Max List Count #最大条目数,这里只读取50条</span><br><span class="line">                Parameter Id: Max List Count (0x04)</span><br><span class="line">                Parameter Length: 2</span><br><span class="line">                Max List Count: 50 (0x0032)</span><br><span class="line">            Parameter: List Start Offset #偏移量，这是从第1条开始读取</span><br><span class="line">                Parameter Id: List Start Offset (0x05)</span><br><span class="line">                Parameter Length: 2</span><br><span class="line">                List Start Offset: 1 (0x0001)</span><br><span class="line">            Parameter: Filter #用于指示所请求的vCard中包含的属性</span><br><span class="line">                Parameter Id: Filter (0x06)</span><br><span class="line">                Parameter Length: 8</span><br><span class="line">                Filter: 0x00000000</span><br><span class="line">                Filter: 0x008001af, vCard Version, Formatted Name, Structured Presentation of Name, Associated Image or Photo, Delivery Address, Telephone Number, Electronic Mail Address, Nickname</span><br><span class="line">            Parameter: Format #vCard文件格式版本，这是3.0</span><br><span class="line">                Parameter Id: Format (0x07)</span><br><span class="line">                Parameter Length: 1</span><br><span class="line">                Format: 3.0 (0x01)</span><br><span class="line"></span><br><span class="line">#传输数据片段</span><br><span class="line">&gt; 839	24.764415	XiaomiCo_6e:38:c5 (PHONE)	localhost ()	OBEX	1004	Rcvd OBEX fragment</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Frame 839: 1004 bytes on wire (8032 bits), 1004 bytes captured (8032 bits)</span><br><span class="line">Bluetooth</span><br><span class="line">Bluetooth HCI H4</span><br><span class="line">Bluetooth HCI ACL Packet</span><br><span class="line">Bluetooth L2CAP Protocol</span><br><span class="line">Bluetooth RFCOMM Protocol</span><br><span class="line">OBEX Protocol</span><br><span class="line">    [Profile: PBAP (4)]</span><br><span class="line">    [Current Path: /]</span><br><span class="line">    [Reassembled OBEX in frame: 844]</span><br><span class="line">    Data (990 bytes)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">#传输成功</span><br><span class="line">&gt; 844	24.794969	XiaomiCo_6e:38:c5 (PHONE)	localhost ()	OBEX	182	Rcvd Success (x-bt/phonebook)</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">OBEX Protocol</span><br><span class="line">    [Profile: PBAP (4)]</span><br><span class="line">    [Current Path: /]</span><br><span class="line">    [6 OBEX Fragments (5117 bytes): #839(990), #840(990), #841(990), #842(990), #843(990), #844(167)] #6个数据片段，需要拼接对应Frame</span><br><span class="line">    .010 0000 = Response Code: Success (0x20)</span><br><span class="line">    1... .... = Final Flag: True</span><br><span class="line">    Packet Length: 5117</span><br><span class="line">    [Request in Frame: 837]</span><br><span class="line">    Headers</span><br><span class="line">        Connection Id: 1</span><br><span class="line">            Header Id: Connection Id (0xcb)</span><br><span class="line">            Connection ID: 1</span><br><span class="line">        End Of Body</span><br><span class="line">            Header Id: End Of Body (0x49)</span><br><span class="line">            Length: 5109</span><br><span class="line">            Value: 424547494e3a56434152440d0a56455253494f4e3a332e300d0a4e3ae591a83be4baa6e6…</span><br><span class="line">    Line-based text data: x-bt/phonebook (320 lines)</span><br><span class="line">        BEGIN:VCARD\r\n</span><br><span class="line">        VERSION:3.0\r\n</span><br><span class="line">        N:张;三;;;\r\n</span><br><span class="line">        FN:张三\r\n</span><br><span class="line">        TEL;TYPE=CELL:22222222\r\n</span><br><span class="line">        END:VCARD\r\n</span><br><span class="line">        BEGIN:VCARD\r\n</span><br><span class="line">        VERSION:3.0\r\n</span><br><span class="line">        N:李四;;;;\r\n</span><br><span class="line">        FN:李四\r\n</span><br><span class="line">        TEL;TYPE=CELL:11111111\r\n</span><br><span class="line">        END:VCARD\r\n</span><br><span class="line"></span><br><span class="line">#请求获取vCard 3.0格式，并从第51条数据开始，最多50条</span><br><span class="line">&gt; 847	24.875858	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	OBEX	96	Sent Get final &quot;telecom/pb.vcf&quot;</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">OBEX Protocol</span><br><span class="line">    [Profile: PBAP (4)]</span><br><span class="line">    [Current Path: /]</span><br><span class="line">    .000 0011 = Opcode: Get (0x03)</span><br><span class="line">    1... .... = Final Flag: True</span><br><span class="line">    Packet Length: 83</span><br><span class="line">    [Response in Frame: 850]</span><br><span class="line">    Headers</span><br><span class="line">        Connection Id: 1</span><br><span class="line">            Header Id: Connection Id (0xcb)</span><br><span class="line">            Connection ID: 1</span><br><span class="line">        Name: &quot;telecom/pb.vcf&quot;</span><br><span class="line">            Header Id: Name (0x01)</span><br><span class="line">            Length: 33</span><br><span class="line">            Name: telecom/pb.vcf</span><br><span class="line">        Type: &quot;x-bt/phonebook&quot;</span><br><span class="line">            Header Id: Type (0x42)</span><br><span class="line">            Length: 18</span><br><span class="line">            Type: x-bt/phonebook</span><br><span class="line">        Application Parameters</span><br><span class="line">            Header Id: Application Parameters (0x4c)</span><br><span class="line">            Length: 24</span><br><span class="line">            Parameter: Max List Count</span><br><span class="line">                Parameter Id: Max List Count (0x04)</span><br><span class="line">                Parameter Length: 2</span><br><span class="line">                Max List Count: 50 (0x0032)</span><br><span class="line">            Parameter: List Start Offset</span><br><span class="line">                Parameter Id: List Start Offset (0x05)</span><br><span class="line">                Parameter Length: 2</span><br><span class="line">                List Start Offset: 51 (0x0033)</span><br><span class="line">            Parameter: Filter</span><br><span class="line">                Parameter Id: Filter (0x06)</span><br><span class="line">                Parameter Length: 8</span><br><span class="line">                Filter: 0x00000000</span><br><span class="line">                Filter: 0x008001af, vCard Version, Formatted Name, Structured Presentation of Name, Associated Image or Photo, Delivery Address, Telephone Number, Electronic Mail Address, Nickname</span><br><span class="line">            Parameter: Format</span><br><span class="line">                Parameter Id: Format (0x07)</span><br><span class="line">                Parameter Length: 1</span><br><span class="line">                Format: 3.0 (0x01)</span><br><span class="line"></span><br><span class="line">&gt; 849	24.953425	XiaomiCo_6e:38:c5 (PHONE)	localhost ()	OBEX	1004	Rcvd OBEX fragment</span><br><span class="line"></span><br><span class="line"># 刚刚通过`Sent Get final &quot;pb&quot;`获取手机通讯录只有71条，现在只剩下21，这次就可以传输完成。</span><br><span class="line">&gt; 850	24.960363	XiaomiCo_6e:38:c5 (PHONE)	localhost ()	OBEX	940	Rcvd Success (x-bt/phonebook)</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">OBEX Protocol</span><br><span class="line">    [Profile: PBAP (4)]</span><br><span class="line">    [Current Path: /]</span><br><span class="line">    [2 OBEX Fragments (1915 bytes): #849(990), #850(925)]</span><br><span class="line">    .010 0000 = Response Code: Success (0x20)</span><br><span class="line">    1... .... = Final Flag: True</span><br><span class="line">    Packet Length: 1915</span><br><span class="line">    [Request in Frame: 847]</span><br><span class="line">    Headers</span><br><span class="line">        Connection Id: 1</span><br><span class="line">            Header Id: Connection Id (0xcb)</span><br><span class="line">            Connection ID: 1</span><br><span class="line">        End Of Body</span><br><span class="line">            Header Id: End Of Body (0x49)</span><br><span class="line">            Length: 1907</span><br><span class="line">            Value: 424547494e3a56434152440d0a56455253494f4e3a332e300d0a4e3ae4bd993be4bf8ae7…</span><br><span class="line">    Line-based text data: x-bt/phonebook (122 lines)</span><br><span class="line">        BEGIN:VCARD\r\n</span><br><span class="line">        VERSION:3.0\r\n</span><br><span class="line">        N:张;三;;;\r\n</span><br><span class="line">        FN:张三\r\n</span><br><span class="line">        TEL;TYPE=CELL:22222222\r\n</span><br><span class="line">        END:VCARD\r\n</span><br><span class="line">        BEGIN:VCARD\r\n</span><br><span class="line">        VERSION:3.0\r\n</span><br><span class="line">        N:李四;;;;\r\n</span><br><span class="line">        FN:李四\r\n</span><br><span class="line">        TEL;TYPE=CELL:11111111\r\n</span><br><span class="line">        END:VCARD\r\n</span><br></pre></td></tr></table></figure>

<h4 id="SIM1-1"><a href="#SIM1-1" class="headerlink" title="SIM1"></a>SIM1</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&gt; 866	25.021131	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	OBEX	107	Sent Get final &quot;SIM1/telecom/pb.vcf&quot;</span><br><span class="line">#这里手机直接拒绝了</span><br><span class="line">&gt; 868	25.032728	XiaomiCo_6e:38:c5 (PHONE)	localhost ()	OBEX	25	Rcvd Success</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">OBEX Protocol</span><br><span class="line">    [Profile: PBAP (4)]</span><br><span class="line">    [Current Path: /]</span><br><span class="line">    .010 0000 = Response Code: Success (0x20)</span><br><span class="line">    1... .... = Final Flag: True</span><br><span class="line">    Packet Length: 11</span><br><span class="line">    [Request in Frame: 866]</span><br><span class="line">    Headers</span><br><span class="line">        Connection Id: 1</span><br><span class="line">            Header Id: Connection Id (0xcb)</span><br><span class="line">            Connection ID: 1</span><br><span class="line">        End Of Body</span><br><span class="line">            Header Id: End Of Body (0x49)</span><br><span class="line">            Length: 3</span><br><span class="line">            Value: &lt;MISSING&gt;</span><br></pre></td></tr></table></figure>



<h3 id="获取通话记录"><a href="#获取通话记录" class="headerlink" title="获取通话记录"></a>获取通话记录</h3><p>在[PBAP协议规范]的<code>5.3 PullvCardListing Function</code>章节，通过obex.header&#x3D;<strong>&lt;x-bt&#x2F;phonebook&gt;</strong> 判断，分页获取vCard格式。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">&gt; 869	25.071027	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	OBEX	27	Sent Set Path &quot;&quot;</span><br><span class="line">&gt; 882	25.125323	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	OBEX	43	Sent Set Path &quot;telecom&quot;</span><br><span class="line"># $/telecom/cch/</span><br><span class="line">&gt; 887	25.138796	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	OBEX	72	Sent Get final &quot;cch&quot;</span><br><span class="line">&gt; 895	25.222650	XiaomiCo_6e:38:c5 (PHONE)	localhost ()	OBEX	29	Rcvd Success</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">OBEX Protocol</span><br><span class="line">    [Profile: PBAP (4)]</span><br><span class="line">    [Current Path: /telecom]</span><br><span class="line">    .010 0000 = Response Code: Success (0x20)</span><br><span class="line">    1... .... = Final Flag: True</span><br><span class="line">    Packet Length: 15</span><br><span class="line">    [Request in Frame: 887]</span><br><span class="line">    Headers</span><br><span class="line">        Connection Id: 1</span><br><span class="line">            Header Id: Connection Id (0xcb)</span><br><span class="line">            Connection ID: 1</span><br><span class="line">        Application Parameters</span><br><span class="line">            Header Id: Application Parameters (0x4c)</span><br><span class="line">            Length: 7</span><br><span class="line">            Parameter: Phonebook Size</span><br><span class="line">                Parameter Id: Phonebook Size (0x08)</span><br><span class="line">                Parameter Length: 2</span><br><span class="line">                Phonebook Size: 2177 (0x0881)</span><br><span class="line"></span><br><span class="line">&gt; 897	25.225643	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	OBEX	27	Sent Set Path &quot;&quot;</span><br><span class="line">#分页获取通话记录，从第0条开始，每页最多50条</span><br><span class="line">&gt; 919	25.279427	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	OBEX	85	Sent Get final &quot;telecom/cch.vcf&quot;</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">OBEX Protocol</span><br><span class="line">    [Profile: PBAP (4)]</span><br><span class="line">    [Current Path: /]</span><br><span class="line">    .000 0011 = Opcode: Get (0x03)</span><br><span class="line">    1... .... = Final Flag: True</span><br><span class="line">    Packet Length: 71</span><br><span class="line">    [Response in Frame: 935]</span><br><span class="line">    Headers</span><br><span class="line">        Connection Id: 1</span><br><span class="line">            Header Id: Connection Id (0xcb)</span><br><span class="line">            Connection ID: 1</span><br><span class="line">        Name: &quot;telecom/cch.vcf&quot;</span><br><span class="line">            Header Id: Name (0x01)</span><br><span class="line">            Length: 35</span><br><span class="line">            Name: telecom/cch.vcf</span><br><span class="line">        Type: &quot;x-bt/phonebook&quot;</span><br><span class="line">            Header Id: Type (0x42)</span><br><span class="line">            Length: 18</span><br><span class="line">            Type: x-bt/phonebook</span><br><span class="line">        Application Parameters</span><br><span class="line">            Header Id: Application Parameters (0x4c)</span><br><span class="line">            Length: 10</span><br><span class="line">            Parameter: Max List Count</span><br><span class="line">                Parameter Id: Max List Count (0x04)</span><br><span class="line">                Parameter Length: 2</span><br><span class="line">                Max List Count: 50 (0x0032)</span><br><span class="line">            Parameter: Format</span><br><span class="line">                Parameter Id: Format (0x07)</span><br><span class="line">                Parameter Length: 1</span><br><span class="line">                Format: 3.0 (0x01)</span><br><span class="line">&gt; 935	25.381127	XiaomiCo_6e:38:c5 (PHONE)	localhost ()	OBEX	132	Rcvd Success (x-bt/phonebook)</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">OBEX Protocol</span><br><span class="line">    [Profile: PBAP (4)]</span><br><span class="line">    [Current Path: /]</span><br><span class="line">    [8 OBEX Fragments (7048 bytes): #926(990), #927(990), #928(990), #929(990), #930(990), #931(990), #934(990), #935(118)]</span><br><span class="line">    .010 0000 = Response Code: Success (0x20)</span><br><span class="line">    1... .... = Final Flag: True</span><br><span class="line">    Packet Length: 7048</span><br><span class="line">    [Request in Frame: 919]</span><br><span class="line">    Headers</span><br><span class="line">        Connection Id: 1</span><br><span class="line">            Header Id: Connection Id (0xcb)</span><br><span class="line">            Connection ID: 1</span><br><span class="line">        End Of Body</span><br><span class="line">            Header Id: End Of Body (0x49)</span><br><span class="line">            Length: 7040</span><br><span class="line">            Value: 424547494e3a56434152440d0a56455253494f4e3a332e300d0a464e3a0d0a4e3a0d0a54…</span><br><span class="line">    Line-based text data: x-bt/phonebook (350 lines)</span><br><span class="line">        BEGIN:VCARD\r\n</span><br><span class="line">        VERSION:3.0\r\n</span><br><span class="line">        FN:\r\n</span><br><span class="line">        N:\r\n</span><br><span class="line">        TEL;TYPE=0:10086\r\n</span><br><span class="line">        X-IRMC-CALL-DATETIME;TYPE=DIALED:20220317T161710\r\n</span><br><span class="line">        END:VCARD\r\n</span><br><span class="line">        BEGIN:VCARD\r\n</span><br><span class="line">        VERSION:3.0\r\n</span><br><span class="line">        FN:\r\n</span><br><span class="line">        N:\r\n</span><br><span class="line">        TEL;TYPE=0:02310050\r\n</span><br><span class="line">        X-IRMC-CALL-DATETIME;TYPE=MISSED:20220316T160142\r\n</span><br><span class="line">        END:VCARD\r\n</span><br><span class="line"></span><br><span class="line">#分页获取通话记录，从第50条开始，每页最多50条</span><br><span class="line">936	25.423573	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	OBEX	89	Sent Get final &quot;telecom/cch.vcf&quot;</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">OBEX Protocol</span><br><span class="line">    [Profile: PBAP (4)]</span><br><span class="line">    [Current Path: /]</span><br><span class="line">    .000 0011 = Opcode: Get (0x03)</span><br><span class="line">    1... .... = Final Flag: True</span><br><span class="line">    Packet Length: 75</span><br><span class="line">    [Response in Frame: 947]</span><br><span class="line">    Headers</span><br><span class="line">        Connection Id: 1</span><br><span class="line">            Header Id: Connection Id (0xcb)</span><br><span class="line">            Connection ID: 1</span><br><span class="line">        Name: &quot;telecom/cch.vcf&quot;</span><br><span class="line">            Header Id: Name (0x01)</span><br><span class="line">            Length: 35</span><br><span class="line">            Name: telecom/cch.vcf</span><br><span class="line">        Type: &quot;x-bt/phonebook&quot;</span><br><span class="line">            Header Id: Type (0x42)</span><br><span class="line">            Length: 18</span><br><span class="line">            Type: x-bt/phonebook</span><br><span class="line">        Application Parameters</span><br><span class="line">            Header Id: Application Parameters (0x4c)</span><br><span class="line">            Length: 14</span><br><span class="line">            Parameter: Max List Count</span><br><span class="line">                Parameter Id: Max List Count (0x04)</span><br><span class="line">                Parameter Length: 2</span><br><span class="line">                Max List Count: 50 (0x0032)</span><br><span class="line">            Parameter: List Start Offset</span><br><span class="line">                Parameter Id: List Start Offset (0x05)</span><br><span class="line">                Parameter Length: 2</span><br><span class="line">                List Start Offset: 50 (0x0032)</span><br><span class="line">            Parameter: Format</span><br><span class="line">                Parameter Id: Format (0x07)</span><br><span class="line">                Parameter Length: 1</span><br><span class="line">                Format: 3.0 (0x01)</span><br><span class="line">&gt; 947	25.516478	XiaomiCo_6e:38:c5 (PHONE)	localhost ()	OBEX	810	Rcvd Success (x-bt/phonebook)</span><br></pre></td></tr></table></figure>

<h2 id="HFP-RFCOMM"><a href="#HFP-RFCOMM" class="headerlink" title="HFP(RFCOMM)"></a>HFP(RFCOMM)</h2><blockquote>
<p>HFP(Hands-free Profile)，让蓝牙设备可以控制电话，如接听、挂断、拒接、语音拨号等，拒接、语音拨号要视蓝牙耳机及电话是否支持。</p>
<p>目前HFP的使用场景有车载蓝牙，耳机和PDA，定义了AG和HFP两种角色。<br>AG（Audio Gate）音频网关—音频设备输入输出网关<br>HF（Hands Free）免提—该设备作为音频网关的远程音频输入&#x2F;输出机制，并可提供若干遥控功能。</p>
</blockquote>
<p>在车载蓝牙中，<strong>手机侧是AG</strong>，<strong>车载蓝牙侧是HF</strong>，在android源代码中，将AG侧称为HFP&#x2F;AG，将HF侧称为HFPClient&#x2F;HF。</p>
<h3 id="AT命令"><a href="#AT命令" class="headerlink" title="AT命令"></a>AT命令</h3><p>在HFP使用AT命令控制电话，其参考3GPP 27.007标准，命令规范为：</p>
<ul>
<li><p>每个命令行只有一个命令</p>
</li>
<li><p>AG侧默认不回显命令</p>
</li>
<li><p>AG使用冗长的格式返回结果</p>
</li>
<li><p>以下字符将被用于AT命令和返回结果格式中</p>
<ul>
<li><p><code>&lt;cr&gt;</code> 表示回车，也就是<code>\r</code>字符</p>
</li>
<li><p><code> &lt;lf&gt;</code>表示换行，也就是<code>\n</code>字符</p>
</li>
</ul>
</li>
<li><p>从HF发送到AG的命令格式是：<code>&lt;AT command&gt; &lt;cr&gt;</code></p>
</li>
<li><p>从AG返回给HF的OK命令格式是：<code>&lt;cr&gt;&lt;lf&gt;OK&lt;cr&gt;&lt;lf&gt;</code></p>
</li>
<li><p>从AG到HF的ERROR命令是：<code>&lt;cr&gt;&lt;lf&gt;ERROR&lt;cr&gt;&lt;lf&gt;</code></p>
</li>
<li><p>从AG到HF的结果命令格式是：<code>&lt;cr&gt;&lt;lf&gt;&lt;result code&gt;&lt;cr&gt;&lt;lf&gt;</code></p>
</li>
</ul>
<p>HFP协议复用的AT命令：</p>
<ul>
<li><p>ATA：标准电话应答AT命令</p>
</li>
<li><p>ATDdd…dd;：用电话号码打电话</p>
</li>
<li><p>ATD&gt;nnn…;：ATD扩展命令，记忆拨号</p>
</li>
<li><p>ERROR：错误指示符，语法，格式或者通信过程出错。</p>
</li>
<li><p>OK：命令的成功应答。</p>
</li>
<li><p>NO CARRIER, BUSY, NO ANSWER, DELAYED, BLACKLISTED：AT扩展命令，AG返回给HF。</p>
</li>
<li><p>RING：来电</p>
</li>
<li><p>AT+CCWA：calling waiting notification AT命令。AT+CCWA&#x3D;<code>[&lt;n&gt;[,&lt;mode&gt;[,&lt;class&gt;]]]</code>，</p>
</li>
<li><p>+CCWA：Call Waiting notification返回结果码。只有<code>&lt;number&gt;</code>和<code>&lt;type&gt;</code>参数对HFP有意义，<code>&lt;number&gt;</code>是由双引号及其中的文本串组成。<code>&lt;type&gt;</code>是支持的电话格式，有如下值：</p>
<ul>
<li><p>128~143：国家或国际格式，</p>
</li>
<li><p>144~159：国际电话，包括国家码前缀。</p>
</li>
<li><p>160-175:国家码</p>
</li>
<li><p>AT+CHLD：通话保持，多方处理。AT+CHLD&#x3D;<code>&lt;n&gt;</code>中<code>&lt;n&gt;</code>值覆盖0, 1, 1<code>&lt;idx&gt;</code>, 2, 2<code>&lt;idx&gt;</code>, 3 and 4,说明：</p>
<ul>
<li>0：释放所有保持电话或者设置用户的忙等待</li>
<li>1：释放正在通话的电话，接听保持或等待的电话</li>
<li>1<code>&lt;idx&gt;</code>:释放<code>&lt;idx&gt;</code>标识的电话</li>
<li>2：将所有活跃电话设置成保持并且接受其它电话。</li>
<li>2<code>&lt;idx&gt;</code>:请求接受<code>&lt;idx&gt;</code>标识电话，让其它电话保持。</li>
<li>3：增加一个保持电话到对话中</li>
<li>4：连接连个电话并且断开两个电话的订阅。HF侧可选。</li>
</ul>
</li>
<li><p>AT+CHLD&#x3D;?：查询AG侧保持和多方会话。</p>
</li>
</ul>
</li>
<li><p>AT+CHUP：标准的挂断命令。AG会结束通话，也可用于拒接来电。</p>
</li>
<li><p>AT+CIND：<code>AT+CIND?</code>获取AG indicators当前的状态,&#96;AT+CIND&#x3D;?获取AG支持的indicator以及它们的次序。</p>
<ul>
<li>service: Service availability indication:<ul>
<li><code>&lt;value&gt;=0</code> implies no service. No Home&#x2F;Roam network available.</li>
<li><code>&lt;value&gt;=1</code> implies presence of service. Home&#x2F;Roam network available.</li>
</ul>
</li>
<li>call: Standard call status indicator:  <ul>
<li><code>&lt;value&gt;=0 </code>means there are no calls in progress  </li>
<li><code>&lt;value&gt;=1</code> means at least one call is in progress</li>
</ul>
</li>
<li>callsetup: Bluetooth proprietary call set up status indicator4. Support for this indicator is optional<br>for the HF. When supported, this indicator shall be used in conjunction with, and as an extension<br>of the standard call indicator. Possible values are as follows:  <ul>
<li><code>&lt;value&gt;=0</code> means not currently in call set up.  </li>
<li><code>&lt;value&gt;=1</code> means an incoming call process ongoing.</li>
<li><code>&lt;value&gt;=2</code> means an outgoing call set up is ongoing.  </li>
<li><code>&lt;value&gt;=3</code> means remote party being alerted in an outgoing call.</li>
</ul>
</li>
<li>callheld: Bluetooth proprietary call hold status indicator. Support for this indicator is mandatory for<br>the AG, optional for the HF. Possible values are as follows:  <ul>
<li>0&#x3D; No calls held  </li>
<li>1&#x3D; Call is placed on hold or active&#x2F;held calls swapped<br>(The AG has both an active AND a held call)  </li>
<li>Call on hold, no active call</li>
</ul>
</li>
<li>signal: Signal Strength indicator:  <ul>
<li><code>&lt;value&gt;= </code>ranges from 0 to 5</li>
</ul>
</li>
<li>roam: Roaming status indicator:  <ul>
<li><code>&lt;value&gt;=0</code> means roaming is not active  </li>
<li><code>&lt;value&gt;=1</code> means a roaming is active</li>
</ul>
</li>
<li>battchg: Battery Charge indicator of AG:  <ul>
<li><code>&lt;value&gt;=</code>ranges from 0 to 5</li>
</ul>
</li>
</ul>
</li>
<li><p>+CIND：当前indicator的列表</p>
</li>
<li><p>AT+CLCC：列出当前电话命令，</p>
</li>
<li><p>+CLCC：当前call结果码，支持参数是</p>
<ul>
<li><p>idx：表示建立连接顺序或者接听电话的数字（从1开始）。</p>
</li>
<li><p>dir：0（outgoing），1（incoming）</p>
</li>
<li><p>status：</p>
<ul>
<li><p>0&#x3D;Active</p>
</li>
<li><p>1&#x3D;Held</p>
</li>
<li><p>2&#x3D;Dialing（outgoing calls only）</p>
</li>
<li><p>3&#x3D;Alerting(outgoing calls only)</p>
</li>
<li><p>4&#x3D;Incoming(incoming calls only)</p>
</li>
<li><p>5&#x3D;Waiting(incoming calls only)</p>
</li>
<li><p>6 &#x3D; Call held by Response and Hold</p>
</li>
</ul>
</li>
<li><p>mode&#x3D; 0 (Voice), 1 (Data), 2 (FAX)</p>
</li>
<li><p>mpty&#x3D;</p>
<ul>
<li>0 - this call is NOT a member of a multi-party (conference) call</li>
<li>1 - this call IS a member of a multi-party (conference) call</li>
</ul>
</li>
<li><p>number (optional)</p>
</li>
<li><p>type (optional)</p>
</li>
</ul>
</li>
<li><p>AT+COPS: AT+COPS&#x3D;3,0将被HF发送给AG</p>
</li>
<li><p>AT+CMEE: 使能+CME ERROR: <err>结果码</p>
</li>
<li><p>+CME ERROR</p>
<ul>
<li>+CME ERROR: 0 – AG failure</li>
</ul>
</li>
<li><p>AT+CLIP: Calling Line Identification notification 使能命令，It enables&#x2F;disables the Calling Line Identification notification unsolicited result code 。</p>
</li>
<li><p>+CLIP : Standard “Calling Line Identification notification” unsolicited result code.  </p>
</li>
<li><p>AT+CMER :Standard event reporting activation&#x2F;deactivation AT command.  </p>
</li>
<li><p>+CIEV: “indicator events reporting”结果码。<code>&lt;ind&gt;</code>,<code>&lt;value&gt;</code> result code ，对应AT+CIND 返回的列表中的参数和值。</p>
</li>
<li><p>AT+VTS: DTMF生成命令。</p>
</li>
<li><p>AT+CNUM: HF相应<code>+CNUM</code>命令</p>
<ul>
<li>AT+CNUM (Retrieve Subscriber Number Information)</li>
<li>AT+CNUM&#x3D;? (Test Subscriber Number Information – Not Implemented)</li>
</ul>
</li>
<li><p>+CNUM:  用于将“ Subscriber Number Information ”从AG发送到HF的标准响应。</p>
</li>
</ul>
<p>HFP协议扩展的AT命令：</p>
<ul>
<li>AT+BIA (Bluetooth Indicators Activation)  </li>
<li>AT+BINP (Bluetooth INPut)  </li>
<li>AT+BLDN (Bluetooth Last Dialed Number)  </li>
<li>AT+BVRA (Bluetooth Voice Recognition Activation)  </li>
<li>+BVRA (Bluetooth Voice Recognition Activation)  </li>
<li>AT+BRSF (Bluetooth Retrieve Supported Features)  </li>
<li>+BRSF (Bluetooth Retrieve Supported Features)   </li>
<li>AT+NREC (Noise Reduction and Echo Canceling)  </li>
<li>AT+VGM (Gain of Microphone)  </li>
<li>AT+VGS (Gain of Speaker)  </li>
<li>+VGM (Gain of Microphone)  </li>
<li>+VGS (Gain of Speaker)  </li>
<li>+BSIR (Bluetooth Setting of In-band Ring tone)  </li>
<li>AT+BTRH (Bluetooth Response and Hold Feature)  </li>
<li>+BTRH (Bluetooth Response and Hold Feature)  </li>
<li>AT+BCC (Bluetooth Codec Connection)  </li>
<li>AT+BCS (Bluetooth Codec Selection)  </li>
<li>+BCS (Bluetooth Codec Selection)  </li>
<li>AT+BAC (Bluetooth Available Codecs)  </li>
<li>AT+BIND (Bluetooth HF Indicators Feature)  </li>
<li>+BIND (Bluetooth HF Indicators Feature)  </li>
<li>AT+BIEV (Bluetooth HF Indicators Feature)</li>
</ul>
<h3 id="建立服务连接"><a href="#建立服务连接" class="headerlink" title="建立服务连接"></a>建立服务连接</h3><blockquote>
<p>Upon a user action or an internal event, either the HF or the AG may initiate a <strong>Service Level Connection</strong><br><strong>establishment</strong> procedure.<br>A Service Level Connection establishment requires the existence of a RFCOMM connection, that is, a<br>RFCOMM data link channel between the HF and the AG.<br>Both the HF and the AG may initiate the RFCOMM connection establishment. If there is no RFCOMM<br>session between the AG and the HF, the initiating device shall first initialize RFCOMM.  </p>
</blockquote>
<p>连接过程如下：</p>
<p><img data-src="https://s1.ax1x.com/2022/04/11/LV6DxS.png"></p>
<ol>
<li><p>支持能力交换<br>首先HF发送AT+BRSF&#x3D;&lt; HF supported features &gt;给AG，目的是首先通知AG其具有的能力，其次接收AG返回的其自身的BRSF能力。</p>
</li>
<li><p>Codec协商<br>如果HF支持Codec Negotiation特征，其会查看AG返回的BRSF中是否也支持该特性，如果都支持该特性，则HF将发送AT+BAC&#x3D;&lt; HF available codecs &gt;命令给AG以告知其可用的codec。</p>
</li>
<li><p>AG Indicator<br>HF从AG接收到的BRSF，可以知道AG支持的Indicator，并按顺序拍好，这是因为根据3GPP 27.007规范，AG可以支持Hands-Free不支持的profile。HF使用AT+CIND&#x3D;?测试命令接收AG支持的indicator以及它们的次序。<br>当HF获得必须的Indicator和它们的次序，它将通过AT+CIND?命令取得AG端正在使用indicator的状态。<br>当HF取得AG的indicator后，HF会使用AT+CMER使能AG的indicator状态跟新功能，AG会返回OK作为应答。当service，call或者call建立状态发生时，AG将发送和indicator相关的+CIEV结果码给HF。HF根据收到的+CIEV码来跟新其自身内部的indicator。<br>AG侧会一直保持indicator状态跟新功能使能直到收到AT+CMER指示其关闭或者HF和AG端的Service Level Connection连接断开。<br>当HF使能AG的indicator状态跟新，如果AG和HF都支持呼叫等待（Call waiting）和3方通信（3-way calling）。HF将发送AT+CHLD&#x3D;?测试命令取得AG是如何支持这种功能的。如果HF或者AG其中之一不支持三方通信，AT+CHLD&#x3D;?命令不会被发送。</p>
</li>
<li><p>HF Indicator<br>如果HF支持HF indicator，其会查看AG是否支持HF indicator。<br>如果HF和AG支持HF indicator特性，HF将发送AT+BIND&#x3D;&lt; HF supported HF indicators &gt;通知HF侧支持的indicator，AG以OK应答。<br>当AG接收到HF告知的HF indicator特性，HF将发送AT+BIND&#x3D;?请求AG侧支持的HF indicator。AG将会以+BIND和以OK结尾的应答。<br>当HF接收到AG支持的HF indicator，HF将会发送AT+BIND?命令确定HF目前使能的HF indicator。AG将会一次或多次以+BIND应答和以OK结尾的应答。<br>至此HF可能发送AT+BIEV命令告知AG其使能的HF indicator发生变化。<br>AG可以使用+BIND使能或者禁止任何HF indicator。</p>
</li>
<li><p>End of Service Level Connection</p>
<ul>
<li><p>HF需要知道Service Level Connection被完全建立，这可以通过以下几个方式：</p>
<ul>
<li>当且仅当AG通过+BRSF命令告知HF其支持的<code>&quot;HF indicator&quot;</code>，在HF收到AG通过<strong>AT+BIND？</strong>命令发来的其支持的<code>&quot;HF indicator&quot;</code>可认为完全建立。</li>
<li>当且仅当SDP服务发现AH和AG双方均支持<code>&quot;Call waiting and 3-way calling&quot;</code>，在HFAG通过<strong>AT+CHLD</strong>命令发来的其对呼叫等待和多方电话的支持，对这种情况，<code>&quot;HF indicator&quot;</code>不要设置该比特位，AG也不要在+BRSF命令中设置该比特位。</li>
<li>在HF使用<strong>AT+CMER</strong>命令成功启用<code>“Indicator status update”</code>功能，对这种情况SDP服务不应该设置<code>“Call waiting and 3-way calling”</code>比特位。<br>如果HF收到AG通过indicator指示当前有电话时，HF查询AG的接听和保持状态来判断是否是未接听电话。</li>
</ul>
</li>
<li><p>同样AG侧Service Level Connection完全建立也有几种情况：</p>
<ul>
<li><p>当且仅当HF indicator在HF被设置且AG侧支持的indicator已经通过+BRSF命令应答，则AG以**+BIND加OK结尾**的命令应答其使能的HF indicator时可认为Service Level Connection完全建立。</p>
</li>
<li><p>当且仅当<code>“Call waiting and 3-way calling”</code>比特在HF和AG的SDP服务中被置位，在AG通过**+CHLD加OK结尾**命令成功响应其对呼叫保持和多方电话支持时SLC会被完全建立。对这种情况，+BRSF不应该设置该HF indicator比特位。</p>
</li>
<li><p>AG已成功<strong>响应OK到AT + CMER</strong>命令（启用<code>“Indicator status update”</code>功能。）当<code>“Call waiting and 3-way calling”</code>位时，应适用这种情况未在支持的功能位图中设置为HF或AG，以及<code>“HF Indicators ”</code>对于通过+ BRSF交换的HF或AG的支持功能位图中未设置位的位图命令。</p>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">#判断是否支持&quot;Call waiting and 3-way calling&quot;</span><br><span class="line">#AG发现HF, hfP支持的协议,HF支持&quot;Call waiting and 3-way calling&quot;</span><br><span class="line">&gt; 596	17.850811	XiaomiCo_6e:38:c5 (PHONE)	SANYOEle_62:35:bb (DEVICE)	SDP	36	Rcvd Service Search Attribute Request : Handsfree: [Service Class ID List 0x0001] [Protocol Descriptor List 0x0004] [Bluetooth Profile Descriptor List 0x0009] [(HFP HS) Supported Features 0x0311] </span><br><span class="line">&gt; 597	17.851437	SANYOEle_62:35:bb (DEVICE)	XiaomiCo_6e:38:c5 (PHONE)	SDP	69	Sent Service Search Attribute Response </span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth SDP Protocol</span><br><span class="line">    PDU: Service Search Attribute Response (0x07)</span><br><span class="line">    Transaction Id: 0x0000</span><br><span class="line">    Parameter Length: 55</span><br><span class="line">    Attribute List Byte Count: 52</span><br><span class="line">    Attribute Lists [count =  1]</span><br><span class="line">        Data Element: Sequence uint8 50 bytes</span><br><span class="line">            0011 0... = Data Element Type: Sequence (6)</span><br><span class="line">            .... .101 = Data Element Size: uint8 (5)</span><br><span class="line">            Data Element Var Size: 50</span><br><span class="line">            Data Value</span><br><span class="line">                Attribute List [count =  4] (Handsfree)</span><br><span class="line">                    Data Element: Sequence uint16 47 bytes</span><br><span class="line">                        0011 0... = Data Element Type: Sequence (6)</span><br><span class="line">                        .... .110 = Data Element Size: uint16 (6)</span><br><span class="line">                        Data Element Var Size: 47</span><br><span class="line">                        Data Value</span><br><span class="line">                            Service Attribute: Service Class ID List (0x1), value = Handsfree -&gt; Generic Audio</span><br><span class="line">                            Service Attribute: Protocol Descriptor List (0x4), value = L2CAP -&gt; RFCOMM:2</span><br><span class="line">                            Service Attribute: Bluetooth Profile Descriptor List (0x9), value = Handsfree 1.6</span><br><span class="line">                            Service Attribute: (HFP HS) Supported Features (0x311), value = (EC and/or Nr Function) (Call Waiting or Three Way Calling) (CLI Presentation Capability) (Voice Recognition Activation) (Remote Volume Control) (Wide Band Speech) </span><br><span class="line">    Continuation State: no (00)</span><br><span class="line"></span><br><span class="line">#HF发现AG, hfP支持的协议,AG不支持&quot;Call waiting and 3-way calling&quot;，只支持&quot;3-way calling&quot;</span><br><span class="line">&gt; 637	18.017460	SANYOEle_62:35:bb (DEVICE)	XiaomiCo_6e:38:c5 (PHONE)	SDP	33	Sent Service Search Attribute Request : Handsfree Audio Gateway: [Service Class ID List 0x0001] [Bluetooth Profile Descriptor List 0x0009] [(HFP AG) Supported Features 0x0311] </span><br><span class="line">&gt; 644	18.024689	XiaomiCo_6e:38:c5 (PHONE)	SANYOEle_62:35:bb (DEVICE)	SDP	52	Rcvd Service Search Attribute Response </span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth SDP Protocol</span><br><span class="line">    PDU: Service Search Attribute Response (0x07)</span><br><span class="line">    Transaction Id: 0x0000</span><br><span class="line">    Parameter Length: 38</span><br><span class="line">    Attribute List Byte Count: 35</span><br><span class="line">    Attribute Lists [count =  1]</span><br><span class="line">        Data Element: Sequence uint8 33 bytes</span><br><span class="line">            0011 0... = Data Element Type: Sequence (6)</span><br><span class="line">            .... .101 = Data Element Size: uint8 (5)</span><br><span class="line">            Data Element Var Size: 33</span><br><span class="line">            Data Value</span><br><span class="line">                Attribute List [count =  3] (Handsfree Audio Gateway)</span><br><span class="line">                    Data Element: Sequence uint16 30 bytes</span><br><span class="line">                        0011 0... = Data Element Type: Sequence (6)</span><br><span class="line">                        .... .110 = Data Element Size: uint16 (6)</span><br><span class="line">                        Data Element Var Size: 30</span><br><span class="line">                        Data Value</span><br><span class="line">                            Service Attribute: Service Class ID List (0x1), value = Handsfree Audio Gateway -&gt; Generic Audio</span><br><span class="line">                            Service Attribute: Bluetooth Profile Descriptor List (0x9), value = Handsfree 1.6</span><br><span class="line">                            Service Attribute: (HFP AG) Supported Features (0x311), value = (Three Way Calling) (EC and/or Nr Function) (Voice Recognition Function) (Wide Band Speech) </span><br><span class="line">    Continuation State: no (00)</span><br><span class="line"></span><br><span class="line">#HFP建立连接</span><br><span class="line">#交换支持功能，AG和HF都不支持&quot;HF indicator&quot;</span><br><span class="line">&gt; 634	18.012482	SANYOEle_62:35:bb (DEVICE)	XiaomiCo_6e:38:c5 (PHONE)	HFP	26	Sent AT+BRSF=255</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HFP Profile</span><br><span class="line">    [Role: HS - Headset (2)]</span><br><span class="line">    AT Stream: AT+BRSF=255\r</span><br><span class="line">    Command 0: +BRSF</span><br><span class="line">        Command Line Prefix: AT</span><br><span class="line">        Command: +BRSF (Bluetooth Retrieve Supported Features)</span><br><span class="line">        Type: Action Command (0x003d)</span><br><span class="line">        Parameters</span><br><span class="line">            HS supported features bitmask: 255</span><br><span class="line">                .... .... .... .... .... .... .... ...1 = EC and/or NR function: True</span><br><span class="line">                .... .... .... .... .... .... .... ..1. = Call waiting or 3-way calling: True</span><br><span class="line">                .... .... .... .... .... .... .... .1.. = CLI Presentation: True</span><br><span class="line">                .... .... .... .... .... .... .... 1... = Voice Recognition Activation: True</span><br><span class="line">                .... .... .... .... .... .... ...1 .... = Remote Volume Control: True</span><br><span class="line">                .... .... .... .... .... .... ..1. .... = Enhanced Call Status: True</span><br><span class="line">                .... .... .... .... .... .... .1.. .... = Enhanced Call Control: True</span><br><span class="line">                .... .... .... .... .... .... 1... .... = Codec Negotiation: True</span><br><span class="line">                .... .... .... .... .... ...0 .... .... = HF Indicators: False</span><br><span class="line">                .... .... .... .... .... ..0. .... .... = eSCO S4 (and T2) Settings Support: False</span><br><span class="line">                0000 0000 0000 0000 0000 00.. .... .... = Reserved: 0x000000</span><br><span class="line">&gt; 641	18.022446	XiaomiCo_6e:38:c5 (PHONE)	SANYOEle_62:35:bb (DEVICE)	HFP	28	Rcvd   +BRSF: 871</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HFP Profile</span><br><span class="line">    [Role: AG - Audio Gate (1)]</span><br><span class="line">    AT Stream: \r\n+BRSF: 871\r\n</span><br><span class="line">    Command 0: +BRSF</span><br><span class="line">        Command: +BRSF (Bluetooth Retrieve Supported Features)</span><br><span class="line">        Type: Response (0x003a)</span><br><span class="line">        Parameters</span><br><span class="line">            AG supported features bitmask: 871</span><br><span class="line">                .... .... .... .... .... .... .... ...1 = Three Way Calling: True</span><br><span class="line">                .... .... .... .... .... .... .... ..1. = EC and/or NR function: True</span><br><span class="line">                .... .... .... .... .... .... .... .1.. = Voice Recognition Function: True</span><br><span class="line">                .... .... .... .... .... .... .... 0... = In-band Ring Tone: False</span><br><span class="line">                .... .... .... .... .... .... ...0 .... = Attach Number to Voice Tag: False</span><br><span class="line">                .... .... .... .... .... .... ..1. .... = Ability to Reject a Call: True</span><br><span class="line">                .... .... .... .... .... .... .1.. .... = Enhanced Call Status: True</span><br><span class="line">                .... .... .... .... .... .... 0... .... = Enhanced Call Control: False</span><br><span class="line">                .... .... .... .... .... ...1 .... .... = Extended Error Result Codes: True</span><br><span class="line">                .... .... .... .... .... ..1. .... .... = Codec Negotiation: True</span><br><span class="line">                .... .... .... .... .... .0.. .... .... = HF Indicators: False</span><br><span class="line">                .... .... .... .... .... 0... .... .... = eSCO S4 (and T2) Settings Support: False</span><br><span class="line">                0000 0000 0000 0000 0000 .... .... .... = Reserved: 0x00000</span><br><span class="line"></span><br><span class="line">#AG和HF都支持&quot;Codec Negotiation&quot;，HF告知AG其可用的Codec编码(CVSD)</span><br><span class="line">&gt; 643	18.023696	SANYOEle_62:35:bb (DEVICE)	XiaomiCo_6e:38:c5 (PHONE)	HFP	23	Sent AT+BAC=1</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HFP Profile</span><br><span class="line">    [Role: HS - Headset (2)]</span><br><span class="line">    AT Stream: AT+BAC=1\r</span><br><span class="line">    Command 0: +BAC</span><br><span class="line">        Command Line Prefix: AT</span><br><span class="line">        Command: +BAC (Bluetooth Available Codecs)</span><br><span class="line">        Type: Action Command (0x003d)</span><br><span class="line">        Parameters</span><br><span class="line">            Codec: CVSD (1)</span><br><span class="line"></span><br><span class="line">#获取AG支持的indicator以及它们的次序</span><br><span class="line">&gt; 649	18.029340	SANYOEle_62:35:bb (DEVICE)	XiaomiCo_6e:38:c5 (PHONE)	HFP	24	Sent AT+CIND=? </span><br><span class="line">&gt; 652	18.035680	XiaomiCo_6e:38:c5 (PHONE)	SANYOEle_62:35:bb (DEVICE)	HFP	147	Rcvd   +CIND: (&quot;CALL&quot;,(0,1)),(&quot;CALLSETUP&quot;,(0-3)),(&quot;SERVICE&quot;,(0-1)),(&quot;SIGNAL&quot;,(0-5)),(&quot;ROAM&quot;,(0,1)),(&quot;BATTCHG&quot;,(0-5)),(&quot;CALLHELD&quot;,(0-2)) </span><br><span class="line"></span><br><span class="line">#获取AG indicators当前的状态</span><br><span class="line">&gt; 654	18.037547	SANYOEle_62:35:bb (DEVICE)	XiaomiCo_6e:38:c5 (PHONE)	HFP	23	Sent AT+CIND? </span><br><span class="line">&gt; 656	18.092460	XiaomiCo_6e:38:c5 (PHONE)	SANYOEle_62:35:bb (DEVICE)	HFP	38	Rcvd   +CIND: 0,0,1,5,0,2,0</span><br><span class="line"></span><br><span class="line">#标志HFP连接建立</span><br><span class="line">#启用&quot;Indicator status update&quot;</span><br><span class="line">&gt; 658	18.093591	SANYOEle_62:35:bb (DEVICE)	XiaomiCo_6e:38:c5 (PHONE)	HFP	30	Sent AT+CMER=3,0,0,1</span><br><span class="line">&gt; 660	18.117156	XiaomiCo_6e:38:c5 (PHONE)	SANYOEle_62:35:bb (DEVICE)	HFP	20	Rcvd   OK  </span><br></pre></td></tr></table></figure>

<h3 id="HF拨打-挂断电话"><a href="#HF拨打-挂断电话" class="headerlink" title="HF拨打\挂断电话"></a>HF拨打\挂断电话</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#HF拨打电话</span><br><span class="line">&gt; 921	29.433324	SANYOEle_62:35:bb (DEVICE)	XiaomiCo_6e:38:c5 (PHONE)	HFP	24	Sent ATD10086; </span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HFP Profile</span><br><span class="line">    [Role: HS - Headset (2)]</span><br><span class="line">    AT Stream: ATD10086;\r</span><br><span class="line">    Command 0: D</span><br><span class="line">        Command Line Prefix: AT</span><br><span class="line">        Command: D (Dial)</span><br><span class="line">        [Expert Info (Warning/Protocol): Non mandatory type or command in this role]</span><br><span class="line">        Parameters: No</span><br><span class="line">&gt; 924	30.778650	XiaomiCo_6e:38:c5 (PHONE)	SANYOEle_62:35:bb (DEVICE)	HFP	20	Rcvd   OK</span><br><span class="line"></span><br><span class="line">#挂断电话</span><br><span class="line">&gt; 965	37.723080	SANYOEle_62:35:bb (DEVICE)	XiaomiCo_6e:38:c5 (PHONE)	HFP	22	Sent AT+CHUP</span><br><span class="line">&gt; 966	37.752000	XiaomiCo_6e:38:c5 (PHONE)	SANYOEle_62:35:bb (DEVICE)	HFP	20	Rcvd   OK</span><br></pre></td></tr></table></figure>

<h3 id="HF获取通话电话列表"><a href="#HF获取通话电话列表" class="headerlink" title="HF获取通话电话列表"></a>HF获取通话电话列表</h3><p>会HF会轮询此命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&gt; 925	30.779082	SANYOEle_62:35:bb (DEVICE)	XiaomiCo_6e:38:c5 (PHONE)	HFP	22	Sent AT+CLCC </span><br><span class="line">&gt; 929	30.820871	XiaomiCo_6e:38:c5 (PHONE)	SANYOEle_62:35:bb (DEVICE)	HFP	46	Rcvd   +CLCC: 1,0,2,0,0,&quot;10086&quot;,129 </span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HFP Profile</span><br><span class="line">    [Role: AG - Audio Gate (1)]</span><br><span class="line">    AT Stream: \r\n+CLCC: 1,0,2,0,0,&quot;10086&quot;,129\r\n</span><br><span class="line">    Command 0: +CLCC</span><br><span class="line">        Command: +CLCC (Current Calls)</span><br><span class="line">        Type: Response (0x003a)</span><br><span class="line">        Parameters</span><br><span class="line">            ID: 1</span><br><span class="line">            Direction: Mobile Originated (0)</span><br><span class="line">            State: Dialing (2)</span><br><span class="line">            Mode: Voice (0)</span><br><span class="line">            Mpty: Call is not one of multiparty (conference) call parties (0)</span><br><span class="line">            Number: &quot;10086&quot;</span><br><span class="line">            Type: The phone number format may be a national or international format, and may contain prefix and/or escape digits. No changes on the number presentation are required. (129)</span><br></pre></td></tr></table></figure>

<h3 id="AG下发通话状态"><a href="#AG下发通话状态" class="headerlink" title="AG下发通话状态"></a>AG下发通话状态</h3><p>在开启<code>&quot;Indicator status update&quot;</code>(AT+CMER)之后，AG会主动下发当前的通话状态，<code>Indicator Index</code>对应+CIND返回的参数列表，<code>Indicator &lt;idx&gt;</code>对应其值。</p>
<h4 id="拨打电话"><a href="#拨打电话" class="headerlink" title="拨打电话"></a>拨打电话</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#CALLSETUP=2,拨号中</span><br><span class="line">&gt; 1056	66.689969	XiaomiCo_6e:38:c5 (PHONE)	SANYOEle_62:35:bb (DEVICE)	HFP	27	Rcvd   +CIEV: 2,2  </span><br></pre></td></tr></table></figure>

<h4 id="无通话或者挂断"><a href="#无通话或者挂断" class="headerlink" title="无通话或者挂断"></a>无通话或者挂断</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#CALL=0,无通话</span><br><span class="line">1106	74.975552	XiaomiCo_6e:38:c5 (PHONE)	SANYOEle_62:35:bb (DEVICE)	HFP	27	Rcvd   +CIEV: 1,0  </span><br></pre></td></tr></table></figure>

<h4 id="来电"><a href="#来电" class="headerlink" title="来电"></a>来电</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#CALLSETUP=1,来电中</span><br><span class="line">&gt; 1056	66.689969	XiaomiCo_6e:38:c5 (PHONE)	SANYOEle_62:35:bb (DEVICE)	HFP	27	Rcvd   +CIEV: 2,1 </span><br></pre></td></tr></table></figure>
<h3 id="建立SCO-x2F-eSCO连接"><a href="#建立SCO-x2F-eSCO连接" class="headerlink" title="建立SCO&#x2F;eSCO连接"></a>建立SCO&#x2F;eSCO连接</h3><p>蓝牙电话的音频数据由SCO&#x2F;eSCO协议传输，在HCI中无数据相关的日志。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">#HF选择编解码格式</span><br><span class="line">&gt; 900	387.320548	XiaomiCo_6e:38:c5 (PHONE)	localhost ()	HFP	24	Rcvd   +BCS: 1  </span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HFP Profile</span><br><span class="line">    [Role: AG - Audio Gate (1)]</span><br><span class="line">    AT Stream: \r\n+BCS: 1\r\n</span><br><span class="line">    Command 0: +BCS</span><br><span class="line">        Command: +BCS (Bluetooth Codec Selection)</span><br><span class="line">        Type: Response (0x003a)</span><br><span class="line">        Parameters</span><br><span class="line">            Codec: CVSD (1)</span><br><span class="line">&gt; 903	387.380459	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	HFP	23	Sent AT+BCS=1 </span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HFP Profile</span><br><span class="line">    [Role: HS - Headset (2)]</span><br><span class="line">    AT Stream: AT+BCS=1\r</span><br><span class="line">    Command 0: +BCS</span><br><span class="line">        Command Line Prefix: AT</span><br><span class="line">        Command: +BCS (Bluetooth Codec Selection)</span><br><span class="line">        Type: Action Command (0x003d)</span><br><span class="line">        Parameters</span><br><span class="line">            Codec: CVSD (1)</span><br><span class="line"></span><br><span class="line">#AG请求建立eSCO连接</span><br><span class="line">&gt; 906	387.530834	controller	host	HCI_EVT	13	Rcvd Connect Request</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Event - Connect Request</span><br><span class="line">    Event Code: Connect Request (0x04)</span><br><span class="line">    Parameter Total Length: 10</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line">    Class of Device: 0x001f00 (Uncategorized: device code not specified:Unknown - services:)</span><br><span class="line">    Link Type: eSCO connection (Voice Channels) (0x02)</span><br><span class="line"></span><br><span class="line">#HF允许建立eSCO连接</span><br><span class="line">&gt; 907	387.531078	host	controller	HCI_CMD	67	Sent Enhanced Accept Synchronous Connection Request</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Command - Enhanced Accept Synchronous Connection Request</span><br><span class="line">    Command Opcode: Enhanced Accept Synchronous Connection Request (0x043e)</span><br><span class="line">        0000 01.. .... .... = Opcode Group Field: Link Control Commands (0x01)</span><br><span class="line">        .... ..00 0011 1110 = Opcode Command Field: Enhanced Accept Synchronous Connection Request (0x03e)</span><br><span class="line">    Parameter Total Length: 63</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line">    Tx Bandwidth (bytes/s): 8000</span><br><span class="line">    Rx Bandwidth (bytes/s): 8000</span><br><span class="line">    Transmit Coding Format</span><br><span class="line">    Receive Coding Format</span><br><span class="line">    Transmit Codec Frame Size: 60</span><br><span class="line">    Receive Codec Frame Size: 60</span><br><span class="line">    Input Bandwidth: 16000</span><br><span class="line">    Output Bandwidth: 16000</span><br><span class="line">    Input Coding Format</span><br><span class="line">    Output Coding Format</span><br><span class="line">    Input Coded Data Size: 16</span><br><span class="line">    Output Coded Data Size: 16</span><br><span class="line">    Input PCM Data Format: 2&#x27;s complement (0x02)</span><br><span class="line">    Output PCM Data Format: 2&#x27;s complement (0x02)</span><br><span class="line">    Input PCM Sample Payload MSB Position: 0</span><br><span class="line">    Output PCM Sample Payload MSB Position: 0</span><br><span class="line">    Input Data Path: Vendor Specific</span><br><span class="line">    Output Data Path: Vendor Specific</span><br><span class="line">    Input Transport Unit Size: 16</span><br><span class="line">    Output Transport Unit Size: 16</span><br><span class="line">    Max. Latency (ms): 12</span><br><span class="line">    Packet Type: 0x03bf, 3-EV5 may NOT be used, 2-EV5 may NOT be used, 3-EV3 may NOT be used, EV5 may be used, EV4 may be used, EV3 may be used, HV3 may be used, HV2 may be used, HV1 may be used</span><br><span class="line">    Retransmission Effort: At least 1 retransmission, optimize for link quality (2)</span><br><span class="line">    [Pending in frame: 909]</span><br><span class="line">    [Command-Pending Delta: 1.38ms]</span><br><span class="line">    [Response in frame: 910]</span><br><span class="line">    [Command-Response Delta: 3.862ms]</span><br><span class="line"></span><br><span class="line">#eSCO连接成功</span><br><span class="line">&gt; 910	387.534940	controller	host	HCI_EVT	20	Rcvd Synchronous Connection Complete</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth HCI Event - Synchronous Connection Complete</span><br><span class="line">    Event Code: Synchronous Connection Complete (0x2c)</span><br><span class="line">    Parameter Total Length: 17</span><br><span class="line">    Status: Success (0x00)</span><br><span class="line">    Connection Handle: 0x0e00</span><br><span class="line">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class="line">    Link Type: eSCO connection (0x02)</span><br><span class="line">    Transmit Interval: 12 slots (7.5 msec)</span><br><span class="line">    Retransmit Window: 2 slots (1.25 msec)</span><br><span class="line">    Rx Packet Length: 60</span><br><span class="line">    Tx Packet Length: 60</span><br><span class="line">    Air Mode: CVSD (2)</span><br><span class="line">    [Command in frame: 907]</span><br><span class="line">    [Pending in frame: 909]</span><br><span class="line">    [Pending-Response Delta: 2.482ms]</span><br><span class="line">    [Command-Response Delta: 3.862ms]</span><br></pre></td></tr></table></figure>

<h1 id="蓝牙音乐"><a href="#蓝牙音乐" class="headerlink" title="蓝牙音乐"></a>蓝牙音乐</h1><h2 id="AVDTP"><a href="#AVDTP" class="headerlink" title="AVDTP"></a>AVDTP</h2><p><strong>AVDTP：AUDIO&#x2F;VIDEO DISTRIBUTION TRANSPORT PROTOCOL(音视频分配传输协议)</strong> ，用于音乐数据流的建立与传输控制。</p>
<h3 id="建立连接"><a href="#建立连接" class="headerlink" title="建立连接"></a>建立连接</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; 458	11.574257	SANYOEle_62:35:bb (DEVICE)	XiaomiCo_6e:38:c5 (PHONE)	L2CAP	17	Sent Connection Request (AVDTP, SCID: 0x0042)</span><br></pre></td></tr></table></figure>

<h3 id="数据流传输"><a href="#数据流传输" class="headerlink" title="数据流传输"></a>数据流传输</h3><p>数据流的生命状态：</p>
<p><img data-src="https://s1.ax1x.com/2022/04/11/LV6NVA.png"></p>
<h4 id="查找-Idle"><a href="#查找-Idle" class="headerlink" title="查找(Idle)"></a>查找(Idle)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#查询AG的所有音源</span><br><span class="line">&gt; 468	11.652772	SANYOEle_62:35:bb (DEVICE)	XiaomiCo_6e:38:c5 (PHONE)	AVDTP	11	Sent Command - Discover</span><br><span class="line">&gt; 469	11.722467	XiaomiCo_6e:38:c5 (PHONE)	SANYOEle_62:35:bb (DEVICE)	AVDTP	15	Rcvd ResponseAccept - Discover - items: 2</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth AVDTP Protocol</span><br><span class="line">    Signal: Discover (ResponseAccept)</span><br><span class="line">    ACP SEP [1 - Audio Source] item 1/2</span><br><span class="line">        0000 01.. = SEID: 1</span><br><span class="line">        .... ..0. = In Use: False (0x0)</span><br><span class="line">        .... ...0 = RFA0: 0x0</span><br><span class="line">        0000 .... = Media Type: Audio (0x0)</span><br><span class="line">        .... 0... = Type: Source (0x0)</span><br><span class="line">        .... .000 = RFA1: 0x0</span><br><span class="line">    ACP SEP [2 - Audio Source] item 2/2</span><br><span class="line">        0000 10.. = SEID: 2</span><br><span class="line">        .... ..0. = In Use: False (0x0)</span><br><span class="line">        .... ...0 = RFA0: 0x0</span><br><span class="line">        0000 .... = Media Type: Audio (0x0)</span><br><span class="line">        .... 0... = Type: Source (0x0)</span><br><span class="line">        .... .000 = RFA1: 0x0</span><br><span class="line"></span><br><span class="line">#获取音源详细信息</span><br><span class="line">&gt; 470	11.722896	SANYOEle_62:35:bb (DEVICE)	XiaomiCo_6e:38:c5 (PHONE)	AVDTP	12	Sent Command - GetAllCapabilities - ACP SEID [1 - Audio Source]</span><br><span class="line">&gt; 473	11.728705	XiaomiCo_6e:38:c5 (PHONE)	SANYOEle_62:35:bb (DEVICE)	AVDTP	23	Rcvd ResponseAccept - GetAllCapabilities - Audio SBC (44100 | Mono JointStereo | block: 4 8 12 16 | subbands: 8 | allocation: Loudness | bitpool: 2..53)</span><br><span class="line">&gt; 474	11.728960	SANYOEle_62:35:bb (DEVICE)	XiaomiCo_6e:38:c5 (PHONE)	AVDTP	12	Sent Command - GetAllCapabilities - ACP SEID [2 - Audio Source]</span><br><span class="line">&gt; 476	11.734811	XiaomiCo_6e:38:c5 (PHONE)	SANYOEle_62:35:bb (DEVICE)	AVDTP	25	Rcvd ResponseAccept - GetAllCapabilities - Audio MPEG-2,4 AAC</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth AVDTP Protocol</span><br><span class="line">    Signal: GetAllCapabilities (ResponseAccept)</span><br><span class="line">        0010 .... = Transaction: 0x2</span><br><span class="line">        .... 00.. = Packet Type: Single (0x0)</span><br><span class="line">        .... ..10 = Message Type: ResponseAccept (0x2)</span><br><span class="line">        00.. .... = RFA: 0x0</span><br><span class="line">        ..00 1100 = Signal: GetAllCapabilities (0x0c)</span><br><span class="line">    Capabilities</span><br><span class="line">        Service: Media Transport</span><br><span class="line">        Service: Media Codec - Audio MPEG-2,4 AAC</span><br><span class="line">        Service: Delay Reporting</span><br></pre></td></tr></table></figure>

<h4 id="设置-x2F-打开-Configured-x2F-Open"><a href="#设置-x2F-打开-Configured-x2F-Open" class="headerlink" title="设置&#x2F;打开(Configured&#x2F;Open)"></a>设置&#x2F;打开(Configured&#x2F;Open)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#选择对应音源</span><br><span class="line">&gt; 477	11.735508	SANYOEle_62:35:bb (DEVICE)	XiaomiCo_6e:38:c5 (PHONE)	AVDTP	25	Sent Command - SetConfiguration - ACP SEID [2 - Audio Source] - INT SEID [2 - Audio Source] - Audio MPEG-2,4 AAC</span><br><span class="line">&gt; 479	11.742210	XiaomiCo_6e:38:c5 (PHONE)	SANYOEle_62:35:bb (DEVICE)	AVDTP	11	Rcvd ResponseAccept - SetConfiguration</span><br><span class="line"></span><br><span class="line">#打开音源</span><br><span class="line">&gt; 480	11.742538	SANYOEle_62:35:bb (DEVICE)	XiaomiCo_6e:38:c5 (PHONE)	AVDTP	12	Sent Command - Open - ACP SEID [2 - Audio Source]</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth AVDTP Protocol</span><br><span class="line">    Signal: Open (Command)</span><br><span class="line">    ACP SEID [2 - Audio Source]</span><br><span class="line">&gt; 485	11.747312	XiaomiCo_6e:38:c5 (PHONE)	SANYOEle_62:35:bb (DEVICE)	AVDTP	11	Rcvd ResponseAccept - Open</span><br></pre></td></tr></table></figure>

<h4 id="开始传输-Streaming"><a href="#开始传输-Streaming" class="headerlink" title="开始传输(Streaming)"></a>开始传输(Streaming)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; 601	28.945727	XiaomiCo_f2:31:c7 (PHONE)	SANYOEle_71:7b:5c (DEVICE)	AVDTP	12	Rcvd Command - Start - ACP SEID [2 - Audio Sink]</span><br><span class="line">&gt; 602	28.946025	SANYOEle_71:7b:5c (DEVICE)	XiaomiCo_f2:31:c7 (PHONE)	AVDTP	11	Sent ResponseAccept - Start</span><br></pre></td></tr></table></figure>

<h4 id="传输-Streaming"><a href="#传输-Streaming" class="headerlink" title="传输(Streaming)"></a>传输(Streaming)</h4><p>使用RTP协议传输数据，AVDTP协议本身不处理数据流。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&gt; 612	29.166322	XiaomiCo_f2:31:c7 (PHONE)	SANYOEle_71:7b:5c (DEVICE)	RTP	37	PT=Unknown, SSRC=0x2, Seq=1, Time=0</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Frame 612: 37 bytes on wire (296 bits), 37 bytes captured (296 bits)</span><br><span class="line">Bluetooth</span><br><span class="line">Bluetooth HCI H4</span><br><span class="line">Bluetooth HCI ACL Packet</span><br><span class="line">Bluetooth L2CAP Protocol</span><br><span class="line">Bluetooth A2DP Profile</span><br><span class="line">    [ACP SEID: 2]</span><br><span class="line">    [INT SEID: 2]</span><br><span class="line">    [Codec: MPEG-2,4 AAC (0x02)]</span><br><span class="line">    [Stream Start in Frame: 612]</span><br><span class="line">    [Stream End in Frame: 22786]</span><br><span class="line">    [Stream Number: 1]</span><br><span class="line">Real-Time Transport Protocol</span><br><span class="line">    [Stream setup by BT A2DP (frame 612)]</span><br><span class="line">    10.. .... = Version: RFC 1889 Version (2)</span><br><span class="line">    ..0. .... = Padding: False</span><br><span class="line">    ...0 .... = Extension: False</span><br><span class="line">    .... 0000 = Contributing source identifiers count: 0</span><br><span class="line">    0... .... = Marker: False</span><br><span class="line">    Payload type: Unknown (98)</span><br><span class="line">    Sequence number: 1</span><br><span class="line">    [Extended sequence number: 65537]</span><br><span class="line">    Timestamp: 0</span><br><span class="line">    Synchronization Source identifier: 0x00000002 (2)</span><br><span class="line">Data (16 bytes)</span><br><span class="line">    Data: 47fc0000b0908003000621100520a41c</span><br><span class="line">    [Length: 16]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="暂停-Streaming"><a href="#暂停-Streaming" class="headerlink" title="暂停(Streaming)"></a>暂停(Streaming)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; 773	23.510436	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	AVDTP	11	Sent ResponseAccept - Suspend</span><br></pre></td></tr></table></figure>

<h4 id="释放-Closing"><a href="#释放-Closing" class="headerlink" title="释放(Closing)"></a>释放(Closing)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; 5692	96.414176	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	AVDTP	12	Sent Command - Close - ACP SEID [2 - Audio Source]</span><br></pre></td></tr></table></figure>

<h2 id="AVCTP"><a href="#AVCTP" class="headerlink" title="AVCTP"></a>AVCTP</h2><p>**AVCTP： Audio&#x2F;Video Control Transport Protocol(音频&#x2F;视频控制传输协议)**，用于蓝牙设备间音乐数据流功能的发现与控制，但是控制的具体功能逻辑不由AVCTP处理，其只发送命令。</p>
<p>发现由SDP协议完成，然后发起L2CAP通道连接蓝牙设备之间的AVCTP服务，如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">#发现</span><br><span class="line">&gt; 134	0.964749	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	SDP	33	Sent Service Search Attribute Request : Audio Source: [Service Class ID List 0x0001] [Protocol Descriptor List 0x0004] [Bluetooth Profile Descriptor List 0x0009] </span><br><span class="line">&gt; 139	0.981837	XiaomiCo_6e:38:c5 (PHONE)	localhost ()	SDP	64	Rcvd Service Search Attribute Response </span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth SDP Protocol</span><br><span class="line">    PDU: Service Search Attribute Response (0x07)</span><br><span class="line">    Transaction Id: 0x0000</span><br><span class="line">    Parameter Length: 50</span><br><span class="line">    Attribute List Byte Count: 47</span><br><span class="line">    Attribute Lists [count =  1]</span><br><span class="line">        Data Element: Sequence uint8 45 bytes</span><br><span class="line">            0011 0... = Data Element Type: Sequence (6)</span><br><span class="line">            .... .101 = Data Element Size: uint8 (5)</span><br><span class="line">            Data Element Var Size: 45</span><br><span class="line">            Data Value</span><br><span class="line">                Attribute List [count =  3] (Audio Source)</span><br><span class="line">                    Data Element: Sequence uint16 42 bytes</span><br><span class="line">                        0011 0... = Data Element Type: Sequence (6)</span><br><span class="line">                        .... .110 = Data Element Size: uint16 (6)</span><br><span class="line">                        Data Element Var Size: 42</span><br><span class="line">                        Data Value</span><br><span class="line">                            Service Attribute: Service Class ID List (0x1), value = Audio Source</span><br><span class="line">                                Attribute ID: Service Class ID List</span><br><span class="line">                                Value</span><br><span class="line">                            Service Attribute: Protocol Descriptor List (0x4), value = L2CAP:25 -&gt; AVDTP (1.3)</span><br><span class="line">                                Attribute ID: Protocol Descriptor List</span><br><span class="line">                                Value</span><br><span class="line">                            Service Attribute: Bluetooth Profile Descriptor List (0x9), value = Advanced Audio Distribution 1.3</span><br><span class="line">                                Attribute ID: Bluetooth Profile Descriptor List</span><br><span class="line">                                Value</span><br><span class="line">    Continuation State: no (00)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#连接</span><br><span class="line">&gt; 147	1.006617	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	L2CAP	17	Sent Connection Request (AVDTP, SCID: 0x0043)</span><br><span class="line">&gt; 155	1.017317	XiaomiCo_6e:38:c5 (PHONE)	localhost ()	L2CAP	21	Rcvd Connection Response - Success (SCID: 0x0043, DCID: 0x0042)</span><br></pre></td></tr></table></figure>

<h2 id="AVRCP"><a href="#AVRCP" class="headerlink" title="AVRCP"></a>AVRCP</h2><p>**AVRCP：Audio&#x2F;Video Remote Control Profile(音频&#x2F;视频远程控制配置文件)**，用于控制蓝牙音乐的标准接口。</p>
<p>在AVRCP中，<strong>TG</strong>表示播放设备，<strong>CT</strong>表示控制设备。</p>
<h3 id="命令格式"><a href="#命令格式" class="headerlink" title="命令格式"></a>命令格式</h3><p>命令分为两个类型：VENDOR DEPENDENT 与PASS THROUGH，</p>
<ul>
<li><p>VENDOR DEPENDENT：通过<code>Ctype</code>与<code>PDU ID</code>来区分功能，<code>Ctype</code>有<strong>Control, Status , Notify</strong>,ACCEPTED,REJECTED, CHANGED,INTERIM,IMPLEMENTED,STABLE等。</p>
</li>
<li><p>PASS THROUGH：是播放控制命令，<code>Ctype</code>只有<strong>Control</strong>。</p>
</li>
</ul>
<p>其中请求命令<code>Ctype</code>为<strong>Notify</strong>，回复事件<code>Ctype</code>为<strong>Interim</strong>，事件通知<code>Ctype</code>为<strong>Changed</strong>。</p>
<h3 id="获取TG播放器支持功能"><a href="#获取TG播放器支持功能" class="headerlink" title="获取TG播放器支持功能"></a>获取TG播放器支持功能</h3><p><code>PDU ID</code>：GetFolderItems，通过<code>Scope</code>来区分功能，用于<strong>TG</strong>可以播放器列表与每个播放器支持的功能。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&gt; 307	1.551666	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	AVRCP	29	Sent Browsing: Command - GetFolderItems - Scope: MediaPlayerList, StartItem: 0x0000, EndItem: 0x0013</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth AVRCP Profile</span><br><span class="line">    PDU ID: GetFolderItems (0x71)</span><br><span class="line">    Parameter Length: 10</span><br><span class="line">    Scope: MediaPlayerList (0x00)</span><br><span class="line">    StartItem: 0</span><br><span class="line">    EndItem: 19</span><br><span class="line">    Attribute Count: All attributes are requested (0)</span><br><span class="line">    Attribute List</span><br><span class="line"></span><br><span class="line">&gt; 326	1.651062	XiaomiCo_6e:38:c5 (PHONE)	localhost ()	AVRCP	67	Rcvd Browsing: OK - GetFolderItems - UidCounter: 0x0000, NumberOfItems: 1</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth AVRCP Profile</span><br><span class="line">    PDU ID: GetFolderItems (0x71)</span><br><span class="line">    Parameter Length: 48</span><br><span class="line">    Status: OK (0x04)</span><br><span class="line">    UID Counter: 0x0000</span><br><span class="line">    Number Of Items: 1</span><br><span class="line">    Player: Music Player</span><br><span class="line">        Item Type: Media Player Item (0x01)</span><br><span class="line">        Item Length: 40</span><br><span class="line">        Player ID: 0</span><br><span class="line">        Major Player Type: Unknown (0x01)</span><br><span class="line">        Player SubType: Audio Book (0x00000001)</span><br><span class="line">        Play Status: Stopped (0x00)</span><br><span class="line">        Features</span><br><span class="line">            Not Used Features</span><br><span class="line">            .... ...1 = PASSTHROUGH Play: 0x1</span><br><span class="line">            .... ..1. = PASSTHROUGH Stop: 0x1</span><br><span class="line">            .... .1.. = PASSTHROUGH Pause: 0x1</span><br><span class="line">            ...1 .... = PASSTHROUGH Rewind: 0x1</span><br><span class="line">            ..1. .... = PASSTHROUGH FastForward: 0x1</span><br><span class="line">            1... .... = PASSTHROUGH Forward: 0x1</span><br><span class="line">            .... ...1 = PASSTHROUGH Backward: 0x1</span><br><span class="line">            .... .1.. = Advanced Control Player: 0x1</span><br><span class="line">        Character Set: UTF-8 (106)</span><br><span class="line">        Displayable Name Length: 12</span><br><span class="line">        Displayable Name: Music Player</span><br></pre></td></tr></table></figure>

<h3 id="获取TG支持事件"><a href="#获取TG支持事件" class="headerlink" title="获取TG支持事件"></a>获取TG支持事件</h3><p><code>PDU ID</code>：GetCapabilities，用于<strong>TG</strong>可以支持的事件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&gt; 288	1.233497	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	AVRCP	23	Sent Vendor dependent: Status - GetCapabilities(Events Supported)</span><br><span class="line">&gt; 299	1.252688	XiaomiCo_6e:38:c5 (PHONE)	localhost ()	AVRCP	30	Rcvd Vendor dependent: Stable - GetCapabilities(Events Supported) - Count: 6</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth AVRCP Profile</span><br><span class="line">    0000 .... = Reserved: 0x0</span><br><span class="line">    .... 1100 = Ctype: Stable (0xc)</span><br><span class="line">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class="line">    .... .000 = Subunit ID: 0x0</span><br><span class="line">    Opcode: Vendor dependent (0x00)</span><br><span class="line">    Company ID: 00:19:58 (Bluetooth SIG, Inc.)</span><br><span class="line">    PDU ID: GetCapabilities (0x10)</span><br><span class="line">    0000 00.. = RFA: 0x00</span><br><span class="line">    .... ..00 = Packet Type: Single (0x0)</span><br><span class="line">    Parameter Length: 8</span><br><span class="line">    Capability: Events Supported (0x03)</span><br><span class="line">    Capability Count: 0x06</span><br><span class="line">    Event ID: PlaybackStatusChanged (0x01)</span><br><span class="line">    Event ID: TrackChanged (0x02)</span><br><span class="line">    Event ID: PlaybackPositionChanged (0x05)</span><br><span class="line">    Event ID: AvailablePlayersChanged (0x0a)</span><br><span class="line">    Event ID: AddressedPlayerChanged (0x0b)</span><br><span class="line">    Event ID: NowPlayingContentChanged (0x09)</span><br><span class="line">    [Response Time: 19/1000ms]</span><br><span class="line">    [Command in frame: 288]</span><br></pre></td></tr></table></figure>

<h3 id="播放器状态"><a href="#播放器状态" class="headerlink" title="播放器状态"></a>播放器状态</h3><p><strong>CT</strong>端获取<strong>TC</strong>端播放状态，<code>Play Status</code>的参数由<code>GetFolderItems</code>原语获取，通过<code>Ctype</code>来区分操作。</p>
<h4 id="注册事件"><a href="#注册事件" class="headerlink" title="注册事件"></a>注册事件</h4><p><code>PDU ID</code>：RegisterNotification，<code>Event ID</code>为: PlaybackStatusChanged(<code>GetCapabilities</code>原语获取)。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&gt; 300	1.252942	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	AVRCP	27	Sent Vendor dependent: Notify - RegisterNotification - PlaybackStatusChanged</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth AVRCP Profile</span><br><span class="line">    0000 .... = Reserved: 0x0</span><br><span class="line">    .... 0011 = Ctype: Notify (0x3)</span><br><span class="line">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class="line">    .... .000 = Subunit ID: 0x0</span><br><span class="line">    Opcode: Vendor dependent (0x00)</span><br><span class="line">    Company ID: 00:19:58 (Bluetooth SIG, Inc.)</span><br><span class="line">    PDU ID: RegisterNotification (0x31)</span><br><span class="line">    0000 00.. = RFA: 0x00</span><br><span class="line">    .... ..00 = Packet Type: Single (0x0)</span><br><span class="line">    Parameter Length: 5</span><br><span class="line">    Event ID: PlaybackStatusChanged (0x01)</span><br><span class="line">    Interval: 0</span><br><span class="line">    [Response Time: 107/1000ms]</span><br><span class="line">    [Response in frame: 324]</span><br><span class="line"></span><br><span class="line">&gt; 324	1.649874	XiaomiCo_6e:38:c5 (PHONE)	localhost ()	AVRCP	24	Rcvd Vendor dependent: Interim - RegisterNotification - PlaybackStatusChanged - PlayStatus: Paused</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth AVRCP Profile</span><br><span class="line">    0000 .... = Reserved: 0x0</span><br><span class="line">    .... 1111 = Ctype: Interim (0xf)</span><br><span class="line">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class="line">    .... .000 = Subunit ID: 0x0</span><br><span class="line">    Opcode: Vendor dependent (0x00)</span><br><span class="line">    Company ID: 00:19:58 (Bluetooth SIG, Inc.)</span><br><span class="line">    PDU ID: RegisterNotification (0x31)</span><br><span class="line">    0000 00.. = RFA: 0x00</span><br><span class="line">    .... ..00 = Packet Type: Single (0x0)</span><br><span class="line">    Parameter Length: 2</span><br><span class="line">    Event ID: PlaybackStatusChanged (0x01)</span><br><span class="line">    Play Status: Paused (0x02)</span><br><span class="line">    [Response Time: 107/1000ms]</span><br><span class="line">    [Command in frame: 300]</span><br></pre></td></tr></table></figure>

<h4 id="事件通知"><a href="#事件通知" class="headerlink" title="事件通知"></a>事件通知</h4><p><code>PDU ID</code>：RegisterNotification，<code>Event ID</code>为: PlaybackStatusChanged，通过<code>Ctype</code>来区分功能。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&gt; 372	2.461590	XiaomiCo_6e:38:c5 (PHONE)	localhost ()	AVRCP	24	Rcvd Vendor dependent: Changed - RegisterNotification - PlaybackStatusChanged - PlayStatus: Stopped</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth AVRCP Profile</span><br><span class="line">    0000 .... = Reserved: 0x0</span><br><span class="line">    .... 1101 = Ctype: Changed (0xd)</span><br><span class="line">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class="line">    .... .000 = Subunit ID: 0x0</span><br><span class="line">    Opcode: Vendor dependent (0x00)</span><br><span class="line">    Company ID: 00:19:58 (Bluetooth SIG, Inc.)</span><br><span class="line">    PDU ID: RegisterNotification (0x31)</span><br><span class="line">    0000 00.. = RFA: 0x00</span><br><span class="line">    .... ..00 = Packet Type: Single (0x0)</span><br><span class="line">    Parameter Length: 2</span><br><span class="line">    Event ID: PlaybackStatusChanged (0x01)</span><br><span class="line">    Play Status: Stopped (0x00)</span><br><span class="line">    [Response Time: 107/1000ms]</span><br><span class="line">    [Command in frame: 300]</span><br></pre></td></tr></table></figure>

<h4 id="主动获取"><a href="#主动获取" class="headerlink" title="主动获取"></a>主动获取</h4><p><code>PDU ID</code>：GetPlayStatus，往往与<code>RegisterNotification-TrackChanged</code>命令配合使用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&gt; 466	18.051244	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	AVRCP	22	Sent Vendor dependent: Status - GetPlayStatus</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth AVRCP Profile</span><br><span class="line">    0000 .... = Reserved: 0x0</span><br><span class="line">    .... 0001 = Ctype: Status (0x1)</span><br><span class="line">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class="line">    .... .000 = Subunit ID: 0x0</span><br><span class="line">    Opcode: Vendor dependent (0x00)</span><br><span class="line">    Company ID: 00:19:58 (Bluetooth SIG, Inc.)</span><br><span class="line">    PDU ID: GetPlayStatus (0x30)</span><br><span class="line">    0000 00.. = RFA: 0x00</span><br><span class="line">    .... ..00 = Packet Type: Single (0x0)</span><br><span class="line">    Parameter Length: 0</span><br><span class="line">    [Response Time: 40/1000ms]</span><br><span class="line">    [Response in frame: 478]</span><br><span class="line"></span><br><span class="line">&gt; 478	18.091970	XiaomiCo_6e:38:c5 (PHONE)	localhost ()	AVRCP	31	Rcvd Vendor dependent: Stable - GetPlayStatus PlayStatus: Playing, SongPosition: 6118ms, SongLength: 175000ms</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth AVRCP Profile</span><br><span class="line">    0000 .... = Reserved: 0x0</span><br><span class="line">    .... 1100 = Ctype: Stable (0xc)</span><br><span class="line">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class="line">    .... .000 = Subunit ID: 0x0</span><br><span class="line">    Opcode: Vendor dependent (0x00)</span><br><span class="line">    Company ID: 00:19:58 (Bluetooth SIG, Inc.)</span><br><span class="line">    PDU ID: GetPlayStatus (0x30)</span><br><span class="line">    0000 00.. = RFA: 0x00</span><br><span class="line">    .... ..00 = Packet Type: Single (0x0)</span><br><span class="line">    Parameter Length: 9</span><br><span class="line">    Song Length: 175000</span><br><span class="line">    Song Position: 6118</span><br><span class="line">    Play Status: Playing (0x01)</span><br><span class="line">    [Response Time: 40/1000ms]</span><br><span class="line">    [Command in frame: 466]</span><br></pre></td></tr></table></figure>

<h3 id="播放进度"><a href="#播放进度" class="headerlink" title="播放进度"></a>播放进度</h3><p>使用<code>PDU ID</code>：GetPlayStatus，获取<strong>TG</strong>端播放进度，<strong>CT</strong>端轮循调用此命令。其中<code>Song Length</code>参数为音乐长度，<code>Song Position</code>为当前播放进度。日志参考<code>主动获取播放器</code>章节。</p>
<h3 id="音轨状态"><a href="#音轨状态" class="headerlink" title="音轨状态"></a>音轨状态</h3><p><strong>CT</strong>端获取<strong>TC</strong>端播放器音轨状态，状态有下面两种：</p>
<ul>
<li>无音轨：<code>Identifier: 0xffffffffffffffff (NOT SELECTED)</code></li>
<li>有音轨：<code>Identifier: 0x0000000000000000 (SELECTED)</code></li>
</ul>
<p><strong>音轨状态事件</strong>会在每次开始播放都会有事件，歌词就是通过发送<strong>音轨状态事件</strong>来完成的。</p>
<h4 id="注册事件-1"><a href="#注册事件-1" class="headerlink" title="注册事件"></a>注册事件</h4><p><code>PDU ID</code>：RegisterNotification，<code>Event ID</code>为: TrackChanged(<code>GetCapabilities</code>原语获取)。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&gt; 323	1.331254	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	AVRCP	27	Sent Vendor dependent: Notify - RegisterNotification - TrackChanged</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth AVRCP Profile</span><br><span class="line">    0000 .... = Reserved: 0x0</span><br><span class="line">    .... 0011 = Ctype: Notify (0x3)</span><br><span class="line">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class="line">    .... .000 = Subunit ID: 0x0</span><br><span class="line">    Opcode: Vendor dependent (0x00)</span><br><span class="line">    Company ID: 00:19:58 (Bluetooth SIG, Inc.)</span><br><span class="line">    PDU ID: RegisterNotification (0x31)</span><br><span class="line">    0000 00.. = RFA: 0x00</span><br><span class="line">    .... ..00 = Packet Type: Single (0x0)</span><br><span class="line">    Parameter Length: 5</span><br><span class="line">    Event ID: TrackChanged (0x02)</span><br><span class="line">    Interval: 0</span><br><span class="line">    [Response Time: 35/1000ms]</span><br><span class="line">    [Response in frame: 330]</span><br><span class="line"></span><br><span class="line">&gt; 330	1.366518	XiaomiCo_6e:38:c5 (PHONE)	localhost ()	AVRCP	31	Rcvd Vendor dependent: Interim - RegisterNotification - TrackChanged - 0xFFFFFFFFFFFFFFFF (NOT SELECTED)</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth AVRCP Profile</span><br><span class="line">    0000 .... = Reserved: 0x0</span><br><span class="line">    .... 1111 = Ctype: Interim (0xf)</span><br><span class="line">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class="line">    .... .000 = Subunit ID: 0x0</span><br><span class="line">    Opcode: Vendor dependent (0x00)</span><br><span class="line">    Company ID: 00:19:58 (Bluetooth SIG, Inc.)</span><br><span class="line">    PDU ID: RegisterNotification (0x31)</span><br><span class="line">    0000 00.. = RFA: 0x00</span><br><span class="line">    .... ..00 = Packet Type: Single (0x0)</span><br><span class="line">    Parameter Length: 9</span><br><span class="line">    Event ID: TrackChanged (0x02)</span><br><span class="line">    Identifier: 0xffffffffffffffff (NOT SELECTED)</span><br><span class="line">    [Response Time: 35/1000ms]</span><br><span class="line">    [Command in frame: 323]</span><br></pre></td></tr></table></figure>

<h4 id="事件通知-1"><a href="#事件通知-1" class="headerlink" title="事件通知"></a>事件通知</h4><p><code>PDU ID</code>：RegisterNotification，<code>Event ID</code>为: TrackChanged，通过<code>Ctype</code>来区分功能。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; 451	18.026715	XiaomiCo_6e:38:c5 (PHONE)	localhost ()	AVRCP	31	Rcvd Vendor dependent: Changed - RegisterNotification - TrackChanged - 0x0000000000000000 (SELECTED)</span><br></pre></td></tr></table></figure>

<h3 id="获取播放音轨的属性"><a href="#获取播放音轨的属性" class="headerlink" title="获取播放音轨的属性"></a>获取播放音轨的属性</h3><p>获取当前音轨，播放音乐的属性，如标题、歌手等信息。<code>Attribute List</code>请查看<a href="%E5%8F%82%E8%80%83">AVRCP协议规范</a>第26章节，往往与<code>RegisterNotification-TrackChanged</code>命令配合使用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&gt; 465	18.050915	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	AVRCP	59	Sent Vendor dependent: Status - GetElementAttributes - 0x0000000000000000 (PLAYING)</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth AVRCP Profile</span><br><span class="line">    0000 .... = Reserved: 0x0</span><br><span class="line">    .... 0001 = Ctype: Status (0x1)</span><br><span class="line">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class="line">    .... .000 = Subunit ID: 0x0</span><br><span class="line">    Opcode: Vendor dependent (0x00)</span><br><span class="line">    Company ID: 00:19:58 (Bluetooth SIG, Inc.)</span><br><span class="line">    PDU ID: GetElementAttributes (0x20)</span><br><span class="line">    0000 00.. = RFA: 0x00</span><br><span class="line">    .... ..00 = Packet Type: Single (0x0)</span><br><span class="line">    Parameter Length: 37</span><br><span class="line">    Identifier: 0x0000000000000000</span><br><span class="line">    Number of Attributes: 7</span><br><span class="line">    Attribute List</span><br><span class="line">        Attribute ID: Title (0x00000001)</span><br><span class="line">        Attribute ID: Artist (0x00000002)</span><br><span class="line">        Attribute ID: Album (0x00000003)</span><br><span class="line">        Attribute ID: Media Number (0x00000004)</span><br><span class="line">        Attribute ID: Total Number of Media (0x00000005)</span><br><span class="line">        Attribute ID: Genre (0x00000006)</span><br><span class="line">        Attribute ID: Playing Time (0x00000007)</span><br><span class="line">    [Response Time: 3/1000ms]</span><br><span class="line">    [Response in frame: 469]</span><br><span class="line"></span><br><span class="line">&gt; 469	18.054345	XiaomiCo_6e:38:c5 (PHONE)	localhost ()	AVRCP	127	Rcvd Vendor dependent: Stable - GetElementAttributes - Title: &quot;Demons&quot;</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth AVRCP Profile</span><br><span class="line">    0000 .... = Reserved: 0x0</span><br><span class="line">    .... 1100 = Ctype: Stable (0xc)</span><br><span class="line">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class="line">    .... .000 = Subunit ID: 0x0</span><br><span class="line">    Opcode: Vendor dependent (0x00)</span><br><span class="line">    Company ID: 00:19:58 (Bluetooth SIG, Inc.)</span><br><span class="line">    PDU ID: GetElementAttributes (0x20)</span><br><span class="line">    0000 00.. = RFA: 0x00</span><br><span class="line">    .... ..00 = Packet Type: Single (0x0)</span><br><span class="line">    Parameter Length: 105</span><br><span class="line">    Number of Attributes: 7</span><br><span class="line">    Attribute Entries</span><br><span class="line">        Attribute [                Title]: Demons</span><br><span class="line">        Attribute [               Artist]: Imagine Dragons</span><br><span class="line">        Attribute [                Album]: Continued Silence</span><br><span class="line">        Attribute [         Media Number]: 10</span><br><span class="line">        Attribute [Total Number of Media]: 18</span><br><span class="line">        Attribute [                Genre]: </span><br><span class="line">        Attribute [         Playing Time]: 175000</span><br><span class="line">    [Response Time: 3/1000ms]</span><br><span class="line">    [Command in frame: 465]</span><br></pre></td></tr></table></figure>

<h3 id="播放器控制"><a href="#播放器控制" class="headerlink" title="播放器控制"></a>播放器控制</h3><p><strong>CT</strong>控制<strong>TG</strong>播放器的相关命令，都是PASS THROUGH类型，通过<code>Operation ID</code>来区分功能，通过<code>Ctype</code>来区分操作。</p>
<h4 id="播放"><a href="#播放" class="headerlink" title="播放"></a>播放</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; 298	1.252592	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	AVRCP	17	Sent Pass Through: Control - PLAY (Pushed)</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth AVRCP Profile</span><br><span class="line">    0000 .... = Reserved: 0x0</span><br><span class="line">    .... 0000 = Ctype: Control (0x0)</span><br><span class="line">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class="line">    .... .000 = Subunit ID: 0x0</span><br><span class="line">    Opcode: Pass Through (0x7c)</span><br><span class="line">    0... .... = State: Pushed (0x0)</span><br><span class="line">    .100 0100 = Operation ID: PLAY (0x44)</span><br><span class="line">    Data Length: 0x00</span><br><span class="line">    [Response Time: 14/200ms]</span><br><span class="line">    [Response in frame: 308]</span><br><span class="line"></span><br><span class="line">&gt;308	1.266992	XiaomiCo_6e:38:c5 (PHONE)	localhost ()	AVRCP	17	Rcvd Pass Through: Accepted - PLAY (Pushed)</span><br></pre></td></tr></table></figure>

<h4 id="暂停"><a href="#暂停" class="headerlink" title="暂停"></a>暂停</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; 430	7.424245	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	AVRCP	17	Sent Pass Through: Control - PAUSE (Pushed)</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth AVRCP Profile</span><br><span class="line">    0000 .... = Reserved: 0x0</span><br><span class="line">    .... 0000 = Ctype: Control (0x0)</span><br><span class="line">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class="line">    .... .000 = Subunit ID: 0x0</span><br><span class="line">    Opcode: Pass Through (0x7c)</span><br><span class="line">    0... .... = State: Pushed (0x0)</span><br><span class="line">    .100 0110 = Operation ID: PAUSE (0x46)</span><br><span class="line">    Data Length: 0x00</span><br><span class="line">    [Response Time: 70/200ms]</span><br><span class="line">    [Response in frame: 434]</span><br><span class="line"></span><br><span class="line">&gt; 434	7.494377	XiaomiCo_6e:38:c5 (PHONE)	localhost ()	AVRCP	17	Rcvd Pass Through: Accepted - PAUSE (Pushed)</span><br></pre></td></tr></table></figure>

<h4 id="下一曲"><a href="#下一曲" class="headerlink" title="下一曲"></a>下一曲</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; 1163	40.755874	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	AVRCP	17	Sent Pass Through: Control - BACKWARD (Pushed)</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth AVRCP Profile</span><br><span class="line">    0000 .... = Reserved: 0x0</span><br><span class="line">    .... 0000 = Ctype: Control (0x0)</span><br><span class="line">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class="line">    .... .000 = Subunit ID: 0x0</span><br><span class="line">    Opcode: Pass Through (0x7c)</span><br><span class="line">    0... .... = State: Pushed (0x0)</span><br><span class="line">    .100 1100 = Operation ID: BACKWARD (0x4c)</span><br><span class="line">    Data Length: 0x00</span><br><span class="line">    [Response Time: 15/200ms]</span><br><span class="line">    [Response in frame: 1168]</span><br><span class="line"></span><br><span class="line">&gt; 1168	40.771498	XiaomiCo_6e:38:c5 (PHONE)	localhost ()	AVRCP	17	Rcvd Pass Through: Accepted - BACKWARD (Pushed)</span><br></pre></td></tr></table></figure>

<h4 id="上一曲"><a href="#上一曲" class="headerlink" title="上一曲"></a>上一曲</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; 969	37.736799	localhost ()	XiaomiCo_6e:38:c5 (PHONE)	AVRCP	17	Sent Pass Through: Control - FORWARD (Pushed)</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">Bluetooth AVRCP Profile</span><br><span class="line">    0000 .... = Reserved: 0x0</span><br><span class="line">    .... 0000 = Ctype: Control (0x0)</span><br><span class="line">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class="line">    .... .000 = Subunit ID: 0x0</span><br><span class="line">    Opcode: Pass Through (0x7c)</span><br><span class="line">    0... .... = State: Pushed (0x0)</span><br><span class="line">    .100 1011 = Operation ID: FORWARD (0x4b)</span><br><span class="line">    Data Length: 0x00</span><br><span class="line">    [Response Time: 25/200ms]</span><br><span class="line">    [Response in frame: 976]</span><br><span class="line"></span><br><span class="line">&gt; 976	37.762691	XiaomiCo_6e:38:c5 (PHONE)	localhost ()	AVRCP	17	Rcvd Pass Through: Accepted - FORWARD (Pushed)</span><br></pre></td></tr></table></figure>

<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li>蓝牙核心协议规范<a target="_blank" rel="noopener" href="https://www.bluetooth.org/DocMan/handlers/DownloadDoc.ashx?doc_id=286439">Core_v4.2.pdf</a></li>
<li>PBAP协议规范<a target="_blank" rel="noopener" href="https://www.bluetooth.com/specifications/specs/phone-book-access-profile-1-2-3/">PBAP_v1.2.3.pdf</a></li>
<li>HFP协议规范<a target="_blank" rel="noopener" href="https://www.bluetooth.com/specifications/specs/hands-free-profile-1-8/">HFP_v1.8.pdf</a></li>
<li>AVDTP协议规范<a target="_blank" rel="noopener" href="https://www.bluetooth.com/specifications/specs/a-v-distribution-transport-protocol-1-3/">AVDTP_SPEC_V13.pdf</a></li>
<li>AVCTP协议规范<a target="_blank" rel="noopener" href="https://www.bluetooth.com/specifications/specs/a-v-%e2%80%8b%e2%80%8bcontrol-transport-protocol-1-4/">AVCTP_SPEC_V14.pdf</a></li>
<li>AVRCP协议规范<a target="_blank" rel="noopener" href="https://www.bluetooth.com/specifications/specs/a-v-remote-control-profile-1-6-2/">AVRCP_v1.6.2.pdf</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/wenzongliang/article/details/84689377">蓝牙物理链路类型：SCO和ACL链路与A2DP</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/XiaoXiaoPengBo/article/details/107792407">安全简单配对</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/u010657219/article/details/42192481">在HCI层看蓝牙的连接过程</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/libs-liu/p/9498952.html">蓝牙SDP协议概述 </a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/XiaoXiaoPengBo/article/details/108125755">RFCOMM协议概念介绍</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.51cto.com/u_2982693/3521456">蓝牙的OBEX协议</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44260005/article/details/105223139">蓝牙电话之PBAP协议分析</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/shichaog/article/details/52123439">蓝牙之八-HFP</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/shichaog/article/details/52126415">蓝牙之九-AT命令</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.liaoheng.me/2022/02/24/thread-block-and-suspend/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="liaoheng">
      <meta itemprop="description" content="A developer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liaoheng`s blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/24/thread-block-and-suspend/" class="post-title-link" itemprop="url">线程(进程)的阻塞与挂起</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-02-24 14:10:13" itemprop="dateCreated datePublished" datetime="2022-02-24T14:10:13+08:00">2022-02-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-02-21 12:35:23" itemprop="dateModified" datetime="2024-02-21T12:35:23+08:00">2024-02-21</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="阻塞与挂起"><a href="#阻塞与挂起" class="headerlink" title="阻塞与挂起"></a>阻塞与挂起</h1><h2 id="挂起-suspend"><a href="#挂起-suspend" class="headerlink" title="挂起(suspend)"></a>挂起(suspend)</h2><blockquote>
<p>是指在操作系统进程管理将前台的进程暂停(suspend)并转入后台的动作。将进程挂起可以让用户在前台执行其他的进程。挂起的进程通常释放除CPU以外已经占有的系统资源，如内存等。</p>
</blockquote>
<h2 id="阻塞-block"><a href="#阻塞-block" class="headerlink" title="阻塞(block)"></a>阻塞(block)</h2><blockquote>
<p>正在执行的进程由于发生某时间（如I&#x2F;O请求、申请缓冲区失败等）暂时无法继续执行。此时引起进程调度，OS把处理机分配给另一个就绪进程，而让受阻进程处于暂停状态，一般将这种状态称为阻塞状态。</p>
</blockquote>
<h2 id="两者的区别"><a href="#两者的区别" class="headerlink" title="两者的区别"></a>两者的区别</h2><p><strong>挂起</strong>是一种主动行为，因此恢复也应该要主动完成；</p>
<p><strong>阻塞</strong>则是一种被动行为，恢复交由系统完成。而且挂起队列在操作系统里可以看成一个，而阻塞队列则是不同的事件或资源（如信号量）就有自己的队列。</p>
<p><img data-src="https://pic.liaoheng.me/hc-pic/2024/02/3c148cfcf29b361b01d9002250f52873.jpg"></p>
<ul>
<li>运行中<strong>挂起</strong>，进入<code>静止就绪</code>状态，<em>释放资源</em>，自身对换到外存中，不释放锁，也不释放CPU，比如sleep()；</li>
<li>而运行中<strong>阻塞</strong>，进入<code>活动阻塞</code>状态，<em>释放资源</em>，释放锁，释放CPU，比如wait()。</li>
</ul>
<p>也就是说<strong>挂起</strong>在运行状态中要比<strong>阻塞</strong>靠前，<strong>挂起</strong>是一直在内存中定期运行自己，检查是否可以跳出当前状态；<strong>阻塞</strong>是自己不在运行，需要第三方检查自己是否可以跳出当前状态，在一定条件下也会由操作系统将其移出内存保存到外存中。</p>
<h2 id="Java中的线程与锁与其的关系"><a href="#Java中的线程与锁与其的关系" class="headerlink" title="Java中的线程与锁与其的关系"></a>Java中的线程与锁与其的关系</h2><p>Java 的 <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/7/docs/api/java/lang/Thread.State.html">Thread.State</a> 中定义了线程的 6 种状态，分别如下：</p>
<ol>
<li>NEW 未启动的，不会出现在 dump 文件中 (可以通过 jstack命令查看线程堆栈)</li>
<li>RUNNABLE 正在 JVM 中执行的</li>
<li>BLOCKED 被阻塞，等待获取监视器锁进入 synchronized 代码块或者在调用Object.wait 之后重新进入 synchronized 代码块</li>
<li>WAITING 无限期等待另一个线程执行特定动作后唤醒它，也就是调用Object.wait 后会等待拥有同一个监视器锁的线程调用 notify&#x2F;notifyAll来进行唤醒</li>
<li>TIMED_WAITING 有时限的等待另一个线程执行特定动作</li>
<li>TERMINATED 已经完成了执行</li>
</ol>
<h3 id="Thread-sleep"><a href="#Thread-sleep" class="headerlink" title="Thread.sleep"></a>Thread.sleep</h3><p>也就是说这是<code>挂起(suspend)</code>，作用域在线程，持有CPU。</p>
<h3 id="Object-wait-x2F-synchronized"><a href="#Object-wait-x2F-synchronized" class="headerlink" title="Object.wait&#x2F;synchronized"></a>Object.wait&#x2F;synchronized</h3><p>也就是说这是<code>阻塞(block)</code>，作用域在锁对象，释放CPU。</p>
<blockquote>
<p><code>wait/notify</code>是通过 JVM里的<strong>park&#x2F;unpark</strong> 机制来实现的，在Linux下这种机制又是通过<strong>pthread_cond_wait&#x2F;pthread_cond_signal</strong>实现。</p>
</blockquote>
<h3 id="Lock"><a href="#Lock" class="headerlink" title="Lock"></a>Lock</h3><p>也就是说这是<code>挂起(suspend)</code>，作用域在锁对象，持有CPU。</p>
<blockquote>
<p>Lock 用的是乐观锁机制。所谓乐观锁就是，每次不加锁而是假设没有冲突而去完成某项操作，如果因为冲突失败就重试，直到成功为止。</p>
</blockquote>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_37641832/article/details/83217104">操作系统——CPU和内存、挂起和阻塞</a></li>
<li><a target="_blank" rel="noopener" href="https://generalthink.github.io/2019/10/10/analysis-java-object-wait-notify/">分析Java Object 中的 wait&#x2F;notify</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/4c1ed2048985">synchronized(this&#x2F;.class&#x2F;Object),synchronize方法区别</a></li>
<li><a target="_blank" rel="noopener" href="https://www.baeldung.com/java-thread-lifecycle">Life Cycle of a Thread in Java</a></li>
<li><a target="_blank" rel="noopener" href="https://xie.infoq.cn/article/4e370ded27e4419d2a94a44b3">Synchronized 和 lock 区别</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.liaoheng.me/2021/07/28/installation-arch-linux-summary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="liaoheng">
      <meta itemprop="description" content="A developer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liaoheng`s blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/28/installation-arch-linux-summary/" class="post-title-link" itemprop="url">安装Arch Linux小结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-28 13:48:38" itemprop="dateCreated datePublished" datetime="2021-07-28T13:48:38+08:00">2021-07-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-02-21 12:24:03" itemprop="dateModified" datetime="2024-02-21T12:24:03+08:00">2024-02-21</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <img data-src="https://archlinux.org/static/logos/archlinux-logo-dark-1200dpi.b42bd35d5916.png" style="zoom:5%;" />

<p>本人跟随<a target="_blank" rel="noopener" href="https://wiki.archlinux.org/title/Installation_guide_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">Arch Linux官方安装指南</a>操作过程的一些记录。</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><blockquote>
<p> 下载ISO文件并启动到 Live 环境，注意<a target="_blank" rel="noopener" href="https://wiki.archlinux.org/title/Unified_Extensible_Firmware_Interface_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)/Secure_Boot_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">安全启动（Secure Boot）</a>的问题。</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://archlinux.org/download/">官方下载地址</a></p>
<h3 id="验证启动模式-非必须"><a href="#验证启动模式-非必须" class="headerlink" title="验证启动模式(非必须)"></a>验证启动模式(非必须)</h3><p>请用下列命令列出 <a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/Efivars">efivars</a> 目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls /sys/firmware/efi/efivars</span><br></pre></td></tr></table></figure>

<p>目录存在，操作系统使用UEFI模式启动，反之使用传统模式启动(BIOS,CSM)。</p>
<h3 id="网络连接"><a href="#网络连接" class="headerlink" title="网络连接"></a>网络连接</h3><p><strong>安装过程需要连接互联网</strong>，Live环境默认开启DHCP，其它方式可以参考<a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/Installation_guide_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#%E8%BF%9E%E6%8E%A5%E5%88%B0%E5%9B%A0%E7%89%B9%E7%BD%91">连接到因特网</a>，</p>
<h3 id="更新系统时间"><a href="#更新系统时间" class="headerlink" title="更新系统时间"></a>更新系统时间</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timedatectl set-ntp true</span><br></pre></td></tr></table></figure>

<h3 id="建立硬盘分区"><a href="#建立硬盘分区" class="headerlink" title="建立硬盘分区"></a>建立硬盘分区</h3><blockquote>
<p>使用<code>fdisk</code>分区，可以查看这篇<a target="_blank" rel="noopener" href="https://www.cnblogs.com/lsgxeva/p/9610003.html">博文</a>有详细的使用说明</p>
</blockquote>
<p>查看分区列表</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fdisk -l</span><br></pre></td></tr></table></figure>

<p><img data-src="https://pic.liaoheng.me/hc-pic/2024/02/93503db3f240a11f738fc5c37e0287a2.png"></p>
<p>其中<code>/dev/sda</code>代表第一块物理磁盘(<code>/dev/sdb,/dev/sdc</code>与之类推)</p>
<p>操作对应磁盘(<code>/dev/sda</code>)分区</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fdisk /dev/sda</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入fdisk应用命令行：</span></span><br><span class="line">g #如果没有分区表或者是MBR表先删除，创建一个新的空GPT分区表</span><br><span class="line">n #创建新的分区</span><br><span class="line">t #改变分区类型</span><br><span class="line">w #保存并退出</span><br></pre></td></tr></table></figure>

<p><img data-src="https://pic.liaoheng.me/hc-pic/2024/02/4811eca3d0b3a9f324247b14d39e571b.png"></p>
<p>新建分区之后需要指定分区类型，使用命令<code>t &#123;partition number &#125;</code>，可以参考下表配置分区：</p>
<table>
<thead>
<tr>
<th>Mount point</th>
<th>Partition</th>
<th><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/GUID_Partition_Table#Partition_type_GUIDs">Partition type GUID</a></th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;boot</td>
<td>&#x2F;dev&#x2F;sda1</td>
<td><code>C12A7328-F81F-11D2-BA4B-00A0C93EC93B</code>: <a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/EFI_system_partition">EFI system partition</a></td>
</tr>
<tr>
<td>[SWAP]</td>
<td>&#x2F;dev&#x2F;sda2</td>
<td><code>0657FD6D-A4AB-43C4-84E5-0933C84B4F4F</code>: Linux <a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/Swap">swap</a></td>
</tr>
<tr>
<td>&#x2F;home</td>
<td>&#x2F;dev&#x2F;sda3</td>
<td><code>933AC7E1-2EB4-4F13-B844-0E14E2AEF915</code>: Linux &#x2F;home</td>
</tr>
<tr>
<td>&#x2F;</td>
<td>&#x2F;dev&#x2F;sda4</td>
<td><code>4F68BCE3-E8CD-4DB1-96E7-FBCAF984B709</code>: Linux x86-64 root (&#x2F;)</td>
</tr>
</tbody></table>
<p>通过<code>t</code>命令可以查看更多类型，PgUp向上,PgDn向下,q退出。</p>
<h3 id="格式化分区"><a href="#格式化分区" class="headerlink" title="格式化分区"></a>格式化分区</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkfs.fat -F32 /dev/sda1 #EFI system partition(ESP)</span><br><span class="line">mkswap /dev/sda2 #swap</span><br><span class="line">mkfs.ext4 /dev/sda3 #/home</span><br><span class="line">mkfs.ext4 /dev/sda4 #/</span><br></pre></td></tr></table></figure>

<h3 id="挂载分区"><a href="#挂载分区" class="headerlink" title="挂载分区"></a>挂载分区</h3><p>将根磁盘卷 <a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/Mount">挂载</a> 到 <code>/mnt</code>，例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mount /dev/sda4 /mnt #挂载/</span><br><span class="line">mkdir /mnt/boot</span><br><span class="line">mount /dev/sda1 /mnt/boot #挂载ESP</span><br><span class="line">mkdir /mnt/home</span><br><span class="line">mount /dev/sda3 /mnt/home #挂载/home</span><br><span class="line">swapon /dev/sda2 #挂载swap</span><br></pre></td></tr></table></figure>

<h2 id="安装系统"><a href="#安装系统" class="headerlink" title="安装系统"></a>安装系统</h2><h3 id="选择一个合适的镜像-可选"><a href="#选择一个合适的镜像-可选" class="headerlink" title="选择一个合适的镜像(可选)"></a>选择一个合适的镜像(可选)</h3><p><a target="_blank" rel="noopener" href="https://wiki.archlinux.org/title/Mirrors_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#%E4%B8%AD%E5%9B%BD">非官方镜像列表</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nano /etc/pacman.d/mirrorlist</span><br><span class="line">---</span><br><span class="line">Server = https://mirrors.ustc.edu.cn/archlinux/$repo/os/$arch #文件第一排写入</span><br></pre></td></tr></table></figure>

<h3 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h3><p>这几个包按照需求选择是否添加 <a target="_blank" rel="noopener" href="https://wiki.archlinux.org/title/Nano_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">nano</a>, <a target="_blank" rel="noopener" href="https://wiki.archlinux.org/title/GRUB_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">grub</a>, <a target="_blank" rel="noopener" href="https://wiki.archlinux.org/title/Unified_Extensible_Firmware_Interface_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#efibootmgr">efibootmgr</a>, <a target="_blank" rel="noopener" href="https://wiki.archlinux.org/title/Iwd_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">iwd</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pacstrap /mnt base linux linux-firmware nano grub efibootmgr iwd</span><br><span class="line">genfstab -U /mnt &gt;&gt; /mnt/etc/fstab  #定义磁盘分区</span><br></pre></td></tr></table></figure>

<h3 id="通过Chroot进入安装系统"><a href="#通过Chroot进入安装系统" class="headerlink" title="通过Chroot进入安装系统"></a>通过Chroot进入安装系统</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arch-chroot /mnt <span class="comment"># 进入安装好的arch linux系统</span></span><br></pre></td></tr></table></figure>
<p>在当前Live Linux中通过<a target="_blank" rel="noopener" href="https://wiki.archlinux.org/title/Chroot_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">Chroot</a>进入我们挂在到&#x2F;mnt下面的Arch Linux系统中(也就是我们这次安装的系统)，以下操作均在其中</p>
<h3 id="时间-x2F-时区"><a href="#时间-x2F-时区" class="headerlink" title="时间&#x2F;时区"></a>时间&#x2F;时区</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ln</span> -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime  <span class="comment">#设置时区</span></span><br><span class="line">hwclock --systohc <span class="comment">#硬件时间设置为UTC</span></span><br></pre></td></tr></table></figure>

<h3 id="本地化"><a href="#本地化" class="headerlink" title="本地化"></a>本地化</h3><p>编辑<code>/etc/locale.gen</code> 选择 <a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/Locale_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">地区</a> ：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nano /etc/locale.gen <span class="comment">#移除需要的地区前的#号</span></span><br><span class="line">---</span><br><span class="line">locale-gen <span class="comment">#更新配置</span></span><br></pre></td></tr></table></figure>

<p>然后创建<code>/etc/locale.conf</code> 文件，并添加 <a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/Locale#Setting_the_system_locale"> LANG 变量</a>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nano /etc/locale.conf</span><br><span class="line">---</span><br><span class="line">LANG=en_GB.UTF-8 <span class="comment">#推荐使用，而不是zh_CN</span></span><br></pre></td></tr></table></figure>

<h3 id="hostname-amp-hosts"><a href="#hostname-amp-hosts" class="headerlink" title="hostname&amp;hosts"></a>hostname&amp;hosts</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建/etc/hostname文件</span></span><br><span class="line">nano /etc/hostname</span><br><span class="line">---</span><br><span class="line">LHCOMPUTER <span class="comment">#写入主机名称</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#编辑/etc/hosts</span></span><br><span class="line">nano /etc/hosts</span><br><span class="line">---</span><br><span class="line">127.0.0.1    localhost</span><br><span class="line">::1        localhost</span><br><span class="line">127.0.1.1    LHCOMPUTER.localdomain    LHCOMPUTER <span class="comment">#添加</span></span><br></pre></td></tr></table></figure>

<h3 id="设置Root用户密码"><a href="#设置Root用户密码" class="headerlink" title="设置Root用户密码"></a>设置Root用户密码</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passwd</span><br></pre></td></tr></table></figure>

<h3 id="安装引导程序"><a href="#安装引导程序" class="headerlink" title="安装引导程序"></a>安装引导程序</h3><p>前面的步骤已经基本完成对启动系统的配置，现在需要计算机引导启动系统，我选择使用<a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/GRUB_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">GRUB</a>，以下是在EFI 系统分区下的命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB</span><br><span class="line">grub-mkconfig -o /boot/grub/grub.cfg</span><br></pre></td></tr></table></figure>

<h3 id="完成"><a href="#完成" class="headerlink" title="完成"></a>完成</h3><p>输入 <code>exit</code> 或按 <code>Ctrl+d</code> 退出 Chroot 环境。<br>可选用 <code>umount -R /mnt</code> 手动卸载被挂载的分区。<br>最后执行 <code>reboot</code> 重启系统。</p>
<h2 id="使用新系统前的配置"><a href="#使用新系统前的配置" class="headerlink" title="使用新系统前的配置"></a>使用新系统前的配置</h2><h3 id="选择网络管理程序"><a href="#选择网络管理程序" class="headerlink" title="选择网络管理程序"></a>选择网络管理程序</h3><p>系统默认已安装<a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/Systemd-networkd_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">systemd-networkd</a>，以下步骤配置并开启。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">networkctl <span class="comment">#获取有关网络链接的状态信息</span></span></span><br><span class="line">IDX LINK             TYPE               OPERATIONAL SETUP     </span><br><span class="line">1 lo               loopback           carrier     unmanaged </span><br><span class="line">2 ens33            ether              routable    unmanaged </span><br><span class="line">3 wlp2s0           wlan               off         unmanaged </span><br><span class="line">4 vmnet1           ether              routable    unmanaged </span><br><span class="line">5 vmnet8           ether              routable    unmanaged </span><br><span class="line">5 links listed.</span><br></pre></td></tr></table></figure>

<p>其中ens33为有线网卡，wlp2s0为无线网卡。</p>
<h4 id="配置有线"><a href="#配置有线" class="headerlink" title="配置有线"></a>配置有线</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">nano /etc/systemd/network/dhcp.network</span><br><span class="line">---</span><br><span class="line">[Match]</span><br><span class="line">Name=ens33</span><br><span class="line"> </span><br><span class="line">[Network]</span><br><span class="line">DHCP=<span class="literal">true</span></span><br><span class="line"><span class="comment">#Address=192.168.1.20/24</span></span><br><span class="line"><span class="comment">#Gateway=192.168.1.1</span></span><br><span class="line"><span class="comment">#DNS=119.29.29.29</span></span><br><span class="line"><span class="comment">#DNS=8.8.8.8</span></span><br></pre></td></tr></table></figure>

<h4 id="配置无线"><a href="#配置无线" class="headerlink" title="配置无线"></a>配置无线</h4><p>需要先安装<a target="_blank" rel="noopener" href="https://wiki.archlinux.org/title/Iwd_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">iwd</a>包，使用命令连接对应无线网络。</p>
<ol>
<li>要进入交互式提示符（interactive prompt），执行：<code>$ iwctl</code></li>
<li><code>[iwd]# station device scan</code></li>
<li><code>[iwd]# station device get-networks</code></li>
<li><code>[iwd]# station device connect SSID</code>，会提示输入密码</li>
</ol>
<p>完成后，配置网络</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">nano /etc/systemd/network/wireless.network</span><br><span class="line">---</span><br><span class="line">[Match]</span><br><span class="line">Name=wlp2s0</span><br><span class="line"> </span><br><span class="line">[Network]</span><br><span class="line">DHCP=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h4 id="开启自动服务"><a href="#开启自动服务" class="headerlink" title="开启自动服务"></a>开启自动服务</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> --now systemd-networkd.service</span><br><span class="line">systemctl <span class="built_in">enable</span> --now systemd-resolved.service <span class="comment">#DNS</span></span><br></pre></td></tr></table></figure>

<h3 id="添加新用户"><a href="#添加新用户" class="headerlink" title="添加新用户"></a>添加新用户</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">groupadd liaoheng</span><br><span class="line">useradd -m -g liaoheng liaoheng</span><br><span class="line">passwd liaoheng</span><br></pre></td></tr></table></figure>

<h3 id="安装sudo"><a href="#安装sudo" class="headerlink" title="安装sudo"></a>安装<code>sudo</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pacman -S sudo</span><br><span class="line">nano /etc/sudoers<span class="comment">#下面内容到文件末尾</span></span><br><span class="line">---</span><br><span class="line">Defaults targetpw</span><br><span class="line">liaoheng ALL=(ALL) ALL</span><br></pre></td></tr></table></figure>

<h3 id="开机时打开-Num-Lock"><a href="#开机时打开-Num-Lock" class="headerlink" title="开机时打开 Num Lock"></a>开机时打开 <code>Num Lock</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -S systemd-numlockontty</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> --now numLockOnTty.service</span><br></pre></td></tr></table></figure>

<h3 id="软件仓库-可选"><a href="#软件仓库-可选" class="headerlink" title="软件仓库(可选)"></a>软件仓库(可选)</h3><blockquote>
<p>可以登录<code>liaoheng</code>账户</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -Syu</span><br></pre></td></tr></table></figure>

<p>添加Arch Linux Chinese Community Repository，编辑<code>/etc/pacman.conf</code>，添加</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /etc/pacman.conf</span><br><span class="line">---</span><br><span class="line">[archlinuxcn]</span><br><span class="line">Server = https://mirrors.ustc.edu.cn/archlinuxcn/<span class="variable">$arch</span></span><br></pre></td></tr></table></figure>

<p>导入PGP keys:</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/archlinuxcn/repo/issues/522">失败解决办法</a></p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -Syy &amp;&amp; sudo pacman -S archlinuxcn-keyring</span><br></pre></td></tr></table></figure>

<h3 id="图形界面"><a href="#图形界面" class="headerlink" title="图形界面"></a>图形界面</h3><h4 id="GNOME"><a href="#GNOME" class="headerlink" title="GNOME"></a><a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/GNOME_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">GNOME</a></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -S gnome gnome-extra gnome-tweak-tool</span><br><span class="line">sudo pacman -S networkmanager</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> NetworkManager</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> --now gdm.service</span><br></pre></td></tr></table></figure>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/Installation_guide_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">Installation guide</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/Partitioning_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#%E5%B8%83%E5%B1%80%E7%A4%BA%E4%BE%8B">Partitioning</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/EFI_system_partition">EFI_system_partition</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/Fstab_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">fstab </a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/GRUB_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">GRUB</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.liaoheng.me/2021/07/14/android-dp-and-screen-adaptation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="liaoheng">
      <meta itemprop="description" content="A developer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liaoheng`s blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/14/android-dp-and-screen-adaptation/" class="post-title-link" itemprop="url">Android密度无关像素(dp)与屏幕适配</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-14 16:16:34" itemprop="dateCreated datePublished" datetime="2021-07-14T16:16:34+08:00">2021-07-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-02-21 10:32:28" itemprop="dateModified" datetime="2024-02-21T10:32:28+08:00">2024-02-21</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="密度无关像素-density-independent-pixels"><a href="#密度无关像素-density-independent-pixels" class="headerlink" title="密度无关像素(density-independent pixels)"></a>密度无关像素(density-independent pixels)</h2><blockquote>
<p>Android 设备不仅有不同的屏幕尺寸（手机、平板电脑、电视等），而且其屏幕也有不同的像素尺寸。也就是说，有可能一部设备的屏幕为每平方英寸 160 像素，而另一部设备的屏幕在相同的空间内可以容纳 480  像素。如果您不考虑像素密度的这些差异，系统可能会缩放图片（导致图片变模糊），或者图片可能会以完全错误的尺寸显示。</p>
</blockquote>
<p>如果开发者只对屏幕<code>分辨率</code>进行适配，也就是说使用<code>像素(px)</code>作为度量单位，那么在同一<code>分辨率</code>下的布局，在不同<code>像素密度</code>的屏幕中的显示完全不同。为了应对这种情况，Android引入了<code>密度无关像素(dp)</code>来作为度量单位，但<strong>最终的渲染还是使用像素(px)为度量单位</strong>，dp是做为一种中间值的存在。</p>
<blockquote>
<p>密度无关像素(dp)是一个虚拟像素单位，1 dp 约等于<code>中密度屏幕</code>（160dpi；“基准”密度）上的 1 像素。对于其他每个密度，Android 会将此值转换为相应的实际像素数。</p>
</blockquote>
<p>Android支持多种多样的<code>屏幕密度</code>，但是开发者不可能对每种都进行适配，于是将<code>屏幕密度</code>按一定关系进行划分，开发者只适配同一区间的<code>屏幕密度</code>成为一种比较好的方案。Android的<code>屏幕密度</code>分级区间，系统会基于不同区间自行按对应倍数进行缩放（包括布局和图片），开发者也可以基于这些区间规制自行适配，区间如下：</p>
<table>
<thead>
<tr>
<th>密度限定符</th>
<th>说明</th>
<th><strong>缩放倍数</strong></th>
</tr>
</thead>
<tbody><tr>
<td>ldpi</td>
<td>适用于低密度 (ldpi) 屏幕 (~ 120dpi) 的资源。（在120dpi左右，而非固定值，不同系统也是有差距的）</td>
<td>0.75（px&#x3D;dp*0.75）</td>
</tr>
<tr>
<td>mdpi</td>
<td>适用于中密度 (mdpi) 屏幕 (~ 160dpi) 的资源（这是基准密度）。默认的layout，dimens也是基于此。</td>
<td>1.0（px&#x3D;dp)</td>
</tr>
<tr>
<td>hdpi</td>
<td>适用于高密度 (hdpi) 屏幕 (~ 240dpi) 的资源。</td>
<td>1.5（px&#x3D;dp*1.5）</td>
</tr>
<tr>
<td>xhdpi</td>
<td>适用于加高 (xhdpi) 密度屏幕 (~ 320dpi) 的资源。</td>
<td>2.0（px&#x3D;dp*2）</td>
</tr>
<tr>
<td>xxhdpi</td>
<td>适用于超超高密度 (xxhdpi) 屏幕 (~ 480dpi) 的资源。</td>
<td>3.0（px&#x3D;dp*3）</td>
</tr>
<tr>
<td>xxxhdpi</td>
<td>适用于超超超高密度 (xxxhdpi) 屏幕 (~ 640dpi) 的资源。</td>
<td>4.0（px&#x3D;dp*4）</td>
</tr>
<tr>
<td>nodpi</td>
<td>适用于所有密度的资源。这些是与密度无关的资源。无论当前屏幕的密度是多少，系统都不会缩放以此限定符标记的资源。</td>
<td></td>
</tr>
<tr>
<td>tvdpi</td>
<td>适用于密度介于 mdpi 和 hdpi 之间的屏幕（约 213dpi）的资源。这不属于“主要”密度组。它主要用于电视，而大多数应用都不需要它。对于大多数应用而言，提供 mdpi 和 hdpi 资源便已足够，系统将视情况对其进行缩放。如果您发现有必要提供 tvdpi 资源，应按一个系数来确定其大小，即 1.33*mdpi。例如，如果某张图片在 mdpi 屏幕上的大小为 100px x 100px，那么它在 tvdpi 屏幕上的大小应该为 133px x 133px。</td>
<td>1.33（px&#x3D;dp*1.33）</td>
</tr>
</tbody></table>
<p>例如，你在中密度屏幕上的一个控件或者图片，大小为 48x48 像素，那么它在其他各种密度的屏幕上的大小应该为：</p>
<ul>
<li>36x36 (0.75x) - 低密度 (ldpi)</li>
<li>48x48（1.0x 基准）- 中密度 (mdpi)</li>
<li>72x72 (1.5x) - 高密度 (hdpi)</li>
<li>96x96 (2.0x) - 超高密度 (xhdpi)</li>
<li>144x144 (3.0x) - 超超高密度 (xxhdpi)</li>
<li>192x192 (4.0x) - 超超超高密度 (xxxhdpi)</li>
</ul>
<h2 id="如何使用密度无关像素进行适配屏幕"><a href="#如何使用密度无关像素进行适配屏幕" class="headerlink" title="如何使用密度无关像素进行适配屏幕"></a>如何使用密度无关像素进行适配屏幕</h2><h3 id="系统适配"><a href="#系统适配" class="headerlink" title="系统适配"></a>系统适配</h3><ul>
<li>图片文件48x48（res&#x2F;drawable&#x2F;ic_icon.png）</li>
<li>布局文件（res&#x2F;layout&#x2F;activity_main.xml）</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">FrameLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_marginTop</span>=<span class="string">&quot;@dimen/text_margin_top&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_marginEnd</span>=<span class="string">&quot;@dimen/text_margin_end&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_marginStart</span>=<span class="string">&quot;@dimen/text_margin_start&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_marginBottom</span>=<span class="string">&quot;@dimen/text_margin_bottom&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">&quot;@string/app_name&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>资源尺寸文件（res&#x2F;values&#x2F;dimens.xml）</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;text_margin_top&quot;</span>&gt;</span>15dp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span>//缩放之后的px=15*缩放倍数</span><br><span class="line">    <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;text_margin_end&quot;</span>&gt;</span>10dp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;text_margin_start&quot;</span>&gt;</span>20dp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;text_margin_bottom&quot;</span>&gt;</span>20px<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span>//不会缩放px=20</span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>系统会根据<code>屏幕密度</code>分级区间自行按对应倍数进行缩放，在中密度 (mdpi)下<code>text_margin_top</code>的<code>像素</code>为15，在超高密度 (xhdpi)下，<code>text_margin_top</code>的<code>像素</code>为15x2.0，<code>ic_icon.png</code>的<code>像素</code>为96x96。</p>
<h3 id="自定义适配"><a href="#自定义适配" class="headerlink" title="自定义适配"></a>自定义适配</h3><p>系统的缩放比在一定条件下，是可以保证应用的显示正常，但是往往不一定那么理想，于是手动去设置尺寸，更为常见，就是能过将对应尺寸的资源放入对应dp文件夹来实现，如：</p>
<ul>
<li>要适配xhdpi，就将同名图片放入<code>res/drawable-xhdp/ic_icon.png</code>。</li>
<li>要适配xhdpi，就将同名文件放入<code>res/layout-xhdpi/activity_main.xml</code>。</li>
<li>要适配xhdpi，就将同名文件放入<code>res/values-xhdpi/dimens.xml</code>中。</li>
</ul>
<p>如果使用dp会在相应<code>屏幕密度</code>分级区间自行按对应倍数进行缩放，也就是说相当于覆盖了默认的<code>res/values/dimens.xml</code>中的参数，然后进入<em>系统适配</em>（按对应倍数进行缩放），px则不会进行缩放，例如(res&#x2F;values-xhdpi&#x2F;dimens.xml)：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;text_margin_top&quot;</span>&gt;</span>5dp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span> //缩放之后的px=10</span><br><span class="line">    <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;text_margin_end&quot;</span>&gt;</span>5dp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;text_margin_start&quot;</span>&gt;</span>10px<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span>//不会缩放px=10</span><br><span class="line">    <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;text_margin_bottom&quot;</span>&gt;</span>15px<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>当前应用如果适配的dpi不匹配设备时，系统会先找比设备dpi更大最近的以适配的dpi，然后是更小最近的，一直到mdpi也就是默认适配文件。例如：</p>
<ul>
<li>当前应用适配有hdpi、xxdpi、xxxdpi，设备的dpi为xhdpi，于是系统给应用分配的是xxdpi中的参数。</li>
<li>当前应用适配有hdpi，设备的dpi为xhdpi，于是系统给应用分配的是hdpi中的参数。</li>
<li>当前应用适配有ldpi，设备的dpi为xhdpi，于是系统给应用分配的是mdpi(也就是默认值)中的参数。</li>
</ul>
<h3 id="使用代码强行设置应用显示的屏幕密度-dpi"><a href="#使用代码强行设置应用显示的屏幕密度-dpi" class="headerlink" title="使用代码强行设置应用显示的屏幕密度(dpi)"></a>使用代码强行设置应用显示的<code>屏幕密度</code>(dpi)</h3><p>这种方式可以比如只适配了xhdpi，想在其它的dpi中也按xhdpi进行绘制。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">float</span> sNoCompatDensity;</span><br><span class="line"><span class="keyword">private</span> <span class="type">float</span> sNoCompatScaledDensity;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 强制设置dpi</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> targetDP 密度屏幕(160,240,360...)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> isV      是否横屏</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setCustomDensity</span><span class="params">(<span class="type">int</span> targetDP, <span class="type">boolean</span> isV)</span> &#123;</span><br><span class="line">    <span class="type">DisplayMetrics</span> <span class="variable">appDisplayMetrics</span> <span class="operator">=</span> getResources().getDisplayMetrics();</span><br><span class="line">    <span class="keyword">if</span> (sNoCompatDensity == <span class="number">0</span>) &#123;</span><br><span class="line">        sNoCompatDensity = appDisplayMetrics.density;</span><br><span class="line">        sNoCompatScaledDensity = appDisplayMetrics.scaledDensity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> targetDensity;</span><br><span class="line">    <span class="keyword">if</span> (isV) &#123;</span><br><span class="line">        targetDensity =</span><br><span class="line">                (<span class="type">float</span>) appDisplayMetrics.heightPixels / (appDisplayMetrics.heightPixels / (targetDP / <span class="number">160F</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        targetDensity =</span><br><span class="line">                (<span class="type">float</span>) appDisplayMetrics.widthPixels / (appDisplayMetrics.heightPixels / (targetDP / <span class="number">160F</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">float</span> <span class="variable">targetScaledDensity</span> <span class="operator">=</span> targetDensity * (sNoCompatScaledDensity / sNoCompatDensity);</span><br><span class="line">    <span class="type">int</span> <span class="variable">targetDensityDpi</span> <span class="operator">=</span> (<span class="type">int</span>) (<span class="number">160</span> * targetDensity);</span><br><span class="line"></span><br><span class="line">    appDisplayMetrics.density = targetDensity;</span><br><span class="line">    appDisplayMetrics.scaledDensity = targetScaledDensity;</span><br><span class="line">    appDisplayMetrics.densityDpi = targetDensityDpi;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用最小宽度限定符-smallestWidth-进行适配"><a href="#使用最小宽度限定符-smallestWidth-进行适配" class="headerlink" title="使用最小宽度限定符(smallestWidth)进行适配"></a><strong>使用最小宽度限定符(smallestWidth)进行适配</strong></h3><blockquote>
<p>屏幕的基本尺寸，由可用屏幕区域的最小尺寸指定。具体而言，设备的 smallestWidth 是屏幕可用高度和宽度的最小尺寸（您也可将其视为屏幕的“最小可能宽度”）。无论屏幕的当前方向如何，您均可使用此限定符确保应用界面的可用宽度至少为  dp。<br>例如，如果布局要求屏幕区域的最小尺寸始终至少为 600dp，则可使用此限定符创建布局资源 res&#x2F;layout-sw600dp&#x2F;。仅当可用屏幕的最小尺寸至少为 600dp（无论 600dp 表示的边是用户所认为的高度还是宽度）时，系统才会使用这些资源。最小宽度为设备的固定屏幕尺寸特征；即使屏幕方向发生变化，设备的最小宽度仍会保持不变。</p>
</blockquote>
<p>该最小宽度的计算方式为：<code>屏幕宽度(px)/屏幕密度缩放倍数</code>。如你的屏幕为720x1280 xhdpi，那么720&#x2F;2&#x3D;360。</p>
<p>使用如下：<code>res/values-sw360dp/dimens.xml</code>，就是满足最小宽度(dp)为360dpi的屏幕进行适配，这种方式是分辨率+屏幕密度(dpi)，算是现在对于<strong>多尺寸屏幕适配</strong>比较好的方案。</p>
<h3 id="可用宽度-高度-限定符进行适配"><a href="#可用宽度-高度-限定符进行适配" class="headerlink" title="可用宽度(高度)限定符进行适配"></a><strong>可用宽度(高度)限定符进行适配</strong></h3><blockquote>
<p>您可能希望根据当前可用的宽度或高度来更改布局，而不是根据屏幕的最小宽度来更改布局。例如，如果您有一个双窗格布局，您可能希望在屏幕宽度至少为 600dp 时使用该布局，但屏幕宽度可能会根据设备的屏幕方向是横向还是纵向而发生变化。</p>
</blockquote>
<p>使用<strong>最小宽度限定符</strong>的适配方式对于等比例屏幕效果比较好，如果是屏幕长宽比例较大时就不太适用，这时可以使用<strong>可用宽度(高度)符</strong>，这两种方案搭配几乎可以满足所有适配需求。</p>
<p>计算方式为与<strong>最小宽度限定符</strong>一样。</p>
<p>使用如下：<code>res/values-w360dp/dimens.xml</code>，就是满足宽度(dp)为360dpi的屏幕进行适配或者<code>res/values-h720dp/dimens.xml</code>就是满足高度(dp)为720dpi的屏幕进行适配。</p>
<h2 id="相关其它"><a href="#相关其它" class="headerlink" title="相关其它"></a>相关其它</h2><h3 id="dp与px的转换规则"><a href="#dp与px的转换规则" class="headerlink" title="dp与px的转换规则"></a>dp与px的转换规则</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">px = dp * (dpi / 160)</span><br></pre></td></tr></table></figure>
<p><code>dpi</code>：由上表可得，就是每平方英寸可显示的像素数量，如mdpi~240dpi。</p>
<h3 id="设计图中的px与dp转换"><a href="#设计图中的px与dp转换" class="headerlink" title="设计图中的px与dp转换"></a>设计图中的px与dp转换</h3><p>在Photoshop中的**像素&#x2F;英寸 (ppi)**与Android的<code>屏幕密度</code>(dpi)基本是一个概念，于是在设计图(320ppi)中一个控件的外边距为10px，由上面的转换规则可知<code>dp=px/(dpi/160)</code>，这里就是10&#x2F;(320&#x2F;160)&#x3D;5，也就是在xhdpi的布局中对应控件的外边距为5dp。</p>
<h3 id="改变设备的屏幕密度-dpi"><a href="#改变设备的屏幕密度-dpi" class="headerlink" title="改变设备的屏幕密度(dpi)"></a>改变设备的<code>屏幕密度</code>(dpi)</h3><p>获取设备屏幕分辨率：<code>adb shell wm size</code>获取设备<code>屏幕密度</code>(dpi)：<code>adb shell wm density</code>设置<code>屏幕密度</code>(dpi) ：<code>adb shell wm density 320</code>重置<code>屏幕密度</code>(dpi) ：<code>adb shell wm density reset</code></p>
<p><strong>注意</strong>：虽然改变了系统的参数，但是系统判断自定义适配规制是无效的，会跳过当前dpi，但是<code>最小宽度限定符</code>是生效的。例如：</p>
<ul>
<li>当前应用适配有hdpi、xxdpi、xxxdpi，给设备设置的是hdpi，于是系统给应用分配的是xxdpi中的参数。</li>
<li>当前应用适配有sw480dp，给设备(720p)设置的是hdpi，是正常的。</li>
</ul>
<h3 id="获取屏幕参数代码片段"><a href="#获取屏幕参数代码片段" class="headerlink" title="获取屏幕参数代码片段"></a>获取屏幕参数代码片段</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getAndroiodScreenProperty</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">WindowManager</span> <span class="variable">wm</span> <span class="operator">=</span> (WindowManager) getSystemService(Context.WINDOW_SERVICE);</span><br><span class="line">    <span class="type">DisplayMetrics</span> <span class="variable">dm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DisplayMetrics</span>();</span><br><span class="line">    wm.getDefaultDisplay().getMetrics(dm);</span><br><span class="line">    <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> dm.widthPixels;         <span class="comment">// 屏幕宽度（像素）</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> dm.heightPixels;       <span class="comment">// 屏幕高度（像素）</span></span><br><span class="line">    <span class="type">float</span> <span class="variable">density</span> <span class="operator">=</span> dm.density;         <span class="comment">// 屏幕密度（0.75 / 1.0 / 1.5）</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">densityDpi</span> <span class="operator">=</span> dm.densityDpi;     <span class="comment">// 屏幕密度dpi（120 / 160 / 240）</span></span><br><span class="line">    <span class="comment">// 屏幕宽度算法:屏幕宽度（像素）/屏幕密度</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">screenWidth</span> <span class="operator">=</span> (<span class="type">int</span>) (width / density);  <span class="comment">// 屏幕宽度(dp)</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">screenHeight</span> <span class="operator">=</span> (<span class="type">int</span>) (height / density);<span class="comment">// 屏幕高度(dp)</span></span><br><span class="line"></span><br><span class="line">    Log.d(TAG, <span class="string">&quot;屏幕宽度（像素）：&quot;</span> + width);</span><br><span class="line">    Log.d(TAG, <span class="string">&quot;屏幕高度（像素）：&quot;</span> + height);</span><br><span class="line">    Log.d(TAG, <span class="string">&quot;屏幕密度（0.75 / 1.0 / 1.5）：&quot;</span> + density);</span><br><span class="line">    Log.d(TAG, <span class="string">&quot;屏幕密度dpi（120 / 160 / 240）：&quot;</span> + densityDpi);</span><br><span class="line">    Log.d(TAG, <span class="string">&quot;屏幕宽度（dp）：&quot;</span> + screenWidth);</span><br><span class="line">    Log.d(TAG, <span class="string">&quot;屏幕高度（dp）：&quot;</span> + screenHeight);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/training/multiscreen/screensizes">支持不同的屏幕尺寸</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/training/multiscreen/screendensities">支持不同的像素密度</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903612926296072#heading-10">推荐Android两种屏幕适配方案 </a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/wangliblog/article/details/22501141">Android获取屏幕的宽度和高度(dp)</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/nihaomabmt/article/details/71215507">Android屏幕values-sw适配</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.liaoheng.me/2019/12/23/PyQt5-QWebEngineView%E4%B8%8EJavaScript%E4%BA%A4%E4%BA%92/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="liaoheng">
      <meta itemprop="description" content="A developer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liaoheng`s blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/23/PyQt5-QWebEngineView%E4%B8%8EJavaScript%E4%BA%A4%E4%BA%92/" class="post-title-link" itemprop="url">PyQt5中QWebEngineView与JavaScript交互</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-12-23 17:16:38" itemprop="dateCreated datePublished" datetime="2019-12-23T17:16:38+08:00">2019-12-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-02-21 10:32:28" itemprop="dateModified" datetime="2024-02-21T10:32:28+08:00">2024-02-21</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><h4 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h4><ul>
<li>Python 3.8.1</li>
<li>Windows 10</li>
</ul>
<h4 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install PyQt5</span><br><span class="line">pip install PyQtWebEngine</span><br></pre></td></tr></table></figure>

<h3 id="Python端"><a href="#Python端" class="headerlink" title="Python端"></a>Python端</h3><ol>
<li><p>使用<code>QWebChannel</code>的<code>registerObject（&quot;JsBridge名&quot;,&quot;JsBridge&quot;）</code>方法注册回调</p>
<ul>
<li><code>JsBridge名</code>：在JavaScript中调用时使用的对象名称</li>
<li><code>JsBridge</code>：被JavaScript调用的Python对象</li>
</ul>
</li>
<li><p><code>JsBridge</code> 对象</p>
<ul>
<li>入参</li>
</ul>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@QtCore.pyqtSlot(<span class="params"><span class="built_in">str</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">log</span>(<span class="params">self, message</span>):</span><br><span class="line">    <span class="built_in">print</span>(message)</span><br></pre></td></tr></table></figure>

<ul>
<li>出参</li>
</ul>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@QtCore.pyqtSlot(<span class="params">result=<span class="built_in">str</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getName</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>出入参</li>
</ul>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@QtCore.pyqtSlot(<span class="params"><span class="built_in">str</span>, result=<span class="built_in">str</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>(<span class="params">self, message</span>):</span><br><span class="line">    <span class="built_in">print</span>(message)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="JavaScript端"><a href="#JavaScript端" class="headerlink" title="JavaScript端"></a>JavaScript端</h3><ol>
<li><p>在Html的<code>&lt;head&gt;</code>中添加</p>
 <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&#x27;qrc:///qtwebchannel/qwebchannel.js&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>调用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">QWebChannel</span>(qt.<span class="property">webChannelTransport</span>, <span class="keyword">function</span>(<span class="params">channel</span>) &#123;</span><br><span class="line">     channel.<span class="property">objects</span>.<span class="property">pythonBridge</span>.<span class="title function_">test</span>(<span class="string">&quot;hello&quot;</span>,<span class="keyword">function</span>(<span class="params">arg</span>) &#123;</span><br><span class="line">         <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Python message: &quot;</span> + arg);</span><br><span class="line">         <span class="title function_">alert</span>(arg);</span><br><span class="line">     &#125;);</span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>调试(Chrome DevTools)</p>
<ol>
<li>配置环境变量：<code>QTWEBENGINE_REMOTE_DEBUGGING = port</code></li>
<li>使用Chromium内核的浏览器打开地址：<code>http://127.0.0.1:port</code></li>
<li>使用<code>PyCharm</code>中可以在运行配置(Run&#x2F;Debug Configurations)中的Environment variables中添加环境变量,用<code>;</code>号分隔，然后可以直接运行。</li>
</ol>
</li>
</ol>
<h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h3><h4 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h4><ol>
<li><p><strong>JsBridge</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PyQt5 <span class="keyword">import</span> QtCore</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JsBridge</span>(QtCore.QObject):</span><br><span class="line"><span class="meta">    @QtCore.pyqtSlot(<span class="params"><span class="built_in">str</span>, result=<span class="built_in">str</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test</span>(<span class="params">self, message</span>):</span><br><span class="line">        <span class="built_in">print</span>(message)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><h5 id="Application"><a href="#Application" class="headerlink" title="Application"></a>Application</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PyQt5 <span class="keyword">import</span> QtCore</span><br><span class="line"><span class="keyword">from</span> PyQt5 <span class="keyword">import</span> QtWebEngineWidgets</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtCore <span class="keyword">import</span> QDir</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWebChannel <span class="keyword">import</span> QWebChannel</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWebEngineWidgets <span class="keyword">import</span> QWebEngineView</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestWindow</span>(<span class="title class_ inherited__">QMainWindow</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.webView = QWebEngineView()</span><br><span class="line">        self.webView.settings().setAttribute(</span><br><span class="line">            QtWebEngineWidgets.QWebEngineSettings.JavascriptEnabled, <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        channel = QWebChannel(self.webView.page())</span><br><span class="line">        self.webView.page().setWebChannel(channel)</span><br><span class="line">        self.python_bridge = JsBridge(<span class="literal">None</span>)</span><br><span class="line">        channel.registerObject(<span class="string">&quot;pythonBridge&quot;</span>, self.python_bridge)</span><br><span class="line">        layout = QVBoxLayout()</span><br><span class="line">        layout.addWidget(self.webView)</span><br><span class="line">        widget = QWidget()</span><br><span class="line">        widget.setLayout(layout)</span><br><span class="line">        self.setCentralWidget(widget)</span><br><span class="line"></span><br><span class="line">        self.resize(<span class="number">900</span>, <span class="number">600</span>)</span><br><span class="line">        self.setWindowTitle(<span class="string">&#x27;Test&#x27;</span>)</span><br><span class="line">        qr = self.frameGeometry()</span><br><span class="line">        cp = QDesktopWidget().availableGeometry().center()</span><br><span class="line">        qr.moveCenter(cp)</span><br><span class="line">        self.move(qr.topLeft())</span><br><span class="line">        self.show()</span><br><span class="line">        html_path = QtCore.QUrl.fromLocalFile(QDir.currentPath() + <span class="string">&quot;/assets/index.html&quot;</span>)</span><br><span class="line">        self.webView.load(html_path)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app = QApplication(sys.argv)</span><br><span class="line">    m = TestWindow()</span><br><span class="line">    sys.exit(app.exec_())</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="JavaScript"><a href="#JavaScript" class="headerlink" title="JavaScript"></a>JavaScript</h4><blockquote>
<h5 id="index-html"><a href="#index-html" class="headerlink" title="index.html"></a>index.html</h5></blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;zh&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Test<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&#x27;qrc:///qtwebchannel/qwebchannel.js&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://code.jquery.com/jquery-3.4.1.min.js&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">integrity</span>=<span class="string">&quot;sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">crossorigin</span>=<span class="string">&quot;anonymous&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;test&quot;</span>&gt;</span>test<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    $(<span class="variable language_">document</span>).<span class="title function_">ready</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">new</span> <span class="title class_">QWebChannel</span>(qt.<span class="property">webChannelTransport</span>, <span class="keyword">function</span>(<span class="params">channel</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            $(<span class="string">&#x27;#test&#x27;</span>).<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                channel.<span class="property">objects</span>.<span class="property">pythonBridge</span>.<span class="title function_">test</span>(<span class="string">&quot;hello&quot;</span>,<span class="keyword">function</span>(<span class="params">arg</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Python message: &quot;</span> + arg);</span></span><br><span class="line"><span class="language-javascript">                  <span class="title function_">alert</span>(arg);</span></span><br><span class="line"><span class="language-javascript">                &#125;);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.liaoheng.me/2017/09/15/Android-React-Native%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="liaoheng">
      <meta itemprop="description" content="A developer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liaoheng`s blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/09/15/Android-React-Native%E5%85%A5%E9%97%A8/" class="post-title-link" itemprop="url">Android React Native入门</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-09-15 17:34:00" itemprop="dateCreated datePublished" datetime="2017-09-15T17:34:00+08:00">2017-09-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-02-21 10:32:28" itemprop="dateModified" datetime="2024-02-21T10:32:28+08:00">2024-02-21</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>本文需要了解基本Android开发知识</p>
</blockquote>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><ol>
<li><a target="_blank" rel="noopener" href="http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html">JDK</a></li>
<li><a target="_blank" rel="noopener" href="https://nodejs.org/en/download/">Node</a></li>
<li><a target="_blank" rel="noopener" href="https://facebook.github.io/watchman/docs/install.html#build-install">Watchman 可选</a> <code>Windows问题比较多，不推荐安装</code></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/studio/index.html">Android SDK</a><code>配置环境</code></li>
</ol>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><ol>
<li>项目结构，创建相应文件</li>
</ol>
<blockquote>
<p>├── android<br>├── index.js<br>├── node_modules<br>├── package.json</p>
</blockquote>
<ol start="2">
<li>编辑<code>package.json</code>文件添加：</li>
</ol>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;[项目名]&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;private&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node node_modules/react-native/local-cli/cli.js start&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jest&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;dependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;react&quot;</span><span class="punctuation">:</span> <span class="string">&quot;16.3.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;react-native&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.55.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;react-navigation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.5.2&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;devDependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;babel-jest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;22.4.3&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;babel-preset-react-native&quot;</span><span class="punctuation">:</span> <span class="string">&quot;4.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;jest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;22.4.3&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;react-test-renderer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;16.3.1&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;jest&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;preset&quot;</span><span class="punctuation">:</span> <span class="string">&quot;react-native&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>也可以使用命令创建官方的HelloWorld项目，然后拷贝相关配置文件，如下：</p>
</blockquote>
<blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install -g create-react-native-app</span><br><span class="line">create-react-native-app AwesomeProject</span><br></pre></td></tr></table></figure>
</blockquote>
<ol start="3">
<li>安装nodejs库，在根目录中执行命令：</li>
</ol>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br><span class="line">npm install -g react-native-cli</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>编辑<code>index.js</code>文件添加：</li>
</ol>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; <span class="title class_">Component</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line"><span class="title class_">AppRegistry</span>,</span><br><span class="line"><span class="title class_">StyleSheet</span>,</span><br><span class="line"><span class="title class_">Text</span>,</span><br><span class="line"><span class="title class_">View</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;react-native&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Launch</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line"> <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">   <span class="keyword">return</span> (</span><br><span class="line">     <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;styles.container&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;styles.welcome&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        Welcome to React Native!</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;styles.instructions&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        To get started, edit index.js</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;styles.instructions&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        Double tap R on your keyboard to reload,&#123;&#x27;\n&#x27;&#125;</span></span><br><span class="line"><span class="language-xml">        Shake or press menu button for dev menu</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">     <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">   );</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> styles = <span class="title class_">StyleSheet</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line"> <span class="attr">container</span>: &#123;</span><br><span class="line">  <span class="attr">flex</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">justifyContent</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">  <span class="attr">alignItems</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">  <span class="attr">backgroundColor</span>: <span class="string">&#x27;#F5FCFF&#x27;</span>,</span><br><span class="line"> &#125;,</span><br><span class="line"> <span class="attr">welcome</span>: &#123;</span><br><span class="line">  <span class="attr">fontSize</span>: <span class="number">20</span>,</span><br><span class="line">  <span class="attr">textAlign</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">  <span class="attr">margin</span>: <span class="number">10</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">instructions</span>: &#123;</span><br><span class="line">  <span class="attr">textAlign</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">  <span class="attr">color</span>: <span class="string">&#x27;#333333&#x27;</span>,</span><br><span class="line">  <span class="attr">marginBottom</span>: <span class="number">5</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">AppRegistry</span>.<span class="title function_">registerComponent</span>(<span class="string">&#x27;ReactTest&#x27;</span>, <span class="function">() =&gt;</span> <span class="title class_">Launch</span>);</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>在<code>android目录</code>中创建app工程项目，然后在项目中集成React Native</li>
</ol>
<ul>
<li><p>[可选] 在<code>settings.gradle</code>文件中添加：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rootProject.name</span> = <span class="string">&#x27;[项目名]&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在<code>gradle.properties</code>文件中添加：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">android.useDeprecatedNdk</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在根目录<code>build.gradle</code>文件中添加：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">allprojects &#123;</span><br><span class="line">   repositories &#123;</span><br><span class="line">      maven &#123;</span><br><span class="line">        url <span class="string">&quot;$rootDir/../node_modules/react-native/android&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在app目录<code>build.gradle</code>文件中添加：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="attr">from:</span> <span class="string">&quot;../../node_modules/react-native/react.gradle&quot;</span></span><br><span class="line">   android &#123;</span><br><span class="line">   defaultConfig &#123;</span><br><span class="line">      ndk &#123;</span><br><span class="line">          abiFilters <span class="string">&quot;armeabi-v7a&quot;</span>, <span class="string">&quot;x86&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   splits &#123;</span><br><span class="line">       abi &#123;</span><br><span class="line">          reset()</span><br><span class="line">          enable <span class="literal">false</span></span><br><span class="line">          universalApk <span class="literal">false</span>  <span class="comment">// If true, also generate a universal APK</span></span><br><span class="line">          include <span class="string">&quot;armeabi-v7a&quot;</span>, <span class="string">&quot;x86&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   dependencies &#123;</span><br><span class="line">     compile <span class="string">&quot;com.facebook.react:react-native:+&quot;</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在app项目中创建<code>MApplication.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MApplication</span> <span class="keyword">extends</span> <span class="title class_">Application</span> <span class="keyword">implements</span> <span class="title class_">ReactApplication</span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReactNativeHost</span> <span class="variable">mReactNativeHost</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReactNativeHost</span>(<span class="built_in">this</span>)&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">getUseDeveloperSupport</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> BuildConfig.DEBUG;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> List&lt;ReactPackage&gt; <span class="title function_">getPackages</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> Arrays.&lt;ReactPackage&gt;asList(<span class="keyword">new</span> <span class="title class_">MainReactPackage</span>());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> String <span class="title function_">getJSMainModuleName</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ReactNativeHost <span class="title function_">getReactNativeHost</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> mReactNativeHost;</span><br><span class="line">&#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在app项目中创建<code>MainActivity.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">ReactActivity</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Nullable</span></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">protected</span> String <span class="title function_">getMainComponentName</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;ReactTest&quot;</span>;<span class="comment">//与index.js中registerComponent对应</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改app项目中<code>AndroidManifest.xml</code>文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;.MApplication&quot;</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;.MainActivity&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">             <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.facebook.react.devsupport.DevSettingsActivity&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><ol>
<li>通过命令行直接运行<code>开发服务</code>和app:</li>
</ol>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">react-native run-android</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果使用Windows系统请使用方法1，方法2会在运行app时出现异常：<code>java.io.IOException: Could not delete path</code></p>
</blockquote>
<ol start="2">
<li>通过命令运行<code>开发服务</code>，然后手动运行app</li>
</ol>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm start</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">也可使用： react-native start</span></span><br></pre></td></tr></table></figure>

<p>  <code>开发服务</code>正常启动后如下，使用中不能关闭（如果安装Watchman，<code>开发服务</code>会在后台运行可以关闭当前窗口）：</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">\&gt; ReactTest@0.0.1 start x:\xxxx\React</span><br><span class="line">\&gt; node node_modules/react-native/local-cli/cli.js start</span><br><span class="line"></span><br><span class="line">Scanning 564 folders for symlinks in x:\xxxx\React\node_modules (43ms)</span><br><span class="line">┌────────────────────────────────────────────────────────────────────────────  ┐</span><br><span class="line">│  Running packager on port 8081.                                              │</span><br><span class="line">│                                                                              │</span><br><span class="line">│  Keep this packager running while developing on any JS projects. Feel        │</span><br><span class="line">│  free to close this tab and run your own packager instance if you            │</span><br><span class="line">│  prefer.                                                                    │</span><br><span class="line">│                                                                              │</span><br><span class="line">│  https://github.com/facebook/react-native                                    │</span><br><span class="line">│                                                                              │</span><br><span class="line">└────────────────────────────────────────────────────────────────────────────┘</span><br><span class="line">Looking for JS files in</span><br><span class="line">    X:\xxxx\React</span><br><span class="line">    </span><br><span class="line">React packager ready.</span><br><span class="line"></span><br><span class="line">Loading dependency graph, done.</span><br></pre></td></tr></table></figure>

<h3 id="提示"><a href="#提示" class="headerlink" title="提示"></a>提示</h3><ul>
<li>默认在根目录中执行以上命令</li>
<li>出现手机或虚拟机无法连接电脑时可使用<code>adb reverse tcp:8081 tcp:8081</code></li>
<li>debug模式默认使用8081端口,如果本地以被占用，通过<code>react-native start --port 9988</code>修改端口。</li>
<li>注意需要权限：<code>&lt;uses-permission android:name=&quot;android.permission.INTERNET&quot; /&gt;</code></li>
<li>参考：<ul>
<li><a target="_blank" rel="noopener" href="http://facebook.github.io/react-native/docs/integration-with-existing-apps.html">http://facebook.github.io/react-native/docs/integration-with-existing-apps.html</a></li>
<li><a target="_blank" rel="noopener" href="http://facebook.github.io/react-native/docs/getting-started.html">http://facebook.github.io/react-native/docs/getting-started.html</a></li>
</ul>
</li>
</ul>
<h3 id="Demo-ReactTest"><a href="#Demo-ReactTest" class="headerlink" title="Demo:ReactTest"></a>Demo:<a target="_blank" rel="noopener" href="https://github.com/liaoheng/ReactTest">ReactTest</a></h3>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.liaoheng.me/2016/12/19/Android-BLE-Issues/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="liaoheng">
      <meta itemprop="description" content="A developer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liaoheng`s blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/12/19/Android-BLE-Issues/" class="post-title-link" itemprop="url">Android BLE Issues(问题集)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-12-19 22:08:00" itemprop="dateCreated datePublished" datetime="2016-12-19T22:08:00+08:00">2016-12-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-02-21 10:32:28" itemprop="dateModified" datetime="2024-02-21T10:32:28+08:00">2024-02-21</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>新进入公司做智能家居设备，于是查寻了一下Android BLE的问题，这是比较全面的一片文章，简单翻译一下。</p>
</blockquote>
<blockquote>
<p>原文链接:<a target="_blank" rel="noopener" href="http://www.slideshare.net/yeokm1/introduction-to-bluetooth-low-energy">http://www.slideshare.net/yeokm1/introduction-to-bluetooth-low-energy</a></p>
</blockquote>
<h2 id="Android-issues-the-past-BLE支持之前的问题"><a href="#Android-issues-the-past-BLE支持之前的问题" class="headerlink" title="Android issues (the past) BLE支持之前的问题"></a>Android issues (the past) <code>BLE支持之前的问题</code></h2><blockquote>
<p><a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/14118658/devices-with-android-4-2-jelly-bean-supported-bluetooth-low-energy-ble">http://stackoverflow.com/questions/14118658/devices-with-android-4-2-jelly-bean-supported-bluetooth-low-energy-ble</a></p>
</blockquote>
<ul>
<li>Before Android 4.3 (July 2013) <code>Android 4.3在2013年七月之前</code><ul>
<li>Fragmentation hell <code>痛苦的碎片化</code></li>
<li>Proprietary Libraries by OEMs, Android &lt;&#x3D; 4.2 <code>各大OEM厂商提供的私有库</code><ul>
<li>Samsung (quite reliable)</li>
<li>HTC – buggy, unreliable</li>
<li>Motorola (reliable but conflicts with Android 4.3)</li>
</ul>
</li>
<li>Architecture issues <code>架构上的问题</code></li>
</ul>
</li>
<li>Testing issues <code>其它问题</code></li>
</ul>
<h2 id="Android-issues-today-BLE支持之后的问题"><a href="#Android-issues-today-BLE支持之后的问题" class="headerlink" title="Android issues (today) BLE支持之后的问题"></a>Android issues (today) <code>BLE支持之后的问题</code></h2><blockquote>
<p><a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/17870189/android-4-3-bluetooth-low-energy-unstable">http://stackoverflow.com/questions/17870189/android-4-3-bluetooth-low-energy-unstable</a></p>
</blockquote>
<ol>
<li>OS fragmentation</li>
</ol>
<ul>
<li>74.2% of Android devices support BLE <code>只有74.2%的设备支持</code></li>
<li><font color="#D32627">Few support peripheral mode: 35.3% minus Nexus 4, 5, 7 (2012&#x2F;2013)</font> <code>只有35.3%支持手机作为外围设备，只有5.0以上才支持。</code></li>
</ul>
<ol start="2">
<li><p>All callbacks from BLE APIs are not on UI thread. <code>所有的回调不是在UI线程</code></p>
</li>
<li><p>APIs considered new, some functions are buggy <code>考虑使用新的API的话会有一些bug</code></p>
</li>
<li><p>Frequent connection drops (&lt; 5.0) <code>5.0之前频繁连接会导致连接无法使用</code></p>
<blockquote>
<p>参考：<a target="_blank" rel="noopener" href="https://code.google.com/p/android/issues/detail?id=180440">https://code.google.com/p/android/issues/detail?id=180440</a></p>
</blockquote>
</li>
<li><p>Max BLE connections: <code>最大连接数</code></p>
</li>
</ol>
<ul>
<li>Software cap in Bluedroid code: BTA_GATTC_CONN_MAX, GATT_MAX_PHY_CHANNEL</li>
<li>Android 4.3: 4</li>
<li>4.4 - 5.0+: 7</li>
</ul>
<ol start="6">
<li>No API callback to indicate scanning has stopped <code>没有提供startLeScan()扫描结束的回调</code></li>
</ol>
<ul>
<li><p>Scan supposed to be indefinite by API specification, but some phones stop scan after some time <code>API规范与实际扫描结果并不相符，并且一些手机停止扫描需要的时间比较长。</code></p>
<blockquote>
<p>比如有一些手机会一直回调设备，直到设备连接成功，而有一些设备(Samsung…)只回调一次</p>
</blockquote>
</li>
<li><p>Known offender: Samsung <code>比如著名的三星</code></p>
</li>
<li><p>Solution: Restart scan at regular intervals <code>解决方法：扫描定时</code></p>
</li>
</ul>
<ol start="7">
<li>Different scan return result behaviours (See further reading) <code>扫描的结果并不相同</code></li>
</ol>
<ul>
<li>Some phones filter advertisement results, some phones do not. (usually on 4.3 and 4.4)<code>有一些设备会过滤掉广告结果</code></li>
</ul>
<ol start="8">
<li>Bugs on (Samsung) phones at least &lt; 5.0 <code>三星5.0之前bug</code></li>
</ol>
<ul>
<li>Scan using service UUID filtering does not work -&gt; no results returned <code>使用startLeScan()过滤UUID无法工作，没有返回结果</code></li>
<li>connectGatt() must be called from UI thread<code>connectGatt()必须在UI线程中调用</code></li>
</ul>
<ol start="9">
<li>Slow LE initial discovery and connection time <code>初始化查找与连接设备相当缓慢</code></li>
</ol>
<ul>
<li>HTC seems to have this issue<code>HTC好像有这个问题</code><blockquote>
<p>华为，三星也会，其他没有测试过</p>
</blockquote>
</li>
</ul>
<ol start="9">
<li>A high-level view on issues collated by Anaren <code>一些高层view问题的整理</code></li>
</ol>
<ul>
<li><a target="_blank" rel="noopener" href="https://atmosphere.anaren.com/wiki/Android_Issues_With_Bluetooth_Low_Energy">https://atmosphere.anaren.com/wiki/Android_Issues_With_Bluetooth_Low_Energy</a></li>
</ul>
<ol start="10">
<li>A more comprehensive list of issues has been collated by iDevicesInc <code>全面问题清单</code></li>
</ol>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/iDevicesInc/SweetBlue/wiki/Android-BLE-Issues">https://github.com/iDevicesInc/SweetBlue/wiki/Android-BLE-Issues</a></li>
<li>May be able to overcome using: <a target="_blank" rel="noopener" href="https://github.com/iDevicesInc/SweetBlue">https://github.com/iDevicesInc/SweetBlue</a> <code>或许可以使用这个库</code></li>
</ul>
<blockquote>
<p>个人推荐使用基于RxJava的库:<a target="_blank" rel="noopener" href="https://github.com/Polidea/RxAndroidBle">https://github.com/Polidea/RxAndroidBle</a></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="liaoheng"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">liaoheng</p>
  <div class="site-description" itemprop="description">A developer</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">8</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/liaoheng" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;liaoheng" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">liaoheng</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
