{"meta":{"version":1,"warehouse":"4.0.2"},"models":{"Asset":[{"_id":"source/CNAME","path":"CNAME","modified":0,"renderable":0},{"_id":"source/images/apple-touch-icon.png","path":"images/apple-touch-icon.png","modified":0,"renderable":0},{"_id":"source/images/avatar.jpg","path":"images/avatar.jpg","modified":0,"renderable":0},{"_id":"source/images/favicon-16x16.png","path":"images/favicon-16x16.png","modified":0,"renderable":0},{"_id":"source/images/favicon.ico","path":"images/favicon.ico","modified":0,"renderable":0},{"_id":"source/images/favicon-32x32.png","path":"images/favicon-32x32.png","modified":0,"renderable":0},{"_id":"source/images/safari-pinned-tab.svg","path":"images/safari-pinned-tab.svg","modified":0,"renderable":0},{"_id":"themes/hexo-theme-next/source/css/main.styl","path":"css/main.styl","modified":0,"renderable":1},{"_id":"themes/hexo-theme-next/source/images/apple-touch-icon-next.png","path":"images/apple-touch-icon-next.png","modified":0,"renderable":1},{"_id":"themes/hexo-theme-next/source/images/avatar.gif","path":"images/avatar.gif","modified":0,"renderable":1},{"_id":"themes/hexo-theme-next/source/images/cc-by-nc-nd.svg","path":"images/cc-by-nc-nd.svg","modified":0,"renderable":1},{"_id":"themes/hexo-theme-next/source/images/cc-by-nc-sa.svg","path":"images/cc-by-nc-sa.svg","modified":0,"renderable":1},{"_id":"themes/hexo-theme-next/source/images/algolia_logo.svg","path":"images/algolia_logo.svg","modified":0,"renderable":1},{"_id":"themes/hexo-theme-next/source/images/cc-by-nc.svg","path":"images/cc-by-nc.svg","modified":0,"renderable":1},{"_id":"themes/hexo-theme-next/source/images/cc-by-nd.svg","path":"images/cc-by-nd.svg","modified":0,"renderable":1},{"_id":"themes/hexo-theme-next/source/images/cc-by.svg","path":"images/cc-by.svg","modified":0,"renderable":1},{"_id":"themes/hexo-theme-next/source/images/favicon-16x16-next.png","path":"images/favicon-16x16-next.png","modified":0,"renderable":1},{"_id":"themes/hexo-theme-next/source/images/cc-by-sa.svg","path":"images/cc-by-sa.svg","modified":0,"renderable":1},{"_id":"themes/hexo-theme-next/source/images/cc-zero.svg","path":"images/cc-zero.svg","modified":0,"renderable":1},{"_id":"themes/hexo-theme-next/source/images/favicon-32x32-next.png","path":"images/favicon-32x32-next.png","modified":0,"renderable":1},{"_id":"themes/hexo-theme-next/source/images/logo.svg","path":"images/logo.svg","modified":0,"renderable":1},{"_id":"themes/hexo-theme-next/source/js/algolia-search.js","path":"js/algolia-search.js","modified":0,"renderable":1},{"_id":"themes/hexo-theme-next/source/js/bookmark.js","path":"js/bookmark.js","modified":0,"renderable":1},{"_id":"themes/hexo-theme-next/source/js/local-search.js","path":"js/local-search.js","modified":0,"renderable":1},{"_id":"themes/hexo-theme-next/source/js/motion.js","path":"js/motion.js","modified":0,"renderable":1},{"_id":"themes/hexo-theme-next/source/js/next-boot.js","path":"js/next-boot.js","modified":0,"renderable":1},{"_id":"themes/hexo-theme-next/source/js/utils.js","path":"js/utils.js","modified":0,"renderable":1},{"_id":"themes/hexo-theme-next/source/lib/anime.min.js","path":"lib/anime.min.js","modified":0,"renderable":1},{"_id":"themes/hexo-theme-next/source/js/schemes/muse.js","path":"js/schemes/muse.js","modified":0,"renderable":1},{"_id":"themes/hexo-theme-next/source/js/schemes/pisces.js","path":"js/schemes/pisces.js","modified":0,"renderable":1},{"_id":"themes/hexo-theme-next/source/lib/velocity/velocity.min.js","path":"lib/velocity/velocity.min.js","modified":0,"renderable":1},{"_id":"themes/hexo-theme-next/source/lib/velocity/velocity.ui.min.js","path":"lib/velocity/velocity.ui.min.js","modified":0,"renderable":1},{"_id":"themes/hexo-theme-next/source/lib/font-awesome/css/all.min.css","path":"lib/font-awesome/css/all.min.css","modified":0,"renderable":1},{"_id":"themes/hexo-theme-next/source/lib/font-awesome/webfonts/fa-brands-400.woff2","path":"lib/font-awesome/webfonts/fa-brands-400.woff2","modified":0,"renderable":1},{"_id":"themes/hexo-theme-next/source/lib/font-awesome/webfonts/fa-regular-400.woff2","path":"lib/font-awesome/webfonts/fa-regular-400.woff2","modified":0,"renderable":1},{"_id":"themes/hexo-theme-next/source/lib/font-awesome/webfonts/fa-solid-900.woff2","path":"lib/font-awesome/webfonts/fa-solid-900.woff2","modified":0,"renderable":1}],"Cache":[{"_id":"source/CNAME","hash":"6d5c4cefef831ae654f7a52c062e3ee56315470e","modified":1688132074848},{"_id":"source/_data/next.yml","hash":"dd459c28d26c9a8ffb40eeb8ef38ec61328dc990","modified":1688135876148},{"_id":"source/_posts/Android-BLE-Issues.md","hash":"1cc968bc6190a908a87edd2e21904d474ffde00e","modified":1688132074848},{"_id":"source/_posts/Android-React-Native入门.md","hash":"a3aedade77c01b208ba9f398a30049470a27a42e","modified":1688132074848},{"_id":"source/_posts/PyQt5-QWebEngineView与JavaScript交互.md","hash":"e72ef4e15deb2123a5c195b94642dc962510868c","modified":1688132074848},{"_id":"source/_posts/android-dp-and-screen-adaptation.md","hash":"efbd58d92a64e5d616dfd6525ed61c166f6746b9","modified":1688132074848},{"_id":"source/_posts/thread-block-and-suspend.md","hash":"6ef283fd8fa6a51a6adc325ea7eb1cfcd48c2149","modified":1688132074851},{"_id":"source/_posts/installation-arch-linux-summary.md","hash":"63fc1574d732d3c981ef09cd3ac430f5beab3b24","modified":1688132074851},{"_id":"source/images/apple-touch-icon.png","hash":"43278e1086f26c171fcf1277b75d8269a6d596cc","modified":1688132074851},{"_id":"source/images/favicon-16x16.png","hash":"f5c9f42704d94f3b002af9a46cf01a28615c4bfa","modified":1688132074854},{"_id":"source/images/favicon.ico","hash":"f02843df743cf6223f698f865d659dbae7ac9aeb","modified":1688132074854},{"_id":"source/images/favicon-32x32.png","hash":"2bde4f0ad4dd13318d6bc7eaf0980388009fd7bb","modified":1688132074854},{"_id":"source/_posts/traditional-bluetooth-protocol-stack-simple.md","hash":"0b6fe1d9ff51d042694c5ce671dcaefa7805d652","modified":1688132074851},{"_id":"source/images/safari-pinned-tab.svg","hash":"6d29e7e95ce617833d99ae24ecc10b859cfaf184","modified":1688132074854},{"_id":"source/images/avatar.jpg","hash":"366173ed33bcc846ce44f668793fb3fc82662216","modified":1688132074854},{"_id":"themes/hexo-theme-next/.editorconfig","hash":"731c650ddad6eb0fc7c3d4a91cad1698fe7ad311","modified":1688132212156},{"_id":"themes/hexo-theme-next/.eslintrc.json","hash":"d3c11de434171d55d70daadd3914bc33544b74b8","modified":1688132212156},{"_id":"themes/hexo-theme-next/.gitattributes","hash":"3e00e1fb043438cd820d94ee3dc9ffb6718996f3","modified":1688132212156},{"_id":"themes/hexo-theme-next/.gitignore","hash":"83418530da80e6a78501e1d62a89c3bf5cbaec3d","modified":1688132212163},{"_id":"themes/hexo-theme-next/.stylintrc","hash":"6259e2a0b65d46865ab89564b88fc67638668295","modified":1688132212163},{"_id":"themes/hexo-theme-next/.travis.yml","hash":"379f31a140ce41e441442add6f673bf397d863ea","modified":1688132212163},{"_id":"themes/hexo-theme-next/LICENSE.md","hash":"0a9c7399f102b4eb0a6950dd31264be421557c7d","modified":1688132212164},{"_id":"themes/hexo-theme-next/README.md","hash":"7d56751b580d042559b2acf904fca4b42bcb30a7","modified":1688132212164},{"_id":"themes/hexo-theme-next/crowdin.yml","hash":"4a53f5985e545c635cb56b2a57ed290cb8cf8942","modified":1688132212165},{"_id":"themes/hexo-theme-next/_config.yml","hash":"e5d4ee5c53dad5ca46ce27ee54043d327abd52ee","modified":1688132212165},{"_id":"themes/hexo-theme-next/gulpfile.js","hash":"0c76a1ac610ee8cbe8e2cc9cca1c925ffd0edf98","modified":1688132212173},{"_id":"themes/hexo-theme-next/.github/CODE_OF_CONDUCT.md","hash":"778b7e052993ed59f21ed266ba7119ee2e5253fb","modified":1688132212158},{"_id":"themes/hexo-theme-next/package.json","hash":"b099e7cea4406e209130410d13de87988ba37b2a","modified":1688132212203},{"_id":"themes/hexo-theme-next/.github/CONTRIBUTING.md","hash":"5ddde54fb50d11dc08cec899a3588addb56aa386","modified":1688132212158},{"_id":"themes/hexo-theme-next/.github/config.yml","hash":"df3d970700e6b409edc3d23be8d553db78d5ba3f","modified":1688132212161},{"_id":"themes/hexo-theme-next/.github/PULL_REQUEST_TEMPLATE.md","hash":"d2f8e6b65783e31787feb05d2ccea86151f53f35","modified":1688132212160},{"_id":"themes/hexo-theme-next/.github/issue-close-app.yml","hash":"b14756e65546eb9ecc9d4393f0c9a84a3dac1824","modified":1688132212161},{"_id":"themes/hexo-theme-next/.github/issue_label_bot.yaml","hash":"533fbe6b2f87d7e7ec6949063bb7ea7eb4fbe52d","modified":1688132212161},{"_id":"themes/hexo-theme-next/.github/lock.yml","hash":"3ce3d0a26030a1cd52b273cc6a6d444d7c8d85c2","modified":1688132212161},{"_id":"themes/hexo-theme-next/.github/mergeable.yml","hash":"1c1cb77a62df1e3654b151c2da34b4a10d351170","modified":1688132212162},{"_id":"themes/hexo-theme-next/.github/release-drafter.yml","hash":"09c3352b2d643acdc6839601ceb38abc38ab97c5","modified":1688132212162},{"_id":"themes/hexo-theme-next/.github/stale.yml","hash":"590b65aca710e0fba75d3cf5361a64d13b6b0f63","modified":1688132212162},{"_id":"themes/hexo-theme-next/.github/support.yml","hash":"7ce2722d6904c31a086444c422dc49b6aa310651","modified":1688132212162},{"_id":"themes/hexo-theme-next/docs/AGPL3.md","hash":"f463f95b169d64983f59fa6f3e4b6760290a0e6b","modified":1688132212166},{"_id":"themes/hexo-theme-next/docs/AUTHORS.md","hash":"cde7cc095ac31b421a573042cf61060f90d9ad0d","modified":1688132212166},{"_id":"themes/hexo-theme-next/docs/ALGOLIA-SEARCH.md","hash":"60c7e9ef0c578deebad43e9395c958fa61096baf","modified":1688132212166},{"_id":"themes/hexo-theme-next/docs/DATA-FILES.md","hash":"980fb8d37701f7fd96b30bb911519de3bbb473d1","modified":1688132212166},{"_id":"themes/hexo-theme-next/docs/INSTALLATION.md","hash":"07ea00bee149a1bdc9073e903ee6b411e9f2f818","modified":1688132212167},{"_id":"themes/hexo-theme-next/docs/LEANCLOUD-COUNTER-SECURITY.md","hash":"6cc663db5e99fd86bb993c10d446ad26ada88e58","modified":1688132212167},{"_id":"themes/hexo-theme-next/docs/LICENSE.txt","hash":"ae5ad07e4f4106bad55535dba042221539e6c7f9","modified":1688132212167},{"_id":"themes/hexo-theme-next/docs/MATH.md","hash":"f56946053ade0915ff7efa74d43c38b8dd9e63bb","modified":1688132212168},{"_id":"themes/hexo-theme-next/docs/UPDATE-FROM-5.1.X.md","hash":"1e86d32063b490d204baa9d45d8d3cb22c24a37d","modified":1688132212168},{"_id":"themes/hexo-theme-next/languages/ar.yml","hash":"abcf220bd615cec0dd50e4d98da56580169d77e1","modified":1688132212173},{"_id":"themes/hexo-theme-next/languages/en.yml","hash":"dbb64776f9c001c54d0058256c415a9a0724ed5d","modified":1688132212174},{"_id":"themes/hexo-theme-next/languages/de.yml","hash":"15078b7ede1b084e8a6a15d271f0db9c325bd698","modified":1688132212173},{"_id":"themes/hexo-theme-next/languages/default.yml","hash":"ea5e6aee4cb14510793ac4593a3bddffe23e530c","modified":1688132212174},{"_id":"themes/hexo-theme-next/languages/es.yml","hash":"f064c793d56a5e0f20cda93b6f0e355044efc7d8","modified":1688132212174},{"_id":"themes/hexo-theme-next/languages/fa.yml","hash":"6c0a7d5bcc26eb45a9f3e02f13117c668e77fffd","modified":1688132212174},{"_id":"themes/hexo-theme-next/languages/fr.yml","hash":"3e2f89d4bb4441d33ecc7b5a4ee114f627603391","modified":1688132212175},{"_id":"themes/hexo-theme-next/languages/hu.yml","hash":"0ea89ffaefd02a10494995f05a2a59d5e5679a28","modified":1688132212175},{"_id":"themes/hexo-theme-next/languages/id.yml","hash":"7599bb0ecf278beb8fde3d17bfc148a3241aef82","modified":1688132212175},{"_id":"themes/hexo-theme-next/languages/it.yml","hash":"46222f468e66789e9ba13095809eb5e5b63edf30","modified":1688132212176},{"_id":"themes/hexo-theme-next/languages/ja.yml","hash":"bf279d0eb1911806d01a12f27261fbc76a3bb3f9","modified":1688132212176},{"_id":"themes/hexo-theme-next/languages/nl.yml","hash":"9749cf90b250e631dd550a4f32ada3bb20f66dd0","modified":1688132212176},{"_id":"themes/hexo-theme-next/languages/ko.yml","hash":"af4be6cb394abd4e2e9a728418897d2ed4cc5315","modified":1688132212176},{"_id":"themes/hexo-theme-next/languages/pt-BR.yml","hash":"69aa3bef5710b61dc9a0f3b3a8f52f88c4d08c00","modified":1688132212177},{"_id":"themes/hexo-theme-next/languages/pt.yml","hash":"f6606dd0b916a465c233f24bd9a70adce34dc8d6","modified":1688132212177},{"_id":"themes/hexo-theme-next/languages/ru.yml","hash":"012abc694cf9de281a0610f95f79c594f0a16562","modified":1688132212177},{"_id":"themes/hexo-theme-next/languages/tr.yml","hash":"c4e9ab7e047ae13a19f147c6bec163c3ba2c6898","modified":1688132212178},{"_id":"themes/hexo-theme-next/languages/vi.yml","hash":"6a578cc28773bd764f4418110500478f185d6efa","modified":1688132212178},{"_id":"themes/hexo-theme-next/languages/uk.yml","hash":"69ef00b1b8225920fcefff6a6b6f2f3aad00b4ce","modified":1688132212178},{"_id":"themes/hexo-theme-next/languages/zh-HK.yml","hash":"92ccee40c234626bf0142152949811ebe39fcef2","modified":1688132212179},{"_id":"themes/hexo-theme-next/languages/zh-TW.yml","hash":"cf0740648725983fb88409d6501876f8b79db41d","modified":1688132212180},{"_id":"themes/hexo-theme-next/languages/zh-CN.yml","hash":"81d73e21402dad729053a3041390435f43136a68","modified":1688132212179},{"_id":"themes/hexo-theme-next/layout/_layout.swig","hash":"9554bd0f5c5a0438aa7b64065be5561c374d260e","modified":1688132212180},{"_id":"themes/hexo-theme-next/layout/archive.swig","hash":"d9bca77f6dcfef71e300a294f731bead11ce199f","modified":1688132212202},{"_id":"themes/hexo-theme-next/layout/category.swig","hash":"c546b017a956faaa5f5643c7c8a363af7ac9d6b9","modified":1688132212202},{"_id":"themes/hexo-theme-next/layout/index.swig","hash":"8dfd96fb6f833dd5d037de800813105654e8e8e6","modified":1688132212202},{"_id":"themes/hexo-theme-next/layout/page.swig","hash":"357d916694d4c9a0fd1140fa56d3d17e067d8b52","modified":1688132212202},{"_id":"themes/hexo-theme-next/layout/post.swig","hash":"5f0b5ba2e0a5b763be5e7e96611865e33bba24d7","modified":1688132212203},{"_id":"themes/hexo-theme-next/layout/tag.swig","hash":"d44ff8755727f6532e86fc9fc8dc631200ffe161","modified":1688132212203},{"_id":"themes/hexo-theme-next/.github/ISSUE_TEMPLATE/bug-report.md","hash":"e67146befddec3a0dc47dc80d1109070c71d5d04","modified":1688132212159},{"_id":"themes/hexo-theme-next/scripts/renderer.js","hash":"e3658eea97b1183ee2e9f676231e53f7994741f6","modified":1688132212210},{"_id":"themes/hexo-theme-next/.github/ISSUE_TEMPLATE/feature-request.md","hash":"6beeca0f45a429cd932b6e648617f548ff64c27c","modified":1688132212159},{"_id":"themes/hexo-theme-next/.github/ISSUE_TEMPLATE/other.md","hash":"d5aa1a3323639a36bcd9a401484b67537043cd3c","modified":1688132212160},{"_id":"themes/hexo-theme-next/docs/ru/INSTALLATION.md","hash":"a9cfe5ac9ef727a8650b2b6584482751a26b1460","modified":1688132212169},{"_id":"themes/hexo-theme-next/.github/ISSUE_TEMPLATE/question.md","hash":"59275aa0582f793fee7be67904dcf52ad33a7181","modified":1688132212160},{"_id":"themes/hexo-theme-next/docs/ru/DATA-FILES.md","hash":"54e6a067ed95268eab6be2ba040a7e9b1907928e","modified":1688132212168},{"_id":"themes/hexo-theme-next/docs/ru/UPDATE-FROM-5.1.X.md","hash":"cb8e39c377fc4a14aaf133b4d1338a48560e9e65","modified":1688132212169},{"_id":"themes/hexo-theme-next/docs/ru/README.md","hash":"1e5ddb26ad6f931f8c06ce2120f257ff38b74fdf","modified":1688132212169},{"_id":"themes/hexo-theme-next/docs/zh-CN/CODE_OF_CONDUCT.md","hash":"7e6f227f2aaf30f400d4c065650a4e3d0d61b9e1","modified":1688132212170},{"_id":"themes/hexo-theme-next/docs/zh-CN/ALGOLIA-SEARCH.md","hash":"3202be9a8d31986caac640e7a4c7ce22e99917eb","modified":1688132212170},{"_id":"themes/hexo-theme-next/docs/zh-CN/CONTRIBUTING.md","hash":"611f2930c2b281b80543531b1bf33d082531456a","modified":1688132212170},{"_id":"themes/hexo-theme-next/docs/zh-CN/DATA-FILES.md","hash":"2d868cd271d78b08775e28c5b976de8836da4455","modified":1688132212171},{"_id":"themes/hexo-theme-next/docs/zh-CN/INSTALLATION.md","hash":"716111dd36d276f463c707dfcc9937fea2a1cf7a","modified":1688132212171},{"_id":"themes/hexo-theme-next/docs/zh-CN/LEANCLOUD-COUNTER-SECURITY.md","hash":"50ab381c27611d5bf97bb3907b5ca9998f28187d","modified":1688132212171},{"_id":"themes/hexo-theme-next/docs/zh-CN/MATH.md","hash":"0d46f9f50cf2e4183970adce705d1041155b0d37","modified":1688132212172},{"_id":"themes/hexo-theme-next/docs/zh-CN/README.md","hash":"8f7c0d0b766024152591d4ccfac715c8e18b37f3","modified":1688132212172},{"_id":"themes/hexo-theme-next/docs/zh-CN/UPDATE-FROM-5.1.X.md","hash":"b3201934b966bc731eaf8a4dad4ba4bdcd300c10","modified":1688132212172},{"_id":"themes/hexo-theme-next/layout/_partials/comments.swig","hash":"142efb4c6b73d8f736f6784804b40d5871333172","modified":1688132212182},{"_id":"themes/hexo-theme-next/layout/_partials/footer.swig","hash":"e031914c98f082d918ece4c35fdd0a5be1c4e845","modified":1688132212182},{"_id":"themes/hexo-theme-next/layout/_partials/languages.swig","hash":"c3ea82604a5853fb44c5f4e4663cbe912aa5dcf8","modified":1688132212185},{"_id":"themes/hexo-theme-next/layout/_partials/pagination.swig","hash":"2de77d533c91532a8a4052000244d0c1693370df","modified":1688132212186},{"_id":"themes/hexo-theme-next/layout/_partials/widgets.swig","hash":"5392dcbb504266f0f61d5b8219914068ef9cdc25","modified":1688132212189},{"_id":"themes/hexo-theme-next/layout/_macro/post-collapse.swig","hash":"30ade8c806d7826cc50a4a3e46a9e6213fddf333","modified":1688132212181},{"_id":"themes/hexo-theme-next/layout/_macro/post.swig","hash":"c3fd56bac90ce45a0c79ddfe68beb223ad0d72b4","modified":1688132212181},{"_id":"themes/hexo-theme-next/layout/_macro/sidebar.swig","hash":"5bffdb1448caca7db7b1f84e1693e6657a106d50","modified":1688132212181},{"_id":"themes/hexo-theme-next/layout/_third-party/baidu-push.swig","hash":"28b0a7e843ec4365db1963646659a153753cd746","modified":1688132212195},{"_id":"themes/hexo-theme-next/layout/_third-party/index.swig","hash":"c6b63cbc80938e6e09578b8c67e01adf13a9e3bd","modified":1688132212197},{"_id":"themes/hexo-theme-next/layout/_third-party/quicklink.swig","hash":"5ae5adcd6f63ed98b2071e4f7e5e38c4d7d24e1b","modified":1688132212199},{"_id":"themes/hexo-theme-next/layout/_third-party/rating.swig","hash":"269102fc5e46bd1ce75abdcce161f0570ae70e2f","modified":1688132212199},{"_id":"themes/hexo-theme-next/layout/_scripts/index.swig","hash":"1822eaf55bbb4bec88871c324fc18ad95580ccb4","modified":1688132212190},{"_id":"themes/hexo-theme-next/layout/_scripts/noscript.swig","hash":"7b9e0f776a5be6c3f95bc7f394e1424ba02ba93b","modified":1688132212190},{"_id":"themes/hexo-theme-next/layout/_scripts/pjax.swig","hash":"ccff5a773644d33ff22f6b45b6734f52b048f22b","modified":1688132212191},{"_id":"themes/hexo-theme-next/layout/_scripts/three.swig","hash":"6b092c6d882b2dfa5273e1b3f60b244cb7c29fcd","modified":1688132212192},{"_id":"themes/hexo-theme-next/layout/_scripts/vendors.swig","hash":"244ca2d74ee0d497c87572c6a26b43c62a952673","modified":1688132212193},{"_id":"themes/hexo-theme-next/scripts/filters/default-injects.js","hash":"ad321db012cea520066deb0639335e9bc0dcc343","modified":1688132212207},{"_id":"themes/hexo-theme-next/scripts/filters/front-matter.js","hash":"305d03c1e45782988809298c3e3b3c5d5ee438aa","modified":1688132212207},{"_id":"themes/hexo-theme-next/scripts/filters/locals.js","hash":"a5e7d05d3bd2ae6dcffad5a8ea0f72c6e55dbd02","modified":1688132212207},{"_id":"themes/hexo-theme-next/scripts/filters/minify.js","hash":"21196a48cb127bf476ce598f25f24e8a53ef50c2","modified":1688132212207},{"_id":"themes/hexo-theme-next/scripts/filters/post.js","hash":"57f2d817578dd97e206942604365e936a49854de","modified":1688132212207},{"_id":"themes/hexo-theme-next/scripts/events/index.js","hash":"5c355f10fe8c948a7f7cd28bd8120adb7595ebde","modified":1688132212204},{"_id":"themes/hexo-theme-next/scripts/helpers/engine.js","hash":"eb6b8bbc1dce4846cd5e0fac0452dbff56d07b5d","modified":1688132212207},{"_id":"themes/hexo-theme-next/scripts/helpers/font.js","hash":"8fb1c0fc745df28e20b96222974402aab6d13a79","modified":1688132212207},{"_id":"themes/hexo-theme-next/scripts/helpers/next-config.js","hash":"b8d7ddfa4baa9b8d6b9066a634aa81c6243beec9","modified":1688132212207},{"_id":"themes/hexo-theme-next/scripts/helpers/next-url.js","hash":"4044129368d0e2811859a9661cad8ab47118bc32","modified":1688132212210},{"_id":"themes/hexo-theme-next/scripts/tags/button.js","hash":"bb0e8abbc0a6d5b3a1a75a23976f2ac3075aab31","modified":1688132212210},{"_id":"themes/hexo-theme-next/scripts/tags/caniuse.js","hash":"840536754121e0da5968f5ad235f29200fc5d769","modified":1688132212211},{"_id":"themes/hexo-theme-next/scripts/tags/group-pictures.js","hash":"93ccd3f99d3cb42674f29183c756df63acb5d7f8","modified":1688132212211},{"_id":"themes/hexo-theme-next/scripts/tags/center-quote.js","hash":"e2d0184bc4a557e1017395b80ff46880078d8537","modified":1688132212211},{"_id":"themes/hexo-theme-next/scripts/tags/label.js","hash":"fc83f4e1be2c34e81cb79938f4f99973eba1ea60","modified":1688132212211},{"_id":"themes/hexo-theme-next/scripts/tags/mermaid.js","hash":"81134494ff0134c0dae1b3815caf6606fccd4e46","modified":1688132212212},{"_id":"themes/hexo-theme-next/scripts/tags/note.js","hash":"1fdf4f95810fdb983bfd5ad4c4f13fedd4ea2f8d","modified":1688132212212},{"_id":"themes/hexo-theme-next/scripts/tags/pdf.js","hash":"37b53661ad00a01a2ca7d2e4a5ad3a926073f8e2","modified":1688132212212},{"_id":"themes/hexo-theme-next/scripts/tags/tabs.js","hash":"c70a4a66fd0c28c98ccb6c5d5f398972e5574d28","modified":1688132212213},{"_id":"themes/hexo-theme-next/scripts/tags/video.js","hash":"944293fec96e568d9b09bc1280d5dbc9ee1bbd17","modified":1688132212213},{"_id":"themes/hexo-theme-next/source/css/_colors.styl","hash":"11aef31a8e76f0f332a274a8bfd4537b73d4f88f","modified":1688132212214},{"_id":"themes/hexo-theme-next/source/css/_mixins.styl","hash":"072a3fa473c19b20ccd7536a656cda044dbdae0a","modified":1688132212235},{"_id":"themes/hexo-theme-next/source/css/main.styl","hash":"815ef30987d02f3d76dbe4b5ee3a72135a152678","modified":1688132212244},{"_id":"themes/hexo-theme-next/source/images/apple-touch-icon-next.png","hash":"2959dbc97f31c80283e67104fe0854e2369e40aa","modified":1688132212244},{"_id":"themes/hexo-theme-next/source/images/avatar.gif","hash":"18c53e15eb0c84b139995f9334ed8522b40aeaf6","modified":1688132212245},{"_id":"themes/hexo-theme-next/source/images/cc-by-nc-nd.svg","hash":"bc3588c9b2d7c68830524783120ff6cf957cf668","modified":1688132212245},{"_id":"themes/hexo-theme-next/source/images/cc-by-nc-sa.svg","hash":"6f55543d1fb9cbc436c101d24f802dec7b41efc3","modified":1688132212245},{"_id":"themes/hexo-theme-next/source/images/algolia_logo.svg","hash":"45eeea0b5fba833e21e38ea10ed5ab385ceb4f01","modified":1688132212244},{"_id":"themes/hexo-theme-next/source/images/cc-by-nc.svg","hash":"6f076713fb9bf934aa2c1046bdf2cf2e37bc1eab","modified":1688132212246},{"_id":"themes/hexo-theme-next/source/images/cc-by-nd.svg","hash":"42cd73da328077ccc92f859bb8f3cf621b3484f8","modified":1688132212246},{"_id":"themes/hexo-theme-next/source/images/favicon-16x16-next.png","hash":"943a0d67a9cdf8c198109b28f9dbd42f761d11c3","modified":1688132212247},{"_id":"themes/hexo-theme-next/source/images/cc-by.svg","hash":"e92a33c32d1dac8ed94849b2b4e6456e887efe70","modified":1688132212247},{"_id":"themes/hexo-theme-next/source/images/cc-by-sa.svg","hash":"70c1535f43e54e5ff35ca81419e77e4c0c301398","modified":1688132212246},{"_id":"themes/hexo-theme-next/source/images/cc-zero.svg","hash":"9bfb52b2f63527a7049247bf00d44e6dc1170e7d","modified":1688132212247},{"_id":"themes/hexo-theme-next/source/images/favicon-32x32-next.png","hash":"0749d7b24b0d2fae1c8eb7f671ad4646ee1894b1","modified":1688132212248},{"_id":"themes/hexo-theme-next/source/images/logo.svg","hash":"169f56fd82941591dad3abd734a50ec7259be950","modified":1688132212248},{"_id":"themes/hexo-theme-next/source/js/algolia-search.js","hash":"6a813410e33824d7acc65a369a2983912bb3420c","modified":1688132212249},{"_id":"themes/hexo-theme-next/source/js/bookmark.js","hash":"9f05fd3672789311dc0cf5b37e40dc654cb04a2a","modified":1688132212249},{"_id":"themes/hexo-theme-next/source/js/local-search.js","hash":"cfa6a0f3f9c2bc759ee507668a21f4e8f250f42a","modified":1688132212249},{"_id":"themes/hexo-theme-next/source/js/motion.js","hash":"d5aa1a08cdf3c8d1d8d550fb1801274cc41e5874","modified":1688132212250},{"_id":"themes/hexo-theme-next/source/js/next-boot.js","hash":"250d8dcd6322e69e3fbadd0f3e37081c97b47c52","modified":1688132212250},{"_id":"themes/hexo-theme-next/source/js/utils.js","hash":"26a82e46fdcadc7c3c2c56a7267284b61a26f7f3","modified":1688132212251},{"_id":"themes/hexo-theme-next/source/lib/anime.min.js","hash":"960be51132134acd65c2017cc8a5d69cb419a0cd","modified":1688132212252},{"_id":"themes/hexo-theme-next/layout/_partials/head/head-unique.swig","hash":"7d638e413f2548fc990c4a467dd03de6c81fc960","modified":1688132212183},{"_id":"themes/hexo-theme-next/layout/_partials/head/head.swig","hash":"90cce9f407e9490756ba99580e3eb09f55b05eaa","modified":1688132212183},{"_id":"themes/hexo-theme-next/layout/_partials/header/index.swig","hash":"0dd316f153c492c0a03bd0273d50fa322bc81f11","modified":1688132212184},{"_id":"themes/hexo-theme-next/layout/_partials/header/brand.swig","hash":"91056a6c98cca63ff8cc6956e531ee3faf4b8ad9","modified":1688132212183},{"_id":"themes/hexo-theme-next/layout/_partials/header/menu.swig","hash":"90d3eaba6fbe69bee465ddd67c467fd2c0239dc4","modified":1688132212184},{"_id":"themes/hexo-theme-next/layout/_partials/header/menu-item.swig","hash":"4baa86ca631168fc6388d27f4b1b501b40c877a8","modified":1688132212184},{"_id":"themes/hexo-theme-next/layout/_partials/header/sub-menu.swig","hash":"bed6cc2b48cf2655036ba39c9bae73a295228a4d","modified":1688132212185},{"_id":"themes/hexo-theme-next/layout/_partials/page/breadcrumb.swig","hash":"91c0addb33006619faa4c32e5d66874e25f1e9b3","modified":1688132212185},{"_id":"themes/hexo-theme-next/layout/_partials/page/page-header.swig","hash":"8d4e3dd0d3631ce0b21bc15c259f6ac886de631d","modified":1688132212185},{"_id":"themes/hexo-theme-next/layout/_partials/post/post-copyright.swig","hash":"f2eb455c8bf13533427254f0c9b4b17b2498168b","modified":1688132212186},{"_id":"themes/hexo-theme-next/layout/_partials/post/post-followme.swig","hash":"d8f785c062c6b0763a778bd4a252e6f5fee0e432","modified":1688132212186},{"_id":"themes/hexo-theme-next/layout/_partials/post/post-related.swig","hash":"bc7b047a6246df07767373644b1637d91c3a88b1","modified":1688132212187},{"_id":"themes/hexo-theme-next/layout/_partials/post/post-footer.swig","hash":"ce712c110b5ce8aacba7a86b0558ff89700675c9","modified":1688132212187},{"_id":"themes/hexo-theme-next/layout/_partials/post/post-reward.swig","hash":"f349a226e5370075bb6924e60da8b0170c7cfcc1","modified":1688132212187},{"_id":"themes/hexo-theme-next/layout/_partials/search/index.swig","hash":"a6c761d5193cb6f22e9422dbbcf209e05471b0ed","modified":1688132212188},{"_id":"themes/hexo-theme-next/layout/_partials/search/algolia-search.swig","hash":"98fd1f5df044f4534e1d4ca9ab092ba5761739a9","modified":1688132212188},{"_id":"themes/hexo-theme-next/layout/_partials/search/localsearch.swig","hash":"128f7d679bb4d53b29203d598d217f029a66dee7","modified":1688132212188},{"_id":"themes/hexo-theme-next/layout/_partials/sidebar/site-overview.swig","hash":"7b2ef5db9615267a24b884388925de1e9b447c1f","modified":1688132212189},{"_id":"themes/hexo-theme-next/layout/_third-party/analytics/baidu-analytics.swig","hash":"84adaadd83ce447fa9da2cff19006334c9fcbff9","modified":1688132212193},{"_id":"themes/hexo-theme-next/layout/_third-party/analytics/google-analytics.swig","hash":"b8819bd056f8a580c5556d4415836a906ed5d7a4","modified":1688132212194},{"_id":"themes/hexo-theme-next/layout/_third-party/analytics/growingio.swig","hash":"91c2cb900c76224c5814eeb842d1d5f517f9bf05","modified":1688132212194},{"_id":"themes/hexo-theme-next/layout/_third-party/analytics/index.swig","hash":"85b60e222712ca3b2c4dc2039de2dc36b8d82940","modified":1688132212194},{"_id":"themes/hexo-theme-next/layout/_third-party/chat/chatra.swig","hash":"2642e8aef5afbe23a2a76efdc955dab2ee04ed48","modified":1688132212195},{"_id":"themes/hexo-theme-next/layout/_third-party/chat/tidio.swig","hash":"fb94ee487d75e484e59b7fba96e989f699ff8a83","modified":1688132212195},{"_id":"themes/hexo-theme-next/layout/_third-party/comments/changyan.swig","hash":"9298e6d6c4a62a0862fc0f4060ed99779d7b68cb","modified":1688132212196},{"_id":"themes/hexo-theme-next/layout/_third-party/comments/disqus.swig","hash":"1b29b99fa921f12c25d3dc95facdf84ef7bb1b5c","modified":1688132212196},{"_id":"themes/hexo-theme-next/layout/_third-party/comments/gitalk.swig","hash":"606ad14a29320157df9b8f33738282c51bb393d9","modified":1688132212197},{"_id":"themes/hexo-theme-next/layout/_third-party/comments/disqusjs.swig","hash":"a42f97eda3748583bac2253c47fe5dfa54f07b8f","modified":1688132212196},{"_id":"themes/hexo-theme-next/layout/_third-party/comments/valine.swig","hash":"ae2707d6e47582bb470c075649ec7bad86a6d5a9","modified":1688132212197},{"_id":"themes/hexo-theme-next/layout/_third-party/comments/livere.swig","hash":"3d91899ca079e84d95087b882526d291e6f53918","modified":1688132212197},{"_id":"themes/hexo-theme-next/layout/_third-party/math/index.swig","hash":"59df21fcfe9d0ada8cee3188cb1075529c1c3eb8","modified":1688132212198},{"_id":"themes/hexo-theme-next/layout/_third-party/math/katex.swig","hash":"276f523e414d4aa7f350a8f2fd3df8a3d8ea9656","modified":1688132212198},{"_id":"themes/hexo-theme-next/layout/_third-party/math/mathjax.swig","hash":"1f34b2d3c753a3589ab6c462880bd4eb7df09914","modified":1688132212198},{"_id":"themes/hexo-theme-next/layout/_third-party/search/algolia-search.swig","hash":"fd726aad77a57b288f07d6998ec29291c67c7cbb","modified":1688132212199},{"_id":"themes/hexo-theme-next/layout/_third-party/search/localsearch.swig","hash":"58296a5c1883f26464c2a5ccf734c19f5fbf395a","modified":1688132212199},{"_id":"themes/hexo-theme-next/layout/_third-party/search/swiftype.swig","hash":"aa6ab95b8b76611694613defb4bf25003d1b927f","modified":1688132212200},{"_id":"themes/hexo-theme-next/layout/_third-party/statistics/busuanzi-counter.swig","hash":"d2f0e4c598410ec33785abe302c7ea7492bb791a","modified":1688132212200},{"_id":"themes/hexo-theme-next/layout/_third-party/statistics/cnzz-analytics.swig","hash":"53a0760c75d5aaabb3ce8e8aa8e003510d59807f","modified":1688132212200},{"_id":"themes/hexo-theme-next/layout/_third-party/statistics/firestore.swig","hash":"01d94354d07e72cad47100482068b6be69fcc033","modified":1688132212200},{"_id":"themes/hexo-theme-next/layout/_third-party/statistics/index.swig","hash":"964cd6bac668cf6d211a2624fbef3948cfdece55","modified":1688132212201},{"_id":"themes/hexo-theme-next/layout/_third-party/statistics/lean-analytics.swig","hash":"c171ea94e9afbba97f06856904264da331559463","modified":1688132212201},{"_id":"themes/hexo-theme-next/layout/_third-party/tags/mermaid.swig","hash":"619338ddacf01e3df812e66a997e778f672f4726","modified":1688132212201},{"_id":"themes/hexo-theme-next/layout/_third-party/tags/pdf.swig","hash":"5a223b60406cee7438cfe3a5e41d1284425aa7a5","modified":1688132212201},{"_id":"themes/hexo-theme-next/layout/_scripts/pages/schedule.swig","hash":"34c05e9d73b0f081db70990c296b6d6a0f8ea2ca","modified":1688132212190},{"_id":"themes/hexo-theme-next/layout/_scripts/schemes/gemini.swig","hash":"34495d408e8467555afee489500b8aad98c52079","modified":1688132212191},{"_id":"themes/hexo-theme-next/layout/_scripts/schemes/mist.swig","hash":"0b44f400ec00d2b5add5ee96c11d22465c432376","modified":1688132212192},{"_id":"themes/hexo-theme-next/layout/_scripts/schemes/pisces.swig","hash":"34495d408e8467555afee489500b8aad98c52079","modified":1688132212192},{"_id":"themes/hexo-theme-next/layout/_scripts/schemes/muse.swig","hash":"0b44f400ec00d2b5add5ee96c11d22465c432376","modified":1688132212192},{"_id":"themes/hexo-theme-next/scripts/filters/comment/changyan.js","hash":"2f22f48f7370470cef78561a47c2a47c78035385","modified":1688132212205},{"_id":"themes/hexo-theme-next/scripts/filters/comment/common.js","hash":"713056d33dbcd8e9748205c5680b456c21174f4e","modified":1688132212205},{"_id":"themes/hexo-theme-next/scripts/filters/comment/default-config.js","hash":"0c3bea89d64bc12c1bbe6f208a83773c6fb5375a","modified":1688132212205},{"_id":"themes/hexo-theme-next/scripts/filters/comment/disqus.js","hash":"3a80559df0b670ccb065ea9d3bb587d0b61be3a4","modified":1688132212205},{"_id":"themes/hexo-theme-next/scripts/filters/comment/disqusjs.js","hash":"67cf90d9a2428c14eb113a64bdd213c22a019aef","modified":1688132212205},{"_id":"themes/hexo-theme-next/scripts/filters/comment/gitalk.js","hash":"323a47df6ded894944a2647db44556d6163e67c4","modified":1688132212205},{"_id":"themes/hexo-theme-next/scripts/filters/comment/livere.js","hash":"a4f3153ac76a7ffdf6cc70f52f1b2cc218ed393e","modified":1688132212207},{"_id":"themes/hexo-theme-next/scripts/filters/comment/valine.js","hash":"851359f5ff90f733a9bd7fe677edbee8b8ac714c","modified":1688132212207},{"_id":"themes/hexo-theme-next/scripts/events/lib/config.js","hash":"aefe3b38a22bc155d485e39187f23e4f2ee5680a","modified":1688132212204},{"_id":"themes/hexo-theme-next/scripts/events/lib/injects-point.js","hash":"08496b71c9939718e7955704d219e44d7109247b","modified":1688132212205},{"_id":"themes/hexo-theme-next/scripts/events/lib/injects.js","hash":"e73f697bb160b223fdde783237148be5f41c1d78","modified":1688132212205},{"_id":"themes/hexo-theme-next/source/css/_variables/Gemini.styl","hash":"583ff1e7a2ca889f1f54eb0ca793894466823c7c","modified":1688132212242},{"_id":"themes/hexo-theme-next/source/css/_variables/Mist.styl","hash":"5980abbbbeacd8541121f436fa414d24ad5e97c2","modified":1688132212242},{"_id":"themes/hexo-theme-next/source/css/_variables/Muse.styl","hash":"c22b58af3327236ec54d5706501aa5a20e15012e","modified":1688132212242},{"_id":"themes/hexo-theme-next/source/css/_variables/Pisces.styl","hash":"4e33774b1fe6d0a51f3a428c54c5e600e83bf154","modified":1688132212243},{"_id":"themes/hexo-theme-next/source/css/_variables/base.styl","hash":"ad680efdfb2f86546182bf3f59886efbcf3c1b2d","modified":1688132212243},{"_id":"themes/hexo-theme-next/source/js/schemes/muse.js","hash":"a18559a9c332199efad0100cf84bb0c23fc0f17a","modified":1688132212250},{"_id":"themes/hexo-theme-next/source/lib/velocity/velocity.min.js","hash":"bf172816a9c57f9040e3d19c24e181a142daf92b","modified":1688132212255},{"_id":"themes/hexo-theme-next/source/js/schemes/pisces.js","hash":"b85a6e2af1387fe64b51e7cd3e2da8616e6f5a3f","modified":1688132212251},{"_id":"themes/hexo-theme-next/source/lib/velocity/velocity.ui.min.js","hash":"dde584994ac13dc601836e86f4cf490e418d9723","modified":1688132212256},{"_id":"themes/hexo-theme-next/source/css/_common/components/back-to-top-sidebar.styl","hash":"510a6f0ba7485dd54ce347cca890ab52c4957081","modified":1688132212214},{"_id":"themes/hexo-theme-next/source/css/_common/components/back-to-top.styl","hash":"0534b329d279a6f255112b3305ff92c810f31724","modified":1688132212215},{"_id":"themes/hexo-theme-next/source/css/_common/components/components.styl","hash":"d17236df3b4d6def1e4e81133ef4729c390de3ac","modified":1688132212215},{"_id":"themes/hexo-theme-next/source/css/_common/components/reading-progress.styl","hash":"c52648a7b09f9fe37858f5694fcc1ffc709ad147","modified":1688132212221},{"_id":"themes/hexo-theme-next/source/css/_common/outline/mobile.styl","hash":"a2ee16cac29a82cfce26804c160286fcbee94161","modified":1688132212225},{"_id":"themes/hexo-theme-next/source/css/_common/outline/outline.styl","hash":"7a95c27762e1303bf06ee808c63f616cb192fcaf","modified":1688132212226},{"_id":"themes/hexo-theme-next/source/css/_common/scaffolding/base.styl","hash":"5540c9259cb7895a5f10a289c7937e5470a7c134","modified":1688132212229},{"_id":"themes/hexo-theme-next/source/css/_common/scaffolding/buttons.styl","hash":"45f4badac6ec45cf24355f6157aece1d4d3f1134","modified":1688132212230},{"_id":"themes/hexo-theme-next/source/css/_common/scaffolding/comments.styl","hash":"4b068d0d898f4e624937503f0e1428993050bd65","modified":1688132212230},{"_id":"themes/hexo-theme-next/source/css/_common/scaffolding/normalize.styl","hash":"6d740699fb6a7640647a8fd77c4ea4992d8d6437","modified":1688132212231},{"_id":"themes/hexo-theme-next/source/css/_common/scaffolding/pagination.styl","hash":"b619f39e18398422e0ac4999d8f042a5eaebe9cd","modified":1688132212232},{"_id":"themes/hexo-theme-next/source/css/_common/scaffolding/scaffolding.styl","hash":"43045d115f8fe95732c446aa45bf1c97609ff2a5","modified":1688132212232},{"_id":"themes/hexo-theme-next/source/css/_common/scaffolding/tables.styl","hash":"f317d2e3886e94f5fbb8781c2e68edd19669ff58","modified":1688132212232},{"_id":"themes/hexo-theme-next/source/css/_common/scaffolding/toggles.styl","hash":"20e0e3e3eba384930c022e21511214d244b4c9e7","modified":1688132212235},{"_id":"themes/hexo-theme-next/source/css/_schemes/Gemini/index.styl","hash":"e342b8f8e11a3a6aa5a029912c9778c25bf5d135","modified":1688132212236},{"_id":"themes/hexo-theme-next/source/css/_schemes/Mist/_header.styl","hash":"b9e87d32da24264bda247c1526afe140c858b0ef","modified":1688132212236},{"_id":"themes/hexo-theme-next/source/css/_schemes/Mist/_layout.styl","hash":"12b265f82840f27112ca2b1be497677f20f87545","modified":1688132212236},{"_id":"themes/hexo-theme-next/source/css/_schemes/Mist/_menu.styl","hash":"716e8b0f056bf6393e6bc6969ac84598ab8e7a6f","modified":1688132212237},{"_id":"themes/hexo-theme-next/source/css/_schemes/Mist/_posts-expand.styl","hash":"e1c29b81a32273a0dedd926cda199a71aea72624","modified":1688132212237},{"_id":"themes/hexo-theme-next/source/css/_schemes/Mist/index.styl","hash":"c5142739e01e9f25c8b32b2209af85c787bb2b42","modified":1688132212237},{"_id":"themes/hexo-theme-next/source/css/_schemes/Muse/_header.styl","hash":"8674bd88df076a1dfe4023ed6750ded1f5b00223","modified":1688132212237},{"_id":"themes/hexo-theme-next/source/css/_schemes/Muse/_layout.styl","hash":"49c76bc723d3952abb613d9d68398ed7305da999","modified":1688132212238},{"_id":"themes/hexo-theme-next/source/css/_schemes/Muse/_menu.styl","hash":"4b7f057dbb53efd7cbe7eac7835a793ab3cbb135","modified":1688132212238},{"_id":"themes/hexo-theme-next/source/css/_schemes/Muse/_sidebar.styl","hash":"9898323ee5a7ac2a5d4f633c653112280beb2643","modified":1688132212239},{"_id":"themes/hexo-theme-next/source/css/_schemes/Muse/_sub-menu.styl","hash":"2d3e05015796a790abd9d68957a5c698c0c9f9b6","modified":1688132212239},{"_id":"themes/hexo-theme-next/source/css/_schemes/Muse/index.styl","hash":"25c2a7930da14f023329df20f38df2728057fb4d","modified":1688132212239},{"_id":"themes/hexo-theme-next/source/css/_schemes/Pisces/_header.styl","hash":"558794fced306339b98dc2b0ee7f0576802f1355","modified":1688132212239},{"_id":"themes/hexo-theme-next/source/css/_schemes/Pisces/_layout.styl","hash":"5de34e1d8a290751641ae456c942410852d5e809","modified":1688132212240},{"_id":"themes/hexo-theme-next/source/css/_schemes/Pisces/_menu.styl","hash":"0a9f0d9eb042595502d200fb8c65efb0e6c89aa9","modified":1688132212240},{"_id":"themes/hexo-theme-next/source/css/_schemes/Pisces/_sidebar.styl","hash":"dc9318992ce2eb086ebaa2fe56b325e56d24098b","modified":1688132212241},{"_id":"themes/hexo-theme-next/source/css/_schemes/Pisces/_sub-menu.styl","hash":"b69ac38b9da8c9c1b7de696fdeea7f9d7705213a","modified":1688132212241},{"_id":"themes/hexo-theme-next/source/css/_schemes/Pisces/index.styl","hash":"25c2a7930da14f023329df20f38df2728057fb4d","modified":1688132212241},{"_id":"themes/hexo-theme-next/source/lib/font-awesome/css/all.min.css","hash":"82e34d28f8a1169b20b60101d5bb0446deba3514","modified":1688132212252},{"_id":"themes/hexo-theme-next/source/lib/font-awesome/webfonts/fa-regular-400.woff2","hash":"260bb01acd44d88dcb7f501a238ab968f86bef9e","modified":1688132212253},{"_id":"themes/hexo-theme-next/source/css/_common/components/pages/breadcrumb.styl","hash":"236a039b0900f4267de566b46f62314ad967d30f","modified":1688132212215},{"_id":"themes/hexo-theme-next/source/css/_common/components/pages/tag-cloud.styl","hash":"97974c231b4659b8aa5e9321c4d54db5c816d0db","modified":1688132212217},{"_id":"themes/hexo-theme-next/source/css/_common/components/pages/categories.styl","hash":"18edddb2ffb3f85a68e4367f81e06c461e07bc25","modified":1688132212216},{"_id":"themes/hexo-theme-next/source/css/_common/components/pages/schedule.styl","hash":"f6f05f02d50f742c84ee5122016c0563a8bb2cf9","modified":1688132212216},{"_id":"themes/hexo-theme-next/source/css/_common/components/pages/pages.styl","hash":"6cf78a379bb656cc0abb4ab80fcae60152ce41ad","modified":1688132212216},{"_id":"themes/hexo-theme-next/source/css/_common/components/post/post-collapse.styl","hash":"a52f8cae599099231866298ed831fdf76c9b6717","modified":1688132212217},{"_id":"themes/hexo-theme-next/source/css/_common/components/post/post-copyright.styl","hash":"9af620eba5ccceea21a0e3bc69f6f1fa7637c2f3","modified":1688132212217},{"_id":"themes/hexo-theme-next/source/css/_common/components/post/post-eof.styl","hash":"70b3eb9d36543ab92796ac163544e9cf51b7c1e6","modified":1688132212218},{"_id":"themes/hexo-theme-next/source/css/_common/components/post/post-expand.styl","hash":"97dec98d0403097d66822f1c90b50b2890c84698","modified":1688132212218},{"_id":"themes/hexo-theme-next/source/css/_common/components/post/post-gallery.styl","hash":"0dfb97703a519d9438f64f9e41ab1dd37381f733","modified":1688132212219},{"_id":"themes/hexo-theme-next/source/css/_common/components/post/post-followme.styl","hash":"57b9a179675f1536e017cba457b6ac575e397c4f","modified":1688132212218},{"_id":"themes/hexo-theme-next/source/css/_common/components/post/post-header.styl","hash":"93ba8172c0d2c37d738e6dbd44fcd5a2e23b92f3","modified":1688132212219},{"_id":"themes/hexo-theme-next/source/css/_common/components/post/post-nav.styl","hash":"2c24829d95c742eb9e8316ebf2fbe9f2c168b59a","modified":1688132212219},{"_id":"themes/hexo-theme-next/source/css/_common/components/post/post-reward.styl","hash":"66fc406796b6efe6cea76550573b7a632112406a","modified":1688132212219},{"_id":"themes/hexo-theme-next/source/css/_common/components/post/post-rtl.styl","hash":"09dda2667628d1f91b2e37d8fc6df1413f961b64","modified":1688132212220},{"_id":"themes/hexo-theme-next/source/css/_common/components/post/post-tags.styl","hash":"5cc9e7394c927065c688cba5edd6e0a27587f1d8","modified":1688132212220},{"_id":"themes/hexo-theme-next/source/css/_common/components/post/post-widgets.styl","hash":"b266d2ce5e2b117be01537889e839a69004dc0bb","modified":1688132212220},{"_id":"themes/hexo-theme-next/source/css/_common/components/post/post.styl","hash":"fcd64c23d17775b3635325f6758b648d932e79b5","modified":1688132212221},{"_id":"themes/hexo-theme-next/source/css/_common/components/third-party/gitalk.styl","hash":"b87f4a06c0db893df4f756f24be182e1a4751f24","modified":1688132212222},{"_id":"themes/hexo-theme-next/source/css/_common/components/third-party/related-posts.styl","hash":"8ed7a9d5dfac592de703421b543978095129aa5b","modified":1688132212222},{"_id":"themes/hexo-theme-next/source/css/_common/components/third-party/math.styl","hash":"d83102771df652769e51ddfd041cf5f4ca1a041d","modified":1688132212222},{"_id":"themes/hexo-theme-next/source/css/_common/components/third-party/third-party.styl","hash":"1f6b0d3ab227697ca115e57fd61122ea7950e19d","modified":1688132212223},{"_id":"themes/hexo-theme-next/source/css/_common/components/third-party/search.styl","hash":"bad99f4cccb93b3cefe990a2c85124e60698d32e","modified":1688132212222},{"_id":"themes/hexo-theme-next/source/css/_common/outline/footer/footer.styl","hash":"7eeb22c5696f8e0c95161dc57703973cf81c8c12","modified":1688132212223},{"_id":"themes/hexo-theme-next/source/css/_common/outline/header/bookmark.styl","hash":"b4f4bae437d4f994af93cf142494ffcd86bae46b","modified":1688132212224},{"_id":"themes/hexo-theme-next/source/css/_common/outline/header/github-banner.styl","hash":"b31c86d1a4f89837f9187bed646bda96b2cd286c","modified":1688132212224},{"_id":"themes/hexo-theme-next/source/css/_common/outline/header/header.styl","hash":"300058ca12e81013e77ba01fe66ac210525768b6","modified":1688132212224},{"_id":"themes/hexo-theme-next/source/css/_common/outline/header/menu.styl","hash":"7a3a56b10ab714c0e2ed240d0939deeecdcad167","modified":1688132212225},{"_id":"themes/hexo-theme-next/source/css/_common/outline/header/headerband.styl","hash":"6d5f26646e2914474f295de8bf6dc327d4acd529","modified":1688132212225},{"_id":"themes/hexo-theme-next/source/css/_common/outline/header/site-meta.styl","hash":"3d16ac0f4ccaeed868c246d4d49bde543d1f62cb","modified":1688132212225},{"_id":"themes/hexo-theme-next/source/css/_common/outline/header/site-nav.styl","hash":"b8c816fba0a9b4a35fbae03ba5b1b2da96ba2687","modified":1688132212225},{"_id":"themes/hexo-theme-next/source/css/_common/outline/sidebar/sidebar-author-links.styl","hash":"49722d555a2edb18094bb2cb3d7336dd72051b93","modified":1688132212226},{"_id":"themes/hexo-theme-next/source/css/_common/outline/sidebar/sidebar-author.styl","hash":"357f825f0a649b2e28cba1481d4c9a0cb402e43a","modified":1688132212227},{"_id":"themes/hexo-theme-next/source/css/_common/outline/sidebar/sidebar-blogroll.styl","hash":"096f908c08ce553e482aadfd3e767a0145191093","modified":1688132212227},{"_id":"themes/hexo-theme-next/source/css/_common/outline/sidebar/sidebar-button.styl","hash":"525242ce9e912c4adfe5134347c67dbdb9e98e3d","modified":1688132212227},{"_id":"themes/hexo-theme-next/source/css/_common/outline/sidebar/sidebar-dimmer.styl","hash":"12f7eaf6b56624cbc411528562d6bb848ff97039","modified":1688132212227},{"_id":"themes/hexo-theme-next/source/css/_common/outline/sidebar/sidebar-nav.styl","hash":"b11b04737a1a0fea3bd9f0081d96ee6c015358d4","modified":1688132212228},{"_id":"themes/hexo-theme-next/source/css/_common/outline/sidebar/sidebar-toc.styl","hash":"fa0a2ea57b7b4ce75b5d18c264af2d92ea3192f9","modified":1688132212228},{"_id":"themes/hexo-theme-next/source/css/_common/outline/sidebar/sidebar.styl","hash":"5d540f683018745a5ed1d6f635df28ea610c1244","modified":1688132212229},{"_id":"themes/hexo-theme-next/source/css/_common/outline/sidebar/sidebar-toggle.styl","hash":"098b4bdf49c7300490f959386d5d1185a32543f6","modified":1688132212228},{"_id":"themes/hexo-theme-next/source/css/_common/outline/sidebar/site-state.styl","hash":"67a1fcb33535122d41acd24f1f49cf02c89b88fa","modified":1688132212229},{"_id":"themes/hexo-theme-next/source/css/_common/scaffolding/highlight/copy-code.styl","hash":"4079e616fbf36112dec0674c1e0713d1d9769068","modified":1688132212230},{"_id":"themes/hexo-theme-next/source/css/_common/scaffolding/highlight/highlight.styl","hash":"80488259271bcfe38031f4c2e902463daba9336b","modified":1688132212231},{"_id":"themes/hexo-theme-next/source/css/_common/scaffolding/highlight/diff.styl","hash":"83bd737f663a8461e66985af8ddbfc0a731fc939","modified":1688132212231},{"_id":"themes/hexo-theme-next/source/css/_common/scaffolding/highlight/theme.styl","hash":"c911045b2ce9a66e38d9dd30c7ed078abbc10cbf","modified":1688132212231},{"_id":"themes/hexo-theme-next/source/css/_common/scaffolding/tags/blockquote-center.styl","hash":"ceacfa6218f6084c71a230b086e5d2708d29927e","modified":1688132212233},{"_id":"themes/hexo-theme-next/source/css/_common/scaffolding/tags/group-pictures.styl","hash":"aca7bb220fc14ef2a8f96282d2a95a96a9238d46","modified":1688132212233},{"_id":"themes/hexo-theme-next/source/css/_common/scaffolding/tags/label.styl","hash":"8b7aafb911850c73074cdb6cc87abe4ac8c12e99","modified":1688132212233},{"_id":"themes/hexo-theme-next/source/css/_common/scaffolding/tags/note.styl","hash":"adaf0f580fccf4158169eeaf534a18005b39a760","modified":1688132212234},{"_id":"themes/hexo-theme-next/source/css/_common/scaffolding/tags/tabs.styl","hash":"3256e39f281f06751a1c0145d9806a0e56d68170","modified":1688132212234},{"_id":"themes/hexo-theme-next/source/css/_common/scaffolding/tags/pdf.styl","hash":"03a5bcecc0b12231462ef6ffe432fa77ee71beff","modified":1688132212234},{"_id":"themes/hexo-theme-next/source/css/_common/scaffolding/tags/tags.styl","hash":"51d46fa3c7c6b691c61a2c2b0ac005c97cfbf72b","modified":1688132212235},{"_id":"themes/hexo-theme-next/source/lib/font-awesome/webfonts/fa-brands-400.woff2","hash":"509988477da79c146cb93fb728405f18e923c2de","modified":1688132212253},{"_id":"themes/hexo-theme-next/source/lib/font-awesome/webfonts/fa-solid-900.woff2","hash":"75a88815c47a249eadb5f0edc1675957f860cca7","modified":1688132212255},{"_id":"public/atom.xml","hash":"913380b0050b8f8f7bc9928616047b77be47202c","modified":1688135952206},{"_id":"public/sitemap.xml","hash":"feab669635e1c0835fb1eb29f47c9ed2455043ea","modified":1688135952206},{"_id":"public/archives/index.html","hash":"0cc0950540d3934a19f27838c68f44bcf2ac214d","modified":1688135952206},{"_id":"public/archives/page/2/index.html","hash":"57cbdc3e50378fb49b426d963227adc222e538e5","modified":1688135952206},{"_id":"public/archives/2016/index.html","hash":"5b0161270a84c401e76b082132c4c69dc3683b45","modified":1688135952206},{"_id":"public/archives/2016/12/index.html","hash":"608f36c34b54593a46ab3676a1bb2dc88b1201e1","modified":1688135952206},{"_id":"public/archives/2017/index.html","hash":"1d204be32f7f10d80b06474092ed38b8d70a15fa","modified":1688135952206},{"_id":"public/archives/2017/09/index.html","hash":"44d5266d709f0dd51596ce92952d9112e6fa041e","modified":1688135952206},{"_id":"public/archives/2019/index.html","hash":"f6423128ebf3835589e7ef844ada8a53f2da84c5","modified":1688135952206},{"_id":"public/archives/2019/12/index.html","hash":"4d36a762a5699928bd12e98fc40d407989408dd6","modified":1688135952206},{"_id":"public/archives/2021/index.html","hash":"307b3da416780efd47b38353a8120558a0244f4e","modified":1688135952206},{"_id":"public/archives/2021/07/index.html","hash":"d72f0725ccd0e7b1aab9a8b5e5df41a655c0ae12","modified":1688135952206},{"_id":"public/archives/2022/index.html","hash":"26ff00288085ba0570b4fa955db8d7b2eadba73f","modified":1688135952206},{"_id":"public/archives/2022/02/index.html","hash":"b4a1f1860acb8c16f356b679e780ff0b74f61216","modified":1688135952206},{"_id":"public/archives/2022/04/index.html","hash":"29c5ea5295684196a18872ee7b8c93913c21f67c","modified":1688135952206},{"_id":"public/2022/04/11/traditional-bluetooth-protocol-stack-simple/index.html","hash":"05082e8f8de1814595e0ea94c9284c1009a164fa","modified":1688135952206},{"_id":"public/2022/02/24/thread-block-and-suspend/index.html","hash":"b8118badd16c318978f76a5d7e5ece58b2a5b115","modified":1688135952206},{"_id":"public/2021/07/28/installation-arch-linux-summary/index.html","hash":"279dab84f908e51ec390504d8b087352b7fe2b07","modified":1688135952206},{"_id":"public/2021/07/14/android-dp-and-screen-adaptation/index.html","hash":"b8da40df465dbbe68f50d993ec463667d8d567d6","modified":1688135952206},{"_id":"public/2019/12/23/PyQt5-QWebEngineView与JavaScript交互/index.html","hash":"4b400d31c9dbe31e032869d1f18d08ea8d4af56b","modified":1688135952206},{"_id":"public/2017/09/15/Android-React-Native入门/index.html","hash":"0705833eb95358013dabda28bd06ac6372bc54b4","modified":1688135952206},{"_id":"public/2016/12/19/Android-BLE-Issues/index.html","hash":"4afe7425b7782ad176836a0550941ebcc79f685e","modified":1688135952206},{"_id":"public/index.html","hash":"d4f759f379b618b6f306720cd7cb6caf6e476684","modified":1688135952206},{"_id":"public/CNAME","hash":"6d5c4cefef831ae654f7a52c062e3ee56315470e","modified":1688135952206},{"_id":"public/images/apple-touch-icon.png","hash":"43278e1086f26c171fcf1277b75d8269a6d596cc","modified":1688135952206},{"_id":"public/images/favicon.ico","hash":"f02843df743cf6223f698f865d659dbae7ac9aeb","modified":1688135952206},{"_id":"public/images/favicon-16x16.png","hash":"f5c9f42704d94f3b002af9a46cf01a28615c4bfa","modified":1688135952206},{"_id":"public/images/favicon-32x32.png","hash":"2bde4f0ad4dd13318d6bc7eaf0980388009fd7bb","modified":1688135952206},{"_id":"public/images/apple-touch-icon-next.png","hash":"2959dbc97f31c80283e67104fe0854e2369e40aa","modified":1688135952206},{"_id":"public/images/cc-by-nc-nd.svg","hash":"bc3588c9b2d7c68830524783120ff6cf957cf668","modified":1688135952206},{"_id":"public/images/avatar.gif","hash":"18c53e15eb0c84b139995f9334ed8522b40aeaf6","modified":1688135952206},{"_id":"public/images/cc-by-nc-sa.svg","hash":"6f55543d1fb9cbc436c101d24f802dec7b41efc3","modified":1688135952206},{"_id":"public/images/algolia_logo.svg","hash":"45eeea0b5fba833e21e38ea10ed5ab385ceb4f01","modified":1688135952206},{"_id":"public/images/cc-by-nc.svg","hash":"6f076713fb9bf934aa2c1046bdf2cf2e37bc1eab","modified":1688135952206},{"_id":"public/images/cc-by-nd.svg","hash":"42cd73da328077ccc92f859bb8f3cf621b3484f8","modified":1688135952206},{"_id":"public/images/cc-by.svg","hash":"e92a33c32d1dac8ed94849b2b4e6456e887efe70","modified":1688135952206},{"_id":"public/images/favicon-16x16-next.png","hash":"943a0d67a9cdf8c198109b28f9dbd42f761d11c3","modified":1688135952206},{"_id":"public/images/cc-by-sa.svg","hash":"70c1535f43e54e5ff35ca81419e77e4c0c301398","modified":1688135952206},{"_id":"public/images/cc-zero.svg","hash":"9bfb52b2f63527a7049247bf00d44e6dc1170e7d","modified":1688135952206},{"_id":"public/images/favicon-32x32-next.png","hash":"0749d7b24b0d2fae1c8eb7f671ad4646ee1894b1","modified":1688135952206},{"_id":"public/images/logo.svg","hash":"169f56fd82941591dad3abd734a50ec7259be950","modified":1688135952206},{"_id":"public/lib/font-awesome/webfonts/fa-regular-400.woff2","hash":"260bb01acd44d88dcb7f501a238ab968f86bef9e","modified":1688135952206},{"_id":"public/images/safari-pinned-tab.svg","hash":"6d29e7e95ce617833d99ae24ecc10b859cfaf184","modified":1688135952206},{"_id":"public/lib/font-awesome/webfonts/fa-brands-400.woff2","hash":"509988477da79c146cb93fb728405f18e923c2de","modified":1688135952206},{"_id":"public/lib/font-awesome/webfonts/fa-solid-900.woff2","hash":"75a88815c47a249eadb5f0edc1675957f860cca7","modified":1688135952206},{"_id":"public/js/algolia-search.js","hash":"498d233eb5c7af6940baf94c1a1c36fdf1dd2636","modified":1688135952206},{"_id":"public/js/bookmark.js","hash":"9734ebcb9b83489686f5c2da67dc9e6157e988ad","modified":1688135952206},{"_id":"public/js/local-search.js","hash":"35ccf100d8f9c0fd6bfbb7fa88c2a76c42a69110","modified":1688135952206},{"_id":"public/js/next-boot.js","hash":"a1b0636423009d4a4e4cea97bcbf1842bfab582c","modified":1688135952206},{"_id":"public/js/motion.js","hash":"72df86f6dfa29cce22abeff9d814c9dddfcf13a9","modified":1688135952206},{"_id":"public/js/utils.js","hash":"730cca7f164eaf258661a61ff3f769851ff1e5da","modified":1688135952206},{"_id":"public/js/schemes/muse.js","hash":"1eb9b88103ddcf8827b1a7cbc56471a9c5592d53","modified":1688135952206},{"_id":"public/js/schemes/pisces.js","hash":"0ac5ce155bc58c972fe21c4c447f85e6f8755c62","modified":1688135952206},{"_id":"public/lib/velocity/velocity.ui.min.js","hash":"ed5e534cd680a25d8d14429af824f38a2c7d9908","modified":1688135952206},{"_id":"public/css/main.css","hash":"d6f502d74233cc9c9ef27f1bbfddc0733abbf547","modified":1688135952206},{"_id":"public/lib/anime.min.js","hash":"47cb482a8a488620a793d50ba8f6752324b46af3","modified":1688135952206},{"_id":"public/lib/velocity/velocity.min.js","hash":"2f1afadc12e4cf59ef3b405308d21baa97e739c6","modified":1688135952206},{"_id":"public/lib/font-awesome/css/all.min.css","hash":"0038dc97c79451578b7bd48af60ba62282b4082b","modified":1688135952206},{"_id":"public/images/avatar.jpg","hash":"366173ed33bcc846ce44f668793fb3fc82662216","modified":1688135952206}],"Category":[],"Data":[{"_id":"next","data":{"favicon":{"small":"/images/favicon-16x16.png","medium":"/images/favicon-32x32.png","apple_touch_icon":"/images/apple-touch-icon.png","safari_pinned_tab":"/images/safari_pinned_tab.svg"},"creative_commons":{"license":"by-nc-sa","sidebar":true,"post":true,"language":"deed.zh"},"scheme":"Gemini","darkmode":true,"avatar":{"url":"/images/avatar.jpg","rounded":true,"rotated":false},"social":{"GitHub":"https://github.com/liaoheng || fab fa-github","RSS":"/atom.xml || fa fa-rss"},"social_icons":{"enable":true,"icons_only":true,"transition":true},"codeblock":{"highlight_theme":"normal","copy_button":{"enable":true,"show_result":true,"style":null}},"github_banner":{"enable":true,"permalink":"https://github.com/liaoheng","title":"Follow me on GitHub"},"google_analytics":{"tracking_id":"G-64FL8LWFL8","only_pageview":false},"vendors":{"pace":"//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js","pace_css":"//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css"},"pace":{"enable":true,"theme":"minimal"}}}],"Page":[],"Post":[{"title":"Android BLE Issues(问题集)","date":"2016-12-19T14:08:00.000Z","_content":">新进入公司做智能家居设备，于是查寻了一下Android BLE的问题，这是比较全面的一片文章，简单翻译一下。\n\n>原文链接:http://www.slideshare.net/yeokm1/introduction-to-bluetooth-low-energy\n\n## Android issues (the past) `BLE支持之前的问题`\n>http://stackoverflow.com/questions/14118658/devices-with-android-4-2-jelly-bean-supported-bluetooth-low-energy-ble\n\n- Before Android 4.3 (July 2013) `Android 4.3在2013年七月之前`\n  - Fragmentation hell `痛苦的碎片化`\n  - Proprietary Libraries by OEMs, Android <= 4.2 `各大OEM厂商提供的私有库`\n    - Samsung (quite reliable)\n    - HTC – buggy, unreliable\n    - Motorola (reliable but conflicts with Android 4.3)\n  - Architecture issues `架构上的问题`\n- Testing issues `其它问题`\n\n\n## Android issues (today) `BLE支持之后的问题`\n>http://stackoverflow.com/questions/17870189/android-4-3-bluetooth-low-energy-unstable\n\n1. OS fragmentation\n - 74.2% of Android devices support BLE `只有74.2%的设备支持`\n - <font color=\"#D32627\">Few support peripheral mode: 35.3% minus Nexus 4, 5, 7 (2012/2013)</font> `只有35.3%支持手机作为外围设备，只有5.0以上才支持。`\n\n2. All callbacks from BLE APIs are not on UI thread. `所有的回调不是在UI线程`\n\n3. APIs considered new, some functions are buggy `考虑使用新的API的话会有一些bug`\n\n4. Frequent connection drops (< 5.0) `5.0之前频繁连接会导致连接无法使用`\n> 参考：https://code.google.com/p/android/issues/detail?id=180440\n\n5. Max BLE connections: `最大连接数`\n - Software cap in Bluedroid code: BTA_GATTC_CONN_MAX, GATT_MAX_PHY_CHANNEL\n - Android 4.3: 4\n - 4.4 - 5.0+: 7\n\n6. No API callback to indicate scanning has stopped `没有提供startLeScan()扫描结束的回调`\n - Scan supposed to be indefinite by API specification, but some phones stop scan after some time `API规范与实际扫描结果并不相符，并且一些手机停止扫描需要的时间比较长。`\n > 比如有一些手机会一直回调设备，直到设备连接成功，而有一些设备(Samsung...)只回调一次\n\n - Known offender: Samsung `比如著名的三星`\n - Solution: Restart scan at regular intervals `解决方法：扫描定时`\n\n7. Different scan return result behaviours (See further reading) `扫描的结果并不相同`\n - Some phones filter advertisement results, some phones do not. (usually on 4.3 and 4.4)`有一些设备会过滤掉广告结果`\n\n8. Bugs on (Samsung) phones at least < 5.0 `三星5.0之前bug`\n - Scan using service UUID filtering does not work -> no results returned `使用startLeScan()过滤UUID无法工作，没有返回结果`\n - connectGatt() must be called from UI thread`connectGatt()必须在UI线程中调用`\n\n9. Slow LE initial discovery and connection time `初始化查找与连接设备相当缓慢`\n - HTC seems to have this issue`HTC好像有这个问题`\n > 华为，三星也会，其他没有测试过\n\n9. A high-level view on issues collated by Anaren `一些高层view问题的整理`\n - https://atmosphere.anaren.com/wiki/Android_Issues_With_Bluetooth_Low_Energy\n\n10. A more comprehensive list of issues has been collated by iDevicesInc `全面问题清单`\n - https://github.com/iDevicesInc/SweetBlue/wiki/Android-BLE-Issues\n - May be able to overcome using: https://github.com/iDevicesInc/SweetBlue `或许可以使用这个库`\n\n> 个人推荐使用基于RxJava的库:https://github.com/Polidea/RxAndroidBle","source":"_posts/Android-BLE-Issues.md","raw":"---\ntitle: Android BLE Issues(问题集)\ntags:\ndate: 2016-12-19 22:08:00\n---\n>新进入公司做智能家居设备，于是查寻了一下Android BLE的问题，这是比较全面的一片文章，简单翻译一下。\n\n>原文链接:http://www.slideshare.net/yeokm1/introduction-to-bluetooth-low-energy\n\n## Android issues (the past) `BLE支持之前的问题`\n>http://stackoverflow.com/questions/14118658/devices-with-android-4-2-jelly-bean-supported-bluetooth-low-energy-ble\n\n- Before Android 4.3 (July 2013) `Android 4.3在2013年七月之前`\n  - Fragmentation hell `痛苦的碎片化`\n  - Proprietary Libraries by OEMs, Android <= 4.2 `各大OEM厂商提供的私有库`\n    - Samsung (quite reliable)\n    - HTC – buggy, unreliable\n    - Motorola (reliable but conflicts with Android 4.3)\n  - Architecture issues `架构上的问题`\n- Testing issues `其它问题`\n\n\n## Android issues (today) `BLE支持之后的问题`\n>http://stackoverflow.com/questions/17870189/android-4-3-bluetooth-low-energy-unstable\n\n1. OS fragmentation\n - 74.2% of Android devices support BLE `只有74.2%的设备支持`\n - <font color=\"#D32627\">Few support peripheral mode: 35.3% minus Nexus 4, 5, 7 (2012/2013)</font> `只有35.3%支持手机作为外围设备，只有5.0以上才支持。`\n\n2. All callbacks from BLE APIs are not on UI thread. `所有的回调不是在UI线程`\n\n3. APIs considered new, some functions are buggy `考虑使用新的API的话会有一些bug`\n\n4. Frequent connection drops (< 5.0) `5.0之前频繁连接会导致连接无法使用`\n> 参考：https://code.google.com/p/android/issues/detail?id=180440\n\n5. Max BLE connections: `最大连接数`\n - Software cap in Bluedroid code: BTA_GATTC_CONN_MAX, GATT_MAX_PHY_CHANNEL\n - Android 4.3: 4\n - 4.4 - 5.0+: 7\n\n6. No API callback to indicate scanning has stopped `没有提供startLeScan()扫描结束的回调`\n - Scan supposed to be indefinite by API specification, but some phones stop scan after some time `API规范与实际扫描结果并不相符，并且一些手机停止扫描需要的时间比较长。`\n > 比如有一些手机会一直回调设备，直到设备连接成功，而有一些设备(Samsung...)只回调一次\n\n - Known offender: Samsung `比如著名的三星`\n - Solution: Restart scan at regular intervals `解决方法：扫描定时`\n\n7. Different scan return result behaviours (See further reading) `扫描的结果并不相同`\n - Some phones filter advertisement results, some phones do not. (usually on 4.3 and 4.4)`有一些设备会过滤掉广告结果`\n\n8. Bugs on (Samsung) phones at least < 5.0 `三星5.0之前bug`\n - Scan using service UUID filtering does not work -> no results returned `使用startLeScan()过滤UUID无法工作，没有返回结果`\n - connectGatt() must be called from UI thread`connectGatt()必须在UI线程中调用`\n\n9. Slow LE initial discovery and connection time `初始化查找与连接设备相当缓慢`\n - HTC seems to have this issue`HTC好像有这个问题`\n > 华为，三星也会，其他没有测试过\n\n9. A high-level view on issues collated by Anaren `一些高层view问题的整理`\n - https://atmosphere.anaren.com/wiki/Android_Issues_With_Bluetooth_Low_Energy\n\n10. A more comprehensive list of issues has been collated by iDevicesInc `全面问题清单`\n - https://github.com/iDevicesInc/SweetBlue/wiki/Android-BLE-Issues\n - May be able to overcome using: https://github.com/iDevicesInc/SweetBlue `或许可以使用这个库`\n\n> 个人推荐使用基于RxJava的库:https://github.com/Polidea/RxAndroidBle","slug":"Android-BLE-Issues","published":1,"updated":"2023-06-30T13:34:34.848Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cljiok5gh0000t0iz0dkz3m57","content":"<blockquote>\n<p>新进入公司做智能家居设备，于是查寻了一下Android BLE的问题，这是比较全面的一片文章，简单翻译一下。</p>\n</blockquote>\n<blockquote>\n<p>原文链接:<a href=\"http://www.slideshare.net/yeokm1/introduction-to-bluetooth-low-energy\">http://www.slideshare.net/yeokm1/introduction-to-bluetooth-low-energy</a></p>\n</blockquote>\n<h2 id=\"Android-issues-the-past-BLE支持之前的问题\"><a href=\"#Android-issues-the-past-BLE支持之前的问题\" class=\"headerlink\" title=\"Android issues (the past) BLE支持之前的问题\"></a>Android issues (the past) <code>BLE支持之前的问题</code></h2><blockquote>\n<p><a href=\"http://stackoverflow.com/questions/14118658/devices-with-android-4-2-jelly-bean-supported-bluetooth-low-energy-ble\">http://stackoverflow.com/questions/14118658/devices-with-android-4-2-jelly-bean-supported-bluetooth-low-energy-ble</a></p>\n</blockquote>\n<ul>\n<li>Before Android 4.3 (July 2013) <code>Android 4.3在2013年七月之前</code><ul>\n<li>Fragmentation hell <code>痛苦的碎片化</code></li>\n<li>Proprietary Libraries by OEMs, Android &lt;&#x3D; 4.2 <code>各大OEM厂商提供的私有库</code><ul>\n<li>Samsung (quite reliable)</li>\n<li>HTC – buggy, unreliable</li>\n<li>Motorola (reliable but conflicts with Android 4.3)</li>\n</ul>\n</li>\n<li>Architecture issues <code>架构上的问题</code></li>\n</ul>\n</li>\n<li>Testing issues <code>其它问题</code></li>\n</ul>\n<h2 id=\"Android-issues-today-BLE支持之后的问题\"><a href=\"#Android-issues-today-BLE支持之后的问题\" class=\"headerlink\" title=\"Android issues (today) BLE支持之后的问题\"></a>Android issues (today) <code>BLE支持之后的问题</code></h2><blockquote>\n<p><a href=\"http://stackoverflow.com/questions/17870189/android-4-3-bluetooth-low-energy-unstable\">http://stackoverflow.com/questions/17870189/android-4-3-bluetooth-low-energy-unstable</a></p>\n</blockquote>\n<ol>\n<li>OS fragmentation</li>\n</ol>\n<ul>\n<li>74.2% of Android devices support BLE <code>只有74.2%的设备支持</code></li>\n<li><font color=\"#D32627\">Few support peripheral mode: 35.3% minus Nexus 4, 5, 7 (2012&#x2F;2013)</font> <code>只有35.3%支持手机作为外围设备，只有5.0以上才支持。</code></li>\n</ul>\n<ol start=\"2\">\n<li><p>All callbacks from BLE APIs are not on UI thread. <code>所有的回调不是在UI线程</code></p>\n</li>\n<li><p>APIs considered new, some functions are buggy <code>考虑使用新的API的话会有一些bug</code></p>\n</li>\n<li><p>Frequent connection drops (&lt; 5.0) <code>5.0之前频繁连接会导致连接无法使用</code></p>\n<blockquote>\n<p>参考：<a href=\"https://code.google.com/p/android/issues/detail?id=180440\">https://code.google.com/p/android/issues/detail?id=180440</a></p>\n</blockquote>\n</li>\n<li><p>Max BLE connections: <code>最大连接数</code></p>\n</li>\n</ol>\n<ul>\n<li>Software cap in Bluedroid code: BTA_GATTC_CONN_MAX, GATT_MAX_PHY_CHANNEL</li>\n<li>Android 4.3: 4</li>\n<li>4.4 - 5.0+: 7</li>\n</ul>\n<ol start=\"6\">\n<li>No API callback to indicate scanning has stopped <code>没有提供startLeScan()扫描结束的回调</code></li>\n</ol>\n<ul>\n<li><p>Scan supposed to be indefinite by API specification, but some phones stop scan after some time <code>API规范与实际扫描结果并不相符，并且一些手机停止扫描需要的时间比较长。</code></p>\n<blockquote>\n<p>比如有一些手机会一直回调设备，直到设备连接成功，而有一些设备(Samsung…)只回调一次</p>\n</blockquote>\n</li>\n<li><p>Known offender: Samsung <code>比如著名的三星</code></p>\n</li>\n<li><p>Solution: Restart scan at regular intervals <code>解决方法：扫描定时</code></p>\n</li>\n</ul>\n<ol start=\"7\">\n<li>Different scan return result behaviours (See further reading) <code>扫描的结果并不相同</code></li>\n</ol>\n<ul>\n<li>Some phones filter advertisement results, some phones do not. (usually on 4.3 and 4.4)<code>有一些设备会过滤掉广告结果</code></li>\n</ul>\n<ol start=\"8\">\n<li>Bugs on (Samsung) phones at least &lt; 5.0 <code>三星5.0之前bug</code></li>\n</ol>\n<ul>\n<li>Scan using service UUID filtering does not work -&gt; no results returned <code>使用startLeScan()过滤UUID无法工作，没有返回结果</code></li>\n<li>connectGatt() must be called from UI thread<code>connectGatt()必须在UI线程中调用</code></li>\n</ul>\n<ol start=\"9\">\n<li>Slow LE initial discovery and connection time <code>初始化查找与连接设备相当缓慢</code></li>\n</ol>\n<ul>\n<li>HTC seems to have this issue<code>HTC好像有这个问题</code><blockquote>\n<p>华为，三星也会，其他没有测试过</p>\n</blockquote>\n</li>\n</ul>\n<ol start=\"9\">\n<li>A high-level view on issues collated by Anaren <code>一些高层view问题的整理</code></li>\n</ol>\n<ul>\n<li><a href=\"https://atmosphere.anaren.com/wiki/Android_Issues_With_Bluetooth_Low_Energy\">https://atmosphere.anaren.com/wiki/Android_Issues_With_Bluetooth_Low_Energy</a></li>\n</ul>\n<ol start=\"10\">\n<li>A more comprehensive list of issues has been collated by iDevicesInc <code>全面问题清单</code></li>\n</ol>\n<ul>\n<li><a href=\"https://github.com/iDevicesInc/SweetBlue/wiki/Android-BLE-Issues\">https://github.com/iDevicesInc/SweetBlue/wiki/Android-BLE-Issues</a></li>\n<li>May be able to overcome using: <a href=\"https://github.com/iDevicesInc/SweetBlue\">https://github.com/iDevicesInc/SweetBlue</a> <code>或许可以使用这个库</code></li>\n</ul>\n<blockquote>\n<p>个人推荐使用基于RxJava的库:<a href=\"https://github.com/Polidea/RxAndroidBle\">https://github.com/Polidea/RxAndroidBle</a></p>\n</blockquote>\n","site":{"data":{"next":{"favicon":{"small":"/images/favicon-16x16.png","medium":"/images/favicon-32x32.png","apple_touch_icon":"/images/apple-touch-icon.png","safari_pinned_tab":"/images/safari_pinned_tab.svg"},"creative_commons":{"license":"by-nc-sa","sidebar":true,"post":true,"language":"deed.zh"},"scheme":"Gemini","darkmode":true,"avatar":{"url":"/images/avatar.jpg","rounded":true,"rotated":false},"social":{"GitHub":"https://github.com/liaoheng || fab fa-github","RSS":"/atom.xml || fa fa-rss"},"social_icons":{"enable":true,"icons_only":true,"transition":true},"codeblock":{"highlight_theme":"normal","copy_button":{"enable":true,"show_result":true,"style":null}},"github_banner":{"enable":true,"permalink":"https://github.com/liaoheng","title":"Follow me on GitHub"},"google_analytics":{"tracking_id":"G-64FL8LWFL8","only_pageview":false},"vendors":{"pace":"//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js","pace_css":"//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css"},"pace":{"enable":true,"theme":"minimal"}}}},"excerpt":"","more":"<blockquote>\n<p>新进入公司做智能家居设备，于是查寻了一下Android BLE的问题，这是比较全面的一片文章，简单翻译一下。</p>\n</blockquote>\n<blockquote>\n<p>原文链接:<a href=\"http://www.slideshare.net/yeokm1/introduction-to-bluetooth-low-energy\">http://www.slideshare.net/yeokm1/introduction-to-bluetooth-low-energy</a></p>\n</blockquote>\n<h2 id=\"Android-issues-the-past-BLE支持之前的问题\"><a href=\"#Android-issues-the-past-BLE支持之前的问题\" class=\"headerlink\" title=\"Android issues (the past) BLE支持之前的问题\"></a>Android issues (the past) <code>BLE支持之前的问题</code></h2><blockquote>\n<p><a href=\"http://stackoverflow.com/questions/14118658/devices-with-android-4-2-jelly-bean-supported-bluetooth-low-energy-ble\">http://stackoverflow.com/questions/14118658/devices-with-android-4-2-jelly-bean-supported-bluetooth-low-energy-ble</a></p>\n</blockquote>\n<ul>\n<li>Before Android 4.3 (July 2013) <code>Android 4.3在2013年七月之前</code><ul>\n<li>Fragmentation hell <code>痛苦的碎片化</code></li>\n<li>Proprietary Libraries by OEMs, Android &lt;&#x3D; 4.2 <code>各大OEM厂商提供的私有库</code><ul>\n<li>Samsung (quite reliable)</li>\n<li>HTC – buggy, unreliable</li>\n<li>Motorola (reliable but conflicts with Android 4.3)</li>\n</ul>\n</li>\n<li>Architecture issues <code>架构上的问题</code></li>\n</ul>\n</li>\n<li>Testing issues <code>其它问题</code></li>\n</ul>\n<h2 id=\"Android-issues-today-BLE支持之后的问题\"><a href=\"#Android-issues-today-BLE支持之后的问题\" class=\"headerlink\" title=\"Android issues (today) BLE支持之后的问题\"></a>Android issues (today) <code>BLE支持之后的问题</code></h2><blockquote>\n<p><a href=\"http://stackoverflow.com/questions/17870189/android-4-3-bluetooth-low-energy-unstable\">http://stackoverflow.com/questions/17870189/android-4-3-bluetooth-low-energy-unstable</a></p>\n</blockquote>\n<ol>\n<li>OS fragmentation</li>\n</ol>\n<ul>\n<li>74.2% of Android devices support BLE <code>只有74.2%的设备支持</code></li>\n<li><font color=\"#D32627\">Few support peripheral mode: 35.3% minus Nexus 4, 5, 7 (2012&#x2F;2013)</font> <code>只有35.3%支持手机作为外围设备，只有5.0以上才支持。</code></li>\n</ul>\n<ol start=\"2\">\n<li><p>All callbacks from BLE APIs are not on UI thread. <code>所有的回调不是在UI线程</code></p>\n</li>\n<li><p>APIs considered new, some functions are buggy <code>考虑使用新的API的话会有一些bug</code></p>\n</li>\n<li><p>Frequent connection drops (&lt; 5.0) <code>5.0之前频繁连接会导致连接无法使用</code></p>\n<blockquote>\n<p>参考：<a href=\"https://code.google.com/p/android/issues/detail?id=180440\">https://code.google.com/p/android/issues/detail?id=180440</a></p>\n</blockquote>\n</li>\n<li><p>Max BLE connections: <code>最大连接数</code></p>\n</li>\n</ol>\n<ul>\n<li>Software cap in Bluedroid code: BTA_GATTC_CONN_MAX, GATT_MAX_PHY_CHANNEL</li>\n<li>Android 4.3: 4</li>\n<li>4.4 - 5.0+: 7</li>\n</ul>\n<ol start=\"6\">\n<li>No API callback to indicate scanning has stopped <code>没有提供startLeScan()扫描结束的回调</code></li>\n</ol>\n<ul>\n<li><p>Scan supposed to be indefinite by API specification, but some phones stop scan after some time <code>API规范与实际扫描结果并不相符，并且一些手机停止扫描需要的时间比较长。</code></p>\n<blockquote>\n<p>比如有一些手机会一直回调设备，直到设备连接成功，而有一些设备(Samsung…)只回调一次</p>\n</blockquote>\n</li>\n<li><p>Known offender: Samsung <code>比如著名的三星</code></p>\n</li>\n<li><p>Solution: Restart scan at regular intervals <code>解决方法：扫描定时</code></p>\n</li>\n</ul>\n<ol start=\"7\">\n<li>Different scan return result behaviours (See further reading) <code>扫描的结果并不相同</code></li>\n</ol>\n<ul>\n<li>Some phones filter advertisement results, some phones do not. (usually on 4.3 and 4.4)<code>有一些设备会过滤掉广告结果</code></li>\n</ul>\n<ol start=\"8\">\n<li>Bugs on (Samsung) phones at least &lt; 5.0 <code>三星5.0之前bug</code></li>\n</ol>\n<ul>\n<li>Scan using service UUID filtering does not work -&gt; no results returned <code>使用startLeScan()过滤UUID无法工作，没有返回结果</code></li>\n<li>connectGatt() must be called from UI thread<code>connectGatt()必须在UI线程中调用</code></li>\n</ul>\n<ol start=\"9\">\n<li>Slow LE initial discovery and connection time <code>初始化查找与连接设备相当缓慢</code></li>\n</ol>\n<ul>\n<li>HTC seems to have this issue<code>HTC好像有这个问题</code><blockquote>\n<p>华为，三星也会，其他没有测试过</p>\n</blockquote>\n</li>\n</ul>\n<ol start=\"9\">\n<li>A high-level view on issues collated by Anaren <code>一些高层view问题的整理</code></li>\n</ol>\n<ul>\n<li><a href=\"https://atmosphere.anaren.com/wiki/Android_Issues_With_Bluetooth_Low_Energy\">https://atmosphere.anaren.com/wiki/Android_Issues_With_Bluetooth_Low_Energy</a></li>\n</ul>\n<ol start=\"10\">\n<li>A more comprehensive list of issues has been collated by iDevicesInc <code>全面问题清单</code></li>\n</ol>\n<ul>\n<li><a href=\"https://github.com/iDevicesInc/SweetBlue/wiki/Android-BLE-Issues\">https://github.com/iDevicesInc/SweetBlue/wiki/Android-BLE-Issues</a></li>\n<li>May be able to overcome using: <a href=\"https://github.com/iDevicesInc/SweetBlue\">https://github.com/iDevicesInc/SweetBlue</a> <code>或许可以使用这个库</code></li>\n</ul>\n<blockquote>\n<p>个人推荐使用基于RxJava的库:<a href=\"https://github.com/Polidea/RxAndroidBle\">https://github.com/Polidea/RxAndroidBle</a></p>\n</blockquote>\n"},{"title":"PyQt5中QWebEngineView与JavaScript交互","date":"2019-12-23T09:16:38.000Z","_content":"\n### 准备工作\n\n#### 开发环境\n\n- Python 3.8.1\n- Windows 10\n\n#### 安装依赖\n\n```shell\npip install PyQt5\npip install PyQtWebEngine\n```\n\n### Python端\n\n1. 使用`QWebChannel`的`registerObject（\"JsBridge名\",\"JsBridge\"）`方法注册回调\n\n   - `JsBridge名`：在JavaScript中调用时使用的对象名称\n   - `JsBridge`：被JavaScript调用的Python对象\n\n2. `JsBridge` 对象\n\n   - 入参\n\n    ```python\n    @QtCore.pyqtSlot(str)\n    def log(self, message):\n        print(message)\n    ```\n\n   - 出参\n\n    ```python\n    @QtCore.pyqtSlot(result=str)\n    def getName(self):\n        return \"hello\"\n    ```\n\n   - 出入参\n\n    ```python\n    @QtCore.pyqtSlot(str, result=str)\n    def test(self, message):\n        print(message)\n        return \"ok\"\n    ```\n\n### JavaScript端\n\n1. 在Html的`<head>`中添加\n\n    ```html\n    <script src='qrc:///qtwebchannel/qwebchannel.js'></script>\n    ```\n\n2. 调用\n\n   ```javascript\n   new QWebChannel(qt.webChannelTransport, function(channel) {\n        channel.objects.pythonBridge.test(\"hello\",function(arg) {\n            console.log(\"Python message: \" + arg);\n            alert(arg);\n        });\n    });\n   ```\n\n3. 调试(Chrome DevTools)\n   1. 配置环境变量：`QTWEBENGINE_REMOTE_DEBUGGING = port`\n   2. 使用Chromium内核的浏览器打开地址：`http://127.0.0.1:port`\n   3. 使用`PyCharm`中可以在运行配置(Run/Debug Configurations)中的Environment variables中添加环境变量,用`;`号分隔，然后可以直接运行。\n\n### Demo\n\n#### Python\n\n1. **JsBridge**\n\n   ```python\n   from PyQt5 import QtCore\n\n   class JsBridge(QtCore.QObject):\n       @QtCore.pyqtSlot(str, result=str)\n       def test(self, message):\n           print(message)\n           return \"ok\"\n   ```\n\n2. ##### Application\n\n   ```python\n   from PyQt5 import QtCore\n   from PyQt5 import QtWebEngineWidgets\n   from PyQt5.QtCore import QDir\n   from PyQt5.QtWebChannel import QWebChannel\n   from PyQt5.QtWebEngineWidgets import QWebEngineView\n   from PyQt5.QtWidgets import *\n   \n   class TestWindow(QMainWindow):\n       def __init__(self):\n           super().__init__()\n           self.webView = QWebEngineView()\n           self.webView.settings().setAttribute(\n               QtWebEngineWidgets.QWebEngineSettings.JavascriptEnabled, True)\n   \n           channel = QWebChannel(self.webView.page())\n           self.webView.page().setWebChannel(channel)\n           self.python_bridge = JsBridge(None)\n           channel.registerObject(\"pythonBridge\", self.python_bridge)\n           layout = QVBoxLayout()\n           layout.addWidget(self.webView)\n           widget = QWidget()\n           widget.setLayout(layout)\n           self.setCentralWidget(widget)\n   \n           self.resize(900, 600)\n           self.setWindowTitle('Test')\n           qr = self.frameGeometry()\n           cp = QDesktopWidget().availableGeometry().center()\n           qr.moveCenter(cp)\n           self.move(qr.topLeft())\n           self.show()\n           html_path = QtCore.QUrl.fromLocalFile(QDir.currentPath() + \"/assets/index.html\")\n           self.webView.load(html_path)\n   \n   if __name__ == '__main__':\n       app = QApplication(sys.argv)\n       m = TestWindow()\n       sys.exit(app.exec_())\n   ```\n\n#### JavaScript\n\n> ##### index.html\n\n```html\n<!DOCTYPE html>\n<html lang=\"zh\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no\">\n    <title>Test</title>\n    <script src='qrc:///qtwebchannel/qwebchannel.js'></script>\n    <script src=\"https://code.jquery.com/jquery-3.4.1.min.js\"\n            integrity=\"sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=\"\n            crossorigin=\"anonymous\"></script>\n</head>\n<body>\n   <button id=\"test\">test</button>\n</body>\n<script>\n    $(document).ready(function() {\n        new QWebChannel(qt.webChannelTransport, function(channel) {\n            $('#test').on('click', function() {\n                channel.objects.pythonBridge.test(\"hello\",function(arg) {\n                  console.log(\"Python message: \" + arg);\n                  alert(arg);\n                });\n            });\n        });\n    });\n</script>\n</html>\n```","source":"_posts/PyQt5-QWebEngineView与JavaScript交互.md","raw":"---\ntitle: PyQt5中QWebEngineView与JavaScript交互\ndate: 2019-12-23 17:16:38\ntags:\n---\n\n### 准备工作\n\n#### 开发环境\n\n- Python 3.8.1\n- Windows 10\n\n#### 安装依赖\n\n```shell\npip install PyQt5\npip install PyQtWebEngine\n```\n\n### Python端\n\n1. 使用`QWebChannel`的`registerObject（\"JsBridge名\",\"JsBridge\"）`方法注册回调\n\n   - `JsBridge名`：在JavaScript中调用时使用的对象名称\n   - `JsBridge`：被JavaScript调用的Python对象\n\n2. `JsBridge` 对象\n\n   - 入参\n\n    ```python\n    @QtCore.pyqtSlot(str)\n    def log(self, message):\n        print(message)\n    ```\n\n   - 出参\n\n    ```python\n    @QtCore.pyqtSlot(result=str)\n    def getName(self):\n        return \"hello\"\n    ```\n\n   - 出入参\n\n    ```python\n    @QtCore.pyqtSlot(str, result=str)\n    def test(self, message):\n        print(message)\n        return \"ok\"\n    ```\n\n### JavaScript端\n\n1. 在Html的`<head>`中添加\n\n    ```html\n    <script src='qrc:///qtwebchannel/qwebchannel.js'></script>\n    ```\n\n2. 调用\n\n   ```javascript\n   new QWebChannel(qt.webChannelTransport, function(channel) {\n        channel.objects.pythonBridge.test(\"hello\",function(arg) {\n            console.log(\"Python message: \" + arg);\n            alert(arg);\n        });\n    });\n   ```\n\n3. 调试(Chrome DevTools)\n   1. 配置环境变量：`QTWEBENGINE_REMOTE_DEBUGGING = port`\n   2. 使用Chromium内核的浏览器打开地址：`http://127.0.0.1:port`\n   3. 使用`PyCharm`中可以在运行配置(Run/Debug Configurations)中的Environment variables中添加环境变量,用`;`号分隔，然后可以直接运行。\n\n### Demo\n\n#### Python\n\n1. **JsBridge**\n\n   ```python\n   from PyQt5 import QtCore\n\n   class JsBridge(QtCore.QObject):\n       @QtCore.pyqtSlot(str, result=str)\n       def test(self, message):\n           print(message)\n           return \"ok\"\n   ```\n\n2. ##### Application\n\n   ```python\n   from PyQt5 import QtCore\n   from PyQt5 import QtWebEngineWidgets\n   from PyQt5.QtCore import QDir\n   from PyQt5.QtWebChannel import QWebChannel\n   from PyQt5.QtWebEngineWidgets import QWebEngineView\n   from PyQt5.QtWidgets import *\n   \n   class TestWindow(QMainWindow):\n       def __init__(self):\n           super().__init__()\n           self.webView = QWebEngineView()\n           self.webView.settings().setAttribute(\n               QtWebEngineWidgets.QWebEngineSettings.JavascriptEnabled, True)\n   \n           channel = QWebChannel(self.webView.page())\n           self.webView.page().setWebChannel(channel)\n           self.python_bridge = JsBridge(None)\n           channel.registerObject(\"pythonBridge\", self.python_bridge)\n           layout = QVBoxLayout()\n           layout.addWidget(self.webView)\n           widget = QWidget()\n           widget.setLayout(layout)\n           self.setCentralWidget(widget)\n   \n           self.resize(900, 600)\n           self.setWindowTitle('Test')\n           qr = self.frameGeometry()\n           cp = QDesktopWidget().availableGeometry().center()\n           qr.moveCenter(cp)\n           self.move(qr.topLeft())\n           self.show()\n           html_path = QtCore.QUrl.fromLocalFile(QDir.currentPath() + \"/assets/index.html\")\n           self.webView.load(html_path)\n   \n   if __name__ == '__main__':\n       app = QApplication(sys.argv)\n       m = TestWindow()\n       sys.exit(app.exec_())\n   ```\n\n#### JavaScript\n\n> ##### index.html\n\n```html\n<!DOCTYPE html>\n<html lang=\"zh\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no\">\n    <title>Test</title>\n    <script src='qrc:///qtwebchannel/qwebchannel.js'></script>\n    <script src=\"https://code.jquery.com/jquery-3.4.1.min.js\"\n            integrity=\"sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=\"\n            crossorigin=\"anonymous\"></script>\n</head>\n<body>\n   <button id=\"test\">test</button>\n</body>\n<script>\n    $(document).ready(function() {\n        new QWebChannel(qt.webChannelTransport, function(channel) {\n            $('#test').on('click', function() {\n                channel.objects.pythonBridge.test(\"hello\",function(arg) {\n                  console.log(\"Python message: \" + arg);\n                  alert(arg);\n                });\n            });\n        });\n    });\n</script>\n</html>\n```","slug":"PyQt5-QWebEngineView与JavaScript交互","published":1,"updated":"2023-06-30T13:34:34.848Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cljiok5gm0001t0iz4mqg0u97","content":"<h3 id=\"准备工作\"><a href=\"#准备工作\" class=\"headerlink\" title=\"准备工作\"></a>准备工作</h3><h4 id=\"开发环境\"><a href=\"#开发环境\" class=\"headerlink\" title=\"开发环境\"></a>开发环境</h4><ul>\n<li>Python 3.8.1</li>\n<li>Windows 10</li>\n</ul>\n<h4 id=\"安装依赖\"><a href=\"#安装依赖\" class=\"headerlink\" title=\"安装依赖\"></a>安装依赖</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install PyQt5</span><br><span class=\"line\">pip install PyQtWebEngine</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Python端\"><a href=\"#Python端\" class=\"headerlink\" title=\"Python端\"></a>Python端</h3><ol>\n<li><p>使用<code>QWebChannel</code>的<code>registerObject（&quot;JsBridge名&quot;,&quot;JsBridge&quot;）</code>方法注册回调</p>\n<ul>\n<li><code>JsBridge名</code>：在JavaScript中调用时使用的对象名称</li>\n<li><code>JsBridge</code>：被JavaScript调用的Python对象</li>\n</ul>\n</li>\n<li><p><code>JsBridge</code> 对象</p>\n<ul>\n<li>入参</li>\n</ul>\n <figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@QtCore.pyqtSlot(<span class=\"params\"><span class=\"built_in\">str</span></span>)</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">log</span>(<span class=\"params\">self, message</span>):</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(message)</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>出参</li>\n</ul>\n <figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@QtCore.pyqtSlot(<span class=\"params\">result=<span class=\"built_in\">str</span></span>)</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">getName</span>(<span class=\"params\">self</span>):</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">&quot;hello&quot;</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>出入参</li>\n</ul>\n <figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@QtCore.pyqtSlot(<span class=\"params\"><span class=\"built_in\">str</span>, result=<span class=\"built_in\">str</span></span>)</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">test</span>(<span class=\"params\">self, message</span>):</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(message)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">&quot;ok&quot;</span></span><br></pre></td></tr></table></figure></li>\n</ol>\n<h3 id=\"JavaScript端\"><a href=\"#JavaScript端\" class=\"headerlink\" title=\"JavaScript端\"></a>JavaScript端</h3><ol>\n<li><p>在Html的<code>&lt;head&gt;</code>中添加</p>\n <figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">src</span>=<span class=\"string\">&#x27;qrc:///qtwebchannel/qwebchannel.js&#x27;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>调用</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">new</span> <span class=\"title class_\">QWebChannel</span>(qt.<span class=\"property\">webChannelTransport</span>, <span class=\"keyword\">function</span>(<span class=\"params\">channel</span>) &#123;</span><br><span class=\"line\">     channel.<span class=\"property\">objects</span>.<span class=\"property\">pythonBridge</span>.<span class=\"title function_\">test</span>(<span class=\"string\">&quot;hello&quot;</span>,<span class=\"keyword\">function</span>(<span class=\"params\">arg</span>) &#123;</span><br><span class=\"line\">         <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&quot;Python message: &quot;</span> + arg);</span><br><span class=\"line\">         <span class=\"title function_\">alert</span>(arg);</span><br><span class=\"line\">     &#125;);</span><br><span class=\"line\"> &#125;);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>调试(Chrome DevTools)</p>\n<ol>\n<li>配置环境变量：<code>QTWEBENGINE_REMOTE_DEBUGGING = port</code></li>\n<li>使用Chromium内核的浏览器打开地址：<code>http://127.0.0.1:port</code></li>\n<li>使用<code>PyCharm</code>中可以在运行配置(Run&#x2F;Debug Configurations)中的Environment variables中添加环境变量,用<code>;</code>号分隔，然后可以直接运行。</li>\n</ol>\n</li>\n</ol>\n<h3 id=\"Demo\"><a href=\"#Demo\" class=\"headerlink\" title=\"Demo\"></a>Demo</h3><h4 id=\"Python\"><a href=\"#Python\" class=\"headerlink\" title=\"Python\"></a>Python</h4><ol>\n<li><p><strong>JsBridge</strong></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> PyQt5 <span class=\"keyword\">import</span> QtCore</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">JsBridge</span>(QtCore.QObject):</span><br><span class=\"line\"><span class=\"meta\">    @QtCore.pyqtSlot(<span class=\"params\"><span class=\"built_in\">str</span>, result=<span class=\"built_in\">str</span></span>)</span></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">test</span>(<span class=\"params\">self, message</span>):</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(message)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;ok&quot;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><h5 id=\"Application\"><a href=\"#Application\" class=\"headerlink\" title=\"Application\"></a>Application</h5><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> PyQt5 <span class=\"keyword\">import</span> QtCore</span><br><span class=\"line\"><span class=\"keyword\">from</span> PyQt5 <span class=\"keyword\">import</span> QtWebEngineWidgets</span><br><span class=\"line\"><span class=\"keyword\">from</span> PyQt5.QtCore <span class=\"keyword\">import</span> QDir</span><br><span class=\"line\"><span class=\"keyword\">from</span> PyQt5.QtWebChannel <span class=\"keyword\">import</span> QWebChannel</span><br><span class=\"line\"><span class=\"keyword\">from</span> PyQt5.QtWebEngineWidgets <span class=\"keyword\">import</span> QWebEngineView</span><br><span class=\"line\"><span class=\"keyword\">from</span> PyQt5.QtWidgets <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">TestWindow</span>(<span class=\"title class_ inherited__\">QMainWindow</span>):</span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__init__</span>(<span class=\"params\">self</span>):</span><br><span class=\"line\">        <span class=\"built_in\">super</span>().__init__()</span><br><span class=\"line\">        self.webView = QWebEngineView()</span><br><span class=\"line\">        self.webView.settings().setAttribute(</span><br><span class=\"line\">            QtWebEngineWidgets.QWebEngineSettings.JavascriptEnabled, <span class=\"literal\">True</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">        channel = QWebChannel(self.webView.page())</span><br><span class=\"line\">        self.webView.page().setWebChannel(channel)</span><br><span class=\"line\">        self.python_bridge = JsBridge(<span class=\"literal\">None</span>)</span><br><span class=\"line\">        channel.registerObject(<span class=\"string\">&quot;pythonBridge&quot;</span>, self.python_bridge)</span><br><span class=\"line\">        layout = QVBoxLayout()</span><br><span class=\"line\">        layout.addWidget(self.webView)</span><br><span class=\"line\">        widget = QWidget()</span><br><span class=\"line\">        widget.setLayout(layout)</span><br><span class=\"line\">        self.setCentralWidget(widget)</span><br><span class=\"line\"></span><br><span class=\"line\">        self.resize(<span class=\"number\">900</span>, <span class=\"number\">600</span>)</span><br><span class=\"line\">        self.setWindowTitle(<span class=\"string\">&#x27;Test&#x27;</span>)</span><br><span class=\"line\">        qr = self.frameGeometry()</span><br><span class=\"line\">        cp = QDesktopWidget().availableGeometry().center()</span><br><span class=\"line\">        qr.moveCenter(cp)</span><br><span class=\"line\">        self.move(qr.topLeft())</span><br><span class=\"line\">        self.show()</span><br><span class=\"line\">        html_path = QtCore.QUrl.fromLocalFile(QDir.currentPath() + <span class=\"string\">&quot;/assets/index.html&quot;</span>)</span><br><span class=\"line\">        self.webView.load(html_path)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">    app = QApplication(sys.argv)</span><br><span class=\"line\">    m = TestWindow()</span><br><span class=\"line\">    sys.exit(app.exec_())</span><br></pre></td></tr></table></figure></li>\n</ol>\n<h4 id=\"JavaScript\"><a href=\"#JavaScript\" class=\"headerlink\" title=\"JavaScript\"></a>JavaScript</h4><blockquote>\n<h5 id=\"index-html\"><a href=\"#index-html\" class=\"headerlink\" title=\"index.html\"></a>index.html</h5></blockquote>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span> <span class=\"attr\">lang</span>=<span class=\"string\">&quot;zh&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">charset</span>=<span class=\"string\">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;viewport&quot;</span> <span class=\"attr\">content</span>=<span class=\"string\">&quot;width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>Test<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">src</span>=<span class=\"string\">&#x27;qrc:///qtwebchannel/qwebchannel.js&#x27;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;https://code.jquery.com/jquery-3.4.1.min.js&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">integrity</span>=<span class=\"string\">&quot;sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">crossorigin</span>=<span class=\"string\">&quot;anonymous&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">button</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;test&quot;</span>&gt;</span>test<span class=\"tag\">&lt;/<span class=\"name\">button</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    $(<span class=\"variable language_\">document</span>).<span class=\"title function_\">ready</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"keyword\">new</span> <span class=\"title class_\">QWebChannel</span>(qt.<span class=\"property\">webChannelTransport</span>, <span class=\"keyword\">function</span>(<span class=\"params\">channel</span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">            $(<span class=\"string\">&#x27;#test&#x27;</span>).<span class=\"title function_\">on</span>(<span class=\"string\">&#x27;click&#x27;</span>, <span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">                channel.<span class=\"property\">objects</span>.<span class=\"property\">pythonBridge</span>.<span class=\"title function_\">test</span>(<span class=\"string\">&quot;hello&quot;</span>,<span class=\"keyword\">function</span>(<span class=\"params\">arg</span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">                  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&quot;Python message: &quot;</span> + arg);</span></span><br><span class=\"line\"><span class=\"language-javascript\">                  <span class=\"title function_\">alert</span>(arg);</span></span><br><span class=\"line\"><span class=\"language-javascript\">                &#125;);</span></span><br><span class=\"line\"><span class=\"language-javascript\">            &#125;);</span></span><br><span class=\"line\"><span class=\"language-javascript\">        &#125;);</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;);</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>","site":{"data":{"next":{"favicon":{"small":"/images/favicon-16x16.png","medium":"/images/favicon-32x32.png","apple_touch_icon":"/images/apple-touch-icon.png","safari_pinned_tab":"/images/safari_pinned_tab.svg"},"creative_commons":{"license":"by-nc-sa","sidebar":true,"post":true,"language":"deed.zh"},"scheme":"Gemini","darkmode":true,"avatar":{"url":"/images/avatar.jpg","rounded":true,"rotated":false},"social":{"GitHub":"https://github.com/liaoheng || fab fa-github","RSS":"/atom.xml || fa fa-rss"},"social_icons":{"enable":true,"icons_only":true,"transition":true},"codeblock":{"highlight_theme":"normal","copy_button":{"enable":true,"show_result":true,"style":null}},"github_banner":{"enable":true,"permalink":"https://github.com/liaoheng","title":"Follow me on GitHub"},"google_analytics":{"tracking_id":"G-64FL8LWFL8","only_pageview":false},"vendors":{"pace":"//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js","pace_css":"//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css"},"pace":{"enable":true,"theme":"minimal"}}}},"excerpt":"","more":"<h3 id=\"准备工作\"><a href=\"#准备工作\" class=\"headerlink\" title=\"准备工作\"></a>准备工作</h3><h4 id=\"开发环境\"><a href=\"#开发环境\" class=\"headerlink\" title=\"开发环境\"></a>开发环境</h4><ul>\n<li>Python 3.8.1</li>\n<li>Windows 10</li>\n</ul>\n<h4 id=\"安装依赖\"><a href=\"#安装依赖\" class=\"headerlink\" title=\"安装依赖\"></a>安装依赖</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install PyQt5</span><br><span class=\"line\">pip install PyQtWebEngine</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Python端\"><a href=\"#Python端\" class=\"headerlink\" title=\"Python端\"></a>Python端</h3><ol>\n<li><p>使用<code>QWebChannel</code>的<code>registerObject（&quot;JsBridge名&quot;,&quot;JsBridge&quot;）</code>方法注册回调</p>\n<ul>\n<li><code>JsBridge名</code>：在JavaScript中调用时使用的对象名称</li>\n<li><code>JsBridge</code>：被JavaScript调用的Python对象</li>\n</ul>\n</li>\n<li><p><code>JsBridge</code> 对象</p>\n<ul>\n<li>入参</li>\n</ul>\n <figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@QtCore.pyqtSlot(<span class=\"params\"><span class=\"built_in\">str</span></span>)</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">log</span>(<span class=\"params\">self, message</span>):</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(message)</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>出参</li>\n</ul>\n <figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@QtCore.pyqtSlot(<span class=\"params\">result=<span class=\"built_in\">str</span></span>)</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">getName</span>(<span class=\"params\">self</span>):</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">&quot;hello&quot;</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>出入参</li>\n</ul>\n <figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@QtCore.pyqtSlot(<span class=\"params\"><span class=\"built_in\">str</span>, result=<span class=\"built_in\">str</span></span>)</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">test</span>(<span class=\"params\">self, message</span>):</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(message)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">&quot;ok&quot;</span></span><br></pre></td></tr></table></figure></li>\n</ol>\n<h3 id=\"JavaScript端\"><a href=\"#JavaScript端\" class=\"headerlink\" title=\"JavaScript端\"></a>JavaScript端</h3><ol>\n<li><p>在Html的<code>&lt;head&gt;</code>中添加</p>\n <figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">src</span>=<span class=\"string\">&#x27;qrc:///qtwebchannel/qwebchannel.js&#x27;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>调用</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">new</span> <span class=\"title class_\">QWebChannel</span>(qt.<span class=\"property\">webChannelTransport</span>, <span class=\"keyword\">function</span>(<span class=\"params\">channel</span>) &#123;</span><br><span class=\"line\">     channel.<span class=\"property\">objects</span>.<span class=\"property\">pythonBridge</span>.<span class=\"title function_\">test</span>(<span class=\"string\">&quot;hello&quot;</span>,<span class=\"keyword\">function</span>(<span class=\"params\">arg</span>) &#123;</span><br><span class=\"line\">         <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&quot;Python message: &quot;</span> + arg);</span><br><span class=\"line\">         <span class=\"title function_\">alert</span>(arg);</span><br><span class=\"line\">     &#125;);</span><br><span class=\"line\"> &#125;);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>调试(Chrome DevTools)</p>\n<ol>\n<li>配置环境变量：<code>QTWEBENGINE_REMOTE_DEBUGGING = port</code></li>\n<li>使用Chromium内核的浏览器打开地址：<code>http://127.0.0.1:port</code></li>\n<li>使用<code>PyCharm</code>中可以在运行配置(Run&#x2F;Debug Configurations)中的Environment variables中添加环境变量,用<code>;</code>号分隔，然后可以直接运行。</li>\n</ol>\n</li>\n</ol>\n<h3 id=\"Demo\"><a href=\"#Demo\" class=\"headerlink\" title=\"Demo\"></a>Demo</h3><h4 id=\"Python\"><a href=\"#Python\" class=\"headerlink\" title=\"Python\"></a>Python</h4><ol>\n<li><p><strong>JsBridge</strong></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> PyQt5 <span class=\"keyword\">import</span> QtCore</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">JsBridge</span>(QtCore.QObject):</span><br><span class=\"line\"><span class=\"meta\">    @QtCore.pyqtSlot(<span class=\"params\"><span class=\"built_in\">str</span>, result=<span class=\"built_in\">str</span></span>)</span></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">test</span>(<span class=\"params\">self, message</span>):</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(message)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;ok&quot;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><h5 id=\"Application\"><a href=\"#Application\" class=\"headerlink\" title=\"Application\"></a>Application</h5><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> PyQt5 <span class=\"keyword\">import</span> QtCore</span><br><span class=\"line\"><span class=\"keyword\">from</span> PyQt5 <span class=\"keyword\">import</span> QtWebEngineWidgets</span><br><span class=\"line\"><span class=\"keyword\">from</span> PyQt5.QtCore <span class=\"keyword\">import</span> QDir</span><br><span class=\"line\"><span class=\"keyword\">from</span> PyQt5.QtWebChannel <span class=\"keyword\">import</span> QWebChannel</span><br><span class=\"line\"><span class=\"keyword\">from</span> PyQt5.QtWebEngineWidgets <span class=\"keyword\">import</span> QWebEngineView</span><br><span class=\"line\"><span class=\"keyword\">from</span> PyQt5.QtWidgets <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">TestWindow</span>(<span class=\"title class_ inherited__\">QMainWindow</span>):</span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__init__</span>(<span class=\"params\">self</span>):</span><br><span class=\"line\">        <span class=\"built_in\">super</span>().__init__()</span><br><span class=\"line\">        self.webView = QWebEngineView()</span><br><span class=\"line\">        self.webView.settings().setAttribute(</span><br><span class=\"line\">            QtWebEngineWidgets.QWebEngineSettings.JavascriptEnabled, <span class=\"literal\">True</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">        channel = QWebChannel(self.webView.page())</span><br><span class=\"line\">        self.webView.page().setWebChannel(channel)</span><br><span class=\"line\">        self.python_bridge = JsBridge(<span class=\"literal\">None</span>)</span><br><span class=\"line\">        channel.registerObject(<span class=\"string\">&quot;pythonBridge&quot;</span>, self.python_bridge)</span><br><span class=\"line\">        layout = QVBoxLayout()</span><br><span class=\"line\">        layout.addWidget(self.webView)</span><br><span class=\"line\">        widget = QWidget()</span><br><span class=\"line\">        widget.setLayout(layout)</span><br><span class=\"line\">        self.setCentralWidget(widget)</span><br><span class=\"line\"></span><br><span class=\"line\">        self.resize(<span class=\"number\">900</span>, <span class=\"number\">600</span>)</span><br><span class=\"line\">        self.setWindowTitle(<span class=\"string\">&#x27;Test&#x27;</span>)</span><br><span class=\"line\">        qr = self.frameGeometry()</span><br><span class=\"line\">        cp = QDesktopWidget().availableGeometry().center()</span><br><span class=\"line\">        qr.moveCenter(cp)</span><br><span class=\"line\">        self.move(qr.topLeft())</span><br><span class=\"line\">        self.show()</span><br><span class=\"line\">        html_path = QtCore.QUrl.fromLocalFile(QDir.currentPath() + <span class=\"string\">&quot;/assets/index.html&quot;</span>)</span><br><span class=\"line\">        self.webView.load(html_path)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">    app = QApplication(sys.argv)</span><br><span class=\"line\">    m = TestWindow()</span><br><span class=\"line\">    sys.exit(app.exec_())</span><br></pre></td></tr></table></figure></li>\n</ol>\n<h4 id=\"JavaScript\"><a href=\"#JavaScript\" class=\"headerlink\" title=\"JavaScript\"></a>JavaScript</h4><blockquote>\n<h5 id=\"index-html\"><a href=\"#index-html\" class=\"headerlink\" title=\"index.html\"></a>index.html</h5></blockquote>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span> <span class=\"attr\">lang</span>=<span class=\"string\">&quot;zh&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">charset</span>=<span class=\"string\">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;viewport&quot;</span> <span class=\"attr\">content</span>=<span class=\"string\">&quot;width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>Test<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">src</span>=<span class=\"string\">&#x27;qrc:///qtwebchannel/qwebchannel.js&#x27;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;https://code.jquery.com/jquery-3.4.1.min.js&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">integrity</span>=<span class=\"string\">&quot;sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">crossorigin</span>=<span class=\"string\">&quot;anonymous&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">button</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;test&quot;</span>&gt;</span>test<span class=\"tag\">&lt;/<span class=\"name\">button</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    $(<span class=\"variable language_\">document</span>).<span class=\"title function_\">ready</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"keyword\">new</span> <span class=\"title class_\">QWebChannel</span>(qt.<span class=\"property\">webChannelTransport</span>, <span class=\"keyword\">function</span>(<span class=\"params\">channel</span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">            $(<span class=\"string\">&#x27;#test&#x27;</span>).<span class=\"title function_\">on</span>(<span class=\"string\">&#x27;click&#x27;</span>, <span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">                channel.<span class=\"property\">objects</span>.<span class=\"property\">pythonBridge</span>.<span class=\"title function_\">test</span>(<span class=\"string\">&quot;hello&quot;</span>,<span class=\"keyword\">function</span>(<span class=\"params\">arg</span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">                  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&quot;Python message: &quot;</span> + arg);</span></span><br><span class=\"line\"><span class=\"language-javascript\">                  <span class=\"title function_\">alert</span>(arg);</span></span><br><span class=\"line\"><span class=\"language-javascript\">                &#125;);</span></span><br><span class=\"line\"><span class=\"language-javascript\">            &#125;);</span></span><br><span class=\"line\"><span class=\"language-javascript\">        &#125;);</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;);</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>"},{"title":"Android React Native入门","date":"2017-09-15T09:34:00.000Z","_content":"> 本文需要了解基本Android开发知识\n\n## 环境\n\n1. [JDK](http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html)\n2. [Node](https://nodejs.org/en/download/)\n3. [Watchman 可选](https://facebook.github.io/watchman/docs/install.html#build-install) `Windows问题比较多，不推荐安装`\n4. [Android SDK](https://developer.android.com/studio/index.html)`配置环境`\n\n### 配置\n1. 项目结构，创建相应文件\n\n > ├── android\n > ├── index.js\n > ├── node_modules\n > ├── package.json\n\n2. 编辑`package.json`文件添加：\n\n  ```json\n\t{\n\t  \"name\": \"[项目名]\",\n\t  \"version\": \"0.0.1\",\n\t  \"private\": true,\n\t  \"scripts\": {\n\t\t\"start\": \"node node_modules/react-native/local-cli/cli.js start\",\n\t\t\"test\": \"jest\"\n\t  },\n\t  \"dependencies\": {\n\t\t\"react\": \"16.3.1\",\n\t\t\"react-native\": \"0.55.1\",\n\t\t\"react-navigation\": \"1.5.2\"\n\t  },\n\t  \"devDependencies\": {\n\t\t\"babel-jest\": \"22.4.3\",\n\t\t\"babel-preset-react-native\": \"4.0.0\",\n\t\t\"jest\": \"22.4.3\",\n\t\t\"react-test-renderer\": \"16.3.1\"\n\t  },\n\t  \"jest\": {\n\t\t\"preset\": \"react-native\"\n\t  }\n\t}\n  ```\n\n  > 也可以使用命令创建官方的HelloWorld项目，然后拷贝相关配置文件，如下：\n\n  > ```shell\n  > npm install -g create-react-native-app\n  > create-react-native-app AwesomeProject\n  > ```\n\n3. 安装nodejs库，在根目录中执行命令：\n\n  ```shell\n  npm install\n  npm install -g react-native-cli\n  ```\n\n4. 编辑`index.js`文件添加：\n\n  ```javascript\n  import React, { Component } from 'react';\n  import {\n  AppRegistry,\n  StyleSheet,\n  Text,\n  View\n  } from 'react-native';\n\n  export default class Launch extends Component {\n   render() {\n     return (\n       <View style={styles.container}>\n        <Text style={styles.welcome}>\n          Welcome to React Native!\n        </Text>\n        <Text style={styles.instructions}>\n          To get started, edit index.js\n        </Text>\n        <Text style={styles.instructions}>\n          Double tap R on your keyboard to reload,{'\\n'}\n          Shake or press menu button for dev menu\n        </Text>\n       </View>\n     );\n   }\n  }\n\n  const styles = StyleSheet.create({\n   container: {\n    flex: 1,\n    justifyContent: 'center',\n    alignItems: 'center',\n    backgroundColor: '#F5FCFF',\n   },\n   welcome: {\n    fontSize: 20,\n    textAlign: 'center',\n    margin: 10,\n  },\n  instructions: {\n    textAlign: 'center',\n    color: '#333333',\n    marginBottom: 5,\n  },\n  });\n\n  AppRegistry.registerComponent('ReactTest', () => Launch);\n  ```\n\n5. 在`android目录`中创建app工程项目，然后在项目中集成React Native\n\n  - [可选] 在`settings.gradle`文件中添加：\n\n    ```properties\n    rootProject.name = '[项目名]'\n    ```\n\n  - 在`gradle.properties`文件中添加：\n\n    ```properties\n    android.useDeprecatedNdk=true\n    ```\n\n  - 在根目录`build.gradle`文件中添加：\n\n    ```groovy\n    allprojects {\n       repositories {\n          maven {\n            url \"$rootDir/../node_modules/react-native/android\"\n          }\n       }\n     }\n    ```\n\n  - 在app目录`build.gradle`文件中添加：\n\n    ```groovy\n\tapply from: \"../../node_modules/react-native/react.gradle\"\n    android {\n    defaultConfig {\n       ndk {\n           abiFilters \"armeabi-v7a\", \"x86\"\n       }\n    }\n    splits {\n        abi {\n           reset()\n           enable false\n           universalApk false  // If true, also generate a universal APK\n           include \"armeabi-v7a\", \"x86\"\n         }\n      }\n    }\n    dependencies {\n      compile \"com.facebook.react:react-native:+\"\n    }\n    ```\n\n  - 在app项目中创建`MApplication.java`\n\n    ```java\n    public class MApplication extends Application implements ReactApplication{\n\n        private final ReactNativeHost mReactNativeHost = new ReactNativeHost(this){\n\n\t\t\t@Override\n\t\t\tpublic boolean getUseDeveloperSupport() {\n\t\t\t\treturn BuildConfig.DEBUG;\n\t\t\t}\n\n\t\t\t@Override\n\t\t\tprotected List<ReactPackage> getPackages() {\n\t\t\t\treturn Arrays.<ReactPackage>asList(new MainReactPackage());\n\t\t\t}\n\n\t\t\t@Override\n\t\t\tprotected String getJSMainModuleName() {\n\t\t\t\treturn \"index\";\n\t\t\t}\n\t\t};\n\n\t\t@Override\n\t\tpublic ReactNativeHost getReactNativeHost() {\n\t\t\treturn mReactNativeHost;\n\t\t}\n    }\n    ```\n\n  - 在app项目中创建`MainActivity.java`\n\n    ```java\n    public class MainActivity extends ReactActivity {\n\n     @Nullable\n     @Override\n     protected String getMainComponentName() {\n        return \"ReactTest\";//与index.js中registerComponent对应\n     }\n    }\n    ```\n\n  - 修改app项目中`AndroidManifest.xml`文件\n\n    ```xml\n    <application\n        android:name=\".MApplication\">\n           <activity android:name=\".MainActivity\">\n              <intent-filter>\n                 <action android:name=\"android.intent.action.MAIN\" />\n\n                 <category android:name=\"android.intent.category.LAUNCHER\" />\n              </intent-filter>\n           </activity>\n           <activity android:name=\"com.facebook.react.devsupport.DevSettingsActivity\" />\n    </application>\n    ```\n\n### 运行\n\n1. 通过命令行直接运行`开发服务`和app:\n\n  ```shell\n  react-native run-android\n  ```\n\n  > 如果使用Windows系统请使用方法1，方法2会在运行app时出现异常：`java.io.IOException: Could not delete path`\n\n2. 通过命令运行`开发服务`，然后手动运行app\n\n  ```shell\n  npm start\n  #也可使用： react-native start\n  ```\n\n  `开发服务`正常启动后如下，使用中不能关闭（如果安装Watchman，`开发服务`会在后台运行可以关闭当前窗口）：\n\n  ```shell\n   \\> ReactTest@0.0.1 start x:\\xxxx\\React\n   \\> node node_modules/react-native/local-cli/cli.js start\n   \n   Scanning 564 folders for symlinks in x:\\xxxx\\React\\node_modules (43ms)\n   ┌────────────────────────────────────────────────────────────────────────────  ┐\n   │  Running packager on port 8081.                                              │\n   │                                                                              │\n   │  Keep this packager running while developing on any JS projects. Feel        │\n   │  free to close this tab and run your own packager instance if you            │\n   │  prefer.                                                                    │\n   │                                                                              │\n   │  https://github.com/facebook/react-native                                    │\n   │                                                                              │\n   └────────────────────────────────────────────────────────────────────────────┘\n   Looking for JS files in\n       X:\\xxxx\\React\n       \n   React packager ready.\n   \n   Loading dependency graph, done.\n   ```\n\n### 提示\n- 默认在根目录中执行以上命令\n- 出现手机或虚拟机无法连接电脑时可使用`adb reverse tcp:8081 tcp:8081`\n- debug模式默认使用8081端口,如果本地以被占用，通过`react-native start --port 9988`修改端口。\n- 注意需要权限：`<uses-permission android:name=\"android.permission.INTERNET\" />`\n- 参考：\n  - http://facebook.github.io/react-native/docs/integration-with-existing-apps.html\n  - http://facebook.github.io/react-native/docs/getting-started.html\n\n### Demo:[ReactTest](https://github.com/liaoheng/ReactTest)","source":"_posts/Android-React-Native入门.md","raw":"---\ntitle: Android React Native入门\ntags:\ndate: 2017-09-15 17:34:00\n---\n> 本文需要了解基本Android开发知识\n\n## 环境\n\n1. [JDK](http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html)\n2. [Node](https://nodejs.org/en/download/)\n3. [Watchman 可选](https://facebook.github.io/watchman/docs/install.html#build-install) `Windows问题比较多，不推荐安装`\n4. [Android SDK](https://developer.android.com/studio/index.html)`配置环境`\n\n### 配置\n1. 项目结构，创建相应文件\n\n > ├── android\n > ├── index.js\n > ├── node_modules\n > ├── package.json\n\n2. 编辑`package.json`文件添加：\n\n  ```json\n\t{\n\t  \"name\": \"[项目名]\",\n\t  \"version\": \"0.0.1\",\n\t  \"private\": true,\n\t  \"scripts\": {\n\t\t\"start\": \"node node_modules/react-native/local-cli/cli.js start\",\n\t\t\"test\": \"jest\"\n\t  },\n\t  \"dependencies\": {\n\t\t\"react\": \"16.3.1\",\n\t\t\"react-native\": \"0.55.1\",\n\t\t\"react-navigation\": \"1.5.2\"\n\t  },\n\t  \"devDependencies\": {\n\t\t\"babel-jest\": \"22.4.3\",\n\t\t\"babel-preset-react-native\": \"4.0.0\",\n\t\t\"jest\": \"22.4.3\",\n\t\t\"react-test-renderer\": \"16.3.1\"\n\t  },\n\t  \"jest\": {\n\t\t\"preset\": \"react-native\"\n\t  }\n\t}\n  ```\n\n  > 也可以使用命令创建官方的HelloWorld项目，然后拷贝相关配置文件，如下：\n\n  > ```shell\n  > npm install -g create-react-native-app\n  > create-react-native-app AwesomeProject\n  > ```\n\n3. 安装nodejs库，在根目录中执行命令：\n\n  ```shell\n  npm install\n  npm install -g react-native-cli\n  ```\n\n4. 编辑`index.js`文件添加：\n\n  ```javascript\n  import React, { Component } from 'react';\n  import {\n  AppRegistry,\n  StyleSheet,\n  Text,\n  View\n  } from 'react-native';\n\n  export default class Launch extends Component {\n   render() {\n     return (\n       <View style={styles.container}>\n        <Text style={styles.welcome}>\n          Welcome to React Native!\n        </Text>\n        <Text style={styles.instructions}>\n          To get started, edit index.js\n        </Text>\n        <Text style={styles.instructions}>\n          Double tap R on your keyboard to reload,{'\\n'}\n          Shake or press menu button for dev menu\n        </Text>\n       </View>\n     );\n   }\n  }\n\n  const styles = StyleSheet.create({\n   container: {\n    flex: 1,\n    justifyContent: 'center',\n    alignItems: 'center',\n    backgroundColor: '#F5FCFF',\n   },\n   welcome: {\n    fontSize: 20,\n    textAlign: 'center',\n    margin: 10,\n  },\n  instructions: {\n    textAlign: 'center',\n    color: '#333333',\n    marginBottom: 5,\n  },\n  });\n\n  AppRegistry.registerComponent('ReactTest', () => Launch);\n  ```\n\n5. 在`android目录`中创建app工程项目，然后在项目中集成React Native\n\n  - [可选] 在`settings.gradle`文件中添加：\n\n    ```properties\n    rootProject.name = '[项目名]'\n    ```\n\n  - 在`gradle.properties`文件中添加：\n\n    ```properties\n    android.useDeprecatedNdk=true\n    ```\n\n  - 在根目录`build.gradle`文件中添加：\n\n    ```groovy\n    allprojects {\n       repositories {\n          maven {\n            url \"$rootDir/../node_modules/react-native/android\"\n          }\n       }\n     }\n    ```\n\n  - 在app目录`build.gradle`文件中添加：\n\n    ```groovy\n\tapply from: \"../../node_modules/react-native/react.gradle\"\n    android {\n    defaultConfig {\n       ndk {\n           abiFilters \"armeabi-v7a\", \"x86\"\n       }\n    }\n    splits {\n        abi {\n           reset()\n           enable false\n           universalApk false  // If true, also generate a universal APK\n           include \"armeabi-v7a\", \"x86\"\n         }\n      }\n    }\n    dependencies {\n      compile \"com.facebook.react:react-native:+\"\n    }\n    ```\n\n  - 在app项目中创建`MApplication.java`\n\n    ```java\n    public class MApplication extends Application implements ReactApplication{\n\n        private final ReactNativeHost mReactNativeHost = new ReactNativeHost(this){\n\n\t\t\t@Override\n\t\t\tpublic boolean getUseDeveloperSupport() {\n\t\t\t\treturn BuildConfig.DEBUG;\n\t\t\t}\n\n\t\t\t@Override\n\t\t\tprotected List<ReactPackage> getPackages() {\n\t\t\t\treturn Arrays.<ReactPackage>asList(new MainReactPackage());\n\t\t\t}\n\n\t\t\t@Override\n\t\t\tprotected String getJSMainModuleName() {\n\t\t\t\treturn \"index\";\n\t\t\t}\n\t\t};\n\n\t\t@Override\n\t\tpublic ReactNativeHost getReactNativeHost() {\n\t\t\treturn mReactNativeHost;\n\t\t}\n    }\n    ```\n\n  - 在app项目中创建`MainActivity.java`\n\n    ```java\n    public class MainActivity extends ReactActivity {\n\n     @Nullable\n     @Override\n     protected String getMainComponentName() {\n        return \"ReactTest\";//与index.js中registerComponent对应\n     }\n    }\n    ```\n\n  - 修改app项目中`AndroidManifest.xml`文件\n\n    ```xml\n    <application\n        android:name=\".MApplication\">\n           <activity android:name=\".MainActivity\">\n              <intent-filter>\n                 <action android:name=\"android.intent.action.MAIN\" />\n\n                 <category android:name=\"android.intent.category.LAUNCHER\" />\n              </intent-filter>\n           </activity>\n           <activity android:name=\"com.facebook.react.devsupport.DevSettingsActivity\" />\n    </application>\n    ```\n\n### 运行\n\n1. 通过命令行直接运行`开发服务`和app:\n\n  ```shell\n  react-native run-android\n  ```\n\n  > 如果使用Windows系统请使用方法1，方法2会在运行app时出现异常：`java.io.IOException: Could not delete path`\n\n2. 通过命令运行`开发服务`，然后手动运行app\n\n  ```shell\n  npm start\n  #也可使用： react-native start\n  ```\n\n  `开发服务`正常启动后如下，使用中不能关闭（如果安装Watchman，`开发服务`会在后台运行可以关闭当前窗口）：\n\n  ```shell\n   \\> ReactTest@0.0.1 start x:\\xxxx\\React\n   \\> node node_modules/react-native/local-cli/cli.js start\n   \n   Scanning 564 folders for symlinks in x:\\xxxx\\React\\node_modules (43ms)\n   ┌────────────────────────────────────────────────────────────────────────────  ┐\n   │  Running packager on port 8081.                                              │\n   │                                                                              │\n   │  Keep this packager running while developing on any JS projects. Feel        │\n   │  free to close this tab and run your own packager instance if you            │\n   │  prefer.                                                                    │\n   │                                                                              │\n   │  https://github.com/facebook/react-native                                    │\n   │                                                                              │\n   └────────────────────────────────────────────────────────────────────────────┘\n   Looking for JS files in\n       X:\\xxxx\\React\n       \n   React packager ready.\n   \n   Loading dependency graph, done.\n   ```\n\n### 提示\n- 默认在根目录中执行以上命令\n- 出现手机或虚拟机无法连接电脑时可使用`adb reverse tcp:8081 tcp:8081`\n- debug模式默认使用8081端口,如果本地以被占用，通过`react-native start --port 9988`修改端口。\n- 注意需要权限：`<uses-permission android:name=\"android.permission.INTERNET\" />`\n- 参考：\n  - http://facebook.github.io/react-native/docs/integration-with-existing-apps.html\n  - http://facebook.github.io/react-native/docs/getting-started.html\n\n### Demo:[ReactTest](https://github.com/liaoheng/ReactTest)","slug":"Android-React-Native入门","published":1,"updated":"2023-06-30T13:34:34.848Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cljiok5gn0002t0izbfkifft5","content":"<blockquote>\n<p>本文需要了解基本Android开发知识</p>\n</blockquote>\n<h2 id=\"环境\"><a href=\"#环境\" class=\"headerlink\" title=\"环境\"></a>环境</h2><ol>\n<li><a href=\"http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html\">JDK</a></li>\n<li><a href=\"https://nodejs.org/en/download/\">Node</a></li>\n<li><a href=\"https://facebook.github.io/watchman/docs/install.html#build-install\">Watchman 可选</a> <code>Windows问题比较多，不推荐安装</code></li>\n<li><a href=\"https://developer.android.com/studio/index.html\">Android SDK</a><code>配置环境</code></li>\n</ol>\n<h3 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h3><ol>\n<li>项目结构，创建相应文件</li>\n</ol>\n<blockquote>\n<p>├── android<br>├── index.js<br>├── node_modules<br>├── package.json</p>\n</blockquote>\n<ol start=\"2\">\n<li>编辑<code>package.json</code>文件添加：</li>\n</ol>\n  <figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;[项目名]&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;version&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;0.0.1&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;private&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">true</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;scripts&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">\t<span class=\"attr\">&quot;start&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;node node_modules/react-native/local-cli/cli.js start&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">&quot;test&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;jest&quot;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;dependencies&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">\t<span class=\"attr\">&quot;react&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;16.3.1&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">&quot;react-native&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;0.55.1&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">&quot;react-navigation&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;1.5.2&quot;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;devDependencies&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">\t<span class=\"attr\">&quot;babel-jest&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;22.4.3&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">&quot;babel-preset-react-native&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;4.0.0&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">&quot;jest&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;22.4.3&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">&quot;react-test-renderer&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;16.3.1&quot;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;jest&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">\t<span class=\"attr\">&quot;preset&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;react-native&quot;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>也可以使用命令创建官方的HelloWorld项目，然后拷贝相关配置文件，如下：</p>\n</blockquote>\n<blockquote>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install -g create-react-native-app</span><br><span class=\"line\">create-react-native-app AwesomeProject</span><br></pre></td></tr></table></figure>\n</blockquote>\n<ol start=\"3\">\n<li>安装nodejs库，在根目录中执行命令：</li>\n</ol>\n  <figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install</span><br><span class=\"line\">npm install -g react-native-cli</span><br></pre></td></tr></table></figure>\n\n<ol start=\"4\">\n<li>编辑<code>index.js</code>文件添加：</li>\n</ol>\n  <figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> <span class=\"title class_\">React</span>, &#123; <span class=\"title class_\">Component</span> &#125; <span class=\"keyword\">from</span> <span class=\"string\">&#x27;react&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123;</span><br><span class=\"line\"><span class=\"title class_\">AppRegistry</span>,</span><br><span class=\"line\"><span class=\"title class_\">StyleSheet</span>,</span><br><span class=\"line\"><span class=\"title class_\">Text</span>,</span><br><span class=\"line\"><span class=\"title class_\">View</span></span><br><span class=\"line\">&#125; <span class=\"keyword\">from</span> <span class=\"string\">&#x27;react-native&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Launch</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">Component</span> &#123;</span><br><span class=\"line\"> <span class=\"title function_\">render</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">   <span class=\"keyword\">return</span> (</span><br><span class=\"line\">     <span class=\"language-xml\"><span class=\"tag\">&lt;<span class=\"name\">View</span> <span class=\"attr\">style</span>=<span class=\"string\">&#123;styles.container&#125;</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"language-xml\">      <span class=\"tag\">&lt;<span class=\"name\">Text</span> <span class=\"attr\">style</span>=<span class=\"string\">&#123;styles.welcome&#125;</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"language-xml\">        Welcome to React Native!</span></span><br><span class=\"line\"><span class=\"language-xml\">      <span class=\"tag\">&lt;/<span class=\"name\">Text</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"language-xml\">      <span class=\"tag\">&lt;<span class=\"name\">Text</span> <span class=\"attr\">style</span>=<span class=\"string\">&#123;styles.instructions&#125;</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"language-xml\">        To get started, edit index.js</span></span><br><span class=\"line\"><span class=\"language-xml\">      <span class=\"tag\">&lt;/<span class=\"name\">Text</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"language-xml\">      <span class=\"tag\">&lt;<span class=\"name\">Text</span> <span class=\"attr\">style</span>=<span class=\"string\">&#123;styles.instructions&#125;</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"language-xml\">        Double tap R on your keyboard to reload,&#123;&#x27;\\n&#x27;&#125;</span></span><br><span class=\"line\"><span class=\"language-xml\">        Shake or press menu button for dev menu</span></span><br><span class=\"line\"><span class=\"language-xml\">      <span class=\"tag\">&lt;/<span class=\"name\">Text</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"language-xml\">     <span class=\"tag\">&lt;/<span class=\"name\">View</span>&gt;</span></span></span><br><span class=\"line\">   );</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> styles = <span class=\"title class_\">StyleSheet</span>.<span class=\"title function_\">create</span>(&#123;</span><br><span class=\"line\"> <span class=\"attr\">container</span>: &#123;</span><br><span class=\"line\">  <span class=\"attr\">flex</span>: <span class=\"number\">1</span>,</span><br><span class=\"line\">  <span class=\"attr\">justifyContent</span>: <span class=\"string\">&#x27;center&#x27;</span>,</span><br><span class=\"line\">  <span class=\"attr\">alignItems</span>: <span class=\"string\">&#x27;center&#x27;</span>,</span><br><span class=\"line\">  <span class=\"attr\">backgroundColor</span>: <span class=\"string\">&#x27;#F5FCFF&#x27;</span>,</span><br><span class=\"line\"> &#125;,</span><br><span class=\"line\"> <span class=\"attr\">welcome</span>: &#123;</span><br><span class=\"line\">  <span class=\"attr\">fontSize</span>: <span class=\"number\">20</span>,</span><br><span class=\"line\">  <span class=\"attr\">textAlign</span>: <span class=\"string\">&#x27;center&#x27;</span>,</span><br><span class=\"line\">  <span class=\"attr\">margin</span>: <span class=\"number\">10</span>,</span><br><span class=\"line\">&#125;,</span><br><span class=\"line\"><span class=\"attr\">instructions</span>: &#123;</span><br><span class=\"line\">  <span class=\"attr\">textAlign</span>: <span class=\"string\">&#x27;center&#x27;</span>,</span><br><span class=\"line\">  <span class=\"attr\">color</span>: <span class=\"string\">&#x27;#333333&#x27;</span>,</span><br><span class=\"line\">  <span class=\"attr\">marginBottom</span>: <span class=\"number\">5</span>,</span><br><span class=\"line\">&#125;,</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title class_\">AppRegistry</span>.<span class=\"title function_\">registerComponent</span>(<span class=\"string\">&#x27;ReactTest&#x27;</span>, <span class=\"function\">() =&gt;</span> <span class=\"title class_\">Launch</span>);</span><br></pre></td></tr></table></figure>\n\n<ol start=\"5\">\n<li>在<code>android目录</code>中创建app工程项目，然后在项目中集成React Native</li>\n</ol>\n<ul>\n<li><p>[可选] 在<code>settings.gradle</code>文件中添加：</p>\n<figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">rootProject.name</span> = <span class=\"string\">&#x27;[项目名]&#x27;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在<code>gradle.properties</code>文件中添加：</p>\n<figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">android.useDeprecatedNdk</span>=<span class=\"string\">true</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在根目录<code>build.gradle</code>文件中添加：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">allprojects &#123;</span><br><span class=\"line\">   repositories &#123;</span><br><span class=\"line\">      maven &#123;</span><br><span class=\"line\">        url <span class=\"string\">&quot;$rootDir/../node_modules/react-native/android&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在app目录<code>build.gradle</code>文件中添加：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apply <span class=\"attr\">from:</span> <span class=\"string\">&quot;../../node_modules/react-native/react.gradle&quot;</span></span><br><span class=\"line\">   android &#123;</span><br><span class=\"line\">   defaultConfig &#123;</span><br><span class=\"line\">      ndk &#123;</span><br><span class=\"line\">          abiFilters <span class=\"string\">&quot;armeabi-v7a&quot;</span>, <span class=\"string\">&quot;x86&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   splits &#123;</span><br><span class=\"line\">       abi &#123;</span><br><span class=\"line\">          reset()</span><br><span class=\"line\">          enable <span class=\"literal\">false</span></span><br><span class=\"line\">          universalApk <span class=\"literal\">false</span>  <span class=\"comment\">// If true, also generate a universal APK</span></span><br><span class=\"line\">          include <span class=\"string\">&quot;armeabi-v7a&quot;</span>, <span class=\"string\">&quot;x86&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   dependencies &#123;</span><br><span class=\"line\">     compile <span class=\"string\">&quot;com.facebook.react:react-native:+&quot;</span></span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在app项目中创建<code>MApplication.java</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MApplication</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">Application</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">ReactApplication</span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"type\">ReactNativeHost</span> <span class=\"variable\">mReactNativeHost</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ReactNativeHost</span>(<span class=\"built_in\">this</span>)&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"type\">boolean</span> <span class=\"title function_\">getUseDeveloperSupport</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> BuildConfig.DEBUG;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"keyword\">protected</span> List&lt;ReactPackage&gt; <span class=\"title function_\">getPackages</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> Arrays.&lt;ReactPackage&gt;asList(<span class=\"keyword\">new</span> <span class=\"title class_\">MainReactPackage</span>());</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"keyword\">protected</span> String <span class=\"title function_\">getJSMainModuleName</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"string\">&quot;index&quot;</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> ReactNativeHost <span class=\"title function_\">getReactNativeHost</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> mReactNativeHost;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在app项目中创建<code>MainActivity.java</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MainActivity</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">ReactActivity</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"meta\">@Nullable</span></span><br><span class=\"line\"> <span class=\"meta\">@Override</span></span><br><span class=\"line\"> <span class=\"keyword\">protected</span> String <span class=\"title function_\">getMainComponentName</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">&quot;ReactTest&quot;</span>;<span class=\"comment\">//与index.js中registerComponent对应</span></span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>修改app项目中<code>AndroidManifest.xml</code>文件</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">application</span></span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">android:name</span>=<span class=\"string\">&quot;.MApplication&quot;</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">activity</span> <span class=\"attr\">android:name</span>=<span class=\"string\">&quot;.MainActivity&quot;</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">intent-filter</span>&gt;</span></span><br><span class=\"line\">             <span class=\"tag\">&lt;<span class=\"name\">action</span> <span class=\"attr\">android:name</span>=<span class=\"string\">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">             <span class=\"tag\">&lt;<span class=\"name\">category</span> <span class=\"attr\">android:name</span>=<span class=\"string\">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;/<span class=\"name\">intent-filter</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;/<span class=\"name\">activity</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">activity</span> <span class=\"attr\">android:name</span>=<span class=\"string\">&quot;com.facebook.react.devsupport.DevSettingsActivity&quot;</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">application</span>&gt;</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"运行\"><a href=\"#运行\" class=\"headerlink\" title=\"运行\"></a>运行</h3><ol>\n<li>通过命令行直接运行<code>开发服务</code>和app:</li>\n</ol>\n  <figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">react-native run-android</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>如果使用Windows系统请使用方法1，方法2会在运行app时出现异常：<code>java.io.IOException: Could not delete path</code></p>\n</blockquote>\n<ol start=\"2\">\n<li>通过命令运行<code>开发服务</code>，然后手动运行app</li>\n</ol>\n  <figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm start</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">也可使用： react-native start</span></span><br></pre></td></tr></table></figure>\n\n<p>  <code>开发服务</code>正常启动后如下，使用中不能关闭（如果安装Watchman，<code>开发服务</code>会在后台运行可以关闭当前窗口）：</p>\n  <figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\\&gt; ReactTest@0.0.1 start x:\\xxxx\\React</span><br><span class=\"line\">\\&gt; node node_modules/react-native/local-cli/cli.js start</span><br><span class=\"line\"></span><br><span class=\"line\">Scanning 564 folders for symlinks in x:\\xxxx\\React\\node_modules (43ms)</span><br><span class=\"line\">┌────────────────────────────────────────────────────────────────────────────  ┐</span><br><span class=\"line\">│  Running packager on port 8081.                                              │</span><br><span class=\"line\">│                                                                              │</span><br><span class=\"line\">│  Keep this packager running while developing on any JS projects. Feel        │</span><br><span class=\"line\">│  free to close this tab and run your own packager instance if you            │</span><br><span class=\"line\">│  prefer.                                                                    │</span><br><span class=\"line\">│                                                                              │</span><br><span class=\"line\">│  https://github.com/facebook/react-native                                    │</span><br><span class=\"line\">│                                                                              │</span><br><span class=\"line\">└────────────────────────────────────────────────────────────────────────────┘</span><br><span class=\"line\">Looking for JS files in</span><br><span class=\"line\">    X:\\xxxx\\React</span><br><span class=\"line\">    </span><br><span class=\"line\">React packager ready.</span><br><span class=\"line\"></span><br><span class=\"line\">Loading dependency graph, done.</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"提示\"><a href=\"#提示\" class=\"headerlink\" title=\"提示\"></a>提示</h3><ul>\n<li>默认在根目录中执行以上命令</li>\n<li>出现手机或虚拟机无法连接电脑时可使用<code>adb reverse tcp:8081 tcp:8081</code></li>\n<li>debug模式默认使用8081端口,如果本地以被占用，通过<code>react-native start --port 9988</code>修改端口。</li>\n<li>注意需要权限：<code>&lt;uses-permission android:name=&quot;android.permission.INTERNET&quot; /&gt;</code></li>\n<li>参考：<ul>\n<li><a href=\"http://facebook.github.io/react-native/docs/integration-with-existing-apps.html\">http://facebook.github.io/react-native/docs/integration-with-existing-apps.html</a></li>\n<li><a href=\"http://facebook.github.io/react-native/docs/getting-started.html\">http://facebook.github.io/react-native/docs/getting-started.html</a></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Demo-ReactTest\"><a href=\"#Demo-ReactTest\" class=\"headerlink\" title=\"Demo:ReactTest\"></a>Demo:<a href=\"https://github.com/liaoheng/ReactTest\">ReactTest</a></h3>","site":{"data":{"next":{"favicon":{"small":"/images/favicon-16x16.png","medium":"/images/favicon-32x32.png","apple_touch_icon":"/images/apple-touch-icon.png","safari_pinned_tab":"/images/safari_pinned_tab.svg"},"creative_commons":{"license":"by-nc-sa","sidebar":true,"post":true,"language":"deed.zh"},"scheme":"Gemini","darkmode":true,"avatar":{"url":"/images/avatar.jpg","rounded":true,"rotated":false},"social":{"GitHub":"https://github.com/liaoheng || fab fa-github","RSS":"/atom.xml || fa fa-rss"},"social_icons":{"enable":true,"icons_only":true,"transition":true},"codeblock":{"highlight_theme":"normal","copy_button":{"enable":true,"show_result":true,"style":null}},"github_banner":{"enable":true,"permalink":"https://github.com/liaoheng","title":"Follow me on GitHub"},"google_analytics":{"tracking_id":"G-64FL8LWFL8","only_pageview":false},"vendors":{"pace":"//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js","pace_css":"//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css"},"pace":{"enable":true,"theme":"minimal"}}}},"excerpt":"","more":"<blockquote>\n<p>本文需要了解基本Android开发知识</p>\n</blockquote>\n<h2 id=\"环境\"><a href=\"#环境\" class=\"headerlink\" title=\"环境\"></a>环境</h2><ol>\n<li><a href=\"http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html\">JDK</a></li>\n<li><a href=\"https://nodejs.org/en/download/\">Node</a></li>\n<li><a href=\"https://facebook.github.io/watchman/docs/install.html#build-install\">Watchman 可选</a> <code>Windows问题比较多，不推荐安装</code></li>\n<li><a href=\"https://developer.android.com/studio/index.html\">Android SDK</a><code>配置环境</code></li>\n</ol>\n<h3 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h3><ol>\n<li>项目结构，创建相应文件</li>\n</ol>\n<blockquote>\n<p>├── android<br>├── index.js<br>├── node_modules<br>├── package.json</p>\n</blockquote>\n<ol start=\"2\">\n<li>编辑<code>package.json</code>文件添加：</li>\n</ol>\n  <figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;[项目名]&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;version&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;0.0.1&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;private&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">true</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;scripts&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">\t<span class=\"attr\">&quot;start&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;node node_modules/react-native/local-cli/cli.js start&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">&quot;test&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;jest&quot;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;dependencies&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">\t<span class=\"attr\">&quot;react&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;16.3.1&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">&quot;react-native&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;0.55.1&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">&quot;react-navigation&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;1.5.2&quot;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;devDependencies&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">\t<span class=\"attr\">&quot;babel-jest&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;22.4.3&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">&quot;babel-preset-react-native&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;4.0.0&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">&quot;jest&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;22.4.3&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"attr\">&quot;react-test-renderer&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;16.3.1&quot;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;jest&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">\t<span class=\"attr\">&quot;preset&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;react-native&quot;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>也可以使用命令创建官方的HelloWorld项目，然后拷贝相关配置文件，如下：</p>\n</blockquote>\n<blockquote>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install -g create-react-native-app</span><br><span class=\"line\">create-react-native-app AwesomeProject</span><br></pre></td></tr></table></figure>\n</blockquote>\n<ol start=\"3\">\n<li>安装nodejs库，在根目录中执行命令：</li>\n</ol>\n  <figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install</span><br><span class=\"line\">npm install -g react-native-cli</span><br></pre></td></tr></table></figure>\n\n<ol start=\"4\">\n<li>编辑<code>index.js</code>文件添加：</li>\n</ol>\n  <figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> <span class=\"title class_\">React</span>, &#123; <span class=\"title class_\">Component</span> &#125; <span class=\"keyword\">from</span> <span class=\"string\">&#x27;react&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123;</span><br><span class=\"line\"><span class=\"title class_\">AppRegistry</span>,</span><br><span class=\"line\"><span class=\"title class_\">StyleSheet</span>,</span><br><span class=\"line\"><span class=\"title class_\">Text</span>,</span><br><span class=\"line\"><span class=\"title class_\">View</span></span><br><span class=\"line\">&#125; <span class=\"keyword\">from</span> <span class=\"string\">&#x27;react-native&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Launch</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">Component</span> &#123;</span><br><span class=\"line\"> <span class=\"title function_\">render</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">   <span class=\"keyword\">return</span> (</span><br><span class=\"line\">     <span class=\"language-xml\"><span class=\"tag\">&lt;<span class=\"name\">View</span> <span class=\"attr\">style</span>=<span class=\"string\">&#123;styles.container&#125;</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"language-xml\">      <span class=\"tag\">&lt;<span class=\"name\">Text</span> <span class=\"attr\">style</span>=<span class=\"string\">&#123;styles.welcome&#125;</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"language-xml\">        Welcome to React Native!</span></span><br><span class=\"line\"><span class=\"language-xml\">      <span class=\"tag\">&lt;/<span class=\"name\">Text</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"language-xml\">      <span class=\"tag\">&lt;<span class=\"name\">Text</span> <span class=\"attr\">style</span>=<span class=\"string\">&#123;styles.instructions&#125;</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"language-xml\">        To get started, edit index.js</span></span><br><span class=\"line\"><span class=\"language-xml\">      <span class=\"tag\">&lt;/<span class=\"name\">Text</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"language-xml\">      <span class=\"tag\">&lt;<span class=\"name\">Text</span> <span class=\"attr\">style</span>=<span class=\"string\">&#123;styles.instructions&#125;</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"language-xml\">        Double tap R on your keyboard to reload,&#123;&#x27;\\n&#x27;&#125;</span></span><br><span class=\"line\"><span class=\"language-xml\">        Shake or press menu button for dev menu</span></span><br><span class=\"line\"><span class=\"language-xml\">      <span class=\"tag\">&lt;/<span class=\"name\">Text</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"language-xml\">     <span class=\"tag\">&lt;/<span class=\"name\">View</span>&gt;</span></span></span><br><span class=\"line\">   );</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> styles = <span class=\"title class_\">StyleSheet</span>.<span class=\"title function_\">create</span>(&#123;</span><br><span class=\"line\"> <span class=\"attr\">container</span>: &#123;</span><br><span class=\"line\">  <span class=\"attr\">flex</span>: <span class=\"number\">1</span>,</span><br><span class=\"line\">  <span class=\"attr\">justifyContent</span>: <span class=\"string\">&#x27;center&#x27;</span>,</span><br><span class=\"line\">  <span class=\"attr\">alignItems</span>: <span class=\"string\">&#x27;center&#x27;</span>,</span><br><span class=\"line\">  <span class=\"attr\">backgroundColor</span>: <span class=\"string\">&#x27;#F5FCFF&#x27;</span>,</span><br><span class=\"line\"> &#125;,</span><br><span class=\"line\"> <span class=\"attr\">welcome</span>: &#123;</span><br><span class=\"line\">  <span class=\"attr\">fontSize</span>: <span class=\"number\">20</span>,</span><br><span class=\"line\">  <span class=\"attr\">textAlign</span>: <span class=\"string\">&#x27;center&#x27;</span>,</span><br><span class=\"line\">  <span class=\"attr\">margin</span>: <span class=\"number\">10</span>,</span><br><span class=\"line\">&#125;,</span><br><span class=\"line\"><span class=\"attr\">instructions</span>: &#123;</span><br><span class=\"line\">  <span class=\"attr\">textAlign</span>: <span class=\"string\">&#x27;center&#x27;</span>,</span><br><span class=\"line\">  <span class=\"attr\">color</span>: <span class=\"string\">&#x27;#333333&#x27;</span>,</span><br><span class=\"line\">  <span class=\"attr\">marginBottom</span>: <span class=\"number\">5</span>,</span><br><span class=\"line\">&#125;,</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title class_\">AppRegistry</span>.<span class=\"title function_\">registerComponent</span>(<span class=\"string\">&#x27;ReactTest&#x27;</span>, <span class=\"function\">() =&gt;</span> <span class=\"title class_\">Launch</span>);</span><br></pre></td></tr></table></figure>\n\n<ol start=\"5\">\n<li>在<code>android目录</code>中创建app工程项目，然后在项目中集成React Native</li>\n</ol>\n<ul>\n<li><p>[可选] 在<code>settings.gradle</code>文件中添加：</p>\n<figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">rootProject.name</span> = <span class=\"string\">&#x27;[项目名]&#x27;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在<code>gradle.properties</code>文件中添加：</p>\n<figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">android.useDeprecatedNdk</span>=<span class=\"string\">true</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在根目录<code>build.gradle</code>文件中添加：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">allprojects &#123;</span><br><span class=\"line\">   repositories &#123;</span><br><span class=\"line\">      maven &#123;</span><br><span class=\"line\">        url <span class=\"string\">&quot;$rootDir/../node_modules/react-native/android&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在app目录<code>build.gradle</code>文件中添加：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apply <span class=\"attr\">from:</span> <span class=\"string\">&quot;../../node_modules/react-native/react.gradle&quot;</span></span><br><span class=\"line\">   android &#123;</span><br><span class=\"line\">   defaultConfig &#123;</span><br><span class=\"line\">      ndk &#123;</span><br><span class=\"line\">          abiFilters <span class=\"string\">&quot;armeabi-v7a&quot;</span>, <span class=\"string\">&quot;x86&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   splits &#123;</span><br><span class=\"line\">       abi &#123;</span><br><span class=\"line\">          reset()</span><br><span class=\"line\">          enable <span class=\"literal\">false</span></span><br><span class=\"line\">          universalApk <span class=\"literal\">false</span>  <span class=\"comment\">// If true, also generate a universal APK</span></span><br><span class=\"line\">          include <span class=\"string\">&quot;armeabi-v7a&quot;</span>, <span class=\"string\">&quot;x86&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   dependencies &#123;</span><br><span class=\"line\">     compile <span class=\"string\">&quot;com.facebook.react:react-native:+&quot;</span></span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在app项目中创建<code>MApplication.java</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MApplication</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">Application</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">ReactApplication</span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"type\">ReactNativeHost</span> <span class=\"variable\">mReactNativeHost</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ReactNativeHost</span>(<span class=\"built_in\">this</span>)&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"type\">boolean</span> <span class=\"title function_\">getUseDeveloperSupport</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> BuildConfig.DEBUG;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"keyword\">protected</span> List&lt;ReactPackage&gt; <span class=\"title function_\">getPackages</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> Arrays.&lt;ReactPackage&gt;asList(<span class=\"keyword\">new</span> <span class=\"title class_\">MainReactPackage</span>());</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t<span class=\"keyword\">protected</span> String <span class=\"title function_\">getJSMainModuleName</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"string\">&quot;index&quot;</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> ReactNativeHost <span class=\"title function_\">getReactNativeHost</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> mReactNativeHost;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在app项目中创建<code>MainActivity.java</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MainActivity</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">ReactActivity</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"meta\">@Nullable</span></span><br><span class=\"line\"> <span class=\"meta\">@Override</span></span><br><span class=\"line\"> <span class=\"keyword\">protected</span> String <span class=\"title function_\">getMainComponentName</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">&quot;ReactTest&quot;</span>;<span class=\"comment\">//与index.js中registerComponent对应</span></span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>修改app项目中<code>AndroidManifest.xml</code>文件</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">application</span></span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">android:name</span>=<span class=\"string\">&quot;.MApplication&quot;</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">activity</span> <span class=\"attr\">android:name</span>=<span class=\"string\">&quot;.MainActivity&quot;</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">intent-filter</span>&gt;</span></span><br><span class=\"line\">             <span class=\"tag\">&lt;<span class=\"name\">action</span> <span class=\"attr\">android:name</span>=<span class=\"string\">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">             <span class=\"tag\">&lt;<span class=\"name\">category</span> <span class=\"attr\">android:name</span>=<span class=\"string\">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;/<span class=\"name\">intent-filter</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;/<span class=\"name\">activity</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">activity</span> <span class=\"attr\">android:name</span>=<span class=\"string\">&quot;com.facebook.react.devsupport.DevSettingsActivity&quot;</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">application</span>&gt;</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"运行\"><a href=\"#运行\" class=\"headerlink\" title=\"运行\"></a>运行</h3><ol>\n<li>通过命令行直接运行<code>开发服务</code>和app:</li>\n</ol>\n  <figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">react-native run-android</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>如果使用Windows系统请使用方法1，方法2会在运行app时出现异常：<code>java.io.IOException: Could not delete path</code></p>\n</blockquote>\n<ol start=\"2\">\n<li>通过命令运行<code>开发服务</code>，然后手动运行app</li>\n</ol>\n  <figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm start</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">也可使用： react-native start</span></span><br></pre></td></tr></table></figure>\n\n<p>  <code>开发服务</code>正常启动后如下，使用中不能关闭（如果安装Watchman，<code>开发服务</code>会在后台运行可以关闭当前窗口）：</p>\n  <figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\\&gt; ReactTest@0.0.1 start x:\\xxxx\\React</span><br><span class=\"line\">\\&gt; node node_modules/react-native/local-cli/cli.js start</span><br><span class=\"line\"></span><br><span class=\"line\">Scanning 564 folders for symlinks in x:\\xxxx\\React\\node_modules (43ms)</span><br><span class=\"line\">┌────────────────────────────────────────────────────────────────────────────  ┐</span><br><span class=\"line\">│  Running packager on port 8081.                                              │</span><br><span class=\"line\">│                                                                              │</span><br><span class=\"line\">│  Keep this packager running while developing on any JS projects. Feel        │</span><br><span class=\"line\">│  free to close this tab and run your own packager instance if you            │</span><br><span class=\"line\">│  prefer.                                                                    │</span><br><span class=\"line\">│                                                                              │</span><br><span class=\"line\">│  https://github.com/facebook/react-native                                    │</span><br><span class=\"line\">│                                                                              │</span><br><span class=\"line\">└────────────────────────────────────────────────────────────────────────────┘</span><br><span class=\"line\">Looking for JS files in</span><br><span class=\"line\">    X:\\xxxx\\React</span><br><span class=\"line\">    </span><br><span class=\"line\">React packager ready.</span><br><span class=\"line\"></span><br><span class=\"line\">Loading dependency graph, done.</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"提示\"><a href=\"#提示\" class=\"headerlink\" title=\"提示\"></a>提示</h3><ul>\n<li>默认在根目录中执行以上命令</li>\n<li>出现手机或虚拟机无法连接电脑时可使用<code>adb reverse tcp:8081 tcp:8081</code></li>\n<li>debug模式默认使用8081端口,如果本地以被占用，通过<code>react-native start --port 9988</code>修改端口。</li>\n<li>注意需要权限：<code>&lt;uses-permission android:name=&quot;android.permission.INTERNET&quot; /&gt;</code></li>\n<li>参考：<ul>\n<li><a href=\"http://facebook.github.io/react-native/docs/integration-with-existing-apps.html\">http://facebook.github.io/react-native/docs/integration-with-existing-apps.html</a></li>\n<li><a href=\"http://facebook.github.io/react-native/docs/getting-started.html\">http://facebook.github.io/react-native/docs/getting-started.html</a></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Demo-ReactTest\"><a href=\"#Demo-ReactTest\" class=\"headerlink\" title=\"Demo:ReactTest\"></a>Demo:<a href=\"https://github.com/liaoheng/ReactTest\">ReactTest</a></h3>"},{"title":"Android密度无关像素(dp)与屏幕适配","date":"2021-07-14T08:16:34.000Z","_content":"\n## 密度无关像素(density-independent pixels)\n> Android 设备不仅有不同的屏幕尺寸（手机、平板电脑、电视等），而且其屏幕也有不同的像素尺寸。也就是说，有可能一部设备的屏幕为每平方英寸 160 像素，而另一部设备的屏幕在相同的空间内可以容纳 480  像素。如果您不考虑像素密度的这些差异，系统可能会缩放图片（导致图片变模糊），或者图片可能会以完全错误的尺寸显示。\n\n如果开发者只对屏幕`分辨率`进行适配，也就是说使用`像素(px)`作为度量单位，那么在同一`分辨率`下的布局，在不同`像素密度`的屏幕中的显示完全不同。为了应对这种情况，Android引入了`密度无关像素(dp)`来作为度量单位，但**最终的渲染还是使用像素(px)为度量单位**，dp是做为一种中间值的存在。\n\n> 密度无关像素(dp)是一个虚拟像素单位，1 dp 约等于`中密度屏幕`（160dpi；“基准”密度）上的 1 像素。对于其他每个密度，Android 会将此值转换为相应的实际像素数。\n\nAndroid支持多种多样的`屏幕密度`，但是开发者不可能对每种都进行适配，于是将`屏幕密度`按一定关系进行划分，开发者只适配同一区间的`屏幕密度`成为一种比较好的方案。Android的`屏幕密度`分级区间，系统会基于不同区间自行按对应倍数进行缩放（包括布局和图片），开发者也可以基于这些区间规制自行适配，区间如下：\n\n|密度限定符|说明|**缩放倍数**|\n| ----- | ----- | ----- |\n|ldpi|适用于低密度 (ldpi) 屏幕 (\\~ 120dpi) 的资源。（在120dpi左右，而非固定值，不同系统也是有差距的）|0.75（px=dp\\*0.75）|\n|mdpi|适用于中密度 (mdpi) 屏幕 (\\~ 160dpi) 的资源（这是基准密度）。默认的layout，dimens也是基于此。|1.0（px=dp)|\n|hdpi|适用于高密度 (hdpi) 屏幕 (\\~ 240dpi) 的资源。|1.5（px=dp\\*1.5）|\n|xhdpi|适用于加高 (xhdpi) 密度屏幕 (\\~ 320dpi) 的资源。|2.0（px=dp\\*2）|\n|xxhdpi|适用于超超高密度 (xxhdpi) 屏幕 (\\~ 480dpi) 的资源。|3.0（px=dp\\*3）|\n|xxxhdpi|适用于超超超高密度 (xxxhdpi) 屏幕 (\\~ 640dpi) 的资源。|4.0（px=dp\\*4）|\n|nodpi|适用于所有密度的资源。这些是与密度无关的资源。无论当前屏幕的密度是多少，系统都不会缩放以此限定符标记的资源。| |\n|tvdpi|适用于密度介于 mdpi 和 hdpi 之间的屏幕（约 213dpi）的资源。这不属于“主要”密度组。它主要用于电视，而大多数应用都不需要它。对于大多数应用而言，提供 mdpi 和 hdpi 资源便已足够，系统将视情况对其进行缩放。如果您发现有必要提供 tvdpi 资源，应按一个系数来确定其大小，即 1.33\\*mdpi。例如，如果某张图片在 mdpi 屏幕上的大小为 100px x 100px，那么它在 tvdpi 屏幕上的大小应该为 133px x 133px。|1.33（px=dp\\*1.33）|\n\n例如，你在中密度屏幕上的一个控件或者图片，大小为 48x48 像素，那么它在其他各种密度的屏幕上的大小应该为：\n\n* 36x36 (0.75x) - 低密度 (ldpi)\n* 48x48（1.0x 基准）- 中密度 (mdpi)\n* 72x72 (1.5x) - 高密度 (hdpi)\n* 96x96 (2.0x) - 超高密度 (xhdpi)\n* 144x144 (3.0x) - 超超高密度 (xxhdpi)\n* 192x192 (4.0x) - 超超超高密度 (xxxhdpi)\n\n## 如何使用密度无关像素进行适配屏幕\n### 系统适配\n* 图片文件48x48（res/drawable/ic\\_icon.png）\n* 布局文件（res/layout/activity\\_main.xml）\n\n```xml\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<FrameLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"match_parent\">\n    <TextView\n            android:layout_marginTop=\"@dimen/text_margin_top\"\n            android:layout_marginEnd=\"@dimen/text_margin_end\"\n            android:layout_marginStart=\"@dimen/text_margin_start\"\n            android:layout_marginBottom=\"@dimen/text_margin_bottom\"\n            android:layout_width=\"wrap_content\"\n            android:layout_height=\"wrap_content\"\n            android:text=\"@string/app_name\" />\n</FrameLayout>\n```\n* 资源尺寸文件（res/values/dimens.xml）\n\n```xml\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<resources>\n    <dimen name=\"text_margin_top\">15dp</dimen>//缩放之后的px=15*缩放倍数\n    <dimen name=\"text_margin_end\">10dp</dimen>\n    <dimen name=\"text_margin_start\">20dp</dimen>\n    <dimen name=\"text_margin_bottom\">20px</dimen>//不会缩放px=20\n</resources>\n```\n系统会根据`屏幕密度`分级区间自行按对应倍数进行缩放，在中密度 (mdpi)下`text_margin_top`的`像素`为15，在超高密度 (xhdpi)下，`text_margin_top`的`像素`为15x2.0，`ic_icon.png`的`像素`为96x96。\n\n### 自定义适配\n系统的缩放比在一定条件下，是可以保证应用的显示正常，但是往往不一定那么理想，于是手动去设置尺寸，更为常见，就是能过将对应尺寸的资源放入对应dp文件夹来实现，如：\n\n* 要适配xhdpi，就将同名图片放入`res/drawable-xhdp/ic_icon.png`。\n* 要适配xhdpi，就将同名文件放入`res/layout-xhdpi/activity_main.xml`。\n* 要适配xhdpi，就将同名文件放入`res/values-xhdpi/dimens.xml`中。\n\n如果使用dp会在相应`屏幕密度`分级区间自行按对应倍数进行缩放，也就是说相当于覆盖了默认的`res/values/dimens.xml`中的参数，然后进入*系统适配*（按对应倍数进行缩放），px则不会进行缩放，例如(res/values-xhdpi/dimens.xml)：\n\n```xml\n  <?xml version=\"1.0\" encoding=\"utf-8\"?>\n  <resources>\n      <dimen name=\"text_margin_top\">5dp</dimen> //缩放之后的px=10\n      <dimen name=\"text_margin_end\">5dp</dimen>\n      <dimen name=\"text_margin_start\">10px</dimen>//不会缩放px=10\n      <dimen name=\"text_margin_bottom\">15px</dimen>\n  </resources>\n```\n当前应用如果适配的dpi不匹配设备时，系统会先找比设备dpi更大最近的以适配的dpi，然后是更小最近的，一直到mdpi也就是默认适配文件。例如：\n\n* 当前应用适配有hdpi、xxdpi、xxxdpi，设备的dpi为xhdpi，于是系统给应用分配的是xxdpi中的参数。\n* 当前应用适配有hdpi，设备的dpi为xhdpi，于是系统给应用分配的是hdpi中的参数。\n* 当前应用适配有ldpi，设备的dpi为xhdpi，于是系统给应用分配的是mdpi(也就是默认值)中的参数。\n\n### 使用代码强行设置应用显示的`屏幕密度`(dpi)\n这种方式可以比如只适配了xhdpi，想在其它的dpi中也按xhdpi进行绘制。\n\n```java\n    private float sNoCompatDensity;\n    private float sNoCompatScaledDensity;\n\n    /**\n     * 强制设置dpi\n     *\n     * @param targetDP 密度屏幕(160,240,360...)\n     * @param isV      是否横屏\n     */\n    private void setCustomDensity(int targetDP, boolean isV) {\n        DisplayMetrics appDisplayMetrics = getResources().getDisplayMetrics();\n        if (sNoCompatDensity == 0) {\n            sNoCompatDensity = appDisplayMetrics.density;\n            sNoCompatScaledDensity = appDisplayMetrics.scaledDensity;\n        }\n\n        float targetDensity;\n        if (isV) {\n            targetDensity =\n                    (float) appDisplayMetrics.heightPixels / (appDisplayMetrics.heightPixels / (targetDP / 160F));\n        } else {\n            targetDensity =\n                    (float) appDisplayMetrics.widthPixels / (appDisplayMetrics.heightPixels / (targetDP / 160F));\n        }\n        float targetScaledDensity = targetDensity * (sNoCompatScaledDensity / sNoCompatDensity);\n        int targetDensityDpi = (int) (160 * targetDensity);\n\n        appDisplayMetrics.density = targetDensity;\n        appDisplayMetrics.scaledDensity = targetScaledDensity;\n        appDisplayMetrics.densityDpi = targetDensityDpi;\n    }\n```\n### **使用最小宽度限定符(smallestWidth)进行适配**\n> 屏幕的基本尺寸，由可用屏幕区域的最小尺寸指定。具体而言，设备的 smallestWidth 是屏幕可用高度和宽度的最小尺寸（您也可将其视为屏幕的“最小可能宽度”）。无论屏幕的当前方向如何，您均可使用此限定符确保应用界面的可用宽度至少为  dp。\n例如，如果布局要求屏幕区域的最小尺寸始终至少为 600dp，则可使用此限定符创建布局资源 res/layout-sw600dp/。仅当可用屏幕的最小尺寸至少为 600dp（无论 600dp 表示的边是用户所认为的高度还是宽度）时，系统才会使用这些资源。最小宽度为设备的固定屏幕尺寸特征；即使屏幕方向发生变化，设备的最小宽度仍会保持不变。\n\n该最小宽度的计算方式为：`屏幕宽度(px)/屏幕密度缩放倍数`。如你的屏幕为720x1280 xhdpi，那么720/2=360。\n\n使用如下：`res/values-sw360dp/dimens.xml`，就是满足最小宽度(dp)为360dpi的屏幕进行适配，这种方式是分辨率+屏幕密度(dpi)，算是现在对于**多尺寸屏幕适配**比较好的方案。\n\n### **可用宽度(高度)限定符进行适配**\n> 您可能希望根据当前可用的宽度或高度来更改布局，而不是根据屏幕的最小宽度来更改布局。例如，如果您有一个双窗格布局，您可能希望在屏幕宽度至少为 600dp 时使用该布局，但屏幕宽度可能会根据设备的屏幕方向是横向还是纵向而发生变化。\n\n使用**最小宽度限定符**的适配方式对于等比例屏幕效果比较好，如果是屏幕长宽比例较大时就不太适用，这时可以使用**可用宽度(高度)符**，这两种方案搭配几乎可以满足所有适配需求。\n\n计算方式为与**最小宽度限定符**一样。\n\n使用如下：`res/values-w360dp/dimens.xml`，就是满足宽度(dp)为360dpi的屏幕进行适配或者`res/values-h720dp/dimens.xml`就是满足高度(dp)为720dpi的屏幕进行适配。\n\n## 相关其它\n### dp与px的转换规则\n```\npx = dp * (dpi / 160)\n```\n`dpi`：由上表可得，就是每平方英寸可显示的像素数量，如mdpi\\~240dpi。\n\n### 设计图中的px与dp转换\n在Photoshop中的\\*\\*像素/英寸 (ppi)\\*\\*与Android的`屏幕密度`(dpi)基本是一个概念，于是在设计图(320ppi)中一个控件的外边距为10px，由上面的转换规则可知`dp=px/(dpi/160)`，这里就是10/(320/160)=5，也就是在xhdpi的布局中对应控件的外边距为5dp。\n\n### 改变设备的`屏幕密度`(dpi)\n获取设备屏幕分辨率：`adb shell wm size`获取设备`屏幕密度`(dpi)：`adb shell wm density`设置`屏幕密度`(dpi) ：`adb shell wm density 320`重置`屏幕密度`(dpi) ：`adb shell wm density reset`\n\n**注意**：虽然改变了系统的参数，但是系统判断自定义适配规制是无效的，会跳过当前dpi，但是`最小宽度限定符`是生效的。例如：\n\n* 当前应用适配有hdpi、xxdpi、xxxdpi，给设备设置的是hdpi，于是系统给应用分配的是xxdpi中的参数。\n* 当前应用适配有sw480dp，给设备(720p)设置的是hdpi，是正常的。\n\n### 获取屏幕参数代码片段\n```java\n    public void getAndroiodScreenProperty() {\n        WindowManager wm = (WindowManager) getSystemService(Context.WINDOW_SERVICE);\n        DisplayMetrics dm = new DisplayMetrics();\n        wm.getDefaultDisplay().getMetrics(dm);\n        int width = dm.widthPixels;         // 屏幕宽度（像素）\n        int height = dm.heightPixels;       // 屏幕高度（像素）\n        float density = dm.density;         // 屏幕密度（0.75 / 1.0 / 1.5）\n        int densityDpi = dm.densityDpi;     // 屏幕密度dpi（120 / 160 / 240）\n        // 屏幕宽度算法:屏幕宽度（像素）/屏幕密度\n        int screenWidth = (int) (width / density);  // 屏幕宽度(dp)\n        int screenHeight = (int) (height / density);// 屏幕高度(dp)\n\n        Log.d(TAG, \"屏幕宽度（像素）：\" + width);\n        Log.d(TAG, \"屏幕高度（像素）：\" + height);\n        Log.d(TAG, \"屏幕密度（0.75 / 1.0 / 1.5）：\" + density);\n        Log.d(TAG, \"屏幕密度dpi（120 / 160 / 240）：\" + densityDpi);\n        Log.d(TAG, \"屏幕宽度（dp）：\" + screenWidth);\n        Log.d(TAG, \"屏幕高度（dp）：\" + screenHeight);\n    }\n```\n## 参考\n* [支持不同的屏幕尺寸](https://developer.android.com/training/multiscreen/screensizes)\n* [支持不同的像素密度](https://developer.android.com/training/multiscreen/screendensities)\n* [推荐Android两种屏幕适配方案 ](https://juejin.cn/post/6844903612926296072#heading-10)\n* [Android获取屏幕的宽度和高度(dp)](https://blog.csdn.net/wangliblog/article/details/22501141)\n* [Android屏幕values-sw适配](https://blog.csdn.net/nihaomabmt/article/details/71215507)","source":"_posts/android-dp-and-screen-adaptation.md","raw":"---\ntitle: Android密度无关像素(dp)与屏幕适配\ndate: 2021-07-14 16:16:34\ntags:\n---\n\n## 密度无关像素(density-independent pixels)\n> Android 设备不仅有不同的屏幕尺寸（手机、平板电脑、电视等），而且其屏幕也有不同的像素尺寸。也就是说，有可能一部设备的屏幕为每平方英寸 160 像素，而另一部设备的屏幕在相同的空间内可以容纳 480  像素。如果您不考虑像素密度的这些差异，系统可能会缩放图片（导致图片变模糊），或者图片可能会以完全错误的尺寸显示。\n\n如果开发者只对屏幕`分辨率`进行适配，也就是说使用`像素(px)`作为度量单位，那么在同一`分辨率`下的布局，在不同`像素密度`的屏幕中的显示完全不同。为了应对这种情况，Android引入了`密度无关像素(dp)`来作为度量单位，但**最终的渲染还是使用像素(px)为度量单位**，dp是做为一种中间值的存在。\n\n> 密度无关像素(dp)是一个虚拟像素单位，1 dp 约等于`中密度屏幕`（160dpi；“基准”密度）上的 1 像素。对于其他每个密度，Android 会将此值转换为相应的实际像素数。\n\nAndroid支持多种多样的`屏幕密度`，但是开发者不可能对每种都进行适配，于是将`屏幕密度`按一定关系进行划分，开发者只适配同一区间的`屏幕密度`成为一种比较好的方案。Android的`屏幕密度`分级区间，系统会基于不同区间自行按对应倍数进行缩放（包括布局和图片），开发者也可以基于这些区间规制自行适配，区间如下：\n\n|密度限定符|说明|**缩放倍数**|\n| ----- | ----- | ----- |\n|ldpi|适用于低密度 (ldpi) 屏幕 (\\~ 120dpi) 的资源。（在120dpi左右，而非固定值，不同系统也是有差距的）|0.75（px=dp\\*0.75）|\n|mdpi|适用于中密度 (mdpi) 屏幕 (\\~ 160dpi) 的资源（这是基准密度）。默认的layout，dimens也是基于此。|1.0（px=dp)|\n|hdpi|适用于高密度 (hdpi) 屏幕 (\\~ 240dpi) 的资源。|1.5（px=dp\\*1.5）|\n|xhdpi|适用于加高 (xhdpi) 密度屏幕 (\\~ 320dpi) 的资源。|2.0（px=dp\\*2）|\n|xxhdpi|适用于超超高密度 (xxhdpi) 屏幕 (\\~ 480dpi) 的资源。|3.0（px=dp\\*3）|\n|xxxhdpi|适用于超超超高密度 (xxxhdpi) 屏幕 (\\~ 640dpi) 的资源。|4.0（px=dp\\*4）|\n|nodpi|适用于所有密度的资源。这些是与密度无关的资源。无论当前屏幕的密度是多少，系统都不会缩放以此限定符标记的资源。| |\n|tvdpi|适用于密度介于 mdpi 和 hdpi 之间的屏幕（约 213dpi）的资源。这不属于“主要”密度组。它主要用于电视，而大多数应用都不需要它。对于大多数应用而言，提供 mdpi 和 hdpi 资源便已足够，系统将视情况对其进行缩放。如果您发现有必要提供 tvdpi 资源，应按一个系数来确定其大小，即 1.33\\*mdpi。例如，如果某张图片在 mdpi 屏幕上的大小为 100px x 100px，那么它在 tvdpi 屏幕上的大小应该为 133px x 133px。|1.33（px=dp\\*1.33）|\n\n例如，你在中密度屏幕上的一个控件或者图片，大小为 48x48 像素，那么它在其他各种密度的屏幕上的大小应该为：\n\n* 36x36 (0.75x) - 低密度 (ldpi)\n* 48x48（1.0x 基准）- 中密度 (mdpi)\n* 72x72 (1.5x) - 高密度 (hdpi)\n* 96x96 (2.0x) - 超高密度 (xhdpi)\n* 144x144 (3.0x) - 超超高密度 (xxhdpi)\n* 192x192 (4.0x) - 超超超高密度 (xxxhdpi)\n\n## 如何使用密度无关像素进行适配屏幕\n### 系统适配\n* 图片文件48x48（res/drawable/ic\\_icon.png）\n* 布局文件（res/layout/activity\\_main.xml）\n\n```xml\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<FrameLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\n        android:layout_width=\"match_parent\"\n        android:layout_height=\"match_parent\">\n    <TextView\n            android:layout_marginTop=\"@dimen/text_margin_top\"\n            android:layout_marginEnd=\"@dimen/text_margin_end\"\n            android:layout_marginStart=\"@dimen/text_margin_start\"\n            android:layout_marginBottom=\"@dimen/text_margin_bottom\"\n            android:layout_width=\"wrap_content\"\n            android:layout_height=\"wrap_content\"\n            android:text=\"@string/app_name\" />\n</FrameLayout>\n```\n* 资源尺寸文件（res/values/dimens.xml）\n\n```xml\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<resources>\n    <dimen name=\"text_margin_top\">15dp</dimen>//缩放之后的px=15*缩放倍数\n    <dimen name=\"text_margin_end\">10dp</dimen>\n    <dimen name=\"text_margin_start\">20dp</dimen>\n    <dimen name=\"text_margin_bottom\">20px</dimen>//不会缩放px=20\n</resources>\n```\n系统会根据`屏幕密度`分级区间自行按对应倍数进行缩放，在中密度 (mdpi)下`text_margin_top`的`像素`为15，在超高密度 (xhdpi)下，`text_margin_top`的`像素`为15x2.0，`ic_icon.png`的`像素`为96x96。\n\n### 自定义适配\n系统的缩放比在一定条件下，是可以保证应用的显示正常，但是往往不一定那么理想，于是手动去设置尺寸，更为常见，就是能过将对应尺寸的资源放入对应dp文件夹来实现，如：\n\n* 要适配xhdpi，就将同名图片放入`res/drawable-xhdp/ic_icon.png`。\n* 要适配xhdpi，就将同名文件放入`res/layout-xhdpi/activity_main.xml`。\n* 要适配xhdpi，就将同名文件放入`res/values-xhdpi/dimens.xml`中。\n\n如果使用dp会在相应`屏幕密度`分级区间自行按对应倍数进行缩放，也就是说相当于覆盖了默认的`res/values/dimens.xml`中的参数，然后进入*系统适配*（按对应倍数进行缩放），px则不会进行缩放，例如(res/values-xhdpi/dimens.xml)：\n\n```xml\n  <?xml version=\"1.0\" encoding=\"utf-8\"?>\n  <resources>\n      <dimen name=\"text_margin_top\">5dp</dimen> //缩放之后的px=10\n      <dimen name=\"text_margin_end\">5dp</dimen>\n      <dimen name=\"text_margin_start\">10px</dimen>//不会缩放px=10\n      <dimen name=\"text_margin_bottom\">15px</dimen>\n  </resources>\n```\n当前应用如果适配的dpi不匹配设备时，系统会先找比设备dpi更大最近的以适配的dpi，然后是更小最近的，一直到mdpi也就是默认适配文件。例如：\n\n* 当前应用适配有hdpi、xxdpi、xxxdpi，设备的dpi为xhdpi，于是系统给应用分配的是xxdpi中的参数。\n* 当前应用适配有hdpi，设备的dpi为xhdpi，于是系统给应用分配的是hdpi中的参数。\n* 当前应用适配有ldpi，设备的dpi为xhdpi，于是系统给应用分配的是mdpi(也就是默认值)中的参数。\n\n### 使用代码强行设置应用显示的`屏幕密度`(dpi)\n这种方式可以比如只适配了xhdpi，想在其它的dpi中也按xhdpi进行绘制。\n\n```java\n    private float sNoCompatDensity;\n    private float sNoCompatScaledDensity;\n\n    /**\n     * 强制设置dpi\n     *\n     * @param targetDP 密度屏幕(160,240,360...)\n     * @param isV      是否横屏\n     */\n    private void setCustomDensity(int targetDP, boolean isV) {\n        DisplayMetrics appDisplayMetrics = getResources().getDisplayMetrics();\n        if (sNoCompatDensity == 0) {\n            sNoCompatDensity = appDisplayMetrics.density;\n            sNoCompatScaledDensity = appDisplayMetrics.scaledDensity;\n        }\n\n        float targetDensity;\n        if (isV) {\n            targetDensity =\n                    (float) appDisplayMetrics.heightPixels / (appDisplayMetrics.heightPixels / (targetDP / 160F));\n        } else {\n            targetDensity =\n                    (float) appDisplayMetrics.widthPixels / (appDisplayMetrics.heightPixels / (targetDP / 160F));\n        }\n        float targetScaledDensity = targetDensity * (sNoCompatScaledDensity / sNoCompatDensity);\n        int targetDensityDpi = (int) (160 * targetDensity);\n\n        appDisplayMetrics.density = targetDensity;\n        appDisplayMetrics.scaledDensity = targetScaledDensity;\n        appDisplayMetrics.densityDpi = targetDensityDpi;\n    }\n```\n### **使用最小宽度限定符(smallestWidth)进行适配**\n> 屏幕的基本尺寸，由可用屏幕区域的最小尺寸指定。具体而言，设备的 smallestWidth 是屏幕可用高度和宽度的最小尺寸（您也可将其视为屏幕的“最小可能宽度”）。无论屏幕的当前方向如何，您均可使用此限定符确保应用界面的可用宽度至少为  dp。\n例如，如果布局要求屏幕区域的最小尺寸始终至少为 600dp，则可使用此限定符创建布局资源 res/layout-sw600dp/。仅当可用屏幕的最小尺寸至少为 600dp（无论 600dp 表示的边是用户所认为的高度还是宽度）时，系统才会使用这些资源。最小宽度为设备的固定屏幕尺寸特征；即使屏幕方向发生变化，设备的最小宽度仍会保持不变。\n\n该最小宽度的计算方式为：`屏幕宽度(px)/屏幕密度缩放倍数`。如你的屏幕为720x1280 xhdpi，那么720/2=360。\n\n使用如下：`res/values-sw360dp/dimens.xml`，就是满足最小宽度(dp)为360dpi的屏幕进行适配，这种方式是分辨率+屏幕密度(dpi)，算是现在对于**多尺寸屏幕适配**比较好的方案。\n\n### **可用宽度(高度)限定符进行适配**\n> 您可能希望根据当前可用的宽度或高度来更改布局，而不是根据屏幕的最小宽度来更改布局。例如，如果您有一个双窗格布局，您可能希望在屏幕宽度至少为 600dp 时使用该布局，但屏幕宽度可能会根据设备的屏幕方向是横向还是纵向而发生变化。\n\n使用**最小宽度限定符**的适配方式对于等比例屏幕效果比较好，如果是屏幕长宽比例较大时就不太适用，这时可以使用**可用宽度(高度)符**，这两种方案搭配几乎可以满足所有适配需求。\n\n计算方式为与**最小宽度限定符**一样。\n\n使用如下：`res/values-w360dp/dimens.xml`，就是满足宽度(dp)为360dpi的屏幕进行适配或者`res/values-h720dp/dimens.xml`就是满足高度(dp)为720dpi的屏幕进行适配。\n\n## 相关其它\n### dp与px的转换规则\n```\npx = dp * (dpi / 160)\n```\n`dpi`：由上表可得，就是每平方英寸可显示的像素数量，如mdpi\\~240dpi。\n\n### 设计图中的px与dp转换\n在Photoshop中的\\*\\*像素/英寸 (ppi)\\*\\*与Android的`屏幕密度`(dpi)基本是一个概念，于是在设计图(320ppi)中一个控件的外边距为10px，由上面的转换规则可知`dp=px/(dpi/160)`，这里就是10/(320/160)=5，也就是在xhdpi的布局中对应控件的外边距为5dp。\n\n### 改变设备的`屏幕密度`(dpi)\n获取设备屏幕分辨率：`adb shell wm size`获取设备`屏幕密度`(dpi)：`adb shell wm density`设置`屏幕密度`(dpi) ：`adb shell wm density 320`重置`屏幕密度`(dpi) ：`adb shell wm density reset`\n\n**注意**：虽然改变了系统的参数，但是系统判断自定义适配规制是无效的，会跳过当前dpi，但是`最小宽度限定符`是生效的。例如：\n\n* 当前应用适配有hdpi、xxdpi、xxxdpi，给设备设置的是hdpi，于是系统给应用分配的是xxdpi中的参数。\n* 当前应用适配有sw480dp，给设备(720p)设置的是hdpi，是正常的。\n\n### 获取屏幕参数代码片段\n```java\n    public void getAndroiodScreenProperty() {\n        WindowManager wm = (WindowManager) getSystemService(Context.WINDOW_SERVICE);\n        DisplayMetrics dm = new DisplayMetrics();\n        wm.getDefaultDisplay().getMetrics(dm);\n        int width = dm.widthPixels;         // 屏幕宽度（像素）\n        int height = dm.heightPixels;       // 屏幕高度（像素）\n        float density = dm.density;         // 屏幕密度（0.75 / 1.0 / 1.5）\n        int densityDpi = dm.densityDpi;     // 屏幕密度dpi（120 / 160 / 240）\n        // 屏幕宽度算法:屏幕宽度（像素）/屏幕密度\n        int screenWidth = (int) (width / density);  // 屏幕宽度(dp)\n        int screenHeight = (int) (height / density);// 屏幕高度(dp)\n\n        Log.d(TAG, \"屏幕宽度（像素）：\" + width);\n        Log.d(TAG, \"屏幕高度（像素）：\" + height);\n        Log.d(TAG, \"屏幕密度（0.75 / 1.0 / 1.5）：\" + density);\n        Log.d(TAG, \"屏幕密度dpi（120 / 160 / 240）：\" + densityDpi);\n        Log.d(TAG, \"屏幕宽度（dp）：\" + screenWidth);\n        Log.d(TAG, \"屏幕高度（dp）：\" + screenHeight);\n    }\n```\n## 参考\n* [支持不同的屏幕尺寸](https://developer.android.com/training/multiscreen/screensizes)\n* [支持不同的像素密度](https://developer.android.com/training/multiscreen/screendensities)\n* [推荐Android两种屏幕适配方案 ](https://juejin.cn/post/6844903612926296072#heading-10)\n* [Android获取屏幕的宽度和高度(dp)](https://blog.csdn.net/wangliblog/article/details/22501141)\n* [Android屏幕values-sw适配](https://blog.csdn.net/nihaomabmt/article/details/71215507)","slug":"android-dp-and-screen-adaptation","published":1,"updated":"2023-06-30T13:34:34.848Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cljiok5go0003t0iz9vk27xyu","content":"<h2 id=\"密度无关像素-density-independent-pixels\"><a href=\"#密度无关像素-density-independent-pixels\" class=\"headerlink\" title=\"密度无关像素(density-independent pixels)\"></a>密度无关像素(density-independent pixels)</h2><blockquote>\n<p>Android 设备不仅有不同的屏幕尺寸（手机、平板电脑、电视等），而且其屏幕也有不同的像素尺寸。也就是说，有可能一部设备的屏幕为每平方英寸 160 像素，而另一部设备的屏幕在相同的空间内可以容纳 480  像素。如果您不考虑像素密度的这些差异，系统可能会缩放图片（导致图片变模糊），或者图片可能会以完全错误的尺寸显示。</p>\n</blockquote>\n<p>如果开发者只对屏幕<code>分辨率</code>进行适配，也就是说使用<code>像素(px)</code>作为度量单位，那么在同一<code>分辨率</code>下的布局，在不同<code>像素密度</code>的屏幕中的显示完全不同。为了应对这种情况，Android引入了<code>密度无关像素(dp)</code>来作为度量单位，但<strong>最终的渲染还是使用像素(px)为度量单位</strong>，dp是做为一种中间值的存在。</p>\n<blockquote>\n<p>密度无关像素(dp)是一个虚拟像素单位，1 dp 约等于<code>中密度屏幕</code>（160dpi；“基准”密度）上的 1 像素。对于其他每个密度，Android 会将此值转换为相应的实际像素数。</p>\n</blockquote>\n<p>Android支持多种多样的<code>屏幕密度</code>，但是开发者不可能对每种都进行适配，于是将<code>屏幕密度</code>按一定关系进行划分，开发者只适配同一区间的<code>屏幕密度</code>成为一种比较好的方案。Android的<code>屏幕密度</code>分级区间，系统会基于不同区间自行按对应倍数进行缩放（包括布局和图片），开发者也可以基于这些区间规制自行适配，区间如下：</p>\n<table>\n<thead>\n<tr>\n<th>密度限定符</th>\n<th>说明</th>\n<th><strong>缩放倍数</strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>ldpi</td>\n<td>适用于低密度 (ldpi) 屏幕 (~ 120dpi) 的资源。（在120dpi左右，而非固定值，不同系统也是有差距的）</td>\n<td>0.75（px&#x3D;dp*0.75）</td>\n</tr>\n<tr>\n<td>mdpi</td>\n<td>适用于中密度 (mdpi) 屏幕 (~ 160dpi) 的资源（这是基准密度）。默认的layout，dimens也是基于此。</td>\n<td>1.0（px&#x3D;dp)</td>\n</tr>\n<tr>\n<td>hdpi</td>\n<td>适用于高密度 (hdpi) 屏幕 (~ 240dpi) 的资源。</td>\n<td>1.5（px&#x3D;dp*1.5）</td>\n</tr>\n<tr>\n<td>xhdpi</td>\n<td>适用于加高 (xhdpi) 密度屏幕 (~ 320dpi) 的资源。</td>\n<td>2.0（px&#x3D;dp*2）</td>\n</tr>\n<tr>\n<td>xxhdpi</td>\n<td>适用于超超高密度 (xxhdpi) 屏幕 (~ 480dpi) 的资源。</td>\n<td>3.0（px&#x3D;dp*3）</td>\n</tr>\n<tr>\n<td>xxxhdpi</td>\n<td>适用于超超超高密度 (xxxhdpi) 屏幕 (~ 640dpi) 的资源。</td>\n<td>4.0（px&#x3D;dp*4）</td>\n</tr>\n<tr>\n<td>nodpi</td>\n<td>适用于所有密度的资源。这些是与密度无关的资源。无论当前屏幕的密度是多少，系统都不会缩放以此限定符标记的资源。</td>\n<td></td>\n</tr>\n<tr>\n<td>tvdpi</td>\n<td>适用于密度介于 mdpi 和 hdpi 之间的屏幕（约 213dpi）的资源。这不属于“主要”密度组。它主要用于电视，而大多数应用都不需要它。对于大多数应用而言，提供 mdpi 和 hdpi 资源便已足够，系统将视情况对其进行缩放。如果您发现有必要提供 tvdpi 资源，应按一个系数来确定其大小，即 1.33*mdpi。例如，如果某张图片在 mdpi 屏幕上的大小为 100px x 100px，那么它在 tvdpi 屏幕上的大小应该为 133px x 133px。</td>\n<td>1.33（px&#x3D;dp*1.33）</td>\n</tr>\n</tbody></table>\n<p>例如，你在中密度屏幕上的一个控件或者图片，大小为 48x48 像素，那么它在其他各种密度的屏幕上的大小应该为：</p>\n<ul>\n<li>36x36 (0.75x) - 低密度 (ldpi)</li>\n<li>48x48（1.0x 基准）- 中密度 (mdpi)</li>\n<li>72x72 (1.5x) - 高密度 (hdpi)</li>\n<li>96x96 (2.0x) - 超高密度 (xhdpi)</li>\n<li>144x144 (3.0x) - 超超高密度 (xxhdpi)</li>\n<li>192x192 (4.0x) - 超超超高密度 (xxxhdpi)</li>\n</ul>\n<h2 id=\"如何使用密度无关像素进行适配屏幕\"><a href=\"#如何使用密度无关像素进行适配屏幕\" class=\"headerlink\" title=\"如何使用密度无关像素进行适配屏幕\"></a>如何使用密度无关像素进行适配屏幕</h2><h3 id=\"系统适配\"><a href=\"#系统适配\" class=\"headerlink\" title=\"系统适配\"></a>系统适配</h3><ul>\n<li>图片文件48x48（res&#x2F;drawable&#x2F;ic_icon.png）</li>\n<li>布局文件（res&#x2F;layout&#x2F;activity_main.xml）</li>\n</ul>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span> encoding=<span class=\"string\">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">FrameLayout</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">&quot;match_parent&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">&quot;match_parent&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">TextView</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:layout_marginTop</span>=<span class=\"string\">&quot;@dimen/text_margin_top&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:layout_marginEnd</span>=<span class=\"string\">&quot;@dimen/text_margin_end&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:layout_marginStart</span>=<span class=\"string\">&quot;@dimen/text_margin_start&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:layout_marginBottom</span>=<span class=\"string\">&quot;@dimen/text_margin_bottom&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">&quot;wrap_content&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">&quot;wrap_content&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:text</span>=<span class=\"string\">&quot;@string/app_name&quot;</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">FrameLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>资源尺寸文件（res&#x2F;values&#x2F;dimens.xml）</li>\n</ul>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span> encoding=<span class=\"string\">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">resources</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dimen</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;text_margin_top&quot;</span>&gt;</span>15dp<span class=\"tag\">&lt;/<span class=\"name\">dimen</span>&gt;</span>//缩放之后的px=15*缩放倍数</span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dimen</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;text_margin_end&quot;</span>&gt;</span>10dp<span class=\"tag\">&lt;/<span class=\"name\">dimen</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dimen</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;text_margin_start&quot;</span>&gt;</span>20dp<span class=\"tag\">&lt;/<span class=\"name\">dimen</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dimen</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;text_margin_bottom&quot;</span>&gt;</span>20px<span class=\"tag\">&lt;/<span class=\"name\">dimen</span>&gt;</span>//不会缩放px=20</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>系统会根据<code>屏幕密度</code>分级区间自行按对应倍数进行缩放，在中密度 (mdpi)下<code>text_margin_top</code>的<code>像素</code>为15，在超高密度 (xhdpi)下，<code>text_margin_top</code>的<code>像素</code>为15x2.0，<code>ic_icon.png</code>的<code>像素</code>为96x96。</p>\n<h3 id=\"自定义适配\"><a href=\"#自定义适配\" class=\"headerlink\" title=\"自定义适配\"></a>自定义适配</h3><p>系统的缩放比在一定条件下，是可以保证应用的显示正常，但是往往不一定那么理想，于是手动去设置尺寸，更为常见，就是能过将对应尺寸的资源放入对应dp文件夹来实现，如：</p>\n<ul>\n<li>要适配xhdpi，就将同名图片放入<code>res/drawable-xhdp/ic_icon.png</code>。</li>\n<li>要适配xhdpi，就将同名文件放入<code>res/layout-xhdpi/activity_main.xml</code>。</li>\n<li>要适配xhdpi，就将同名文件放入<code>res/values-xhdpi/dimens.xml</code>中。</li>\n</ul>\n<p>如果使用dp会在相应<code>屏幕密度</code>分级区间自行按对应倍数进行缩放，也就是说相当于覆盖了默认的<code>res/values/dimens.xml</code>中的参数，然后进入<em>系统适配</em>（按对应倍数进行缩放），px则不会进行缩放，例如(res&#x2F;values-xhdpi&#x2F;dimens.xml)：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span> encoding=<span class=\"string\">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">resources</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dimen</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;text_margin_top&quot;</span>&gt;</span>5dp<span class=\"tag\">&lt;/<span class=\"name\">dimen</span>&gt;</span> //缩放之后的px=10</span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dimen</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;text_margin_end&quot;</span>&gt;</span>5dp<span class=\"tag\">&lt;/<span class=\"name\">dimen</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dimen</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;text_margin_start&quot;</span>&gt;</span>10px<span class=\"tag\">&lt;/<span class=\"name\">dimen</span>&gt;</span>//不会缩放px=10</span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dimen</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;text_margin_bottom&quot;</span>&gt;</span>15px<span class=\"tag\">&lt;/<span class=\"name\">dimen</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>当前应用如果适配的dpi不匹配设备时，系统会先找比设备dpi更大最近的以适配的dpi，然后是更小最近的，一直到mdpi也就是默认适配文件。例如：</p>\n<ul>\n<li>当前应用适配有hdpi、xxdpi、xxxdpi，设备的dpi为xhdpi，于是系统给应用分配的是xxdpi中的参数。</li>\n<li>当前应用适配有hdpi，设备的dpi为xhdpi，于是系统给应用分配的是hdpi中的参数。</li>\n<li>当前应用适配有ldpi，设备的dpi为xhdpi，于是系统给应用分配的是mdpi(也就是默认值)中的参数。</li>\n</ul>\n<h3 id=\"使用代码强行设置应用显示的屏幕密度-dpi\"><a href=\"#使用代码强行设置应用显示的屏幕密度-dpi\" class=\"headerlink\" title=\"使用代码强行设置应用显示的屏幕密度(dpi)\"></a>使用代码强行设置应用显示的<code>屏幕密度</code>(dpi)</h3><p>这种方式可以比如只适配了xhdpi，想在其它的dpi中也按xhdpi进行绘制。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">float</span> sNoCompatDensity;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">float</span> sNoCompatScaledDensity;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 强制设置dpi</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> targetDP 密度屏幕(160,240,360...)</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> isV      是否横屏</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setCustomDensity</span><span class=\"params\">(<span class=\"type\">int</span> targetDP, <span class=\"type\">boolean</span> isV)</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">DisplayMetrics</span> <span class=\"variable\">appDisplayMetrics</span> <span class=\"operator\">=</span> getResources().getDisplayMetrics();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (sNoCompatDensity == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        sNoCompatDensity = appDisplayMetrics.density;</span><br><span class=\"line\">        sNoCompatScaledDensity = appDisplayMetrics.scaledDensity;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"type\">float</span> targetDensity;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (isV) &#123;</span><br><span class=\"line\">        targetDensity =</span><br><span class=\"line\">                (<span class=\"type\">float</span>) appDisplayMetrics.heightPixels / (appDisplayMetrics.heightPixels / (targetDP / <span class=\"number\">160F</span>));</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        targetDensity =</span><br><span class=\"line\">                (<span class=\"type\">float</span>) appDisplayMetrics.widthPixels / (appDisplayMetrics.heightPixels / (targetDP / <span class=\"number\">160F</span>));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"type\">float</span> <span class=\"variable\">targetScaledDensity</span> <span class=\"operator\">=</span> targetDensity * (sNoCompatScaledDensity / sNoCompatDensity);</span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">targetDensityDpi</span> <span class=\"operator\">=</span> (<span class=\"type\">int</span>) (<span class=\"number\">160</span> * targetDensity);</span><br><span class=\"line\"></span><br><span class=\"line\">    appDisplayMetrics.density = targetDensity;</span><br><span class=\"line\">    appDisplayMetrics.scaledDensity = targetScaledDensity;</span><br><span class=\"line\">    appDisplayMetrics.densityDpi = targetDensityDpi;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"使用最小宽度限定符-smallestWidth-进行适配\"><a href=\"#使用最小宽度限定符-smallestWidth-进行适配\" class=\"headerlink\" title=\"使用最小宽度限定符(smallestWidth)进行适配\"></a><strong>使用最小宽度限定符(smallestWidth)进行适配</strong></h3><blockquote>\n<p>屏幕的基本尺寸，由可用屏幕区域的最小尺寸指定。具体而言，设备的 smallestWidth 是屏幕可用高度和宽度的最小尺寸（您也可将其视为屏幕的“最小可能宽度”）。无论屏幕的当前方向如何，您均可使用此限定符确保应用界面的可用宽度至少为  dp。<br>例如，如果布局要求屏幕区域的最小尺寸始终至少为 600dp，则可使用此限定符创建布局资源 res&#x2F;layout-sw600dp&#x2F;。仅当可用屏幕的最小尺寸至少为 600dp（无论 600dp 表示的边是用户所认为的高度还是宽度）时，系统才会使用这些资源。最小宽度为设备的固定屏幕尺寸特征；即使屏幕方向发生变化，设备的最小宽度仍会保持不变。</p>\n</blockquote>\n<p>该最小宽度的计算方式为：<code>屏幕宽度(px)/屏幕密度缩放倍数</code>。如你的屏幕为720x1280 xhdpi，那么720&#x2F;2&#x3D;360。</p>\n<p>使用如下：<code>res/values-sw360dp/dimens.xml</code>，就是满足最小宽度(dp)为360dpi的屏幕进行适配，这种方式是分辨率+屏幕密度(dpi)，算是现在对于<strong>多尺寸屏幕适配</strong>比较好的方案。</p>\n<h3 id=\"可用宽度-高度-限定符进行适配\"><a href=\"#可用宽度-高度-限定符进行适配\" class=\"headerlink\" title=\"可用宽度(高度)限定符进行适配\"></a><strong>可用宽度(高度)限定符进行适配</strong></h3><blockquote>\n<p>您可能希望根据当前可用的宽度或高度来更改布局，而不是根据屏幕的最小宽度来更改布局。例如，如果您有一个双窗格布局，您可能希望在屏幕宽度至少为 600dp 时使用该布局，但屏幕宽度可能会根据设备的屏幕方向是横向还是纵向而发生变化。</p>\n</blockquote>\n<p>使用<strong>最小宽度限定符</strong>的适配方式对于等比例屏幕效果比较好，如果是屏幕长宽比例较大时就不太适用，这时可以使用<strong>可用宽度(高度)符</strong>，这两种方案搭配几乎可以满足所有适配需求。</p>\n<p>计算方式为与<strong>最小宽度限定符</strong>一样。</p>\n<p>使用如下：<code>res/values-w360dp/dimens.xml</code>，就是满足宽度(dp)为360dpi的屏幕进行适配或者<code>res/values-h720dp/dimens.xml</code>就是满足高度(dp)为720dpi的屏幕进行适配。</p>\n<h2 id=\"相关其它\"><a href=\"#相关其它\" class=\"headerlink\" title=\"相关其它\"></a>相关其它</h2><h3 id=\"dp与px的转换规则\"><a href=\"#dp与px的转换规则\" class=\"headerlink\" title=\"dp与px的转换规则\"></a>dp与px的转换规则</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">px = dp * (dpi / 160)</span><br></pre></td></tr></table></figure>\n<p><code>dpi</code>：由上表可得，就是每平方英寸可显示的像素数量，如mdpi~240dpi。</p>\n<h3 id=\"设计图中的px与dp转换\"><a href=\"#设计图中的px与dp转换\" class=\"headerlink\" title=\"设计图中的px与dp转换\"></a>设计图中的px与dp转换</h3><p>在Photoshop中的**像素&#x2F;英寸 (ppi)**与Android的<code>屏幕密度</code>(dpi)基本是一个概念，于是在设计图(320ppi)中一个控件的外边距为10px，由上面的转换规则可知<code>dp=px/(dpi/160)</code>，这里就是10&#x2F;(320&#x2F;160)&#x3D;5，也就是在xhdpi的布局中对应控件的外边距为5dp。</p>\n<h3 id=\"改变设备的屏幕密度-dpi\"><a href=\"#改变设备的屏幕密度-dpi\" class=\"headerlink\" title=\"改变设备的屏幕密度(dpi)\"></a>改变设备的<code>屏幕密度</code>(dpi)</h3><p>获取设备屏幕分辨率：<code>adb shell wm size</code>获取设备<code>屏幕密度</code>(dpi)：<code>adb shell wm density</code>设置<code>屏幕密度</code>(dpi) ：<code>adb shell wm density 320</code>重置<code>屏幕密度</code>(dpi) ：<code>adb shell wm density reset</code></p>\n<p><strong>注意</strong>：虽然改变了系统的参数，但是系统判断自定义适配规制是无效的，会跳过当前dpi，但是<code>最小宽度限定符</code>是生效的。例如：</p>\n<ul>\n<li>当前应用适配有hdpi、xxdpi、xxxdpi，给设备设置的是hdpi，于是系统给应用分配的是xxdpi中的参数。</li>\n<li>当前应用适配有sw480dp，给设备(720p)设置的是hdpi，是正常的。</li>\n</ul>\n<h3 id=\"获取屏幕参数代码片段\"><a href=\"#获取屏幕参数代码片段\" class=\"headerlink\" title=\"获取屏幕参数代码片段\"></a>获取屏幕参数代码片段</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">getAndroiodScreenProperty</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">WindowManager</span> <span class=\"variable\">wm</span> <span class=\"operator\">=</span> (WindowManager) getSystemService(Context.WINDOW_SERVICE);</span><br><span class=\"line\">    <span class=\"type\">DisplayMetrics</span> <span class=\"variable\">dm</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">DisplayMetrics</span>();</span><br><span class=\"line\">    wm.getDefaultDisplay().getMetrics(dm);</span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">width</span> <span class=\"operator\">=</span> dm.widthPixels;         <span class=\"comment\">// 屏幕宽度（像素）</span></span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">height</span> <span class=\"operator\">=</span> dm.heightPixels;       <span class=\"comment\">// 屏幕高度（像素）</span></span><br><span class=\"line\">    <span class=\"type\">float</span> <span class=\"variable\">density</span> <span class=\"operator\">=</span> dm.density;         <span class=\"comment\">// 屏幕密度（0.75 / 1.0 / 1.5）</span></span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">densityDpi</span> <span class=\"operator\">=</span> dm.densityDpi;     <span class=\"comment\">// 屏幕密度dpi（120 / 160 / 240）</span></span><br><span class=\"line\">    <span class=\"comment\">// 屏幕宽度算法:屏幕宽度（像素）/屏幕密度</span></span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">screenWidth</span> <span class=\"operator\">=</span> (<span class=\"type\">int</span>) (width / density);  <span class=\"comment\">// 屏幕宽度(dp)</span></span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">screenHeight</span> <span class=\"operator\">=</span> (<span class=\"type\">int</span>) (height / density);<span class=\"comment\">// 屏幕高度(dp)</span></span><br><span class=\"line\"></span><br><span class=\"line\">    Log.d(TAG, <span class=\"string\">&quot;屏幕宽度（像素）：&quot;</span> + width);</span><br><span class=\"line\">    Log.d(TAG, <span class=\"string\">&quot;屏幕高度（像素）：&quot;</span> + height);</span><br><span class=\"line\">    Log.d(TAG, <span class=\"string\">&quot;屏幕密度（0.75 / 1.0 / 1.5）：&quot;</span> + density);</span><br><span class=\"line\">    Log.d(TAG, <span class=\"string\">&quot;屏幕密度dpi（120 / 160 / 240）：&quot;</span> + densityDpi);</span><br><span class=\"line\">    Log.d(TAG, <span class=\"string\">&quot;屏幕宽度（dp）：&quot;</span> + screenWidth);</span><br><span class=\"line\">    Log.d(TAG, <span class=\"string\">&quot;屏幕高度（dp）：&quot;</span> + screenHeight);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ul>\n<li><a href=\"https://developer.android.com/training/multiscreen/screensizes\">支持不同的屏幕尺寸</a></li>\n<li><a href=\"https://developer.android.com/training/multiscreen/screendensities\">支持不同的像素密度</a></li>\n<li><a href=\"https://juejin.cn/post/6844903612926296072#heading-10\">推荐Android两种屏幕适配方案 </a></li>\n<li><a href=\"https://blog.csdn.net/wangliblog/article/details/22501141\">Android获取屏幕的宽度和高度(dp)</a></li>\n<li><a href=\"https://blog.csdn.net/nihaomabmt/article/details/71215507\">Android屏幕values-sw适配</a></li>\n</ul>\n","site":{"data":{"next":{"favicon":{"small":"/images/favicon-16x16.png","medium":"/images/favicon-32x32.png","apple_touch_icon":"/images/apple-touch-icon.png","safari_pinned_tab":"/images/safari_pinned_tab.svg"},"creative_commons":{"license":"by-nc-sa","sidebar":true,"post":true,"language":"deed.zh"},"scheme":"Gemini","darkmode":true,"avatar":{"url":"/images/avatar.jpg","rounded":true,"rotated":false},"social":{"GitHub":"https://github.com/liaoheng || fab fa-github","RSS":"/atom.xml || fa fa-rss"},"social_icons":{"enable":true,"icons_only":true,"transition":true},"codeblock":{"highlight_theme":"normal","copy_button":{"enable":true,"show_result":true,"style":null}},"github_banner":{"enable":true,"permalink":"https://github.com/liaoheng","title":"Follow me on GitHub"},"google_analytics":{"tracking_id":"G-64FL8LWFL8","only_pageview":false},"vendors":{"pace":"//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js","pace_css":"//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css"},"pace":{"enable":true,"theme":"minimal"}}}},"excerpt":"","more":"<h2 id=\"密度无关像素-density-independent-pixels\"><a href=\"#密度无关像素-density-independent-pixels\" class=\"headerlink\" title=\"密度无关像素(density-independent pixels)\"></a>密度无关像素(density-independent pixels)</h2><blockquote>\n<p>Android 设备不仅有不同的屏幕尺寸（手机、平板电脑、电视等），而且其屏幕也有不同的像素尺寸。也就是说，有可能一部设备的屏幕为每平方英寸 160 像素，而另一部设备的屏幕在相同的空间内可以容纳 480  像素。如果您不考虑像素密度的这些差异，系统可能会缩放图片（导致图片变模糊），或者图片可能会以完全错误的尺寸显示。</p>\n</blockquote>\n<p>如果开发者只对屏幕<code>分辨率</code>进行适配，也就是说使用<code>像素(px)</code>作为度量单位，那么在同一<code>分辨率</code>下的布局，在不同<code>像素密度</code>的屏幕中的显示完全不同。为了应对这种情况，Android引入了<code>密度无关像素(dp)</code>来作为度量单位，但<strong>最终的渲染还是使用像素(px)为度量单位</strong>，dp是做为一种中间值的存在。</p>\n<blockquote>\n<p>密度无关像素(dp)是一个虚拟像素单位，1 dp 约等于<code>中密度屏幕</code>（160dpi；“基准”密度）上的 1 像素。对于其他每个密度，Android 会将此值转换为相应的实际像素数。</p>\n</blockquote>\n<p>Android支持多种多样的<code>屏幕密度</code>，但是开发者不可能对每种都进行适配，于是将<code>屏幕密度</code>按一定关系进行划分，开发者只适配同一区间的<code>屏幕密度</code>成为一种比较好的方案。Android的<code>屏幕密度</code>分级区间，系统会基于不同区间自行按对应倍数进行缩放（包括布局和图片），开发者也可以基于这些区间规制自行适配，区间如下：</p>\n<table>\n<thead>\n<tr>\n<th>密度限定符</th>\n<th>说明</th>\n<th><strong>缩放倍数</strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>ldpi</td>\n<td>适用于低密度 (ldpi) 屏幕 (~ 120dpi) 的资源。（在120dpi左右，而非固定值，不同系统也是有差距的）</td>\n<td>0.75（px&#x3D;dp*0.75）</td>\n</tr>\n<tr>\n<td>mdpi</td>\n<td>适用于中密度 (mdpi) 屏幕 (~ 160dpi) 的资源（这是基准密度）。默认的layout，dimens也是基于此。</td>\n<td>1.0（px&#x3D;dp)</td>\n</tr>\n<tr>\n<td>hdpi</td>\n<td>适用于高密度 (hdpi) 屏幕 (~ 240dpi) 的资源。</td>\n<td>1.5（px&#x3D;dp*1.5）</td>\n</tr>\n<tr>\n<td>xhdpi</td>\n<td>适用于加高 (xhdpi) 密度屏幕 (~ 320dpi) 的资源。</td>\n<td>2.0（px&#x3D;dp*2）</td>\n</tr>\n<tr>\n<td>xxhdpi</td>\n<td>适用于超超高密度 (xxhdpi) 屏幕 (~ 480dpi) 的资源。</td>\n<td>3.0（px&#x3D;dp*3）</td>\n</tr>\n<tr>\n<td>xxxhdpi</td>\n<td>适用于超超超高密度 (xxxhdpi) 屏幕 (~ 640dpi) 的资源。</td>\n<td>4.0（px&#x3D;dp*4）</td>\n</tr>\n<tr>\n<td>nodpi</td>\n<td>适用于所有密度的资源。这些是与密度无关的资源。无论当前屏幕的密度是多少，系统都不会缩放以此限定符标记的资源。</td>\n<td></td>\n</tr>\n<tr>\n<td>tvdpi</td>\n<td>适用于密度介于 mdpi 和 hdpi 之间的屏幕（约 213dpi）的资源。这不属于“主要”密度组。它主要用于电视，而大多数应用都不需要它。对于大多数应用而言，提供 mdpi 和 hdpi 资源便已足够，系统将视情况对其进行缩放。如果您发现有必要提供 tvdpi 资源，应按一个系数来确定其大小，即 1.33*mdpi。例如，如果某张图片在 mdpi 屏幕上的大小为 100px x 100px，那么它在 tvdpi 屏幕上的大小应该为 133px x 133px。</td>\n<td>1.33（px&#x3D;dp*1.33）</td>\n</tr>\n</tbody></table>\n<p>例如，你在中密度屏幕上的一个控件或者图片，大小为 48x48 像素，那么它在其他各种密度的屏幕上的大小应该为：</p>\n<ul>\n<li>36x36 (0.75x) - 低密度 (ldpi)</li>\n<li>48x48（1.0x 基准）- 中密度 (mdpi)</li>\n<li>72x72 (1.5x) - 高密度 (hdpi)</li>\n<li>96x96 (2.0x) - 超高密度 (xhdpi)</li>\n<li>144x144 (3.0x) - 超超高密度 (xxhdpi)</li>\n<li>192x192 (4.0x) - 超超超高密度 (xxxhdpi)</li>\n</ul>\n<h2 id=\"如何使用密度无关像素进行适配屏幕\"><a href=\"#如何使用密度无关像素进行适配屏幕\" class=\"headerlink\" title=\"如何使用密度无关像素进行适配屏幕\"></a>如何使用密度无关像素进行适配屏幕</h2><h3 id=\"系统适配\"><a href=\"#系统适配\" class=\"headerlink\" title=\"系统适配\"></a>系统适配</h3><ul>\n<li>图片文件48x48（res&#x2F;drawable&#x2F;ic_icon.png）</li>\n<li>布局文件（res&#x2F;layout&#x2F;activity_main.xml）</li>\n</ul>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span> encoding=<span class=\"string\">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">FrameLayout</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">android:layout_width</span>=<span class=\"string\">&quot;match_parent&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">android:layout_height</span>=<span class=\"string\">&quot;match_parent&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">TextView</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:layout_marginTop</span>=<span class=\"string\">&quot;@dimen/text_margin_top&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:layout_marginEnd</span>=<span class=\"string\">&quot;@dimen/text_margin_end&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:layout_marginStart</span>=<span class=\"string\">&quot;@dimen/text_margin_start&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:layout_marginBottom</span>=<span class=\"string\">&quot;@dimen/text_margin_bottom&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:layout_width</span>=<span class=\"string\">&quot;wrap_content&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:layout_height</span>=<span class=\"string\">&quot;wrap_content&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">android:text</span>=<span class=\"string\">&quot;@string/app_name&quot;</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">FrameLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>资源尺寸文件（res&#x2F;values&#x2F;dimens.xml）</li>\n</ul>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span> encoding=<span class=\"string\">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">resources</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dimen</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;text_margin_top&quot;</span>&gt;</span>15dp<span class=\"tag\">&lt;/<span class=\"name\">dimen</span>&gt;</span>//缩放之后的px=15*缩放倍数</span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dimen</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;text_margin_end&quot;</span>&gt;</span>10dp<span class=\"tag\">&lt;/<span class=\"name\">dimen</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dimen</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;text_margin_start&quot;</span>&gt;</span>20dp<span class=\"tag\">&lt;/<span class=\"name\">dimen</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dimen</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;text_margin_bottom&quot;</span>&gt;</span>20px<span class=\"tag\">&lt;/<span class=\"name\">dimen</span>&gt;</span>//不会缩放px=20</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>系统会根据<code>屏幕密度</code>分级区间自行按对应倍数进行缩放，在中密度 (mdpi)下<code>text_margin_top</code>的<code>像素</code>为15，在超高密度 (xhdpi)下，<code>text_margin_top</code>的<code>像素</code>为15x2.0，<code>ic_icon.png</code>的<code>像素</code>为96x96。</p>\n<h3 id=\"自定义适配\"><a href=\"#自定义适配\" class=\"headerlink\" title=\"自定义适配\"></a>自定义适配</h3><p>系统的缩放比在一定条件下，是可以保证应用的显示正常，但是往往不一定那么理想，于是手动去设置尺寸，更为常见，就是能过将对应尺寸的资源放入对应dp文件夹来实现，如：</p>\n<ul>\n<li>要适配xhdpi，就将同名图片放入<code>res/drawable-xhdp/ic_icon.png</code>。</li>\n<li>要适配xhdpi，就将同名文件放入<code>res/layout-xhdpi/activity_main.xml</code>。</li>\n<li>要适配xhdpi，就将同名文件放入<code>res/values-xhdpi/dimens.xml</code>中。</li>\n</ul>\n<p>如果使用dp会在相应<code>屏幕密度</code>分级区间自行按对应倍数进行缩放，也就是说相当于覆盖了默认的<code>res/values/dimens.xml</code>中的参数，然后进入<em>系统适配</em>（按对应倍数进行缩放），px则不会进行缩放，例如(res&#x2F;values-xhdpi&#x2F;dimens.xml)：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span> encoding=<span class=\"string\">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">resources</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dimen</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;text_margin_top&quot;</span>&gt;</span>5dp<span class=\"tag\">&lt;/<span class=\"name\">dimen</span>&gt;</span> //缩放之后的px=10</span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dimen</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;text_margin_end&quot;</span>&gt;</span>5dp<span class=\"tag\">&lt;/<span class=\"name\">dimen</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dimen</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;text_margin_start&quot;</span>&gt;</span>10px<span class=\"tag\">&lt;/<span class=\"name\">dimen</span>&gt;</span>//不会缩放px=10</span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dimen</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;text_margin_bottom&quot;</span>&gt;</span>15px<span class=\"tag\">&lt;/<span class=\"name\">dimen</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>当前应用如果适配的dpi不匹配设备时，系统会先找比设备dpi更大最近的以适配的dpi，然后是更小最近的，一直到mdpi也就是默认适配文件。例如：</p>\n<ul>\n<li>当前应用适配有hdpi、xxdpi、xxxdpi，设备的dpi为xhdpi，于是系统给应用分配的是xxdpi中的参数。</li>\n<li>当前应用适配有hdpi，设备的dpi为xhdpi，于是系统给应用分配的是hdpi中的参数。</li>\n<li>当前应用适配有ldpi，设备的dpi为xhdpi，于是系统给应用分配的是mdpi(也就是默认值)中的参数。</li>\n</ul>\n<h3 id=\"使用代码强行设置应用显示的屏幕密度-dpi\"><a href=\"#使用代码强行设置应用显示的屏幕密度-dpi\" class=\"headerlink\" title=\"使用代码强行设置应用显示的屏幕密度(dpi)\"></a>使用代码强行设置应用显示的<code>屏幕密度</code>(dpi)</h3><p>这种方式可以比如只适配了xhdpi，想在其它的dpi中也按xhdpi进行绘制。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">float</span> sNoCompatDensity;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">float</span> sNoCompatScaledDensity;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 强制设置dpi</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> targetDP 密度屏幕(160,240,360...)</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> isV      是否横屏</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setCustomDensity</span><span class=\"params\">(<span class=\"type\">int</span> targetDP, <span class=\"type\">boolean</span> isV)</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">DisplayMetrics</span> <span class=\"variable\">appDisplayMetrics</span> <span class=\"operator\">=</span> getResources().getDisplayMetrics();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (sNoCompatDensity == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        sNoCompatDensity = appDisplayMetrics.density;</span><br><span class=\"line\">        sNoCompatScaledDensity = appDisplayMetrics.scaledDensity;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"type\">float</span> targetDensity;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (isV) &#123;</span><br><span class=\"line\">        targetDensity =</span><br><span class=\"line\">                (<span class=\"type\">float</span>) appDisplayMetrics.heightPixels / (appDisplayMetrics.heightPixels / (targetDP / <span class=\"number\">160F</span>));</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        targetDensity =</span><br><span class=\"line\">                (<span class=\"type\">float</span>) appDisplayMetrics.widthPixels / (appDisplayMetrics.heightPixels / (targetDP / <span class=\"number\">160F</span>));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"type\">float</span> <span class=\"variable\">targetScaledDensity</span> <span class=\"operator\">=</span> targetDensity * (sNoCompatScaledDensity / sNoCompatDensity);</span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">targetDensityDpi</span> <span class=\"operator\">=</span> (<span class=\"type\">int</span>) (<span class=\"number\">160</span> * targetDensity);</span><br><span class=\"line\"></span><br><span class=\"line\">    appDisplayMetrics.density = targetDensity;</span><br><span class=\"line\">    appDisplayMetrics.scaledDensity = targetScaledDensity;</span><br><span class=\"line\">    appDisplayMetrics.densityDpi = targetDensityDpi;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"使用最小宽度限定符-smallestWidth-进行适配\"><a href=\"#使用最小宽度限定符-smallestWidth-进行适配\" class=\"headerlink\" title=\"使用最小宽度限定符(smallestWidth)进行适配\"></a><strong>使用最小宽度限定符(smallestWidth)进行适配</strong></h3><blockquote>\n<p>屏幕的基本尺寸，由可用屏幕区域的最小尺寸指定。具体而言，设备的 smallestWidth 是屏幕可用高度和宽度的最小尺寸（您也可将其视为屏幕的“最小可能宽度”）。无论屏幕的当前方向如何，您均可使用此限定符确保应用界面的可用宽度至少为  dp。<br>例如，如果布局要求屏幕区域的最小尺寸始终至少为 600dp，则可使用此限定符创建布局资源 res&#x2F;layout-sw600dp&#x2F;。仅当可用屏幕的最小尺寸至少为 600dp（无论 600dp 表示的边是用户所认为的高度还是宽度）时，系统才会使用这些资源。最小宽度为设备的固定屏幕尺寸特征；即使屏幕方向发生变化，设备的最小宽度仍会保持不变。</p>\n</blockquote>\n<p>该最小宽度的计算方式为：<code>屏幕宽度(px)/屏幕密度缩放倍数</code>。如你的屏幕为720x1280 xhdpi，那么720&#x2F;2&#x3D;360。</p>\n<p>使用如下：<code>res/values-sw360dp/dimens.xml</code>，就是满足最小宽度(dp)为360dpi的屏幕进行适配，这种方式是分辨率+屏幕密度(dpi)，算是现在对于<strong>多尺寸屏幕适配</strong>比较好的方案。</p>\n<h3 id=\"可用宽度-高度-限定符进行适配\"><a href=\"#可用宽度-高度-限定符进行适配\" class=\"headerlink\" title=\"可用宽度(高度)限定符进行适配\"></a><strong>可用宽度(高度)限定符进行适配</strong></h3><blockquote>\n<p>您可能希望根据当前可用的宽度或高度来更改布局，而不是根据屏幕的最小宽度来更改布局。例如，如果您有一个双窗格布局，您可能希望在屏幕宽度至少为 600dp 时使用该布局，但屏幕宽度可能会根据设备的屏幕方向是横向还是纵向而发生变化。</p>\n</blockquote>\n<p>使用<strong>最小宽度限定符</strong>的适配方式对于等比例屏幕效果比较好，如果是屏幕长宽比例较大时就不太适用，这时可以使用<strong>可用宽度(高度)符</strong>，这两种方案搭配几乎可以满足所有适配需求。</p>\n<p>计算方式为与<strong>最小宽度限定符</strong>一样。</p>\n<p>使用如下：<code>res/values-w360dp/dimens.xml</code>，就是满足宽度(dp)为360dpi的屏幕进行适配或者<code>res/values-h720dp/dimens.xml</code>就是满足高度(dp)为720dpi的屏幕进行适配。</p>\n<h2 id=\"相关其它\"><a href=\"#相关其它\" class=\"headerlink\" title=\"相关其它\"></a>相关其它</h2><h3 id=\"dp与px的转换规则\"><a href=\"#dp与px的转换规则\" class=\"headerlink\" title=\"dp与px的转换规则\"></a>dp与px的转换规则</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">px = dp * (dpi / 160)</span><br></pre></td></tr></table></figure>\n<p><code>dpi</code>：由上表可得，就是每平方英寸可显示的像素数量，如mdpi~240dpi。</p>\n<h3 id=\"设计图中的px与dp转换\"><a href=\"#设计图中的px与dp转换\" class=\"headerlink\" title=\"设计图中的px与dp转换\"></a>设计图中的px与dp转换</h3><p>在Photoshop中的**像素&#x2F;英寸 (ppi)**与Android的<code>屏幕密度</code>(dpi)基本是一个概念，于是在设计图(320ppi)中一个控件的外边距为10px，由上面的转换规则可知<code>dp=px/(dpi/160)</code>，这里就是10&#x2F;(320&#x2F;160)&#x3D;5，也就是在xhdpi的布局中对应控件的外边距为5dp。</p>\n<h3 id=\"改变设备的屏幕密度-dpi\"><a href=\"#改变设备的屏幕密度-dpi\" class=\"headerlink\" title=\"改变设备的屏幕密度(dpi)\"></a>改变设备的<code>屏幕密度</code>(dpi)</h3><p>获取设备屏幕分辨率：<code>adb shell wm size</code>获取设备<code>屏幕密度</code>(dpi)：<code>adb shell wm density</code>设置<code>屏幕密度</code>(dpi) ：<code>adb shell wm density 320</code>重置<code>屏幕密度</code>(dpi) ：<code>adb shell wm density reset</code></p>\n<p><strong>注意</strong>：虽然改变了系统的参数，但是系统判断自定义适配规制是无效的，会跳过当前dpi，但是<code>最小宽度限定符</code>是生效的。例如：</p>\n<ul>\n<li>当前应用适配有hdpi、xxdpi、xxxdpi，给设备设置的是hdpi，于是系统给应用分配的是xxdpi中的参数。</li>\n<li>当前应用适配有sw480dp，给设备(720p)设置的是hdpi，是正常的。</li>\n</ul>\n<h3 id=\"获取屏幕参数代码片段\"><a href=\"#获取屏幕参数代码片段\" class=\"headerlink\" title=\"获取屏幕参数代码片段\"></a>获取屏幕参数代码片段</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">getAndroiodScreenProperty</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">WindowManager</span> <span class=\"variable\">wm</span> <span class=\"operator\">=</span> (WindowManager) getSystemService(Context.WINDOW_SERVICE);</span><br><span class=\"line\">    <span class=\"type\">DisplayMetrics</span> <span class=\"variable\">dm</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">DisplayMetrics</span>();</span><br><span class=\"line\">    wm.getDefaultDisplay().getMetrics(dm);</span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">width</span> <span class=\"operator\">=</span> dm.widthPixels;         <span class=\"comment\">// 屏幕宽度（像素）</span></span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">height</span> <span class=\"operator\">=</span> dm.heightPixels;       <span class=\"comment\">// 屏幕高度（像素）</span></span><br><span class=\"line\">    <span class=\"type\">float</span> <span class=\"variable\">density</span> <span class=\"operator\">=</span> dm.density;         <span class=\"comment\">// 屏幕密度（0.75 / 1.0 / 1.5）</span></span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">densityDpi</span> <span class=\"operator\">=</span> dm.densityDpi;     <span class=\"comment\">// 屏幕密度dpi（120 / 160 / 240）</span></span><br><span class=\"line\">    <span class=\"comment\">// 屏幕宽度算法:屏幕宽度（像素）/屏幕密度</span></span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">screenWidth</span> <span class=\"operator\">=</span> (<span class=\"type\">int</span>) (width / density);  <span class=\"comment\">// 屏幕宽度(dp)</span></span><br><span class=\"line\">    <span class=\"type\">int</span> <span class=\"variable\">screenHeight</span> <span class=\"operator\">=</span> (<span class=\"type\">int</span>) (height / density);<span class=\"comment\">// 屏幕高度(dp)</span></span><br><span class=\"line\"></span><br><span class=\"line\">    Log.d(TAG, <span class=\"string\">&quot;屏幕宽度（像素）：&quot;</span> + width);</span><br><span class=\"line\">    Log.d(TAG, <span class=\"string\">&quot;屏幕高度（像素）：&quot;</span> + height);</span><br><span class=\"line\">    Log.d(TAG, <span class=\"string\">&quot;屏幕密度（0.75 / 1.0 / 1.5）：&quot;</span> + density);</span><br><span class=\"line\">    Log.d(TAG, <span class=\"string\">&quot;屏幕密度dpi（120 / 160 / 240）：&quot;</span> + densityDpi);</span><br><span class=\"line\">    Log.d(TAG, <span class=\"string\">&quot;屏幕宽度（dp）：&quot;</span> + screenWidth);</span><br><span class=\"line\">    Log.d(TAG, <span class=\"string\">&quot;屏幕高度（dp）：&quot;</span> + screenHeight);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ul>\n<li><a href=\"https://developer.android.com/training/multiscreen/screensizes\">支持不同的屏幕尺寸</a></li>\n<li><a href=\"https://developer.android.com/training/multiscreen/screendensities\">支持不同的像素密度</a></li>\n<li><a href=\"https://juejin.cn/post/6844903612926296072#heading-10\">推荐Android两种屏幕适配方案 </a></li>\n<li><a href=\"https://blog.csdn.net/wangliblog/article/details/22501141\">Android获取屏幕的宽度和高度(dp)</a></li>\n<li><a href=\"https://blog.csdn.net/nihaomabmt/article/details/71215507\">Android屏幕values-sw适配</a></li>\n</ul>\n"},{"title":"线程(进程)的阻塞与挂起","date":"2022-02-24T06:10:13.000Z","_content":"\n## 阻塞与挂起\n\n### 挂起(suspend)\n> 是指在操作系统进程管理将前台的进程暂停(suspend)并转入后台的动作。将进程挂起可以让用户在前台执行其他的进程。挂起的进程通常释放除CPU以外已经占有的系统资源，如内存等。\n\n### 阻塞(block)\n>正在执行的进程由于发生某时间（如I/O请求、申请缓冲区失败等）暂时无法继续执行。此时引起进程调度，OS把处理机分配给另一个就绪进程，而让受阻进程处于暂停状态，一般将这种状态称为阻塞状态。\n\n#### 两者的区别\n**挂起**是一种主动行为，因此恢复也应该要主动完成；**阻塞**则是一种被动行为，恢复交由系统完成。而且挂起队列在操作系统里可以看成一个，而阻塞队列则是不同的事件或资源（如信号量）就有自己的队列。\n![bi5vSe.md.jpg](https://s4.ax1x.com/2022/02/24/bi5vSe.md.jpg)\n如图，运行中**挂起**，进入`禁止就绪`状态，*释放资源*，自身对换到外存中，不释放锁，不释放CPU。，比如sleep()。而运行中**阻塞**，进入`活动阻塞`状态，*释放资源*，释放锁，释放CPU，比如wait()。\n\n也就是说**挂起**在运行状态中要比**阻塞**靠前，**挂起**是一直在内存中定期运行自己，检查是否可以跳出当前状态；**阻塞**是自己不在运行，需要第三方检查自己是否可以跳出当前状态，在一定条件下会操作系统可能将其移出内存保存到外存中。\n\n### 代码中的关系\nJava 的 [Thread.State](https://docs.oracle.com/javase/7/docs/api/java/lang/Thread.State.html) 中定义了线程的 6 种状态，分别如下：\n\n1.  NEW 未启动的，不会出现在 dump 文件中 (可以通过 jstack 命令查看线程堆栈)\n2.  RUNNABLE 正在 JVM 中执行的\n3.  BLOCKED 被阻塞，等待获取监视器锁进入 synchronized 代码块或者在调用 Object.wait 之后重新进入 synchronized 代码块\n4.  WAITING 无限期等待另一个线程执行特定动作后唤醒它，也就是调用 Object.wait 后会等待拥有同一个监视器锁的线程调用 notify/notifyAll 来进行唤醒\n5.  TIMED_WAITING 有时限的等待另一个线程执行特定动作\n6.  TERMINATED 已经完成了执行\n\n#### sleep\n也就是说这是`挂起(suspend)`\n\n#### wait/notify(synchronized)\n也就是说这是`阻塞(block)`\n\n#### wait/notify和sleep的区别\n`wait/notify`的作用域在锁对象，释放CPU，`sleep`的作用域在线程，持有CPU。它们都可以实现对线程的控制。\n\n## 锁\n\n**锁**可以说是我们最经常使用到`阻塞与挂起`的地方了。\n\n### synchronized关键字\n\n**synchronized(Object)**中`Object`就是作用域，自动获取获取锁，自动释放锁。\n\n### wait/notify\n\n**Object.wait/notify**中`Object`就是作用域，手动获取获取锁，手动释放锁。\n\n**wait/nofity** 是通过 jvm 里的 **park/unpark** 机制来实现的，在 linux 下这种机制又是通过 **pthread_cond_wait/pthread_cond_signal** 实现。因此当线程进入到 wait 状态的时候其实是会放弃 cpu 的，也就是说这类线程是不会占用 cpu 资源，也不会影响系统加载。\n\n\n### 参考\n[操作系统——CPU和内存、挂起和阻塞](https://blog.csdn.net/weixin_37641832/article/details/83217104)\n[分析 Java Object 中的 wait/notify](https://generalthink.github.io/2019/10/10/analysis-java-object-wait-notify/)\n[synchronized(this/.class/Object),synchronize方法区别](https://www.jianshu.com/p/4c1ed2048985)\n[Life Cycle of a Thread in Java](https://www.baeldung.com/java-thread-lifecycle)","source":"_posts/thread-block-and-suspend.md","raw":"---\ntitle: 线程(进程)的阻塞与挂起\ndate: 2022-02-24 14:10:13\ntags:\n---\n\n## 阻塞与挂起\n\n### 挂起(suspend)\n> 是指在操作系统进程管理将前台的进程暂停(suspend)并转入后台的动作。将进程挂起可以让用户在前台执行其他的进程。挂起的进程通常释放除CPU以外已经占有的系统资源，如内存等。\n\n### 阻塞(block)\n>正在执行的进程由于发生某时间（如I/O请求、申请缓冲区失败等）暂时无法继续执行。此时引起进程调度，OS把处理机分配给另一个就绪进程，而让受阻进程处于暂停状态，一般将这种状态称为阻塞状态。\n\n#### 两者的区别\n**挂起**是一种主动行为，因此恢复也应该要主动完成；**阻塞**则是一种被动行为，恢复交由系统完成。而且挂起队列在操作系统里可以看成一个，而阻塞队列则是不同的事件或资源（如信号量）就有自己的队列。\n![bi5vSe.md.jpg](https://s4.ax1x.com/2022/02/24/bi5vSe.md.jpg)\n如图，运行中**挂起**，进入`禁止就绪`状态，*释放资源*，自身对换到外存中，不释放锁，不释放CPU。，比如sleep()。而运行中**阻塞**，进入`活动阻塞`状态，*释放资源*，释放锁，释放CPU，比如wait()。\n\n也就是说**挂起**在运行状态中要比**阻塞**靠前，**挂起**是一直在内存中定期运行自己，检查是否可以跳出当前状态；**阻塞**是自己不在运行，需要第三方检查自己是否可以跳出当前状态，在一定条件下会操作系统可能将其移出内存保存到外存中。\n\n### 代码中的关系\nJava 的 [Thread.State](https://docs.oracle.com/javase/7/docs/api/java/lang/Thread.State.html) 中定义了线程的 6 种状态，分别如下：\n\n1.  NEW 未启动的，不会出现在 dump 文件中 (可以通过 jstack 命令查看线程堆栈)\n2.  RUNNABLE 正在 JVM 中执行的\n3.  BLOCKED 被阻塞，等待获取监视器锁进入 synchronized 代码块或者在调用 Object.wait 之后重新进入 synchronized 代码块\n4.  WAITING 无限期等待另一个线程执行特定动作后唤醒它，也就是调用 Object.wait 后会等待拥有同一个监视器锁的线程调用 notify/notifyAll 来进行唤醒\n5.  TIMED_WAITING 有时限的等待另一个线程执行特定动作\n6.  TERMINATED 已经完成了执行\n\n#### sleep\n也就是说这是`挂起(suspend)`\n\n#### wait/notify(synchronized)\n也就是说这是`阻塞(block)`\n\n#### wait/notify和sleep的区别\n`wait/notify`的作用域在锁对象，释放CPU，`sleep`的作用域在线程，持有CPU。它们都可以实现对线程的控制。\n\n## 锁\n\n**锁**可以说是我们最经常使用到`阻塞与挂起`的地方了。\n\n### synchronized关键字\n\n**synchronized(Object)**中`Object`就是作用域，自动获取获取锁，自动释放锁。\n\n### wait/notify\n\n**Object.wait/notify**中`Object`就是作用域，手动获取获取锁，手动释放锁。\n\n**wait/nofity** 是通过 jvm 里的 **park/unpark** 机制来实现的，在 linux 下这种机制又是通过 **pthread_cond_wait/pthread_cond_signal** 实现。因此当线程进入到 wait 状态的时候其实是会放弃 cpu 的，也就是说这类线程是不会占用 cpu 资源，也不会影响系统加载。\n\n\n### 参考\n[操作系统——CPU和内存、挂起和阻塞](https://blog.csdn.net/weixin_37641832/article/details/83217104)\n[分析 Java Object 中的 wait/notify](https://generalthink.github.io/2019/10/10/analysis-java-object-wait-notify/)\n[synchronized(this/.class/Object),synchronize方法区别](https://www.jianshu.com/p/4c1ed2048985)\n[Life Cycle of a Thread in Java](https://www.baeldung.com/java-thread-lifecycle)","slug":"thread-block-and-suspend","published":1,"updated":"2023-06-30T13:34:34.851Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cljiok5gp0004t0izb4lh8x1f","content":"<h2 id=\"阻塞与挂起\"><a href=\"#阻塞与挂起\" class=\"headerlink\" title=\"阻塞与挂起\"></a>阻塞与挂起</h2><h3 id=\"挂起-suspend\"><a href=\"#挂起-suspend\" class=\"headerlink\" title=\"挂起(suspend)\"></a>挂起(suspend)</h3><blockquote>\n<p>是指在操作系统进程管理将前台的进程暂停(suspend)并转入后台的动作。将进程挂起可以让用户在前台执行其他的进程。挂起的进程通常释放除CPU以外已经占有的系统资源，如内存等。</p>\n</blockquote>\n<h3 id=\"阻塞-block\"><a href=\"#阻塞-block\" class=\"headerlink\" title=\"阻塞(block)\"></a>阻塞(block)</h3><blockquote>\n<p>正在执行的进程由于发生某时间（如I&#x2F;O请求、申请缓冲区失败等）暂时无法继续执行。此时引起进程调度，OS把处理机分配给另一个就绪进程，而让受阻进程处于暂停状态，一般将这种状态称为阻塞状态。</p>\n</blockquote>\n<h4 id=\"两者的区别\"><a href=\"#两者的区别\" class=\"headerlink\" title=\"两者的区别\"></a>两者的区别</h4><p><strong>挂起</strong>是一种主动行为，因此恢复也应该要主动完成；<strong>阻塞</strong>则是一种被动行为，恢复交由系统完成。而且挂起队列在操作系统里可以看成一个，而阻塞队列则是不同的事件或资源（如信号量）就有自己的队列。<br><img src=\"https://s4.ax1x.com/2022/02/24/bi5vSe.md.jpg\" alt=\"bi5vSe.md.jpg\"><br>如图，运行中<strong>挂起</strong>，进入<code>禁止就绪</code>状态，<em>释放资源</em>，自身对换到外存中，不释放锁，不释放CPU。，比如sleep()。而运行中<strong>阻塞</strong>，进入<code>活动阻塞</code>状态，<em>释放资源</em>，释放锁，释放CPU，比如wait()。</p>\n<p>也就是说<strong>挂起</strong>在运行状态中要比<strong>阻塞</strong>靠前，<strong>挂起</strong>是一直在内存中定期运行自己，检查是否可以跳出当前状态；<strong>阻塞</strong>是自己不在运行，需要第三方检查自己是否可以跳出当前状态，在一定条件下会操作系统可能将其移出内存保存到外存中。</p>\n<h3 id=\"代码中的关系\"><a href=\"#代码中的关系\" class=\"headerlink\" title=\"代码中的关系\"></a>代码中的关系</h3><p>Java 的 <a href=\"https://docs.oracle.com/javase/7/docs/api/java/lang/Thread.State.html\">Thread.State</a> 中定义了线程的 6 种状态，分别如下：</p>\n<ol>\n<li>NEW 未启动的，不会出现在 dump 文件中 (可以通过 jstack 命令查看线程堆栈)</li>\n<li>RUNNABLE 正在 JVM 中执行的</li>\n<li>BLOCKED 被阻塞，等待获取监视器锁进入 synchronized 代码块或者在调用 Object.wait 之后重新进入 synchronized 代码块</li>\n<li>WAITING 无限期等待另一个线程执行特定动作后唤醒它，也就是调用 Object.wait 后会等待拥有同一个监视器锁的线程调用 notify&#x2F;notifyAll 来进行唤醒</li>\n<li>TIMED_WAITING 有时限的等待另一个线程执行特定动作</li>\n<li>TERMINATED 已经完成了执行</li>\n</ol>\n<h4 id=\"sleep\"><a href=\"#sleep\" class=\"headerlink\" title=\"sleep\"></a>sleep</h4><p>也就是说这是<code>挂起(suspend)</code></p>\n<h4 id=\"wait-x2F-notify-synchronized\"><a href=\"#wait-x2F-notify-synchronized\" class=\"headerlink\" title=\"wait&#x2F;notify(synchronized)\"></a>wait&#x2F;notify(synchronized)</h4><p>也就是说这是<code>阻塞(block)</code></p>\n<h4 id=\"wait-x2F-notify和sleep的区别\"><a href=\"#wait-x2F-notify和sleep的区别\" class=\"headerlink\" title=\"wait&#x2F;notify和sleep的区别\"></a>wait&#x2F;notify和sleep的区别</h4><p><code>wait/notify</code>的作用域在锁对象，释放CPU，<code>sleep</code>的作用域在线程，持有CPU。它们都可以实现对线程的控制。</p>\n<h2 id=\"锁\"><a href=\"#锁\" class=\"headerlink\" title=\"锁\"></a>锁</h2><p><strong>锁</strong>可以说是我们最经常使用到<code>阻塞与挂起</code>的地方了。</p>\n<h3 id=\"synchronized关键字\"><a href=\"#synchronized关键字\" class=\"headerlink\" title=\"synchronized关键字\"></a>synchronized关键字</h3><p>**synchronized(Object)**中<code>Object</code>就是作用域，自动获取获取锁，自动释放锁。</p>\n<h3 id=\"wait-x2F-notify\"><a href=\"#wait-x2F-notify\" class=\"headerlink\" title=\"wait&#x2F;notify\"></a>wait&#x2F;notify</h3><p><strong>Object.wait&#x2F;notify</strong>中<code>Object</code>就是作用域，手动获取获取锁，手动释放锁。</p>\n<p><strong>wait&#x2F;nofity</strong> 是通过 jvm 里的 <strong>park&#x2F;unpark</strong> 机制来实现的，在 linux 下这种机制又是通过 <strong>pthread_cond_wait&#x2F;pthread_cond_signal</strong> 实现。因此当线程进入到 wait 状态的时候其实是会放弃 cpu 的，也就是说这类线程是不会占用 cpu 资源，也不会影响系统加载。</p>\n<h3 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h3><p><a href=\"https://blog.csdn.net/weixin_37641832/article/details/83217104\">操作系统——CPU和内存、挂起和阻塞</a><br><a href=\"https://generalthink.github.io/2019/10/10/analysis-java-object-wait-notify/\">分析 Java Object 中的 wait&#x2F;notify</a><br><a href=\"https://www.jianshu.com/p/4c1ed2048985\">synchronized(this&#x2F;.class&#x2F;Object),synchronize方法区别</a><br><a href=\"https://www.baeldung.com/java-thread-lifecycle\">Life Cycle of a Thread in Java</a></p>\n","site":{"data":{"next":{"favicon":{"small":"/images/favicon-16x16.png","medium":"/images/favicon-32x32.png","apple_touch_icon":"/images/apple-touch-icon.png","safari_pinned_tab":"/images/safari_pinned_tab.svg"},"creative_commons":{"license":"by-nc-sa","sidebar":true,"post":true,"language":"deed.zh"},"scheme":"Gemini","darkmode":true,"avatar":{"url":"/images/avatar.jpg","rounded":true,"rotated":false},"social":{"GitHub":"https://github.com/liaoheng || fab fa-github","RSS":"/atom.xml || fa fa-rss"},"social_icons":{"enable":true,"icons_only":true,"transition":true},"codeblock":{"highlight_theme":"normal","copy_button":{"enable":true,"show_result":true,"style":null}},"github_banner":{"enable":true,"permalink":"https://github.com/liaoheng","title":"Follow me on GitHub"},"google_analytics":{"tracking_id":"G-64FL8LWFL8","only_pageview":false},"vendors":{"pace":"//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js","pace_css":"//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css"},"pace":{"enable":true,"theme":"minimal"}}}},"excerpt":"","more":"<h2 id=\"阻塞与挂起\"><a href=\"#阻塞与挂起\" class=\"headerlink\" title=\"阻塞与挂起\"></a>阻塞与挂起</h2><h3 id=\"挂起-suspend\"><a href=\"#挂起-suspend\" class=\"headerlink\" title=\"挂起(suspend)\"></a>挂起(suspend)</h3><blockquote>\n<p>是指在操作系统进程管理将前台的进程暂停(suspend)并转入后台的动作。将进程挂起可以让用户在前台执行其他的进程。挂起的进程通常释放除CPU以外已经占有的系统资源，如内存等。</p>\n</blockquote>\n<h3 id=\"阻塞-block\"><a href=\"#阻塞-block\" class=\"headerlink\" title=\"阻塞(block)\"></a>阻塞(block)</h3><blockquote>\n<p>正在执行的进程由于发生某时间（如I&#x2F;O请求、申请缓冲区失败等）暂时无法继续执行。此时引起进程调度，OS把处理机分配给另一个就绪进程，而让受阻进程处于暂停状态，一般将这种状态称为阻塞状态。</p>\n</blockquote>\n<h4 id=\"两者的区别\"><a href=\"#两者的区别\" class=\"headerlink\" title=\"两者的区别\"></a>两者的区别</h4><p><strong>挂起</strong>是一种主动行为，因此恢复也应该要主动完成；<strong>阻塞</strong>则是一种被动行为，恢复交由系统完成。而且挂起队列在操作系统里可以看成一个，而阻塞队列则是不同的事件或资源（如信号量）就有自己的队列。<br><img src=\"https://s4.ax1x.com/2022/02/24/bi5vSe.md.jpg\" alt=\"bi5vSe.md.jpg\"><br>如图，运行中<strong>挂起</strong>，进入<code>禁止就绪</code>状态，<em>释放资源</em>，自身对换到外存中，不释放锁，不释放CPU。，比如sleep()。而运行中<strong>阻塞</strong>，进入<code>活动阻塞</code>状态，<em>释放资源</em>，释放锁，释放CPU，比如wait()。</p>\n<p>也就是说<strong>挂起</strong>在运行状态中要比<strong>阻塞</strong>靠前，<strong>挂起</strong>是一直在内存中定期运行自己，检查是否可以跳出当前状态；<strong>阻塞</strong>是自己不在运行，需要第三方检查自己是否可以跳出当前状态，在一定条件下会操作系统可能将其移出内存保存到外存中。</p>\n<h3 id=\"代码中的关系\"><a href=\"#代码中的关系\" class=\"headerlink\" title=\"代码中的关系\"></a>代码中的关系</h3><p>Java 的 <a href=\"https://docs.oracle.com/javase/7/docs/api/java/lang/Thread.State.html\">Thread.State</a> 中定义了线程的 6 种状态，分别如下：</p>\n<ol>\n<li>NEW 未启动的，不会出现在 dump 文件中 (可以通过 jstack 命令查看线程堆栈)</li>\n<li>RUNNABLE 正在 JVM 中执行的</li>\n<li>BLOCKED 被阻塞，等待获取监视器锁进入 synchronized 代码块或者在调用 Object.wait 之后重新进入 synchronized 代码块</li>\n<li>WAITING 无限期等待另一个线程执行特定动作后唤醒它，也就是调用 Object.wait 后会等待拥有同一个监视器锁的线程调用 notify&#x2F;notifyAll 来进行唤醒</li>\n<li>TIMED_WAITING 有时限的等待另一个线程执行特定动作</li>\n<li>TERMINATED 已经完成了执行</li>\n</ol>\n<h4 id=\"sleep\"><a href=\"#sleep\" class=\"headerlink\" title=\"sleep\"></a>sleep</h4><p>也就是说这是<code>挂起(suspend)</code></p>\n<h4 id=\"wait-x2F-notify-synchronized\"><a href=\"#wait-x2F-notify-synchronized\" class=\"headerlink\" title=\"wait&#x2F;notify(synchronized)\"></a>wait&#x2F;notify(synchronized)</h4><p>也就是说这是<code>阻塞(block)</code></p>\n<h4 id=\"wait-x2F-notify和sleep的区别\"><a href=\"#wait-x2F-notify和sleep的区别\" class=\"headerlink\" title=\"wait&#x2F;notify和sleep的区别\"></a>wait&#x2F;notify和sleep的区别</h4><p><code>wait/notify</code>的作用域在锁对象，释放CPU，<code>sleep</code>的作用域在线程，持有CPU。它们都可以实现对线程的控制。</p>\n<h2 id=\"锁\"><a href=\"#锁\" class=\"headerlink\" title=\"锁\"></a>锁</h2><p><strong>锁</strong>可以说是我们最经常使用到<code>阻塞与挂起</code>的地方了。</p>\n<h3 id=\"synchronized关键字\"><a href=\"#synchronized关键字\" class=\"headerlink\" title=\"synchronized关键字\"></a>synchronized关键字</h3><p>**synchronized(Object)**中<code>Object</code>就是作用域，自动获取获取锁，自动释放锁。</p>\n<h3 id=\"wait-x2F-notify\"><a href=\"#wait-x2F-notify\" class=\"headerlink\" title=\"wait&#x2F;notify\"></a>wait&#x2F;notify</h3><p><strong>Object.wait&#x2F;notify</strong>中<code>Object</code>就是作用域，手动获取获取锁，手动释放锁。</p>\n<p><strong>wait&#x2F;nofity</strong> 是通过 jvm 里的 <strong>park&#x2F;unpark</strong> 机制来实现的，在 linux 下这种机制又是通过 <strong>pthread_cond_wait&#x2F;pthread_cond_signal</strong> 实现。因此当线程进入到 wait 状态的时候其实是会放弃 cpu 的，也就是说这类线程是不会占用 cpu 资源，也不会影响系统加载。</p>\n<h3 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h3><p><a href=\"https://blog.csdn.net/weixin_37641832/article/details/83217104\">操作系统——CPU和内存、挂起和阻塞</a><br><a href=\"https://generalthink.github.io/2019/10/10/analysis-java-object-wait-notify/\">分析 Java Object 中的 wait&#x2F;notify</a><br><a href=\"https://www.jianshu.com/p/4c1ed2048985\">synchronized(this&#x2F;.class&#x2F;Object),synchronize方法区别</a><br><a href=\"https://www.baeldung.com/java-thread-lifecycle\">Life Cycle of a Thread in Java</a></p>\n"},{"title":"安装Arch Linux小结","date":"2021-07-28T05:48:38.000Z","_content":"\n<img src=\"https://archlinux.org/static/logos/archlinux-logo-dark-1200dpi.b42bd35d5916.png\" style=\"zoom:5%;\" />\n\n本人跟随[Arch Linux官方安装指南](https://wiki.archlinux.org/title/Installation_guide_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87))操作过程的一些记录。\n\n## 准备\n\n>  下载ISO文件并启动到 Live 环境，注意[安全启动（Secure Boot）](https://wiki.archlinux.org/title/Unified_Extensible_Firmware_Interface_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)/Secure_Boot_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87))的问题。\n\n[官方下载地址](https://archlinux.org/download/)\n\n### 验证启动模式(非必须)\n\n请用下列命令列出 [efivars](https://wiki.archlinux.org/index.php/Efivars) 目录：\n\n```shell\nls /sys/firmware/efi/efivars\n```\n\n目录存在，操作系统使用UEFI模式启动，反之使用传统模式启动(BIOS,CSM)。\n\n### 网络连接\n\n**安装过程需要连接互联网**，Live环境默认开启DHCP，其它方式可以参考[连接到因特网](https://wiki.archlinux.org/index.php/Installation_guide_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#%E8%BF%9E%E6%8E%A5%E5%88%B0%E5%9B%A0%E7%89%B9%E7%BD%91)，\n\n### 更新系统时间\n\n```shell\ntimedatectl set-ntp true\n```\n\n### 建立硬盘分区\n\n> 使用`fdisk`分区，可以查看这篇[博文](https://www.cnblogs.com/lsgxeva/p/9610003.html)有详细的使用说明\n\n查看分区列表\n\n```shell\nfdisk -l\n```\n\n![IVXRYh.png](https://s3.jpg.cm/2021/07/28/IVXRYh.png)\n\n其中`/dev/sda`代表第一块物理磁盘(`/dev/sdb,/dev/sdc`与之类推)\n\n操作对应磁盘(`/dev/sda`)分区\n\n```shell\nfdisk /dev/sda\n# 进入fdisk应用命令行：\ng #如果没有分区表或者是MBR表先删除，创建一个新的空GPT分区表\nn #创建新的分区\nt #改变分区类型\nw #保存并退出\n```\n\n![IVXqCS.png](https://s3.jpg.cm/2021/07/28/IVXqCS.png)\n\n新建分区之后需要指定分区类型，使用命令`t {partition number }`，可以参考下表配置分区：\n\n| Mount point | Partition | [Partition type GUID](https://en.wikipedia.org/wiki/GUID_Partition_Table#Partition_type_GUIDs) |\n| ----------- | --------- | ------------------------------------------------------------ |\n| /boot       | /dev/sda1 | `C12A7328-F81F-11D2-BA4B-00A0C93EC93B`: [EFI system partition](https://wiki.archlinux.org/index.php/EFI_system_partition) |\n| [SWAP]      | /dev/sda2 | `0657FD6D-A4AB-43C4-84E5-0933C84B4F4F`: Linux [swap](https://wiki.archlinux.org/index.php/Swap) |\n| /home       | /dev/sda3 | `933AC7E1-2EB4-4F13-B844-0E14E2AEF915`: Linux /home          |\n| /           | /dev/sda4 | `4F68BCE3-E8CD-4DB1-96E7-FBCAF984B709`: Linux x86-64 root (/) |\n\n通过`t`命令可以查看更多类型，PgUp向上,PgDn向下,q退出。\n\n### 格式化分区\n\n```shell\nmkfs.fat -F32 /dev/sda1 #EFI system partition(ESP)\nmkswap /dev/sda2 #swap\nmkfs.ext4 /dev/sda3 #/home\nmkfs.ext4 /dev/sda4 #/\n```\n\n### 挂载分区\n\n将根磁盘卷 [挂载](https://wiki.archlinux.org/index.php/Mount) 到 `/mnt`，例如：\n\n```shell\nmount /dev/sda4 /mnt #挂载/\nmkdir /mnt/boot\nmount /dev/sda1 /mnt/boot #挂载ESP\nmkdir /mnt/home\nmount /dev/sda3 /mnt/home #挂载/home\nswapon /dev/sda2 #挂载swap\n```\n\n## 安装系统\n\n### 选择一个合适的镜像(可选)\n\n[非官方镜像列表](https://wiki.archlinux.org/title/Mirrors_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#%E4%B8%AD%E5%9B%BD)\n\n```shell\nnano /etc/pacman.d/mirrorlist\n---\nServer = https://mirrors.ustc.edu.cn/archlinux/$repo/os/$arch #文件第一排写入\n```\n\n### 安装配置\n\n这几个包按照需求选择是否添加 [nano](https://wiki.archlinux.org/title/Nano_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)), [grub](https://wiki.archlinux.org/title/GRUB_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)), [efibootmgr](https://wiki.archlinux.org/title/Unified_Extensible_Firmware_Interface_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#efibootmgr), [iwd](https://wiki.archlinux.org/title/Iwd_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87))\n\n```shell\npacstrap /mnt base linux linux-firmware nano grub efibootmgr iwd\ngenfstab -U /mnt >> /mnt/etc/fstab  #定义磁盘分区\n```\n\n### 通过Chroot进入安装系统\n\n```sh\narch-chroot /mnt # 进入安装好的arch linux系统\n```\n在当前Live Linux中通过[Chroot](https://wiki.archlinux.org/title/Chroot_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87))进入我们挂在到/mnt下面的Arch Linux系统中(也就是我们这次安装的系统)，以下操作均在其中\n\n### 时间/时区\n\n```sh\nln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime  #设置时区\nhwclock --systohc #硬件时间设置为UTC\n```\n\n### 本地化\n\n编辑`/etc/locale.gen` 选择 [地区](https://wiki.archlinux.org/index.php/Locale_(简体中文)) ：\n\n```sh\nnano /etc/locale.gen #移除需要的地区前的#号\n---\nlocale-gen #更新配置\n```\n\n然后创建`/etc/locale.conf` 文件，并添加 [ LANG 变量](https://wiki.archlinux.org/index.php/Locale#Setting_the_system_locale)：\n\n```sh\nnano /etc/locale.conf\n---\nLANG=en_GB.UTF-8 #推荐使用，而不是zh_CN\n```\n\n### hostname&hosts\n\n```sh\n#创建/etc/hostname文件\nnano /etc/hostname\n---\nLHCOMPUTER #写入主机名称\n\n#编辑/etc/hosts\nnano /etc/hosts\n---\n127.0.0.1    localhost\n::1        localhost\n127.0.1.1    LHCOMPUTER.localdomain    LHCOMPUTER #添加\n```\n\n### 设置Root用户密码\n\n```sh\npasswd\n```\n\n### 安装引导程序\n\n前面的步骤已经基本完成对启动系统的配置，现在需要计算机引导启动系统，我选择使用[GRUB](https://wiki.archlinux.org/index.php/GRUB_(简体中文))，以下是在EFI 系统分区下的命令：\n\n```sh\ngrub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB\ngrub-mkconfig -o /boot/grub/grub.cfg\n```\n\n### 完成\n\n输入 `exit` 或按 `Ctrl+d` 退出 Chroot 环境。\n可选用 `umount -R /mnt` 手动卸载被挂载的分区。\n最后执行 `reboot` 重启系统。\n\n## 使用新系统前的配置\n\n### 选择网络管理程序\n\n系统默认已安装[systemd-networkd](https://wiki.archlinux.org/index.php/Systemd-networkd_(简体中文))，以下步骤配置并开启。\n\n```shell\n$ networkctl #获取有关网络链接的状态信息\nIDX LINK             TYPE               OPERATIONAL SETUP     \n1 lo               loopback           carrier     unmanaged \n2 ens33            ether              routable    unmanaged \n3 wlp2s0           wlan               off         unmanaged \n4 vmnet1           ether              routable    unmanaged \n5 vmnet8           ether              routable    unmanaged \n5 links listed.\n```\n\n其中ens33为有线网卡，wlp2s0为无线网卡。\n\n#### 配置有线\n\n```sh\nnano /etc/systemd/network/dhcp.network\n---\n[Match]\nName=ens33\n \n[Network]\nDHCP=true\n#Address=192.168.1.20/24\n#Gateway=192.168.1.1\n#DNS=119.29.29.29\n#DNS=8.8.8.8\n```\n\n#### 配置无线\n\n需要先安装[iwd](https://wiki.archlinux.org/title/Iwd_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87))包，使用命令连接对应无线网络。\n\n1. 要进入交互式提示符（interactive prompt），执行：`$ iwctl`\n2. `[iwd]# station device scan`\n3. `[iwd]# station device get-networks`\n4. `[iwd]# station device connect SSID`，会提示输入密码\n\n完成后，配置网络\n\n```sh\nnano /etc/systemd/network/wireless.network\n---\n[Match]\nName=wlp2s0\n \n[Network]\nDHCP=true\n```\n#### 开启自动服务\n\n```sh\nsystemctl enable --now systemd-networkd.service\nsystemctl enable --now systemd-resolved.service #DNS\n```\n\n### 添加新用户\n\n```sh\ngroupadd liaoheng\nuseradd -m -g liaoheng liaoheng\npasswd liaoheng\n```\n\n### 安装`sudo`\n\n```sh\npacman -S sudo\nnano /etc/sudoers#下面内容到文件末尾\n---\nDefaults targetpw\nliaoheng ALL=(ALL) ALL\n```\n\n### 开机时打开 `Num Lock`\n\n```sh\nsudo pacman -S systemd-numlockontty\nsudo systemctl enable --now numLockOnTty.service\n```\n\n### 软件仓库(可选)\n\n> 可以登录`liaoheng`账户\n\n```sh\nsudo pacman -Syu\n```\n\n添加Arch Linux Chinese Community Repository，编辑`/etc/pacman.conf`，添加\n\n```sh\nsudo nano /etc/pacman.conf\n---\n[archlinuxcn]\nServer = https://mirrors.ustc.edu.cn/archlinuxcn/$arch\n```\n\n导入PGP keys:\n\n> [失败解决办法](https://github.com/archlinuxcn/repo/issues/522)\n\n```sh\nsudo pacman -Syy && sudo pacman -S archlinuxcn-keyring\n```\n\n### 图形界面\n\n#### [GNOME](https://wiki.archlinux.org/index.php/GNOME_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87))\n\n```sh\nsudo pacman -S gnome gnome-extra gnome-tweak-tool\nsudo pacman -S networkmanager\nsudo systemctl enable NetworkManager\nsudo systemctl enable --now gdm.service\n```\n\n## 参考\n\n- [Installation guide](https://wiki.archlinux.org/index.php/Installation_guide_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87))\n- [Partitioning](https://wiki.archlinux.org/index.php/Partitioning_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#%E5%B8%83%E5%B1%80%E7%A4%BA%E4%BE%8B)\n- [EFI_system_partition](https://wiki.archlinux.org/index.php/EFI_system_partition)\n- [fstab ](https://wiki.archlinux.org/index.php/Fstab_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87))","source":"_posts/installation-arch-linux-summary.md","raw":"---\ntitle: 安装Arch Linux小结\ndate: 2021-07-28 13:48:38\ntags:\n---\n\n<img src=\"https://archlinux.org/static/logos/archlinux-logo-dark-1200dpi.b42bd35d5916.png\" style=\"zoom:5%;\" />\n\n本人跟随[Arch Linux官方安装指南](https://wiki.archlinux.org/title/Installation_guide_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87))操作过程的一些记录。\n\n## 准备\n\n>  下载ISO文件并启动到 Live 环境，注意[安全启动（Secure Boot）](https://wiki.archlinux.org/title/Unified_Extensible_Firmware_Interface_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)/Secure_Boot_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87))的问题。\n\n[官方下载地址](https://archlinux.org/download/)\n\n### 验证启动模式(非必须)\n\n请用下列命令列出 [efivars](https://wiki.archlinux.org/index.php/Efivars) 目录：\n\n```shell\nls /sys/firmware/efi/efivars\n```\n\n目录存在，操作系统使用UEFI模式启动，反之使用传统模式启动(BIOS,CSM)。\n\n### 网络连接\n\n**安装过程需要连接互联网**，Live环境默认开启DHCP，其它方式可以参考[连接到因特网](https://wiki.archlinux.org/index.php/Installation_guide_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#%E8%BF%9E%E6%8E%A5%E5%88%B0%E5%9B%A0%E7%89%B9%E7%BD%91)，\n\n### 更新系统时间\n\n```shell\ntimedatectl set-ntp true\n```\n\n### 建立硬盘分区\n\n> 使用`fdisk`分区，可以查看这篇[博文](https://www.cnblogs.com/lsgxeva/p/9610003.html)有详细的使用说明\n\n查看分区列表\n\n```shell\nfdisk -l\n```\n\n![IVXRYh.png](https://s3.jpg.cm/2021/07/28/IVXRYh.png)\n\n其中`/dev/sda`代表第一块物理磁盘(`/dev/sdb,/dev/sdc`与之类推)\n\n操作对应磁盘(`/dev/sda`)分区\n\n```shell\nfdisk /dev/sda\n# 进入fdisk应用命令行：\ng #如果没有分区表或者是MBR表先删除，创建一个新的空GPT分区表\nn #创建新的分区\nt #改变分区类型\nw #保存并退出\n```\n\n![IVXqCS.png](https://s3.jpg.cm/2021/07/28/IVXqCS.png)\n\n新建分区之后需要指定分区类型，使用命令`t {partition number }`，可以参考下表配置分区：\n\n| Mount point | Partition | [Partition type GUID](https://en.wikipedia.org/wiki/GUID_Partition_Table#Partition_type_GUIDs) |\n| ----------- | --------- | ------------------------------------------------------------ |\n| /boot       | /dev/sda1 | `C12A7328-F81F-11D2-BA4B-00A0C93EC93B`: [EFI system partition](https://wiki.archlinux.org/index.php/EFI_system_partition) |\n| [SWAP]      | /dev/sda2 | `0657FD6D-A4AB-43C4-84E5-0933C84B4F4F`: Linux [swap](https://wiki.archlinux.org/index.php/Swap) |\n| /home       | /dev/sda3 | `933AC7E1-2EB4-4F13-B844-0E14E2AEF915`: Linux /home          |\n| /           | /dev/sda4 | `4F68BCE3-E8CD-4DB1-96E7-FBCAF984B709`: Linux x86-64 root (/) |\n\n通过`t`命令可以查看更多类型，PgUp向上,PgDn向下,q退出。\n\n### 格式化分区\n\n```shell\nmkfs.fat -F32 /dev/sda1 #EFI system partition(ESP)\nmkswap /dev/sda2 #swap\nmkfs.ext4 /dev/sda3 #/home\nmkfs.ext4 /dev/sda4 #/\n```\n\n### 挂载分区\n\n将根磁盘卷 [挂载](https://wiki.archlinux.org/index.php/Mount) 到 `/mnt`，例如：\n\n```shell\nmount /dev/sda4 /mnt #挂载/\nmkdir /mnt/boot\nmount /dev/sda1 /mnt/boot #挂载ESP\nmkdir /mnt/home\nmount /dev/sda3 /mnt/home #挂载/home\nswapon /dev/sda2 #挂载swap\n```\n\n## 安装系统\n\n### 选择一个合适的镜像(可选)\n\n[非官方镜像列表](https://wiki.archlinux.org/title/Mirrors_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#%E4%B8%AD%E5%9B%BD)\n\n```shell\nnano /etc/pacman.d/mirrorlist\n---\nServer = https://mirrors.ustc.edu.cn/archlinux/$repo/os/$arch #文件第一排写入\n```\n\n### 安装配置\n\n这几个包按照需求选择是否添加 [nano](https://wiki.archlinux.org/title/Nano_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)), [grub](https://wiki.archlinux.org/title/GRUB_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)), [efibootmgr](https://wiki.archlinux.org/title/Unified_Extensible_Firmware_Interface_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#efibootmgr), [iwd](https://wiki.archlinux.org/title/Iwd_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87))\n\n```shell\npacstrap /mnt base linux linux-firmware nano grub efibootmgr iwd\ngenfstab -U /mnt >> /mnt/etc/fstab  #定义磁盘分区\n```\n\n### 通过Chroot进入安装系统\n\n```sh\narch-chroot /mnt # 进入安装好的arch linux系统\n```\n在当前Live Linux中通过[Chroot](https://wiki.archlinux.org/title/Chroot_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87))进入我们挂在到/mnt下面的Arch Linux系统中(也就是我们这次安装的系统)，以下操作均在其中\n\n### 时间/时区\n\n```sh\nln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime  #设置时区\nhwclock --systohc #硬件时间设置为UTC\n```\n\n### 本地化\n\n编辑`/etc/locale.gen` 选择 [地区](https://wiki.archlinux.org/index.php/Locale_(简体中文)) ：\n\n```sh\nnano /etc/locale.gen #移除需要的地区前的#号\n---\nlocale-gen #更新配置\n```\n\n然后创建`/etc/locale.conf` 文件，并添加 [ LANG 变量](https://wiki.archlinux.org/index.php/Locale#Setting_the_system_locale)：\n\n```sh\nnano /etc/locale.conf\n---\nLANG=en_GB.UTF-8 #推荐使用，而不是zh_CN\n```\n\n### hostname&hosts\n\n```sh\n#创建/etc/hostname文件\nnano /etc/hostname\n---\nLHCOMPUTER #写入主机名称\n\n#编辑/etc/hosts\nnano /etc/hosts\n---\n127.0.0.1    localhost\n::1        localhost\n127.0.1.1    LHCOMPUTER.localdomain    LHCOMPUTER #添加\n```\n\n### 设置Root用户密码\n\n```sh\npasswd\n```\n\n### 安装引导程序\n\n前面的步骤已经基本完成对启动系统的配置，现在需要计算机引导启动系统，我选择使用[GRUB](https://wiki.archlinux.org/index.php/GRUB_(简体中文))，以下是在EFI 系统分区下的命令：\n\n```sh\ngrub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB\ngrub-mkconfig -o /boot/grub/grub.cfg\n```\n\n### 完成\n\n输入 `exit` 或按 `Ctrl+d` 退出 Chroot 环境。\n可选用 `umount -R /mnt` 手动卸载被挂载的分区。\n最后执行 `reboot` 重启系统。\n\n## 使用新系统前的配置\n\n### 选择网络管理程序\n\n系统默认已安装[systemd-networkd](https://wiki.archlinux.org/index.php/Systemd-networkd_(简体中文))，以下步骤配置并开启。\n\n```shell\n$ networkctl #获取有关网络链接的状态信息\nIDX LINK             TYPE               OPERATIONAL SETUP     \n1 lo               loopback           carrier     unmanaged \n2 ens33            ether              routable    unmanaged \n3 wlp2s0           wlan               off         unmanaged \n4 vmnet1           ether              routable    unmanaged \n5 vmnet8           ether              routable    unmanaged \n5 links listed.\n```\n\n其中ens33为有线网卡，wlp2s0为无线网卡。\n\n#### 配置有线\n\n```sh\nnano /etc/systemd/network/dhcp.network\n---\n[Match]\nName=ens33\n \n[Network]\nDHCP=true\n#Address=192.168.1.20/24\n#Gateway=192.168.1.1\n#DNS=119.29.29.29\n#DNS=8.8.8.8\n```\n\n#### 配置无线\n\n需要先安装[iwd](https://wiki.archlinux.org/title/Iwd_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87))包，使用命令连接对应无线网络。\n\n1. 要进入交互式提示符（interactive prompt），执行：`$ iwctl`\n2. `[iwd]# station device scan`\n3. `[iwd]# station device get-networks`\n4. `[iwd]# station device connect SSID`，会提示输入密码\n\n完成后，配置网络\n\n```sh\nnano /etc/systemd/network/wireless.network\n---\n[Match]\nName=wlp2s0\n \n[Network]\nDHCP=true\n```\n#### 开启自动服务\n\n```sh\nsystemctl enable --now systemd-networkd.service\nsystemctl enable --now systemd-resolved.service #DNS\n```\n\n### 添加新用户\n\n```sh\ngroupadd liaoheng\nuseradd -m -g liaoheng liaoheng\npasswd liaoheng\n```\n\n### 安装`sudo`\n\n```sh\npacman -S sudo\nnano /etc/sudoers#下面内容到文件末尾\n---\nDefaults targetpw\nliaoheng ALL=(ALL) ALL\n```\n\n### 开机时打开 `Num Lock`\n\n```sh\nsudo pacman -S systemd-numlockontty\nsudo systemctl enable --now numLockOnTty.service\n```\n\n### 软件仓库(可选)\n\n> 可以登录`liaoheng`账户\n\n```sh\nsudo pacman -Syu\n```\n\n添加Arch Linux Chinese Community Repository，编辑`/etc/pacman.conf`，添加\n\n```sh\nsudo nano /etc/pacman.conf\n---\n[archlinuxcn]\nServer = https://mirrors.ustc.edu.cn/archlinuxcn/$arch\n```\n\n导入PGP keys:\n\n> [失败解决办法](https://github.com/archlinuxcn/repo/issues/522)\n\n```sh\nsudo pacman -Syy && sudo pacman -S archlinuxcn-keyring\n```\n\n### 图形界面\n\n#### [GNOME](https://wiki.archlinux.org/index.php/GNOME_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87))\n\n```sh\nsudo pacman -S gnome gnome-extra gnome-tweak-tool\nsudo pacman -S networkmanager\nsudo systemctl enable NetworkManager\nsudo systemctl enable --now gdm.service\n```\n\n## 参考\n\n- [Installation guide](https://wiki.archlinux.org/index.php/Installation_guide_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87))\n- [Partitioning](https://wiki.archlinux.org/index.php/Partitioning_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#%E5%B8%83%E5%B1%80%E7%A4%BA%E4%BE%8B)\n- [EFI_system_partition](https://wiki.archlinux.org/index.php/EFI_system_partition)\n- [fstab ](https://wiki.archlinux.org/index.php/Fstab_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87))","slug":"installation-arch-linux-summary","published":1,"updated":"2023-06-30T13:34:34.851Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cljiok5gp0005t0iz1216cfl7","content":"<img src=\"https://archlinux.org/static/logos/archlinux-logo-dark-1200dpi.b42bd35d5916.png\" style=\"zoom:5%;\" />\n\n<p>本人跟随<a href=\"https://wiki.archlinux.org/title/Installation_guide_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)\">Arch Linux官方安装指南</a>操作过程的一些记录。</p>\n<h2 id=\"准备\"><a href=\"#准备\" class=\"headerlink\" title=\"准备\"></a>准备</h2><blockquote>\n<p> 下载ISO文件并启动到 Live 环境，注意<a href=\"https://wiki.archlinux.org/title/Unified_Extensible_Firmware_Interface_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)/Secure_Boot_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)\">安全启动（Secure Boot）</a>的问题。</p>\n</blockquote>\n<p><a href=\"https://archlinux.org/download/\">官方下载地址</a></p>\n<h3 id=\"验证启动模式-非必须\"><a href=\"#验证启动模式-非必须\" class=\"headerlink\" title=\"验证启动模式(非必须)\"></a>验证启动模式(非必须)</h3><p>请用下列命令列出 <a href=\"https://wiki.archlinux.org/index.php/Efivars\">efivars</a> 目录：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ls /sys/firmware/efi/efivars</span><br></pre></td></tr></table></figure>\n\n<p>目录存在，操作系统使用UEFI模式启动，反之使用传统模式启动(BIOS,CSM)。</p>\n<h3 id=\"网络连接\"><a href=\"#网络连接\" class=\"headerlink\" title=\"网络连接\"></a>网络连接</h3><p><strong>安装过程需要连接互联网</strong>，Live环境默认开启DHCP，其它方式可以参考<a href=\"https://wiki.archlinux.org/index.php/Installation_guide_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#%E8%BF%9E%E6%8E%A5%E5%88%B0%E5%9B%A0%E7%89%B9%E7%BD%91\">连接到因特网</a>，</p>\n<h3 id=\"更新系统时间\"><a href=\"#更新系统时间\" class=\"headerlink\" title=\"更新系统时间\"></a>更新系统时间</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">timedatectl set-ntp true</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"建立硬盘分区\"><a href=\"#建立硬盘分区\" class=\"headerlink\" title=\"建立硬盘分区\"></a>建立硬盘分区</h3><blockquote>\n<p>使用<code>fdisk</code>分区，可以查看这篇<a href=\"https://www.cnblogs.com/lsgxeva/p/9610003.html\">博文</a>有详细的使用说明</p>\n</blockquote>\n<p>查看分区列表</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fdisk -l</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://s3.jpg.cm/2021/07/28/IVXRYh.png\" alt=\"IVXRYh.png\"></p>\n<p>其中<code>/dev/sda</code>代表第一块物理磁盘(<code>/dev/sdb,/dev/sdc</code>与之类推)</p>\n<p>操作对应磁盘(<code>/dev/sda</code>)分区</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fdisk /dev/sda</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">进入fdisk应用命令行：</span></span><br><span class=\"line\">g #如果没有分区表或者是MBR表先删除，创建一个新的空GPT分区表</span><br><span class=\"line\">n #创建新的分区</span><br><span class=\"line\">t #改变分区类型</span><br><span class=\"line\">w #保存并退出</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://s3.jpg.cm/2021/07/28/IVXqCS.png\" alt=\"IVXqCS.png\"></p>\n<p>新建分区之后需要指定分区类型，使用命令<code>t &#123;partition number &#125;</code>，可以参考下表配置分区：</p>\n<table>\n<thead>\n<tr>\n<th>Mount point</th>\n<th>Partition</th>\n<th><a href=\"https://en.wikipedia.org/wiki/GUID_Partition_Table#Partition_type_GUIDs\">Partition type GUID</a></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>&#x2F;boot</td>\n<td>&#x2F;dev&#x2F;sda1</td>\n<td><code>C12A7328-F81F-11D2-BA4B-00A0C93EC93B</code>: <a href=\"https://wiki.archlinux.org/index.php/EFI_system_partition\">EFI system partition</a></td>\n</tr>\n<tr>\n<td>[SWAP]</td>\n<td>&#x2F;dev&#x2F;sda2</td>\n<td><code>0657FD6D-A4AB-43C4-84E5-0933C84B4F4F</code>: Linux <a href=\"https://wiki.archlinux.org/index.php/Swap\">swap</a></td>\n</tr>\n<tr>\n<td>&#x2F;home</td>\n<td>&#x2F;dev&#x2F;sda3</td>\n<td><code>933AC7E1-2EB4-4F13-B844-0E14E2AEF915</code>: Linux &#x2F;home</td>\n</tr>\n<tr>\n<td>&#x2F;</td>\n<td>&#x2F;dev&#x2F;sda4</td>\n<td><code>4F68BCE3-E8CD-4DB1-96E7-FBCAF984B709</code>: Linux x86-64 root (&#x2F;)</td>\n</tr>\n</tbody></table>\n<p>通过<code>t</code>命令可以查看更多类型，PgUp向上,PgDn向下,q退出。</p>\n<h3 id=\"格式化分区\"><a href=\"#格式化分区\" class=\"headerlink\" title=\"格式化分区\"></a>格式化分区</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkfs.fat -F32 /dev/sda1 #EFI system partition(ESP)</span><br><span class=\"line\">mkswap /dev/sda2 #swap</span><br><span class=\"line\">mkfs.ext4 /dev/sda3 #/home</span><br><span class=\"line\">mkfs.ext4 /dev/sda4 #/</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"挂载分区\"><a href=\"#挂载分区\" class=\"headerlink\" title=\"挂载分区\"></a>挂载分区</h3><p>将根磁盘卷 <a href=\"https://wiki.archlinux.org/index.php/Mount\">挂载</a> 到 <code>/mnt</code>，例如：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mount /dev/sda4 /mnt #挂载/</span><br><span class=\"line\">mkdir /mnt/boot</span><br><span class=\"line\">mount /dev/sda1 /mnt/boot #挂载ESP</span><br><span class=\"line\">mkdir /mnt/home</span><br><span class=\"line\">mount /dev/sda3 /mnt/home #挂载/home</span><br><span class=\"line\">swapon /dev/sda2 #挂载swap</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"安装系统\"><a href=\"#安装系统\" class=\"headerlink\" title=\"安装系统\"></a>安装系统</h2><h3 id=\"选择一个合适的镜像-可选\"><a href=\"#选择一个合适的镜像-可选\" class=\"headerlink\" title=\"选择一个合适的镜像(可选)\"></a>选择一个合适的镜像(可选)</h3><p><a href=\"https://wiki.archlinux.org/title/Mirrors_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#%E4%B8%AD%E5%9B%BD\">非官方镜像列表</a></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nano /etc/pacman.d/mirrorlist</span><br><span class=\"line\">---</span><br><span class=\"line\">Server = https://mirrors.ustc.edu.cn/archlinux/$repo/os/$arch #文件第一排写入</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"安装配置\"><a href=\"#安装配置\" class=\"headerlink\" title=\"安装配置\"></a>安装配置</h3><p>这几个包按照需求选择是否添加 <a href=\"https://wiki.archlinux.org/title/Nano_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)\">nano</a>, <a href=\"https://wiki.archlinux.org/title/GRUB_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)\">grub</a>, <a href=\"https://wiki.archlinux.org/title/Unified_Extensible_Firmware_Interface_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#efibootmgr\">efibootmgr</a>, <a href=\"https://wiki.archlinux.org/title/Iwd_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)\">iwd</a></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pacstrap /mnt base linux linux-firmware nano grub efibootmgr iwd</span><br><span class=\"line\">genfstab -U /mnt &gt;&gt; /mnt/etc/fstab  #定义磁盘分区</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"通过Chroot进入安装系统\"><a href=\"#通过Chroot进入安装系统\" class=\"headerlink\" title=\"通过Chroot进入安装系统\"></a>通过Chroot进入安装系统</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">arch-chroot /mnt <span class=\"comment\"># 进入安装好的arch linux系统</span></span><br></pre></td></tr></table></figure>\n<p>在当前Live Linux中通过<a href=\"https://wiki.archlinux.org/title/Chroot_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)\">Chroot</a>进入我们挂在到&#x2F;mnt下面的Arch Linux系统中(也就是我们这次安装的系统)，以下操作均在其中</p>\n<h3 id=\"时间-x2F-时区\"><a href=\"#时间-x2F-时区\" class=\"headerlink\" title=\"时间&#x2F;时区\"></a>时间&#x2F;时区</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">ln</span> -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime  <span class=\"comment\">#设置时区</span></span><br><span class=\"line\">hwclock --systohc <span class=\"comment\">#硬件时间设置为UTC</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"本地化\"><a href=\"#本地化\" class=\"headerlink\" title=\"本地化\"></a>本地化</h3><p>编辑<code>/etc/locale.gen</code> 选择 <a href=\"https://wiki.archlinux.org/index.php/Locale_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)\">地区</a> ：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nano /etc/locale.gen <span class=\"comment\">#移除需要的地区前的#号</span></span><br><span class=\"line\">---</span><br><span class=\"line\">locale-gen <span class=\"comment\">#更新配置</span></span><br></pre></td></tr></table></figure>\n\n<p>然后创建<code>/etc/locale.conf</code> 文件，并添加 <a href=\"https://wiki.archlinux.org/index.php/Locale#Setting_the_system_locale\"> LANG 变量</a>：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nano /etc/locale.conf</span><br><span class=\"line\">---</span><br><span class=\"line\">LANG=en_GB.UTF-8 <span class=\"comment\">#推荐使用，而不是zh_CN</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"hostname-amp-hosts\"><a href=\"#hostname-amp-hosts\" class=\"headerlink\" title=\"hostname&amp;hosts\"></a>hostname&amp;hosts</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#创建/etc/hostname文件</span></span><br><span class=\"line\">nano /etc/hostname</span><br><span class=\"line\">---</span><br><span class=\"line\">LHCOMPUTER <span class=\"comment\">#写入主机名称</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#编辑/etc/hosts</span></span><br><span class=\"line\">nano /etc/hosts</span><br><span class=\"line\">---</span><br><span class=\"line\">127.0.0.1    localhost</span><br><span class=\"line\">::1        localhost</span><br><span class=\"line\">127.0.1.1    LHCOMPUTER.localdomain    LHCOMPUTER <span class=\"comment\">#添加</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"设置Root用户密码\"><a href=\"#设置Root用户密码\" class=\"headerlink\" title=\"设置Root用户密码\"></a>设置Root用户密码</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">passwd</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"安装引导程序\"><a href=\"#安装引导程序\" class=\"headerlink\" title=\"安装引导程序\"></a>安装引导程序</h3><p>前面的步骤已经基本完成对启动系统的配置，现在需要计算机引导启动系统，我选择使用<a href=\"https://wiki.archlinux.org/index.php/GRUB_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)\">GRUB</a>，以下是在EFI 系统分区下的命令：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB</span><br><span class=\"line\">grub-mkconfig -o /boot/grub/grub.cfg</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"完成\"><a href=\"#完成\" class=\"headerlink\" title=\"完成\"></a>完成</h3><p>输入 <code>exit</code> 或按 <code>Ctrl+d</code> 退出 Chroot 环境。<br>可选用 <code>umount -R /mnt</code> 手动卸载被挂载的分区。<br>最后执行 <code>reboot</code> 重启系统。</p>\n<h2 id=\"使用新系统前的配置\"><a href=\"#使用新系统前的配置\" class=\"headerlink\" title=\"使用新系统前的配置\"></a>使用新系统前的配置</h2><h3 id=\"选择网络管理程序\"><a href=\"#选择网络管理程序\" class=\"headerlink\" title=\"选择网络管理程序\"></a>选择网络管理程序</h3><p>系统默认已安装<a href=\"https://wiki.archlinux.org/index.php/Systemd-networkd_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)\">systemd-networkd</a>，以下步骤配置并开启。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">networkctl <span class=\"comment\">#获取有关网络链接的状态信息</span></span></span><br><span class=\"line\">IDX LINK             TYPE               OPERATIONAL SETUP     </span><br><span class=\"line\">1 lo               loopback           carrier     unmanaged </span><br><span class=\"line\">2 ens33            ether              routable    unmanaged </span><br><span class=\"line\">3 wlp2s0           wlan               off         unmanaged </span><br><span class=\"line\">4 vmnet1           ether              routable    unmanaged </span><br><span class=\"line\">5 vmnet8           ether              routable    unmanaged </span><br><span class=\"line\">5 links listed.</span><br></pre></td></tr></table></figure>\n\n<p>其中ens33为有线网卡，wlp2s0为无线网卡。</p>\n<h4 id=\"配置有线\"><a href=\"#配置有线\" class=\"headerlink\" title=\"配置有线\"></a>配置有线</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nano /etc/systemd/network/dhcp.network</span><br><span class=\"line\">---</span><br><span class=\"line\">[Match]</span><br><span class=\"line\">Name=ens33</span><br><span class=\"line\"> </span><br><span class=\"line\">[Network]</span><br><span class=\"line\">DHCP=<span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"comment\">#Address=192.168.1.20/24</span></span><br><span class=\"line\"><span class=\"comment\">#Gateway=192.168.1.1</span></span><br><span class=\"line\"><span class=\"comment\">#DNS=119.29.29.29</span></span><br><span class=\"line\"><span class=\"comment\">#DNS=8.8.8.8</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"配置无线\"><a href=\"#配置无线\" class=\"headerlink\" title=\"配置无线\"></a>配置无线</h4><p>需要先安装<a href=\"https://wiki.archlinux.org/title/Iwd_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)\">iwd</a>包，使用命令连接对应无线网络。</p>\n<ol>\n<li>要进入交互式提示符（interactive prompt），执行：<code>$ iwctl</code></li>\n<li><code>[iwd]# station device scan</code></li>\n<li><code>[iwd]# station device get-networks</code></li>\n<li><code>[iwd]# station device connect SSID</code>，会提示输入密码</li>\n</ol>\n<p>完成后，配置网络</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nano /etc/systemd/network/wireless.network</span><br><span class=\"line\">---</span><br><span class=\"line\">[Match]</span><br><span class=\"line\">Name=wlp2s0</span><br><span class=\"line\"> </span><br><span class=\"line\">[Network]</span><br><span class=\"line\">DHCP=<span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"开启自动服务\"><a href=\"#开启自动服务\" class=\"headerlink\" title=\"开启自动服务\"></a>开启自动服务</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl <span class=\"built_in\">enable</span> --now systemd-networkd.service</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> --now systemd-resolved.service <span class=\"comment\">#DNS</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"添加新用户\"><a href=\"#添加新用户\" class=\"headerlink\" title=\"添加新用户\"></a>添加新用户</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">groupadd liaoheng</span><br><span class=\"line\">useradd -m -g liaoheng liaoheng</span><br><span class=\"line\">passwd liaoheng</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"安装sudo\"><a href=\"#安装sudo\" class=\"headerlink\" title=\"安装sudo\"></a>安装<code>sudo</code></h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pacman -S sudo</span><br><span class=\"line\">nano /etc/sudoers<span class=\"comment\">#下面内容到文件末尾</span></span><br><span class=\"line\">---</span><br><span class=\"line\">Defaults targetpw</span><br><span class=\"line\">liaoheng ALL=(ALL) ALL</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"开机时打开-Num-Lock\"><a href=\"#开机时打开-Num-Lock\" class=\"headerlink\" title=\"开机时打开 Num Lock\"></a>开机时打开 <code>Num Lock</code></h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo pacman -S systemd-numlockontty</span><br><span class=\"line\">sudo systemctl <span class=\"built_in\">enable</span> --now numLockOnTty.service</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"软件仓库-可选\"><a href=\"#软件仓库-可选\" class=\"headerlink\" title=\"软件仓库(可选)\"></a>软件仓库(可选)</h3><blockquote>\n<p>可以登录<code>liaoheng</code>账户</p>\n</blockquote>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo pacman -Syu</span><br></pre></td></tr></table></figure>\n\n<p>添加Arch Linux Chinese Community Repository，编辑<code>/etc/pacman.conf</code>，添加</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo nano /etc/pacman.conf</span><br><span class=\"line\">---</span><br><span class=\"line\">[archlinuxcn]</span><br><span class=\"line\">Server = https://mirrors.ustc.edu.cn/archlinuxcn/<span class=\"variable\">$arch</span></span><br></pre></td></tr></table></figure>\n\n<p>导入PGP keys:</p>\n<blockquote>\n<p><a href=\"https://github.com/archlinuxcn/repo/issues/522\">失败解决办法</a></p>\n</blockquote>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo pacman -Syy &amp;&amp; sudo pacman -S archlinuxcn-keyring</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"图形界面\"><a href=\"#图形界面\" class=\"headerlink\" title=\"图形界面\"></a>图形界面</h3><h4 id=\"GNOME\"><a href=\"#GNOME\" class=\"headerlink\" title=\"GNOME\"></a><a href=\"https://wiki.archlinux.org/index.php/GNOME_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)\">GNOME</a></h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo pacman -S gnome gnome-extra gnome-tweak-tool</span><br><span class=\"line\">sudo pacman -S networkmanager</span><br><span class=\"line\">sudo systemctl <span class=\"built_in\">enable</span> NetworkManager</span><br><span class=\"line\">sudo systemctl <span class=\"built_in\">enable</span> --now gdm.service</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ul>\n<li><a href=\"https://wiki.archlinux.org/index.php/Installation_guide_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)\">Installation guide</a></li>\n<li><a href=\"https://wiki.archlinux.org/index.php/Partitioning_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#%E5%B8%83%E5%B1%80%E7%A4%BA%E4%BE%8B\">Partitioning</a></li>\n<li><a href=\"https://wiki.archlinux.org/index.php/EFI_system_partition\">EFI_system_partition</a></li>\n<li><a href=\"https://wiki.archlinux.org/index.php/Fstab_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)\">fstab </a></li>\n</ul>\n","site":{"data":{"next":{"favicon":{"small":"/images/favicon-16x16.png","medium":"/images/favicon-32x32.png","apple_touch_icon":"/images/apple-touch-icon.png","safari_pinned_tab":"/images/safari_pinned_tab.svg"},"creative_commons":{"license":"by-nc-sa","sidebar":true,"post":true,"language":"deed.zh"},"scheme":"Gemini","darkmode":true,"avatar":{"url":"/images/avatar.jpg","rounded":true,"rotated":false},"social":{"GitHub":"https://github.com/liaoheng || fab fa-github","RSS":"/atom.xml || fa fa-rss"},"social_icons":{"enable":true,"icons_only":true,"transition":true},"codeblock":{"highlight_theme":"normal","copy_button":{"enable":true,"show_result":true,"style":null}},"github_banner":{"enable":true,"permalink":"https://github.com/liaoheng","title":"Follow me on GitHub"},"google_analytics":{"tracking_id":"G-64FL8LWFL8","only_pageview":false},"vendors":{"pace":"//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js","pace_css":"//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css"},"pace":{"enable":true,"theme":"minimal"}}}},"excerpt":"","more":"<img src=\"https://archlinux.org/static/logos/archlinux-logo-dark-1200dpi.b42bd35d5916.png\" style=\"zoom:5%;\" />\n\n<p>本人跟随<a href=\"https://wiki.archlinux.org/title/Installation_guide_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)\">Arch Linux官方安装指南</a>操作过程的一些记录。</p>\n<h2 id=\"准备\"><a href=\"#准备\" class=\"headerlink\" title=\"准备\"></a>准备</h2><blockquote>\n<p> 下载ISO文件并启动到 Live 环境，注意<a href=\"https://wiki.archlinux.org/title/Unified_Extensible_Firmware_Interface_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)/Secure_Boot_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)\">安全启动（Secure Boot）</a>的问题。</p>\n</blockquote>\n<p><a href=\"https://archlinux.org/download/\">官方下载地址</a></p>\n<h3 id=\"验证启动模式-非必须\"><a href=\"#验证启动模式-非必须\" class=\"headerlink\" title=\"验证启动模式(非必须)\"></a>验证启动模式(非必须)</h3><p>请用下列命令列出 <a href=\"https://wiki.archlinux.org/index.php/Efivars\">efivars</a> 目录：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ls /sys/firmware/efi/efivars</span><br></pre></td></tr></table></figure>\n\n<p>目录存在，操作系统使用UEFI模式启动，反之使用传统模式启动(BIOS,CSM)。</p>\n<h3 id=\"网络连接\"><a href=\"#网络连接\" class=\"headerlink\" title=\"网络连接\"></a>网络连接</h3><p><strong>安装过程需要连接互联网</strong>，Live环境默认开启DHCP，其它方式可以参考<a href=\"https://wiki.archlinux.org/index.php/Installation_guide_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#%E8%BF%9E%E6%8E%A5%E5%88%B0%E5%9B%A0%E7%89%B9%E7%BD%91\">连接到因特网</a>，</p>\n<h3 id=\"更新系统时间\"><a href=\"#更新系统时间\" class=\"headerlink\" title=\"更新系统时间\"></a>更新系统时间</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">timedatectl set-ntp true</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"建立硬盘分区\"><a href=\"#建立硬盘分区\" class=\"headerlink\" title=\"建立硬盘分区\"></a>建立硬盘分区</h3><blockquote>\n<p>使用<code>fdisk</code>分区，可以查看这篇<a href=\"https://www.cnblogs.com/lsgxeva/p/9610003.html\">博文</a>有详细的使用说明</p>\n</blockquote>\n<p>查看分区列表</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fdisk -l</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://s3.jpg.cm/2021/07/28/IVXRYh.png\" alt=\"IVXRYh.png\"></p>\n<p>其中<code>/dev/sda</code>代表第一块物理磁盘(<code>/dev/sdb,/dev/sdc</code>与之类推)</p>\n<p>操作对应磁盘(<code>/dev/sda</code>)分区</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fdisk /dev/sda</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">进入fdisk应用命令行：</span></span><br><span class=\"line\">g #如果没有分区表或者是MBR表先删除，创建一个新的空GPT分区表</span><br><span class=\"line\">n #创建新的分区</span><br><span class=\"line\">t #改变分区类型</span><br><span class=\"line\">w #保存并退出</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://s3.jpg.cm/2021/07/28/IVXqCS.png\" alt=\"IVXqCS.png\"></p>\n<p>新建分区之后需要指定分区类型，使用命令<code>t &#123;partition number &#125;</code>，可以参考下表配置分区：</p>\n<table>\n<thead>\n<tr>\n<th>Mount point</th>\n<th>Partition</th>\n<th><a href=\"https://en.wikipedia.org/wiki/GUID_Partition_Table#Partition_type_GUIDs\">Partition type GUID</a></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>&#x2F;boot</td>\n<td>&#x2F;dev&#x2F;sda1</td>\n<td><code>C12A7328-F81F-11D2-BA4B-00A0C93EC93B</code>: <a href=\"https://wiki.archlinux.org/index.php/EFI_system_partition\">EFI system partition</a></td>\n</tr>\n<tr>\n<td>[SWAP]</td>\n<td>&#x2F;dev&#x2F;sda2</td>\n<td><code>0657FD6D-A4AB-43C4-84E5-0933C84B4F4F</code>: Linux <a href=\"https://wiki.archlinux.org/index.php/Swap\">swap</a></td>\n</tr>\n<tr>\n<td>&#x2F;home</td>\n<td>&#x2F;dev&#x2F;sda3</td>\n<td><code>933AC7E1-2EB4-4F13-B844-0E14E2AEF915</code>: Linux &#x2F;home</td>\n</tr>\n<tr>\n<td>&#x2F;</td>\n<td>&#x2F;dev&#x2F;sda4</td>\n<td><code>4F68BCE3-E8CD-4DB1-96E7-FBCAF984B709</code>: Linux x86-64 root (&#x2F;)</td>\n</tr>\n</tbody></table>\n<p>通过<code>t</code>命令可以查看更多类型，PgUp向上,PgDn向下,q退出。</p>\n<h3 id=\"格式化分区\"><a href=\"#格式化分区\" class=\"headerlink\" title=\"格式化分区\"></a>格式化分区</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkfs.fat -F32 /dev/sda1 #EFI system partition(ESP)</span><br><span class=\"line\">mkswap /dev/sda2 #swap</span><br><span class=\"line\">mkfs.ext4 /dev/sda3 #/home</span><br><span class=\"line\">mkfs.ext4 /dev/sda4 #/</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"挂载分区\"><a href=\"#挂载分区\" class=\"headerlink\" title=\"挂载分区\"></a>挂载分区</h3><p>将根磁盘卷 <a href=\"https://wiki.archlinux.org/index.php/Mount\">挂载</a> 到 <code>/mnt</code>，例如：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mount /dev/sda4 /mnt #挂载/</span><br><span class=\"line\">mkdir /mnt/boot</span><br><span class=\"line\">mount /dev/sda1 /mnt/boot #挂载ESP</span><br><span class=\"line\">mkdir /mnt/home</span><br><span class=\"line\">mount /dev/sda3 /mnt/home #挂载/home</span><br><span class=\"line\">swapon /dev/sda2 #挂载swap</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"安装系统\"><a href=\"#安装系统\" class=\"headerlink\" title=\"安装系统\"></a>安装系统</h2><h3 id=\"选择一个合适的镜像-可选\"><a href=\"#选择一个合适的镜像-可选\" class=\"headerlink\" title=\"选择一个合适的镜像(可选)\"></a>选择一个合适的镜像(可选)</h3><p><a href=\"https://wiki.archlinux.org/title/Mirrors_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#%E4%B8%AD%E5%9B%BD\">非官方镜像列表</a></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nano /etc/pacman.d/mirrorlist</span><br><span class=\"line\">---</span><br><span class=\"line\">Server = https://mirrors.ustc.edu.cn/archlinux/$repo/os/$arch #文件第一排写入</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"安装配置\"><a href=\"#安装配置\" class=\"headerlink\" title=\"安装配置\"></a>安装配置</h3><p>这几个包按照需求选择是否添加 <a href=\"https://wiki.archlinux.org/title/Nano_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)\">nano</a>, <a href=\"https://wiki.archlinux.org/title/GRUB_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)\">grub</a>, <a href=\"https://wiki.archlinux.org/title/Unified_Extensible_Firmware_Interface_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#efibootmgr\">efibootmgr</a>, <a href=\"https://wiki.archlinux.org/title/Iwd_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)\">iwd</a></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pacstrap /mnt base linux linux-firmware nano grub efibootmgr iwd</span><br><span class=\"line\">genfstab -U /mnt &gt;&gt; /mnt/etc/fstab  #定义磁盘分区</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"通过Chroot进入安装系统\"><a href=\"#通过Chroot进入安装系统\" class=\"headerlink\" title=\"通过Chroot进入安装系统\"></a>通过Chroot进入安装系统</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">arch-chroot /mnt <span class=\"comment\"># 进入安装好的arch linux系统</span></span><br></pre></td></tr></table></figure>\n<p>在当前Live Linux中通过<a href=\"https://wiki.archlinux.org/title/Chroot_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)\">Chroot</a>进入我们挂在到&#x2F;mnt下面的Arch Linux系统中(也就是我们这次安装的系统)，以下操作均在其中</p>\n<h3 id=\"时间-x2F-时区\"><a href=\"#时间-x2F-时区\" class=\"headerlink\" title=\"时间&#x2F;时区\"></a>时间&#x2F;时区</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">ln</span> -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime  <span class=\"comment\">#设置时区</span></span><br><span class=\"line\">hwclock --systohc <span class=\"comment\">#硬件时间设置为UTC</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"本地化\"><a href=\"#本地化\" class=\"headerlink\" title=\"本地化\"></a>本地化</h3><p>编辑<code>/etc/locale.gen</code> 选择 <a href=\"https://wiki.archlinux.org/index.php/Locale_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)\">地区</a> ：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nano /etc/locale.gen <span class=\"comment\">#移除需要的地区前的#号</span></span><br><span class=\"line\">---</span><br><span class=\"line\">locale-gen <span class=\"comment\">#更新配置</span></span><br></pre></td></tr></table></figure>\n\n<p>然后创建<code>/etc/locale.conf</code> 文件，并添加 <a href=\"https://wiki.archlinux.org/index.php/Locale#Setting_the_system_locale\"> LANG 变量</a>：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nano /etc/locale.conf</span><br><span class=\"line\">---</span><br><span class=\"line\">LANG=en_GB.UTF-8 <span class=\"comment\">#推荐使用，而不是zh_CN</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"hostname-amp-hosts\"><a href=\"#hostname-amp-hosts\" class=\"headerlink\" title=\"hostname&amp;hosts\"></a>hostname&amp;hosts</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#创建/etc/hostname文件</span></span><br><span class=\"line\">nano /etc/hostname</span><br><span class=\"line\">---</span><br><span class=\"line\">LHCOMPUTER <span class=\"comment\">#写入主机名称</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#编辑/etc/hosts</span></span><br><span class=\"line\">nano /etc/hosts</span><br><span class=\"line\">---</span><br><span class=\"line\">127.0.0.1    localhost</span><br><span class=\"line\">::1        localhost</span><br><span class=\"line\">127.0.1.1    LHCOMPUTER.localdomain    LHCOMPUTER <span class=\"comment\">#添加</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"设置Root用户密码\"><a href=\"#设置Root用户密码\" class=\"headerlink\" title=\"设置Root用户密码\"></a>设置Root用户密码</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">passwd</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"安装引导程序\"><a href=\"#安装引导程序\" class=\"headerlink\" title=\"安装引导程序\"></a>安装引导程序</h3><p>前面的步骤已经基本完成对启动系统的配置，现在需要计算机引导启动系统，我选择使用<a href=\"https://wiki.archlinux.org/index.php/GRUB_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)\">GRUB</a>，以下是在EFI 系统分区下的命令：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB</span><br><span class=\"line\">grub-mkconfig -o /boot/grub/grub.cfg</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"完成\"><a href=\"#完成\" class=\"headerlink\" title=\"完成\"></a>完成</h3><p>输入 <code>exit</code> 或按 <code>Ctrl+d</code> 退出 Chroot 环境。<br>可选用 <code>umount -R /mnt</code> 手动卸载被挂载的分区。<br>最后执行 <code>reboot</code> 重启系统。</p>\n<h2 id=\"使用新系统前的配置\"><a href=\"#使用新系统前的配置\" class=\"headerlink\" title=\"使用新系统前的配置\"></a>使用新系统前的配置</h2><h3 id=\"选择网络管理程序\"><a href=\"#选择网络管理程序\" class=\"headerlink\" title=\"选择网络管理程序\"></a>选择网络管理程序</h3><p>系统默认已安装<a href=\"https://wiki.archlinux.org/index.php/Systemd-networkd_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)\">systemd-networkd</a>，以下步骤配置并开启。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\">networkctl <span class=\"comment\">#获取有关网络链接的状态信息</span></span></span><br><span class=\"line\">IDX LINK             TYPE               OPERATIONAL SETUP     </span><br><span class=\"line\">1 lo               loopback           carrier     unmanaged </span><br><span class=\"line\">2 ens33            ether              routable    unmanaged </span><br><span class=\"line\">3 wlp2s0           wlan               off         unmanaged </span><br><span class=\"line\">4 vmnet1           ether              routable    unmanaged </span><br><span class=\"line\">5 vmnet8           ether              routable    unmanaged </span><br><span class=\"line\">5 links listed.</span><br></pre></td></tr></table></figure>\n\n<p>其中ens33为有线网卡，wlp2s0为无线网卡。</p>\n<h4 id=\"配置有线\"><a href=\"#配置有线\" class=\"headerlink\" title=\"配置有线\"></a>配置有线</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nano /etc/systemd/network/dhcp.network</span><br><span class=\"line\">---</span><br><span class=\"line\">[Match]</span><br><span class=\"line\">Name=ens33</span><br><span class=\"line\"> </span><br><span class=\"line\">[Network]</span><br><span class=\"line\">DHCP=<span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"comment\">#Address=192.168.1.20/24</span></span><br><span class=\"line\"><span class=\"comment\">#Gateway=192.168.1.1</span></span><br><span class=\"line\"><span class=\"comment\">#DNS=119.29.29.29</span></span><br><span class=\"line\"><span class=\"comment\">#DNS=8.8.8.8</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"配置无线\"><a href=\"#配置无线\" class=\"headerlink\" title=\"配置无线\"></a>配置无线</h4><p>需要先安装<a href=\"https://wiki.archlinux.org/title/Iwd_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)\">iwd</a>包，使用命令连接对应无线网络。</p>\n<ol>\n<li>要进入交互式提示符（interactive prompt），执行：<code>$ iwctl</code></li>\n<li><code>[iwd]# station device scan</code></li>\n<li><code>[iwd]# station device get-networks</code></li>\n<li><code>[iwd]# station device connect SSID</code>，会提示输入密码</li>\n</ol>\n<p>完成后，配置网络</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nano /etc/systemd/network/wireless.network</span><br><span class=\"line\">---</span><br><span class=\"line\">[Match]</span><br><span class=\"line\">Name=wlp2s0</span><br><span class=\"line\"> </span><br><span class=\"line\">[Network]</span><br><span class=\"line\">DHCP=<span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"开启自动服务\"><a href=\"#开启自动服务\" class=\"headerlink\" title=\"开启自动服务\"></a>开启自动服务</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl <span class=\"built_in\">enable</span> --now systemd-networkd.service</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> --now systemd-resolved.service <span class=\"comment\">#DNS</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"添加新用户\"><a href=\"#添加新用户\" class=\"headerlink\" title=\"添加新用户\"></a>添加新用户</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">groupadd liaoheng</span><br><span class=\"line\">useradd -m -g liaoheng liaoheng</span><br><span class=\"line\">passwd liaoheng</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"安装sudo\"><a href=\"#安装sudo\" class=\"headerlink\" title=\"安装sudo\"></a>安装<code>sudo</code></h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pacman -S sudo</span><br><span class=\"line\">nano /etc/sudoers<span class=\"comment\">#下面内容到文件末尾</span></span><br><span class=\"line\">---</span><br><span class=\"line\">Defaults targetpw</span><br><span class=\"line\">liaoheng ALL=(ALL) ALL</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"开机时打开-Num-Lock\"><a href=\"#开机时打开-Num-Lock\" class=\"headerlink\" title=\"开机时打开 Num Lock\"></a>开机时打开 <code>Num Lock</code></h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo pacman -S systemd-numlockontty</span><br><span class=\"line\">sudo systemctl <span class=\"built_in\">enable</span> --now numLockOnTty.service</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"软件仓库-可选\"><a href=\"#软件仓库-可选\" class=\"headerlink\" title=\"软件仓库(可选)\"></a>软件仓库(可选)</h3><blockquote>\n<p>可以登录<code>liaoheng</code>账户</p>\n</blockquote>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo pacman -Syu</span><br></pre></td></tr></table></figure>\n\n<p>添加Arch Linux Chinese Community Repository，编辑<code>/etc/pacman.conf</code>，添加</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo nano /etc/pacman.conf</span><br><span class=\"line\">---</span><br><span class=\"line\">[archlinuxcn]</span><br><span class=\"line\">Server = https://mirrors.ustc.edu.cn/archlinuxcn/<span class=\"variable\">$arch</span></span><br></pre></td></tr></table></figure>\n\n<p>导入PGP keys:</p>\n<blockquote>\n<p><a href=\"https://github.com/archlinuxcn/repo/issues/522\">失败解决办法</a></p>\n</blockquote>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo pacman -Syy &amp;&amp; sudo pacman -S archlinuxcn-keyring</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"图形界面\"><a href=\"#图形界面\" class=\"headerlink\" title=\"图形界面\"></a>图形界面</h3><h4 id=\"GNOME\"><a href=\"#GNOME\" class=\"headerlink\" title=\"GNOME\"></a><a href=\"https://wiki.archlinux.org/index.php/GNOME_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)\">GNOME</a></h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo pacman -S gnome gnome-extra gnome-tweak-tool</span><br><span class=\"line\">sudo pacman -S networkmanager</span><br><span class=\"line\">sudo systemctl <span class=\"built_in\">enable</span> NetworkManager</span><br><span class=\"line\">sudo systemctl <span class=\"built_in\">enable</span> --now gdm.service</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><ul>\n<li><a href=\"https://wiki.archlinux.org/index.php/Installation_guide_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)\">Installation guide</a></li>\n<li><a href=\"https://wiki.archlinux.org/index.php/Partitioning_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#%E5%B8%83%E5%B1%80%E7%A4%BA%E4%BE%8B\">Partitioning</a></li>\n<li><a href=\"https://wiki.archlinux.org/index.php/EFI_system_partition\">EFI_system_partition</a></li>\n<li><a href=\"https://wiki.archlinux.org/index.php/Fstab_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)\">fstab </a></li>\n</ul>\n"},{"title":"传统蓝牙协议栈初探","date":"2022-04-11T09:05:36.000Z","_content":"\n# 概述\n\n此文主要是简单的探索一下蓝牙电话和蓝牙音乐相关协议栈，所以很多细节并未涉及。\n\n一般而言，我们把某个协议的实现代码称为协议栈(protocol stack)，要理解协议栈需要先了解蓝牙的核心系统架构，如下图：\n\n![](https://s1.ax1x.com/2022/04/11/LV6Ybd.png)\n\n也可简单的**抽象为3层**：![](https://s1.ax1x.com/2022/04/11/LV6JDH.png)\n\n- **User Application(Host)**：User Application即应用层，也被称为Host，我们调用Bluetooth API就属于应用层，例如，[BluetoothAdapter](https://developer.android.com/reference/android/bluetooth/BluetoothAdapter.html)中提供的接口。\n- **HCI (Host controller Interface)**：上层在调用蓝牙API时，**不会直接操作蓝牙底层**(Controller)相关接口，而是**通过HCI下发对应操作的Command给Controller**，然后底层执行命令后返回执行结果，**即Controller发送Event给HCI，HCI再通知给应用层**，HCI起到了一个**中间层**的作用。\n- **Controller**：Controller是在最底层，硬件驱动。\n\n按照上面的定义，HCI与Host层中的协议实现就是**蓝牙协议栈**。\n\n## HCI\n\n>  BLUETOOTH SPECIFICATION Version 4.2 [Vol 2, Part E] page 400  \n>\n>  HCI（HOST CONTROLLER INTERFACE）：主机控制层接口，主要负责透过transport把协议栈的数据发送给蓝牙芯片，并且接受来自蓝牙芯片的数据，数据主要分为HCI COMMAND(HOST->CONTROLLER),HCI EVENT(HOST<-CONTROLLER),HCI ACL(HOST<->CONTROLLER),HCI SCO(这个有点些微差异，因为部分芯片的SCO数据不是透过TRANSPORT直接跟HOST沟通，而是通过特殊的引脚，PCM IN/OUT/SYNC/CLK脚来传输数据)\n\nHOST层的几乎所有数据最后都会通过HCI，所以我们通过HCI的日志就可以了解蓝牙协议栈中每个协议，手机中可以通过开发者模式打开HCI日志开关，推荐使用**wireshark**或者**Frontline ComProbe Protocol Analysis System**来分析HCI日志，下面给出来的的日志都是**wireshark**的结果。\n\nHCI日志由各种数据包组成，我们需要了解其中的两种数据包如下：\n\n### Command 数据包\n\nHCI Command数据包格式如下，开头的**Opcode是区分不同类型的命令的唯一标识**，Opcode由**OpCode Group Field (OGF)** 和 **OpCode Command Field (OCF)**组成。根据OGF的值，可以将HCI commands进行分类。OpCode 的计算公式为：`OpCode = OGF << 6 + OCF` **。有了OpCode计算的方式，我们就可以**通过OpCode过滤HCI log里面的指定类型的HCI Command。\n\n![](https://s1.ax1x.com/2022/04/11/LV608f.png)\n\n一次HCI Command指令发送完成，通常两条数据包，一条是host给controller的指令，一条是controller给host的指令反馈，可以确定指令发送是成功的。\n\n### Event 数据包\n\nHCI Event 数据包由controller发送给Host，其中可以是蓝牙设备的消息也可以是连接的蓝牙设备的消息。\n\n![](https://s1.ax1x.com/2022/04/11/LV6B28.png)\n\n# 设备连接\n\n## 蓝牙设备状态\n\n> BLUETOOTH SPECIFICATION Version 4.2 [Vol 2, Part B] page 159  \n\n扫描设备然后与之建立连接是蓝牙工作流程的第一步，所以先要了解一下蓝牙的状态如下图：\n\n![](https://s1.ax1x.com/2022/04/11/LV6wPP.png)\n\n从<u>蓝牙状态转换图</u>中可以看出 STANDBY状体是蓝牙设备的默认状态。\n\n**Page**：这个子状态就是我们通常称为的连接(寻呼)，进行连接/激活对应的slave的操作我们就称为page。\n\n**Page scan**：这个子状态是和page对应的，它就是等待被page的slave所处的状态，换句话说，若想被page到，我们就要处于page scan的状态。\n\n**inquiry**：这就是我们通常所说的扫描状态，这个状态的设备就是去扫描周围的设备。\n\n**inquiry scan**：这就是我们通常看到的可被发现的设备。体现在上层就是我们在android系统中点击设备可被周围什么发现，那设备就处于这样的状态。\n\n## 逻辑链路传输协议\n\n### ACL\n\n> BLUETOOTH SPECIFICATION Version 4.2 [Vol 1, Part A]  page  63  \n>\n> The asynchronous connection-oriented (ACL) logical transport is used to carry\n> LMP and L2CAP control signaling and best effort asynchronous user data. The\n> ACL logical transport uses a 1-bit ARQN/SEQN scheme to provide simple\n> channel reliability. Every active slave device within a piconet has one ACL\n> logical transport to the piconet master, known as the default ACL.  \n\nACL全称**BR/EDR Asynchronous Connection-oriented**，定向连接，它既支持对称连接，也支持不对称连接（既可以一对一，也可以一对多）。主设备负责控制链路带宽，并决定微微网中的每个从设备可以占用多少带宽和连接的对称性。从设备只有被选中时才能传送数据。ACL链路也支持接收主设备发给微微网中所有从设备的广播消息。\n\n建立ACL需要设备HCI之间进行的下面的操作，这个也与**蓝牙状态**息息相关。\n\n#### 开始扫描\n\n- **Host**:\n\n  ```java\n  LocalBluetoothManager.getInstance().getBluetoothAdapter().startScanning(true);\n  ```\n\n- **Controller**:\n\n  ```dtd\n  #发送扫描指令\n  > 103\t4.351128\thost\tcontroller\tHCI_CMD\t9\tSent Inquiry\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - Inquiry\n      Command Opcode: Inquiry (0x0401)\n          0000 01.. .... .... = Opcode Group Field: Link Control Commands (0x01)\n          .... ..00 0000 0001 = Opcode Command Field: Inquiry (0x001)\n      Parameter Total Length: 5\n      LAP: 0x9e8b33\n      Inquiry Length: 10 (12.8 sec)\n      Num Responses: 0\n      [Pending in frame: 104]\n      [Command-Pending Delta: 0.846ms]\n      [Response in frame: 429]\n      [Command-Response Delta: 12811.07ms]\n  \n  #HCI反馈扫描指令状态\n  > 104\t4.351974\tcontroller\thost\tHCI_EVT\t7\tRcvd Command Status (Inquiry)\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Command Status\n      Event Code: Command Status (0x0f)\n      Parameter Total Length: 4\n      Status: Pending (0x00)\n      Number of Allowed Command Packets: 1\n      Command Opcode: Inquiry (0x0401)\n      [Command in frame: 103]\n      [Response in frame: 429]\n      [Command-Pending Delta: 0.846ms]\n      [Pending-Response Delta: 12810.224ms]\n  \n  #HCI发送的扫描到的设备信息\n  > 114\t4.505582\tcontroller\thost\tHCI_EVT\t258\tRcvd Extended Inquiry Result\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Extended Inquiry Result\n      Event Code: Extended Inquiry Result (0x2f)\n      Parameter Total Length: 255\n      Number of responses: 1\n      BD_ADDR: XiaomiCo_77:c2:35 (00:00:00:00:00:00)\n      Page Scan Repetition Mode: R1 (0x01)\n      Reserved: 0x02\n      Class of Device: 0x5a020c (Phone:Smartphone - services: Networking Capturing ObjectTransfer Telephony)\n      .000 0000 0011 0100 = Clock Offset: 0x0034\n      RSSI: -88 dBm\n      Extended Inquiry Response Data\n          Device Name: +My Phone1234567890123456789012\n          16-bit Service Class UUIDs\n          32-bit Service Class UUIDs\n          128-bit Service Class UUIDs\n          Unused\n  \n  ```\n\n#### 停止扫描\n\n- **Host**:\n\n    ```java\n    LocalBluetoothManager.getInstance().getBluetoothAdapter().stopScanning();\n    ```\n\n- **Controller**:\n\n  ```dtd\n  > 85\t2.202129\thost\tcontroller\tHCI_CMD\t4\tSent Inquiry Cancel\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - Inquiry Cancel\n      Command Opcode: Inquiry Cancel (0x0402)\n          0000 01.. .... .... = Opcode Group Field: Link Control Commands (0x01)\n          .... ..00 0000 0010 = Opcode Command Field: Inquiry Cancel (0x002)\n      Parameter Total Length: 0\n      [Response in frame: 86]\n      [Command-Response Delta: 2.051ms]\n  \n  > 86\t2.204180\tcontroller\thost\tHCI_EVT\t7\tRcvd Command Complete (Inquiry Cancel)\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Command Complete\n      Event Code: Command Complete (0x0e)\n      Parameter Total Length: 4\n      Number of Allowed Command Packets: 1\n      Command Opcode: Inquiry Cancel (0x0402)\n      Status: Success (0x00)\n      [Command in frame: 85]\n      [Command-Response Delta: 2.051ms]\n  ```\n\n#### 完成扫描\n\n- **Host**:\n\n  ```java\n  LocalBluetoothManager.getInstance().getEventManager().registerCallback(new BluetoothCallback() {\n     \t\t@Override\n  \t\tpublic void onScanningStateChanged(boolean started) {\n  \t\t} \n  });\n  ```\n\n- **Controller**:\n\n  ```dtd\n  > 429\t17.162198\tcontroller\thost\tHCI_EVT\t4\tRcvd Inquiry Complete\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Inquiry Complete\n      Event Code: Inquiry Complete (0x01)\n      Parameter Total Length: 1\n      Status: Success (0x00)\n      [Command in frame: 103]\n      [Pending in frame: 104]\n      [Pending-Response Delta: 12810.224ms]\n      [Command-Response Delta: 12811.07ms]\n  ```\n\n#### 设备配对\n\n![](https://s1.ax1x.com/2022/04/11/LV6GKe.png)\n\n##### 配对\n\n- **Host**:\n\n  ```java\n  CachedBluetoothDevice.startPairing();\n  ```\n  \n- **Controller**:\n\n  ```dtd\n  #删除需要连接设备本地记忆的Link Key\n  > 685\t33.812149\thost\tcontroller\tHCI_CMD\t11\tSent Delete Stored Link Key\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - Delete Stored Link Key\n      Command Opcode: Delete Stored Link Key (0x0c12)\n          0000 11.. .... .... = Opcode Group Field: Host Controller & Baseband Commands (0x03)\n          .... ..00 0001 0010 = Opcode Command Field: Delete Stored Link Key (0x012)\n      Parameter Total Length: 7\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Delete All Flag: Delete only Link Key for specified BD_ADDR (0x00)\n      [Response in frame: 686]\n      [Command-Response Delta: 2.147ms]\n  \n  #建立ACL连接\n  > 687\t33.814531\thost\tcontroller\tHCI_CMD\t17\tSent Create Connection\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - Create Connection\n      Command Opcode: Create Connection (0x0405)\n      Parameter Total Length: 13\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Packet Type: 0xcc18, DH5, DM5, DH3, DM3, DH1, DM1\n      Page Scan Repetition Mode: R1 (0x01)\n      Page Scan Mode: Mandatory Page Scan Mode (0x00)\n      .000 0010 0000 1000 = Clock Offset: 0x0208 (650 msec)\n      1... .... .... .... = Clock_Offset_Valid_Flag: true (1)\n      Allow Role Switch: Local device may be master, or may become slave after accepting a master slave switch. (0x01)\n      [Pending in frame: 688]\n      [Command-Pending Delta: 0.965ms]\n      [Response in frame: 690]\n      [Command-Response Delta: 1118.609ms]\n  \n  #建立ACL连接成功\n  > 690\t34.933140\tcontroller\thost\tHCI_EVT\t14\tRcvd Connect Complete\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Connect Complete\n      Event Code: Connect Complete (0x03)\n      Parameter Total Length: 11\n      Status: Success (0x00)\n      Connection Handle: 0x0033\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Link Type: ACL connection (Data Channels) (0x01)\n      Encryption Mode: Encryption Disabled (0x00)\n      [Command in frame: 687]\n      [Pending in frame: 688]\n      [Pending-Response Delta: 1117.644ms]\n      [Command-Response Delta: 1118.609ms]\n  \n  #改变当前设备的角色，这里当前设备为从(Slave)，连接设备为主(Master)\n  > 689\t34.929964\tcontroller\thost\tHCI_EVT\t11\tRcvd Role Change\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Role Change\n      Event Code: Role Change (0x12)\n      Parameter Total Length: 8\n      Status: Success (0x00)\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Role: Currently the Slave for specified BD_ADDR (0x01)\n  \n  #与设备建立连接之后，准备开始验证\n  > 697\t34.935615\thost\tcontroller\tHCI_CMD\t6\tSent Authentication Requested\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - Authentication Requested\n      Command Opcode: Authentication Requested (0x0411)\n      Parameter Total Length: 2\n      Connection Handle: 0x0033\n      [Pending in frame: 699]\n      [Command-Pending Delta: 0.917ms]\n      [Response in frame: 743]\n      [Command-Response Delta: 4291.694ms]\n  \n  #连接设备询问Link Key\n  > 701\t34.936976\tcontroller\thost\tHCI_EVT\t9\tRcvd Link Key Request\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Link Key Request\n      Event Code: Link Key Request (0x17)\n      Parameter Total Length: 6\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n  \n  #当前设备无Link Key，也就是未于连接设备配对过\n  > 705\t34.938603\thost\tcontroller\tHCI_CMD\t10\tSent Link Key Request Negative Reply\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - Link Key Request Negative Reply\n      Command Opcode: Link Key Request Negative Reply (0x040c)\n          0000 01.. .... .... = Opcode Group Field: Link Control Commands (0x01)\n          .... ..00 0000 1100 = Opcode Command Field: Link Key Request Negative Reply (0x00c)\n      Parameter Total Length: 6\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      [Response in frame: 706]\n      [Command-Response Delta: 0.87ms]\n  \n  #使用的配对方式是`简单安全配对`SSP(Simple Secure Pairng), 就是直接弹配对码\n  \n  #连接设备询问当前设备的IO能力\n  > 707\t34.939729\tcontroller\thost\tHCI_EVT\t9\tRcvd IO Capability Request\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - IO Capability Request\n      Event Code: IO Capability Request (0x31)\n      Parameter Total Length: 6\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n  \n  #回复当前设备的IO能力\n  >708\t34.939897\thost\tcontroller\tHCI_CMD\t13\tSent IO Capability Request Reply\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - IO Capability Request Reply\n      Command Opcode: IO Capability Request Reply (0x042b)\n          0000 01.. .... .... = Opcode Group Field: Link Control Commands (0x01)\n          .... ..00 0010 1011 = Opcode Command Field: IO Capability Request Reply (0x02b)\n      Parameter Total Length: 9\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      IO Capability: Display Yes/No (1)\n      OOB Data Present: OOB Authentication Data Not Present (0)\n      Authentication Requirements: MITM Protection Required - Dedicated Bonding. Use IO Capability To Determine Procedure, No Secure Connection (3)\n      [Response in frame: 709]\n      [Command-Response Delta: 0.811ms]\n  \n  ######其它参数同步\n  \n  #连接设备的IO能力，io能力参数为Display Yes/No (0x01)，需要用户确认\n  > 737\t36.532369\tcontroller\thost\tHCI_EVT\t12\tRcvd IO Capability Response\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - IO Capability Response\n      Event Code: IO Capability Response (0x32)\n      Parameter Total Length: 9\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      IO Capability: Display Yes/No (0x01)\n      OOB Data Present: OOB Authentication Data Not Present (0)\n      Authentication Requirements: MITM Protection Required - Dedicated Bonding. Use IO Capability To Determine Procedure, No Secure Connection (3)\n  \n  #当前设备接收到配对码信息，Numeric Value就是显示的配对码\n  > 738\t37.066181\tcontroller\thost\tHCI_EVT\t13\tRcvd User Confirmation Request\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - User Confirmation Request\n      Event Code: User Confirmation Request (0x33)\n      Parameter Total Length: 10\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Numeric Value: 446514\n  \n  #回复连接设备已接收到配对码信息\n  > 739\t37.096306\thost\tcontroller\tHCI_CMD\t10\tSent User Confirmation Request Reply\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - User Confirmation Request Reply\n      Command Opcode: User Confirmation Request Reply (0x042c)\n          0000 01.. .... .... = Opcode Group Field: Link Control Commands (0x01)\n          .... ..00 0010 1100 = Opcode Command Field: User Confirmation Request Reply (0x02c)\n      Parameter Total Length: 6\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      [Response in frame: 740]\n      [Command-Response Delta: 1.46ms]\n  \n  #连接设备SSP验证成功\n  > 741\t39.215747\tcontroller\thost\tHCI_EVT\t10\tRcvd Simple Pairing Complete\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Simple Pairing Complete\n      Event Code: Simple Pairing Complete (0x36)\n      Parameter Total Length: 7\n      Status: Success (0x00)\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n  \n  #连接设备的Link Key，需要保存，用于下次连接\n  > 742\t39.226970\tcontroller\thost\tHCI_EVT\t26\tRcvd Link Key Notification\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Link Key Notification\n      Event Code: Link Key Notification (0x18)\n      Parameter Total Length: 23\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Link Key: bc31fb070e91eec2f2296fbf9bc8b518\n      Key Type: Unknown (0x08)\n  \n  #验证完成\n  > 743\t39.227309\tcontroller\thost\tHCI_EVT\t6\tRcvd Authentication Complete\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Authentication Complete\n      Event Code: Authentication Complete (0x06)\n      Parameter Total Length: 3\n      Status: Success (0x00)\n      Connection Handle: 0x0033\n      [Command in frame: 697]\n      [Pending in frame: 699]\n      [Pending-Response Delta: 4290.777ms]\n      [Command-Response Delta: 4291.694ms]\n  ```\n\n##### 被配对\n\n- **Host**:\n\n  ```java\n  LocalBluetoothManager.getInstance().getEventManager().registerCallback(new BluetoothCallback() {\n     \t\t@Override\n  \t\tpublic void onDeviceBondStateChanged(CachedBluetoothDevice cachedDevice, int bondState) {\n  \t\t}\n  });\n  ```\n\n- **Controller**:\n\n  ```dtd\n  #请求ACL连接\n  > 326\t21.946869\tcontroller\thost\tHCI_EVT\t13\tRcvd Connect Request\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Connect Request\n      Event Code: Connect Request (0x04)\n      Parameter Total Length: 10\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Class of Device: 0x5a020c (Phone:Smartphone - services: Networking Capturing ObjectTransfer Telephony)\n      Link Type: ACL connection (Data Channels) (0x01)\n  \n  #允许ACL连接\n  > 327\t21.947178\thost\tcontroller\tHCI_CMD\t11\tSent Accept Connection Request\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - Accept Connection Request\n      Command Opcode: Accept Connection Request (0x0409)\n      Parameter Total Length: 7\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Role: Remain the Slave for this connection. The LM will NOT perform the role switch. (0x01)\n      [Pending in frame: 328]\n      [Command-Pending Delta: 0.685ms]\n      [Response in frame: 329]\n      [Command-Response Delta: 4.432ms]\n  \n  #ACL连接成功\n  > 329\t21.951610\tcontroller\thost\tHCI_EVT\t14\tRcvd Connect Complete\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Connect Complete\n      Event Code: Connect Complete (0x03)\n      Parameter Total Length: 11\n      Status: Success (0x00)\n      Connection Handle: 0x0033\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Link Type: ACL connection (Data Channels) (0x01)\n      Encryption Mode: Encryption Disabled (0x00)\n      [Command in frame: 327]\n      [Pending in frame: 328]\n      [Pending-Response Delta: 3.747ms]\n      [Command-Response Delta: 4.432ms]\n  \n  \n  > 370\t22.259461\tcontroller\thost\tHCI_EVT\t12\tRcvd IO Capability Response\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - IO Capability Response\n      Event Code: IO Capability Response (0x32)\n      Parameter Total Length: 9\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      IO Capability: Display Yes/No (0x01)\n      OOB Data Present: OOB Authentication Data Not Present (0)\n      Authentication Requirements: MITM Protection Required - Dedicated Bonding. Use IO Capability To Determine Procedure, No Secure Connection (3)\n  \n  > 371\t22.259809\tcontroller\thost\tHCI_EVT\t9\tRcvd IO Capability Request\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - IO Capability Request\n      Event Code: IO Capability Request (0x31)\n      Parameter Total Length: 6\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n  \n  > 372\t22.259982\thost\tcontroller\tHCI_CMD\t13\tSent IO Capability Request Reply\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - IO Capability Request Reply\n      Command Opcode: IO Capability Request Reply (0x042b)\n      Parameter Total Length: 9\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      IO Capability: Display Yes/No (1)\n      OOB Data Present: OOB Authentication Data Not Present (0)\n      Authentication Requirements: MITM Protection Required - Dedicated Bonding. Use IO Capability To Determine Procedure, No Secure Connection (3)\n      [Response in frame: 373]\n      [Command-Response Delta: 0.619ms]\n  \n  > 374\t22.958223\tcontroller\thost\tHCI_EVT\t13\tRcvd User Confirmation Request\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - User Confirmation Request\n      Event Code: User Confirmation Request (0x33)\n      Parameter Total Length: 10\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Numeric Value: 804568\n  \n  > 375\t23.069385\thost\tcontroller\tHCI_CMD\t10\tSent User Confirmation Request Reply\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - User Confirmation Request Reply\n      Command Opcode: User Confirmation Request Reply (0x042c)\n      Parameter Total Length: 6\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      [Response in frame: 376]\n      [Command-Response Delta: 1.81ms]\n  \n  #连接设备SSP验证成功\n  > 377\t26.919540\tcontroller\thost\tHCI_EVT\t10\tRcvd Simple Pairing Complete\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Simple Pairing Complete\n      Event Code: Simple Pairing Complete (0x36)\n      Parameter Total Length: 7\n      Status: Success (0x00)\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n  \n  #连接设备的Link Key，需要保存，用于下次连接\n  > 378\t26.926691\tcontroller\thost\tHCI_EVT\t26\tRcvd Link Key Notification\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Link Key Notification\n      Event Code: Link Key Notification (0x18)\n      Parameter Total Length: 23\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Link Key: 2160acf6b7403a97050f64de72570b1d\n      Key Type: Unknown (0x08)\n  ```\n  \n  \n\n#### 设备连接\n\n![](https://s1.ax1x.com/2022/04/11/LV63vD.png)\n\n##### 连接\n\n- **Host**:\n\n  ```java\n  CachedBluetoothDevice.conntect(true);\n  ```\n\n- **Controller**:\n\n  ```dtd\n  > 1214\t47.023224\thost\tcontroller\tHCI_CMD\t17\tSent Create Connection\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - Create Connection\n      Command Opcode: Create Connection (0x0405)\n      Parameter Total Length: 13\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Packet Type: 0xcc18, DH5, DM5, DH3, DM3, DH1, DM1\n      Page Scan Repetition Mode: R1 (0x01)\n      Page Scan Mode: Mandatory Page Scan Mode (0x00)\n      .011 1001 0100 0100 = Clock Offset: 0x3944 (18325 msec)\n      1... .... .... .... = Clock_Offset_Valid_Flag: true (1)\n      Allow Role Switch: Local device may be master, or may become slave after accepting a master slave switch. (0x01)\n      [Pending in frame: 1215]\n      [Command-Pending Delta: 1.458ms]\n      [Response in frame: 1217]\n      [Command-Response Delta: 1630.81ms]\n  \n  > 1216\t48.646874\tcontroller\thost\tHCI_EVT\t11\tRcvd Role Change\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Role Change\n      Event Code: Role Change (0x12)\n      Parameter Total Length: 8\n      Status: Success (0x00)\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Role: Currently the Slave for specified BD_ADDR (0x01)\n  \n  > 1217\t48.654034\tcontroller\thost\tHCI_EVT\t14\tRcvd Connect Complete\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Connect Complete\n      Event Code: Connect Complete (0x03)\n      Parameter Total Length: 11\n      Status: Success (0x00)\n      Connection Handle: 0x0033\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Link Type: ACL connection (Data Channels) (0x01)\n      Encryption Mode: Encryption Disabled (0x00)\n      [Command in frame: 1214]\n      [Pending in frame: 1215]\n      [Pending-Response Delta: 1629.352ms]\n      [Command-Response Delta: 1630.81ms]\n  \n  > 1278\t48.812485\thost\tcontroller\tHCI_CMD\t6\tSent Authentication Requested\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - Authentication Requested\n      Command Opcode: Authentication Requested (0x0411)\n      Parameter Total Length: 2\n      Connection Handle: 0x0033\n      [Pending in frame: 1279]\n      [Command-Pending Delta: 0.945ms]\n      [Response in frame: 1283]\n      [Command-Response Delta: 16.693ms]\n  \n  > 1280\t48.813892\tcontroller\thost\tHCI_EVT\t9\tRcvd Link Key Request\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Link Key Request\n      Event Code: Link Key Request (0x17)\n      Parameter Total Length: 6\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n  \n  > 1281\t48.814039\thost\tcontroller\tHCI_CMD\t26\tSent Link Key Request Reply\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - Link Key Request Reply\n      Command Opcode: Link Key Request Reply (0x040b)\n      Parameter Total Length: 22\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Link Key: 2160acf6b7403a97050f64de72570b1d\n      [Response in frame: 1282]\n      [Command-Response Delta: 1.336ms]\n  \n  > 1282\t48.815375\tcontroller\thost\tHCI_EVT\t13\tRcvd Command Complete (Link Key Request Reply)\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Command Complete\n      Event Code: Command Complete (0x0e)\n      Parameter Total Length: 10\n      Number of Allowed Command Packets: 1\n      Command Opcode: Link Key Request Reply (0x040b)\n      Status: Success (0x00)\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      [Command in frame: 1281]\n      [Command-Response Delta: 1.336ms]\n  \n  > 1283\t48.829178\tcontroller\thost\tHCI_EVT\t6\tRcvd Authentication Complete\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Authentication Complete\n      Event Code: Authentication Complete (0x06)\n      Parameter Total Length: 3\n      Status: Success (0x00)\n      Connection Handle: 0x0033\n      [Command in frame: 1278]\n      [Pending in frame: 1279]\n      [Pending-Response Delta: 15.748ms]\n      [Command-Response Delta: 16.693ms]\n  \n  ```\n  \n\n##### 被连接\n\n- **Host**:\n\n  ```java\n  LocalBluetoothManager.getInstance().getEventManager().registerCallback(new BluetoothCallback() {\n     \t\t@Override\n  \t\tpublic void onConnectionStateChanged(CachedBluetoothDevice cachedDevice, int bondState) {\n  \t\t}\n  });\n  ```\n\n- **Controller**:\n\n  ```dtd\n  > 1900\t62.151696\tcontroller\thost\tHCI_EVT\t13\tRcvd Connect Request\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Connect Request\n      Event Code: Connect Request (0x04)\n      Parameter Total Length: 10\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Class of Device: 0x5a020c (Phone:Smartphone - services: Networking Capturing ObjectTransfer Telephony)\n      Link Type: ACL connection (Data Channels) (0x01)\n  \n  > 1901\t62.152042\thost\tcontroller\tHCI_CMD\t11\tSent Accept Connection Request\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - Accept Connection Request\n      Command Opcode: Accept Connection Request (0x0409)\n      Parameter Total Length: 7\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Role: Remain the Slave for this connection. The LM will NOT perform the role switch. (0x01)\n      [Pending in frame: 1902]\n      [Command-Pending Delta: 0.748ms]\n      [Response in frame: 1903]\n      [Command-Response Delta: 4.455ms]\n  \n  > 1903\t62.156497\tcontroller\thost\tHCI_EVT\t14\tRcvd Connect Complete\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Connect Complete\n      Event Code: Connect Complete (0x03)\n      Parameter Total Length: 11\n      Status: Success (0x00)\n      Connection Handle: 0x0032\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Link Type: ACL connection (Data Channels) (0x01)\n      Encryption Mode: Encryption Disabled (0x00)\n      [Command in frame: 1901]\n      [Pending in frame: 1902]\n      [Pending-Response Delta: 3.707ms]\n      [Command-Response Delta: 4.455ms]\n  \n  > 1968\t62.415419\tcontroller\thost\tHCI_EVT\t9\tRcvd Link Key Request\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Link Key Request\n      Event Code: Link Key Request (0x17)\n      Parameter Total Length: 6\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n  \n  > 1969\t62.415629\thost\tcontroller\tHCI_CMD\t26\tSent Link Key Request Reply\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - Link Key Request Reply\n      Command Opcode: Link Key Request Reply (0x040b)\n      Parameter Total Length: 22\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Link Key: 2160acf6b7403a97050f64de72570b1d\n      [Response in frame: 1971]\n      [Command-Response Delta: 0.934ms]\n  \n  > 1971\t62.416563\tcontroller\thost\tHCI_EVT\t13\tRcvd Command Complete (Link Key Request Reply)\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Command Complete\n      Event Code: Command Complete (0x0e)\n      Parameter Total Length: 10\n      Number of Allowed Command Packets: 1\n      Command Opcode: Link Key Request Reply (0x040b)\n      Status: Success (0x00)\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      [Command in frame: 1969]\n      [Command-Response Delta: 0.934ms]\n  \n  ```\n\n### SCO\n\n>BLUETOOTH SPECIFICATION Version 4.2 [Vol 1, Part A] page 64  \n>\n>The synchronous connection-oriented (SCO) logical transport is a symmetric,\n>point-to-point transport between the master and a specific slave. The SCO\n>logical transport reserves slots on the physical channel and can therefore be\n>considered as a circuit-switched connection between the master and the slave.\n>SCO logical transports carry 64 kb/s of information synchronized with the\n>piconet clock. Typically this information is an encoded voice stream. Three\n>different SCO configurations exist, offering a balance between robustness,\n>delay and bandwidth consumption.  \n\nSCO全称**BR/EDR Synchronous Connection-Oriented**，利用保留时隙传送数据包。连接建立后，主设备和从设备可以不被选中就发送SCO数据包。SCO数据包既可以传送话音，也可以传送数据，但在传送数据时，只用于重发被损坏的那部分的数据。\n\n### L2CAP\n\n> BLUETOOTH SPECIFICATION Version 4.2 [Vol 3, Part A] page 30  \n>\n> L2CAP（Logical Link Control and Adaptation Protocol）：逻辑链路控制与适配协议，将ACL数据分组交换为便于高层应用的数据分组格式，并提供协议复用和服务质量交换等功能。\n>\n> 通过协议多路复用、分段重组操作和组概念,向高层提供面向连接的和无连接的数据服务,L2CAP还屏蔽了低层传输协议中的很多特性，使得高层协议应用开发人员可以不必了解基层协议而进行开发。\n\n![](https://s1.ax1x.com/2022/04/11/LV6sKg.png)\n\n从架构图可以看出，L2CAP位于HCI与上层业务之间，在建立物理连接(ACL)之后，上层业务的通信和控制都由L2CAP协议与微微网(piconet )中其它蓝牙设备进行交互，类似HTTP协议的存在。\n\n下图概括了两个设备L2CAP之间的连接过程：\n\n![](https://s1.ax1x.com/2022/04/11/LV6UUI.png)\n\n### SDP\n\n> BLUETOOTH SPECIFICATION Version 4.2 [Vol 3, Part B] page 222  \n>\n> The service discovery mechanism provides the means for client applications to\n> discover the existence of services provided by server applications as well as\n> the attributes of those services. The attributes of a service include the type or\n> class of service offered and the mechanism or protocol information needed to\n> utilize the service.  \n\n全称是**Service Discovery Protocol**，服务发现协议，服务发现协议(SDP)为应用程序提供了一种方法来发现哪些服务可用，并确定这些可用服务的特征。\n\n![](https://s1.ax1x.com/2022/04/11/LV66bj.png)\n\n从上图可知蓝牙设备中同时存在一个Client和Server，通过L2CAP协议与别的设备时行交互，通过`Service Search Attribute Request   `命令查询对方设备支持的蓝牙服务，其工作流程如图：\n\n![](https://s1.ax1x.com/2022/04/11/LV6a5t.png)\n\n通过HCI可以看到发现蓝牙服务过过程中的数据：\n\n```dtd\n> 455\t22.824346\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tSDP\t29\tSent Service Search Attribute Request : L2CAP: Attribute Range (0x0000 - 0xffff) \n---------------------------------------------------------------------------\nFrame 455: 29 bytes on wire (232 bits), 29 bytes captured (232 bits)\nBluetooth\nBluetooth HCI H4\nBluetooth HCI ACL Packet\nBluetooth L2CAP Protocol\nBluetooth SDP Protocol\n    PDU: Service Search Attribute Request (0x06)\n    Transaction Id: 0x0000\n    Parameter Length: 15\n    Service Search Pattern: L2CAP\n    Maximum Attribute Byte Count: 1008\n    Attribute ID List\n        Data Element: Sequence uint8 5 bytes\n            0011 0... = Data Element Type: Sequence (6)\n            .... .101 = Data Element Size: uint8 (5)\n            Data Element Var Size: 5\n            Data Value\n                Data Element: Unsigned Integer 4 bytes\n                    0000 1... = Data Element Type: Unsigned Integer (1)\n                    .... .010 = Data Element Size: 4 bytes (2)\n                    Data Value\n                        Attribute Range: 0x0000ffff\n                            Attribute Range From: 0x0000\n                            Attribute Range To: 0xffff\n    Continuation State: no (00)\n\n> 471\t22.896191\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tSDP\t281\tRcvd Service Search Attribute Response\n---------------------------------------------------------------------------\nFrame 471: 281 bytes on wire (2248 bits), 281 bytes captured (2248 bits)\nBluetooth\nBluetooth HCI H4\nBluetooth HCI ACL Packet\nBluetooth L2CAP Protocol\nBluetooth SDP Protocol\n    PDU: Service Search Attribute Response (0x07)\n    Transaction Id: 0x0001\n    Parameter Length: 267\n    Attribute List Byte Count: 264\n    Data Fragment\n    Continuation State: no (00)\n    [Reassembled Attribute List]\n        Attribute Lists [count = 14]\n            Data Element: Sequence uint16 1269 bytes\n                0011 0... = Data Element Type: Sequence (6)\n                .... .110 = Data Element Size: uint16 (6)\n                Data Element Var Size: 1269\n                Data Value\n                    Attribute List [count =  4] (Generic Attribute Profile)\n                    Attribute List [count =  4] (Generic Access Profile)\n                    Attribute List [count =  6] (Headset Audio Gateway)\n                    Attribute List [count =  8] (Handsfree Audio Gateway)\n                    Attribute List [count =  8] (A/V Remote Control Target)\n                    Attribute List [count =  7] (Audio Source)\n                    Attribute List [count = 11] (PAN NAP)\n                    Attribute List [count =  9] (PAN PANU)\n                    Attribute List [count =  7] (Phonebook Access Server)\n                    Attribute List [count = 10] (Message Access Server)\n                    Attribute List [count =  4] (Xiaomi Inc.)\n                    Attribute List [count =  5] (CustomUUID: Unknown)\n                    Attribute List [count =  8] (OBEX Object Push)\n                    Attribute List [count =  4] (Unknown)\n```\n\n\n\n# 蓝牙电话\n\n\n## PBAP(RFCOMM/OBEX)\n\n> RFCOMM协议提供了对L2CAP协议上的串行端口的模拟。该协议基于ETSI标准GSM 07.10。\n>\n> OBEX：Object Exchange的简称，对象交换协议，来源于红外通讯协议，但又不局限于具体的传输方式，后来被蓝牙组织SIG吸纳其中部分并进行优化处理作为蓝牙协议中的OBEX层用于蓝牙设备间的文件数据传输，如蓝牙传输文件（OPP）、同步电话簿（PBAP）和同步短信（MAP）等场景下都是以OBEX协议组织相关数据进行传输的。\n\nPBAP: Phone Book Access Profile的简称，**电话本访问协议**，用于同步手机这些具有电话本功能设备上的通讯录和通话记录等。\n\nRFCOMM/OBEX和协议不属于蓝牙定义的规范 ，只是被蓝牙采纳，而PBAP协议包在OBEX协议之上封装而成。\n\n### PBAP虚拟文件夹架构\n\nPBAP中通话数据文件是在虚拟文件夹架构下，访问通话数据时需要指定路径，下图为官方架构图：\n\n![](https://s1.ax1x.com/2022/04/11/LV6yrQ.png)\n\n其中vcf的文件名称意义如下：\n\n![](https://s1.ax1x.com/2022/04/11/LV6gVs.png)\n\n### 建立连接/断开连接\n\n只使用OBEX协议\n\n#### 连接\n\n```dtd\n> 798\t23.907353\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t40\tSent Connect - Phone Book Access Profile\n---------------------------------------------------------------------------\nFrame 798: 40 bytes on wire (320 bits), 40 bytes captured (320 bits)\nBluetooth\nBluetooth HCI H4\nBluetooth HCI ACL Packet\nBluetooth L2CAP Protocol\nBluetooth RFCOMM Protocol\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: ?]\n    .000 0000 = Opcode: Connect (0x00)\n    1... .... = Final Flag: True\n    Packet Length: 26\n    [Response in Frame: 803]\n    Version: 1.0 (0x10)\n    Flags: 0x00\n    Max. Packet Length: 65534\n    Headers\n        Target: Phone Book Access Profile\n            Header Id: Target (0x46)\n            Length: 19\n            Value: 796135f0f0c511d809660800200c9a66: Phone Book Access Profile\n\n\n> 803\t23.917550\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t45\tRcvd Success - Phone Book Access Profile\n---------------------------------------------------------------------------\nFrame 803: 45 bytes on wire (360 bits), 45 bytes captured (360 bits)\nBluetooth\nBluetooth HCI H4\nBluetooth HCI ACL Packet\nBluetooth L2CAP Protocol\nBluetooth RFCOMM Protocol\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /]\n    .010 0000 = Response Code: Success (0x20)\n    1... .... = Final Flag: True\n    Packet Length: 31\n    [Request in Frame: 798]\n    Version: 1.0 (0x10)\n    Flags: 0x00\n    Max. Packet Length: 65534\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n        Who: Phone Book Access Profile\n            Header Id: Who (0x4a)\n            Length: 19\n            Value: 796135f0f0c511d809660800200c9a66: Phone Book Access Profile\n\n```\n\n#### 断开\n\n```dtd\n> 1142\t58.752933\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t22\tSent Disconnect\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /]\n    .000 0001 = Opcode: Disconnect (0x01)\n    1... .... = Final Flag: True\n    Packet Length: 8\n    [Response in Frame: 1164]\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n\n> 1164\t59.162598\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t22\tRcvd Success\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /]\n    .010 0000 = Response Code: Success (0x20)\n    1... .... = Final Flag: True\n    Packet Length: 8\n    [Request in Frame: 1142]\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n```\n\n### 设置访问虚拟文件夹路径\n\n在[PBAP协议规范]的`5.2 SetPhoneBook Function`章节，使用OBEX协议SetPath命令，通过obex.opcode=**0x05**判断。\n\n```dtd\n# $/\n> 808\t24.023528\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t27\tSent Set Path \"\"\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /]\n    .000 0101 = Opcode: Set Path (0x05)\n    1... .... = Final Flag: True\n    Packet Length: 13\n    [Response in Frame: 810]\n    Flags: 0x02\n    .... ...0 = Go back one folder (../) first: False\n    .... ..1. = Do not create folder, if not existing: True\n    Constants: 0x00\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n        Name: \"\"\n            Header Id: Name (0x01)\n            Length: 3\n            Name: \n\n> 810\t24.065127\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t22\tRcvd Success\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /]\n    .010 0000 = Response Code: Success (0x20)\n    1... .... = Final Flag: True\n    Packet Length: 8\n    [Request in Frame: 808]\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n\n# $/telecom/\n> 811\t24.078180\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t43\tSent Set Path \"telecom\"\n```\n\n\n\n### 获取通讯录数量\n\n在[PBAP协议规范]的`5.3 PullvCardListing Function`章节，通过obex.header=**<x-bt/vcard-listing>**判断。\n\n#### 手机\n\n```dtd\n> 808\t24.023528\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t27\tSent Set Path \"\"\n> 811\t24.078180\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t43\tSent Set Path \"telecom\"\n# $/telecom/pb/\n> 816\t24.118267\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t70\tSent Get final \"pb\"\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /telecom]\n    .000 0011 = Opcode: Get (0x03)\n    1... .... = Final Flag: True\n    Packet Length: 56\n    [Response in Frame: 818]\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n        Name: \"pb\"\n            Header Id: Name (0x01)\n            Length: 9\n            Name: pb\n        Type: \"x-bt/vcard-listing\"\n            Header Id: Type (0x42)\n            Length: 22\n            Type: x-bt/vcard-listing\n        Application Parameters\n            Header Id: Application Parameters (0x4c)\n            Length: 17\n            Parameter: Order #排序规则: { Alphabetical | Indexed | Phonetical }\n                Parameter Id: Order (0x01)\n                Parameter Length: 1\n                Max List Count: Indexed (0x00)\n            Parameter: Search Attribute #搜索:  {Name | Number | Sound } 与 SearchValue配合，默认为Name\n                Parameter Id: Search Attribute (0x03)\n                Parameter Length: 1\n                Search Attribute: Name (0x00)\n            Parameter: Max List Count #最大条目数\n                Parameter Id: Max List Count (0x04)\n                Parameter Length: 2\n                Max List Count: 0 (0x0000)\n            Parameter: List Start Offset #偏移量\n                Parameter Id: List Start Offset (0x05)\n                Parameter Length: 2\n                List Start Offset: 0 (0x0000)\n\n> 818\t24.332995\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t29\tRcvd Success\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /telecom]\n    .010 0000 = Response Code: Success (0x20)\n    1... .... = Final Flag: True\n    Packet Length: 15\n    [Request in Frame: 816]\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n        Application Parameters\n            Header Id: Application Parameters (0x4c)\n            Length: 7\n            Parameter: Phonebook Size\n                Parameter Id: Phonebook Size (0x08)\n                Parameter Length: 2\n                Phonebook Size: 71 (0x0047)\n```\n\n#### SIM1\n\n```dtd\n> 819\t24.336294\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t27\tSent Set Path \"\"\n> 822\t24.379640\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t27\tSent Set Path \"\"\n> 825\t24.430836\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t37\tSent Set Path \"SIM1\"\n> 828\t24.481559\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t43\tSent Set Path \"telecom\"\n# $/SIM1/telecom/pb/\n> 831\t24.532312\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t70\tSent Get final \"pb\"\n\n> 833\t24.578831\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t29\tRcvd Success\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /SIM1/telecom]\n    .010 0000 = Response Code: Success (0x20)\n    1... .... = Final Flag: True\n    Packet Length: 15\n    [Request in Frame: 831]\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n        Application Parameters\n            Header Id: Application Parameters (0x4c)\n            Length: 7\n            Parameter: Phonebook Size\n                Parameter Id: Phonebook Size (0x08)\n                Parameter Length: 2\n                Phonebook Size: 1 (0x0001)\n```\n\n### 获取通讯录\n\n在[PBAP协议规范]的`5.3 PullvCardListing Function`章节，通过obex.header=**<x-bt/phonebook>** 判断，分页获取vCard格式。\n\n#### 手机\n\n```dtd\n> 834\t24.580643\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t27\tSent Set Path \"\"\n#分页请求获取通讯录，从第1条数据开始，每页最多50条\n> 837\t24.632264\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t97\tSent Get final \"telecom/pb.vcf\"\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /]\n    .000 0011 = Opcode: Get (0x03)\n    1... .... = Final Flag: True\n    Packet Length: 83\n    [Response in Frame: 844]\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n        Name: \"telecom/pb.vcf\"\n            Header Id: Name (0x01)\n            Length: 33\n            Name: telecom/pb.vcf\n        Type: \"x-bt/phonebook\"\n            Header Id: Type (0x42)\n            Length: 18\n            Type: x-bt/phonebook\n        Application Parameters\n            Header Id: Application Parameters (0x4c)\n            Length: 24\n            Parameter: Max List Count #最大条目数,这里只读取50条\n                Parameter Id: Max List Count (0x04)\n                Parameter Length: 2\n                Max List Count: 50 (0x0032)\n            Parameter: List Start Offset #偏移量，这是从第1条开始读取\n                Parameter Id: List Start Offset (0x05)\n                Parameter Length: 2\n                List Start Offset: 1 (0x0001)\n            Parameter: Filter #用于指示所请求的vCard中包含的属性\n                Parameter Id: Filter (0x06)\n                Parameter Length: 8\n                Filter: 0x00000000\n                Filter: 0x008001af, vCard Version, Formatted Name, Structured Presentation of Name, Associated Image or Photo, Delivery Address, Telephone Number, Electronic Mail Address, Nickname\n            Parameter: Format #vCard文件格式版本，这是3.0\n                Parameter Id: Format (0x07)\n                Parameter Length: 1\n                Format: 3.0 (0x01)\n\n#传输数据片段\n> 839\t24.764415\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t1004\tRcvd OBEX fragment\n---------------------------------------------------------------------------\nFrame 839: 1004 bytes on wire (8032 bits), 1004 bytes captured (8032 bits)\nBluetooth\nBluetooth HCI H4\nBluetooth HCI ACL Packet\nBluetooth L2CAP Protocol\nBluetooth RFCOMM Protocol\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /]\n    [Reassembled OBEX in frame: 844]\n    Data (990 bytes)\n\n...\n#传输成功\n> 844\t24.794969\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t182\tRcvd Success (x-bt/phonebook)\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /]\n    [6 OBEX Fragments (5117 bytes): #839(990), #840(990), #841(990), #842(990), #843(990), #844(167)] #6个数据片段，需要拼接对应Frame\n    .010 0000 = Response Code: Success (0x20)\n    1... .... = Final Flag: True\n    Packet Length: 5117\n    [Request in Frame: 837]\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n        End Of Body\n            Header Id: End Of Body (0x49)\n            Length: 5109\n            Value: 424547494e3a56434152440d0a56455253494f4e3a332e300d0a4e3ae591a83be4baa6e6…\n    Line-based text data: x-bt/phonebook (320 lines)\n        BEGIN:VCARD\\r\\n\n        VERSION:3.0\\r\\n\n        N:张;三;;;\\r\\n\n        FN:张三\\r\\n\n        TEL;TYPE=CELL:22222222\\r\\n\n        END:VCARD\\r\\n\n        BEGIN:VCARD\\r\\n\n        VERSION:3.0\\r\\n\n        N:李四;;;;\\r\\n\n        FN:李四\\r\\n\n        TEL;TYPE=CELL:11111111\\r\\n\n        END:VCARD\\r\\n\n\n#请求获取vCard 3.0格式，并从第51条数据开始，最多50条\n> 847\t24.875858\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t96\tSent Get final \"telecom/pb.vcf\"\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /]\n    .000 0011 = Opcode: Get (0x03)\n    1... .... = Final Flag: True\n    Packet Length: 83\n    [Response in Frame: 850]\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n        Name: \"telecom/pb.vcf\"\n            Header Id: Name (0x01)\n            Length: 33\n            Name: telecom/pb.vcf\n        Type: \"x-bt/phonebook\"\n            Header Id: Type (0x42)\n            Length: 18\n            Type: x-bt/phonebook\n        Application Parameters\n            Header Id: Application Parameters (0x4c)\n            Length: 24\n            Parameter: Max List Count\n                Parameter Id: Max List Count (0x04)\n                Parameter Length: 2\n                Max List Count: 50 (0x0032)\n            Parameter: List Start Offset\n                Parameter Id: List Start Offset (0x05)\n                Parameter Length: 2\n                List Start Offset: 51 (0x0033)\n            Parameter: Filter\n                Parameter Id: Filter (0x06)\n                Parameter Length: 8\n                Filter: 0x00000000\n                Filter: 0x008001af, vCard Version, Formatted Name, Structured Presentation of Name, Associated Image or Photo, Delivery Address, Telephone Number, Electronic Mail Address, Nickname\n            Parameter: Format\n                Parameter Id: Format (0x07)\n                Parameter Length: 1\n                Format: 3.0 (0x01)\n\n> 849\t24.953425\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t1004\tRcvd OBEX fragment\n\n# 刚刚通过`Sent Get final \"pb\"`获取手机通讯录只有71条，现在只剩下21，这次就可以传输完成。\n> 850\t24.960363\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t940\tRcvd Success (x-bt/phonebook)\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /]\n    [2 OBEX Fragments (1915 bytes): #849(990), #850(925)]\n    .010 0000 = Response Code: Success (0x20)\n    1... .... = Final Flag: True\n    Packet Length: 1915\n    [Request in Frame: 847]\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n        End Of Body\n            Header Id: End Of Body (0x49)\n            Length: 1907\n            Value: 424547494e3a56434152440d0a56455253494f4e3a332e300d0a4e3ae4bd993be4bf8ae7…\n    Line-based text data: x-bt/phonebook (122 lines)\n        BEGIN:VCARD\\r\\n\n        VERSION:3.0\\r\\n\n        N:张;三;;;\\r\\n\n        FN:张三\\r\\n\n        TEL;TYPE=CELL:22222222\\r\\n\n        END:VCARD\\r\\n\n        BEGIN:VCARD\\r\\n\n        VERSION:3.0\\r\\n\n        N:李四;;;;\\r\\n\n        FN:李四\\r\\n\n        TEL;TYPE=CELL:11111111\\r\\n\n        END:VCARD\\r\\n\n```\n\n#### SIM1\n\n```dtd\n> 866\t25.021131\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t107\tSent Get final \"SIM1/telecom/pb.vcf\"\n#这里手机直接拒绝了\n> 868\t25.032728\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t25\tRcvd Success\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /]\n    .010 0000 = Response Code: Success (0x20)\n    1... .... = Final Flag: True\n    Packet Length: 11\n    [Request in Frame: 866]\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n        End Of Body\n            Header Id: End Of Body (0x49)\n            Length: 3\n            Value: <MISSING>\n```\n\n\n\n### 获取通话记录\n\n在[PBAP协议规范]的`5.3 PullvCardListing Function`章节，通过obex.header=**<x-bt/phonebook>** 判断，分页获取vCard格式。\n\n```dtd\n> 869\t25.071027\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t27\tSent Set Path \"\"\n> 882\t25.125323\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t43\tSent Set Path \"telecom\"\n# $/telecom/cch/\n> 887\t25.138796\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t72\tSent Get final \"cch\"\n> 895\t25.222650\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t29\tRcvd Success\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /telecom]\n    .010 0000 = Response Code: Success (0x20)\n    1... .... = Final Flag: True\n    Packet Length: 15\n    [Request in Frame: 887]\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n        Application Parameters\n            Header Id: Application Parameters (0x4c)\n            Length: 7\n            Parameter: Phonebook Size\n                Parameter Id: Phonebook Size (0x08)\n                Parameter Length: 2\n                Phonebook Size: 2177 (0x0881)\n\n> 897\t25.225643\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t27\tSent Set Path \"\"\n#分页获取通话记录，从第0条开始，每页最多50条\n> 919\t25.279427\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t85\tSent Get final \"telecom/cch.vcf\"\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /]\n    .000 0011 = Opcode: Get (0x03)\n    1... .... = Final Flag: True\n    Packet Length: 71\n    [Response in Frame: 935]\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n        Name: \"telecom/cch.vcf\"\n            Header Id: Name (0x01)\n            Length: 35\n            Name: telecom/cch.vcf\n        Type: \"x-bt/phonebook\"\n            Header Id: Type (0x42)\n            Length: 18\n            Type: x-bt/phonebook\n        Application Parameters\n            Header Id: Application Parameters (0x4c)\n            Length: 10\n            Parameter: Max List Count\n                Parameter Id: Max List Count (0x04)\n                Parameter Length: 2\n                Max List Count: 50 (0x0032)\n            Parameter: Format\n                Parameter Id: Format (0x07)\n                Parameter Length: 1\n                Format: 3.0 (0x01)\n> 935\t25.381127\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t132\tRcvd Success (x-bt/phonebook)\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /]\n    [8 OBEX Fragments (7048 bytes): #926(990), #927(990), #928(990), #929(990), #930(990), #931(990), #934(990), #935(118)]\n    .010 0000 = Response Code: Success (0x20)\n    1... .... = Final Flag: True\n    Packet Length: 7048\n    [Request in Frame: 919]\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n        End Of Body\n            Header Id: End Of Body (0x49)\n            Length: 7040\n            Value: 424547494e3a56434152440d0a56455253494f4e3a332e300d0a464e3a0d0a4e3a0d0a54…\n    Line-based text data: x-bt/phonebook (350 lines)\n        BEGIN:VCARD\\r\\n\n        VERSION:3.0\\r\\n\n        FN:\\r\\n\n        N:\\r\\n\n        TEL;TYPE=0:10086\\r\\n\n        X-IRMC-CALL-DATETIME;TYPE=DIALED:20220317T161710\\r\\n\n        END:VCARD\\r\\n\n        BEGIN:VCARD\\r\\n\n        VERSION:3.0\\r\\n\n        FN:\\r\\n\n        N:\\r\\n\n        TEL;TYPE=0:02310050\\r\\n\n        X-IRMC-CALL-DATETIME;TYPE=MISSED:20220316T160142\\r\\n\n        END:VCARD\\r\\n\n\n#分页获取通话记录，从第50条开始，每页最多50条\n936\t25.423573\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t89\tSent Get final \"telecom/cch.vcf\"\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /]\n    .000 0011 = Opcode: Get (0x03)\n    1... .... = Final Flag: True\n    Packet Length: 75\n    [Response in Frame: 947]\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n        Name: \"telecom/cch.vcf\"\n            Header Id: Name (0x01)\n            Length: 35\n            Name: telecom/cch.vcf\n        Type: \"x-bt/phonebook\"\n            Header Id: Type (0x42)\n            Length: 18\n            Type: x-bt/phonebook\n        Application Parameters\n            Header Id: Application Parameters (0x4c)\n            Length: 14\n            Parameter: Max List Count\n                Parameter Id: Max List Count (0x04)\n                Parameter Length: 2\n                Max List Count: 50 (0x0032)\n            Parameter: List Start Offset\n                Parameter Id: List Start Offset (0x05)\n                Parameter Length: 2\n                List Start Offset: 50 (0x0032)\n            Parameter: Format\n                Parameter Id: Format (0x07)\n                Parameter Length: 1\n                Format: 3.0 (0x01)\n> 947\t25.516478\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t810\tRcvd Success (x-bt/phonebook)\n```\n\n## HFP(RFCOMM)\n\n> HFP(Hands-free Profile)，让蓝牙设备可以控制电话，如接听、挂断、拒接、语音拨号等，拒接、语音拨号要视蓝牙耳机及电话是否支持。\n>\n> 目前HFP的使用场景有车载蓝牙，耳机和PDA，定义了AG和HFP两种角色。\n> AG（Audio Gate）音频网关—音频设备输入输出网关\n> HF（Hands Free）免提—该设备作为音频网关的远程音频输入/输出机制，并可提供若干遥控功能。\n\n在车载蓝牙中，**手机侧是AG**，**车载蓝牙侧是HF**，在android源代码中，将AG侧称为HFP/AG，将HF侧称为HFPClient/HF。\n\n### AT命令\n\n在HFP使用AT命令控制电话，其参考3GPP 27.007标准，命令规范为：\n\n- 每个命令行只有一个命令\n\n- AG侧默认不回显命令\n\n- AG使用冗长的格式返回结果\n\n- 以下字符将被用于AT命令和返回结果格式中\n\n  - `<cr>` 表示回车，也就是`\\r`字符\n\n  - ` <lf>`表示换行，也就是`\\n`字符\n\n- 从HF发送到AG的命令格式是：`<AT command> <cr>`\n\n- 从AG返回给HF的OK命令格式是：`<cr><lf>OK<cr><lf>`\n\n- 从AG到HF的ERROR命令是：`<cr><lf>ERROR<cr><lf>`\n\n- 从AG到HF的结果命令格式是：`<cr><lf><result code><cr><lf>`\n\nHFP协议复用的AT命令：\n\n- ATA：标准电话应答AT命令\n- ATDdd...dd;：用电话号码打电话\n- ATD>nnn...;：ATD扩展命令，记忆拨号\n- ERROR：错误指示符，语法，格式或者通信过程出错。\n- OK：命令的成功应答。\n- NO CARRIER, BUSY, NO ANSWER, DELAYED, BLACKLISTED：AT扩展命令，AG返回给HF。\n- RING：来电\n- AT+CCWA：calling waiting notification AT命令。AT+CCWA=`[<n>[,<mode>[,<class>]]]`，\n- +CCWA：Call Waiting notification返回结果码。只有`<number>`和`<type>`参数对HFP有意义，`<number>`是由双引号及其中的文本串组成。`<type>`是支持的电话格式，有如下值：\n  - 128~143：国家或国际格式，\n  - 144~159：国际电话，包括国家码前缀。\n  - 160-175:国家码\n  - AT+CHLD：通话保持，多方处理。AT+CHLD=`<n>`中`<n>`值覆盖0, 1, 1`<idx>`, 2, 2`<idx>`, 3 and 4,说明：\n    - 0：释放所有保持电话或者设置用户的忙等待\n    - 1：释放正在通话的电话，接听保持或等待的电话\n    - 1`<idx>`:释放`<idx>`标识的电话\n    - 2：将所有活跃电话设置成保持并且接受其它电话。\n    - 2`<idx>`:请求接受`<idx>`标识电话，让其它电话保持。\n    - 3：增加一个保持电话到对话中\n    - 4：连接连个电话并且断开两个电话的订阅。HF侧可选。\n  \n  - AT+CHLD=?：查询AG侧保持和多方会话。\n- AT+CHUP：标准的挂断命令。AG会结束通话，也可用于拒接来电。\n- AT+CIND：`AT+CIND?`获取AG indicators当前的状态,`AT+CIND=?获取AG支持的indicator以及它们的次序。\n  - service: Service availability indication:\n    - `<value>=0` implies no service. No Home/Roam network available.\n    - `<value>=1` implies presence of service. Home/Roam network available.  \n  - call: Standard call status indicator:  \n    - `<value>=0 `means there are no calls in progress  \n    - `<value>=1` means at least one call is in progress  \n  - callsetup: Bluetooth proprietary call set up status indicator4. Support for this indicator is optional\n    for the HF. When supported, this indicator shall be used in conjunction with, and as an extension\n    of the standard call indicator. Possible values are as follows:  \n    - `<value>=0` means not currently in call set up.  \n    - `<value>=1` means an incoming call process ongoing.\n    - `<value>=2` means an outgoing call set up is ongoing.  \n    - `<value>=3` means remote party being alerted in an outgoing call.  \n  - callheld: Bluetooth proprietary call hold status indicator. Support for this indicator is mandatory for\n    the AG, optional for the HF. Possible values are as follows:  \n    - 0= No calls held  \n    - 1= Call is placed on hold or active/held calls swapped\n      (The AG has both an active AND a held call)  \n    - Call on hold, no active call  \n  - signal: Signal Strength indicator:  \n    - `<value>= `ranges from 0 to 5  \n  - roam: Roaming status indicator:  \n    - `<value>=0` means roaming is not active  \n    - `<value>=1` means a roaming is active  \n  - battchg: Battery Charge indicator of AG:  \n    - `<value>=`ranges from 0 to 5  \n- +CIND：当前indicator的列表\n- AT+CLCC：列出当前电话命令，\n- +CLCC：当前call结果码，支持参数是\n\n  - idx：表示建立连接顺序或者接听电话的数字（从1开始）。\n  - dir：0（outgoing），1（incoming）\n  - status：\n\n    - 0=Active\n\n    - 1=Held\n\n    - 2=Dialing（outgoing calls only）\n\n    - 3=Alerting(outgoing calls only)\n\n    - 4=Incoming(incoming calls only)\n\n    - 5=Waiting(incoming calls only)\n\n    - 6 = Call held by Response and Hold\n  - mode= 0 (Voice), 1 (Data), 2 (FAX)\n  - mpty=\n    - 0 - this call is NOT a member of a multi-party (conference) call\n    - 1 - this call IS a member of a multi-party (conference) call\n  - number (optional)\n  - type (optional)\n- AT+COPS: AT+COPS=3,0将被HF发送给AG\n- AT+CMEE: 使能+CME ERROR: <err>结果码\n- +CME ERROR\n  - +CME ERROR: 0 – AG failure\n- AT+CLIP: Calling Line Identification notification 使能命令，It enables/disables the Calling Line Identification notification unsolicited result code 。\n- +CLIP : Standard “Calling Line Identification notification” unsolicited result code.  \n- AT+CMER :Standard event reporting activation/deactivation AT command.  \n- +CIEV: “indicator events reporting”结果码。`<ind>`,`<value>` result code ，对应AT+CIND 返回的列表中的参数和值。\n- AT+VTS: DTMF生成命令。\n- AT+CNUM: HF相应`+CNUM`命令\n  - AT+CNUM (Retrieve Subscriber Number Information)\n  - AT+CNUM=? (Test Subscriber Number Information – Not Implemented)\n- +CNUM:  用于将“ Subscriber Number Information ”从AG发送到HF的标准响应。\n\nHFP协议扩展的AT命令：\n\n- AT+BIA (Bluetooth Indicators Activation)  \n- AT+BINP (Bluetooth INPut)  \n- AT+BLDN (Bluetooth Last Dialed Number)  \n- AT+BVRA (Bluetooth Voice Recognition Activation)  \n- +BVRA (Bluetooth Voice Recognition Activation)  \n- AT+BRSF (Bluetooth Retrieve Supported Features)  \n- +BRSF (Bluetooth Retrieve Supported Features)   \n- AT+NREC (Noise Reduction and Echo Canceling)  \n- AT+VGM (Gain of Microphone)  \n- AT+VGS (Gain of Speaker)  \n- +VGM (Gain of Microphone)  \n- +VGS (Gain of Speaker)  \n- +BSIR (Bluetooth Setting of In-band Ring tone)  \n- AT+BTRH (Bluetooth Response and Hold Feature)  \n- +BTRH (Bluetooth Response and Hold Feature)  \n- AT+BCC (Bluetooth Codec Connection)  \n- AT+BCS (Bluetooth Codec Selection)  \n- +BCS (Bluetooth Codec Selection)  \n- AT+BAC (Bluetooth Available Codecs)  \n- AT+BIND (Bluetooth HF Indicators Feature)  \n- +BIND (Bluetooth HF Indicators Feature)  \n- AT+BIEV (Bluetooth HF Indicators Feature)\n\n### 建立服务连接\n\n> Upon a user action or an internal event, either the HF or the AG may initiate a **Service Level Connection**\n> **establishment** procedure.\n> A Service Level Connection establishment requires the existence of a RFCOMM connection, that is, a\n> RFCOMM data link channel between the HF and the AG.\n> Both the HF and the AG may initiate the RFCOMM connection establishment. If there is no RFCOMM\n> session between the AG and the HF, the initiating device shall first initialize RFCOMM.  \n\n连接过程如下：\n\n![](https://s1.ax1x.com/2022/04/11/LV6DxS.png)\n\n1. 支持能力交换\n   首先HF发送AT+BRSF=< HF supported features >给AG，目的是首先通知AG其具有的能力，其次接收AG返回的其自身的BRSF能力。\n   \n2. Codec协商\n   如果HF支持Codec Negotiation特征，其会查看AG返回的BRSF中是否也支持该特性，如果都支持该特性，则HF将发送AT+BAC=< HF available codecs >命令给AG以告知其可用的codec。\n   \n3. AG Indicator\n   HF从AG接收到的BRSF，可以知道AG支持的Indicator，并按顺序拍好，这是因为根据3GPP 27.007规范，AG可以支持Hands-Free不支持的profile。HF使用AT+CIND=?测试命令接收AG支持的indicator以及它们的次序。\n   当HF获得必须的Indicator和它们的次序，它将通过AT+CIND?命令取得AG端正在使用indicator的状态。\n   当HF取得AG的indicator后，HF会使用AT+CMER使能AG的indicator状态跟新功能，AG会返回OK作为应答。当service，call或者call建立状态发生时，AG将发送和indicator相关的+CIEV结果码给HF。HF根据收到的+CIEV码来跟新其自身内部的indicator。\n   AG侧会一直保持indicator状态跟新功能使能直到收到AT+CMER指示其关闭或者HF和AG端的Service Level Connection连接断开。\n   当HF使能AG的indicator状态跟新，如果AG和HF都支持呼叫等待（Call waiting）和3方通信（3-way calling）。HF将发送AT+CHLD=?测试命令取得AG是如何支持这种功能的。如果HF或者AG其中之一不支持三方通信，AT+CHLD=?命令不会被发送。\n   \n4. HF Indicator\n   如果HF支持HF indicator，其会查看AG是否支持HF indicator。\n   如果HF和AG支持HF indicator特性，HF将发送AT+BIND=< HF supported HF indicators >通知HF侧支持的indicator，AG以OK应答。\n   当AG接收到HF告知的HF indicator特性，HF将发送AT+BIND=?请求AG侧支持的HF indicator。AG将会以+BIND和以OK结尾的应答。\n   当HF接收到AG支持的HF indicator，HF将会发送AT+BIND?命令确定HF目前使能的HF indicator。AG将会一次或多次以+BIND应答和以OK结尾的应答。\n   至此HF可能发送AT+BIEV命令告知AG其使能的HF indicator发生变化。\n   AG可以使用+BIND使能或者禁止任何HF indicator。\n   \n5. End of Service Level Connection\n   - HF需要知道Service Level Connection被完全建立，这可以通过以下几个方式：\n     - 当且仅当AG通过+BRSF命令告知HF其支持的`\"HF indicator\"`，在HF收到AG通过**AT+BIND？**命令发来的其支持的`\"HF indicator\"`可认为完全建立。\n     - 当且仅当SDP服务发现AH和AG双方均支持`\"Call waiting and 3-way calling\"`，在HFAG通过**AT+CHLD**命令发来的其对呼叫等待和多方电话的支持，对这种情况，`\"HF indicator\"`不要设置该比特位，AG也不要在+BRSF命令中设置该比特位。\n     - 在HF使用**AT+CMER**命令成功启用`“Indicator status update”`功能，对这种情况SDP服务不应该设置`“Call waiting and 3-way calling”`比特位。\n       如果HF收到AG通过indicator指示当前有电话时，HF查询AG的接听和保持状态来判断是否是未接听电话。\n     \n   - 同样AG侧Service Level Connection完全建立也有几种情况：\n     - 当且仅当HF indicator在HF被设置且AG侧支持的indicator已经通过+BRSF命令应答，则AG以**+BIND加OK结尾**的命令应答其使能的HF indicator时可认为Service Level Connection完全建立。\n     \n     - 当且仅当`“Call waiting and 3-way calling”`比特在HF和AG的SDP服务中被置位，在AG通过**+CHLD加OK结尾**命令成功响应其对呼叫保持和多方电话支持时SLC会被完全建立。对这种情况，+BRSF不应该设置该HF indicator比特位。\n     \n     - AG已成功**响应OK到AT + CMER**命令（启用`“Indicator status update”`功能。）当`“Call waiting and 3-way calling”`位时，应适用这种情况未在支持的功能位图中设置为HF或AG，以及`“HF Indicators ”`对于通过+ BRSF交换的HF或AG的支持功能位图中未设置位的位图命令。\n     \n\n```dtd\n#判断是否支持\"Call waiting and 3-way calling\"\n#AG发现HF, hfP支持的协议,HF支持\"Call waiting and 3-way calling\"\n> 596\t17.850811\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tSDP\t36\tRcvd Service Search Attribute Request : Handsfree: [Service Class ID List 0x0001] [Protocol Descriptor List 0x0004] [Bluetooth Profile Descriptor List 0x0009] [(HFP HS) Supported Features 0x0311] \n> 597\t17.851437\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tSDP\t69\tSent Service Search Attribute Response \n---------------------------------------------------------------------------\nBluetooth SDP Protocol\n    PDU: Service Search Attribute Response (0x07)\n    Transaction Id: 0x0000\n    Parameter Length: 55\n    Attribute List Byte Count: 52\n    Attribute Lists [count =  1]\n        Data Element: Sequence uint8 50 bytes\n            0011 0... = Data Element Type: Sequence (6)\n            .... .101 = Data Element Size: uint8 (5)\n            Data Element Var Size: 50\n            Data Value\n                Attribute List [count =  4] (Handsfree)\n                    Data Element: Sequence uint16 47 bytes\n                        0011 0... = Data Element Type: Sequence (6)\n                        .... .110 = Data Element Size: uint16 (6)\n                        Data Element Var Size: 47\n                        Data Value\n                            Service Attribute: Service Class ID List (0x1), value = Handsfree -> Generic Audio\n                            Service Attribute: Protocol Descriptor List (0x4), value = L2CAP -> RFCOMM:2\n                            Service Attribute: Bluetooth Profile Descriptor List (0x9), value = Handsfree 1.6\n                            Service Attribute: (HFP HS) Supported Features (0x311), value = (EC and/or Nr Function) (Call Waiting or Three Way Calling) (CLI Presentation Capability) (Voice Recognition Activation) (Remote Volume Control) (Wide Band Speech) \n    Continuation State: no (00)\n\n#HF发现AG, hfP支持的协议,AG不支持\"Call waiting and 3-way calling\"，只支持\"3-way calling\"\n> 637\t18.017460\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tSDP\t33\tSent Service Search Attribute Request : Handsfree Audio Gateway: [Service Class ID List 0x0001] [Bluetooth Profile Descriptor List 0x0009] [(HFP AG) Supported Features 0x0311] \n> 644\t18.024689\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tSDP\t52\tRcvd Service Search Attribute Response \n---------------------------------------------------------------------------\nBluetooth SDP Protocol\n    PDU: Service Search Attribute Response (0x07)\n    Transaction Id: 0x0000\n    Parameter Length: 38\n    Attribute List Byte Count: 35\n    Attribute Lists [count =  1]\n        Data Element: Sequence uint8 33 bytes\n            0011 0... = Data Element Type: Sequence (6)\n            .... .101 = Data Element Size: uint8 (5)\n            Data Element Var Size: 33\n            Data Value\n                Attribute List [count =  3] (Handsfree Audio Gateway)\n                    Data Element: Sequence uint16 30 bytes\n                        0011 0... = Data Element Type: Sequence (6)\n                        .... .110 = Data Element Size: uint16 (6)\n                        Data Element Var Size: 30\n                        Data Value\n                            Service Attribute: Service Class ID List (0x1), value = Handsfree Audio Gateway -> Generic Audio\n                            Service Attribute: Bluetooth Profile Descriptor List (0x9), value = Handsfree 1.6\n                            Service Attribute: (HFP AG) Supported Features (0x311), value = (Three Way Calling) (EC and/or Nr Function) (Voice Recognition Function) (Wide Band Speech) \n    Continuation State: no (00)\n\n#HFP建立连接\n#交换支持功能，AG和HF都不支持\"HF indicator\"\n> 634\t18.012482\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t26\tSent AT+BRSF=255\n---------------------------------------------------------------------------\nBluetooth HFP Profile\n    [Role: HS - Headset (2)]\n    AT Stream: AT+BRSF=255\\r\n    Command 0: +BRSF\n        Command Line Prefix: AT\n        Command: +BRSF (Bluetooth Retrieve Supported Features)\n        Type: Action Command (0x003d)\n        Parameters\n            HS supported features bitmask: 255\n                .... .... .... .... .... .... .... ...1 = EC and/or NR function: True\n                .... .... .... .... .... .... .... ..1. = Call waiting or 3-way calling: True\n                .... .... .... .... .... .... .... .1.. = CLI Presentation: True\n                .... .... .... .... .... .... .... 1... = Voice Recognition Activation: True\n                .... .... .... .... .... .... ...1 .... = Remote Volume Control: True\n                .... .... .... .... .... .... ..1. .... = Enhanced Call Status: True\n                .... .... .... .... .... .... .1.. .... = Enhanced Call Control: True\n                .... .... .... .... .... .... 1... .... = Codec Negotiation: True\n                .... .... .... .... .... ...0 .... .... = HF Indicators: False\n                .... .... .... .... .... ..0. .... .... = eSCO S4 (and T2) Settings Support: False\n                0000 0000 0000 0000 0000 00.. .... .... = Reserved: 0x000000\n> 641\t18.022446\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t28\tRcvd   +BRSF: 871\n---------------------------------------------------------------------------\nBluetooth HFP Profile\n    [Role: AG - Audio Gate (1)]\n    AT Stream: \\r\\n+BRSF: 871\\r\\n\n    Command 0: +BRSF\n        Command: +BRSF (Bluetooth Retrieve Supported Features)\n        Type: Response (0x003a)\n        Parameters\n            AG supported features bitmask: 871\n                .... .... .... .... .... .... .... ...1 = Three Way Calling: True\n                .... .... .... .... .... .... .... ..1. = EC and/or NR function: True\n                .... .... .... .... .... .... .... .1.. = Voice Recognition Function: True\n                .... .... .... .... .... .... .... 0... = In-band Ring Tone: False\n                .... .... .... .... .... .... ...0 .... = Attach Number to Voice Tag: False\n                .... .... .... .... .... .... ..1. .... = Ability to Reject a Call: True\n                .... .... .... .... .... .... .1.. .... = Enhanced Call Status: True\n                .... .... .... .... .... .... 0... .... = Enhanced Call Control: False\n                .... .... .... .... .... ...1 .... .... = Extended Error Result Codes: True\n                .... .... .... .... .... ..1. .... .... = Codec Negotiation: True\n                .... .... .... .... .... .0.. .... .... = HF Indicators: False\n                .... .... .... .... .... 0... .... .... = eSCO S4 (and T2) Settings Support: False\n                0000 0000 0000 0000 0000 .... .... .... = Reserved: 0x00000\n\n#AG和HF都支持\"Codec Negotiation\"，HF告知AG其可用的Codec编码(CVSD)\n> 643\t18.023696\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t23\tSent AT+BAC=1\n---------------------------------------------------------------------------\nBluetooth HFP Profile\n    [Role: HS - Headset (2)]\n    AT Stream: AT+BAC=1\\r\n    Command 0: +BAC\n        Command Line Prefix: AT\n        Command: +BAC (Bluetooth Available Codecs)\n        Type: Action Command (0x003d)\n        Parameters\n            Codec: CVSD (1)\n\n#获取AG支持的indicator以及它们的次序\n> 649\t18.029340\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t24\tSent AT+CIND=? \n> 652\t18.035680\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t147\tRcvd   +CIND: (\"CALL\",(0,1)),(\"CALLSETUP\",(0-3)),(\"SERVICE\",(0-1)),(\"SIGNAL\",(0-5)),(\"ROAM\",(0,1)),(\"BATTCHG\",(0-5)),(\"CALLHELD\",(0-2)) \n\n#获取AG indicators当前的状态\n> 654\t18.037547\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t23\tSent AT+CIND? \n> 656\t18.092460\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t38\tRcvd   +CIND: 0,0,1,5,0,2,0\n\n#标志HFP连接建立\n#启用\"Indicator status update\"\n> 658\t18.093591\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t30\tSent AT+CMER=3,0,0,1\n> 660\t18.117156\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t20\tRcvd   OK  \n```\n\n### HF拨打\\挂断电话\n\n```dtd\n#HF拨打电话\n> 921\t29.433324\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t24\tSent ATD10086; \n---------------------------------------------------------------------------\nBluetooth HFP Profile\n    [Role: HS - Headset (2)]\n    AT Stream: ATD10086;\\r\n    Command 0: D\n        Command Line Prefix: AT\n        Command: D (Dial)\n        [Expert Info (Warning/Protocol): Non mandatory type or command in this role]\n        Parameters: No\n> 924\t30.778650\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t20\tRcvd   OK\n\n#挂断电话\n> 965\t37.723080\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t22\tSent AT+CHUP\n> 966\t37.752000\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t20\tRcvd   OK\n```\n\n### HF获取通话电话列表\n\n会HF会轮询此命令\n\n```dtd\n> 925\t30.779082\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t22\tSent AT+CLCC \n> 929\t30.820871\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t46\tRcvd   +CLCC: 1,0,2,0,0,\"10086\",129 \n---------------------------------------------------------------------------\nBluetooth HFP Profile\n    [Role: AG - Audio Gate (1)]\n    AT Stream: \\r\\n+CLCC: 1,0,2,0,0,\"10086\",129\\r\\n\n    Command 0: +CLCC\n        Command: +CLCC (Current Calls)\n        Type: Response (0x003a)\n        Parameters\n            ID: 1\n            Direction: Mobile Originated (0)\n            State: Dialing (2)\n            Mode: Voice (0)\n            Mpty: Call is not one of multiparty (conference) call parties (0)\n            Number: \"10086\"\n            Type: The phone number format may be a national or international format, and may contain prefix and/or escape digits. No changes on the number presentation are required. (129)\n```\n\n### AG下发通话状态\n\n在开启`\"Indicator status update\"`(AT+CMER)之后，AG会主动下发当前的通话状态，`Indicator Index`对应+CIND返回的参数列表，`Indicator <idx>`对应其值。\n\n#### 拨打电话\n\n```dtd\n#CALLSETUP=2,拨号中\n> 1056\t66.689969\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t27\tRcvd   +CIEV: 2,2  \n```\n\n#### 无通话或者挂断\n\n```dtd\n#CALL=0,无通话\n1106\t74.975552\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t27\tRcvd   +CIEV: 1,0  \n```\n\n#### 来电\n\n```dtd\n#CALLSETUP=1,来电中\n> 1056\t66.689969\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t27\tRcvd   +CIEV: 2,1 \n```\n### 建立SCO/eSCO连接\n\n蓝牙电话的音频数据由SCO/eSCO协议传输，在HCI中无数据相关的日志。\n\n```dtd\n#HF选择编解码格式\n> 900\t387.320548\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tHFP\t24\tRcvd   +BCS: 1  \n---------------------------------------------------------------------------\nBluetooth HFP Profile\n    [Role: AG - Audio Gate (1)]\n    AT Stream: \\r\\n+BCS: 1\\r\\n\n    Command 0: +BCS\n        Command: +BCS (Bluetooth Codec Selection)\n        Type: Response (0x003a)\n        Parameters\n            Codec: CVSD (1)\n> 903\t387.380459\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t23\tSent AT+BCS=1 \n---------------------------------------------------------------------------\nBluetooth HFP Profile\n    [Role: HS - Headset (2)]\n    AT Stream: AT+BCS=1\\r\n    Command 0: +BCS\n        Command Line Prefix: AT\n        Command: +BCS (Bluetooth Codec Selection)\n        Type: Action Command (0x003d)\n        Parameters\n            Codec: CVSD (1)\n\n#AG请求建立eSCO连接\n> 906\t387.530834\tcontroller\thost\tHCI_EVT\t13\tRcvd Connect Request\n---------------------------------------------------------------------------\nBluetooth HCI Event - Connect Request\n    Event Code: Connect Request (0x04)\n    Parameter Total Length: 10\n    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n    Class of Device: 0x001f00 (Uncategorized: device code not specified:Unknown - services:)\n    Link Type: eSCO connection (Voice Channels) (0x02)\n\n#HF允许建立eSCO连接\n> 907\t387.531078\thost\tcontroller\tHCI_CMD\t67\tSent Enhanced Accept Synchronous Connection Request\n---------------------------------------------------------------------------\nBluetooth HCI Command - Enhanced Accept Synchronous Connection Request\n    Command Opcode: Enhanced Accept Synchronous Connection Request (0x043e)\n        0000 01.. .... .... = Opcode Group Field: Link Control Commands (0x01)\n        .... ..00 0011 1110 = Opcode Command Field: Enhanced Accept Synchronous Connection Request (0x03e)\n    Parameter Total Length: 63\n    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n    Tx Bandwidth (bytes/s): 8000\n    Rx Bandwidth (bytes/s): 8000\n    Transmit Coding Format\n    Receive Coding Format\n    Transmit Codec Frame Size: 60\n    Receive Codec Frame Size: 60\n    Input Bandwidth: 16000\n    Output Bandwidth: 16000\n    Input Coding Format\n    Output Coding Format\n    Input Coded Data Size: 16\n    Output Coded Data Size: 16\n    Input PCM Data Format: 2's complement (0x02)\n    Output PCM Data Format: 2's complement (0x02)\n    Input PCM Sample Payload MSB Position: 0\n    Output PCM Sample Payload MSB Position: 0\n    Input Data Path: Vendor Specific\n    Output Data Path: Vendor Specific\n    Input Transport Unit Size: 16\n    Output Transport Unit Size: 16\n    Max. Latency (ms): 12\n    Packet Type: 0x03bf, 3-EV5 may NOT be used, 2-EV5 may NOT be used, 3-EV3 may NOT be used, EV5 may be used, EV4 may be used, EV3 may be used, HV3 may be used, HV2 may be used, HV1 may be used\n    Retransmission Effort: At least 1 retransmission, optimize for link quality (2)\n    [Pending in frame: 909]\n    [Command-Pending Delta: 1.38ms]\n    [Response in frame: 910]\n    [Command-Response Delta: 3.862ms]\n\n#eSCO连接成功\n> 910\t387.534940\tcontroller\thost\tHCI_EVT\t20\tRcvd Synchronous Connection Complete\n---------------------------------------------------------------------------\nBluetooth HCI Event - Synchronous Connection Complete\n    Event Code: Synchronous Connection Complete (0x2c)\n    Parameter Total Length: 17\n    Status: Success (0x00)\n    Connection Handle: 0x0e00\n    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n    Link Type: eSCO connection (0x02)\n    Transmit Interval: 12 slots (7.5 msec)\n    Retransmit Window: 2 slots (1.25 msec)\n    Rx Packet Length: 60\n    Tx Packet Length: 60\n    Air Mode: CVSD (2)\n    [Command in frame: 907]\n    [Pending in frame: 909]\n    [Pending-Response Delta: 2.482ms]\n    [Command-Response Delta: 3.862ms]\n```\n\n# 蓝牙音乐\n\n## AVDTP\n\n**AVDTP：AUDIO/VIDEO DISTRIBUTION TRANSPORT PROTOCOL(音视频分配传输协议)** ，用于音乐数据流的建立与传输控制。\n\n### 建立连接\n\n```dtd\n> 458\t11.574257\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tL2CAP\t17\tSent Connection Request (AVDTP, SCID: 0x0042)\n```\n\n### 数据流传输\n\n数据流的生命状态：\n\n![](https://s1.ax1x.com/2022/04/11/LV6NVA.png)\n\n#### 查找(Idle)\n\n```dtd\n#查询AG的所有音源\n> 468\t11.652772\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tAVDTP\t11\tSent Command - Discover\n> 469\t11.722467\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tAVDTP\t15\tRcvd ResponseAccept - Discover - items: 2\n---------------------------------------------------------------------------\nBluetooth AVDTP Protocol\n    Signal: Discover (ResponseAccept)\n    ACP SEP [1 - Audio Source] item 1/2\n        0000 01.. = SEID: 1\n        .... ..0. = In Use: False (0x0)\n        .... ...0 = RFA0: 0x0\n        0000 .... = Media Type: Audio (0x0)\n        .... 0... = Type: Source (0x0)\n        .... .000 = RFA1: 0x0\n    ACP SEP [2 - Audio Source] item 2/2\n        0000 10.. = SEID: 2\n        .... ..0. = In Use: False (0x0)\n        .... ...0 = RFA0: 0x0\n        0000 .... = Media Type: Audio (0x0)\n        .... 0... = Type: Source (0x0)\n        .... .000 = RFA1: 0x0\n\n#获取音源详细信息\n> 470\t11.722896\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tAVDTP\t12\tSent Command - GetAllCapabilities - ACP SEID [1 - Audio Source]\n> 473\t11.728705\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tAVDTP\t23\tRcvd ResponseAccept - GetAllCapabilities - Audio SBC (44100 | Mono JointStereo | block: 4 8 12 16 | subbands: 8 | allocation: Loudness | bitpool: 2..53)\n> 474\t11.728960\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tAVDTP\t12\tSent Command - GetAllCapabilities - ACP SEID [2 - Audio Source]\n> 476\t11.734811\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tAVDTP\t25\tRcvd ResponseAccept - GetAllCapabilities - Audio MPEG-2,4 AAC\n---------------------------------------------------------------------------\nBluetooth AVDTP Protocol\n    Signal: GetAllCapabilities (ResponseAccept)\n        0010 .... = Transaction: 0x2\n        .... 00.. = Packet Type: Single (0x0)\n        .... ..10 = Message Type: ResponseAccept (0x2)\n        00.. .... = RFA: 0x0\n        ..00 1100 = Signal: GetAllCapabilities (0x0c)\n    Capabilities\n        Service: Media Transport\n        Service: Media Codec - Audio MPEG-2,4 AAC\n        Service: Delay Reporting\n```\n\n#### 设置/打开(Configured/Open)\n\n```dtd\n#选择对应音源\n> 477\t11.735508\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tAVDTP\t25\tSent Command - SetConfiguration - ACP SEID [2 - Audio Source] - INT SEID [2 - Audio Source] - Audio MPEG-2,4 AAC\n> 479\t11.742210\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tAVDTP\t11\tRcvd ResponseAccept - SetConfiguration\n\n#打开音源\n> 480\t11.742538\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tAVDTP\t12\tSent Command - Open - ACP SEID [2 - Audio Source]\n---------------------------------------------------------------------------\nBluetooth AVDTP Protocol\n    Signal: Open (Command)\n    ACP SEID [2 - Audio Source]\n> 485\t11.747312\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tAVDTP\t11\tRcvd ResponseAccept - Open\n```\n\n#### 开始传输(Streaming)\n\n```dtd\n> 601\t28.945727\tXiaomiCo_f2:31:c7 (PHONE)\tSANYOEle_71:7b:5c (DEVICE)\tAVDTP\t12\tRcvd Command - Start - ACP SEID [2 - Audio Sink]\n> 602\t28.946025\tSANYOEle_71:7b:5c (DEVICE)\tXiaomiCo_f2:31:c7 (PHONE)\tAVDTP\t11\tSent ResponseAccept - Start\n```\n\n#### 传输(Streaming)\n\n使用RTP协议传输数据，AVDTP协议本身不处理数据流。\n\n```dtd\n> 612\t29.166322\tXiaomiCo_f2:31:c7 (PHONE)\tSANYOEle_71:7b:5c (DEVICE)\tRTP\t37\tPT=Unknown, SSRC=0x2, Seq=1, Time=0\n---------------------------------------------------------------------------\nFrame 612: 37 bytes on wire (296 bits), 37 bytes captured (296 bits)\nBluetooth\nBluetooth HCI H4\nBluetooth HCI ACL Packet\nBluetooth L2CAP Protocol\nBluetooth A2DP Profile\n    [ACP SEID: 2]\n    [INT SEID: 2]\n    [Codec: MPEG-2,4 AAC (0x02)]\n    [Stream Start in Frame: 612]\n    [Stream End in Frame: 22786]\n    [Stream Number: 1]\nReal-Time Transport Protocol\n    [Stream setup by BT A2DP (frame 612)]\n    10.. .... = Version: RFC 1889 Version (2)\n    ..0. .... = Padding: False\n    ...0 .... = Extension: False\n    .... 0000 = Contributing source identifiers count: 0\n    0... .... = Marker: False\n    Payload type: Unknown (98)\n    Sequence number: 1\n    [Extended sequence number: 65537]\n    Timestamp: 0\n    Synchronization Source identifier: 0x00000002 (2)\nData (16 bytes)\n    Data: 47fc0000b0908003000621100520a41c\n    [Length: 16]\n\n```\n\n#### 暂停(Streaming)\n\n```dtd\n> 773\t23.510436\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVDTP\t11\tSent ResponseAccept - Suspend\n```\n\n#### 释放(Closing)\n\n```dtd\n> 5692\t96.414176\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVDTP\t12\tSent Command - Close - ACP SEID [2 - Audio Source]\n```\n\n## AVCTP\n\n**AVCTP： Audio/Video Control Transport Protocol(音频/视频控制传输协议)**，用于蓝牙设备间音乐数据流功能的发现与控制，但是控制的具体功能逻辑不由AVCTP处理，其只发送命令。\n\n发现由SDP协议完成，然后发起L2CAP通道连接蓝牙设备之间的AVCTP服务，如下:\n\n```dtd\n#发现\n> 134\t0.964749\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tSDP\t33\tSent Service Search Attribute Request : Audio Source: [Service Class ID List 0x0001] [Protocol Descriptor List 0x0004] [Bluetooth Profile Descriptor List 0x0009] \n> 139\t0.981837\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tSDP\t64\tRcvd Service Search Attribute Response \n---------------------------------------------------------------------------\nBluetooth SDP Protocol\n    PDU: Service Search Attribute Response (0x07)\n    Transaction Id: 0x0000\n    Parameter Length: 50\n    Attribute List Byte Count: 47\n    Attribute Lists [count =  1]\n        Data Element: Sequence uint8 45 bytes\n            0011 0... = Data Element Type: Sequence (6)\n            .... .101 = Data Element Size: uint8 (5)\n            Data Element Var Size: 45\n            Data Value\n                Attribute List [count =  3] (Audio Source)\n                    Data Element: Sequence uint16 42 bytes\n                        0011 0... = Data Element Type: Sequence (6)\n                        .... .110 = Data Element Size: uint16 (6)\n                        Data Element Var Size: 42\n                        Data Value\n                            Service Attribute: Service Class ID List (0x1), value = Audio Source\n                                Attribute ID: Service Class ID List\n                                Value\n                            Service Attribute: Protocol Descriptor List (0x4), value = L2CAP:25 -> AVDTP (1.3)\n                                Attribute ID: Protocol Descriptor List\n                                Value\n                            Service Attribute: Bluetooth Profile Descriptor List (0x9), value = Advanced Audio Distribution 1.3\n                                Attribute ID: Bluetooth Profile Descriptor List\n                                Value\n    Continuation State: no (00)\n\n\n#连接\n> 147\t1.006617\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tL2CAP\t17\tSent Connection Request (AVDTP, SCID: 0x0043)\n> 155\t1.017317\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tL2CAP\t21\tRcvd Connection Response - Success (SCID: 0x0043, DCID: 0x0042)\n```\n\n## AVRCP\n\n**AVRCP：Audio/Video Remote Control Profile(音频/视频远程控制配置文件)**，用于控制蓝牙音乐的标准接口。\n\n在AVRCP中，**TG**表示播放设备，**CT**表示控制设备。\n\n### 命令格式\n\n命令分为两个类型：VENDOR DEPENDENT 与PASS THROUGH，\n\n- VENDOR DEPENDENT：通过`Ctype`与`PDU ID`来区分功能，`Ctype`有**Control, Status , Notify**,ACCEPTED,REJECTED, CHANGED,INTERIM,IMPLEMENTED,STABLE等。\n\n- PASS THROUGH：是播放控制命令，`Ctype`只有**Control**。\n\n其中请求命令`Ctype`为**Notify**，回复事件`Ctype`为**Interim**，事件通知`Ctype`为**Changed**。\n\n### 获取TG播放器支持功能\n\n`PDU ID`：GetFolderItems，通过`Scope`来区分功能，用于**TG**可以播放器列表与每个播放器支持的功能。\n\n```dtd\n> 307\t1.551666\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t29\tSent Browsing: Command - GetFolderItems - Scope: MediaPlayerList, StartItem: 0x0000, EndItem: 0x0013\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    PDU ID: GetFolderItems (0x71)\n    Parameter Length: 10\n    Scope: MediaPlayerList (0x00)\n    StartItem: 0\n    EndItem: 19\n    Attribute Count: All attributes are requested (0)\n    Attribute List\n\n> 326\t1.651062\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t67\tRcvd Browsing: OK - GetFolderItems - UidCounter: 0x0000, NumberOfItems: 1\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    PDU ID: GetFolderItems (0x71)\n    Parameter Length: 48\n    Status: OK (0x04)\n    UID Counter: 0x0000\n    Number Of Items: 1\n    Player: Music Player\n        Item Type: Media Player Item (0x01)\n        Item Length: 40\n        Player ID: 0\n        Major Player Type: Unknown (0x01)\n        Player SubType: Audio Book (0x00000001)\n        Play Status: Stopped (0x00)\n        Features\n            Not Used Features\n            .... ...1 = PASSTHROUGH Play: 0x1\n            .... ..1. = PASSTHROUGH Stop: 0x1\n            .... .1.. = PASSTHROUGH Pause: 0x1\n            ...1 .... = PASSTHROUGH Rewind: 0x1\n            ..1. .... = PASSTHROUGH FastForward: 0x1\n            1... .... = PASSTHROUGH Forward: 0x1\n            .... ...1 = PASSTHROUGH Backward: 0x1\n            .... .1.. = Advanced Control Player: 0x1\n        Character Set: UTF-8 (106)\n        Displayable Name Length: 12\n        Displayable Name: Music Player\n```\n\n### 获取TG支持事件\n\n`PDU ID`：GetCapabilities，用于**TG**可以支持的事件。\n\n```dtd\n> 288\t1.233497\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t23\tSent Vendor dependent: Status - GetCapabilities(Events Supported)\n> 299\t1.252688\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t30\tRcvd Vendor dependent: Stable - GetCapabilities(Events Supported) - Count: 6\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    0000 .... = Reserved: 0x0\n    .... 1100 = Ctype: Stable (0xc)\n    0100 1... = Subunit Type: Panel (0x09)\n    .... .000 = Subunit ID: 0x0\n    Opcode: Vendor dependent (0x00)\n    Company ID: 00:19:58 (Bluetooth SIG, Inc.)\n    PDU ID: GetCapabilities (0x10)\n    0000 00.. = RFA: 0x00\n    .... ..00 = Packet Type: Single (0x0)\n    Parameter Length: 8\n    Capability: Events Supported (0x03)\n    Capability Count: 0x06\n    Event ID: PlaybackStatusChanged (0x01)\n    Event ID: TrackChanged (0x02)\n    Event ID: PlaybackPositionChanged (0x05)\n    Event ID: AvailablePlayersChanged (0x0a)\n    Event ID: AddressedPlayerChanged (0x0b)\n    Event ID: NowPlayingContentChanged (0x09)\n    [Response Time: 19/1000ms]\n    [Command in frame: 288]\n```\n\n### 播放器状态\n\n**CT**端获取**TC**端播放状态，`Play Status`的参数由`GetFolderItems`原语获取，通过`Ctype`来区分操作。\n\n#### 注册事件\n\n`PDU ID`：RegisterNotification，`Event ID`为: PlaybackStatusChanged(`GetCapabilities`原语获取)。\n\n```dtd\n> 300\t1.252942\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t27\tSent Vendor dependent: Notify - RegisterNotification - PlaybackStatusChanged\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    0000 .... = Reserved: 0x0\n    .... 0011 = Ctype: Notify (0x3)\n    0100 1... = Subunit Type: Panel (0x09)\n    .... .000 = Subunit ID: 0x0\n    Opcode: Vendor dependent (0x00)\n    Company ID: 00:19:58 (Bluetooth SIG, Inc.)\n    PDU ID: RegisterNotification (0x31)\n    0000 00.. = RFA: 0x00\n    .... ..00 = Packet Type: Single (0x0)\n    Parameter Length: 5\n    Event ID: PlaybackStatusChanged (0x01)\n    Interval: 0\n    [Response Time: 107/1000ms]\n    [Response in frame: 324]\n\n> 324\t1.649874\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t24\tRcvd Vendor dependent: Interim - RegisterNotification - PlaybackStatusChanged - PlayStatus: Paused\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    0000 .... = Reserved: 0x0\n    .... 1111 = Ctype: Interim (0xf)\n    0100 1... = Subunit Type: Panel (0x09)\n    .... .000 = Subunit ID: 0x0\n    Opcode: Vendor dependent (0x00)\n    Company ID: 00:19:58 (Bluetooth SIG, Inc.)\n    PDU ID: RegisterNotification (0x31)\n    0000 00.. = RFA: 0x00\n    .... ..00 = Packet Type: Single (0x0)\n    Parameter Length: 2\n    Event ID: PlaybackStatusChanged (0x01)\n    Play Status: Paused (0x02)\n    [Response Time: 107/1000ms]\n    [Command in frame: 300]\n```\n\n#### 事件通知\n\n`PDU ID`：RegisterNotification，`Event ID`为: PlaybackStatusChanged，通过`Ctype`来区分功能。\n\n```dtd\n> 372\t2.461590\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t24\tRcvd Vendor dependent: Changed - RegisterNotification - PlaybackStatusChanged - PlayStatus: Stopped\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    0000 .... = Reserved: 0x0\n    .... 1101 = Ctype: Changed (0xd)\n    0100 1... = Subunit Type: Panel (0x09)\n    .... .000 = Subunit ID: 0x0\n    Opcode: Vendor dependent (0x00)\n    Company ID: 00:19:58 (Bluetooth SIG, Inc.)\n    PDU ID: RegisterNotification (0x31)\n    0000 00.. = RFA: 0x00\n    .... ..00 = Packet Type: Single (0x0)\n    Parameter Length: 2\n    Event ID: PlaybackStatusChanged (0x01)\n    Play Status: Stopped (0x00)\n    [Response Time: 107/1000ms]\n    [Command in frame: 300]\n```\n\n#### 主动获取\n\n`PDU ID`：GetPlayStatus，往往与`RegisterNotification-TrackChanged`命令配合使用。\n\n```dtd\n> 466\t18.051244\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t22\tSent Vendor dependent: Status - GetPlayStatus\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    0000 .... = Reserved: 0x0\n    .... 0001 = Ctype: Status (0x1)\n    0100 1... = Subunit Type: Panel (0x09)\n    .... .000 = Subunit ID: 0x0\n    Opcode: Vendor dependent (0x00)\n    Company ID: 00:19:58 (Bluetooth SIG, Inc.)\n    PDU ID: GetPlayStatus (0x30)\n    0000 00.. = RFA: 0x00\n    .... ..00 = Packet Type: Single (0x0)\n    Parameter Length: 0\n    [Response Time: 40/1000ms]\n    [Response in frame: 478]\n\n> 478\t18.091970\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t31\tRcvd Vendor dependent: Stable - GetPlayStatus PlayStatus: Playing, SongPosition: 6118ms, SongLength: 175000ms\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    0000 .... = Reserved: 0x0\n    .... 1100 = Ctype: Stable (0xc)\n    0100 1... = Subunit Type: Panel (0x09)\n    .... .000 = Subunit ID: 0x0\n    Opcode: Vendor dependent (0x00)\n    Company ID: 00:19:58 (Bluetooth SIG, Inc.)\n    PDU ID: GetPlayStatus (0x30)\n    0000 00.. = RFA: 0x00\n    .... ..00 = Packet Type: Single (0x0)\n    Parameter Length: 9\n    Song Length: 175000\n    Song Position: 6118\n    Play Status: Playing (0x01)\n    [Response Time: 40/1000ms]\n    [Command in frame: 466]\n```\n\n### 播放进度\n\n使用`PDU ID`：GetPlayStatus，获取**TG**端播放进度，**CT**端轮循调用此命令。其中`Song Length`参数为音乐长度，`Song Position`为当前播放进度。日志参考`主动获取播放器`章节。\n\n### 音轨状态\n\n**CT**端获取**TC**端播放器音轨状态，状态有下面两种：\n\n- 无音轨：`Identifier: 0xffffffffffffffff (NOT SELECTED)`\n- 有音轨：`Identifier: 0x0000000000000000 (SELECTED)`\n\n**音轨状态事件**会在每次开始播放都会有事件，歌词就是通过发送**音轨状态事件**来完成的。\n\n#### 注册事件\n\n`PDU ID`：RegisterNotification，`Event ID`为: TrackChanged(`GetCapabilities`原语获取)。\n\n```dtd\n> 323\t1.331254\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t27\tSent Vendor dependent: Notify - RegisterNotification - TrackChanged\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    0000 .... = Reserved: 0x0\n    .... 0011 = Ctype: Notify (0x3)\n    0100 1... = Subunit Type: Panel (0x09)\n    .... .000 = Subunit ID: 0x0\n    Opcode: Vendor dependent (0x00)\n    Company ID: 00:19:58 (Bluetooth SIG, Inc.)\n    PDU ID: RegisterNotification (0x31)\n    0000 00.. = RFA: 0x00\n    .... ..00 = Packet Type: Single (0x0)\n    Parameter Length: 5\n    Event ID: TrackChanged (0x02)\n    Interval: 0\n    [Response Time: 35/1000ms]\n    [Response in frame: 330]\n\n> 330\t1.366518\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t31\tRcvd Vendor dependent: Interim - RegisterNotification - TrackChanged - 0xFFFFFFFFFFFFFFFF (NOT SELECTED)\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    0000 .... = Reserved: 0x0\n    .... 1111 = Ctype: Interim (0xf)\n    0100 1... = Subunit Type: Panel (0x09)\n    .... .000 = Subunit ID: 0x0\n    Opcode: Vendor dependent (0x00)\n    Company ID: 00:19:58 (Bluetooth SIG, Inc.)\n    PDU ID: RegisterNotification (0x31)\n    0000 00.. = RFA: 0x00\n    .... ..00 = Packet Type: Single (0x0)\n    Parameter Length: 9\n    Event ID: TrackChanged (0x02)\n    Identifier: 0xffffffffffffffff (NOT SELECTED)\n    [Response Time: 35/1000ms]\n    [Command in frame: 323]\n```\n\n#### 事件通知\n\n`PDU ID`：RegisterNotification，`Event ID`为: TrackChanged，通过`Ctype`来区分功能。\n\n```dtd\n> 451\t18.026715\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t31\tRcvd Vendor dependent: Changed - RegisterNotification - TrackChanged - 0x0000000000000000 (SELECTED)\n```\n\n### 获取播放音轨的属性\n\n获取当前音轨，播放音乐的属性，如标题、歌手等信息。`Attribute List`请查看[AVRCP协议规范](参考)第26章节，往往与`RegisterNotification-TrackChanged`命令配合使用。\n\n```dtd\n> 465\t18.050915\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t59\tSent Vendor dependent: Status - GetElementAttributes - 0x0000000000000000 (PLAYING)\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    0000 .... = Reserved: 0x0\n    .... 0001 = Ctype: Status (0x1)\n    0100 1... = Subunit Type: Panel (0x09)\n    .... .000 = Subunit ID: 0x0\n    Opcode: Vendor dependent (0x00)\n    Company ID: 00:19:58 (Bluetooth SIG, Inc.)\n    PDU ID: GetElementAttributes (0x20)\n    0000 00.. = RFA: 0x00\n    .... ..00 = Packet Type: Single (0x0)\n    Parameter Length: 37\n    Identifier: 0x0000000000000000\n    Number of Attributes: 7\n    Attribute List\n        Attribute ID: Title (0x00000001)\n        Attribute ID: Artist (0x00000002)\n        Attribute ID: Album (0x00000003)\n        Attribute ID: Media Number (0x00000004)\n        Attribute ID: Total Number of Media (0x00000005)\n        Attribute ID: Genre (0x00000006)\n        Attribute ID: Playing Time (0x00000007)\n    [Response Time: 3/1000ms]\n    [Response in frame: 469]\n\n> 469\t18.054345\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t127\tRcvd Vendor dependent: Stable - GetElementAttributes - Title: \"Demons\"\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    0000 .... = Reserved: 0x0\n    .... 1100 = Ctype: Stable (0xc)\n    0100 1... = Subunit Type: Panel (0x09)\n    .... .000 = Subunit ID: 0x0\n    Opcode: Vendor dependent (0x00)\n    Company ID: 00:19:58 (Bluetooth SIG, Inc.)\n    PDU ID: GetElementAttributes (0x20)\n    0000 00.. = RFA: 0x00\n    .... ..00 = Packet Type: Single (0x0)\n    Parameter Length: 105\n    Number of Attributes: 7\n    Attribute Entries\n        Attribute [                Title]: Demons\n        Attribute [               Artist]: Imagine Dragons\n        Attribute [                Album]: Continued Silence\n        Attribute [         Media Number]: 10\n        Attribute [Total Number of Media]: 18\n        Attribute [                Genre]: \n        Attribute [         Playing Time]: 175000\n    [Response Time: 3/1000ms]\n    [Command in frame: 465]\n```\n\n### 播放器控制\n\n**CT**控制**TG**播放器的相关命令，都是PASS THROUGH类型，通过`Operation ID`来区分功能，通过`Ctype`来区分操作。\n\n#### 播放\n\n```dtd\n> 298\t1.252592\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t17\tSent Pass Through: Control - PLAY (Pushed)\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    0000 .... = Reserved: 0x0\n    .... 0000 = Ctype: Control (0x0)\n    0100 1... = Subunit Type: Panel (0x09)\n    .... .000 = Subunit ID: 0x0\n    Opcode: Pass Through (0x7c)\n    0... .... = State: Pushed (0x0)\n    .100 0100 = Operation ID: PLAY (0x44)\n    Data Length: 0x00\n    [Response Time: 14/200ms]\n    [Response in frame: 308]\n\n>308\t1.266992\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t17\tRcvd Pass Through: Accepted - PLAY (Pushed)\n```\n\n#### 暂停\n\n```dtd\n> 430\t7.424245\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t17\tSent Pass Through: Control - PAUSE (Pushed)\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    0000 .... = Reserved: 0x0\n    .... 0000 = Ctype: Control (0x0)\n    0100 1... = Subunit Type: Panel (0x09)\n    .... .000 = Subunit ID: 0x0\n    Opcode: Pass Through (0x7c)\n    0... .... = State: Pushed (0x0)\n    .100 0110 = Operation ID: PAUSE (0x46)\n    Data Length: 0x00\n    [Response Time: 70/200ms]\n    [Response in frame: 434]\n\n> 434\t7.494377\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t17\tRcvd Pass Through: Accepted - PAUSE (Pushed)\n```\n\n#### 下一曲\n\n```dtd\n> 1163\t40.755874\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t17\tSent Pass Through: Control - BACKWARD (Pushed)\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    0000 .... = Reserved: 0x0\n    .... 0000 = Ctype: Control (0x0)\n    0100 1... = Subunit Type: Panel (0x09)\n    .... .000 = Subunit ID: 0x0\n    Opcode: Pass Through (0x7c)\n    0... .... = State: Pushed (0x0)\n    .100 1100 = Operation ID: BACKWARD (0x4c)\n    Data Length: 0x00\n    [Response Time: 15/200ms]\n    [Response in frame: 1168]\n\n> 1168\t40.771498\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t17\tRcvd Pass Through: Accepted - BACKWARD (Pushed)\n```\n\n#### 上一曲\n\n```dtd\n> 969\t37.736799\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t17\tSent Pass Through: Control - FORWARD (Pushed)\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    0000 .... = Reserved: 0x0\n    .... 0000 = Ctype: Control (0x0)\n    0100 1... = Subunit Type: Panel (0x09)\n    .... .000 = Subunit ID: 0x0\n    Opcode: Pass Through (0x7c)\n    0... .... = State: Pushed (0x0)\n    .100 1011 = Operation ID: FORWARD (0x4b)\n    Data Length: 0x00\n    [Response Time: 25/200ms]\n    [Response in frame: 976]\n\n> 976\t37.762691\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t17\tRcvd Pass Through: Accepted - FORWARD (Pushed)\n```\n\n# 参考\n- 蓝牙核心协议规范[Core_v4.2.pdf](https://www.bluetooth.org/DocMan/handlers/DownloadDoc.ashx?doc_id=286439)\n- PBAP协议规范[PBAP_v1.2.3.pdf](https://www.bluetooth.com/specifications/specs/phone-book-access-profile-1-2-3/)\n- HFP协议规范[HFP_v1.8.pdf](https://www.bluetooth.com/specifications/specs/hands-free-profile-1-8/)\n- AVDTP协议规范[AVDTP_SPEC_V13.pdf](https://www.bluetooth.com/specifications/specs/a-v-distribution-transport-protocol-1-3/)\n- AVCTP协议规范[AVCTP_SPEC_V14.pdf](https://www.bluetooth.com/specifications/specs/a-v-%e2%80%8b%e2%80%8bcontrol-transport-protocol-1-4/)\n- AVRCP协议规范[AVRCP_v1.6.2.pdf](https://www.bluetooth.com/specifications/specs/a-v-remote-control-profile-1-6-2/)\n- [蓝牙物理链路类型：SCO和ACL链路与A2DP](https://blog.csdn.net/wenzongliang/article/details/84689377)\n- [安全简单配对](https://blog.csdn.net/XiaoXiaoPengBo/article/details/107792407)\n- [在HCI层看蓝牙的连接过程](https://blog.csdn.net/u010657219/article/details/42192481)\n- [蓝牙SDP协议概述 ](https://www.cnblogs.com/libs-liu/p/9498952.html)\n- [RFCOMM协议概念介绍](https://blog.csdn.net/XiaoXiaoPengBo/article/details/108125755)\n- [蓝牙的OBEX协议](https://blog.51cto.com/u_2982693/3521456)\n- [蓝牙电话之PBAP协议分析](https://blog.csdn.net/weixin_44260005/article/details/105223139)\n- [蓝牙之八-HFP](https://blog.csdn.net/shichaog/article/details/52123439)\n- [蓝牙之九-AT命令](https://blog.csdn.net/shichaog/article/details/52126415)\n\n","source":"_posts/traditional-bluetooth-protocol-stack-simple.md","raw":"---\ntitle: 传统蓝牙协议栈初探\ndate: 2022-04-11 17:05:36\ntags:\n---\n\n# 概述\n\n此文主要是简单的探索一下蓝牙电话和蓝牙音乐相关协议栈，所以很多细节并未涉及。\n\n一般而言，我们把某个协议的实现代码称为协议栈(protocol stack)，要理解协议栈需要先了解蓝牙的核心系统架构，如下图：\n\n![](https://s1.ax1x.com/2022/04/11/LV6Ybd.png)\n\n也可简单的**抽象为3层**：![](https://s1.ax1x.com/2022/04/11/LV6JDH.png)\n\n- **User Application(Host)**：User Application即应用层，也被称为Host，我们调用Bluetooth API就属于应用层，例如，[BluetoothAdapter](https://developer.android.com/reference/android/bluetooth/BluetoothAdapter.html)中提供的接口。\n- **HCI (Host controller Interface)**：上层在调用蓝牙API时，**不会直接操作蓝牙底层**(Controller)相关接口，而是**通过HCI下发对应操作的Command给Controller**，然后底层执行命令后返回执行结果，**即Controller发送Event给HCI，HCI再通知给应用层**，HCI起到了一个**中间层**的作用。\n- **Controller**：Controller是在最底层，硬件驱动。\n\n按照上面的定义，HCI与Host层中的协议实现就是**蓝牙协议栈**。\n\n## HCI\n\n>  BLUETOOTH SPECIFICATION Version 4.2 [Vol 2, Part E] page 400  \n>\n>  HCI（HOST CONTROLLER INTERFACE）：主机控制层接口，主要负责透过transport把协议栈的数据发送给蓝牙芯片，并且接受来自蓝牙芯片的数据，数据主要分为HCI COMMAND(HOST->CONTROLLER),HCI EVENT(HOST<-CONTROLLER),HCI ACL(HOST<->CONTROLLER),HCI SCO(这个有点些微差异，因为部分芯片的SCO数据不是透过TRANSPORT直接跟HOST沟通，而是通过特殊的引脚，PCM IN/OUT/SYNC/CLK脚来传输数据)\n\nHOST层的几乎所有数据最后都会通过HCI，所以我们通过HCI的日志就可以了解蓝牙协议栈中每个协议，手机中可以通过开发者模式打开HCI日志开关，推荐使用**wireshark**或者**Frontline ComProbe Protocol Analysis System**来分析HCI日志，下面给出来的的日志都是**wireshark**的结果。\n\nHCI日志由各种数据包组成，我们需要了解其中的两种数据包如下：\n\n### Command 数据包\n\nHCI Command数据包格式如下，开头的**Opcode是区分不同类型的命令的唯一标识**，Opcode由**OpCode Group Field (OGF)** 和 **OpCode Command Field (OCF)**组成。根据OGF的值，可以将HCI commands进行分类。OpCode 的计算公式为：`OpCode = OGF << 6 + OCF` **。有了OpCode计算的方式，我们就可以**通过OpCode过滤HCI log里面的指定类型的HCI Command。\n\n![](https://s1.ax1x.com/2022/04/11/LV608f.png)\n\n一次HCI Command指令发送完成，通常两条数据包，一条是host给controller的指令，一条是controller给host的指令反馈，可以确定指令发送是成功的。\n\n### Event 数据包\n\nHCI Event 数据包由controller发送给Host，其中可以是蓝牙设备的消息也可以是连接的蓝牙设备的消息。\n\n![](https://s1.ax1x.com/2022/04/11/LV6B28.png)\n\n# 设备连接\n\n## 蓝牙设备状态\n\n> BLUETOOTH SPECIFICATION Version 4.2 [Vol 2, Part B] page 159  \n\n扫描设备然后与之建立连接是蓝牙工作流程的第一步，所以先要了解一下蓝牙的状态如下图：\n\n![](https://s1.ax1x.com/2022/04/11/LV6wPP.png)\n\n从<u>蓝牙状态转换图</u>中可以看出 STANDBY状体是蓝牙设备的默认状态。\n\n**Page**：这个子状态就是我们通常称为的连接(寻呼)，进行连接/激活对应的slave的操作我们就称为page。\n\n**Page scan**：这个子状态是和page对应的，它就是等待被page的slave所处的状态，换句话说，若想被page到，我们就要处于page scan的状态。\n\n**inquiry**：这就是我们通常所说的扫描状态，这个状态的设备就是去扫描周围的设备。\n\n**inquiry scan**：这就是我们通常看到的可被发现的设备。体现在上层就是我们在android系统中点击设备可被周围什么发现，那设备就处于这样的状态。\n\n## 逻辑链路传输协议\n\n### ACL\n\n> BLUETOOTH SPECIFICATION Version 4.2 [Vol 1, Part A]  page  63  \n>\n> The asynchronous connection-oriented (ACL) logical transport is used to carry\n> LMP and L2CAP control signaling and best effort asynchronous user data. The\n> ACL logical transport uses a 1-bit ARQN/SEQN scheme to provide simple\n> channel reliability. Every active slave device within a piconet has one ACL\n> logical transport to the piconet master, known as the default ACL.  \n\nACL全称**BR/EDR Asynchronous Connection-oriented**，定向连接，它既支持对称连接，也支持不对称连接（既可以一对一，也可以一对多）。主设备负责控制链路带宽，并决定微微网中的每个从设备可以占用多少带宽和连接的对称性。从设备只有被选中时才能传送数据。ACL链路也支持接收主设备发给微微网中所有从设备的广播消息。\n\n建立ACL需要设备HCI之间进行的下面的操作，这个也与**蓝牙状态**息息相关。\n\n#### 开始扫描\n\n- **Host**:\n\n  ```java\n  LocalBluetoothManager.getInstance().getBluetoothAdapter().startScanning(true);\n  ```\n\n- **Controller**:\n\n  ```dtd\n  #发送扫描指令\n  > 103\t4.351128\thost\tcontroller\tHCI_CMD\t9\tSent Inquiry\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - Inquiry\n      Command Opcode: Inquiry (0x0401)\n          0000 01.. .... .... = Opcode Group Field: Link Control Commands (0x01)\n          .... ..00 0000 0001 = Opcode Command Field: Inquiry (0x001)\n      Parameter Total Length: 5\n      LAP: 0x9e8b33\n      Inquiry Length: 10 (12.8 sec)\n      Num Responses: 0\n      [Pending in frame: 104]\n      [Command-Pending Delta: 0.846ms]\n      [Response in frame: 429]\n      [Command-Response Delta: 12811.07ms]\n  \n  #HCI反馈扫描指令状态\n  > 104\t4.351974\tcontroller\thost\tHCI_EVT\t7\tRcvd Command Status (Inquiry)\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Command Status\n      Event Code: Command Status (0x0f)\n      Parameter Total Length: 4\n      Status: Pending (0x00)\n      Number of Allowed Command Packets: 1\n      Command Opcode: Inquiry (0x0401)\n      [Command in frame: 103]\n      [Response in frame: 429]\n      [Command-Pending Delta: 0.846ms]\n      [Pending-Response Delta: 12810.224ms]\n  \n  #HCI发送的扫描到的设备信息\n  > 114\t4.505582\tcontroller\thost\tHCI_EVT\t258\tRcvd Extended Inquiry Result\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Extended Inquiry Result\n      Event Code: Extended Inquiry Result (0x2f)\n      Parameter Total Length: 255\n      Number of responses: 1\n      BD_ADDR: XiaomiCo_77:c2:35 (00:00:00:00:00:00)\n      Page Scan Repetition Mode: R1 (0x01)\n      Reserved: 0x02\n      Class of Device: 0x5a020c (Phone:Smartphone - services: Networking Capturing ObjectTransfer Telephony)\n      .000 0000 0011 0100 = Clock Offset: 0x0034\n      RSSI: -88 dBm\n      Extended Inquiry Response Data\n          Device Name: +My Phone1234567890123456789012\n          16-bit Service Class UUIDs\n          32-bit Service Class UUIDs\n          128-bit Service Class UUIDs\n          Unused\n  \n  ```\n\n#### 停止扫描\n\n- **Host**:\n\n    ```java\n    LocalBluetoothManager.getInstance().getBluetoothAdapter().stopScanning();\n    ```\n\n- **Controller**:\n\n  ```dtd\n  > 85\t2.202129\thost\tcontroller\tHCI_CMD\t4\tSent Inquiry Cancel\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - Inquiry Cancel\n      Command Opcode: Inquiry Cancel (0x0402)\n          0000 01.. .... .... = Opcode Group Field: Link Control Commands (0x01)\n          .... ..00 0000 0010 = Opcode Command Field: Inquiry Cancel (0x002)\n      Parameter Total Length: 0\n      [Response in frame: 86]\n      [Command-Response Delta: 2.051ms]\n  \n  > 86\t2.204180\tcontroller\thost\tHCI_EVT\t7\tRcvd Command Complete (Inquiry Cancel)\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Command Complete\n      Event Code: Command Complete (0x0e)\n      Parameter Total Length: 4\n      Number of Allowed Command Packets: 1\n      Command Opcode: Inquiry Cancel (0x0402)\n      Status: Success (0x00)\n      [Command in frame: 85]\n      [Command-Response Delta: 2.051ms]\n  ```\n\n#### 完成扫描\n\n- **Host**:\n\n  ```java\n  LocalBluetoothManager.getInstance().getEventManager().registerCallback(new BluetoothCallback() {\n     \t\t@Override\n  \t\tpublic void onScanningStateChanged(boolean started) {\n  \t\t} \n  });\n  ```\n\n- **Controller**:\n\n  ```dtd\n  > 429\t17.162198\tcontroller\thost\tHCI_EVT\t4\tRcvd Inquiry Complete\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Inquiry Complete\n      Event Code: Inquiry Complete (0x01)\n      Parameter Total Length: 1\n      Status: Success (0x00)\n      [Command in frame: 103]\n      [Pending in frame: 104]\n      [Pending-Response Delta: 12810.224ms]\n      [Command-Response Delta: 12811.07ms]\n  ```\n\n#### 设备配对\n\n![](https://s1.ax1x.com/2022/04/11/LV6GKe.png)\n\n##### 配对\n\n- **Host**:\n\n  ```java\n  CachedBluetoothDevice.startPairing();\n  ```\n  \n- **Controller**:\n\n  ```dtd\n  #删除需要连接设备本地记忆的Link Key\n  > 685\t33.812149\thost\tcontroller\tHCI_CMD\t11\tSent Delete Stored Link Key\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - Delete Stored Link Key\n      Command Opcode: Delete Stored Link Key (0x0c12)\n          0000 11.. .... .... = Opcode Group Field: Host Controller & Baseband Commands (0x03)\n          .... ..00 0001 0010 = Opcode Command Field: Delete Stored Link Key (0x012)\n      Parameter Total Length: 7\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Delete All Flag: Delete only Link Key for specified BD_ADDR (0x00)\n      [Response in frame: 686]\n      [Command-Response Delta: 2.147ms]\n  \n  #建立ACL连接\n  > 687\t33.814531\thost\tcontroller\tHCI_CMD\t17\tSent Create Connection\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - Create Connection\n      Command Opcode: Create Connection (0x0405)\n      Parameter Total Length: 13\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Packet Type: 0xcc18, DH5, DM5, DH3, DM3, DH1, DM1\n      Page Scan Repetition Mode: R1 (0x01)\n      Page Scan Mode: Mandatory Page Scan Mode (0x00)\n      .000 0010 0000 1000 = Clock Offset: 0x0208 (650 msec)\n      1... .... .... .... = Clock_Offset_Valid_Flag: true (1)\n      Allow Role Switch: Local device may be master, or may become slave after accepting a master slave switch. (0x01)\n      [Pending in frame: 688]\n      [Command-Pending Delta: 0.965ms]\n      [Response in frame: 690]\n      [Command-Response Delta: 1118.609ms]\n  \n  #建立ACL连接成功\n  > 690\t34.933140\tcontroller\thost\tHCI_EVT\t14\tRcvd Connect Complete\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Connect Complete\n      Event Code: Connect Complete (0x03)\n      Parameter Total Length: 11\n      Status: Success (0x00)\n      Connection Handle: 0x0033\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Link Type: ACL connection (Data Channels) (0x01)\n      Encryption Mode: Encryption Disabled (0x00)\n      [Command in frame: 687]\n      [Pending in frame: 688]\n      [Pending-Response Delta: 1117.644ms]\n      [Command-Response Delta: 1118.609ms]\n  \n  #改变当前设备的角色，这里当前设备为从(Slave)，连接设备为主(Master)\n  > 689\t34.929964\tcontroller\thost\tHCI_EVT\t11\tRcvd Role Change\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Role Change\n      Event Code: Role Change (0x12)\n      Parameter Total Length: 8\n      Status: Success (0x00)\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Role: Currently the Slave for specified BD_ADDR (0x01)\n  \n  #与设备建立连接之后，准备开始验证\n  > 697\t34.935615\thost\tcontroller\tHCI_CMD\t6\tSent Authentication Requested\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - Authentication Requested\n      Command Opcode: Authentication Requested (0x0411)\n      Parameter Total Length: 2\n      Connection Handle: 0x0033\n      [Pending in frame: 699]\n      [Command-Pending Delta: 0.917ms]\n      [Response in frame: 743]\n      [Command-Response Delta: 4291.694ms]\n  \n  #连接设备询问Link Key\n  > 701\t34.936976\tcontroller\thost\tHCI_EVT\t9\tRcvd Link Key Request\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Link Key Request\n      Event Code: Link Key Request (0x17)\n      Parameter Total Length: 6\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n  \n  #当前设备无Link Key，也就是未于连接设备配对过\n  > 705\t34.938603\thost\tcontroller\tHCI_CMD\t10\tSent Link Key Request Negative Reply\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - Link Key Request Negative Reply\n      Command Opcode: Link Key Request Negative Reply (0x040c)\n          0000 01.. .... .... = Opcode Group Field: Link Control Commands (0x01)\n          .... ..00 0000 1100 = Opcode Command Field: Link Key Request Negative Reply (0x00c)\n      Parameter Total Length: 6\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      [Response in frame: 706]\n      [Command-Response Delta: 0.87ms]\n  \n  #使用的配对方式是`简单安全配对`SSP(Simple Secure Pairng), 就是直接弹配对码\n  \n  #连接设备询问当前设备的IO能力\n  > 707\t34.939729\tcontroller\thost\tHCI_EVT\t9\tRcvd IO Capability Request\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - IO Capability Request\n      Event Code: IO Capability Request (0x31)\n      Parameter Total Length: 6\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n  \n  #回复当前设备的IO能力\n  >708\t34.939897\thost\tcontroller\tHCI_CMD\t13\tSent IO Capability Request Reply\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - IO Capability Request Reply\n      Command Opcode: IO Capability Request Reply (0x042b)\n          0000 01.. .... .... = Opcode Group Field: Link Control Commands (0x01)\n          .... ..00 0010 1011 = Opcode Command Field: IO Capability Request Reply (0x02b)\n      Parameter Total Length: 9\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      IO Capability: Display Yes/No (1)\n      OOB Data Present: OOB Authentication Data Not Present (0)\n      Authentication Requirements: MITM Protection Required - Dedicated Bonding. Use IO Capability To Determine Procedure, No Secure Connection (3)\n      [Response in frame: 709]\n      [Command-Response Delta: 0.811ms]\n  \n  ######其它参数同步\n  \n  #连接设备的IO能力，io能力参数为Display Yes/No (0x01)，需要用户确认\n  > 737\t36.532369\tcontroller\thost\tHCI_EVT\t12\tRcvd IO Capability Response\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - IO Capability Response\n      Event Code: IO Capability Response (0x32)\n      Parameter Total Length: 9\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      IO Capability: Display Yes/No (0x01)\n      OOB Data Present: OOB Authentication Data Not Present (0)\n      Authentication Requirements: MITM Protection Required - Dedicated Bonding. Use IO Capability To Determine Procedure, No Secure Connection (3)\n  \n  #当前设备接收到配对码信息，Numeric Value就是显示的配对码\n  > 738\t37.066181\tcontroller\thost\tHCI_EVT\t13\tRcvd User Confirmation Request\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - User Confirmation Request\n      Event Code: User Confirmation Request (0x33)\n      Parameter Total Length: 10\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Numeric Value: 446514\n  \n  #回复连接设备已接收到配对码信息\n  > 739\t37.096306\thost\tcontroller\tHCI_CMD\t10\tSent User Confirmation Request Reply\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - User Confirmation Request Reply\n      Command Opcode: User Confirmation Request Reply (0x042c)\n          0000 01.. .... .... = Opcode Group Field: Link Control Commands (0x01)\n          .... ..00 0010 1100 = Opcode Command Field: User Confirmation Request Reply (0x02c)\n      Parameter Total Length: 6\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      [Response in frame: 740]\n      [Command-Response Delta: 1.46ms]\n  \n  #连接设备SSP验证成功\n  > 741\t39.215747\tcontroller\thost\tHCI_EVT\t10\tRcvd Simple Pairing Complete\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Simple Pairing Complete\n      Event Code: Simple Pairing Complete (0x36)\n      Parameter Total Length: 7\n      Status: Success (0x00)\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n  \n  #连接设备的Link Key，需要保存，用于下次连接\n  > 742\t39.226970\tcontroller\thost\tHCI_EVT\t26\tRcvd Link Key Notification\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Link Key Notification\n      Event Code: Link Key Notification (0x18)\n      Parameter Total Length: 23\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Link Key: bc31fb070e91eec2f2296fbf9bc8b518\n      Key Type: Unknown (0x08)\n  \n  #验证完成\n  > 743\t39.227309\tcontroller\thost\tHCI_EVT\t6\tRcvd Authentication Complete\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Authentication Complete\n      Event Code: Authentication Complete (0x06)\n      Parameter Total Length: 3\n      Status: Success (0x00)\n      Connection Handle: 0x0033\n      [Command in frame: 697]\n      [Pending in frame: 699]\n      [Pending-Response Delta: 4290.777ms]\n      [Command-Response Delta: 4291.694ms]\n  ```\n\n##### 被配对\n\n- **Host**:\n\n  ```java\n  LocalBluetoothManager.getInstance().getEventManager().registerCallback(new BluetoothCallback() {\n     \t\t@Override\n  \t\tpublic void onDeviceBondStateChanged(CachedBluetoothDevice cachedDevice, int bondState) {\n  \t\t}\n  });\n  ```\n\n- **Controller**:\n\n  ```dtd\n  #请求ACL连接\n  > 326\t21.946869\tcontroller\thost\tHCI_EVT\t13\tRcvd Connect Request\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Connect Request\n      Event Code: Connect Request (0x04)\n      Parameter Total Length: 10\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Class of Device: 0x5a020c (Phone:Smartphone - services: Networking Capturing ObjectTransfer Telephony)\n      Link Type: ACL connection (Data Channels) (0x01)\n  \n  #允许ACL连接\n  > 327\t21.947178\thost\tcontroller\tHCI_CMD\t11\tSent Accept Connection Request\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - Accept Connection Request\n      Command Opcode: Accept Connection Request (0x0409)\n      Parameter Total Length: 7\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Role: Remain the Slave for this connection. The LM will NOT perform the role switch. (0x01)\n      [Pending in frame: 328]\n      [Command-Pending Delta: 0.685ms]\n      [Response in frame: 329]\n      [Command-Response Delta: 4.432ms]\n  \n  #ACL连接成功\n  > 329\t21.951610\tcontroller\thost\tHCI_EVT\t14\tRcvd Connect Complete\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Connect Complete\n      Event Code: Connect Complete (0x03)\n      Parameter Total Length: 11\n      Status: Success (0x00)\n      Connection Handle: 0x0033\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Link Type: ACL connection (Data Channels) (0x01)\n      Encryption Mode: Encryption Disabled (0x00)\n      [Command in frame: 327]\n      [Pending in frame: 328]\n      [Pending-Response Delta: 3.747ms]\n      [Command-Response Delta: 4.432ms]\n  \n  \n  > 370\t22.259461\tcontroller\thost\tHCI_EVT\t12\tRcvd IO Capability Response\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - IO Capability Response\n      Event Code: IO Capability Response (0x32)\n      Parameter Total Length: 9\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      IO Capability: Display Yes/No (0x01)\n      OOB Data Present: OOB Authentication Data Not Present (0)\n      Authentication Requirements: MITM Protection Required - Dedicated Bonding. Use IO Capability To Determine Procedure, No Secure Connection (3)\n  \n  > 371\t22.259809\tcontroller\thost\tHCI_EVT\t9\tRcvd IO Capability Request\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - IO Capability Request\n      Event Code: IO Capability Request (0x31)\n      Parameter Total Length: 6\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n  \n  > 372\t22.259982\thost\tcontroller\tHCI_CMD\t13\tSent IO Capability Request Reply\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - IO Capability Request Reply\n      Command Opcode: IO Capability Request Reply (0x042b)\n      Parameter Total Length: 9\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      IO Capability: Display Yes/No (1)\n      OOB Data Present: OOB Authentication Data Not Present (0)\n      Authentication Requirements: MITM Protection Required - Dedicated Bonding. Use IO Capability To Determine Procedure, No Secure Connection (3)\n      [Response in frame: 373]\n      [Command-Response Delta: 0.619ms]\n  \n  > 374\t22.958223\tcontroller\thost\tHCI_EVT\t13\tRcvd User Confirmation Request\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - User Confirmation Request\n      Event Code: User Confirmation Request (0x33)\n      Parameter Total Length: 10\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Numeric Value: 804568\n  \n  > 375\t23.069385\thost\tcontroller\tHCI_CMD\t10\tSent User Confirmation Request Reply\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - User Confirmation Request Reply\n      Command Opcode: User Confirmation Request Reply (0x042c)\n      Parameter Total Length: 6\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      [Response in frame: 376]\n      [Command-Response Delta: 1.81ms]\n  \n  #连接设备SSP验证成功\n  > 377\t26.919540\tcontroller\thost\tHCI_EVT\t10\tRcvd Simple Pairing Complete\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Simple Pairing Complete\n      Event Code: Simple Pairing Complete (0x36)\n      Parameter Total Length: 7\n      Status: Success (0x00)\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n  \n  #连接设备的Link Key，需要保存，用于下次连接\n  > 378\t26.926691\tcontroller\thost\tHCI_EVT\t26\tRcvd Link Key Notification\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Link Key Notification\n      Event Code: Link Key Notification (0x18)\n      Parameter Total Length: 23\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Link Key: 2160acf6b7403a97050f64de72570b1d\n      Key Type: Unknown (0x08)\n  ```\n  \n  \n\n#### 设备连接\n\n![](https://s1.ax1x.com/2022/04/11/LV63vD.png)\n\n##### 连接\n\n- **Host**:\n\n  ```java\n  CachedBluetoothDevice.conntect(true);\n  ```\n\n- **Controller**:\n\n  ```dtd\n  > 1214\t47.023224\thost\tcontroller\tHCI_CMD\t17\tSent Create Connection\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - Create Connection\n      Command Opcode: Create Connection (0x0405)\n      Parameter Total Length: 13\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Packet Type: 0xcc18, DH5, DM5, DH3, DM3, DH1, DM1\n      Page Scan Repetition Mode: R1 (0x01)\n      Page Scan Mode: Mandatory Page Scan Mode (0x00)\n      .011 1001 0100 0100 = Clock Offset: 0x3944 (18325 msec)\n      1... .... .... .... = Clock_Offset_Valid_Flag: true (1)\n      Allow Role Switch: Local device may be master, or may become slave after accepting a master slave switch. (0x01)\n      [Pending in frame: 1215]\n      [Command-Pending Delta: 1.458ms]\n      [Response in frame: 1217]\n      [Command-Response Delta: 1630.81ms]\n  \n  > 1216\t48.646874\tcontroller\thost\tHCI_EVT\t11\tRcvd Role Change\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Role Change\n      Event Code: Role Change (0x12)\n      Parameter Total Length: 8\n      Status: Success (0x00)\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Role: Currently the Slave for specified BD_ADDR (0x01)\n  \n  > 1217\t48.654034\tcontroller\thost\tHCI_EVT\t14\tRcvd Connect Complete\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Connect Complete\n      Event Code: Connect Complete (0x03)\n      Parameter Total Length: 11\n      Status: Success (0x00)\n      Connection Handle: 0x0033\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Link Type: ACL connection (Data Channels) (0x01)\n      Encryption Mode: Encryption Disabled (0x00)\n      [Command in frame: 1214]\n      [Pending in frame: 1215]\n      [Pending-Response Delta: 1629.352ms]\n      [Command-Response Delta: 1630.81ms]\n  \n  > 1278\t48.812485\thost\tcontroller\tHCI_CMD\t6\tSent Authentication Requested\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - Authentication Requested\n      Command Opcode: Authentication Requested (0x0411)\n      Parameter Total Length: 2\n      Connection Handle: 0x0033\n      [Pending in frame: 1279]\n      [Command-Pending Delta: 0.945ms]\n      [Response in frame: 1283]\n      [Command-Response Delta: 16.693ms]\n  \n  > 1280\t48.813892\tcontroller\thost\tHCI_EVT\t9\tRcvd Link Key Request\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Link Key Request\n      Event Code: Link Key Request (0x17)\n      Parameter Total Length: 6\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n  \n  > 1281\t48.814039\thost\tcontroller\tHCI_CMD\t26\tSent Link Key Request Reply\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - Link Key Request Reply\n      Command Opcode: Link Key Request Reply (0x040b)\n      Parameter Total Length: 22\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Link Key: 2160acf6b7403a97050f64de72570b1d\n      [Response in frame: 1282]\n      [Command-Response Delta: 1.336ms]\n  \n  > 1282\t48.815375\tcontroller\thost\tHCI_EVT\t13\tRcvd Command Complete (Link Key Request Reply)\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Command Complete\n      Event Code: Command Complete (0x0e)\n      Parameter Total Length: 10\n      Number of Allowed Command Packets: 1\n      Command Opcode: Link Key Request Reply (0x040b)\n      Status: Success (0x00)\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      [Command in frame: 1281]\n      [Command-Response Delta: 1.336ms]\n  \n  > 1283\t48.829178\tcontroller\thost\tHCI_EVT\t6\tRcvd Authentication Complete\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Authentication Complete\n      Event Code: Authentication Complete (0x06)\n      Parameter Total Length: 3\n      Status: Success (0x00)\n      Connection Handle: 0x0033\n      [Command in frame: 1278]\n      [Pending in frame: 1279]\n      [Pending-Response Delta: 15.748ms]\n      [Command-Response Delta: 16.693ms]\n  \n  ```\n  \n\n##### 被连接\n\n- **Host**:\n\n  ```java\n  LocalBluetoothManager.getInstance().getEventManager().registerCallback(new BluetoothCallback() {\n     \t\t@Override\n  \t\tpublic void onConnectionStateChanged(CachedBluetoothDevice cachedDevice, int bondState) {\n  \t\t}\n  });\n  ```\n\n- **Controller**:\n\n  ```dtd\n  > 1900\t62.151696\tcontroller\thost\tHCI_EVT\t13\tRcvd Connect Request\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Connect Request\n      Event Code: Connect Request (0x04)\n      Parameter Total Length: 10\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Class of Device: 0x5a020c (Phone:Smartphone - services: Networking Capturing ObjectTransfer Telephony)\n      Link Type: ACL connection (Data Channels) (0x01)\n  \n  > 1901\t62.152042\thost\tcontroller\tHCI_CMD\t11\tSent Accept Connection Request\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - Accept Connection Request\n      Command Opcode: Accept Connection Request (0x0409)\n      Parameter Total Length: 7\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Role: Remain the Slave for this connection. The LM will NOT perform the role switch. (0x01)\n      [Pending in frame: 1902]\n      [Command-Pending Delta: 0.748ms]\n      [Response in frame: 1903]\n      [Command-Response Delta: 4.455ms]\n  \n  > 1903\t62.156497\tcontroller\thost\tHCI_EVT\t14\tRcvd Connect Complete\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Connect Complete\n      Event Code: Connect Complete (0x03)\n      Parameter Total Length: 11\n      Status: Success (0x00)\n      Connection Handle: 0x0032\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Link Type: ACL connection (Data Channels) (0x01)\n      Encryption Mode: Encryption Disabled (0x00)\n      [Command in frame: 1901]\n      [Pending in frame: 1902]\n      [Pending-Response Delta: 3.707ms]\n      [Command-Response Delta: 4.455ms]\n  \n  > 1968\t62.415419\tcontroller\thost\tHCI_EVT\t9\tRcvd Link Key Request\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Link Key Request\n      Event Code: Link Key Request (0x17)\n      Parameter Total Length: 6\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n  \n  > 1969\t62.415629\thost\tcontroller\tHCI_CMD\t26\tSent Link Key Request Reply\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Command - Link Key Request Reply\n      Command Opcode: Link Key Request Reply (0x040b)\n      Parameter Total Length: 22\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      Link Key: 2160acf6b7403a97050f64de72570b1d\n      [Response in frame: 1971]\n      [Command-Response Delta: 0.934ms]\n  \n  > 1971\t62.416563\tcontroller\thost\tHCI_EVT\t13\tRcvd Command Complete (Link Key Request Reply)\n  ---------------------------------------------------------------------------\n  Bluetooth HCI Event - Command Complete\n      Event Code: Command Complete (0x0e)\n      Parameter Total Length: 10\n      Number of Allowed Command Packets: 1\n      Command Opcode: Link Key Request Reply (0x040b)\n      Status: Success (0x00)\n      BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n      [Command in frame: 1969]\n      [Command-Response Delta: 0.934ms]\n  \n  ```\n\n### SCO\n\n>BLUETOOTH SPECIFICATION Version 4.2 [Vol 1, Part A] page 64  \n>\n>The synchronous connection-oriented (SCO) logical transport is a symmetric,\n>point-to-point transport between the master and a specific slave. The SCO\n>logical transport reserves slots on the physical channel and can therefore be\n>considered as a circuit-switched connection between the master and the slave.\n>SCO logical transports carry 64 kb/s of information synchronized with the\n>piconet clock. Typically this information is an encoded voice stream. Three\n>different SCO configurations exist, offering a balance between robustness,\n>delay and bandwidth consumption.  \n\nSCO全称**BR/EDR Synchronous Connection-Oriented**，利用保留时隙传送数据包。连接建立后，主设备和从设备可以不被选中就发送SCO数据包。SCO数据包既可以传送话音，也可以传送数据，但在传送数据时，只用于重发被损坏的那部分的数据。\n\n### L2CAP\n\n> BLUETOOTH SPECIFICATION Version 4.2 [Vol 3, Part A] page 30  \n>\n> L2CAP（Logical Link Control and Adaptation Protocol）：逻辑链路控制与适配协议，将ACL数据分组交换为便于高层应用的数据分组格式，并提供协议复用和服务质量交换等功能。\n>\n> 通过协议多路复用、分段重组操作和组概念,向高层提供面向连接的和无连接的数据服务,L2CAP还屏蔽了低层传输协议中的很多特性，使得高层协议应用开发人员可以不必了解基层协议而进行开发。\n\n![](https://s1.ax1x.com/2022/04/11/LV6sKg.png)\n\n从架构图可以看出，L2CAP位于HCI与上层业务之间，在建立物理连接(ACL)之后，上层业务的通信和控制都由L2CAP协议与微微网(piconet )中其它蓝牙设备进行交互，类似HTTP协议的存在。\n\n下图概括了两个设备L2CAP之间的连接过程：\n\n![](https://s1.ax1x.com/2022/04/11/LV6UUI.png)\n\n### SDP\n\n> BLUETOOTH SPECIFICATION Version 4.2 [Vol 3, Part B] page 222  \n>\n> The service discovery mechanism provides the means for client applications to\n> discover the existence of services provided by server applications as well as\n> the attributes of those services. The attributes of a service include the type or\n> class of service offered and the mechanism or protocol information needed to\n> utilize the service.  \n\n全称是**Service Discovery Protocol**，服务发现协议，服务发现协议(SDP)为应用程序提供了一种方法来发现哪些服务可用，并确定这些可用服务的特征。\n\n![](https://s1.ax1x.com/2022/04/11/LV66bj.png)\n\n从上图可知蓝牙设备中同时存在一个Client和Server，通过L2CAP协议与别的设备时行交互，通过`Service Search Attribute Request   `命令查询对方设备支持的蓝牙服务，其工作流程如图：\n\n![](https://s1.ax1x.com/2022/04/11/LV6a5t.png)\n\n通过HCI可以看到发现蓝牙服务过过程中的数据：\n\n```dtd\n> 455\t22.824346\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tSDP\t29\tSent Service Search Attribute Request : L2CAP: Attribute Range (0x0000 - 0xffff) \n---------------------------------------------------------------------------\nFrame 455: 29 bytes on wire (232 bits), 29 bytes captured (232 bits)\nBluetooth\nBluetooth HCI H4\nBluetooth HCI ACL Packet\nBluetooth L2CAP Protocol\nBluetooth SDP Protocol\n    PDU: Service Search Attribute Request (0x06)\n    Transaction Id: 0x0000\n    Parameter Length: 15\n    Service Search Pattern: L2CAP\n    Maximum Attribute Byte Count: 1008\n    Attribute ID List\n        Data Element: Sequence uint8 5 bytes\n            0011 0... = Data Element Type: Sequence (6)\n            .... .101 = Data Element Size: uint8 (5)\n            Data Element Var Size: 5\n            Data Value\n                Data Element: Unsigned Integer 4 bytes\n                    0000 1... = Data Element Type: Unsigned Integer (1)\n                    .... .010 = Data Element Size: 4 bytes (2)\n                    Data Value\n                        Attribute Range: 0x0000ffff\n                            Attribute Range From: 0x0000\n                            Attribute Range To: 0xffff\n    Continuation State: no (00)\n\n> 471\t22.896191\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tSDP\t281\tRcvd Service Search Attribute Response\n---------------------------------------------------------------------------\nFrame 471: 281 bytes on wire (2248 bits), 281 bytes captured (2248 bits)\nBluetooth\nBluetooth HCI H4\nBluetooth HCI ACL Packet\nBluetooth L2CAP Protocol\nBluetooth SDP Protocol\n    PDU: Service Search Attribute Response (0x07)\n    Transaction Id: 0x0001\n    Parameter Length: 267\n    Attribute List Byte Count: 264\n    Data Fragment\n    Continuation State: no (00)\n    [Reassembled Attribute List]\n        Attribute Lists [count = 14]\n            Data Element: Sequence uint16 1269 bytes\n                0011 0... = Data Element Type: Sequence (6)\n                .... .110 = Data Element Size: uint16 (6)\n                Data Element Var Size: 1269\n                Data Value\n                    Attribute List [count =  4] (Generic Attribute Profile)\n                    Attribute List [count =  4] (Generic Access Profile)\n                    Attribute List [count =  6] (Headset Audio Gateway)\n                    Attribute List [count =  8] (Handsfree Audio Gateway)\n                    Attribute List [count =  8] (A/V Remote Control Target)\n                    Attribute List [count =  7] (Audio Source)\n                    Attribute List [count = 11] (PAN NAP)\n                    Attribute List [count =  9] (PAN PANU)\n                    Attribute List [count =  7] (Phonebook Access Server)\n                    Attribute List [count = 10] (Message Access Server)\n                    Attribute List [count =  4] (Xiaomi Inc.)\n                    Attribute List [count =  5] (CustomUUID: Unknown)\n                    Attribute List [count =  8] (OBEX Object Push)\n                    Attribute List [count =  4] (Unknown)\n```\n\n\n\n# 蓝牙电话\n\n\n## PBAP(RFCOMM/OBEX)\n\n> RFCOMM协议提供了对L2CAP协议上的串行端口的模拟。该协议基于ETSI标准GSM 07.10。\n>\n> OBEX：Object Exchange的简称，对象交换协议，来源于红外通讯协议，但又不局限于具体的传输方式，后来被蓝牙组织SIG吸纳其中部分并进行优化处理作为蓝牙协议中的OBEX层用于蓝牙设备间的文件数据传输，如蓝牙传输文件（OPP）、同步电话簿（PBAP）和同步短信（MAP）等场景下都是以OBEX协议组织相关数据进行传输的。\n\nPBAP: Phone Book Access Profile的简称，**电话本访问协议**，用于同步手机这些具有电话本功能设备上的通讯录和通话记录等。\n\nRFCOMM/OBEX和协议不属于蓝牙定义的规范 ，只是被蓝牙采纳，而PBAP协议包在OBEX协议之上封装而成。\n\n### PBAP虚拟文件夹架构\n\nPBAP中通话数据文件是在虚拟文件夹架构下，访问通话数据时需要指定路径，下图为官方架构图：\n\n![](https://s1.ax1x.com/2022/04/11/LV6yrQ.png)\n\n其中vcf的文件名称意义如下：\n\n![](https://s1.ax1x.com/2022/04/11/LV6gVs.png)\n\n### 建立连接/断开连接\n\n只使用OBEX协议\n\n#### 连接\n\n```dtd\n> 798\t23.907353\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t40\tSent Connect - Phone Book Access Profile\n---------------------------------------------------------------------------\nFrame 798: 40 bytes on wire (320 bits), 40 bytes captured (320 bits)\nBluetooth\nBluetooth HCI H4\nBluetooth HCI ACL Packet\nBluetooth L2CAP Protocol\nBluetooth RFCOMM Protocol\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: ?]\n    .000 0000 = Opcode: Connect (0x00)\n    1... .... = Final Flag: True\n    Packet Length: 26\n    [Response in Frame: 803]\n    Version: 1.0 (0x10)\n    Flags: 0x00\n    Max. Packet Length: 65534\n    Headers\n        Target: Phone Book Access Profile\n            Header Id: Target (0x46)\n            Length: 19\n            Value: 796135f0f0c511d809660800200c9a66: Phone Book Access Profile\n\n\n> 803\t23.917550\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t45\tRcvd Success - Phone Book Access Profile\n---------------------------------------------------------------------------\nFrame 803: 45 bytes on wire (360 bits), 45 bytes captured (360 bits)\nBluetooth\nBluetooth HCI H4\nBluetooth HCI ACL Packet\nBluetooth L2CAP Protocol\nBluetooth RFCOMM Protocol\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /]\n    .010 0000 = Response Code: Success (0x20)\n    1... .... = Final Flag: True\n    Packet Length: 31\n    [Request in Frame: 798]\n    Version: 1.0 (0x10)\n    Flags: 0x00\n    Max. Packet Length: 65534\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n        Who: Phone Book Access Profile\n            Header Id: Who (0x4a)\n            Length: 19\n            Value: 796135f0f0c511d809660800200c9a66: Phone Book Access Profile\n\n```\n\n#### 断开\n\n```dtd\n> 1142\t58.752933\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t22\tSent Disconnect\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /]\n    .000 0001 = Opcode: Disconnect (0x01)\n    1... .... = Final Flag: True\n    Packet Length: 8\n    [Response in Frame: 1164]\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n\n> 1164\t59.162598\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t22\tRcvd Success\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /]\n    .010 0000 = Response Code: Success (0x20)\n    1... .... = Final Flag: True\n    Packet Length: 8\n    [Request in Frame: 1142]\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n```\n\n### 设置访问虚拟文件夹路径\n\n在[PBAP协议规范]的`5.2 SetPhoneBook Function`章节，使用OBEX协议SetPath命令，通过obex.opcode=**0x05**判断。\n\n```dtd\n# $/\n> 808\t24.023528\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t27\tSent Set Path \"\"\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /]\n    .000 0101 = Opcode: Set Path (0x05)\n    1... .... = Final Flag: True\n    Packet Length: 13\n    [Response in Frame: 810]\n    Flags: 0x02\n    .... ...0 = Go back one folder (../) first: False\n    .... ..1. = Do not create folder, if not existing: True\n    Constants: 0x00\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n        Name: \"\"\n            Header Id: Name (0x01)\n            Length: 3\n            Name: \n\n> 810\t24.065127\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t22\tRcvd Success\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /]\n    .010 0000 = Response Code: Success (0x20)\n    1... .... = Final Flag: True\n    Packet Length: 8\n    [Request in Frame: 808]\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n\n# $/telecom/\n> 811\t24.078180\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t43\tSent Set Path \"telecom\"\n```\n\n\n\n### 获取通讯录数量\n\n在[PBAP协议规范]的`5.3 PullvCardListing Function`章节，通过obex.header=**<x-bt/vcard-listing>**判断。\n\n#### 手机\n\n```dtd\n> 808\t24.023528\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t27\tSent Set Path \"\"\n> 811\t24.078180\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t43\tSent Set Path \"telecom\"\n# $/telecom/pb/\n> 816\t24.118267\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t70\tSent Get final \"pb\"\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /telecom]\n    .000 0011 = Opcode: Get (0x03)\n    1... .... = Final Flag: True\n    Packet Length: 56\n    [Response in Frame: 818]\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n        Name: \"pb\"\n            Header Id: Name (0x01)\n            Length: 9\n            Name: pb\n        Type: \"x-bt/vcard-listing\"\n            Header Id: Type (0x42)\n            Length: 22\n            Type: x-bt/vcard-listing\n        Application Parameters\n            Header Id: Application Parameters (0x4c)\n            Length: 17\n            Parameter: Order #排序规则: { Alphabetical | Indexed | Phonetical }\n                Parameter Id: Order (0x01)\n                Parameter Length: 1\n                Max List Count: Indexed (0x00)\n            Parameter: Search Attribute #搜索:  {Name | Number | Sound } 与 SearchValue配合，默认为Name\n                Parameter Id: Search Attribute (0x03)\n                Parameter Length: 1\n                Search Attribute: Name (0x00)\n            Parameter: Max List Count #最大条目数\n                Parameter Id: Max List Count (0x04)\n                Parameter Length: 2\n                Max List Count: 0 (0x0000)\n            Parameter: List Start Offset #偏移量\n                Parameter Id: List Start Offset (0x05)\n                Parameter Length: 2\n                List Start Offset: 0 (0x0000)\n\n> 818\t24.332995\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t29\tRcvd Success\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /telecom]\n    .010 0000 = Response Code: Success (0x20)\n    1... .... = Final Flag: True\n    Packet Length: 15\n    [Request in Frame: 816]\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n        Application Parameters\n            Header Id: Application Parameters (0x4c)\n            Length: 7\n            Parameter: Phonebook Size\n                Parameter Id: Phonebook Size (0x08)\n                Parameter Length: 2\n                Phonebook Size: 71 (0x0047)\n```\n\n#### SIM1\n\n```dtd\n> 819\t24.336294\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t27\tSent Set Path \"\"\n> 822\t24.379640\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t27\tSent Set Path \"\"\n> 825\t24.430836\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t37\tSent Set Path \"SIM1\"\n> 828\t24.481559\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t43\tSent Set Path \"telecom\"\n# $/SIM1/telecom/pb/\n> 831\t24.532312\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t70\tSent Get final \"pb\"\n\n> 833\t24.578831\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t29\tRcvd Success\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /SIM1/telecom]\n    .010 0000 = Response Code: Success (0x20)\n    1... .... = Final Flag: True\n    Packet Length: 15\n    [Request in Frame: 831]\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n        Application Parameters\n            Header Id: Application Parameters (0x4c)\n            Length: 7\n            Parameter: Phonebook Size\n                Parameter Id: Phonebook Size (0x08)\n                Parameter Length: 2\n                Phonebook Size: 1 (0x0001)\n```\n\n### 获取通讯录\n\n在[PBAP协议规范]的`5.3 PullvCardListing Function`章节，通过obex.header=**<x-bt/phonebook>** 判断，分页获取vCard格式。\n\n#### 手机\n\n```dtd\n> 834\t24.580643\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t27\tSent Set Path \"\"\n#分页请求获取通讯录，从第1条数据开始，每页最多50条\n> 837\t24.632264\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t97\tSent Get final \"telecom/pb.vcf\"\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /]\n    .000 0011 = Opcode: Get (0x03)\n    1... .... = Final Flag: True\n    Packet Length: 83\n    [Response in Frame: 844]\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n        Name: \"telecom/pb.vcf\"\n            Header Id: Name (0x01)\n            Length: 33\n            Name: telecom/pb.vcf\n        Type: \"x-bt/phonebook\"\n            Header Id: Type (0x42)\n            Length: 18\n            Type: x-bt/phonebook\n        Application Parameters\n            Header Id: Application Parameters (0x4c)\n            Length: 24\n            Parameter: Max List Count #最大条目数,这里只读取50条\n                Parameter Id: Max List Count (0x04)\n                Parameter Length: 2\n                Max List Count: 50 (0x0032)\n            Parameter: List Start Offset #偏移量，这是从第1条开始读取\n                Parameter Id: List Start Offset (0x05)\n                Parameter Length: 2\n                List Start Offset: 1 (0x0001)\n            Parameter: Filter #用于指示所请求的vCard中包含的属性\n                Parameter Id: Filter (0x06)\n                Parameter Length: 8\n                Filter: 0x00000000\n                Filter: 0x008001af, vCard Version, Formatted Name, Structured Presentation of Name, Associated Image or Photo, Delivery Address, Telephone Number, Electronic Mail Address, Nickname\n            Parameter: Format #vCard文件格式版本，这是3.0\n                Parameter Id: Format (0x07)\n                Parameter Length: 1\n                Format: 3.0 (0x01)\n\n#传输数据片段\n> 839\t24.764415\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t1004\tRcvd OBEX fragment\n---------------------------------------------------------------------------\nFrame 839: 1004 bytes on wire (8032 bits), 1004 bytes captured (8032 bits)\nBluetooth\nBluetooth HCI H4\nBluetooth HCI ACL Packet\nBluetooth L2CAP Protocol\nBluetooth RFCOMM Protocol\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /]\n    [Reassembled OBEX in frame: 844]\n    Data (990 bytes)\n\n...\n#传输成功\n> 844\t24.794969\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t182\tRcvd Success (x-bt/phonebook)\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /]\n    [6 OBEX Fragments (5117 bytes): #839(990), #840(990), #841(990), #842(990), #843(990), #844(167)] #6个数据片段，需要拼接对应Frame\n    .010 0000 = Response Code: Success (0x20)\n    1... .... = Final Flag: True\n    Packet Length: 5117\n    [Request in Frame: 837]\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n        End Of Body\n            Header Id: End Of Body (0x49)\n            Length: 5109\n            Value: 424547494e3a56434152440d0a56455253494f4e3a332e300d0a4e3ae591a83be4baa6e6…\n    Line-based text data: x-bt/phonebook (320 lines)\n        BEGIN:VCARD\\r\\n\n        VERSION:3.0\\r\\n\n        N:张;三;;;\\r\\n\n        FN:张三\\r\\n\n        TEL;TYPE=CELL:22222222\\r\\n\n        END:VCARD\\r\\n\n        BEGIN:VCARD\\r\\n\n        VERSION:3.0\\r\\n\n        N:李四;;;;\\r\\n\n        FN:李四\\r\\n\n        TEL;TYPE=CELL:11111111\\r\\n\n        END:VCARD\\r\\n\n\n#请求获取vCard 3.0格式，并从第51条数据开始，最多50条\n> 847\t24.875858\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t96\tSent Get final \"telecom/pb.vcf\"\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /]\n    .000 0011 = Opcode: Get (0x03)\n    1... .... = Final Flag: True\n    Packet Length: 83\n    [Response in Frame: 850]\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n        Name: \"telecom/pb.vcf\"\n            Header Id: Name (0x01)\n            Length: 33\n            Name: telecom/pb.vcf\n        Type: \"x-bt/phonebook\"\n            Header Id: Type (0x42)\n            Length: 18\n            Type: x-bt/phonebook\n        Application Parameters\n            Header Id: Application Parameters (0x4c)\n            Length: 24\n            Parameter: Max List Count\n                Parameter Id: Max List Count (0x04)\n                Parameter Length: 2\n                Max List Count: 50 (0x0032)\n            Parameter: List Start Offset\n                Parameter Id: List Start Offset (0x05)\n                Parameter Length: 2\n                List Start Offset: 51 (0x0033)\n            Parameter: Filter\n                Parameter Id: Filter (0x06)\n                Parameter Length: 8\n                Filter: 0x00000000\n                Filter: 0x008001af, vCard Version, Formatted Name, Structured Presentation of Name, Associated Image or Photo, Delivery Address, Telephone Number, Electronic Mail Address, Nickname\n            Parameter: Format\n                Parameter Id: Format (0x07)\n                Parameter Length: 1\n                Format: 3.0 (0x01)\n\n> 849\t24.953425\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t1004\tRcvd OBEX fragment\n\n# 刚刚通过`Sent Get final \"pb\"`获取手机通讯录只有71条，现在只剩下21，这次就可以传输完成。\n> 850\t24.960363\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t940\tRcvd Success (x-bt/phonebook)\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /]\n    [2 OBEX Fragments (1915 bytes): #849(990), #850(925)]\n    .010 0000 = Response Code: Success (0x20)\n    1... .... = Final Flag: True\n    Packet Length: 1915\n    [Request in Frame: 847]\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n        End Of Body\n            Header Id: End Of Body (0x49)\n            Length: 1907\n            Value: 424547494e3a56434152440d0a56455253494f4e3a332e300d0a4e3ae4bd993be4bf8ae7…\n    Line-based text data: x-bt/phonebook (122 lines)\n        BEGIN:VCARD\\r\\n\n        VERSION:3.0\\r\\n\n        N:张;三;;;\\r\\n\n        FN:张三\\r\\n\n        TEL;TYPE=CELL:22222222\\r\\n\n        END:VCARD\\r\\n\n        BEGIN:VCARD\\r\\n\n        VERSION:3.0\\r\\n\n        N:李四;;;;\\r\\n\n        FN:李四\\r\\n\n        TEL;TYPE=CELL:11111111\\r\\n\n        END:VCARD\\r\\n\n```\n\n#### SIM1\n\n```dtd\n> 866\t25.021131\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t107\tSent Get final \"SIM1/telecom/pb.vcf\"\n#这里手机直接拒绝了\n> 868\t25.032728\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t25\tRcvd Success\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /]\n    .010 0000 = Response Code: Success (0x20)\n    1... .... = Final Flag: True\n    Packet Length: 11\n    [Request in Frame: 866]\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n        End Of Body\n            Header Id: End Of Body (0x49)\n            Length: 3\n            Value: <MISSING>\n```\n\n\n\n### 获取通话记录\n\n在[PBAP协议规范]的`5.3 PullvCardListing Function`章节，通过obex.header=**<x-bt/phonebook>** 判断，分页获取vCard格式。\n\n```dtd\n> 869\t25.071027\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t27\tSent Set Path \"\"\n> 882\t25.125323\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t43\tSent Set Path \"telecom\"\n# $/telecom/cch/\n> 887\t25.138796\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t72\tSent Get final \"cch\"\n> 895\t25.222650\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t29\tRcvd Success\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /telecom]\n    .010 0000 = Response Code: Success (0x20)\n    1... .... = Final Flag: True\n    Packet Length: 15\n    [Request in Frame: 887]\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n        Application Parameters\n            Header Id: Application Parameters (0x4c)\n            Length: 7\n            Parameter: Phonebook Size\n                Parameter Id: Phonebook Size (0x08)\n                Parameter Length: 2\n                Phonebook Size: 2177 (0x0881)\n\n> 897\t25.225643\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t27\tSent Set Path \"\"\n#分页获取通话记录，从第0条开始，每页最多50条\n> 919\t25.279427\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t85\tSent Get final \"telecom/cch.vcf\"\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /]\n    .000 0011 = Opcode: Get (0x03)\n    1... .... = Final Flag: True\n    Packet Length: 71\n    [Response in Frame: 935]\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n        Name: \"telecom/cch.vcf\"\n            Header Id: Name (0x01)\n            Length: 35\n            Name: telecom/cch.vcf\n        Type: \"x-bt/phonebook\"\n            Header Id: Type (0x42)\n            Length: 18\n            Type: x-bt/phonebook\n        Application Parameters\n            Header Id: Application Parameters (0x4c)\n            Length: 10\n            Parameter: Max List Count\n                Parameter Id: Max List Count (0x04)\n                Parameter Length: 2\n                Max List Count: 50 (0x0032)\n            Parameter: Format\n                Parameter Id: Format (0x07)\n                Parameter Length: 1\n                Format: 3.0 (0x01)\n> 935\t25.381127\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t132\tRcvd Success (x-bt/phonebook)\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /]\n    [8 OBEX Fragments (7048 bytes): #926(990), #927(990), #928(990), #929(990), #930(990), #931(990), #934(990), #935(118)]\n    .010 0000 = Response Code: Success (0x20)\n    1... .... = Final Flag: True\n    Packet Length: 7048\n    [Request in Frame: 919]\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n        End Of Body\n            Header Id: End Of Body (0x49)\n            Length: 7040\n            Value: 424547494e3a56434152440d0a56455253494f4e3a332e300d0a464e3a0d0a4e3a0d0a54…\n    Line-based text data: x-bt/phonebook (350 lines)\n        BEGIN:VCARD\\r\\n\n        VERSION:3.0\\r\\n\n        FN:\\r\\n\n        N:\\r\\n\n        TEL;TYPE=0:10086\\r\\n\n        X-IRMC-CALL-DATETIME;TYPE=DIALED:20220317T161710\\r\\n\n        END:VCARD\\r\\n\n        BEGIN:VCARD\\r\\n\n        VERSION:3.0\\r\\n\n        FN:\\r\\n\n        N:\\r\\n\n        TEL;TYPE=0:02310050\\r\\n\n        X-IRMC-CALL-DATETIME;TYPE=MISSED:20220316T160142\\r\\n\n        END:VCARD\\r\\n\n\n#分页获取通话记录，从第50条开始，每页最多50条\n936\t25.423573\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t89\tSent Get final \"telecom/cch.vcf\"\n---------------------------------------------------------------------------\nOBEX Protocol\n    [Profile: PBAP (4)]\n    [Current Path: /]\n    .000 0011 = Opcode: Get (0x03)\n    1... .... = Final Flag: True\n    Packet Length: 75\n    [Response in Frame: 947]\n    Headers\n        Connection Id: 1\n            Header Id: Connection Id (0xcb)\n            Connection ID: 1\n        Name: \"telecom/cch.vcf\"\n            Header Id: Name (0x01)\n            Length: 35\n            Name: telecom/cch.vcf\n        Type: \"x-bt/phonebook\"\n            Header Id: Type (0x42)\n            Length: 18\n            Type: x-bt/phonebook\n        Application Parameters\n            Header Id: Application Parameters (0x4c)\n            Length: 14\n            Parameter: Max List Count\n                Parameter Id: Max List Count (0x04)\n                Parameter Length: 2\n                Max List Count: 50 (0x0032)\n            Parameter: List Start Offset\n                Parameter Id: List Start Offset (0x05)\n                Parameter Length: 2\n                List Start Offset: 50 (0x0032)\n            Parameter: Format\n                Parameter Id: Format (0x07)\n                Parameter Length: 1\n                Format: 3.0 (0x01)\n> 947\t25.516478\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t810\tRcvd Success (x-bt/phonebook)\n```\n\n## HFP(RFCOMM)\n\n> HFP(Hands-free Profile)，让蓝牙设备可以控制电话，如接听、挂断、拒接、语音拨号等，拒接、语音拨号要视蓝牙耳机及电话是否支持。\n>\n> 目前HFP的使用场景有车载蓝牙，耳机和PDA，定义了AG和HFP两种角色。\n> AG（Audio Gate）音频网关—音频设备输入输出网关\n> HF（Hands Free）免提—该设备作为音频网关的远程音频输入/输出机制，并可提供若干遥控功能。\n\n在车载蓝牙中，**手机侧是AG**，**车载蓝牙侧是HF**，在android源代码中，将AG侧称为HFP/AG，将HF侧称为HFPClient/HF。\n\n### AT命令\n\n在HFP使用AT命令控制电话，其参考3GPP 27.007标准，命令规范为：\n\n- 每个命令行只有一个命令\n\n- AG侧默认不回显命令\n\n- AG使用冗长的格式返回结果\n\n- 以下字符将被用于AT命令和返回结果格式中\n\n  - `<cr>` 表示回车，也就是`\\r`字符\n\n  - ` <lf>`表示换行，也就是`\\n`字符\n\n- 从HF发送到AG的命令格式是：`<AT command> <cr>`\n\n- 从AG返回给HF的OK命令格式是：`<cr><lf>OK<cr><lf>`\n\n- 从AG到HF的ERROR命令是：`<cr><lf>ERROR<cr><lf>`\n\n- 从AG到HF的结果命令格式是：`<cr><lf><result code><cr><lf>`\n\nHFP协议复用的AT命令：\n\n- ATA：标准电话应答AT命令\n- ATDdd...dd;：用电话号码打电话\n- ATD>nnn...;：ATD扩展命令，记忆拨号\n- ERROR：错误指示符，语法，格式或者通信过程出错。\n- OK：命令的成功应答。\n- NO CARRIER, BUSY, NO ANSWER, DELAYED, BLACKLISTED：AT扩展命令，AG返回给HF。\n- RING：来电\n- AT+CCWA：calling waiting notification AT命令。AT+CCWA=`[<n>[,<mode>[,<class>]]]`，\n- +CCWA：Call Waiting notification返回结果码。只有`<number>`和`<type>`参数对HFP有意义，`<number>`是由双引号及其中的文本串组成。`<type>`是支持的电话格式，有如下值：\n  - 128~143：国家或国际格式，\n  - 144~159：国际电话，包括国家码前缀。\n  - 160-175:国家码\n  - AT+CHLD：通话保持，多方处理。AT+CHLD=`<n>`中`<n>`值覆盖0, 1, 1`<idx>`, 2, 2`<idx>`, 3 and 4,说明：\n    - 0：释放所有保持电话或者设置用户的忙等待\n    - 1：释放正在通话的电话，接听保持或等待的电话\n    - 1`<idx>`:释放`<idx>`标识的电话\n    - 2：将所有活跃电话设置成保持并且接受其它电话。\n    - 2`<idx>`:请求接受`<idx>`标识电话，让其它电话保持。\n    - 3：增加一个保持电话到对话中\n    - 4：连接连个电话并且断开两个电话的订阅。HF侧可选。\n  \n  - AT+CHLD=?：查询AG侧保持和多方会话。\n- AT+CHUP：标准的挂断命令。AG会结束通话，也可用于拒接来电。\n- AT+CIND：`AT+CIND?`获取AG indicators当前的状态,`AT+CIND=?获取AG支持的indicator以及它们的次序。\n  - service: Service availability indication:\n    - `<value>=0` implies no service. No Home/Roam network available.\n    - `<value>=1` implies presence of service. Home/Roam network available.  \n  - call: Standard call status indicator:  \n    - `<value>=0 `means there are no calls in progress  \n    - `<value>=1` means at least one call is in progress  \n  - callsetup: Bluetooth proprietary call set up status indicator4. Support for this indicator is optional\n    for the HF. When supported, this indicator shall be used in conjunction with, and as an extension\n    of the standard call indicator. Possible values are as follows:  \n    - `<value>=0` means not currently in call set up.  \n    - `<value>=1` means an incoming call process ongoing.\n    - `<value>=2` means an outgoing call set up is ongoing.  \n    - `<value>=3` means remote party being alerted in an outgoing call.  \n  - callheld: Bluetooth proprietary call hold status indicator. Support for this indicator is mandatory for\n    the AG, optional for the HF. Possible values are as follows:  \n    - 0= No calls held  \n    - 1= Call is placed on hold or active/held calls swapped\n      (The AG has both an active AND a held call)  \n    - Call on hold, no active call  \n  - signal: Signal Strength indicator:  \n    - `<value>= `ranges from 0 to 5  \n  - roam: Roaming status indicator:  \n    - `<value>=0` means roaming is not active  \n    - `<value>=1` means a roaming is active  \n  - battchg: Battery Charge indicator of AG:  \n    - `<value>=`ranges from 0 to 5  \n- +CIND：当前indicator的列表\n- AT+CLCC：列出当前电话命令，\n- +CLCC：当前call结果码，支持参数是\n\n  - idx：表示建立连接顺序或者接听电话的数字（从1开始）。\n  - dir：0（outgoing），1（incoming）\n  - status：\n\n    - 0=Active\n\n    - 1=Held\n\n    - 2=Dialing（outgoing calls only）\n\n    - 3=Alerting(outgoing calls only)\n\n    - 4=Incoming(incoming calls only)\n\n    - 5=Waiting(incoming calls only)\n\n    - 6 = Call held by Response and Hold\n  - mode= 0 (Voice), 1 (Data), 2 (FAX)\n  - mpty=\n    - 0 - this call is NOT a member of a multi-party (conference) call\n    - 1 - this call IS a member of a multi-party (conference) call\n  - number (optional)\n  - type (optional)\n- AT+COPS: AT+COPS=3,0将被HF发送给AG\n- AT+CMEE: 使能+CME ERROR: <err>结果码\n- +CME ERROR\n  - +CME ERROR: 0 – AG failure\n- AT+CLIP: Calling Line Identification notification 使能命令，It enables/disables the Calling Line Identification notification unsolicited result code 。\n- +CLIP : Standard “Calling Line Identification notification” unsolicited result code.  \n- AT+CMER :Standard event reporting activation/deactivation AT command.  \n- +CIEV: “indicator events reporting”结果码。`<ind>`,`<value>` result code ，对应AT+CIND 返回的列表中的参数和值。\n- AT+VTS: DTMF生成命令。\n- AT+CNUM: HF相应`+CNUM`命令\n  - AT+CNUM (Retrieve Subscriber Number Information)\n  - AT+CNUM=? (Test Subscriber Number Information – Not Implemented)\n- +CNUM:  用于将“ Subscriber Number Information ”从AG发送到HF的标准响应。\n\nHFP协议扩展的AT命令：\n\n- AT+BIA (Bluetooth Indicators Activation)  \n- AT+BINP (Bluetooth INPut)  \n- AT+BLDN (Bluetooth Last Dialed Number)  \n- AT+BVRA (Bluetooth Voice Recognition Activation)  \n- +BVRA (Bluetooth Voice Recognition Activation)  \n- AT+BRSF (Bluetooth Retrieve Supported Features)  \n- +BRSF (Bluetooth Retrieve Supported Features)   \n- AT+NREC (Noise Reduction and Echo Canceling)  \n- AT+VGM (Gain of Microphone)  \n- AT+VGS (Gain of Speaker)  \n- +VGM (Gain of Microphone)  \n- +VGS (Gain of Speaker)  \n- +BSIR (Bluetooth Setting of In-band Ring tone)  \n- AT+BTRH (Bluetooth Response and Hold Feature)  \n- +BTRH (Bluetooth Response and Hold Feature)  \n- AT+BCC (Bluetooth Codec Connection)  \n- AT+BCS (Bluetooth Codec Selection)  \n- +BCS (Bluetooth Codec Selection)  \n- AT+BAC (Bluetooth Available Codecs)  \n- AT+BIND (Bluetooth HF Indicators Feature)  \n- +BIND (Bluetooth HF Indicators Feature)  \n- AT+BIEV (Bluetooth HF Indicators Feature)\n\n### 建立服务连接\n\n> Upon a user action or an internal event, either the HF or the AG may initiate a **Service Level Connection**\n> **establishment** procedure.\n> A Service Level Connection establishment requires the existence of a RFCOMM connection, that is, a\n> RFCOMM data link channel between the HF and the AG.\n> Both the HF and the AG may initiate the RFCOMM connection establishment. If there is no RFCOMM\n> session between the AG and the HF, the initiating device shall first initialize RFCOMM.  \n\n连接过程如下：\n\n![](https://s1.ax1x.com/2022/04/11/LV6DxS.png)\n\n1. 支持能力交换\n   首先HF发送AT+BRSF=< HF supported features >给AG，目的是首先通知AG其具有的能力，其次接收AG返回的其自身的BRSF能力。\n   \n2. Codec协商\n   如果HF支持Codec Negotiation特征，其会查看AG返回的BRSF中是否也支持该特性，如果都支持该特性，则HF将发送AT+BAC=< HF available codecs >命令给AG以告知其可用的codec。\n   \n3. AG Indicator\n   HF从AG接收到的BRSF，可以知道AG支持的Indicator，并按顺序拍好，这是因为根据3GPP 27.007规范，AG可以支持Hands-Free不支持的profile。HF使用AT+CIND=?测试命令接收AG支持的indicator以及它们的次序。\n   当HF获得必须的Indicator和它们的次序，它将通过AT+CIND?命令取得AG端正在使用indicator的状态。\n   当HF取得AG的indicator后，HF会使用AT+CMER使能AG的indicator状态跟新功能，AG会返回OK作为应答。当service，call或者call建立状态发生时，AG将发送和indicator相关的+CIEV结果码给HF。HF根据收到的+CIEV码来跟新其自身内部的indicator。\n   AG侧会一直保持indicator状态跟新功能使能直到收到AT+CMER指示其关闭或者HF和AG端的Service Level Connection连接断开。\n   当HF使能AG的indicator状态跟新，如果AG和HF都支持呼叫等待（Call waiting）和3方通信（3-way calling）。HF将发送AT+CHLD=?测试命令取得AG是如何支持这种功能的。如果HF或者AG其中之一不支持三方通信，AT+CHLD=?命令不会被发送。\n   \n4. HF Indicator\n   如果HF支持HF indicator，其会查看AG是否支持HF indicator。\n   如果HF和AG支持HF indicator特性，HF将发送AT+BIND=< HF supported HF indicators >通知HF侧支持的indicator，AG以OK应答。\n   当AG接收到HF告知的HF indicator特性，HF将发送AT+BIND=?请求AG侧支持的HF indicator。AG将会以+BIND和以OK结尾的应答。\n   当HF接收到AG支持的HF indicator，HF将会发送AT+BIND?命令确定HF目前使能的HF indicator。AG将会一次或多次以+BIND应答和以OK结尾的应答。\n   至此HF可能发送AT+BIEV命令告知AG其使能的HF indicator发生变化。\n   AG可以使用+BIND使能或者禁止任何HF indicator。\n   \n5. End of Service Level Connection\n   - HF需要知道Service Level Connection被完全建立，这可以通过以下几个方式：\n     - 当且仅当AG通过+BRSF命令告知HF其支持的`\"HF indicator\"`，在HF收到AG通过**AT+BIND？**命令发来的其支持的`\"HF indicator\"`可认为完全建立。\n     - 当且仅当SDP服务发现AH和AG双方均支持`\"Call waiting and 3-way calling\"`，在HFAG通过**AT+CHLD**命令发来的其对呼叫等待和多方电话的支持，对这种情况，`\"HF indicator\"`不要设置该比特位，AG也不要在+BRSF命令中设置该比特位。\n     - 在HF使用**AT+CMER**命令成功启用`“Indicator status update”`功能，对这种情况SDP服务不应该设置`“Call waiting and 3-way calling”`比特位。\n       如果HF收到AG通过indicator指示当前有电话时，HF查询AG的接听和保持状态来判断是否是未接听电话。\n     \n   - 同样AG侧Service Level Connection完全建立也有几种情况：\n     - 当且仅当HF indicator在HF被设置且AG侧支持的indicator已经通过+BRSF命令应答，则AG以**+BIND加OK结尾**的命令应答其使能的HF indicator时可认为Service Level Connection完全建立。\n     \n     - 当且仅当`“Call waiting and 3-way calling”`比特在HF和AG的SDP服务中被置位，在AG通过**+CHLD加OK结尾**命令成功响应其对呼叫保持和多方电话支持时SLC会被完全建立。对这种情况，+BRSF不应该设置该HF indicator比特位。\n     \n     - AG已成功**响应OK到AT + CMER**命令（启用`“Indicator status update”`功能。）当`“Call waiting and 3-way calling”`位时，应适用这种情况未在支持的功能位图中设置为HF或AG，以及`“HF Indicators ”`对于通过+ BRSF交换的HF或AG的支持功能位图中未设置位的位图命令。\n     \n\n```dtd\n#判断是否支持\"Call waiting and 3-way calling\"\n#AG发现HF, hfP支持的协议,HF支持\"Call waiting and 3-way calling\"\n> 596\t17.850811\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tSDP\t36\tRcvd Service Search Attribute Request : Handsfree: [Service Class ID List 0x0001] [Protocol Descriptor List 0x0004] [Bluetooth Profile Descriptor List 0x0009] [(HFP HS) Supported Features 0x0311] \n> 597\t17.851437\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tSDP\t69\tSent Service Search Attribute Response \n---------------------------------------------------------------------------\nBluetooth SDP Protocol\n    PDU: Service Search Attribute Response (0x07)\n    Transaction Id: 0x0000\n    Parameter Length: 55\n    Attribute List Byte Count: 52\n    Attribute Lists [count =  1]\n        Data Element: Sequence uint8 50 bytes\n            0011 0... = Data Element Type: Sequence (6)\n            .... .101 = Data Element Size: uint8 (5)\n            Data Element Var Size: 50\n            Data Value\n                Attribute List [count =  4] (Handsfree)\n                    Data Element: Sequence uint16 47 bytes\n                        0011 0... = Data Element Type: Sequence (6)\n                        .... .110 = Data Element Size: uint16 (6)\n                        Data Element Var Size: 47\n                        Data Value\n                            Service Attribute: Service Class ID List (0x1), value = Handsfree -> Generic Audio\n                            Service Attribute: Protocol Descriptor List (0x4), value = L2CAP -> RFCOMM:2\n                            Service Attribute: Bluetooth Profile Descriptor List (0x9), value = Handsfree 1.6\n                            Service Attribute: (HFP HS) Supported Features (0x311), value = (EC and/or Nr Function) (Call Waiting or Three Way Calling) (CLI Presentation Capability) (Voice Recognition Activation) (Remote Volume Control) (Wide Band Speech) \n    Continuation State: no (00)\n\n#HF发现AG, hfP支持的协议,AG不支持\"Call waiting and 3-way calling\"，只支持\"3-way calling\"\n> 637\t18.017460\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tSDP\t33\tSent Service Search Attribute Request : Handsfree Audio Gateway: [Service Class ID List 0x0001] [Bluetooth Profile Descriptor List 0x0009] [(HFP AG) Supported Features 0x0311] \n> 644\t18.024689\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tSDP\t52\tRcvd Service Search Attribute Response \n---------------------------------------------------------------------------\nBluetooth SDP Protocol\n    PDU: Service Search Attribute Response (0x07)\n    Transaction Id: 0x0000\n    Parameter Length: 38\n    Attribute List Byte Count: 35\n    Attribute Lists [count =  1]\n        Data Element: Sequence uint8 33 bytes\n            0011 0... = Data Element Type: Sequence (6)\n            .... .101 = Data Element Size: uint8 (5)\n            Data Element Var Size: 33\n            Data Value\n                Attribute List [count =  3] (Handsfree Audio Gateway)\n                    Data Element: Sequence uint16 30 bytes\n                        0011 0... = Data Element Type: Sequence (6)\n                        .... .110 = Data Element Size: uint16 (6)\n                        Data Element Var Size: 30\n                        Data Value\n                            Service Attribute: Service Class ID List (0x1), value = Handsfree Audio Gateway -> Generic Audio\n                            Service Attribute: Bluetooth Profile Descriptor List (0x9), value = Handsfree 1.6\n                            Service Attribute: (HFP AG) Supported Features (0x311), value = (Three Way Calling) (EC and/or Nr Function) (Voice Recognition Function) (Wide Band Speech) \n    Continuation State: no (00)\n\n#HFP建立连接\n#交换支持功能，AG和HF都不支持\"HF indicator\"\n> 634\t18.012482\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t26\tSent AT+BRSF=255\n---------------------------------------------------------------------------\nBluetooth HFP Profile\n    [Role: HS - Headset (2)]\n    AT Stream: AT+BRSF=255\\r\n    Command 0: +BRSF\n        Command Line Prefix: AT\n        Command: +BRSF (Bluetooth Retrieve Supported Features)\n        Type: Action Command (0x003d)\n        Parameters\n            HS supported features bitmask: 255\n                .... .... .... .... .... .... .... ...1 = EC and/or NR function: True\n                .... .... .... .... .... .... .... ..1. = Call waiting or 3-way calling: True\n                .... .... .... .... .... .... .... .1.. = CLI Presentation: True\n                .... .... .... .... .... .... .... 1... = Voice Recognition Activation: True\n                .... .... .... .... .... .... ...1 .... = Remote Volume Control: True\n                .... .... .... .... .... .... ..1. .... = Enhanced Call Status: True\n                .... .... .... .... .... .... .1.. .... = Enhanced Call Control: True\n                .... .... .... .... .... .... 1... .... = Codec Negotiation: True\n                .... .... .... .... .... ...0 .... .... = HF Indicators: False\n                .... .... .... .... .... ..0. .... .... = eSCO S4 (and T2) Settings Support: False\n                0000 0000 0000 0000 0000 00.. .... .... = Reserved: 0x000000\n> 641\t18.022446\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t28\tRcvd   +BRSF: 871\n---------------------------------------------------------------------------\nBluetooth HFP Profile\n    [Role: AG - Audio Gate (1)]\n    AT Stream: \\r\\n+BRSF: 871\\r\\n\n    Command 0: +BRSF\n        Command: +BRSF (Bluetooth Retrieve Supported Features)\n        Type: Response (0x003a)\n        Parameters\n            AG supported features bitmask: 871\n                .... .... .... .... .... .... .... ...1 = Three Way Calling: True\n                .... .... .... .... .... .... .... ..1. = EC and/or NR function: True\n                .... .... .... .... .... .... .... .1.. = Voice Recognition Function: True\n                .... .... .... .... .... .... .... 0... = In-band Ring Tone: False\n                .... .... .... .... .... .... ...0 .... = Attach Number to Voice Tag: False\n                .... .... .... .... .... .... ..1. .... = Ability to Reject a Call: True\n                .... .... .... .... .... .... .1.. .... = Enhanced Call Status: True\n                .... .... .... .... .... .... 0... .... = Enhanced Call Control: False\n                .... .... .... .... .... ...1 .... .... = Extended Error Result Codes: True\n                .... .... .... .... .... ..1. .... .... = Codec Negotiation: True\n                .... .... .... .... .... .0.. .... .... = HF Indicators: False\n                .... .... .... .... .... 0... .... .... = eSCO S4 (and T2) Settings Support: False\n                0000 0000 0000 0000 0000 .... .... .... = Reserved: 0x00000\n\n#AG和HF都支持\"Codec Negotiation\"，HF告知AG其可用的Codec编码(CVSD)\n> 643\t18.023696\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t23\tSent AT+BAC=1\n---------------------------------------------------------------------------\nBluetooth HFP Profile\n    [Role: HS - Headset (2)]\n    AT Stream: AT+BAC=1\\r\n    Command 0: +BAC\n        Command Line Prefix: AT\n        Command: +BAC (Bluetooth Available Codecs)\n        Type: Action Command (0x003d)\n        Parameters\n            Codec: CVSD (1)\n\n#获取AG支持的indicator以及它们的次序\n> 649\t18.029340\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t24\tSent AT+CIND=? \n> 652\t18.035680\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t147\tRcvd   +CIND: (\"CALL\",(0,1)),(\"CALLSETUP\",(0-3)),(\"SERVICE\",(0-1)),(\"SIGNAL\",(0-5)),(\"ROAM\",(0,1)),(\"BATTCHG\",(0-5)),(\"CALLHELD\",(0-2)) \n\n#获取AG indicators当前的状态\n> 654\t18.037547\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t23\tSent AT+CIND? \n> 656\t18.092460\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t38\tRcvd   +CIND: 0,0,1,5,0,2,0\n\n#标志HFP连接建立\n#启用\"Indicator status update\"\n> 658\t18.093591\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t30\tSent AT+CMER=3,0,0,1\n> 660\t18.117156\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t20\tRcvd   OK  \n```\n\n### HF拨打\\挂断电话\n\n```dtd\n#HF拨打电话\n> 921\t29.433324\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t24\tSent ATD10086; \n---------------------------------------------------------------------------\nBluetooth HFP Profile\n    [Role: HS - Headset (2)]\n    AT Stream: ATD10086;\\r\n    Command 0: D\n        Command Line Prefix: AT\n        Command: D (Dial)\n        [Expert Info (Warning/Protocol): Non mandatory type or command in this role]\n        Parameters: No\n> 924\t30.778650\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t20\tRcvd   OK\n\n#挂断电话\n> 965\t37.723080\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t22\tSent AT+CHUP\n> 966\t37.752000\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t20\tRcvd   OK\n```\n\n### HF获取通话电话列表\n\n会HF会轮询此命令\n\n```dtd\n> 925\t30.779082\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t22\tSent AT+CLCC \n> 929\t30.820871\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t46\tRcvd   +CLCC: 1,0,2,0,0,\"10086\",129 \n---------------------------------------------------------------------------\nBluetooth HFP Profile\n    [Role: AG - Audio Gate (1)]\n    AT Stream: \\r\\n+CLCC: 1,0,2,0,0,\"10086\",129\\r\\n\n    Command 0: +CLCC\n        Command: +CLCC (Current Calls)\n        Type: Response (0x003a)\n        Parameters\n            ID: 1\n            Direction: Mobile Originated (0)\n            State: Dialing (2)\n            Mode: Voice (0)\n            Mpty: Call is not one of multiparty (conference) call parties (0)\n            Number: \"10086\"\n            Type: The phone number format may be a national or international format, and may contain prefix and/or escape digits. No changes on the number presentation are required. (129)\n```\n\n### AG下发通话状态\n\n在开启`\"Indicator status update\"`(AT+CMER)之后，AG会主动下发当前的通话状态，`Indicator Index`对应+CIND返回的参数列表，`Indicator <idx>`对应其值。\n\n#### 拨打电话\n\n```dtd\n#CALLSETUP=2,拨号中\n> 1056\t66.689969\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t27\tRcvd   +CIEV: 2,2  \n```\n\n#### 无通话或者挂断\n\n```dtd\n#CALL=0,无通话\n1106\t74.975552\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t27\tRcvd   +CIEV: 1,0  \n```\n\n#### 来电\n\n```dtd\n#CALLSETUP=1,来电中\n> 1056\t66.689969\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t27\tRcvd   +CIEV: 2,1 \n```\n### 建立SCO/eSCO连接\n\n蓝牙电话的音频数据由SCO/eSCO协议传输，在HCI中无数据相关的日志。\n\n```dtd\n#HF选择编解码格式\n> 900\t387.320548\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tHFP\t24\tRcvd   +BCS: 1  \n---------------------------------------------------------------------------\nBluetooth HFP Profile\n    [Role: AG - Audio Gate (1)]\n    AT Stream: \\r\\n+BCS: 1\\r\\n\n    Command 0: +BCS\n        Command: +BCS (Bluetooth Codec Selection)\n        Type: Response (0x003a)\n        Parameters\n            Codec: CVSD (1)\n> 903\t387.380459\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t23\tSent AT+BCS=1 \n---------------------------------------------------------------------------\nBluetooth HFP Profile\n    [Role: HS - Headset (2)]\n    AT Stream: AT+BCS=1\\r\n    Command 0: +BCS\n        Command Line Prefix: AT\n        Command: +BCS (Bluetooth Codec Selection)\n        Type: Action Command (0x003d)\n        Parameters\n            Codec: CVSD (1)\n\n#AG请求建立eSCO连接\n> 906\t387.530834\tcontroller\thost\tHCI_EVT\t13\tRcvd Connect Request\n---------------------------------------------------------------------------\nBluetooth HCI Event - Connect Request\n    Event Code: Connect Request (0x04)\n    Parameter Total Length: 10\n    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n    Class of Device: 0x001f00 (Uncategorized: device code not specified:Unknown - services:)\n    Link Type: eSCO connection (Voice Channels) (0x02)\n\n#HF允许建立eSCO连接\n> 907\t387.531078\thost\tcontroller\tHCI_CMD\t67\tSent Enhanced Accept Synchronous Connection Request\n---------------------------------------------------------------------------\nBluetooth HCI Command - Enhanced Accept Synchronous Connection Request\n    Command Opcode: Enhanced Accept Synchronous Connection Request (0x043e)\n        0000 01.. .... .... = Opcode Group Field: Link Control Commands (0x01)\n        .... ..00 0011 1110 = Opcode Command Field: Enhanced Accept Synchronous Connection Request (0x03e)\n    Parameter Total Length: 63\n    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n    Tx Bandwidth (bytes/s): 8000\n    Rx Bandwidth (bytes/s): 8000\n    Transmit Coding Format\n    Receive Coding Format\n    Transmit Codec Frame Size: 60\n    Receive Codec Frame Size: 60\n    Input Bandwidth: 16000\n    Output Bandwidth: 16000\n    Input Coding Format\n    Output Coding Format\n    Input Coded Data Size: 16\n    Output Coded Data Size: 16\n    Input PCM Data Format: 2's complement (0x02)\n    Output PCM Data Format: 2's complement (0x02)\n    Input PCM Sample Payload MSB Position: 0\n    Output PCM Sample Payload MSB Position: 0\n    Input Data Path: Vendor Specific\n    Output Data Path: Vendor Specific\n    Input Transport Unit Size: 16\n    Output Transport Unit Size: 16\n    Max. Latency (ms): 12\n    Packet Type: 0x03bf, 3-EV5 may NOT be used, 2-EV5 may NOT be used, 3-EV3 may NOT be used, EV5 may be used, EV4 may be used, EV3 may be used, HV3 may be used, HV2 may be used, HV1 may be used\n    Retransmission Effort: At least 1 retransmission, optimize for link quality (2)\n    [Pending in frame: 909]\n    [Command-Pending Delta: 1.38ms]\n    [Response in frame: 910]\n    [Command-Response Delta: 3.862ms]\n\n#eSCO连接成功\n> 910\t387.534940\tcontroller\thost\tHCI_EVT\t20\tRcvd Synchronous Connection Complete\n---------------------------------------------------------------------------\nBluetooth HCI Event - Synchronous Connection Complete\n    Event Code: Synchronous Connection Complete (0x2c)\n    Parameter Total Length: 17\n    Status: Success (0x00)\n    Connection Handle: 0x0e00\n    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)\n    Link Type: eSCO connection (0x02)\n    Transmit Interval: 12 slots (7.5 msec)\n    Retransmit Window: 2 slots (1.25 msec)\n    Rx Packet Length: 60\n    Tx Packet Length: 60\n    Air Mode: CVSD (2)\n    [Command in frame: 907]\n    [Pending in frame: 909]\n    [Pending-Response Delta: 2.482ms]\n    [Command-Response Delta: 3.862ms]\n```\n\n# 蓝牙音乐\n\n## AVDTP\n\n**AVDTP：AUDIO/VIDEO DISTRIBUTION TRANSPORT PROTOCOL(音视频分配传输协议)** ，用于音乐数据流的建立与传输控制。\n\n### 建立连接\n\n```dtd\n> 458\t11.574257\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tL2CAP\t17\tSent Connection Request (AVDTP, SCID: 0x0042)\n```\n\n### 数据流传输\n\n数据流的生命状态：\n\n![](https://s1.ax1x.com/2022/04/11/LV6NVA.png)\n\n#### 查找(Idle)\n\n```dtd\n#查询AG的所有音源\n> 468\t11.652772\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tAVDTP\t11\tSent Command - Discover\n> 469\t11.722467\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tAVDTP\t15\tRcvd ResponseAccept - Discover - items: 2\n---------------------------------------------------------------------------\nBluetooth AVDTP Protocol\n    Signal: Discover (ResponseAccept)\n    ACP SEP [1 - Audio Source] item 1/2\n        0000 01.. = SEID: 1\n        .... ..0. = In Use: False (0x0)\n        .... ...0 = RFA0: 0x0\n        0000 .... = Media Type: Audio (0x0)\n        .... 0... = Type: Source (0x0)\n        .... .000 = RFA1: 0x0\n    ACP SEP [2 - Audio Source] item 2/2\n        0000 10.. = SEID: 2\n        .... ..0. = In Use: False (0x0)\n        .... ...0 = RFA0: 0x0\n        0000 .... = Media Type: Audio (0x0)\n        .... 0... = Type: Source (0x0)\n        .... .000 = RFA1: 0x0\n\n#获取音源详细信息\n> 470\t11.722896\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tAVDTP\t12\tSent Command - GetAllCapabilities - ACP SEID [1 - Audio Source]\n> 473\t11.728705\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tAVDTP\t23\tRcvd ResponseAccept - GetAllCapabilities - Audio SBC (44100 | Mono JointStereo | block: 4 8 12 16 | subbands: 8 | allocation: Loudness | bitpool: 2..53)\n> 474\t11.728960\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tAVDTP\t12\tSent Command - GetAllCapabilities - ACP SEID [2 - Audio Source]\n> 476\t11.734811\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tAVDTP\t25\tRcvd ResponseAccept - GetAllCapabilities - Audio MPEG-2,4 AAC\n---------------------------------------------------------------------------\nBluetooth AVDTP Protocol\n    Signal: GetAllCapabilities (ResponseAccept)\n        0010 .... = Transaction: 0x2\n        .... 00.. = Packet Type: Single (0x0)\n        .... ..10 = Message Type: ResponseAccept (0x2)\n        00.. .... = RFA: 0x0\n        ..00 1100 = Signal: GetAllCapabilities (0x0c)\n    Capabilities\n        Service: Media Transport\n        Service: Media Codec - Audio MPEG-2,4 AAC\n        Service: Delay Reporting\n```\n\n#### 设置/打开(Configured/Open)\n\n```dtd\n#选择对应音源\n> 477\t11.735508\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tAVDTP\t25\tSent Command - SetConfiguration - ACP SEID [2 - Audio Source] - INT SEID [2 - Audio Source] - Audio MPEG-2,4 AAC\n> 479\t11.742210\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tAVDTP\t11\tRcvd ResponseAccept - SetConfiguration\n\n#打开音源\n> 480\t11.742538\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tAVDTP\t12\tSent Command - Open - ACP SEID [2 - Audio Source]\n---------------------------------------------------------------------------\nBluetooth AVDTP Protocol\n    Signal: Open (Command)\n    ACP SEID [2 - Audio Source]\n> 485\t11.747312\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tAVDTP\t11\tRcvd ResponseAccept - Open\n```\n\n#### 开始传输(Streaming)\n\n```dtd\n> 601\t28.945727\tXiaomiCo_f2:31:c7 (PHONE)\tSANYOEle_71:7b:5c (DEVICE)\tAVDTP\t12\tRcvd Command - Start - ACP SEID [2 - Audio Sink]\n> 602\t28.946025\tSANYOEle_71:7b:5c (DEVICE)\tXiaomiCo_f2:31:c7 (PHONE)\tAVDTP\t11\tSent ResponseAccept - Start\n```\n\n#### 传输(Streaming)\n\n使用RTP协议传输数据，AVDTP协议本身不处理数据流。\n\n```dtd\n> 612\t29.166322\tXiaomiCo_f2:31:c7 (PHONE)\tSANYOEle_71:7b:5c (DEVICE)\tRTP\t37\tPT=Unknown, SSRC=0x2, Seq=1, Time=0\n---------------------------------------------------------------------------\nFrame 612: 37 bytes on wire (296 bits), 37 bytes captured (296 bits)\nBluetooth\nBluetooth HCI H4\nBluetooth HCI ACL Packet\nBluetooth L2CAP Protocol\nBluetooth A2DP Profile\n    [ACP SEID: 2]\n    [INT SEID: 2]\n    [Codec: MPEG-2,4 AAC (0x02)]\n    [Stream Start in Frame: 612]\n    [Stream End in Frame: 22786]\n    [Stream Number: 1]\nReal-Time Transport Protocol\n    [Stream setup by BT A2DP (frame 612)]\n    10.. .... = Version: RFC 1889 Version (2)\n    ..0. .... = Padding: False\n    ...0 .... = Extension: False\n    .... 0000 = Contributing source identifiers count: 0\n    0... .... = Marker: False\n    Payload type: Unknown (98)\n    Sequence number: 1\n    [Extended sequence number: 65537]\n    Timestamp: 0\n    Synchronization Source identifier: 0x00000002 (2)\nData (16 bytes)\n    Data: 47fc0000b0908003000621100520a41c\n    [Length: 16]\n\n```\n\n#### 暂停(Streaming)\n\n```dtd\n> 773\t23.510436\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVDTP\t11\tSent ResponseAccept - Suspend\n```\n\n#### 释放(Closing)\n\n```dtd\n> 5692\t96.414176\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVDTP\t12\tSent Command - Close - ACP SEID [2 - Audio Source]\n```\n\n## AVCTP\n\n**AVCTP： Audio/Video Control Transport Protocol(音频/视频控制传输协议)**，用于蓝牙设备间音乐数据流功能的发现与控制，但是控制的具体功能逻辑不由AVCTP处理，其只发送命令。\n\n发现由SDP协议完成，然后发起L2CAP通道连接蓝牙设备之间的AVCTP服务，如下:\n\n```dtd\n#发现\n> 134\t0.964749\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tSDP\t33\tSent Service Search Attribute Request : Audio Source: [Service Class ID List 0x0001] [Protocol Descriptor List 0x0004] [Bluetooth Profile Descriptor List 0x0009] \n> 139\t0.981837\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tSDP\t64\tRcvd Service Search Attribute Response \n---------------------------------------------------------------------------\nBluetooth SDP Protocol\n    PDU: Service Search Attribute Response (0x07)\n    Transaction Id: 0x0000\n    Parameter Length: 50\n    Attribute List Byte Count: 47\n    Attribute Lists [count =  1]\n        Data Element: Sequence uint8 45 bytes\n            0011 0... = Data Element Type: Sequence (6)\n            .... .101 = Data Element Size: uint8 (5)\n            Data Element Var Size: 45\n            Data Value\n                Attribute List [count =  3] (Audio Source)\n                    Data Element: Sequence uint16 42 bytes\n                        0011 0... = Data Element Type: Sequence (6)\n                        .... .110 = Data Element Size: uint16 (6)\n                        Data Element Var Size: 42\n                        Data Value\n                            Service Attribute: Service Class ID List (0x1), value = Audio Source\n                                Attribute ID: Service Class ID List\n                                Value\n                            Service Attribute: Protocol Descriptor List (0x4), value = L2CAP:25 -> AVDTP (1.3)\n                                Attribute ID: Protocol Descriptor List\n                                Value\n                            Service Attribute: Bluetooth Profile Descriptor List (0x9), value = Advanced Audio Distribution 1.3\n                                Attribute ID: Bluetooth Profile Descriptor List\n                                Value\n    Continuation State: no (00)\n\n\n#连接\n> 147\t1.006617\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tL2CAP\t17\tSent Connection Request (AVDTP, SCID: 0x0043)\n> 155\t1.017317\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tL2CAP\t21\tRcvd Connection Response - Success (SCID: 0x0043, DCID: 0x0042)\n```\n\n## AVRCP\n\n**AVRCP：Audio/Video Remote Control Profile(音频/视频远程控制配置文件)**，用于控制蓝牙音乐的标准接口。\n\n在AVRCP中，**TG**表示播放设备，**CT**表示控制设备。\n\n### 命令格式\n\n命令分为两个类型：VENDOR DEPENDENT 与PASS THROUGH，\n\n- VENDOR DEPENDENT：通过`Ctype`与`PDU ID`来区分功能，`Ctype`有**Control, Status , Notify**,ACCEPTED,REJECTED, CHANGED,INTERIM,IMPLEMENTED,STABLE等。\n\n- PASS THROUGH：是播放控制命令，`Ctype`只有**Control**。\n\n其中请求命令`Ctype`为**Notify**，回复事件`Ctype`为**Interim**，事件通知`Ctype`为**Changed**。\n\n### 获取TG播放器支持功能\n\n`PDU ID`：GetFolderItems，通过`Scope`来区分功能，用于**TG**可以播放器列表与每个播放器支持的功能。\n\n```dtd\n> 307\t1.551666\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t29\tSent Browsing: Command - GetFolderItems - Scope: MediaPlayerList, StartItem: 0x0000, EndItem: 0x0013\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    PDU ID: GetFolderItems (0x71)\n    Parameter Length: 10\n    Scope: MediaPlayerList (0x00)\n    StartItem: 0\n    EndItem: 19\n    Attribute Count: All attributes are requested (0)\n    Attribute List\n\n> 326\t1.651062\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t67\tRcvd Browsing: OK - GetFolderItems - UidCounter: 0x0000, NumberOfItems: 1\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    PDU ID: GetFolderItems (0x71)\n    Parameter Length: 48\n    Status: OK (0x04)\n    UID Counter: 0x0000\n    Number Of Items: 1\n    Player: Music Player\n        Item Type: Media Player Item (0x01)\n        Item Length: 40\n        Player ID: 0\n        Major Player Type: Unknown (0x01)\n        Player SubType: Audio Book (0x00000001)\n        Play Status: Stopped (0x00)\n        Features\n            Not Used Features\n            .... ...1 = PASSTHROUGH Play: 0x1\n            .... ..1. = PASSTHROUGH Stop: 0x1\n            .... .1.. = PASSTHROUGH Pause: 0x1\n            ...1 .... = PASSTHROUGH Rewind: 0x1\n            ..1. .... = PASSTHROUGH FastForward: 0x1\n            1... .... = PASSTHROUGH Forward: 0x1\n            .... ...1 = PASSTHROUGH Backward: 0x1\n            .... .1.. = Advanced Control Player: 0x1\n        Character Set: UTF-8 (106)\n        Displayable Name Length: 12\n        Displayable Name: Music Player\n```\n\n### 获取TG支持事件\n\n`PDU ID`：GetCapabilities，用于**TG**可以支持的事件。\n\n```dtd\n> 288\t1.233497\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t23\tSent Vendor dependent: Status - GetCapabilities(Events Supported)\n> 299\t1.252688\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t30\tRcvd Vendor dependent: Stable - GetCapabilities(Events Supported) - Count: 6\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    0000 .... = Reserved: 0x0\n    .... 1100 = Ctype: Stable (0xc)\n    0100 1... = Subunit Type: Panel (0x09)\n    .... .000 = Subunit ID: 0x0\n    Opcode: Vendor dependent (0x00)\n    Company ID: 00:19:58 (Bluetooth SIG, Inc.)\n    PDU ID: GetCapabilities (0x10)\n    0000 00.. = RFA: 0x00\n    .... ..00 = Packet Type: Single (0x0)\n    Parameter Length: 8\n    Capability: Events Supported (0x03)\n    Capability Count: 0x06\n    Event ID: PlaybackStatusChanged (0x01)\n    Event ID: TrackChanged (0x02)\n    Event ID: PlaybackPositionChanged (0x05)\n    Event ID: AvailablePlayersChanged (0x0a)\n    Event ID: AddressedPlayerChanged (0x0b)\n    Event ID: NowPlayingContentChanged (0x09)\n    [Response Time: 19/1000ms]\n    [Command in frame: 288]\n```\n\n### 播放器状态\n\n**CT**端获取**TC**端播放状态，`Play Status`的参数由`GetFolderItems`原语获取，通过`Ctype`来区分操作。\n\n#### 注册事件\n\n`PDU ID`：RegisterNotification，`Event ID`为: PlaybackStatusChanged(`GetCapabilities`原语获取)。\n\n```dtd\n> 300\t1.252942\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t27\tSent Vendor dependent: Notify - RegisterNotification - PlaybackStatusChanged\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    0000 .... = Reserved: 0x0\n    .... 0011 = Ctype: Notify (0x3)\n    0100 1... = Subunit Type: Panel (0x09)\n    .... .000 = Subunit ID: 0x0\n    Opcode: Vendor dependent (0x00)\n    Company ID: 00:19:58 (Bluetooth SIG, Inc.)\n    PDU ID: RegisterNotification (0x31)\n    0000 00.. = RFA: 0x00\n    .... ..00 = Packet Type: Single (0x0)\n    Parameter Length: 5\n    Event ID: PlaybackStatusChanged (0x01)\n    Interval: 0\n    [Response Time: 107/1000ms]\n    [Response in frame: 324]\n\n> 324\t1.649874\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t24\tRcvd Vendor dependent: Interim - RegisterNotification - PlaybackStatusChanged - PlayStatus: Paused\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    0000 .... = Reserved: 0x0\n    .... 1111 = Ctype: Interim (0xf)\n    0100 1... = Subunit Type: Panel (0x09)\n    .... .000 = Subunit ID: 0x0\n    Opcode: Vendor dependent (0x00)\n    Company ID: 00:19:58 (Bluetooth SIG, Inc.)\n    PDU ID: RegisterNotification (0x31)\n    0000 00.. = RFA: 0x00\n    .... ..00 = Packet Type: Single (0x0)\n    Parameter Length: 2\n    Event ID: PlaybackStatusChanged (0x01)\n    Play Status: Paused (0x02)\n    [Response Time: 107/1000ms]\n    [Command in frame: 300]\n```\n\n#### 事件通知\n\n`PDU ID`：RegisterNotification，`Event ID`为: PlaybackStatusChanged，通过`Ctype`来区分功能。\n\n```dtd\n> 372\t2.461590\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t24\tRcvd Vendor dependent: Changed - RegisterNotification - PlaybackStatusChanged - PlayStatus: Stopped\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    0000 .... = Reserved: 0x0\n    .... 1101 = Ctype: Changed (0xd)\n    0100 1... = Subunit Type: Panel (0x09)\n    .... .000 = Subunit ID: 0x0\n    Opcode: Vendor dependent (0x00)\n    Company ID: 00:19:58 (Bluetooth SIG, Inc.)\n    PDU ID: RegisterNotification (0x31)\n    0000 00.. = RFA: 0x00\n    .... ..00 = Packet Type: Single (0x0)\n    Parameter Length: 2\n    Event ID: PlaybackStatusChanged (0x01)\n    Play Status: Stopped (0x00)\n    [Response Time: 107/1000ms]\n    [Command in frame: 300]\n```\n\n#### 主动获取\n\n`PDU ID`：GetPlayStatus，往往与`RegisterNotification-TrackChanged`命令配合使用。\n\n```dtd\n> 466\t18.051244\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t22\tSent Vendor dependent: Status - GetPlayStatus\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    0000 .... = Reserved: 0x0\n    .... 0001 = Ctype: Status (0x1)\n    0100 1... = Subunit Type: Panel (0x09)\n    .... .000 = Subunit ID: 0x0\n    Opcode: Vendor dependent (0x00)\n    Company ID: 00:19:58 (Bluetooth SIG, Inc.)\n    PDU ID: GetPlayStatus (0x30)\n    0000 00.. = RFA: 0x00\n    .... ..00 = Packet Type: Single (0x0)\n    Parameter Length: 0\n    [Response Time: 40/1000ms]\n    [Response in frame: 478]\n\n> 478\t18.091970\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t31\tRcvd Vendor dependent: Stable - GetPlayStatus PlayStatus: Playing, SongPosition: 6118ms, SongLength: 175000ms\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    0000 .... = Reserved: 0x0\n    .... 1100 = Ctype: Stable (0xc)\n    0100 1... = Subunit Type: Panel (0x09)\n    .... .000 = Subunit ID: 0x0\n    Opcode: Vendor dependent (0x00)\n    Company ID: 00:19:58 (Bluetooth SIG, Inc.)\n    PDU ID: GetPlayStatus (0x30)\n    0000 00.. = RFA: 0x00\n    .... ..00 = Packet Type: Single (0x0)\n    Parameter Length: 9\n    Song Length: 175000\n    Song Position: 6118\n    Play Status: Playing (0x01)\n    [Response Time: 40/1000ms]\n    [Command in frame: 466]\n```\n\n### 播放进度\n\n使用`PDU ID`：GetPlayStatus，获取**TG**端播放进度，**CT**端轮循调用此命令。其中`Song Length`参数为音乐长度，`Song Position`为当前播放进度。日志参考`主动获取播放器`章节。\n\n### 音轨状态\n\n**CT**端获取**TC**端播放器音轨状态，状态有下面两种：\n\n- 无音轨：`Identifier: 0xffffffffffffffff (NOT SELECTED)`\n- 有音轨：`Identifier: 0x0000000000000000 (SELECTED)`\n\n**音轨状态事件**会在每次开始播放都会有事件，歌词就是通过发送**音轨状态事件**来完成的。\n\n#### 注册事件\n\n`PDU ID`：RegisterNotification，`Event ID`为: TrackChanged(`GetCapabilities`原语获取)。\n\n```dtd\n> 323\t1.331254\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t27\tSent Vendor dependent: Notify - RegisterNotification - TrackChanged\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    0000 .... = Reserved: 0x0\n    .... 0011 = Ctype: Notify (0x3)\n    0100 1... = Subunit Type: Panel (0x09)\n    .... .000 = Subunit ID: 0x0\n    Opcode: Vendor dependent (0x00)\n    Company ID: 00:19:58 (Bluetooth SIG, Inc.)\n    PDU ID: RegisterNotification (0x31)\n    0000 00.. = RFA: 0x00\n    .... ..00 = Packet Type: Single (0x0)\n    Parameter Length: 5\n    Event ID: TrackChanged (0x02)\n    Interval: 0\n    [Response Time: 35/1000ms]\n    [Response in frame: 330]\n\n> 330\t1.366518\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t31\tRcvd Vendor dependent: Interim - RegisterNotification - TrackChanged - 0xFFFFFFFFFFFFFFFF (NOT SELECTED)\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    0000 .... = Reserved: 0x0\n    .... 1111 = Ctype: Interim (0xf)\n    0100 1... = Subunit Type: Panel (0x09)\n    .... .000 = Subunit ID: 0x0\n    Opcode: Vendor dependent (0x00)\n    Company ID: 00:19:58 (Bluetooth SIG, Inc.)\n    PDU ID: RegisterNotification (0x31)\n    0000 00.. = RFA: 0x00\n    .... ..00 = Packet Type: Single (0x0)\n    Parameter Length: 9\n    Event ID: TrackChanged (0x02)\n    Identifier: 0xffffffffffffffff (NOT SELECTED)\n    [Response Time: 35/1000ms]\n    [Command in frame: 323]\n```\n\n#### 事件通知\n\n`PDU ID`：RegisterNotification，`Event ID`为: TrackChanged，通过`Ctype`来区分功能。\n\n```dtd\n> 451\t18.026715\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t31\tRcvd Vendor dependent: Changed - RegisterNotification - TrackChanged - 0x0000000000000000 (SELECTED)\n```\n\n### 获取播放音轨的属性\n\n获取当前音轨，播放音乐的属性，如标题、歌手等信息。`Attribute List`请查看[AVRCP协议规范](参考)第26章节，往往与`RegisterNotification-TrackChanged`命令配合使用。\n\n```dtd\n> 465\t18.050915\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t59\tSent Vendor dependent: Status - GetElementAttributes - 0x0000000000000000 (PLAYING)\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    0000 .... = Reserved: 0x0\n    .... 0001 = Ctype: Status (0x1)\n    0100 1... = Subunit Type: Panel (0x09)\n    .... .000 = Subunit ID: 0x0\n    Opcode: Vendor dependent (0x00)\n    Company ID: 00:19:58 (Bluetooth SIG, Inc.)\n    PDU ID: GetElementAttributes (0x20)\n    0000 00.. = RFA: 0x00\n    .... ..00 = Packet Type: Single (0x0)\n    Parameter Length: 37\n    Identifier: 0x0000000000000000\n    Number of Attributes: 7\n    Attribute List\n        Attribute ID: Title (0x00000001)\n        Attribute ID: Artist (0x00000002)\n        Attribute ID: Album (0x00000003)\n        Attribute ID: Media Number (0x00000004)\n        Attribute ID: Total Number of Media (0x00000005)\n        Attribute ID: Genre (0x00000006)\n        Attribute ID: Playing Time (0x00000007)\n    [Response Time: 3/1000ms]\n    [Response in frame: 469]\n\n> 469\t18.054345\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t127\tRcvd Vendor dependent: Stable - GetElementAttributes - Title: \"Demons\"\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    0000 .... = Reserved: 0x0\n    .... 1100 = Ctype: Stable (0xc)\n    0100 1... = Subunit Type: Panel (0x09)\n    .... .000 = Subunit ID: 0x0\n    Opcode: Vendor dependent (0x00)\n    Company ID: 00:19:58 (Bluetooth SIG, Inc.)\n    PDU ID: GetElementAttributes (0x20)\n    0000 00.. = RFA: 0x00\n    .... ..00 = Packet Type: Single (0x0)\n    Parameter Length: 105\n    Number of Attributes: 7\n    Attribute Entries\n        Attribute [                Title]: Demons\n        Attribute [               Artist]: Imagine Dragons\n        Attribute [                Album]: Continued Silence\n        Attribute [         Media Number]: 10\n        Attribute [Total Number of Media]: 18\n        Attribute [                Genre]: \n        Attribute [         Playing Time]: 175000\n    [Response Time: 3/1000ms]\n    [Command in frame: 465]\n```\n\n### 播放器控制\n\n**CT**控制**TG**播放器的相关命令，都是PASS THROUGH类型，通过`Operation ID`来区分功能，通过`Ctype`来区分操作。\n\n#### 播放\n\n```dtd\n> 298\t1.252592\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t17\tSent Pass Through: Control - PLAY (Pushed)\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    0000 .... = Reserved: 0x0\n    .... 0000 = Ctype: Control (0x0)\n    0100 1... = Subunit Type: Panel (0x09)\n    .... .000 = Subunit ID: 0x0\n    Opcode: Pass Through (0x7c)\n    0... .... = State: Pushed (0x0)\n    .100 0100 = Operation ID: PLAY (0x44)\n    Data Length: 0x00\n    [Response Time: 14/200ms]\n    [Response in frame: 308]\n\n>308\t1.266992\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t17\tRcvd Pass Through: Accepted - PLAY (Pushed)\n```\n\n#### 暂停\n\n```dtd\n> 430\t7.424245\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t17\tSent Pass Through: Control - PAUSE (Pushed)\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    0000 .... = Reserved: 0x0\n    .... 0000 = Ctype: Control (0x0)\n    0100 1... = Subunit Type: Panel (0x09)\n    .... .000 = Subunit ID: 0x0\n    Opcode: Pass Through (0x7c)\n    0... .... = State: Pushed (0x0)\n    .100 0110 = Operation ID: PAUSE (0x46)\n    Data Length: 0x00\n    [Response Time: 70/200ms]\n    [Response in frame: 434]\n\n> 434\t7.494377\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t17\tRcvd Pass Through: Accepted - PAUSE (Pushed)\n```\n\n#### 下一曲\n\n```dtd\n> 1163\t40.755874\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t17\tSent Pass Through: Control - BACKWARD (Pushed)\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    0000 .... = Reserved: 0x0\n    .... 0000 = Ctype: Control (0x0)\n    0100 1... = Subunit Type: Panel (0x09)\n    .... .000 = Subunit ID: 0x0\n    Opcode: Pass Through (0x7c)\n    0... .... = State: Pushed (0x0)\n    .100 1100 = Operation ID: BACKWARD (0x4c)\n    Data Length: 0x00\n    [Response Time: 15/200ms]\n    [Response in frame: 1168]\n\n> 1168\t40.771498\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t17\tRcvd Pass Through: Accepted - BACKWARD (Pushed)\n```\n\n#### 上一曲\n\n```dtd\n> 969\t37.736799\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t17\tSent Pass Through: Control - FORWARD (Pushed)\n---------------------------------------------------------------------------\nBluetooth AVRCP Profile\n    0000 .... = Reserved: 0x0\n    .... 0000 = Ctype: Control (0x0)\n    0100 1... = Subunit Type: Panel (0x09)\n    .... .000 = Subunit ID: 0x0\n    Opcode: Pass Through (0x7c)\n    0... .... = State: Pushed (0x0)\n    .100 1011 = Operation ID: FORWARD (0x4b)\n    Data Length: 0x00\n    [Response Time: 25/200ms]\n    [Response in frame: 976]\n\n> 976\t37.762691\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t17\tRcvd Pass Through: Accepted - FORWARD (Pushed)\n```\n\n# 参考\n- 蓝牙核心协议规范[Core_v4.2.pdf](https://www.bluetooth.org/DocMan/handlers/DownloadDoc.ashx?doc_id=286439)\n- PBAP协议规范[PBAP_v1.2.3.pdf](https://www.bluetooth.com/specifications/specs/phone-book-access-profile-1-2-3/)\n- HFP协议规范[HFP_v1.8.pdf](https://www.bluetooth.com/specifications/specs/hands-free-profile-1-8/)\n- AVDTP协议规范[AVDTP_SPEC_V13.pdf](https://www.bluetooth.com/specifications/specs/a-v-distribution-transport-protocol-1-3/)\n- AVCTP协议规范[AVCTP_SPEC_V14.pdf](https://www.bluetooth.com/specifications/specs/a-v-%e2%80%8b%e2%80%8bcontrol-transport-protocol-1-4/)\n- AVRCP协议规范[AVRCP_v1.6.2.pdf](https://www.bluetooth.com/specifications/specs/a-v-remote-control-profile-1-6-2/)\n- [蓝牙物理链路类型：SCO和ACL链路与A2DP](https://blog.csdn.net/wenzongliang/article/details/84689377)\n- [安全简单配对](https://blog.csdn.net/XiaoXiaoPengBo/article/details/107792407)\n- [在HCI层看蓝牙的连接过程](https://blog.csdn.net/u010657219/article/details/42192481)\n- [蓝牙SDP协议概述 ](https://www.cnblogs.com/libs-liu/p/9498952.html)\n- [RFCOMM协议概念介绍](https://blog.csdn.net/XiaoXiaoPengBo/article/details/108125755)\n- [蓝牙的OBEX协议](https://blog.51cto.com/u_2982693/3521456)\n- [蓝牙电话之PBAP协议分析](https://blog.csdn.net/weixin_44260005/article/details/105223139)\n- [蓝牙之八-HFP](https://blog.csdn.net/shichaog/article/details/52123439)\n- [蓝牙之九-AT命令](https://blog.csdn.net/shichaog/article/details/52126415)\n\n","slug":"traditional-bluetooth-protocol-stack-simple","published":1,"updated":"2023-06-30T13:34:34.851Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cljiok5gq0006t0izf0x00kwo","content":"<h1 id=\"概述\"><a href=\"#概述\" class=\"headerlink\" title=\"概述\"></a>概述</h1><p>此文主要是简单的探索一下蓝牙电话和蓝牙音乐相关协议栈，所以很多细节并未涉及。</p>\n<p>一般而言，我们把某个协议的实现代码称为协议栈(protocol stack)，要理解协议栈需要先了解蓝牙的核心系统架构，如下图：</p>\n<p><img src=\"https://s1.ax1x.com/2022/04/11/LV6Ybd.png\"></p>\n<p>也可简单的<strong>抽象为3层</strong>：<img src=\"https://s1.ax1x.com/2022/04/11/LV6JDH.png\"></p>\n<ul>\n<li>**User Application(Host)**：User Application即应用层，也被称为Host，我们调用Bluetooth API就属于应用层，例如，<a href=\"https://developer.android.com/reference/android/bluetooth/BluetoothAdapter.html\">BluetoothAdapter</a>中提供的接口。</li>\n<li><strong>HCI (Host controller Interface)<strong>：上层在调用蓝牙API时，</strong>不会直接操作蓝牙底层</strong>(Controller)相关接口，而是<strong>通过HCI下发对应操作的Command给Controller</strong>，然后底层执行命令后返回执行结果，<strong>即Controller发送Event给HCI，HCI再通知给应用层</strong>，HCI起到了一个<strong>中间层</strong>的作用。</li>\n<li><strong>Controller</strong>：Controller是在最底层，硬件驱动。</li>\n</ul>\n<p>按照上面的定义，HCI与Host层中的协议实现就是<strong>蓝牙协议栈</strong>。</p>\n<h2 id=\"HCI\"><a href=\"#HCI\" class=\"headerlink\" title=\"HCI\"></a>HCI</h2><blockquote>\n<p> BLUETOOTH SPECIFICATION Version 4.2 [Vol 2, Part E] page 400  </p>\n<p> HCI（HOST CONTROLLER INTERFACE）：主机控制层接口，主要负责透过transport把协议栈的数据发送给蓝牙芯片，并且接受来自蓝牙芯片的数据，数据主要分为HCI COMMAND(HOST-&gt;CONTROLLER),HCI EVENT(HOST&lt;-CONTROLLER),HCI ACL(HOST&lt;-&gt;CONTROLLER),HCI SCO(这个有点些微差异，因为部分芯片的SCO数据不是透过TRANSPORT直接跟HOST沟通，而是通过特殊的引脚，PCM IN&#x2F;OUT&#x2F;SYNC&#x2F;CLK脚来传输数据)</p>\n</blockquote>\n<p>HOST层的几乎所有数据最后都会通过HCI，所以我们通过HCI的日志就可以了解蓝牙协议栈中每个协议，手机中可以通过开发者模式打开HCI日志开关，推荐使用<strong>wireshark</strong>或者<strong>Frontline ComProbe Protocol Analysis System</strong>来分析HCI日志，下面给出来的的日志都是<strong>wireshark</strong>的结果。</p>\n<p>HCI日志由各种数据包组成，我们需要了解其中的两种数据包如下：</p>\n<h3 id=\"Command-数据包\"><a href=\"#Command-数据包\" class=\"headerlink\" title=\"Command 数据包\"></a>Command 数据包</h3><p>HCI Command数据包格式如下，开头的<strong>Opcode是区分不同类型的命令的唯一标识</strong>，Opcode由<strong>OpCode Group Field (OGF)</strong> 和 **OpCode Command Field (OCF)**组成。根据OGF的值，可以将HCI commands进行分类。OpCode 的计算公式为：<code>OpCode = OGF &lt;&lt; 6 + OCF</code> <strong>。有了OpCode计算的方式，我们就可以</strong>通过OpCode过滤HCI log里面的指定类型的HCI Command。</p>\n<p><img src=\"https://s1.ax1x.com/2022/04/11/LV608f.png\"></p>\n<p>一次HCI Command指令发送完成，通常两条数据包，一条是host给controller的指令，一条是controller给host的指令反馈，可以确定指令发送是成功的。</p>\n<h3 id=\"Event-数据包\"><a href=\"#Event-数据包\" class=\"headerlink\" title=\"Event 数据包\"></a>Event 数据包</h3><p>HCI Event 数据包由controller发送给Host，其中可以是蓝牙设备的消息也可以是连接的蓝牙设备的消息。</p>\n<p><img src=\"https://s1.ax1x.com/2022/04/11/LV6B28.png\"></p>\n<h1 id=\"设备连接\"><a href=\"#设备连接\" class=\"headerlink\" title=\"设备连接\"></a>设备连接</h1><h2 id=\"蓝牙设备状态\"><a href=\"#蓝牙设备状态\" class=\"headerlink\" title=\"蓝牙设备状态\"></a>蓝牙设备状态</h2><blockquote>\n<p>BLUETOOTH SPECIFICATION Version 4.2 [Vol 2, Part B] page 159  </p>\n</blockquote>\n<p>扫描设备然后与之建立连接是蓝牙工作流程的第一步，所以先要了解一下蓝牙的状态如下图：</p>\n<p><img src=\"https://s1.ax1x.com/2022/04/11/LV6wPP.png\"></p>\n<p>从<u>蓝牙状态转换图</u>中可以看出 STANDBY状体是蓝牙设备的默认状态。</p>\n<p><strong>Page</strong>：这个子状态就是我们通常称为的连接(寻呼)，进行连接&#x2F;激活对应的slave的操作我们就称为page。</p>\n<p><strong>Page scan</strong>：这个子状态是和page对应的，它就是等待被page的slave所处的状态，换句话说，若想被page到，我们就要处于page scan的状态。</p>\n<p><strong>inquiry</strong>：这就是我们通常所说的扫描状态，这个状态的设备就是去扫描周围的设备。</p>\n<p><strong>inquiry scan</strong>：这就是我们通常看到的可被发现的设备。体现在上层就是我们在android系统中点击设备可被周围什么发现，那设备就处于这样的状态。</p>\n<h2 id=\"逻辑链路传输协议\"><a href=\"#逻辑链路传输协议\" class=\"headerlink\" title=\"逻辑链路传输协议\"></a>逻辑链路传输协议</h2><h3 id=\"ACL\"><a href=\"#ACL\" class=\"headerlink\" title=\"ACL\"></a>ACL</h3><blockquote>\n<p>BLUETOOTH SPECIFICATION Version 4.2 [Vol 1, Part A]  page  63  </p>\n<p>The asynchronous connection-oriented (ACL) logical transport is used to carry<br>LMP and L2CAP control signaling and best effort asynchronous user data. The<br>ACL logical transport uses a 1-bit ARQN&#x2F;SEQN scheme to provide simple<br>channel reliability. Every active slave device within a piconet has one ACL<br>logical transport to the piconet master, known as the default ACL.  </p>\n</blockquote>\n<p>ACL全称<strong>BR&#x2F;EDR Asynchronous Connection-oriented</strong>，定向连接，它既支持对称连接，也支持不对称连接（既可以一对一，也可以一对多）。主设备负责控制链路带宽，并决定微微网中的每个从设备可以占用多少带宽和连接的对称性。从设备只有被选中时才能传送数据。ACL链路也支持接收主设备发给微微网中所有从设备的广播消息。</p>\n<p>建立ACL需要设备HCI之间进行的下面的操作，这个也与<strong>蓝牙状态</strong>息息相关。</p>\n<h4 id=\"开始扫描\"><a href=\"#开始扫描\" class=\"headerlink\" title=\"开始扫描\"></a>开始扫描</h4><ul>\n<li><p><strong>Host</strong>:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LocalBluetoothManager.getInstance().getBluetoothAdapter().startScanning(<span class=\"literal\">true</span>);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>Controller</strong>:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#发送扫描指令</span><br><span class=\"line\">&gt; 103\t4.351128\thost\tcontroller\tHCI_CMD\t9\tSent Inquiry</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - Inquiry</span><br><span class=\"line\">    Command Opcode: Inquiry (0x0401)</span><br><span class=\"line\">        0000 01.. .... .... = Opcode Group Field: Link Control Commands (0x01)</span><br><span class=\"line\">        .... ..00 0000 0001 = Opcode Command Field: Inquiry (0x001)</span><br><span class=\"line\">    Parameter Total Length: 5</span><br><span class=\"line\">    LAP: 0x9e8b33</span><br><span class=\"line\">    Inquiry Length: 10 (12.8 sec)</span><br><span class=\"line\">    Num Responses: 0</span><br><span class=\"line\">    [Pending in frame: 104]</span><br><span class=\"line\">    [Command-Pending Delta: 0.846ms]</span><br><span class=\"line\">    [Response in frame: 429]</span><br><span class=\"line\">    [Command-Response Delta: 12811.07ms]</span><br><span class=\"line\"></span><br><span class=\"line\">#HCI反馈扫描指令状态</span><br><span class=\"line\">&gt; 104\t4.351974\tcontroller\thost\tHCI_EVT\t7\tRcvd Command Status (Inquiry)</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Command Status</span><br><span class=\"line\">    Event Code: Command Status (0x0f)</span><br><span class=\"line\">    Parameter Total Length: 4</span><br><span class=\"line\">    Status: Pending (0x00)</span><br><span class=\"line\">    Number of Allowed Command Packets: 1</span><br><span class=\"line\">    Command Opcode: Inquiry (0x0401)</span><br><span class=\"line\">    [Command in frame: 103]</span><br><span class=\"line\">    [Response in frame: 429]</span><br><span class=\"line\">    [Command-Pending Delta: 0.846ms]</span><br><span class=\"line\">    [Pending-Response Delta: 12810.224ms]</span><br><span class=\"line\"></span><br><span class=\"line\">#HCI发送的扫描到的设备信息</span><br><span class=\"line\">&gt; 114\t4.505582\tcontroller\thost\tHCI_EVT\t258\tRcvd Extended Inquiry Result</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Extended Inquiry Result</span><br><span class=\"line\">    Event Code: Extended Inquiry Result (0x2f)</span><br><span class=\"line\">    Parameter Total Length: 255</span><br><span class=\"line\">    Number of responses: 1</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_77:c2:35 (00:00:00:00:00:00)</span><br><span class=\"line\">    Page Scan Repetition Mode: R1 (0x01)</span><br><span class=\"line\">    Reserved: 0x02</span><br><span class=\"line\">    Class of Device: 0x5a020c (Phone:Smartphone - services: Networking Capturing ObjectTransfer Telephony)</span><br><span class=\"line\">    .000 0000 0011 0100 = Clock Offset: 0x0034</span><br><span class=\"line\">    RSSI: -88 dBm</span><br><span class=\"line\">    Extended Inquiry Response Data</span><br><span class=\"line\">        Device Name: +My Phone1234567890123456789012</span><br><span class=\"line\">        16-bit Service Class UUIDs</span><br><span class=\"line\">        32-bit Service Class UUIDs</span><br><span class=\"line\">        128-bit Service Class UUIDs</span><br><span class=\"line\">        Unused</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"停止扫描\"><a href=\"#停止扫描\" class=\"headerlink\" title=\"停止扫描\"></a>停止扫描</h4><ul>\n<li><p><strong>Host</strong>:</p>\n  <figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LocalBluetoothManager.getInstance().getBluetoothAdapter().stopScanning();</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>Controller</strong>:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 85\t2.202129\thost\tcontroller\tHCI_CMD\t4\tSent Inquiry Cancel</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - Inquiry Cancel</span><br><span class=\"line\">    Command Opcode: Inquiry Cancel (0x0402)</span><br><span class=\"line\">        0000 01.. .... .... = Opcode Group Field: Link Control Commands (0x01)</span><br><span class=\"line\">        .... ..00 0000 0010 = Opcode Command Field: Inquiry Cancel (0x002)</span><br><span class=\"line\">    Parameter Total Length: 0</span><br><span class=\"line\">    [Response in frame: 86]</span><br><span class=\"line\">    [Command-Response Delta: 2.051ms]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 86\t2.204180\tcontroller\thost\tHCI_EVT\t7\tRcvd Command Complete (Inquiry Cancel)</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Command Complete</span><br><span class=\"line\">    Event Code: Command Complete (0x0e)</span><br><span class=\"line\">    Parameter Total Length: 4</span><br><span class=\"line\">    Number of Allowed Command Packets: 1</span><br><span class=\"line\">    Command Opcode: Inquiry Cancel (0x0402)</span><br><span class=\"line\">    Status: Success (0x00)</span><br><span class=\"line\">    [Command in frame: 85]</span><br><span class=\"line\">    [Command-Response Delta: 2.051ms]</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"完成扫描\"><a href=\"#完成扫描\" class=\"headerlink\" title=\"完成扫描\"></a>完成扫描</h4><ul>\n<li><p><strong>Host</strong>:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LocalBluetoothManager.getInstance().getEventManager().registerCallback(<span class=\"keyword\">new</span> <span class=\"title class_\">BluetoothCallback</span>() &#123;</span><br><span class=\"line\">   \t\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onScanningStateChanged</span><span class=\"params\">(<span class=\"type\">boolean</span> started)</span> &#123;</span><br><span class=\"line\">\t\t&#125; </span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>Controller</strong>:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 429\t17.162198\tcontroller\thost\tHCI_EVT\t4\tRcvd Inquiry Complete</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Inquiry Complete</span><br><span class=\"line\">    Event Code: Inquiry Complete (0x01)</span><br><span class=\"line\">    Parameter Total Length: 1</span><br><span class=\"line\">    Status: Success (0x00)</span><br><span class=\"line\">    [Command in frame: 103]</span><br><span class=\"line\">    [Pending in frame: 104]</span><br><span class=\"line\">    [Pending-Response Delta: 12810.224ms]</span><br><span class=\"line\">    [Command-Response Delta: 12811.07ms]</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"设备配对\"><a href=\"#设备配对\" class=\"headerlink\" title=\"设备配对\"></a>设备配对</h4><p><img src=\"https://s1.ax1x.com/2022/04/11/LV6GKe.png\"></p>\n<h5 id=\"配对\"><a href=\"#配对\" class=\"headerlink\" title=\"配对\"></a>配对</h5><ul>\n<li><p><strong>Host</strong>:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CachedBluetoothDevice.startPairing();</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>Controller</strong>:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#删除需要连接设备本地记忆的Link Key</span><br><span class=\"line\">&gt; 685\t33.812149\thost\tcontroller\tHCI_CMD\t11\tSent Delete Stored Link Key</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - Delete Stored Link Key</span><br><span class=\"line\">    Command Opcode: Delete Stored Link Key (0x0c12)</span><br><span class=\"line\">        0000 11.. .... .... = Opcode Group Field: Host Controller &amp; Baseband Commands (0x03)</span><br><span class=\"line\">        .... ..00 0001 0010 = Opcode Command Field: Delete Stored Link Key (0x012)</span><br><span class=\"line\">    Parameter Total Length: 7</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Delete All Flag: Delete only Link Key for specified BD_ADDR (0x00)</span><br><span class=\"line\">    [Response in frame: 686]</span><br><span class=\"line\">    [Command-Response Delta: 2.147ms]</span><br><span class=\"line\"></span><br><span class=\"line\">#建立ACL连接</span><br><span class=\"line\">&gt; 687\t33.814531\thost\tcontroller\tHCI_CMD\t17\tSent Create Connection</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - Create Connection</span><br><span class=\"line\">    Command Opcode: Create Connection (0x0405)</span><br><span class=\"line\">    Parameter Total Length: 13</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Packet Type: 0xcc18, DH5, DM5, DH3, DM3, DH1, DM1</span><br><span class=\"line\">    Page Scan Repetition Mode: R1 (0x01)</span><br><span class=\"line\">    Page Scan Mode: Mandatory Page Scan Mode (0x00)</span><br><span class=\"line\">    .000 0010 0000 1000 = Clock Offset: 0x0208 (650 msec)</span><br><span class=\"line\">    1... .... .... .... = Clock_Offset_Valid_Flag: true (1)</span><br><span class=\"line\">    Allow Role Switch: Local device may be master, or may become slave after accepting a master slave switch. (0x01)</span><br><span class=\"line\">    [Pending in frame: 688]</span><br><span class=\"line\">    [Command-Pending Delta: 0.965ms]</span><br><span class=\"line\">    [Response in frame: 690]</span><br><span class=\"line\">    [Command-Response Delta: 1118.609ms]</span><br><span class=\"line\"></span><br><span class=\"line\">#建立ACL连接成功</span><br><span class=\"line\">&gt; 690\t34.933140\tcontroller\thost\tHCI_EVT\t14\tRcvd Connect Complete</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Connect Complete</span><br><span class=\"line\">    Event Code: Connect Complete (0x03)</span><br><span class=\"line\">    Parameter Total Length: 11</span><br><span class=\"line\">    Status: Success (0x00)</span><br><span class=\"line\">    Connection Handle: 0x0033</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Link Type: ACL connection (Data Channels) (0x01)</span><br><span class=\"line\">    Encryption Mode: Encryption Disabled (0x00)</span><br><span class=\"line\">    [Command in frame: 687]</span><br><span class=\"line\">    [Pending in frame: 688]</span><br><span class=\"line\">    [Pending-Response Delta: 1117.644ms]</span><br><span class=\"line\">    [Command-Response Delta: 1118.609ms]</span><br><span class=\"line\"></span><br><span class=\"line\">#改变当前设备的角色，这里当前设备为从(Slave)，连接设备为主(Master)</span><br><span class=\"line\">&gt; 689\t34.929964\tcontroller\thost\tHCI_EVT\t11\tRcvd Role Change</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Role Change</span><br><span class=\"line\">    Event Code: Role Change (0x12)</span><br><span class=\"line\">    Parameter Total Length: 8</span><br><span class=\"line\">    Status: Success (0x00)</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Role: Currently the Slave for specified BD_ADDR (0x01)</span><br><span class=\"line\"></span><br><span class=\"line\">#与设备建立连接之后，准备开始验证</span><br><span class=\"line\">&gt; 697\t34.935615\thost\tcontroller\tHCI_CMD\t6\tSent Authentication Requested</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - Authentication Requested</span><br><span class=\"line\">    Command Opcode: Authentication Requested (0x0411)</span><br><span class=\"line\">    Parameter Total Length: 2</span><br><span class=\"line\">    Connection Handle: 0x0033</span><br><span class=\"line\">    [Pending in frame: 699]</span><br><span class=\"line\">    [Command-Pending Delta: 0.917ms]</span><br><span class=\"line\">    [Response in frame: 743]</span><br><span class=\"line\">    [Command-Response Delta: 4291.694ms]</span><br><span class=\"line\"></span><br><span class=\"line\">#连接设备询问Link Key</span><br><span class=\"line\">&gt; 701\t34.936976\tcontroller\thost\tHCI_EVT\t9\tRcvd Link Key Request</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Link Key Request</span><br><span class=\"line\">    Event Code: Link Key Request (0x17)</span><br><span class=\"line\">    Parameter Total Length: 6</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\"></span><br><span class=\"line\">#当前设备无Link Key，也就是未于连接设备配对过</span><br><span class=\"line\">&gt; 705\t34.938603\thost\tcontroller\tHCI_CMD\t10\tSent Link Key Request Negative Reply</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - Link Key Request Negative Reply</span><br><span class=\"line\">    Command Opcode: Link Key Request Negative Reply (0x040c)</span><br><span class=\"line\">        0000 01.. .... .... = Opcode Group Field: Link Control Commands (0x01)</span><br><span class=\"line\">        .... ..00 0000 1100 = Opcode Command Field: Link Key Request Negative Reply (0x00c)</span><br><span class=\"line\">    Parameter Total Length: 6</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    [Response in frame: 706]</span><br><span class=\"line\">    [Command-Response Delta: 0.87ms]</span><br><span class=\"line\"></span><br><span class=\"line\">#使用的配对方式是`简单安全配对`SSP(Simple Secure Pairng), 就是直接弹配对码</span><br><span class=\"line\"></span><br><span class=\"line\">#连接设备询问当前设备的IO能力</span><br><span class=\"line\">&gt; 707\t34.939729\tcontroller\thost\tHCI_EVT\t9\tRcvd IO Capability Request</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - IO Capability Request</span><br><span class=\"line\">    Event Code: IO Capability Request (0x31)</span><br><span class=\"line\">    Parameter Total Length: 6</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\"></span><br><span class=\"line\">#回复当前设备的IO能力</span><br><span class=\"line\">&gt;708\t34.939897\thost\tcontroller\tHCI_CMD\t13\tSent IO Capability Request Reply</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - IO Capability Request Reply</span><br><span class=\"line\">    Command Opcode: IO Capability Request Reply (0x042b)</span><br><span class=\"line\">        0000 01.. .... .... = Opcode Group Field: Link Control Commands (0x01)</span><br><span class=\"line\">        .... ..00 0010 1011 = Opcode Command Field: IO Capability Request Reply (0x02b)</span><br><span class=\"line\">    Parameter Total Length: 9</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    IO Capability: Display Yes/No (1)</span><br><span class=\"line\">    OOB Data Present: OOB Authentication Data Not Present (0)</span><br><span class=\"line\">    Authentication Requirements: MITM Protection Required - Dedicated Bonding. Use IO Capability To Determine Procedure, No Secure Connection (3)</span><br><span class=\"line\">    [Response in frame: 709]</span><br><span class=\"line\">    [Command-Response Delta: 0.811ms]</span><br><span class=\"line\"></span><br><span class=\"line\">######其它参数同步</span><br><span class=\"line\"></span><br><span class=\"line\">#连接设备的IO能力，io能力参数为Display Yes/No (0x01)，需要用户确认</span><br><span class=\"line\">&gt; 737\t36.532369\tcontroller\thost\tHCI_EVT\t12\tRcvd IO Capability Response</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - IO Capability Response</span><br><span class=\"line\">    Event Code: IO Capability Response (0x32)</span><br><span class=\"line\">    Parameter Total Length: 9</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    IO Capability: Display Yes/No (0x01)</span><br><span class=\"line\">    OOB Data Present: OOB Authentication Data Not Present (0)</span><br><span class=\"line\">    Authentication Requirements: MITM Protection Required - Dedicated Bonding. Use IO Capability To Determine Procedure, No Secure Connection (3)</span><br><span class=\"line\"></span><br><span class=\"line\">#当前设备接收到配对码信息，Numeric Value就是显示的配对码</span><br><span class=\"line\">&gt; 738\t37.066181\tcontroller\thost\tHCI_EVT\t13\tRcvd User Confirmation Request</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - User Confirmation Request</span><br><span class=\"line\">    Event Code: User Confirmation Request (0x33)</span><br><span class=\"line\">    Parameter Total Length: 10</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Numeric Value: 446514</span><br><span class=\"line\"></span><br><span class=\"line\">#回复连接设备已接收到配对码信息</span><br><span class=\"line\">&gt; 739\t37.096306\thost\tcontroller\tHCI_CMD\t10\tSent User Confirmation Request Reply</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - User Confirmation Request Reply</span><br><span class=\"line\">    Command Opcode: User Confirmation Request Reply (0x042c)</span><br><span class=\"line\">        0000 01.. .... .... = Opcode Group Field: Link Control Commands (0x01)</span><br><span class=\"line\">        .... ..00 0010 1100 = Opcode Command Field: User Confirmation Request Reply (0x02c)</span><br><span class=\"line\">    Parameter Total Length: 6</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    [Response in frame: 740]</span><br><span class=\"line\">    [Command-Response Delta: 1.46ms]</span><br><span class=\"line\"></span><br><span class=\"line\">#连接设备SSP验证成功</span><br><span class=\"line\">&gt; 741\t39.215747\tcontroller\thost\tHCI_EVT\t10\tRcvd Simple Pairing Complete</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Simple Pairing Complete</span><br><span class=\"line\">    Event Code: Simple Pairing Complete (0x36)</span><br><span class=\"line\">    Parameter Total Length: 7</span><br><span class=\"line\">    Status: Success (0x00)</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\"></span><br><span class=\"line\">#连接设备的Link Key，需要保存，用于下次连接</span><br><span class=\"line\">&gt; 742\t39.226970\tcontroller\thost\tHCI_EVT\t26\tRcvd Link Key Notification</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Link Key Notification</span><br><span class=\"line\">    Event Code: Link Key Notification (0x18)</span><br><span class=\"line\">    Parameter Total Length: 23</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Link Key: bc31fb070e91eec2f2296fbf9bc8b518</span><br><span class=\"line\">    Key Type: Unknown (0x08)</span><br><span class=\"line\"></span><br><span class=\"line\">#验证完成</span><br><span class=\"line\">&gt; 743\t39.227309\tcontroller\thost\tHCI_EVT\t6\tRcvd Authentication Complete</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Authentication Complete</span><br><span class=\"line\">    Event Code: Authentication Complete (0x06)</span><br><span class=\"line\">    Parameter Total Length: 3</span><br><span class=\"line\">    Status: Success (0x00)</span><br><span class=\"line\">    Connection Handle: 0x0033</span><br><span class=\"line\">    [Command in frame: 697]</span><br><span class=\"line\">    [Pending in frame: 699]</span><br><span class=\"line\">    [Pending-Response Delta: 4290.777ms]</span><br><span class=\"line\">    [Command-Response Delta: 4291.694ms]</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h5 id=\"被配对\"><a href=\"#被配对\" class=\"headerlink\" title=\"被配对\"></a>被配对</h5><ul>\n<li><p><strong>Host</strong>:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LocalBluetoothManager.getInstance().getEventManager().registerCallback(<span class=\"keyword\">new</span> <span class=\"title class_\">BluetoothCallback</span>() &#123;</span><br><span class=\"line\">   \t\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onDeviceBondStateChanged</span><span class=\"params\">(CachedBluetoothDevice cachedDevice, <span class=\"type\">int</span> bondState)</span> &#123;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>Controller</strong>:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#请求ACL连接</span><br><span class=\"line\">&gt; 326\t21.946869\tcontroller\thost\tHCI_EVT\t13\tRcvd Connect Request</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Connect Request</span><br><span class=\"line\">    Event Code: Connect Request (0x04)</span><br><span class=\"line\">    Parameter Total Length: 10</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Class of Device: 0x5a020c (Phone:Smartphone - services: Networking Capturing ObjectTransfer Telephony)</span><br><span class=\"line\">    Link Type: ACL connection (Data Channels) (0x01)</span><br><span class=\"line\"></span><br><span class=\"line\">#允许ACL连接</span><br><span class=\"line\">&gt; 327\t21.947178\thost\tcontroller\tHCI_CMD\t11\tSent Accept Connection Request</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - Accept Connection Request</span><br><span class=\"line\">    Command Opcode: Accept Connection Request (0x0409)</span><br><span class=\"line\">    Parameter Total Length: 7</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Role: Remain the Slave for this connection. The LM will NOT perform the role switch. (0x01)</span><br><span class=\"line\">    [Pending in frame: 328]</span><br><span class=\"line\">    [Command-Pending Delta: 0.685ms]</span><br><span class=\"line\">    [Response in frame: 329]</span><br><span class=\"line\">    [Command-Response Delta: 4.432ms]</span><br><span class=\"line\"></span><br><span class=\"line\">#ACL连接成功</span><br><span class=\"line\">&gt; 329\t21.951610\tcontroller\thost\tHCI_EVT\t14\tRcvd Connect Complete</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Connect Complete</span><br><span class=\"line\">    Event Code: Connect Complete (0x03)</span><br><span class=\"line\">    Parameter Total Length: 11</span><br><span class=\"line\">    Status: Success (0x00)</span><br><span class=\"line\">    Connection Handle: 0x0033</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Link Type: ACL connection (Data Channels) (0x01)</span><br><span class=\"line\">    Encryption Mode: Encryption Disabled (0x00)</span><br><span class=\"line\">    [Command in frame: 327]</span><br><span class=\"line\">    [Pending in frame: 328]</span><br><span class=\"line\">    [Pending-Response Delta: 3.747ms]</span><br><span class=\"line\">    [Command-Response Delta: 4.432ms]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 370\t22.259461\tcontroller\thost\tHCI_EVT\t12\tRcvd IO Capability Response</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - IO Capability Response</span><br><span class=\"line\">    Event Code: IO Capability Response (0x32)</span><br><span class=\"line\">    Parameter Total Length: 9</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    IO Capability: Display Yes/No (0x01)</span><br><span class=\"line\">    OOB Data Present: OOB Authentication Data Not Present (0)</span><br><span class=\"line\">    Authentication Requirements: MITM Protection Required - Dedicated Bonding. Use IO Capability To Determine Procedure, No Secure Connection (3)</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 371\t22.259809\tcontroller\thost\tHCI_EVT\t9\tRcvd IO Capability Request</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - IO Capability Request</span><br><span class=\"line\">    Event Code: IO Capability Request (0x31)</span><br><span class=\"line\">    Parameter Total Length: 6</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 372\t22.259982\thost\tcontroller\tHCI_CMD\t13\tSent IO Capability Request Reply</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - IO Capability Request Reply</span><br><span class=\"line\">    Command Opcode: IO Capability Request Reply (0x042b)</span><br><span class=\"line\">    Parameter Total Length: 9</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    IO Capability: Display Yes/No (1)</span><br><span class=\"line\">    OOB Data Present: OOB Authentication Data Not Present (0)</span><br><span class=\"line\">    Authentication Requirements: MITM Protection Required - Dedicated Bonding. Use IO Capability To Determine Procedure, No Secure Connection (3)</span><br><span class=\"line\">    [Response in frame: 373]</span><br><span class=\"line\">    [Command-Response Delta: 0.619ms]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 374\t22.958223\tcontroller\thost\tHCI_EVT\t13\tRcvd User Confirmation Request</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - User Confirmation Request</span><br><span class=\"line\">    Event Code: User Confirmation Request (0x33)</span><br><span class=\"line\">    Parameter Total Length: 10</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Numeric Value: 804568</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 375\t23.069385\thost\tcontroller\tHCI_CMD\t10\tSent User Confirmation Request Reply</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - User Confirmation Request Reply</span><br><span class=\"line\">    Command Opcode: User Confirmation Request Reply (0x042c)</span><br><span class=\"line\">    Parameter Total Length: 6</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    [Response in frame: 376]</span><br><span class=\"line\">    [Command-Response Delta: 1.81ms]</span><br><span class=\"line\"></span><br><span class=\"line\">#连接设备SSP验证成功</span><br><span class=\"line\">&gt; 377\t26.919540\tcontroller\thost\tHCI_EVT\t10\tRcvd Simple Pairing Complete</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Simple Pairing Complete</span><br><span class=\"line\">    Event Code: Simple Pairing Complete (0x36)</span><br><span class=\"line\">    Parameter Total Length: 7</span><br><span class=\"line\">    Status: Success (0x00)</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\"></span><br><span class=\"line\">#连接设备的Link Key，需要保存，用于下次连接</span><br><span class=\"line\">&gt; 378\t26.926691\tcontroller\thost\tHCI_EVT\t26\tRcvd Link Key Notification</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Link Key Notification</span><br><span class=\"line\">    Event Code: Link Key Notification (0x18)</span><br><span class=\"line\">    Parameter Total Length: 23</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Link Key: 2160acf6b7403a97050f64de72570b1d</span><br><span class=\"line\">    Key Type: Unknown (0x08)</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"设备连接-1\"><a href=\"#设备连接-1\" class=\"headerlink\" title=\"设备连接\"></a>设备连接</h4><p><img src=\"https://s1.ax1x.com/2022/04/11/LV63vD.png\"></p>\n<h5 id=\"连接\"><a href=\"#连接\" class=\"headerlink\" title=\"连接\"></a>连接</h5><ul>\n<li><p><strong>Host</strong>:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CachedBluetoothDevice.conntect(<span class=\"literal\">true</span>);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>Controller</strong>:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 1214\t47.023224\thost\tcontroller\tHCI_CMD\t17\tSent Create Connection</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - Create Connection</span><br><span class=\"line\">    Command Opcode: Create Connection (0x0405)</span><br><span class=\"line\">    Parameter Total Length: 13</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Packet Type: 0xcc18, DH5, DM5, DH3, DM3, DH1, DM1</span><br><span class=\"line\">    Page Scan Repetition Mode: R1 (0x01)</span><br><span class=\"line\">    Page Scan Mode: Mandatory Page Scan Mode (0x00)</span><br><span class=\"line\">    .011 1001 0100 0100 = Clock Offset: 0x3944 (18325 msec)</span><br><span class=\"line\">    1... .... .... .... = Clock_Offset_Valid_Flag: true (1)</span><br><span class=\"line\">    Allow Role Switch: Local device may be master, or may become slave after accepting a master slave switch. (0x01)</span><br><span class=\"line\">    [Pending in frame: 1215]</span><br><span class=\"line\">    [Command-Pending Delta: 1.458ms]</span><br><span class=\"line\">    [Response in frame: 1217]</span><br><span class=\"line\">    [Command-Response Delta: 1630.81ms]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 1216\t48.646874\tcontroller\thost\tHCI_EVT\t11\tRcvd Role Change</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Role Change</span><br><span class=\"line\">    Event Code: Role Change (0x12)</span><br><span class=\"line\">    Parameter Total Length: 8</span><br><span class=\"line\">    Status: Success (0x00)</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Role: Currently the Slave for specified BD_ADDR (0x01)</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 1217\t48.654034\tcontroller\thost\tHCI_EVT\t14\tRcvd Connect Complete</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Connect Complete</span><br><span class=\"line\">    Event Code: Connect Complete (0x03)</span><br><span class=\"line\">    Parameter Total Length: 11</span><br><span class=\"line\">    Status: Success (0x00)</span><br><span class=\"line\">    Connection Handle: 0x0033</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Link Type: ACL connection (Data Channels) (0x01)</span><br><span class=\"line\">    Encryption Mode: Encryption Disabled (0x00)</span><br><span class=\"line\">    [Command in frame: 1214]</span><br><span class=\"line\">    [Pending in frame: 1215]</span><br><span class=\"line\">    [Pending-Response Delta: 1629.352ms]</span><br><span class=\"line\">    [Command-Response Delta: 1630.81ms]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 1278\t48.812485\thost\tcontroller\tHCI_CMD\t6\tSent Authentication Requested</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - Authentication Requested</span><br><span class=\"line\">    Command Opcode: Authentication Requested (0x0411)</span><br><span class=\"line\">    Parameter Total Length: 2</span><br><span class=\"line\">    Connection Handle: 0x0033</span><br><span class=\"line\">    [Pending in frame: 1279]</span><br><span class=\"line\">    [Command-Pending Delta: 0.945ms]</span><br><span class=\"line\">    [Response in frame: 1283]</span><br><span class=\"line\">    [Command-Response Delta: 16.693ms]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 1280\t48.813892\tcontroller\thost\tHCI_EVT\t9\tRcvd Link Key Request</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Link Key Request</span><br><span class=\"line\">    Event Code: Link Key Request (0x17)</span><br><span class=\"line\">    Parameter Total Length: 6</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 1281\t48.814039\thost\tcontroller\tHCI_CMD\t26\tSent Link Key Request Reply</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - Link Key Request Reply</span><br><span class=\"line\">    Command Opcode: Link Key Request Reply (0x040b)</span><br><span class=\"line\">    Parameter Total Length: 22</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Link Key: 2160acf6b7403a97050f64de72570b1d</span><br><span class=\"line\">    [Response in frame: 1282]</span><br><span class=\"line\">    [Command-Response Delta: 1.336ms]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 1282\t48.815375\tcontroller\thost\tHCI_EVT\t13\tRcvd Command Complete (Link Key Request Reply)</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Command Complete</span><br><span class=\"line\">    Event Code: Command Complete (0x0e)</span><br><span class=\"line\">    Parameter Total Length: 10</span><br><span class=\"line\">    Number of Allowed Command Packets: 1</span><br><span class=\"line\">    Command Opcode: Link Key Request Reply (0x040b)</span><br><span class=\"line\">    Status: Success (0x00)</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    [Command in frame: 1281]</span><br><span class=\"line\">    [Command-Response Delta: 1.336ms]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 1283\t48.829178\tcontroller\thost\tHCI_EVT\t6\tRcvd Authentication Complete</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Authentication Complete</span><br><span class=\"line\">    Event Code: Authentication Complete (0x06)</span><br><span class=\"line\">    Parameter Total Length: 3</span><br><span class=\"line\">    Status: Success (0x00)</span><br><span class=\"line\">    Connection Handle: 0x0033</span><br><span class=\"line\">    [Command in frame: 1278]</span><br><span class=\"line\">    [Pending in frame: 1279]</span><br><span class=\"line\">    [Pending-Response Delta: 15.748ms]</span><br><span class=\"line\">    [Command-Response Delta: 16.693ms]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h5 id=\"被连接\"><a href=\"#被连接\" class=\"headerlink\" title=\"被连接\"></a>被连接</h5><ul>\n<li><p><strong>Host</strong>:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LocalBluetoothManager.getInstance().getEventManager().registerCallback(<span class=\"keyword\">new</span> <span class=\"title class_\">BluetoothCallback</span>() &#123;</span><br><span class=\"line\">   \t\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onConnectionStateChanged</span><span class=\"params\">(CachedBluetoothDevice cachedDevice, <span class=\"type\">int</span> bondState)</span> &#123;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>Controller</strong>:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 1900\t62.151696\tcontroller\thost\tHCI_EVT\t13\tRcvd Connect Request</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Connect Request</span><br><span class=\"line\">    Event Code: Connect Request (0x04)</span><br><span class=\"line\">    Parameter Total Length: 10</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Class of Device: 0x5a020c (Phone:Smartphone - services: Networking Capturing ObjectTransfer Telephony)</span><br><span class=\"line\">    Link Type: ACL connection (Data Channels) (0x01)</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 1901\t62.152042\thost\tcontroller\tHCI_CMD\t11\tSent Accept Connection Request</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - Accept Connection Request</span><br><span class=\"line\">    Command Opcode: Accept Connection Request (0x0409)</span><br><span class=\"line\">    Parameter Total Length: 7</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Role: Remain the Slave for this connection. The LM will NOT perform the role switch. (0x01)</span><br><span class=\"line\">    [Pending in frame: 1902]</span><br><span class=\"line\">    [Command-Pending Delta: 0.748ms]</span><br><span class=\"line\">    [Response in frame: 1903]</span><br><span class=\"line\">    [Command-Response Delta: 4.455ms]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 1903\t62.156497\tcontroller\thost\tHCI_EVT\t14\tRcvd Connect Complete</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Connect Complete</span><br><span class=\"line\">    Event Code: Connect Complete (0x03)</span><br><span class=\"line\">    Parameter Total Length: 11</span><br><span class=\"line\">    Status: Success (0x00)</span><br><span class=\"line\">    Connection Handle: 0x0032</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Link Type: ACL connection (Data Channels) (0x01)</span><br><span class=\"line\">    Encryption Mode: Encryption Disabled (0x00)</span><br><span class=\"line\">    [Command in frame: 1901]</span><br><span class=\"line\">    [Pending in frame: 1902]</span><br><span class=\"line\">    [Pending-Response Delta: 3.707ms]</span><br><span class=\"line\">    [Command-Response Delta: 4.455ms]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 1968\t62.415419\tcontroller\thost\tHCI_EVT\t9\tRcvd Link Key Request</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Link Key Request</span><br><span class=\"line\">    Event Code: Link Key Request (0x17)</span><br><span class=\"line\">    Parameter Total Length: 6</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 1969\t62.415629\thost\tcontroller\tHCI_CMD\t26\tSent Link Key Request Reply</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - Link Key Request Reply</span><br><span class=\"line\">    Command Opcode: Link Key Request Reply (0x040b)</span><br><span class=\"line\">    Parameter Total Length: 22</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Link Key: 2160acf6b7403a97050f64de72570b1d</span><br><span class=\"line\">    [Response in frame: 1971]</span><br><span class=\"line\">    [Command-Response Delta: 0.934ms]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 1971\t62.416563\tcontroller\thost\tHCI_EVT\t13\tRcvd Command Complete (Link Key Request Reply)</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Command Complete</span><br><span class=\"line\">    Event Code: Command Complete (0x0e)</span><br><span class=\"line\">    Parameter Total Length: 10</span><br><span class=\"line\">    Number of Allowed Command Packets: 1</span><br><span class=\"line\">    Command Opcode: Link Key Request Reply (0x040b)</span><br><span class=\"line\">    Status: Success (0x00)</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    [Command in frame: 1969]</span><br><span class=\"line\">    [Command-Response Delta: 0.934ms]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"SCO\"><a href=\"#SCO\" class=\"headerlink\" title=\"SCO\"></a>SCO</h3><blockquote>\n<p>BLUETOOTH SPECIFICATION Version 4.2 [Vol 1, Part A] page 64  </p>\n<p>The synchronous connection-oriented (SCO) logical transport is a symmetric,<br>point-to-point transport between the master and a specific slave. The SCO<br>logical transport reserves slots on the physical channel and can therefore be<br>considered as a circuit-switched connection between the master and the slave.<br>SCO logical transports carry 64 kb&#x2F;s of information synchronized with the<br>piconet clock. Typically this information is an encoded voice stream. Three<br>different SCO configurations exist, offering a balance between robustness,<br>delay and bandwidth consumption.  </p>\n</blockquote>\n<p>SCO全称<strong>BR&#x2F;EDR Synchronous Connection-Oriented</strong>，利用保留时隙传送数据包。连接建立后，主设备和从设备可以不被选中就发送SCO数据包。SCO数据包既可以传送话音，也可以传送数据，但在传送数据时，只用于重发被损坏的那部分的数据。</p>\n<h3 id=\"L2CAP\"><a href=\"#L2CAP\" class=\"headerlink\" title=\"L2CAP\"></a>L2CAP</h3><blockquote>\n<p>BLUETOOTH SPECIFICATION Version 4.2 [Vol 3, Part A] page 30  </p>\n<p>L2CAP（Logical Link Control and Adaptation Protocol）：逻辑链路控制与适配协议，将ACL数据分组交换为便于高层应用的数据分组格式，并提供协议复用和服务质量交换等功能。</p>\n<p>通过协议多路复用、分段重组操作和组概念,向高层提供面向连接的和无连接的数据服务,L2CAP还屏蔽了低层传输协议中的很多特性，使得高层协议应用开发人员可以不必了解基层协议而进行开发。</p>\n</blockquote>\n<p><img src=\"https://s1.ax1x.com/2022/04/11/LV6sKg.png\"></p>\n<p>从架构图可以看出，L2CAP位于HCI与上层业务之间，在建立物理连接(ACL)之后，上层业务的通信和控制都由L2CAP协议与微微网(piconet )中其它蓝牙设备进行交互，类似HTTP协议的存在。</p>\n<p>下图概括了两个设备L2CAP之间的连接过程：</p>\n<p><img src=\"https://s1.ax1x.com/2022/04/11/LV6UUI.png\"></p>\n<h3 id=\"SDP\"><a href=\"#SDP\" class=\"headerlink\" title=\"SDP\"></a>SDP</h3><blockquote>\n<p>BLUETOOTH SPECIFICATION Version 4.2 [Vol 3, Part B] page 222  </p>\n<p>The service discovery mechanism provides the means for client applications to<br>discover the existence of services provided by server applications as well as<br>the attributes of those services. The attributes of a service include the type or<br>class of service offered and the mechanism or protocol information needed to<br>utilize the service.  </p>\n</blockquote>\n<p>全称是<strong>Service Discovery Protocol</strong>，服务发现协议，服务发现协议(SDP)为应用程序提供了一种方法来发现哪些服务可用，并确定这些可用服务的特征。</p>\n<p><img src=\"https://s1.ax1x.com/2022/04/11/LV66bj.png\"></p>\n<p>从上图可知蓝牙设备中同时存在一个Client和Server，通过L2CAP协议与别的设备时行交互，通过<code>Service Search Attribute Request   </code>命令查询对方设备支持的蓝牙服务，其工作流程如图：</p>\n<p><img src=\"https://s1.ax1x.com/2022/04/11/LV6a5t.png\"></p>\n<p>通过HCI可以看到发现蓝牙服务过过程中的数据：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 455\t22.824346\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tSDP\t29\tSent Service Search Attribute Request : L2CAP: Attribute Range (0x0000 - 0xffff) </span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Frame 455: 29 bytes on wire (232 bits), 29 bytes captured (232 bits)</span><br><span class=\"line\">Bluetooth</span><br><span class=\"line\">Bluetooth HCI H4</span><br><span class=\"line\">Bluetooth HCI ACL Packet</span><br><span class=\"line\">Bluetooth L2CAP Protocol</span><br><span class=\"line\">Bluetooth SDP Protocol</span><br><span class=\"line\">    PDU: Service Search Attribute Request (0x06)</span><br><span class=\"line\">    Transaction Id: 0x0000</span><br><span class=\"line\">    Parameter Length: 15</span><br><span class=\"line\">    Service Search Pattern: L2CAP</span><br><span class=\"line\">    Maximum Attribute Byte Count: 1008</span><br><span class=\"line\">    Attribute ID List</span><br><span class=\"line\">        Data Element: Sequence uint8 5 bytes</span><br><span class=\"line\">            0011 0... = Data Element Type: Sequence (6)</span><br><span class=\"line\">            .... .101 = Data Element Size: uint8 (5)</span><br><span class=\"line\">            Data Element Var Size: 5</span><br><span class=\"line\">            Data Value</span><br><span class=\"line\">                Data Element: Unsigned Integer 4 bytes</span><br><span class=\"line\">                    0000 1... = Data Element Type: Unsigned Integer (1)</span><br><span class=\"line\">                    .... .010 = Data Element Size: 4 bytes (2)</span><br><span class=\"line\">                    Data Value</span><br><span class=\"line\">                        Attribute Range: 0x0000ffff</span><br><span class=\"line\">                            Attribute Range From: 0x0000</span><br><span class=\"line\">                            Attribute Range To: 0xffff</span><br><span class=\"line\">    Continuation State: no (00)</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 471\t22.896191\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tSDP\t281\tRcvd Service Search Attribute Response</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Frame 471: 281 bytes on wire (2248 bits), 281 bytes captured (2248 bits)</span><br><span class=\"line\">Bluetooth</span><br><span class=\"line\">Bluetooth HCI H4</span><br><span class=\"line\">Bluetooth HCI ACL Packet</span><br><span class=\"line\">Bluetooth L2CAP Protocol</span><br><span class=\"line\">Bluetooth SDP Protocol</span><br><span class=\"line\">    PDU: Service Search Attribute Response (0x07)</span><br><span class=\"line\">    Transaction Id: 0x0001</span><br><span class=\"line\">    Parameter Length: 267</span><br><span class=\"line\">    Attribute List Byte Count: 264</span><br><span class=\"line\">    Data Fragment</span><br><span class=\"line\">    Continuation State: no (00)</span><br><span class=\"line\">    [Reassembled Attribute List]</span><br><span class=\"line\">        Attribute Lists [count = 14]</span><br><span class=\"line\">            Data Element: Sequence uint16 1269 bytes</span><br><span class=\"line\">                0011 0... = Data Element Type: Sequence (6)</span><br><span class=\"line\">                .... .110 = Data Element Size: uint16 (6)</span><br><span class=\"line\">                Data Element Var Size: 1269</span><br><span class=\"line\">                Data Value</span><br><span class=\"line\">                    Attribute List [count =  4] (Generic Attribute Profile)</span><br><span class=\"line\">                    Attribute List [count =  4] (Generic Access Profile)</span><br><span class=\"line\">                    Attribute List [count =  6] (Headset Audio Gateway)</span><br><span class=\"line\">                    Attribute List [count =  8] (Handsfree Audio Gateway)</span><br><span class=\"line\">                    Attribute List [count =  8] (A/V Remote Control Target)</span><br><span class=\"line\">                    Attribute List [count =  7] (Audio Source)</span><br><span class=\"line\">                    Attribute List [count = 11] (PAN NAP)</span><br><span class=\"line\">                    Attribute List [count =  9] (PAN PANU)</span><br><span class=\"line\">                    Attribute List [count =  7] (Phonebook Access Server)</span><br><span class=\"line\">                    Attribute List [count = 10] (Message Access Server)</span><br><span class=\"line\">                    Attribute List [count =  4] (Xiaomi Inc.)</span><br><span class=\"line\">                    Attribute List [count =  5] (CustomUUID: Unknown)</span><br><span class=\"line\">                    Attribute List [count =  8] (OBEX Object Push)</span><br><span class=\"line\">                    Attribute List [count =  4] (Unknown)</span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"蓝牙电话\"><a href=\"#蓝牙电话\" class=\"headerlink\" title=\"蓝牙电话\"></a>蓝牙电话</h1><h2 id=\"PBAP-RFCOMM-x2F-OBEX\"><a href=\"#PBAP-RFCOMM-x2F-OBEX\" class=\"headerlink\" title=\"PBAP(RFCOMM&#x2F;OBEX)\"></a>PBAP(RFCOMM&#x2F;OBEX)</h2><blockquote>\n<p>RFCOMM协议提供了对L2CAP协议上的串行端口的模拟。该协议基于ETSI标准GSM 07.10。</p>\n<p>OBEX：Object Exchange的简称，对象交换协议，来源于红外通讯协议，但又不局限于具体的传输方式，后来被蓝牙组织SIG吸纳其中部分并进行优化处理作为蓝牙协议中的OBEX层用于蓝牙设备间的文件数据传输，如蓝牙传输文件（OPP）、同步电话簿（PBAP）和同步短信（MAP）等场景下都是以OBEX协议组织相关数据进行传输的。</p>\n</blockquote>\n<p>PBAP: Phone Book Access Profile的简称，<strong>电话本访问协议</strong>，用于同步手机这些具有电话本功能设备上的通讯录和通话记录等。</p>\n<p>RFCOMM&#x2F;OBEX和协议不属于蓝牙定义的规范 ，只是被蓝牙采纳，而PBAP协议包在OBEX协议之上封装而成。</p>\n<h3 id=\"PBAP虚拟文件夹架构\"><a href=\"#PBAP虚拟文件夹架构\" class=\"headerlink\" title=\"PBAP虚拟文件夹架构\"></a>PBAP虚拟文件夹架构</h3><p>PBAP中通话数据文件是在虚拟文件夹架构下，访问通话数据时需要指定路径，下图为官方架构图：</p>\n<p><img src=\"https://s1.ax1x.com/2022/04/11/LV6yrQ.png\"></p>\n<p>其中vcf的文件名称意义如下：</p>\n<p><img src=\"https://s1.ax1x.com/2022/04/11/LV6gVs.png\"></p>\n<h3 id=\"建立连接-x2F-断开连接\"><a href=\"#建立连接-x2F-断开连接\" class=\"headerlink\" title=\"建立连接&#x2F;断开连接\"></a>建立连接&#x2F;断开连接</h3><p>只使用OBEX协议</p>\n<h4 id=\"连接-1\"><a href=\"#连接-1\" class=\"headerlink\" title=\"连接\"></a>连接</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 798\t23.907353\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t40\tSent Connect - Phone Book Access Profile</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Frame 798: 40 bytes on wire (320 bits), 40 bytes captured (320 bits)</span><br><span class=\"line\">Bluetooth</span><br><span class=\"line\">Bluetooth HCI H4</span><br><span class=\"line\">Bluetooth HCI ACL Packet</span><br><span class=\"line\">Bluetooth L2CAP Protocol</span><br><span class=\"line\">Bluetooth RFCOMM Protocol</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: ?]</span><br><span class=\"line\">    .000 0000 = Opcode: Connect (0x00)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 26</span><br><span class=\"line\">    [Response in Frame: 803]</span><br><span class=\"line\">    Version: 1.0 (0x10)</span><br><span class=\"line\">    Flags: 0x00</span><br><span class=\"line\">    Max. Packet Length: 65534</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Target: Phone Book Access Profile</span><br><span class=\"line\">            Header Id: Target (0x46)</span><br><span class=\"line\">            Length: 19</span><br><span class=\"line\">            Value: 796135f0f0c511d809660800200c9a66: Phone Book Access Profile</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 803\t23.917550\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t45\tRcvd Success - Phone Book Access Profile</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Frame 803: 45 bytes on wire (360 bits), 45 bytes captured (360 bits)</span><br><span class=\"line\">Bluetooth</span><br><span class=\"line\">Bluetooth HCI H4</span><br><span class=\"line\">Bluetooth HCI ACL Packet</span><br><span class=\"line\">Bluetooth L2CAP Protocol</span><br><span class=\"line\">Bluetooth RFCOMM Protocol</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /]</span><br><span class=\"line\">    .010 0000 = Response Code: Success (0x20)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 31</span><br><span class=\"line\">    [Request in Frame: 798]</span><br><span class=\"line\">    Version: 1.0 (0x10)</span><br><span class=\"line\">    Flags: 0x00</span><br><span class=\"line\">    Max. Packet Length: 65534</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\">        Who: Phone Book Access Profile</span><br><span class=\"line\">            Header Id: Who (0x4a)</span><br><span class=\"line\">            Length: 19</span><br><span class=\"line\">            Value: 796135f0f0c511d809660800200c9a66: Phone Book Access Profile</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"断开\"><a href=\"#断开\" class=\"headerlink\" title=\"断开\"></a>断开</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 1142\t58.752933\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t22\tSent Disconnect</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /]</span><br><span class=\"line\">    .000 0001 = Opcode: Disconnect (0x01)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 8</span><br><span class=\"line\">    [Response in Frame: 1164]</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 1164\t59.162598\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t22\tRcvd Success</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /]</span><br><span class=\"line\">    .010 0000 = Response Code: Success (0x20)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 8</span><br><span class=\"line\">    [Request in Frame: 1142]</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"设置访问虚拟文件夹路径\"><a href=\"#设置访问虚拟文件夹路径\" class=\"headerlink\" title=\"设置访问虚拟文件夹路径\"></a>设置访问虚拟文件夹路径</h3><p>在[PBAP协议规范]的<code>5.2 SetPhoneBook Function</code>章节，使用OBEX协议SetPath命令，通过obex.opcode&#x3D;<strong>0x05</strong>判断。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># $/</span><br><span class=\"line\">&gt; 808\t24.023528\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t27\tSent Set Path &quot;&quot;</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /]</span><br><span class=\"line\">    .000 0101 = Opcode: Set Path (0x05)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 13</span><br><span class=\"line\">    [Response in Frame: 810]</span><br><span class=\"line\">    Flags: 0x02</span><br><span class=\"line\">    .... ...0 = Go back one folder (../) first: False</span><br><span class=\"line\">    .... ..1. = Do not create folder, if not existing: True</span><br><span class=\"line\">    Constants: 0x00</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\">        Name: &quot;&quot;</span><br><span class=\"line\">            Header Id: Name (0x01)</span><br><span class=\"line\">            Length: 3</span><br><span class=\"line\">            Name: </span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 810\t24.065127\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t22\tRcvd Success</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /]</span><br><span class=\"line\">    .010 0000 = Response Code: Success (0x20)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 8</span><br><span class=\"line\">    [Request in Frame: 808]</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\"></span><br><span class=\"line\"># $/telecom/</span><br><span class=\"line\">&gt; 811\t24.078180\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t43\tSent Set Path &quot;telecom&quot;</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"获取通讯录数量\"><a href=\"#获取通讯录数量\" class=\"headerlink\" title=\"获取通讯录数量\"></a>获取通讯录数量</h3><p>在[PBAP协议规范]的<code>5.3 PullvCardListing Function</code>章节，通过obex.header&#x3D;**&lt;x-bt&#x2F;vcard-listing&gt;**判断。</p>\n<h4 id=\"手机\"><a href=\"#手机\" class=\"headerlink\" title=\"手机\"></a>手机</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 808\t24.023528\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t27\tSent Set Path &quot;&quot;</span><br><span class=\"line\">&gt; 811\t24.078180\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t43\tSent Set Path &quot;telecom&quot;</span><br><span class=\"line\"># $/telecom/pb/</span><br><span class=\"line\">&gt; 816\t24.118267\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t70\tSent Get final &quot;pb&quot;</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /telecom]</span><br><span class=\"line\">    .000 0011 = Opcode: Get (0x03)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 56</span><br><span class=\"line\">    [Response in Frame: 818]</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\">        Name: &quot;pb&quot;</span><br><span class=\"line\">            Header Id: Name (0x01)</span><br><span class=\"line\">            Length: 9</span><br><span class=\"line\">            Name: pb</span><br><span class=\"line\">        Type: &quot;x-bt/vcard-listing&quot;</span><br><span class=\"line\">            Header Id: Type (0x42)</span><br><span class=\"line\">            Length: 22</span><br><span class=\"line\">            Type: x-bt/vcard-listing</span><br><span class=\"line\">        Application Parameters</span><br><span class=\"line\">            Header Id: Application Parameters (0x4c)</span><br><span class=\"line\">            Length: 17</span><br><span class=\"line\">            Parameter: Order #排序规则: &#123; Alphabetical | Indexed | Phonetical &#125;</span><br><span class=\"line\">                Parameter Id: Order (0x01)</span><br><span class=\"line\">                Parameter Length: 1</span><br><span class=\"line\">                Max List Count: Indexed (0x00)</span><br><span class=\"line\">            Parameter: Search Attribute #搜索:  &#123;Name | Number | Sound &#125; 与 SearchValue配合，默认为Name</span><br><span class=\"line\">                Parameter Id: Search Attribute (0x03)</span><br><span class=\"line\">                Parameter Length: 1</span><br><span class=\"line\">                Search Attribute: Name (0x00)</span><br><span class=\"line\">            Parameter: Max List Count #最大条目数</span><br><span class=\"line\">                Parameter Id: Max List Count (0x04)</span><br><span class=\"line\">                Parameter Length: 2</span><br><span class=\"line\">                Max List Count: 0 (0x0000)</span><br><span class=\"line\">            Parameter: List Start Offset #偏移量</span><br><span class=\"line\">                Parameter Id: List Start Offset (0x05)</span><br><span class=\"line\">                Parameter Length: 2</span><br><span class=\"line\">                List Start Offset: 0 (0x0000)</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 818\t24.332995\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t29\tRcvd Success</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /telecom]</span><br><span class=\"line\">    .010 0000 = Response Code: Success (0x20)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 15</span><br><span class=\"line\">    [Request in Frame: 816]</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\">        Application Parameters</span><br><span class=\"line\">            Header Id: Application Parameters (0x4c)</span><br><span class=\"line\">            Length: 7</span><br><span class=\"line\">            Parameter: Phonebook Size</span><br><span class=\"line\">                Parameter Id: Phonebook Size (0x08)</span><br><span class=\"line\">                Parameter Length: 2</span><br><span class=\"line\">                Phonebook Size: 71 (0x0047)</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"SIM1\"><a href=\"#SIM1\" class=\"headerlink\" title=\"SIM1\"></a>SIM1</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 819\t24.336294\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t27\tSent Set Path &quot;&quot;</span><br><span class=\"line\">&gt; 822\t24.379640\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t27\tSent Set Path &quot;&quot;</span><br><span class=\"line\">&gt; 825\t24.430836\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t37\tSent Set Path &quot;SIM1&quot;</span><br><span class=\"line\">&gt; 828\t24.481559\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t43\tSent Set Path &quot;telecom&quot;</span><br><span class=\"line\"># $/SIM1/telecom/pb/</span><br><span class=\"line\">&gt; 831\t24.532312\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t70\tSent Get final &quot;pb&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 833\t24.578831\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t29\tRcvd Success</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /SIM1/telecom]</span><br><span class=\"line\">    .010 0000 = Response Code: Success (0x20)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 15</span><br><span class=\"line\">    [Request in Frame: 831]</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\">        Application Parameters</span><br><span class=\"line\">            Header Id: Application Parameters (0x4c)</span><br><span class=\"line\">            Length: 7</span><br><span class=\"line\">            Parameter: Phonebook Size</span><br><span class=\"line\">                Parameter Id: Phonebook Size (0x08)</span><br><span class=\"line\">                Parameter Length: 2</span><br><span class=\"line\">                Phonebook Size: 1 (0x0001)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"获取通讯录\"><a href=\"#获取通讯录\" class=\"headerlink\" title=\"获取通讯录\"></a>获取通讯录</h3><p>在[PBAP协议规范]的<code>5.3 PullvCardListing Function</code>章节，通过obex.header&#x3D;<strong>&lt;x-bt&#x2F;phonebook&gt;</strong> 判断，分页获取vCard格式。</p>\n<h4 id=\"手机-1\"><a href=\"#手机-1\" class=\"headerlink\" title=\"手机\"></a>手机</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 834\t24.580643\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t27\tSent Set Path &quot;&quot;</span><br><span class=\"line\">#分页请求获取通讯录，从第1条数据开始，每页最多50条</span><br><span class=\"line\">&gt; 837\t24.632264\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t97\tSent Get final &quot;telecom/pb.vcf&quot;</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /]</span><br><span class=\"line\">    .000 0011 = Opcode: Get (0x03)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 83</span><br><span class=\"line\">    [Response in Frame: 844]</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\">        Name: &quot;telecom/pb.vcf&quot;</span><br><span class=\"line\">            Header Id: Name (0x01)</span><br><span class=\"line\">            Length: 33</span><br><span class=\"line\">            Name: telecom/pb.vcf</span><br><span class=\"line\">        Type: &quot;x-bt/phonebook&quot;</span><br><span class=\"line\">            Header Id: Type (0x42)</span><br><span class=\"line\">            Length: 18</span><br><span class=\"line\">            Type: x-bt/phonebook</span><br><span class=\"line\">        Application Parameters</span><br><span class=\"line\">            Header Id: Application Parameters (0x4c)</span><br><span class=\"line\">            Length: 24</span><br><span class=\"line\">            Parameter: Max List Count #最大条目数,这里只读取50条</span><br><span class=\"line\">                Parameter Id: Max List Count (0x04)</span><br><span class=\"line\">                Parameter Length: 2</span><br><span class=\"line\">                Max List Count: 50 (0x0032)</span><br><span class=\"line\">            Parameter: List Start Offset #偏移量，这是从第1条开始读取</span><br><span class=\"line\">                Parameter Id: List Start Offset (0x05)</span><br><span class=\"line\">                Parameter Length: 2</span><br><span class=\"line\">                List Start Offset: 1 (0x0001)</span><br><span class=\"line\">            Parameter: Filter #用于指示所请求的vCard中包含的属性</span><br><span class=\"line\">                Parameter Id: Filter (0x06)</span><br><span class=\"line\">                Parameter Length: 8</span><br><span class=\"line\">                Filter: 0x00000000</span><br><span class=\"line\">                Filter: 0x008001af, vCard Version, Formatted Name, Structured Presentation of Name, Associated Image or Photo, Delivery Address, Telephone Number, Electronic Mail Address, Nickname</span><br><span class=\"line\">            Parameter: Format #vCard文件格式版本，这是3.0</span><br><span class=\"line\">                Parameter Id: Format (0x07)</span><br><span class=\"line\">                Parameter Length: 1</span><br><span class=\"line\">                Format: 3.0 (0x01)</span><br><span class=\"line\"></span><br><span class=\"line\">#传输数据片段</span><br><span class=\"line\">&gt; 839\t24.764415\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t1004\tRcvd OBEX fragment</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Frame 839: 1004 bytes on wire (8032 bits), 1004 bytes captured (8032 bits)</span><br><span class=\"line\">Bluetooth</span><br><span class=\"line\">Bluetooth HCI H4</span><br><span class=\"line\">Bluetooth HCI ACL Packet</span><br><span class=\"line\">Bluetooth L2CAP Protocol</span><br><span class=\"line\">Bluetooth RFCOMM Protocol</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /]</span><br><span class=\"line\">    [Reassembled OBEX in frame: 844]</span><br><span class=\"line\">    Data (990 bytes)</span><br><span class=\"line\"></span><br><span class=\"line\">...</span><br><span class=\"line\">#传输成功</span><br><span class=\"line\">&gt; 844\t24.794969\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t182\tRcvd Success (x-bt/phonebook)</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /]</span><br><span class=\"line\">    [6 OBEX Fragments (5117 bytes): #839(990), #840(990), #841(990), #842(990), #843(990), #844(167)] #6个数据片段，需要拼接对应Frame</span><br><span class=\"line\">    .010 0000 = Response Code: Success (0x20)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 5117</span><br><span class=\"line\">    [Request in Frame: 837]</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\">        End Of Body</span><br><span class=\"line\">            Header Id: End Of Body (0x49)</span><br><span class=\"line\">            Length: 5109</span><br><span class=\"line\">            Value: 424547494e3a56434152440d0a56455253494f4e3a332e300d0a4e3ae591a83be4baa6e6…</span><br><span class=\"line\">    Line-based text data: x-bt/phonebook (320 lines)</span><br><span class=\"line\">        BEGIN:VCARD\\r\\n</span><br><span class=\"line\">        VERSION:3.0\\r\\n</span><br><span class=\"line\">        N:张;三;;;\\r\\n</span><br><span class=\"line\">        FN:张三\\r\\n</span><br><span class=\"line\">        TEL;TYPE=CELL:22222222\\r\\n</span><br><span class=\"line\">        END:VCARD\\r\\n</span><br><span class=\"line\">        BEGIN:VCARD\\r\\n</span><br><span class=\"line\">        VERSION:3.0\\r\\n</span><br><span class=\"line\">        N:李四;;;;\\r\\n</span><br><span class=\"line\">        FN:李四\\r\\n</span><br><span class=\"line\">        TEL;TYPE=CELL:11111111\\r\\n</span><br><span class=\"line\">        END:VCARD\\r\\n</span><br><span class=\"line\"></span><br><span class=\"line\">#请求获取vCard 3.0格式，并从第51条数据开始，最多50条</span><br><span class=\"line\">&gt; 847\t24.875858\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t96\tSent Get final &quot;telecom/pb.vcf&quot;</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /]</span><br><span class=\"line\">    .000 0011 = Opcode: Get (0x03)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 83</span><br><span class=\"line\">    [Response in Frame: 850]</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\">        Name: &quot;telecom/pb.vcf&quot;</span><br><span class=\"line\">            Header Id: Name (0x01)</span><br><span class=\"line\">            Length: 33</span><br><span class=\"line\">            Name: telecom/pb.vcf</span><br><span class=\"line\">        Type: &quot;x-bt/phonebook&quot;</span><br><span class=\"line\">            Header Id: Type (0x42)</span><br><span class=\"line\">            Length: 18</span><br><span class=\"line\">            Type: x-bt/phonebook</span><br><span class=\"line\">        Application Parameters</span><br><span class=\"line\">            Header Id: Application Parameters (0x4c)</span><br><span class=\"line\">            Length: 24</span><br><span class=\"line\">            Parameter: Max List Count</span><br><span class=\"line\">                Parameter Id: Max List Count (0x04)</span><br><span class=\"line\">                Parameter Length: 2</span><br><span class=\"line\">                Max List Count: 50 (0x0032)</span><br><span class=\"line\">            Parameter: List Start Offset</span><br><span class=\"line\">                Parameter Id: List Start Offset (0x05)</span><br><span class=\"line\">                Parameter Length: 2</span><br><span class=\"line\">                List Start Offset: 51 (0x0033)</span><br><span class=\"line\">            Parameter: Filter</span><br><span class=\"line\">                Parameter Id: Filter (0x06)</span><br><span class=\"line\">                Parameter Length: 8</span><br><span class=\"line\">                Filter: 0x00000000</span><br><span class=\"line\">                Filter: 0x008001af, vCard Version, Formatted Name, Structured Presentation of Name, Associated Image or Photo, Delivery Address, Telephone Number, Electronic Mail Address, Nickname</span><br><span class=\"line\">            Parameter: Format</span><br><span class=\"line\">                Parameter Id: Format (0x07)</span><br><span class=\"line\">                Parameter Length: 1</span><br><span class=\"line\">                Format: 3.0 (0x01)</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 849\t24.953425\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t1004\tRcvd OBEX fragment</span><br><span class=\"line\"></span><br><span class=\"line\"># 刚刚通过`Sent Get final &quot;pb&quot;`获取手机通讯录只有71条，现在只剩下21，这次就可以传输完成。</span><br><span class=\"line\">&gt; 850\t24.960363\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t940\tRcvd Success (x-bt/phonebook)</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /]</span><br><span class=\"line\">    [2 OBEX Fragments (1915 bytes): #849(990), #850(925)]</span><br><span class=\"line\">    .010 0000 = Response Code: Success (0x20)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 1915</span><br><span class=\"line\">    [Request in Frame: 847]</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\">        End Of Body</span><br><span class=\"line\">            Header Id: End Of Body (0x49)</span><br><span class=\"line\">            Length: 1907</span><br><span class=\"line\">            Value: 424547494e3a56434152440d0a56455253494f4e3a332e300d0a4e3ae4bd993be4bf8ae7…</span><br><span class=\"line\">    Line-based text data: x-bt/phonebook (122 lines)</span><br><span class=\"line\">        BEGIN:VCARD\\r\\n</span><br><span class=\"line\">        VERSION:3.0\\r\\n</span><br><span class=\"line\">        N:张;三;;;\\r\\n</span><br><span class=\"line\">        FN:张三\\r\\n</span><br><span class=\"line\">        TEL;TYPE=CELL:22222222\\r\\n</span><br><span class=\"line\">        END:VCARD\\r\\n</span><br><span class=\"line\">        BEGIN:VCARD\\r\\n</span><br><span class=\"line\">        VERSION:3.0\\r\\n</span><br><span class=\"line\">        N:李四;;;;\\r\\n</span><br><span class=\"line\">        FN:李四\\r\\n</span><br><span class=\"line\">        TEL;TYPE=CELL:11111111\\r\\n</span><br><span class=\"line\">        END:VCARD\\r\\n</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"SIM1-1\"><a href=\"#SIM1-1\" class=\"headerlink\" title=\"SIM1\"></a>SIM1</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 866\t25.021131\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t107\tSent Get final &quot;SIM1/telecom/pb.vcf&quot;</span><br><span class=\"line\">#这里手机直接拒绝了</span><br><span class=\"line\">&gt; 868\t25.032728\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t25\tRcvd Success</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /]</span><br><span class=\"line\">    .010 0000 = Response Code: Success (0x20)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 11</span><br><span class=\"line\">    [Request in Frame: 866]</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\">        End Of Body</span><br><span class=\"line\">            Header Id: End Of Body (0x49)</span><br><span class=\"line\">            Length: 3</span><br><span class=\"line\">            Value: &lt;MISSING&gt;</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"获取通话记录\"><a href=\"#获取通话记录\" class=\"headerlink\" title=\"获取通话记录\"></a>获取通话记录</h3><p>在[PBAP协议规范]的<code>5.3 PullvCardListing Function</code>章节，通过obex.header&#x3D;<strong>&lt;x-bt&#x2F;phonebook&gt;</strong> 判断，分页获取vCard格式。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 869\t25.071027\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t27\tSent Set Path &quot;&quot;</span><br><span class=\"line\">&gt; 882\t25.125323\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t43\tSent Set Path &quot;telecom&quot;</span><br><span class=\"line\"># $/telecom/cch/</span><br><span class=\"line\">&gt; 887\t25.138796\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t72\tSent Get final &quot;cch&quot;</span><br><span class=\"line\">&gt; 895\t25.222650\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t29\tRcvd Success</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /telecom]</span><br><span class=\"line\">    .010 0000 = Response Code: Success (0x20)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 15</span><br><span class=\"line\">    [Request in Frame: 887]</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\">        Application Parameters</span><br><span class=\"line\">            Header Id: Application Parameters (0x4c)</span><br><span class=\"line\">            Length: 7</span><br><span class=\"line\">            Parameter: Phonebook Size</span><br><span class=\"line\">                Parameter Id: Phonebook Size (0x08)</span><br><span class=\"line\">                Parameter Length: 2</span><br><span class=\"line\">                Phonebook Size: 2177 (0x0881)</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 897\t25.225643\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t27\tSent Set Path &quot;&quot;</span><br><span class=\"line\">#分页获取通话记录，从第0条开始，每页最多50条</span><br><span class=\"line\">&gt; 919\t25.279427\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t85\tSent Get final &quot;telecom/cch.vcf&quot;</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /]</span><br><span class=\"line\">    .000 0011 = Opcode: Get (0x03)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 71</span><br><span class=\"line\">    [Response in Frame: 935]</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\">        Name: &quot;telecom/cch.vcf&quot;</span><br><span class=\"line\">            Header Id: Name (0x01)</span><br><span class=\"line\">            Length: 35</span><br><span class=\"line\">            Name: telecom/cch.vcf</span><br><span class=\"line\">        Type: &quot;x-bt/phonebook&quot;</span><br><span class=\"line\">            Header Id: Type (0x42)</span><br><span class=\"line\">            Length: 18</span><br><span class=\"line\">            Type: x-bt/phonebook</span><br><span class=\"line\">        Application Parameters</span><br><span class=\"line\">            Header Id: Application Parameters (0x4c)</span><br><span class=\"line\">            Length: 10</span><br><span class=\"line\">            Parameter: Max List Count</span><br><span class=\"line\">                Parameter Id: Max List Count (0x04)</span><br><span class=\"line\">                Parameter Length: 2</span><br><span class=\"line\">                Max List Count: 50 (0x0032)</span><br><span class=\"line\">            Parameter: Format</span><br><span class=\"line\">                Parameter Id: Format (0x07)</span><br><span class=\"line\">                Parameter Length: 1</span><br><span class=\"line\">                Format: 3.0 (0x01)</span><br><span class=\"line\">&gt; 935\t25.381127\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t132\tRcvd Success (x-bt/phonebook)</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /]</span><br><span class=\"line\">    [8 OBEX Fragments (7048 bytes): #926(990), #927(990), #928(990), #929(990), #930(990), #931(990), #934(990), #935(118)]</span><br><span class=\"line\">    .010 0000 = Response Code: Success (0x20)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 7048</span><br><span class=\"line\">    [Request in Frame: 919]</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\">        End Of Body</span><br><span class=\"line\">            Header Id: End Of Body (0x49)</span><br><span class=\"line\">            Length: 7040</span><br><span class=\"line\">            Value: 424547494e3a56434152440d0a56455253494f4e3a332e300d0a464e3a0d0a4e3a0d0a54…</span><br><span class=\"line\">    Line-based text data: x-bt/phonebook (350 lines)</span><br><span class=\"line\">        BEGIN:VCARD\\r\\n</span><br><span class=\"line\">        VERSION:3.0\\r\\n</span><br><span class=\"line\">        FN:\\r\\n</span><br><span class=\"line\">        N:\\r\\n</span><br><span class=\"line\">        TEL;TYPE=0:10086\\r\\n</span><br><span class=\"line\">        X-IRMC-CALL-DATETIME;TYPE=DIALED:20220317T161710\\r\\n</span><br><span class=\"line\">        END:VCARD\\r\\n</span><br><span class=\"line\">        BEGIN:VCARD\\r\\n</span><br><span class=\"line\">        VERSION:3.0\\r\\n</span><br><span class=\"line\">        FN:\\r\\n</span><br><span class=\"line\">        N:\\r\\n</span><br><span class=\"line\">        TEL;TYPE=0:02310050\\r\\n</span><br><span class=\"line\">        X-IRMC-CALL-DATETIME;TYPE=MISSED:20220316T160142\\r\\n</span><br><span class=\"line\">        END:VCARD\\r\\n</span><br><span class=\"line\"></span><br><span class=\"line\">#分页获取通话记录，从第50条开始，每页最多50条</span><br><span class=\"line\">936\t25.423573\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t89\tSent Get final &quot;telecom/cch.vcf&quot;</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /]</span><br><span class=\"line\">    .000 0011 = Opcode: Get (0x03)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 75</span><br><span class=\"line\">    [Response in Frame: 947]</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\">        Name: &quot;telecom/cch.vcf&quot;</span><br><span class=\"line\">            Header Id: Name (0x01)</span><br><span class=\"line\">            Length: 35</span><br><span class=\"line\">            Name: telecom/cch.vcf</span><br><span class=\"line\">        Type: &quot;x-bt/phonebook&quot;</span><br><span class=\"line\">            Header Id: Type (0x42)</span><br><span class=\"line\">            Length: 18</span><br><span class=\"line\">            Type: x-bt/phonebook</span><br><span class=\"line\">        Application Parameters</span><br><span class=\"line\">            Header Id: Application Parameters (0x4c)</span><br><span class=\"line\">            Length: 14</span><br><span class=\"line\">            Parameter: Max List Count</span><br><span class=\"line\">                Parameter Id: Max List Count (0x04)</span><br><span class=\"line\">                Parameter Length: 2</span><br><span class=\"line\">                Max List Count: 50 (0x0032)</span><br><span class=\"line\">            Parameter: List Start Offset</span><br><span class=\"line\">                Parameter Id: List Start Offset (0x05)</span><br><span class=\"line\">                Parameter Length: 2</span><br><span class=\"line\">                List Start Offset: 50 (0x0032)</span><br><span class=\"line\">            Parameter: Format</span><br><span class=\"line\">                Parameter Id: Format (0x07)</span><br><span class=\"line\">                Parameter Length: 1</span><br><span class=\"line\">                Format: 3.0 (0x01)</span><br><span class=\"line\">&gt; 947\t25.516478\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t810\tRcvd Success (x-bt/phonebook)</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"HFP-RFCOMM\"><a href=\"#HFP-RFCOMM\" class=\"headerlink\" title=\"HFP(RFCOMM)\"></a>HFP(RFCOMM)</h2><blockquote>\n<p>HFP(Hands-free Profile)，让蓝牙设备可以控制电话，如接听、挂断、拒接、语音拨号等，拒接、语音拨号要视蓝牙耳机及电话是否支持。</p>\n<p>目前HFP的使用场景有车载蓝牙，耳机和PDA，定义了AG和HFP两种角色。<br>AG（Audio Gate）音频网关—音频设备输入输出网关<br>HF（Hands Free）免提—该设备作为音频网关的远程音频输入&#x2F;输出机制，并可提供若干遥控功能。</p>\n</blockquote>\n<p>在车载蓝牙中，<strong>手机侧是AG</strong>，<strong>车载蓝牙侧是HF</strong>，在android源代码中，将AG侧称为HFP&#x2F;AG，将HF侧称为HFPClient&#x2F;HF。</p>\n<h3 id=\"AT命令\"><a href=\"#AT命令\" class=\"headerlink\" title=\"AT命令\"></a>AT命令</h3><p>在HFP使用AT命令控制电话，其参考3GPP 27.007标准，命令规范为：</p>\n<ul>\n<li><p>每个命令行只有一个命令</p>\n</li>\n<li><p>AG侧默认不回显命令</p>\n</li>\n<li><p>AG使用冗长的格式返回结果</p>\n</li>\n<li><p>以下字符将被用于AT命令和返回结果格式中</p>\n<ul>\n<li><p><code>&lt;cr&gt;</code> 表示回车，也就是<code>\\r</code>字符</p>\n</li>\n<li><p><code> &lt;lf&gt;</code>表示换行，也就是<code>\\n</code>字符</p>\n</li>\n</ul>\n</li>\n<li><p>从HF发送到AG的命令格式是：<code>&lt;AT command&gt; &lt;cr&gt;</code></p>\n</li>\n<li><p>从AG返回给HF的OK命令格式是：<code>&lt;cr&gt;&lt;lf&gt;OK&lt;cr&gt;&lt;lf&gt;</code></p>\n</li>\n<li><p>从AG到HF的ERROR命令是：<code>&lt;cr&gt;&lt;lf&gt;ERROR&lt;cr&gt;&lt;lf&gt;</code></p>\n</li>\n<li><p>从AG到HF的结果命令格式是：<code>&lt;cr&gt;&lt;lf&gt;&lt;result code&gt;&lt;cr&gt;&lt;lf&gt;</code></p>\n</li>\n</ul>\n<p>HFP协议复用的AT命令：</p>\n<ul>\n<li><p>ATA：标准电话应答AT命令</p>\n</li>\n<li><p>ATDdd…dd;：用电话号码打电话</p>\n</li>\n<li><p>ATD&gt;nnn…;：ATD扩展命令，记忆拨号</p>\n</li>\n<li><p>ERROR：错误指示符，语法，格式或者通信过程出错。</p>\n</li>\n<li><p>OK：命令的成功应答。</p>\n</li>\n<li><p>NO CARRIER, BUSY, NO ANSWER, DELAYED, BLACKLISTED：AT扩展命令，AG返回给HF。</p>\n</li>\n<li><p>RING：来电</p>\n</li>\n<li><p>AT+CCWA：calling waiting notification AT命令。AT+CCWA&#x3D;<code>[&lt;n&gt;[,&lt;mode&gt;[,&lt;class&gt;]]]</code>，</p>\n</li>\n<li><p>+CCWA：Call Waiting notification返回结果码。只有<code>&lt;number&gt;</code>和<code>&lt;type&gt;</code>参数对HFP有意义，<code>&lt;number&gt;</code>是由双引号及其中的文本串组成。<code>&lt;type&gt;</code>是支持的电话格式，有如下值：</p>\n<ul>\n<li><p>128~143：国家或国际格式，</p>\n</li>\n<li><p>144~159：国际电话，包括国家码前缀。</p>\n</li>\n<li><p>160-175:国家码</p>\n</li>\n<li><p>AT+CHLD：通话保持，多方处理。AT+CHLD&#x3D;<code>&lt;n&gt;</code>中<code>&lt;n&gt;</code>值覆盖0, 1, 1<code>&lt;idx&gt;</code>, 2, 2<code>&lt;idx&gt;</code>, 3 and 4,说明：</p>\n<ul>\n<li>0：释放所有保持电话或者设置用户的忙等待</li>\n<li>1：释放正在通话的电话，接听保持或等待的电话</li>\n<li>1<code>&lt;idx&gt;</code>:释放<code>&lt;idx&gt;</code>标识的电话</li>\n<li>2：将所有活跃电话设置成保持并且接受其它电话。</li>\n<li>2<code>&lt;idx&gt;</code>:请求接受<code>&lt;idx&gt;</code>标识电话，让其它电话保持。</li>\n<li>3：增加一个保持电话到对话中</li>\n<li>4：连接连个电话并且断开两个电话的订阅。HF侧可选。</li>\n</ul>\n</li>\n<li><p>AT+CHLD&#x3D;?：查询AG侧保持和多方会话。</p>\n</li>\n</ul>\n</li>\n<li><p>AT+CHUP：标准的挂断命令。AG会结束通话，也可用于拒接来电。</p>\n</li>\n<li><p>AT+CIND：<code>AT+CIND?</code>获取AG indicators当前的状态,&#96;AT+CIND&#x3D;?获取AG支持的indicator以及它们的次序。</p>\n<ul>\n<li>service: Service availability indication:<ul>\n<li><code>&lt;value&gt;=0</code> implies no service. No Home&#x2F;Roam network available.</li>\n<li><code>&lt;value&gt;=1</code> implies presence of service. Home&#x2F;Roam network available.</li>\n</ul>\n</li>\n<li>call: Standard call status indicator:  <ul>\n<li><code>&lt;value&gt;=0 </code>means there are no calls in progress  </li>\n<li><code>&lt;value&gt;=1</code> means at least one call is in progress</li>\n</ul>\n</li>\n<li>callsetup: Bluetooth proprietary call set up status indicator4. Support for this indicator is optional<br>for the HF. When supported, this indicator shall be used in conjunction with, and as an extension<br>of the standard call indicator. Possible values are as follows:  <ul>\n<li><code>&lt;value&gt;=0</code> means not currently in call set up.  </li>\n<li><code>&lt;value&gt;=1</code> means an incoming call process ongoing.</li>\n<li><code>&lt;value&gt;=2</code> means an outgoing call set up is ongoing.  </li>\n<li><code>&lt;value&gt;=3</code> means remote party being alerted in an outgoing call.</li>\n</ul>\n</li>\n<li>callheld: Bluetooth proprietary call hold status indicator. Support for this indicator is mandatory for<br>the AG, optional for the HF. Possible values are as follows:  <ul>\n<li>0&#x3D; No calls held  </li>\n<li>1&#x3D; Call is placed on hold or active&#x2F;held calls swapped<br>(The AG has both an active AND a held call)  </li>\n<li>Call on hold, no active call</li>\n</ul>\n</li>\n<li>signal: Signal Strength indicator:  <ul>\n<li><code>&lt;value&gt;= </code>ranges from 0 to 5</li>\n</ul>\n</li>\n<li>roam: Roaming status indicator:  <ul>\n<li><code>&lt;value&gt;=0</code> means roaming is not active  </li>\n<li><code>&lt;value&gt;=1</code> means a roaming is active</li>\n</ul>\n</li>\n<li>battchg: Battery Charge indicator of AG:  <ul>\n<li><code>&lt;value&gt;=</code>ranges from 0 to 5</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>+CIND：当前indicator的列表</p>\n</li>\n<li><p>AT+CLCC：列出当前电话命令，</p>\n</li>\n<li><p>+CLCC：当前call结果码，支持参数是</p>\n<ul>\n<li><p>idx：表示建立连接顺序或者接听电话的数字（从1开始）。</p>\n</li>\n<li><p>dir：0（outgoing），1（incoming）</p>\n</li>\n<li><p>status：</p>\n<ul>\n<li><p>0&#x3D;Active</p>\n</li>\n<li><p>1&#x3D;Held</p>\n</li>\n<li><p>2&#x3D;Dialing（outgoing calls only）</p>\n</li>\n<li><p>3&#x3D;Alerting(outgoing calls only)</p>\n</li>\n<li><p>4&#x3D;Incoming(incoming calls only)</p>\n</li>\n<li><p>5&#x3D;Waiting(incoming calls only)</p>\n</li>\n<li><p>6 &#x3D; Call held by Response and Hold</p>\n</li>\n</ul>\n</li>\n<li><p>mode&#x3D; 0 (Voice), 1 (Data), 2 (FAX)</p>\n</li>\n<li><p>mpty&#x3D;</p>\n<ul>\n<li>0 - this call is NOT a member of a multi-party (conference) call</li>\n<li>1 - this call IS a member of a multi-party (conference) call</li>\n</ul>\n</li>\n<li><p>number (optional)</p>\n</li>\n<li><p>type (optional)</p>\n</li>\n</ul>\n</li>\n<li><p>AT+COPS: AT+COPS&#x3D;3,0将被HF发送给AG</p>\n</li>\n<li><p>AT+CMEE: 使能+CME ERROR: <err>结果码</p>\n</li>\n<li><p>+CME ERROR</p>\n<ul>\n<li>+CME ERROR: 0 – AG failure</li>\n</ul>\n</li>\n<li><p>AT+CLIP: Calling Line Identification notification 使能命令，It enables&#x2F;disables the Calling Line Identification notification unsolicited result code 。</p>\n</li>\n<li><p>+CLIP : Standard “Calling Line Identification notification” unsolicited result code.  </p>\n</li>\n<li><p>AT+CMER :Standard event reporting activation&#x2F;deactivation AT command.  </p>\n</li>\n<li><p>+CIEV: “indicator events reporting”结果码。<code>&lt;ind&gt;</code>,<code>&lt;value&gt;</code> result code ，对应AT+CIND 返回的列表中的参数和值。</p>\n</li>\n<li><p>AT+VTS: DTMF生成命令。</p>\n</li>\n<li><p>AT+CNUM: HF相应<code>+CNUM</code>命令</p>\n<ul>\n<li>AT+CNUM (Retrieve Subscriber Number Information)</li>\n<li>AT+CNUM&#x3D;? (Test Subscriber Number Information – Not Implemented)</li>\n</ul>\n</li>\n<li><p>+CNUM:  用于将“ Subscriber Number Information ”从AG发送到HF的标准响应。</p>\n</li>\n</ul>\n<p>HFP协议扩展的AT命令：</p>\n<ul>\n<li>AT+BIA (Bluetooth Indicators Activation)  </li>\n<li>AT+BINP (Bluetooth INPut)  </li>\n<li>AT+BLDN (Bluetooth Last Dialed Number)  </li>\n<li>AT+BVRA (Bluetooth Voice Recognition Activation)  </li>\n<li>+BVRA (Bluetooth Voice Recognition Activation)  </li>\n<li>AT+BRSF (Bluetooth Retrieve Supported Features)  </li>\n<li>+BRSF (Bluetooth Retrieve Supported Features)   </li>\n<li>AT+NREC (Noise Reduction and Echo Canceling)  </li>\n<li>AT+VGM (Gain of Microphone)  </li>\n<li>AT+VGS (Gain of Speaker)  </li>\n<li>+VGM (Gain of Microphone)  </li>\n<li>+VGS (Gain of Speaker)  </li>\n<li>+BSIR (Bluetooth Setting of In-band Ring tone)  </li>\n<li>AT+BTRH (Bluetooth Response and Hold Feature)  </li>\n<li>+BTRH (Bluetooth Response and Hold Feature)  </li>\n<li>AT+BCC (Bluetooth Codec Connection)  </li>\n<li>AT+BCS (Bluetooth Codec Selection)  </li>\n<li>+BCS (Bluetooth Codec Selection)  </li>\n<li>AT+BAC (Bluetooth Available Codecs)  </li>\n<li>AT+BIND (Bluetooth HF Indicators Feature)  </li>\n<li>+BIND (Bluetooth HF Indicators Feature)  </li>\n<li>AT+BIEV (Bluetooth HF Indicators Feature)</li>\n</ul>\n<h3 id=\"建立服务连接\"><a href=\"#建立服务连接\" class=\"headerlink\" title=\"建立服务连接\"></a>建立服务连接</h3><blockquote>\n<p>Upon a user action or an internal event, either the HF or the AG may initiate a <strong>Service Level Connection</strong><br><strong>establishment</strong> procedure.<br>A Service Level Connection establishment requires the existence of a RFCOMM connection, that is, a<br>RFCOMM data link channel between the HF and the AG.<br>Both the HF and the AG may initiate the RFCOMM connection establishment. If there is no RFCOMM<br>session between the AG and the HF, the initiating device shall first initialize RFCOMM.  </p>\n</blockquote>\n<p>连接过程如下：</p>\n<p><img src=\"https://s1.ax1x.com/2022/04/11/LV6DxS.png\"></p>\n<ol>\n<li><p>支持能力交换<br>首先HF发送AT+BRSF&#x3D;&lt; HF supported features &gt;给AG，目的是首先通知AG其具有的能力，其次接收AG返回的其自身的BRSF能力。</p>\n</li>\n<li><p>Codec协商<br>如果HF支持Codec Negotiation特征，其会查看AG返回的BRSF中是否也支持该特性，如果都支持该特性，则HF将发送AT+BAC&#x3D;&lt; HF available codecs &gt;命令给AG以告知其可用的codec。</p>\n</li>\n<li><p>AG Indicator<br>HF从AG接收到的BRSF，可以知道AG支持的Indicator，并按顺序拍好，这是因为根据3GPP 27.007规范，AG可以支持Hands-Free不支持的profile。HF使用AT+CIND&#x3D;?测试命令接收AG支持的indicator以及它们的次序。<br>当HF获得必须的Indicator和它们的次序，它将通过AT+CIND?命令取得AG端正在使用indicator的状态。<br>当HF取得AG的indicator后，HF会使用AT+CMER使能AG的indicator状态跟新功能，AG会返回OK作为应答。当service，call或者call建立状态发生时，AG将发送和indicator相关的+CIEV结果码给HF。HF根据收到的+CIEV码来跟新其自身内部的indicator。<br>AG侧会一直保持indicator状态跟新功能使能直到收到AT+CMER指示其关闭或者HF和AG端的Service Level Connection连接断开。<br>当HF使能AG的indicator状态跟新，如果AG和HF都支持呼叫等待（Call waiting）和3方通信（3-way calling）。HF将发送AT+CHLD&#x3D;?测试命令取得AG是如何支持这种功能的。如果HF或者AG其中之一不支持三方通信，AT+CHLD&#x3D;?命令不会被发送。</p>\n</li>\n<li><p>HF Indicator<br>如果HF支持HF indicator，其会查看AG是否支持HF indicator。<br>如果HF和AG支持HF indicator特性，HF将发送AT+BIND&#x3D;&lt; HF supported HF indicators &gt;通知HF侧支持的indicator，AG以OK应答。<br>当AG接收到HF告知的HF indicator特性，HF将发送AT+BIND&#x3D;?请求AG侧支持的HF indicator。AG将会以+BIND和以OK结尾的应答。<br>当HF接收到AG支持的HF indicator，HF将会发送AT+BIND?命令确定HF目前使能的HF indicator。AG将会一次或多次以+BIND应答和以OK结尾的应答。<br>至此HF可能发送AT+BIEV命令告知AG其使能的HF indicator发生变化。<br>AG可以使用+BIND使能或者禁止任何HF indicator。</p>\n</li>\n<li><p>End of Service Level Connection</p>\n<ul>\n<li><p>HF需要知道Service Level Connection被完全建立，这可以通过以下几个方式：</p>\n<ul>\n<li>当且仅当AG通过+BRSF命令告知HF其支持的<code>&quot;HF indicator&quot;</code>，在HF收到AG通过<strong>AT+BIND？</strong>命令发来的其支持的<code>&quot;HF indicator&quot;</code>可认为完全建立。</li>\n<li>当且仅当SDP服务发现AH和AG双方均支持<code>&quot;Call waiting and 3-way calling&quot;</code>，在HFAG通过<strong>AT+CHLD</strong>命令发来的其对呼叫等待和多方电话的支持，对这种情况，<code>&quot;HF indicator&quot;</code>不要设置该比特位，AG也不要在+BRSF命令中设置该比特位。</li>\n<li>在HF使用<strong>AT+CMER</strong>命令成功启用<code>“Indicator status update”</code>功能，对这种情况SDP服务不应该设置<code>“Call waiting and 3-way calling”</code>比特位。<br>如果HF收到AG通过indicator指示当前有电话时，HF查询AG的接听和保持状态来判断是否是未接听电话。</li>\n</ul>\n</li>\n<li><p>同样AG侧Service Level Connection完全建立也有几种情况：</p>\n<ul>\n<li><p>当且仅当HF indicator在HF被设置且AG侧支持的indicator已经通过+BRSF命令应答，则AG以**+BIND加OK结尾**的命令应答其使能的HF indicator时可认为Service Level Connection完全建立。</p>\n</li>\n<li><p>当且仅当<code>“Call waiting and 3-way calling”</code>比特在HF和AG的SDP服务中被置位，在AG通过**+CHLD加OK结尾**命令成功响应其对呼叫保持和多方电话支持时SLC会被完全建立。对这种情况，+BRSF不应该设置该HF indicator比特位。</p>\n</li>\n<li><p>AG已成功<strong>响应OK到AT + CMER</strong>命令（启用<code>“Indicator status update”</code>功能。）当<code>“Call waiting and 3-way calling”</code>位时，应适用这种情况未在支持的功能位图中设置为HF或AG，以及<code>“HF Indicators ”</code>对于通过+ BRSF交换的HF或AG的支持功能位图中未设置位的位图命令。</p>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#判断是否支持&quot;Call waiting and 3-way calling&quot;</span><br><span class=\"line\">#AG发现HF, hfP支持的协议,HF支持&quot;Call waiting and 3-way calling&quot;</span><br><span class=\"line\">&gt; 596\t17.850811\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tSDP\t36\tRcvd Service Search Attribute Request : Handsfree: [Service Class ID List 0x0001] [Protocol Descriptor List 0x0004] [Bluetooth Profile Descriptor List 0x0009] [(HFP HS) Supported Features 0x0311] </span><br><span class=\"line\">&gt; 597\t17.851437\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tSDP\t69\tSent Service Search Attribute Response </span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth SDP Protocol</span><br><span class=\"line\">    PDU: Service Search Attribute Response (0x07)</span><br><span class=\"line\">    Transaction Id: 0x0000</span><br><span class=\"line\">    Parameter Length: 55</span><br><span class=\"line\">    Attribute List Byte Count: 52</span><br><span class=\"line\">    Attribute Lists [count =  1]</span><br><span class=\"line\">        Data Element: Sequence uint8 50 bytes</span><br><span class=\"line\">            0011 0... = Data Element Type: Sequence (6)</span><br><span class=\"line\">            .... .101 = Data Element Size: uint8 (5)</span><br><span class=\"line\">            Data Element Var Size: 50</span><br><span class=\"line\">            Data Value</span><br><span class=\"line\">                Attribute List [count =  4] (Handsfree)</span><br><span class=\"line\">                    Data Element: Sequence uint16 47 bytes</span><br><span class=\"line\">                        0011 0... = Data Element Type: Sequence (6)</span><br><span class=\"line\">                        .... .110 = Data Element Size: uint16 (6)</span><br><span class=\"line\">                        Data Element Var Size: 47</span><br><span class=\"line\">                        Data Value</span><br><span class=\"line\">                            Service Attribute: Service Class ID List (0x1), value = Handsfree -&gt; Generic Audio</span><br><span class=\"line\">                            Service Attribute: Protocol Descriptor List (0x4), value = L2CAP -&gt; RFCOMM:2</span><br><span class=\"line\">                            Service Attribute: Bluetooth Profile Descriptor List (0x9), value = Handsfree 1.6</span><br><span class=\"line\">                            Service Attribute: (HFP HS) Supported Features (0x311), value = (EC and/or Nr Function) (Call Waiting or Three Way Calling) (CLI Presentation Capability) (Voice Recognition Activation) (Remote Volume Control) (Wide Band Speech) </span><br><span class=\"line\">    Continuation State: no (00)</span><br><span class=\"line\"></span><br><span class=\"line\">#HF发现AG, hfP支持的协议,AG不支持&quot;Call waiting and 3-way calling&quot;，只支持&quot;3-way calling&quot;</span><br><span class=\"line\">&gt; 637\t18.017460\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tSDP\t33\tSent Service Search Attribute Request : Handsfree Audio Gateway: [Service Class ID List 0x0001] [Bluetooth Profile Descriptor List 0x0009] [(HFP AG) Supported Features 0x0311] </span><br><span class=\"line\">&gt; 644\t18.024689\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tSDP\t52\tRcvd Service Search Attribute Response </span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth SDP Protocol</span><br><span class=\"line\">    PDU: Service Search Attribute Response (0x07)</span><br><span class=\"line\">    Transaction Id: 0x0000</span><br><span class=\"line\">    Parameter Length: 38</span><br><span class=\"line\">    Attribute List Byte Count: 35</span><br><span class=\"line\">    Attribute Lists [count =  1]</span><br><span class=\"line\">        Data Element: Sequence uint8 33 bytes</span><br><span class=\"line\">            0011 0... = Data Element Type: Sequence (6)</span><br><span class=\"line\">            .... .101 = Data Element Size: uint8 (5)</span><br><span class=\"line\">            Data Element Var Size: 33</span><br><span class=\"line\">            Data Value</span><br><span class=\"line\">                Attribute List [count =  3] (Handsfree Audio Gateway)</span><br><span class=\"line\">                    Data Element: Sequence uint16 30 bytes</span><br><span class=\"line\">                        0011 0... = Data Element Type: Sequence (6)</span><br><span class=\"line\">                        .... .110 = Data Element Size: uint16 (6)</span><br><span class=\"line\">                        Data Element Var Size: 30</span><br><span class=\"line\">                        Data Value</span><br><span class=\"line\">                            Service Attribute: Service Class ID List (0x1), value = Handsfree Audio Gateway -&gt; Generic Audio</span><br><span class=\"line\">                            Service Attribute: Bluetooth Profile Descriptor List (0x9), value = Handsfree 1.6</span><br><span class=\"line\">                            Service Attribute: (HFP AG) Supported Features (0x311), value = (Three Way Calling) (EC and/or Nr Function) (Voice Recognition Function) (Wide Band Speech) </span><br><span class=\"line\">    Continuation State: no (00)</span><br><span class=\"line\"></span><br><span class=\"line\">#HFP建立连接</span><br><span class=\"line\">#交换支持功能，AG和HF都不支持&quot;HF indicator&quot;</span><br><span class=\"line\">&gt; 634\t18.012482\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t26\tSent AT+BRSF=255</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HFP Profile</span><br><span class=\"line\">    [Role: HS - Headset (2)]</span><br><span class=\"line\">    AT Stream: AT+BRSF=255\\r</span><br><span class=\"line\">    Command 0: +BRSF</span><br><span class=\"line\">        Command Line Prefix: AT</span><br><span class=\"line\">        Command: +BRSF (Bluetooth Retrieve Supported Features)</span><br><span class=\"line\">        Type: Action Command (0x003d)</span><br><span class=\"line\">        Parameters</span><br><span class=\"line\">            HS supported features bitmask: 255</span><br><span class=\"line\">                .... .... .... .... .... .... .... ...1 = EC and/or NR function: True</span><br><span class=\"line\">                .... .... .... .... .... .... .... ..1. = Call waiting or 3-way calling: True</span><br><span class=\"line\">                .... .... .... .... .... .... .... .1.. = CLI Presentation: True</span><br><span class=\"line\">                .... .... .... .... .... .... .... 1... = Voice Recognition Activation: True</span><br><span class=\"line\">                .... .... .... .... .... .... ...1 .... = Remote Volume Control: True</span><br><span class=\"line\">                .... .... .... .... .... .... ..1. .... = Enhanced Call Status: True</span><br><span class=\"line\">                .... .... .... .... .... .... .1.. .... = Enhanced Call Control: True</span><br><span class=\"line\">                .... .... .... .... .... .... 1... .... = Codec Negotiation: True</span><br><span class=\"line\">                .... .... .... .... .... ...0 .... .... = HF Indicators: False</span><br><span class=\"line\">                .... .... .... .... .... ..0. .... .... = eSCO S4 (and T2) Settings Support: False</span><br><span class=\"line\">                0000 0000 0000 0000 0000 00.. .... .... = Reserved: 0x000000</span><br><span class=\"line\">&gt; 641\t18.022446\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t28\tRcvd   +BRSF: 871</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HFP Profile</span><br><span class=\"line\">    [Role: AG - Audio Gate (1)]</span><br><span class=\"line\">    AT Stream: \\r\\n+BRSF: 871\\r\\n</span><br><span class=\"line\">    Command 0: +BRSF</span><br><span class=\"line\">        Command: +BRSF (Bluetooth Retrieve Supported Features)</span><br><span class=\"line\">        Type: Response (0x003a)</span><br><span class=\"line\">        Parameters</span><br><span class=\"line\">            AG supported features bitmask: 871</span><br><span class=\"line\">                .... .... .... .... .... .... .... ...1 = Three Way Calling: True</span><br><span class=\"line\">                .... .... .... .... .... .... .... ..1. = EC and/or NR function: True</span><br><span class=\"line\">                .... .... .... .... .... .... .... .1.. = Voice Recognition Function: True</span><br><span class=\"line\">                .... .... .... .... .... .... .... 0... = In-band Ring Tone: False</span><br><span class=\"line\">                .... .... .... .... .... .... ...0 .... = Attach Number to Voice Tag: False</span><br><span class=\"line\">                .... .... .... .... .... .... ..1. .... = Ability to Reject a Call: True</span><br><span class=\"line\">                .... .... .... .... .... .... .1.. .... = Enhanced Call Status: True</span><br><span class=\"line\">                .... .... .... .... .... .... 0... .... = Enhanced Call Control: False</span><br><span class=\"line\">                .... .... .... .... .... ...1 .... .... = Extended Error Result Codes: True</span><br><span class=\"line\">                .... .... .... .... .... ..1. .... .... = Codec Negotiation: True</span><br><span class=\"line\">                .... .... .... .... .... .0.. .... .... = HF Indicators: False</span><br><span class=\"line\">                .... .... .... .... .... 0... .... .... = eSCO S4 (and T2) Settings Support: False</span><br><span class=\"line\">                0000 0000 0000 0000 0000 .... .... .... = Reserved: 0x00000</span><br><span class=\"line\"></span><br><span class=\"line\">#AG和HF都支持&quot;Codec Negotiation&quot;，HF告知AG其可用的Codec编码(CVSD)</span><br><span class=\"line\">&gt; 643\t18.023696\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t23\tSent AT+BAC=1</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HFP Profile</span><br><span class=\"line\">    [Role: HS - Headset (2)]</span><br><span class=\"line\">    AT Stream: AT+BAC=1\\r</span><br><span class=\"line\">    Command 0: +BAC</span><br><span class=\"line\">        Command Line Prefix: AT</span><br><span class=\"line\">        Command: +BAC (Bluetooth Available Codecs)</span><br><span class=\"line\">        Type: Action Command (0x003d)</span><br><span class=\"line\">        Parameters</span><br><span class=\"line\">            Codec: CVSD (1)</span><br><span class=\"line\"></span><br><span class=\"line\">#获取AG支持的indicator以及它们的次序</span><br><span class=\"line\">&gt; 649\t18.029340\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t24\tSent AT+CIND=? </span><br><span class=\"line\">&gt; 652\t18.035680\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t147\tRcvd   +CIND: (&quot;CALL&quot;,(0,1)),(&quot;CALLSETUP&quot;,(0-3)),(&quot;SERVICE&quot;,(0-1)),(&quot;SIGNAL&quot;,(0-5)),(&quot;ROAM&quot;,(0,1)),(&quot;BATTCHG&quot;,(0-5)),(&quot;CALLHELD&quot;,(0-2)) </span><br><span class=\"line\"></span><br><span class=\"line\">#获取AG indicators当前的状态</span><br><span class=\"line\">&gt; 654\t18.037547\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t23\tSent AT+CIND? </span><br><span class=\"line\">&gt; 656\t18.092460\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t38\tRcvd   +CIND: 0,0,1,5,0,2,0</span><br><span class=\"line\"></span><br><span class=\"line\">#标志HFP连接建立</span><br><span class=\"line\">#启用&quot;Indicator status update&quot;</span><br><span class=\"line\">&gt; 658\t18.093591\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t30\tSent AT+CMER=3,0,0,1</span><br><span class=\"line\">&gt; 660\t18.117156\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t20\tRcvd   OK  </span><br></pre></td></tr></table></figure>\n\n<h3 id=\"HF拨打-挂断电话\"><a href=\"#HF拨打-挂断电话\" class=\"headerlink\" title=\"HF拨打\\挂断电话\"></a>HF拨打\\挂断电话</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#HF拨打电话</span><br><span class=\"line\">&gt; 921\t29.433324\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t24\tSent ATD10086; </span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HFP Profile</span><br><span class=\"line\">    [Role: HS - Headset (2)]</span><br><span class=\"line\">    AT Stream: ATD10086;\\r</span><br><span class=\"line\">    Command 0: D</span><br><span class=\"line\">        Command Line Prefix: AT</span><br><span class=\"line\">        Command: D (Dial)</span><br><span class=\"line\">        [Expert Info (Warning/Protocol): Non mandatory type or command in this role]</span><br><span class=\"line\">        Parameters: No</span><br><span class=\"line\">&gt; 924\t30.778650\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t20\tRcvd   OK</span><br><span class=\"line\"></span><br><span class=\"line\">#挂断电话</span><br><span class=\"line\">&gt; 965\t37.723080\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t22\tSent AT+CHUP</span><br><span class=\"line\">&gt; 966\t37.752000\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t20\tRcvd   OK</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"HF获取通话电话列表\"><a href=\"#HF获取通话电话列表\" class=\"headerlink\" title=\"HF获取通话电话列表\"></a>HF获取通话电话列表</h3><p>会HF会轮询此命令</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 925\t30.779082\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t22\tSent AT+CLCC </span><br><span class=\"line\">&gt; 929\t30.820871\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t46\tRcvd   +CLCC: 1,0,2,0,0,&quot;10086&quot;,129 </span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HFP Profile</span><br><span class=\"line\">    [Role: AG - Audio Gate (1)]</span><br><span class=\"line\">    AT Stream: \\r\\n+CLCC: 1,0,2,0,0,&quot;10086&quot;,129\\r\\n</span><br><span class=\"line\">    Command 0: +CLCC</span><br><span class=\"line\">        Command: +CLCC (Current Calls)</span><br><span class=\"line\">        Type: Response (0x003a)</span><br><span class=\"line\">        Parameters</span><br><span class=\"line\">            ID: 1</span><br><span class=\"line\">            Direction: Mobile Originated (0)</span><br><span class=\"line\">            State: Dialing (2)</span><br><span class=\"line\">            Mode: Voice (0)</span><br><span class=\"line\">            Mpty: Call is not one of multiparty (conference) call parties (0)</span><br><span class=\"line\">            Number: &quot;10086&quot;</span><br><span class=\"line\">            Type: The phone number format may be a national or international format, and may contain prefix and/or escape digits. No changes on the number presentation are required. (129)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"AG下发通话状态\"><a href=\"#AG下发通话状态\" class=\"headerlink\" title=\"AG下发通话状态\"></a>AG下发通话状态</h3><p>在开启<code>&quot;Indicator status update&quot;</code>(AT+CMER)之后，AG会主动下发当前的通话状态，<code>Indicator Index</code>对应+CIND返回的参数列表，<code>Indicator &lt;idx&gt;</code>对应其值。</p>\n<h4 id=\"拨打电话\"><a href=\"#拨打电话\" class=\"headerlink\" title=\"拨打电话\"></a>拨打电话</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#CALLSETUP=2,拨号中</span><br><span class=\"line\">&gt; 1056\t66.689969\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t27\tRcvd   +CIEV: 2,2  </span><br></pre></td></tr></table></figure>\n\n<h4 id=\"无通话或者挂断\"><a href=\"#无通话或者挂断\" class=\"headerlink\" title=\"无通话或者挂断\"></a>无通话或者挂断</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#CALL=0,无通话</span><br><span class=\"line\">1106\t74.975552\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t27\tRcvd   +CIEV: 1,0  </span><br></pre></td></tr></table></figure>\n\n<h4 id=\"来电\"><a href=\"#来电\" class=\"headerlink\" title=\"来电\"></a>来电</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#CALLSETUP=1,来电中</span><br><span class=\"line\">&gt; 1056\t66.689969\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t27\tRcvd   +CIEV: 2,1 </span><br></pre></td></tr></table></figure>\n<h3 id=\"建立SCO-x2F-eSCO连接\"><a href=\"#建立SCO-x2F-eSCO连接\" class=\"headerlink\" title=\"建立SCO&#x2F;eSCO连接\"></a>建立SCO&#x2F;eSCO连接</h3><p>蓝牙电话的音频数据由SCO&#x2F;eSCO协议传输，在HCI中无数据相关的日志。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#HF选择编解码格式</span><br><span class=\"line\">&gt; 900\t387.320548\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tHFP\t24\tRcvd   +BCS: 1  </span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HFP Profile</span><br><span class=\"line\">    [Role: AG - Audio Gate (1)]</span><br><span class=\"line\">    AT Stream: \\r\\n+BCS: 1\\r\\n</span><br><span class=\"line\">    Command 0: +BCS</span><br><span class=\"line\">        Command: +BCS (Bluetooth Codec Selection)</span><br><span class=\"line\">        Type: Response (0x003a)</span><br><span class=\"line\">        Parameters</span><br><span class=\"line\">            Codec: CVSD (1)</span><br><span class=\"line\">&gt; 903\t387.380459\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t23\tSent AT+BCS=1 </span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HFP Profile</span><br><span class=\"line\">    [Role: HS - Headset (2)]</span><br><span class=\"line\">    AT Stream: AT+BCS=1\\r</span><br><span class=\"line\">    Command 0: +BCS</span><br><span class=\"line\">        Command Line Prefix: AT</span><br><span class=\"line\">        Command: +BCS (Bluetooth Codec Selection)</span><br><span class=\"line\">        Type: Action Command (0x003d)</span><br><span class=\"line\">        Parameters</span><br><span class=\"line\">            Codec: CVSD (1)</span><br><span class=\"line\"></span><br><span class=\"line\">#AG请求建立eSCO连接</span><br><span class=\"line\">&gt; 906\t387.530834\tcontroller\thost\tHCI_EVT\t13\tRcvd Connect Request</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Connect Request</span><br><span class=\"line\">    Event Code: Connect Request (0x04)</span><br><span class=\"line\">    Parameter Total Length: 10</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Class of Device: 0x001f00 (Uncategorized: device code not specified:Unknown - services:)</span><br><span class=\"line\">    Link Type: eSCO connection (Voice Channels) (0x02)</span><br><span class=\"line\"></span><br><span class=\"line\">#HF允许建立eSCO连接</span><br><span class=\"line\">&gt; 907\t387.531078\thost\tcontroller\tHCI_CMD\t67\tSent Enhanced Accept Synchronous Connection Request</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - Enhanced Accept Synchronous Connection Request</span><br><span class=\"line\">    Command Opcode: Enhanced Accept Synchronous Connection Request (0x043e)</span><br><span class=\"line\">        0000 01.. .... .... = Opcode Group Field: Link Control Commands (0x01)</span><br><span class=\"line\">        .... ..00 0011 1110 = Opcode Command Field: Enhanced Accept Synchronous Connection Request (0x03e)</span><br><span class=\"line\">    Parameter Total Length: 63</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Tx Bandwidth (bytes/s): 8000</span><br><span class=\"line\">    Rx Bandwidth (bytes/s): 8000</span><br><span class=\"line\">    Transmit Coding Format</span><br><span class=\"line\">    Receive Coding Format</span><br><span class=\"line\">    Transmit Codec Frame Size: 60</span><br><span class=\"line\">    Receive Codec Frame Size: 60</span><br><span class=\"line\">    Input Bandwidth: 16000</span><br><span class=\"line\">    Output Bandwidth: 16000</span><br><span class=\"line\">    Input Coding Format</span><br><span class=\"line\">    Output Coding Format</span><br><span class=\"line\">    Input Coded Data Size: 16</span><br><span class=\"line\">    Output Coded Data Size: 16</span><br><span class=\"line\">    Input PCM Data Format: 2&#x27;s complement (0x02)</span><br><span class=\"line\">    Output PCM Data Format: 2&#x27;s complement (0x02)</span><br><span class=\"line\">    Input PCM Sample Payload MSB Position: 0</span><br><span class=\"line\">    Output PCM Sample Payload MSB Position: 0</span><br><span class=\"line\">    Input Data Path: Vendor Specific</span><br><span class=\"line\">    Output Data Path: Vendor Specific</span><br><span class=\"line\">    Input Transport Unit Size: 16</span><br><span class=\"line\">    Output Transport Unit Size: 16</span><br><span class=\"line\">    Max. Latency (ms): 12</span><br><span class=\"line\">    Packet Type: 0x03bf, 3-EV5 may NOT be used, 2-EV5 may NOT be used, 3-EV3 may NOT be used, EV5 may be used, EV4 may be used, EV3 may be used, HV3 may be used, HV2 may be used, HV1 may be used</span><br><span class=\"line\">    Retransmission Effort: At least 1 retransmission, optimize for link quality (2)</span><br><span class=\"line\">    [Pending in frame: 909]</span><br><span class=\"line\">    [Command-Pending Delta: 1.38ms]</span><br><span class=\"line\">    [Response in frame: 910]</span><br><span class=\"line\">    [Command-Response Delta: 3.862ms]</span><br><span class=\"line\"></span><br><span class=\"line\">#eSCO连接成功</span><br><span class=\"line\">&gt; 910\t387.534940\tcontroller\thost\tHCI_EVT\t20\tRcvd Synchronous Connection Complete</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Synchronous Connection Complete</span><br><span class=\"line\">    Event Code: Synchronous Connection Complete (0x2c)</span><br><span class=\"line\">    Parameter Total Length: 17</span><br><span class=\"line\">    Status: Success (0x00)</span><br><span class=\"line\">    Connection Handle: 0x0e00</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Link Type: eSCO connection (0x02)</span><br><span class=\"line\">    Transmit Interval: 12 slots (7.5 msec)</span><br><span class=\"line\">    Retransmit Window: 2 slots (1.25 msec)</span><br><span class=\"line\">    Rx Packet Length: 60</span><br><span class=\"line\">    Tx Packet Length: 60</span><br><span class=\"line\">    Air Mode: CVSD (2)</span><br><span class=\"line\">    [Command in frame: 907]</span><br><span class=\"line\">    [Pending in frame: 909]</span><br><span class=\"line\">    [Pending-Response Delta: 2.482ms]</span><br><span class=\"line\">    [Command-Response Delta: 3.862ms]</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"蓝牙音乐\"><a href=\"#蓝牙音乐\" class=\"headerlink\" title=\"蓝牙音乐\"></a>蓝牙音乐</h1><h2 id=\"AVDTP\"><a href=\"#AVDTP\" class=\"headerlink\" title=\"AVDTP\"></a>AVDTP</h2><p><strong>AVDTP：AUDIO&#x2F;VIDEO DISTRIBUTION TRANSPORT PROTOCOL(音视频分配传输协议)</strong> ，用于音乐数据流的建立与传输控制。</p>\n<h3 id=\"建立连接\"><a href=\"#建立连接\" class=\"headerlink\" title=\"建立连接\"></a>建立连接</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 458\t11.574257\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tL2CAP\t17\tSent Connection Request (AVDTP, SCID: 0x0042)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"数据流传输\"><a href=\"#数据流传输\" class=\"headerlink\" title=\"数据流传输\"></a>数据流传输</h3><p>数据流的生命状态：</p>\n<p><img src=\"https://s1.ax1x.com/2022/04/11/LV6NVA.png\"></p>\n<h4 id=\"查找-Idle\"><a href=\"#查找-Idle\" class=\"headerlink\" title=\"查找(Idle)\"></a>查找(Idle)</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#查询AG的所有音源</span><br><span class=\"line\">&gt; 468\t11.652772\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tAVDTP\t11\tSent Command - Discover</span><br><span class=\"line\">&gt; 469\t11.722467\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tAVDTP\t15\tRcvd ResponseAccept - Discover - items: 2</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVDTP Protocol</span><br><span class=\"line\">    Signal: Discover (ResponseAccept)</span><br><span class=\"line\">    ACP SEP [1 - Audio Source] item 1/2</span><br><span class=\"line\">        0000 01.. = SEID: 1</span><br><span class=\"line\">        .... ..0. = In Use: False (0x0)</span><br><span class=\"line\">        .... ...0 = RFA0: 0x0</span><br><span class=\"line\">        0000 .... = Media Type: Audio (0x0)</span><br><span class=\"line\">        .... 0... = Type: Source (0x0)</span><br><span class=\"line\">        .... .000 = RFA1: 0x0</span><br><span class=\"line\">    ACP SEP [2 - Audio Source] item 2/2</span><br><span class=\"line\">        0000 10.. = SEID: 2</span><br><span class=\"line\">        .... ..0. = In Use: False (0x0)</span><br><span class=\"line\">        .... ...0 = RFA0: 0x0</span><br><span class=\"line\">        0000 .... = Media Type: Audio (0x0)</span><br><span class=\"line\">        .... 0... = Type: Source (0x0)</span><br><span class=\"line\">        .... .000 = RFA1: 0x0</span><br><span class=\"line\"></span><br><span class=\"line\">#获取音源详细信息</span><br><span class=\"line\">&gt; 470\t11.722896\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tAVDTP\t12\tSent Command - GetAllCapabilities - ACP SEID [1 - Audio Source]</span><br><span class=\"line\">&gt; 473\t11.728705\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tAVDTP\t23\tRcvd ResponseAccept - GetAllCapabilities - Audio SBC (44100 | Mono JointStereo | block: 4 8 12 16 | subbands: 8 | allocation: Loudness | bitpool: 2..53)</span><br><span class=\"line\">&gt; 474\t11.728960\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tAVDTP\t12\tSent Command - GetAllCapabilities - ACP SEID [2 - Audio Source]</span><br><span class=\"line\">&gt; 476\t11.734811\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tAVDTP\t25\tRcvd ResponseAccept - GetAllCapabilities - Audio MPEG-2,4 AAC</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVDTP Protocol</span><br><span class=\"line\">    Signal: GetAllCapabilities (ResponseAccept)</span><br><span class=\"line\">        0010 .... = Transaction: 0x2</span><br><span class=\"line\">        .... 00.. = Packet Type: Single (0x0)</span><br><span class=\"line\">        .... ..10 = Message Type: ResponseAccept (0x2)</span><br><span class=\"line\">        00.. .... = RFA: 0x0</span><br><span class=\"line\">        ..00 1100 = Signal: GetAllCapabilities (0x0c)</span><br><span class=\"line\">    Capabilities</span><br><span class=\"line\">        Service: Media Transport</span><br><span class=\"line\">        Service: Media Codec - Audio MPEG-2,4 AAC</span><br><span class=\"line\">        Service: Delay Reporting</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"设置-x2F-打开-Configured-x2F-Open\"><a href=\"#设置-x2F-打开-Configured-x2F-Open\" class=\"headerlink\" title=\"设置&#x2F;打开(Configured&#x2F;Open)\"></a>设置&#x2F;打开(Configured&#x2F;Open)</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#选择对应音源</span><br><span class=\"line\">&gt; 477\t11.735508\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tAVDTP\t25\tSent Command - SetConfiguration - ACP SEID [2 - Audio Source] - INT SEID [2 - Audio Source] - Audio MPEG-2,4 AAC</span><br><span class=\"line\">&gt; 479\t11.742210\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tAVDTP\t11\tRcvd ResponseAccept - SetConfiguration</span><br><span class=\"line\"></span><br><span class=\"line\">#打开音源</span><br><span class=\"line\">&gt; 480\t11.742538\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tAVDTP\t12\tSent Command - Open - ACP SEID [2 - Audio Source]</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVDTP Protocol</span><br><span class=\"line\">    Signal: Open (Command)</span><br><span class=\"line\">    ACP SEID [2 - Audio Source]</span><br><span class=\"line\">&gt; 485\t11.747312\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tAVDTP\t11\tRcvd ResponseAccept - Open</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"开始传输-Streaming\"><a href=\"#开始传输-Streaming\" class=\"headerlink\" title=\"开始传输(Streaming)\"></a>开始传输(Streaming)</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 601\t28.945727\tXiaomiCo_f2:31:c7 (PHONE)\tSANYOEle_71:7b:5c (DEVICE)\tAVDTP\t12\tRcvd Command - Start - ACP SEID [2 - Audio Sink]</span><br><span class=\"line\">&gt; 602\t28.946025\tSANYOEle_71:7b:5c (DEVICE)\tXiaomiCo_f2:31:c7 (PHONE)\tAVDTP\t11\tSent ResponseAccept - Start</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"传输-Streaming\"><a href=\"#传输-Streaming\" class=\"headerlink\" title=\"传输(Streaming)\"></a>传输(Streaming)</h4><p>使用RTP协议传输数据，AVDTP协议本身不处理数据流。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 612\t29.166322\tXiaomiCo_f2:31:c7 (PHONE)\tSANYOEle_71:7b:5c (DEVICE)\tRTP\t37\tPT=Unknown, SSRC=0x2, Seq=1, Time=0</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Frame 612: 37 bytes on wire (296 bits), 37 bytes captured (296 bits)</span><br><span class=\"line\">Bluetooth</span><br><span class=\"line\">Bluetooth HCI H4</span><br><span class=\"line\">Bluetooth HCI ACL Packet</span><br><span class=\"line\">Bluetooth L2CAP Protocol</span><br><span class=\"line\">Bluetooth A2DP Profile</span><br><span class=\"line\">    [ACP SEID: 2]</span><br><span class=\"line\">    [INT SEID: 2]</span><br><span class=\"line\">    [Codec: MPEG-2,4 AAC (0x02)]</span><br><span class=\"line\">    [Stream Start in Frame: 612]</span><br><span class=\"line\">    [Stream End in Frame: 22786]</span><br><span class=\"line\">    [Stream Number: 1]</span><br><span class=\"line\">Real-Time Transport Protocol</span><br><span class=\"line\">    [Stream setup by BT A2DP (frame 612)]</span><br><span class=\"line\">    10.. .... = Version: RFC 1889 Version (2)</span><br><span class=\"line\">    ..0. .... = Padding: False</span><br><span class=\"line\">    ...0 .... = Extension: False</span><br><span class=\"line\">    .... 0000 = Contributing source identifiers count: 0</span><br><span class=\"line\">    0... .... = Marker: False</span><br><span class=\"line\">    Payload type: Unknown (98)</span><br><span class=\"line\">    Sequence number: 1</span><br><span class=\"line\">    [Extended sequence number: 65537]</span><br><span class=\"line\">    Timestamp: 0</span><br><span class=\"line\">    Synchronization Source identifier: 0x00000002 (2)</span><br><span class=\"line\">Data (16 bytes)</span><br><span class=\"line\">    Data: 47fc0000b0908003000621100520a41c</span><br><span class=\"line\">    [Length: 16]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"暂停-Streaming\"><a href=\"#暂停-Streaming\" class=\"headerlink\" title=\"暂停(Streaming)\"></a>暂停(Streaming)</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 773\t23.510436\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVDTP\t11\tSent ResponseAccept - Suspend</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"释放-Closing\"><a href=\"#释放-Closing\" class=\"headerlink\" title=\"释放(Closing)\"></a>释放(Closing)</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 5692\t96.414176\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVDTP\t12\tSent Command - Close - ACP SEID [2 - Audio Source]</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"AVCTP\"><a href=\"#AVCTP\" class=\"headerlink\" title=\"AVCTP\"></a>AVCTP</h2><p>**AVCTP： Audio&#x2F;Video Control Transport Protocol(音频&#x2F;视频控制传输协议)**，用于蓝牙设备间音乐数据流功能的发现与控制，但是控制的具体功能逻辑不由AVCTP处理，其只发送命令。</p>\n<p>发现由SDP协议完成，然后发起L2CAP通道连接蓝牙设备之间的AVCTP服务，如下:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#发现</span><br><span class=\"line\">&gt; 134\t0.964749\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tSDP\t33\tSent Service Search Attribute Request : Audio Source: [Service Class ID List 0x0001] [Protocol Descriptor List 0x0004] [Bluetooth Profile Descriptor List 0x0009] </span><br><span class=\"line\">&gt; 139\t0.981837\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tSDP\t64\tRcvd Service Search Attribute Response </span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth SDP Protocol</span><br><span class=\"line\">    PDU: Service Search Attribute Response (0x07)</span><br><span class=\"line\">    Transaction Id: 0x0000</span><br><span class=\"line\">    Parameter Length: 50</span><br><span class=\"line\">    Attribute List Byte Count: 47</span><br><span class=\"line\">    Attribute Lists [count =  1]</span><br><span class=\"line\">        Data Element: Sequence uint8 45 bytes</span><br><span class=\"line\">            0011 0... = Data Element Type: Sequence (6)</span><br><span class=\"line\">            .... .101 = Data Element Size: uint8 (5)</span><br><span class=\"line\">            Data Element Var Size: 45</span><br><span class=\"line\">            Data Value</span><br><span class=\"line\">                Attribute List [count =  3] (Audio Source)</span><br><span class=\"line\">                    Data Element: Sequence uint16 42 bytes</span><br><span class=\"line\">                        0011 0... = Data Element Type: Sequence (6)</span><br><span class=\"line\">                        .... .110 = Data Element Size: uint16 (6)</span><br><span class=\"line\">                        Data Element Var Size: 42</span><br><span class=\"line\">                        Data Value</span><br><span class=\"line\">                            Service Attribute: Service Class ID List (0x1), value = Audio Source</span><br><span class=\"line\">                                Attribute ID: Service Class ID List</span><br><span class=\"line\">                                Value</span><br><span class=\"line\">                            Service Attribute: Protocol Descriptor List (0x4), value = L2CAP:25 -&gt; AVDTP (1.3)</span><br><span class=\"line\">                                Attribute ID: Protocol Descriptor List</span><br><span class=\"line\">                                Value</span><br><span class=\"line\">                            Service Attribute: Bluetooth Profile Descriptor List (0x9), value = Advanced Audio Distribution 1.3</span><br><span class=\"line\">                                Attribute ID: Bluetooth Profile Descriptor List</span><br><span class=\"line\">                                Value</span><br><span class=\"line\">    Continuation State: no (00)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#连接</span><br><span class=\"line\">&gt; 147\t1.006617\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tL2CAP\t17\tSent Connection Request (AVDTP, SCID: 0x0043)</span><br><span class=\"line\">&gt; 155\t1.017317\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tL2CAP\t21\tRcvd Connection Response - Success (SCID: 0x0043, DCID: 0x0042)</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"AVRCP\"><a href=\"#AVRCP\" class=\"headerlink\" title=\"AVRCP\"></a>AVRCP</h2><p>**AVRCP：Audio&#x2F;Video Remote Control Profile(音频&#x2F;视频远程控制配置文件)**，用于控制蓝牙音乐的标准接口。</p>\n<p>在AVRCP中，<strong>TG</strong>表示播放设备，<strong>CT</strong>表示控制设备。</p>\n<h3 id=\"命令格式\"><a href=\"#命令格式\" class=\"headerlink\" title=\"命令格式\"></a>命令格式</h3><p>命令分为两个类型：VENDOR DEPENDENT 与PASS THROUGH，</p>\n<ul>\n<li><p>VENDOR DEPENDENT：通过<code>Ctype</code>与<code>PDU ID</code>来区分功能，<code>Ctype</code>有<strong>Control, Status , Notify</strong>,ACCEPTED,REJECTED, CHANGED,INTERIM,IMPLEMENTED,STABLE等。</p>\n</li>\n<li><p>PASS THROUGH：是播放控制命令，<code>Ctype</code>只有<strong>Control</strong>。</p>\n</li>\n</ul>\n<p>其中请求命令<code>Ctype</code>为<strong>Notify</strong>，回复事件<code>Ctype</code>为<strong>Interim</strong>，事件通知<code>Ctype</code>为<strong>Changed</strong>。</p>\n<h3 id=\"获取TG播放器支持功能\"><a href=\"#获取TG播放器支持功能\" class=\"headerlink\" title=\"获取TG播放器支持功能\"></a>获取TG播放器支持功能</h3><p><code>PDU ID</code>：GetFolderItems，通过<code>Scope</code>来区分功能，用于<strong>TG</strong>可以播放器列表与每个播放器支持的功能。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 307\t1.551666\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t29\tSent Browsing: Command - GetFolderItems - Scope: MediaPlayerList, StartItem: 0x0000, EndItem: 0x0013</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    PDU ID: GetFolderItems (0x71)</span><br><span class=\"line\">    Parameter Length: 10</span><br><span class=\"line\">    Scope: MediaPlayerList (0x00)</span><br><span class=\"line\">    StartItem: 0</span><br><span class=\"line\">    EndItem: 19</span><br><span class=\"line\">    Attribute Count: All attributes are requested (0)</span><br><span class=\"line\">    Attribute List</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 326\t1.651062\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t67\tRcvd Browsing: OK - GetFolderItems - UidCounter: 0x0000, NumberOfItems: 1</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    PDU ID: GetFolderItems (0x71)</span><br><span class=\"line\">    Parameter Length: 48</span><br><span class=\"line\">    Status: OK (0x04)</span><br><span class=\"line\">    UID Counter: 0x0000</span><br><span class=\"line\">    Number Of Items: 1</span><br><span class=\"line\">    Player: Music Player</span><br><span class=\"line\">        Item Type: Media Player Item (0x01)</span><br><span class=\"line\">        Item Length: 40</span><br><span class=\"line\">        Player ID: 0</span><br><span class=\"line\">        Major Player Type: Unknown (0x01)</span><br><span class=\"line\">        Player SubType: Audio Book (0x00000001)</span><br><span class=\"line\">        Play Status: Stopped (0x00)</span><br><span class=\"line\">        Features</span><br><span class=\"line\">            Not Used Features</span><br><span class=\"line\">            .... ...1 = PASSTHROUGH Play: 0x1</span><br><span class=\"line\">            .... ..1. = PASSTHROUGH Stop: 0x1</span><br><span class=\"line\">            .... .1.. = PASSTHROUGH Pause: 0x1</span><br><span class=\"line\">            ...1 .... = PASSTHROUGH Rewind: 0x1</span><br><span class=\"line\">            ..1. .... = PASSTHROUGH FastForward: 0x1</span><br><span class=\"line\">            1... .... = PASSTHROUGH Forward: 0x1</span><br><span class=\"line\">            .... ...1 = PASSTHROUGH Backward: 0x1</span><br><span class=\"line\">            .... .1.. = Advanced Control Player: 0x1</span><br><span class=\"line\">        Character Set: UTF-8 (106)</span><br><span class=\"line\">        Displayable Name Length: 12</span><br><span class=\"line\">        Displayable Name: Music Player</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"获取TG支持事件\"><a href=\"#获取TG支持事件\" class=\"headerlink\" title=\"获取TG支持事件\"></a>获取TG支持事件</h3><p><code>PDU ID</code>：GetCapabilities，用于<strong>TG</strong>可以支持的事件。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 288\t1.233497\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t23\tSent Vendor dependent: Status - GetCapabilities(Events Supported)</span><br><span class=\"line\">&gt; 299\t1.252688\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t30\tRcvd Vendor dependent: Stable - GetCapabilities(Events Supported) - Count: 6</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    0000 .... = Reserved: 0x0</span><br><span class=\"line\">    .... 1100 = Ctype: Stable (0xc)</span><br><span class=\"line\">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class=\"line\">    .... .000 = Subunit ID: 0x0</span><br><span class=\"line\">    Opcode: Vendor dependent (0x00)</span><br><span class=\"line\">    Company ID: 00:19:58 (Bluetooth SIG, Inc.)</span><br><span class=\"line\">    PDU ID: GetCapabilities (0x10)</span><br><span class=\"line\">    0000 00.. = RFA: 0x00</span><br><span class=\"line\">    .... ..00 = Packet Type: Single (0x0)</span><br><span class=\"line\">    Parameter Length: 8</span><br><span class=\"line\">    Capability: Events Supported (0x03)</span><br><span class=\"line\">    Capability Count: 0x06</span><br><span class=\"line\">    Event ID: PlaybackStatusChanged (0x01)</span><br><span class=\"line\">    Event ID: TrackChanged (0x02)</span><br><span class=\"line\">    Event ID: PlaybackPositionChanged (0x05)</span><br><span class=\"line\">    Event ID: AvailablePlayersChanged (0x0a)</span><br><span class=\"line\">    Event ID: AddressedPlayerChanged (0x0b)</span><br><span class=\"line\">    Event ID: NowPlayingContentChanged (0x09)</span><br><span class=\"line\">    [Response Time: 19/1000ms]</span><br><span class=\"line\">    [Command in frame: 288]</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"播放器状态\"><a href=\"#播放器状态\" class=\"headerlink\" title=\"播放器状态\"></a>播放器状态</h3><p><strong>CT</strong>端获取<strong>TC</strong>端播放状态，<code>Play Status</code>的参数由<code>GetFolderItems</code>原语获取，通过<code>Ctype</code>来区分操作。</p>\n<h4 id=\"注册事件\"><a href=\"#注册事件\" class=\"headerlink\" title=\"注册事件\"></a>注册事件</h4><p><code>PDU ID</code>：RegisterNotification，<code>Event ID</code>为: PlaybackStatusChanged(<code>GetCapabilities</code>原语获取)。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 300\t1.252942\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t27\tSent Vendor dependent: Notify - RegisterNotification - PlaybackStatusChanged</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    0000 .... = Reserved: 0x0</span><br><span class=\"line\">    .... 0011 = Ctype: Notify (0x3)</span><br><span class=\"line\">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class=\"line\">    .... .000 = Subunit ID: 0x0</span><br><span class=\"line\">    Opcode: Vendor dependent (0x00)</span><br><span class=\"line\">    Company ID: 00:19:58 (Bluetooth SIG, Inc.)</span><br><span class=\"line\">    PDU ID: RegisterNotification (0x31)</span><br><span class=\"line\">    0000 00.. = RFA: 0x00</span><br><span class=\"line\">    .... ..00 = Packet Type: Single (0x0)</span><br><span class=\"line\">    Parameter Length: 5</span><br><span class=\"line\">    Event ID: PlaybackStatusChanged (0x01)</span><br><span class=\"line\">    Interval: 0</span><br><span class=\"line\">    [Response Time: 107/1000ms]</span><br><span class=\"line\">    [Response in frame: 324]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 324\t1.649874\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t24\tRcvd Vendor dependent: Interim - RegisterNotification - PlaybackStatusChanged - PlayStatus: Paused</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    0000 .... = Reserved: 0x0</span><br><span class=\"line\">    .... 1111 = Ctype: Interim (0xf)</span><br><span class=\"line\">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class=\"line\">    .... .000 = Subunit ID: 0x0</span><br><span class=\"line\">    Opcode: Vendor dependent (0x00)</span><br><span class=\"line\">    Company ID: 00:19:58 (Bluetooth SIG, Inc.)</span><br><span class=\"line\">    PDU ID: RegisterNotification (0x31)</span><br><span class=\"line\">    0000 00.. = RFA: 0x00</span><br><span class=\"line\">    .... ..00 = Packet Type: Single (0x0)</span><br><span class=\"line\">    Parameter Length: 2</span><br><span class=\"line\">    Event ID: PlaybackStatusChanged (0x01)</span><br><span class=\"line\">    Play Status: Paused (0x02)</span><br><span class=\"line\">    [Response Time: 107/1000ms]</span><br><span class=\"line\">    [Command in frame: 300]</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"事件通知\"><a href=\"#事件通知\" class=\"headerlink\" title=\"事件通知\"></a>事件通知</h4><p><code>PDU ID</code>：RegisterNotification，<code>Event ID</code>为: PlaybackStatusChanged，通过<code>Ctype</code>来区分功能。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 372\t2.461590\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t24\tRcvd Vendor dependent: Changed - RegisterNotification - PlaybackStatusChanged - PlayStatus: Stopped</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    0000 .... = Reserved: 0x0</span><br><span class=\"line\">    .... 1101 = Ctype: Changed (0xd)</span><br><span class=\"line\">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class=\"line\">    .... .000 = Subunit ID: 0x0</span><br><span class=\"line\">    Opcode: Vendor dependent (0x00)</span><br><span class=\"line\">    Company ID: 00:19:58 (Bluetooth SIG, Inc.)</span><br><span class=\"line\">    PDU ID: RegisterNotification (0x31)</span><br><span class=\"line\">    0000 00.. = RFA: 0x00</span><br><span class=\"line\">    .... ..00 = Packet Type: Single (0x0)</span><br><span class=\"line\">    Parameter Length: 2</span><br><span class=\"line\">    Event ID: PlaybackStatusChanged (0x01)</span><br><span class=\"line\">    Play Status: Stopped (0x00)</span><br><span class=\"line\">    [Response Time: 107/1000ms]</span><br><span class=\"line\">    [Command in frame: 300]</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"主动获取\"><a href=\"#主动获取\" class=\"headerlink\" title=\"主动获取\"></a>主动获取</h4><p><code>PDU ID</code>：GetPlayStatus，往往与<code>RegisterNotification-TrackChanged</code>命令配合使用。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 466\t18.051244\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t22\tSent Vendor dependent: Status - GetPlayStatus</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    0000 .... = Reserved: 0x0</span><br><span class=\"line\">    .... 0001 = Ctype: Status (0x1)</span><br><span class=\"line\">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class=\"line\">    .... .000 = Subunit ID: 0x0</span><br><span class=\"line\">    Opcode: Vendor dependent (0x00)</span><br><span class=\"line\">    Company ID: 00:19:58 (Bluetooth SIG, Inc.)</span><br><span class=\"line\">    PDU ID: GetPlayStatus (0x30)</span><br><span class=\"line\">    0000 00.. = RFA: 0x00</span><br><span class=\"line\">    .... ..00 = Packet Type: Single (0x0)</span><br><span class=\"line\">    Parameter Length: 0</span><br><span class=\"line\">    [Response Time: 40/1000ms]</span><br><span class=\"line\">    [Response in frame: 478]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 478\t18.091970\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t31\tRcvd Vendor dependent: Stable - GetPlayStatus PlayStatus: Playing, SongPosition: 6118ms, SongLength: 175000ms</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    0000 .... = Reserved: 0x0</span><br><span class=\"line\">    .... 1100 = Ctype: Stable (0xc)</span><br><span class=\"line\">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class=\"line\">    .... .000 = Subunit ID: 0x0</span><br><span class=\"line\">    Opcode: Vendor dependent (0x00)</span><br><span class=\"line\">    Company ID: 00:19:58 (Bluetooth SIG, Inc.)</span><br><span class=\"line\">    PDU ID: GetPlayStatus (0x30)</span><br><span class=\"line\">    0000 00.. = RFA: 0x00</span><br><span class=\"line\">    .... ..00 = Packet Type: Single (0x0)</span><br><span class=\"line\">    Parameter Length: 9</span><br><span class=\"line\">    Song Length: 175000</span><br><span class=\"line\">    Song Position: 6118</span><br><span class=\"line\">    Play Status: Playing (0x01)</span><br><span class=\"line\">    [Response Time: 40/1000ms]</span><br><span class=\"line\">    [Command in frame: 466]</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"播放进度\"><a href=\"#播放进度\" class=\"headerlink\" title=\"播放进度\"></a>播放进度</h3><p>使用<code>PDU ID</code>：GetPlayStatus，获取<strong>TG</strong>端播放进度，<strong>CT</strong>端轮循调用此命令。其中<code>Song Length</code>参数为音乐长度，<code>Song Position</code>为当前播放进度。日志参考<code>主动获取播放器</code>章节。</p>\n<h3 id=\"音轨状态\"><a href=\"#音轨状态\" class=\"headerlink\" title=\"音轨状态\"></a>音轨状态</h3><p><strong>CT</strong>端获取<strong>TC</strong>端播放器音轨状态，状态有下面两种：</p>\n<ul>\n<li>无音轨：<code>Identifier: 0xffffffffffffffff (NOT SELECTED)</code></li>\n<li>有音轨：<code>Identifier: 0x0000000000000000 (SELECTED)</code></li>\n</ul>\n<p><strong>音轨状态事件</strong>会在每次开始播放都会有事件，歌词就是通过发送<strong>音轨状态事件</strong>来完成的。</p>\n<h4 id=\"注册事件-1\"><a href=\"#注册事件-1\" class=\"headerlink\" title=\"注册事件\"></a>注册事件</h4><p><code>PDU ID</code>：RegisterNotification，<code>Event ID</code>为: TrackChanged(<code>GetCapabilities</code>原语获取)。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 323\t1.331254\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t27\tSent Vendor dependent: Notify - RegisterNotification - TrackChanged</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    0000 .... = Reserved: 0x0</span><br><span class=\"line\">    .... 0011 = Ctype: Notify (0x3)</span><br><span class=\"line\">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class=\"line\">    .... .000 = Subunit ID: 0x0</span><br><span class=\"line\">    Opcode: Vendor dependent (0x00)</span><br><span class=\"line\">    Company ID: 00:19:58 (Bluetooth SIG, Inc.)</span><br><span class=\"line\">    PDU ID: RegisterNotification (0x31)</span><br><span class=\"line\">    0000 00.. = RFA: 0x00</span><br><span class=\"line\">    .... ..00 = Packet Type: Single (0x0)</span><br><span class=\"line\">    Parameter Length: 5</span><br><span class=\"line\">    Event ID: TrackChanged (0x02)</span><br><span class=\"line\">    Interval: 0</span><br><span class=\"line\">    [Response Time: 35/1000ms]</span><br><span class=\"line\">    [Response in frame: 330]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 330\t1.366518\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t31\tRcvd Vendor dependent: Interim - RegisterNotification - TrackChanged - 0xFFFFFFFFFFFFFFFF (NOT SELECTED)</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    0000 .... = Reserved: 0x0</span><br><span class=\"line\">    .... 1111 = Ctype: Interim (0xf)</span><br><span class=\"line\">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class=\"line\">    .... .000 = Subunit ID: 0x0</span><br><span class=\"line\">    Opcode: Vendor dependent (0x00)</span><br><span class=\"line\">    Company ID: 00:19:58 (Bluetooth SIG, Inc.)</span><br><span class=\"line\">    PDU ID: RegisterNotification (0x31)</span><br><span class=\"line\">    0000 00.. = RFA: 0x00</span><br><span class=\"line\">    .... ..00 = Packet Type: Single (0x0)</span><br><span class=\"line\">    Parameter Length: 9</span><br><span class=\"line\">    Event ID: TrackChanged (0x02)</span><br><span class=\"line\">    Identifier: 0xffffffffffffffff (NOT SELECTED)</span><br><span class=\"line\">    [Response Time: 35/1000ms]</span><br><span class=\"line\">    [Command in frame: 323]</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"事件通知-1\"><a href=\"#事件通知-1\" class=\"headerlink\" title=\"事件通知\"></a>事件通知</h4><p><code>PDU ID</code>：RegisterNotification，<code>Event ID</code>为: TrackChanged，通过<code>Ctype</code>来区分功能。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 451\t18.026715\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t31\tRcvd Vendor dependent: Changed - RegisterNotification - TrackChanged - 0x0000000000000000 (SELECTED)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"获取播放音轨的属性\"><a href=\"#获取播放音轨的属性\" class=\"headerlink\" title=\"获取播放音轨的属性\"></a>获取播放音轨的属性</h3><p>获取当前音轨，播放音乐的属性，如标题、歌手等信息。<code>Attribute List</code>请查看<a href=\"%E5%8F%82%E8%80%83\">AVRCP协议规范</a>第26章节，往往与<code>RegisterNotification-TrackChanged</code>命令配合使用。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 465\t18.050915\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t59\tSent Vendor dependent: Status - GetElementAttributes - 0x0000000000000000 (PLAYING)</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    0000 .... = Reserved: 0x0</span><br><span class=\"line\">    .... 0001 = Ctype: Status (0x1)</span><br><span class=\"line\">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class=\"line\">    .... .000 = Subunit ID: 0x0</span><br><span class=\"line\">    Opcode: Vendor dependent (0x00)</span><br><span class=\"line\">    Company ID: 00:19:58 (Bluetooth SIG, Inc.)</span><br><span class=\"line\">    PDU ID: GetElementAttributes (0x20)</span><br><span class=\"line\">    0000 00.. = RFA: 0x00</span><br><span class=\"line\">    .... ..00 = Packet Type: Single (0x0)</span><br><span class=\"line\">    Parameter Length: 37</span><br><span class=\"line\">    Identifier: 0x0000000000000000</span><br><span class=\"line\">    Number of Attributes: 7</span><br><span class=\"line\">    Attribute List</span><br><span class=\"line\">        Attribute ID: Title (0x00000001)</span><br><span class=\"line\">        Attribute ID: Artist (0x00000002)</span><br><span class=\"line\">        Attribute ID: Album (0x00000003)</span><br><span class=\"line\">        Attribute ID: Media Number (0x00000004)</span><br><span class=\"line\">        Attribute ID: Total Number of Media (0x00000005)</span><br><span class=\"line\">        Attribute ID: Genre (0x00000006)</span><br><span class=\"line\">        Attribute ID: Playing Time (0x00000007)</span><br><span class=\"line\">    [Response Time: 3/1000ms]</span><br><span class=\"line\">    [Response in frame: 469]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 469\t18.054345\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t127\tRcvd Vendor dependent: Stable - GetElementAttributes - Title: &quot;Demons&quot;</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    0000 .... = Reserved: 0x0</span><br><span class=\"line\">    .... 1100 = Ctype: Stable (0xc)</span><br><span class=\"line\">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class=\"line\">    .... .000 = Subunit ID: 0x0</span><br><span class=\"line\">    Opcode: Vendor dependent (0x00)</span><br><span class=\"line\">    Company ID: 00:19:58 (Bluetooth SIG, Inc.)</span><br><span class=\"line\">    PDU ID: GetElementAttributes (0x20)</span><br><span class=\"line\">    0000 00.. = RFA: 0x00</span><br><span class=\"line\">    .... ..00 = Packet Type: Single (0x0)</span><br><span class=\"line\">    Parameter Length: 105</span><br><span class=\"line\">    Number of Attributes: 7</span><br><span class=\"line\">    Attribute Entries</span><br><span class=\"line\">        Attribute [                Title]: Demons</span><br><span class=\"line\">        Attribute [               Artist]: Imagine Dragons</span><br><span class=\"line\">        Attribute [                Album]: Continued Silence</span><br><span class=\"line\">        Attribute [         Media Number]: 10</span><br><span class=\"line\">        Attribute [Total Number of Media]: 18</span><br><span class=\"line\">        Attribute [                Genre]: </span><br><span class=\"line\">        Attribute [         Playing Time]: 175000</span><br><span class=\"line\">    [Response Time: 3/1000ms]</span><br><span class=\"line\">    [Command in frame: 465]</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"播放器控制\"><a href=\"#播放器控制\" class=\"headerlink\" title=\"播放器控制\"></a>播放器控制</h3><p><strong>CT</strong>控制<strong>TG</strong>播放器的相关命令，都是PASS THROUGH类型，通过<code>Operation ID</code>来区分功能，通过<code>Ctype</code>来区分操作。</p>\n<h4 id=\"播放\"><a href=\"#播放\" class=\"headerlink\" title=\"播放\"></a>播放</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 298\t1.252592\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t17\tSent Pass Through: Control - PLAY (Pushed)</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    0000 .... = Reserved: 0x0</span><br><span class=\"line\">    .... 0000 = Ctype: Control (0x0)</span><br><span class=\"line\">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class=\"line\">    .... .000 = Subunit ID: 0x0</span><br><span class=\"line\">    Opcode: Pass Through (0x7c)</span><br><span class=\"line\">    0... .... = State: Pushed (0x0)</span><br><span class=\"line\">    .100 0100 = Operation ID: PLAY (0x44)</span><br><span class=\"line\">    Data Length: 0x00</span><br><span class=\"line\">    [Response Time: 14/200ms]</span><br><span class=\"line\">    [Response in frame: 308]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt;308\t1.266992\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t17\tRcvd Pass Through: Accepted - PLAY (Pushed)</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"暂停\"><a href=\"#暂停\" class=\"headerlink\" title=\"暂停\"></a>暂停</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 430\t7.424245\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t17\tSent Pass Through: Control - PAUSE (Pushed)</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    0000 .... = Reserved: 0x0</span><br><span class=\"line\">    .... 0000 = Ctype: Control (0x0)</span><br><span class=\"line\">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class=\"line\">    .... .000 = Subunit ID: 0x0</span><br><span class=\"line\">    Opcode: Pass Through (0x7c)</span><br><span class=\"line\">    0... .... = State: Pushed (0x0)</span><br><span class=\"line\">    .100 0110 = Operation ID: PAUSE (0x46)</span><br><span class=\"line\">    Data Length: 0x00</span><br><span class=\"line\">    [Response Time: 70/200ms]</span><br><span class=\"line\">    [Response in frame: 434]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 434\t7.494377\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t17\tRcvd Pass Through: Accepted - PAUSE (Pushed)</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"下一曲\"><a href=\"#下一曲\" class=\"headerlink\" title=\"下一曲\"></a>下一曲</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 1163\t40.755874\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t17\tSent Pass Through: Control - BACKWARD (Pushed)</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    0000 .... = Reserved: 0x0</span><br><span class=\"line\">    .... 0000 = Ctype: Control (0x0)</span><br><span class=\"line\">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class=\"line\">    .... .000 = Subunit ID: 0x0</span><br><span class=\"line\">    Opcode: Pass Through (0x7c)</span><br><span class=\"line\">    0... .... = State: Pushed (0x0)</span><br><span class=\"line\">    .100 1100 = Operation ID: BACKWARD (0x4c)</span><br><span class=\"line\">    Data Length: 0x00</span><br><span class=\"line\">    [Response Time: 15/200ms]</span><br><span class=\"line\">    [Response in frame: 1168]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 1168\t40.771498\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t17\tRcvd Pass Through: Accepted - BACKWARD (Pushed)</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"上一曲\"><a href=\"#上一曲\" class=\"headerlink\" title=\"上一曲\"></a>上一曲</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 969\t37.736799\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t17\tSent Pass Through: Control - FORWARD (Pushed)</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    0000 .... = Reserved: 0x0</span><br><span class=\"line\">    .... 0000 = Ctype: Control (0x0)</span><br><span class=\"line\">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class=\"line\">    .... .000 = Subunit ID: 0x0</span><br><span class=\"line\">    Opcode: Pass Through (0x7c)</span><br><span class=\"line\">    0... .... = State: Pushed (0x0)</span><br><span class=\"line\">    .100 1011 = Operation ID: FORWARD (0x4b)</span><br><span class=\"line\">    Data Length: 0x00</span><br><span class=\"line\">    [Response Time: 25/200ms]</span><br><span class=\"line\">    [Response in frame: 976]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 976\t37.762691\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t17\tRcvd Pass Through: Accepted - FORWARD (Pushed)</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><ul>\n<li>蓝牙核心协议规范<a href=\"https://www.bluetooth.org/DocMan/handlers/DownloadDoc.ashx?doc_id=286439\">Core_v4.2.pdf</a></li>\n<li>PBAP协议规范<a href=\"https://www.bluetooth.com/specifications/specs/phone-book-access-profile-1-2-3/\">PBAP_v1.2.3.pdf</a></li>\n<li>HFP协议规范<a href=\"https://www.bluetooth.com/specifications/specs/hands-free-profile-1-8/\">HFP_v1.8.pdf</a></li>\n<li>AVDTP协议规范<a href=\"https://www.bluetooth.com/specifications/specs/a-v-distribution-transport-protocol-1-3/\">AVDTP_SPEC_V13.pdf</a></li>\n<li>AVCTP协议规范<a href=\"https://www.bluetooth.com/specifications/specs/a-v-%e2%80%8b%e2%80%8bcontrol-transport-protocol-1-4/\">AVCTP_SPEC_V14.pdf</a></li>\n<li>AVRCP协议规范<a href=\"https://www.bluetooth.com/specifications/specs/a-v-remote-control-profile-1-6-2/\">AVRCP_v1.6.2.pdf</a></li>\n<li><a href=\"https://blog.csdn.net/wenzongliang/article/details/84689377\">蓝牙物理链路类型：SCO和ACL链路与A2DP</a></li>\n<li><a href=\"https://blog.csdn.net/XiaoXiaoPengBo/article/details/107792407\">安全简单配对</a></li>\n<li><a href=\"https://blog.csdn.net/u010657219/article/details/42192481\">在HCI层看蓝牙的连接过程</a></li>\n<li><a href=\"https://www.cnblogs.com/libs-liu/p/9498952.html\">蓝牙SDP协议概述 </a></li>\n<li><a href=\"https://blog.csdn.net/XiaoXiaoPengBo/article/details/108125755\">RFCOMM协议概念介绍</a></li>\n<li><a href=\"https://blog.51cto.com/u_2982693/3521456\">蓝牙的OBEX协议</a></li>\n<li><a href=\"https://blog.csdn.net/weixin_44260005/article/details/105223139\">蓝牙电话之PBAP协议分析</a></li>\n<li><a href=\"https://blog.csdn.net/shichaog/article/details/52123439\">蓝牙之八-HFP</a></li>\n<li><a href=\"https://blog.csdn.net/shichaog/article/details/52126415\">蓝牙之九-AT命令</a></li>\n</ul>\n","site":{"data":{"next":{"favicon":{"small":"/images/favicon-16x16.png","medium":"/images/favicon-32x32.png","apple_touch_icon":"/images/apple-touch-icon.png","safari_pinned_tab":"/images/safari_pinned_tab.svg"},"creative_commons":{"license":"by-nc-sa","sidebar":true,"post":true,"language":"deed.zh"},"scheme":"Gemini","darkmode":true,"avatar":{"url":"/images/avatar.jpg","rounded":true,"rotated":false},"social":{"GitHub":"https://github.com/liaoheng || fab fa-github","RSS":"/atom.xml || fa fa-rss"},"social_icons":{"enable":true,"icons_only":true,"transition":true},"codeblock":{"highlight_theme":"normal","copy_button":{"enable":true,"show_result":true,"style":null}},"github_banner":{"enable":true,"permalink":"https://github.com/liaoheng","title":"Follow me on GitHub"},"google_analytics":{"tracking_id":"G-64FL8LWFL8","only_pageview":false},"vendors":{"pace":"//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js","pace_css":"//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css"},"pace":{"enable":true,"theme":"minimal"}}}},"excerpt":"","more":"<h1 id=\"概述\"><a href=\"#概述\" class=\"headerlink\" title=\"概述\"></a>概述</h1><p>此文主要是简单的探索一下蓝牙电话和蓝牙音乐相关协议栈，所以很多细节并未涉及。</p>\n<p>一般而言，我们把某个协议的实现代码称为协议栈(protocol stack)，要理解协议栈需要先了解蓝牙的核心系统架构，如下图：</p>\n<p><img src=\"https://s1.ax1x.com/2022/04/11/LV6Ybd.png\"></p>\n<p>也可简单的<strong>抽象为3层</strong>：<img src=\"https://s1.ax1x.com/2022/04/11/LV6JDH.png\"></p>\n<ul>\n<li>**User Application(Host)**：User Application即应用层，也被称为Host，我们调用Bluetooth API就属于应用层，例如，<a href=\"https://developer.android.com/reference/android/bluetooth/BluetoothAdapter.html\">BluetoothAdapter</a>中提供的接口。</li>\n<li><strong>HCI (Host controller Interface)<strong>：上层在调用蓝牙API时，</strong>不会直接操作蓝牙底层</strong>(Controller)相关接口，而是<strong>通过HCI下发对应操作的Command给Controller</strong>，然后底层执行命令后返回执行结果，<strong>即Controller发送Event给HCI，HCI再通知给应用层</strong>，HCI起到了一个<strong>中间层</strong>的作用。</li>\n<li><strong>Controller</strong>：Controller是在最底层，硬件驱动。</li>\n</ul>\n<p>按照上面的定义，HCI与Host层中的协议实现就是<strong>蓝牙协议栈</strong>。</p>\n<h2 id=\"HCI\"><a href=\"#HCI\" class=\"headerlink\" title=\"HCI\"></a>HCI</h2><blockquote>\n<p> BLUETOOTH SPECIFICATION Version 4.2 [Vol 2, Part E] page 400  </p>\n<p> HCI（HOST CONTROLLER INTERFACE）：主机控制层接口，主要负责透过transport把协议栈的数据发送给蓝牙芯片，并且接受来自蓝牙芯片的数据，数据主要分为HCI COMMAND(HOST-&gt;CONTROLLER),HCI EVENT(HOST&lt;-CONTROLLER),HCI ACL(HOST&lt;-&gt;CONTROLLER),HCI SCO(这个有点些微差异，因为部分芯片的SCO数据不是透过TRANSPORT直接跟HOST沟通，而是通过特殊的引脚，PCM IN&#x2F;OUT&#x2F;SYNC&#x2F;CLK脚来传输数据)</p>\n</blockquote>\n<p>HOST层的几乎所有数据最后都会通过HCI，所以我们通过HCI的日志就可以了解蓝牙协议栈中每个协议，手机中可以通过开发者模式打开HCI日志开关，推荐使用<strong>wireshark</strong>或者<strong>Frontline ComProbe Protocol Analysis System</strong>来分析HCI日志，下面给出来的的日志都是<strong>wireshark</strong>的结果。</p>\n<p>HCI日志由各种数据包组成，我们需要了解其中的两种数据包如下：</p>\n<h3 id=\"Command-数据包\"><a href=\"#Command-数据包\" class=\"headerlink\" title=\"Command 数据包\"></a>Command 数据包</h3><p>HCI Command数据包格式如下，开头的<strong>Opcode是区分不同类型的命令的唯一标识</strong>，Opcode由<strong>OpCode Group Field (OGF)</strong> 和 **OpCode Command Field (OCF)**组成。根据OGF的值，可以将HCI commands进行分类。OpCode 的计算公式为：<code>OpCode = OGF &lt;&lt; 6 + OCF</code> <strong>。有了OpCode计算的方式，我们就可以</strong>通过OpCode过滤HCI log里面的指定类型的HCI Command。</p>\n<p><img src=\"https://s1.ax1x.com/2022/04/11/LV608f.png\"></p>\n<p>一次HCI Command指令发送完成，通常两条数据包，一条是host给controller的指令，一条是controller给host的指令反馈，可以确定指令发送是成功的。</p>\n<h3 id=\"Event-数据包\"><a href=\"#Event-数据包\" class=\"headerlink\" title=\"Event 数据包\"></a>Event 数据包</h3><p>HCI Event 数据包由controller发送给Host，其中可以是蓝牙设备的消息也可以是连接的蓝牙设备的消息。</p>\n<p><img src=\"https://s1.ax1x.com/2022/04/11/LV6B28.png\"></p>\n<h1 id=\"设备连接\"><a href=\"#设备连接\" class=\"headerlink\" title=\"设备连接\"></a>设备连接</h1><h2 id=\"蓝牙设备状态\"><a href=\"#蓝牙设备状态\" class=\"headerlink\" title=\"蓝牙设备状态\"></a>蓝牙设备状态</h2><blockquote>\n<p>BLUETOOTH SPECIFICATION Version 4.2 [Vol 2, Part B] page 159  </p>\n</blockquote>\n<p>扫描设备然后与之建立连接是蓝牙工作流程的第一步，所以先要了解一下蓝牙的状态如下图：</p>\n<p><img src=\"https://s1.ax1x.com/2022/04/11/LV6wPP.png\"></p>\n<p>从<u>蓝牙状态转换图</u>中可以看出 STANDBY状体是蓝牙设备的默认状态。</p>\n<p><strong>Page</strong>：这个子状态就是我们通常称为的连接(寻呼)，进行连接&#x2F;激活对应的slave的操作我们就称为page。</p>\n<p><strong>Page scan</strong>：这个子状态是和page对应的，它就是等待被page的slave所处的状态，换句话说，若想被page到，我们就要处于page scan的状态。</p>\n<p><strong>inquiry</strong>：这就是我们通常所说的扫描状态，这个状态的设备就是去扫描周围的设备。</p>\n<p><strong>inquiry scan</strong>：这就是我们通常看到的可被发现的设备。体现在上层就是我们在android系统中点击设备可被周围什么发现，那设备就处于这样的状态。</p>\n<h2 id=\"逻辑链路传输协议\"><a href=\"#逻辑链路传输协议\" class=\"headerlink\" title=\"逻辑链路传输协议\"></a>逻辑链路传输协议</h2><h3 id=\"ACL\"><a href=\"#ACL\" class=\"headerlink\" title=\"ACL\"></a>ACL</h3><blockquote>\n<p>BLUETOOTH SPECIFICATION Version 4.2 [Vol 1, Part A]  page  63  </p>\n<p>The asynchronous connection-oriented (ACL) logical transport is used to carry<br>LMP and L2CAP control signaling and best effort asynchronous user data. The<br>ACL logical transport uses a 1-bit ARQN&#x2F;SEQN scheme to provide simple<br>channel reliability. Every active slave device within a piconet has one ACL<br>logical transport to the piconet master, known as the default ACL.  </p>\n</blockquote>\n<p>ACL全称<strong>BR&#x2F;EDR Asynchronous Connection-oriented</strong>，定向连接，它既支持对称连接，也支持不对称连接（既可以一对一，也可以一对多）。主设备负责控制链路带宽，并决定微微网中的每个从设备可以占用多少带宽和连接的对称性。从设备只有被选中时才能传送数据。ACL链路也支持接收主设备发给微微网中所有从设备的广播消息。</p>\n<p>建立ACL需要设备HCI之间进行的下面的操作，这个也与<strong>蓝牙状态</strong>息息相关。</p>\n<h4 id=\"开始扫描\"><a href=\"#开始扫描\" class=\"headerlink\" title=\"开始扫描\"></a>开始扫描</h4><ul>\n<li><p><strong>Host</strong>:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LocalBluetoothManager.getInstance().getBluetoothAdapter().startScanning(<span class=\"literal\">true</span>);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>Controller</strong>:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#发送扫描指令</span><br><span class=\"line\">&gt; 103\t4.351128\thost\tcontroller\tHCI_CMD\t9\tSent Inquiry</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - Inquiry</span><br><span class=\"line\">    Command Opcode: Inquiry (0x0401)</span><br><span class=\"line\">        0000 01.. .... .... = Opcode Group Field: Link Control Commands (0x01)</span><br><span class=\"line\">        .... ..00 0000 0001 = Opcode Command Field: Inquiry (0x001)</span><br><span class=\"line\">    Parameter Total Length: 5</span><br><span class=\"line\">    LAP: 0x9e8b33</span><br><span class=\"line\">    Inquiry Length: 10 (12.8 sec)</span><br><span class=\"line\">    Num Responses: 0</span><br><span class=\"line\">    [Pending in frame: 104]</span><br><span class=\"line\">    [Command-Pending Delta: 0.846ms]</span><br><span class=\"line\">    [Response in frame: 429]</span><br><span class=\"line\">    [Command-Response Delta: 12811.07ms]</span><br><span class=\"line\"></span><br><span class=\"line\">#HCI反馈扫描指令状态</span><br><span class=\"line\">&gt; 104\t4.351974\tcontroller\thost\tHCI_EVT\t7\tRcvd Command Status (Inquiry)</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Command Status</span><br><span class=\"line\">    Event Code: Command Status (0x0f)</span><br><span class=\"line\">    Parameter Total Length: 4</span><br><span class=\"line\">    Status: Pending (0x00)</span><br><span class=\"line\">    Number of Allowed Command Packets: 1</span><br><span class=\"line\">    Command Opcode: Inquiry (0x0401)</span><br><span class=\"line\">    [Command in frame: 103]</span><br><span class=\"line\">    [Response in frame: 429]</span><br><span class=\"line\">    [Command-Pending Delta: 0.846ms]</span><br><span class=\"line\">    [Pending-Response Delta: 12810.224ms]</span><br><span class=\"line\"></span><br><span class=\"line\">#HCI发送的扫描到的设备信息</span><br><span class=\"line\">&gt; 114\t4.505582\tcontroller\thost\tHCI_EVT\t258\tRcvd Extended Inquiry Result</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Extended Inquiry Result</span><br><span class=\"line\">    Event Code: Extended Inquiry Result (0x2f)</span><br><span class=\"line\">    Parameter Total Length: 255</span><br><span class=\"line\">    Number of responses: 1</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_77:c2:35 (00:00:00:00:00:00)</span><br><span class=\"line\">    Page Scan Repetition Mode: R1 (0x01)</span><br><span class=\"line\">    Reserved: 0x02</span><br><span class=\"line\">    Class of Device: 0x5a020c (Phone:Smartphone - services: Networking Capturing ObjectTransfer Telephony)</span><br><span class=\"line\">    .000 0000 0011 0100 = Clock Offset: 0x0034</span><br><span class=\"line\">    RSSI: -88 dBm</span><br><span class=\"line\">    Extended Inquiry Response Data</span><br><span class=\"line\">        Device Name: +My Phone1234567890123456789012</span><br><span class=\"line\">        16-bit Service Class UUIDs</span><br><span class=\"line\">        32-bit Service Class UUIDs</span><br><span class=\"line\">        128-bit Service Class UUIDs</span><br><span class=\"line\">        Unused</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"停止扫描\"><a href=\"#停止扫描\" class=\"headerlink\" title=\"停止扫描\"></a>停止扫描</h4><ul>\n<li><p><strong>Host</strong>:</p>\n  <figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LocalBluetoothManager.getInstance().getBluetoothAdapter().stopScanning();</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>Controller</strong>:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 85\t2.202129\thost\tcontroller\tHCI_CMD\t4\tSent Inquiry Cancel</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - Inquiry Cancel</span><br><span class=\"line\">    Command Opcode: Inquiry Cancel (0x0402)</span><br><span class=\"line\">        0000 01.. .... .... = Opcode Group Field: Link Control Commands (0x01)</span><br><span class=\"line\">        .... ..00 0000 0010 = Opcode Command Field: Inquiry Cancel (0x002)</span><br><span class=\"line\">    Parameter Total Length: 0</span><br><span class=\"line\">    [Response in frame: 86]</span><br><span class=\"line\">    [Command-Response Delta: 2.051ms]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 86\t2.204180\tcontroller\thost\tHCI_EVT\t7\tRcvd Command Complete (Inquiry Cancel)</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Command Complete</span><br><span class=\"line\">    Event Code: Command Complete (0x0e)</span><br><span class=\"line\">    Parameter Total Length: 4</span><br><span class=\"line\">    Number of Allowed Command Packets: 1</span><br><span class=\"line\">    Command Opcode: Inquiry Cancel (0x0402)</span><br><span class=\"line\">    Status: Success (0x00)</span><br><span class=\"line\">    [Command in frame: 85]</span><br><span class=\"line\">    [Command-Response Delta: 2.051ms]</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"完成扫描\"><a href=\"#完成扫描\" class=\"headerlink\" title=\"完成扫描\"></a>完成扫描</h4><ul>\n<li><p><strong>Host</strong>:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LocalBluetoothManager.getInstance().getEventManager().registerCallback(<span class=\"keyword\">new</span> <span class=\"title class_\">BluetoothCallback</span>() &#123;</span><br><span class=\"line\">   \t\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onScanningStateChanged</span><span class=\"params\">(<span class=\"type\">boolean</span> started)</span> &#123;</span><br><span class=\"line\">\t\t&#125; </span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>Controller</strong>:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 429\t17.162198\tcontroller\thost\tHCI_EVT\t4\tRcvd Inquiry Complete</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Inquiry Complete</span><br><span class=\"line\">    Event Code: Inquiry Complete (0x01)</span><br><span class=\"line\">    Parameter Total Length: 1</span><br><span class=\"line\">    Status: Success (0x00)</span><br><span class=\"line\">    [Command in frame: 103]</span><br><span class=\"line\">    [Pending in frame: 104]</span><br><span class=\"line\">    [Pending-Response Delta: 12810.224ms]</span><br><span class=\"line\">    [Command-Response Delta: 12811.07ms]</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"设备配对\"><a href=\"#设备配对\" class=\"headerlink\" title=\"设备配对\"></a>设备配对</h4><p><img src=\"https://s1.ax1x.com/2022/04/11/LV6GKe.png\"></p>\n<h5 id=\"配对\"><a href=\"#配对\" class=\"headerlink\" title=\"配对\"></a>配对</h5><ul>\n<li><p><strong>Host</strong>:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CachedBluetoothDevice.startPairing();</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>Controller</strong>:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#删除需要连接设备本地记忆的Link Key</span><br><span class=\"line\">&gt; 685\t33.812149\thost\tcontroller\tHCI_CMD\t11\tSent Delete Stored Link Key</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - Delete Stored Link Key</span><br><span class=\"line\">    Command Opcode: Delete Stored Link Key (0x0c12)</span><br><span class=\"line\">        0000 11.. .... .... = Opcode Group Field: Host Controller &amp; Baseband Commands (0x03)</span><br><span class=\"line\">        .... ..00 0001 0010 = Opcode Command Field: Delete Stored Link Key (0x012)</span><br><span class=\"line\">    Parameter Total Length: 7</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Delete All Flag: Delete only Link Key for specified BD_ADDR (0x00)</span><br><span class=\"line\">    [Response in frame: 686]</span><br><span class=\"line\">    [Command-Response Delta: 2.147ms]</span><br><span class=\"line\"></span><br><span class=\"line\">#建立ACL连接</span><br><span class=\"line\">&gt; 687\t33.814531\thost\tcontroller\tHCI_CMD\t17\tSent Create Connection</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - Create Connection</span><br><span class=\"line\">    Command Opcode: Create Connection (0x0405)</span><br><span class=\"line\">    Parameter Total Length: 13</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Packet Type: 0xcc18, DH5, DM5, DH3, DM3, DH1, DM1</span><br><span class=\"line\">    Page Scan Repetition Mode: R1 (0x01)</span><br><span class=\"line\">    Page Scan Mode: Mandatory Page Scan Mode (0x00)</span><br><span class=\"line\">    .000 0010 0000 1000 = Clock Offset: 0x0208 (650 msec)</span><br><span class=\"line\">    1... .... .... .... = Clock_Offset_Valid_Flag: true (1)</span><br><span class=\"line\">    Allow Role Switch: Local device may be master, or may become slave after accepting a master slave switch. (0x01)</span><br><span class=\"line\">    [Pending in frame: 688]</span><br><span class=\"line\">    [Command-Pending Delta: 0.965ms]</span><br><span class=\"line\">    [Response in frame: 690]</span><br><span class=\"line\">    [Command-Response Delta: 1118.609ms]</span><br><span class=\"line\"></span><br><span class=\"line\">#建立ACL连接成功</span><br><span class=\"line\">&gt; 690\t34.933140\tcontroller\thost\tHCI_EVT\t14\tRcvd Connect Complete</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Connect Complete</span><br><span class=\"line\">    Event Code: Connect Complete (0x03)</span><br><span class=\"line\">    Parameter Total Length: 11</span><br><span class=\"line\">    Status: Success (0x00)</span><br><span class=\"line\">    Connection Handle: 0x0033</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Link Type: ACL connection (Data Channels) (0x01)</span><br><span class=\"line\">    Encryption Mode: Encryption Disabled (0x00)</span><br><span class=\"line\">    [Command in frame: 687]</span><br><span class=\"line\">    [Pending in frame: 688]</span><br><span class=\"line\">    [Pending-Response Delta: 1117.644ms]</span><br><span class=\"line\">    [Command-Response Delta: 1118.609ms]</span><br><span class=\"line\"></span><br><span class=\"line\">#改变当前设备的角色，这里当前设备为从(Slave)，连接设备为主(Master)</span><br><span class=\"line\">&gt; 689\t34.929964\tcontroller\thost\tHCI_EVT\t11\tRcvd Role Change</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Role Change</span><br><span class=\"line\">    Event Code: Role Change (0x12)</span><br><span class=\"line\">    Parameter Total Length: 8</span><br><span class=\"line\">    Status: Success (0x00)</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Role: Currently the Slave for specified BD_ADDR (0x01)</span><br><span class=\"line\"></span><br><span class=\"line\">#与设备建立连接之后，准备开始验证</span><br><span class=\"line\">&gt; 697\t34.935615\thost\tcontroller\tHCI_CMD\t6\tSent Authentication Requested</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - Authentication Requested</span><br><span class=\"line\">    Command Opcode: Authentication Requested (0x0411)</span><br><span class=\"line\">    Parameter Total Length: 2</span><br><span class=\"line\">    Connection Handle: 0x0033</span><br><span class=\"line\">    [Pending in frame: 699]</span><br><span class=\"line\">    [Command-Pending Delta: 0.917ms]</span><br><span class=\"line\">    [Response in frame: 743]</span><br><span class=\"line\">    [Command-Response Delta: 4291.694ms]</span><br><span class=\"line\"></span><br><span class=\"line\">#连接设备询问Link Key</span><br><span class=\"line\">&gt; 701\t34.936976\tcontroller\thost\tHCI_EVT\t9\tRcvd Link Key Request</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Link Key Request</span><br><span class=\"line\">    Event Code: Link Key Request (0x17)</span><br><span class=\"line\">    Parameter Total Length: 6</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\"></span><br><span class=\"line\">#当前设备无Link Key，也就是未于连接设备配对过</span><br><span class=\"line\">&gt; 705\t34.938603\thost\tcontroller\tHCI_CMD\t10\tSent Link Key Request Negative Reply</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - Link Key Request Negative Reply</span><br><span class=\"line\">    Command Opcode: Link Key Request Negative Reply (0x040c)</span><br><span class=\"line\">        0000 01.. .... .... = Opcode Group Field: Link Control Commands (0x01)</span><br><span class=\"line\">        .... ..00 0000 1100 = Opcode Command Field: Link Key Request Negative Reply (0x00c)</span><br><span class=\"line\">    Parameter Total Length: 6</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    [Response in frame: 706]</span><br><span class=\"line\">    [Command-Response Delta: 0.87ms]</span><br><span class=\"line\"></span><br><span class=\"line\">#使用的配对方式是`简单安全配对`SSP(Simple Secure Pairng), 就是直接弹配对码</span><br><span class=\"line\"></span><br><span class=\"line\">#连接设备询问当前设备的IO能力</span><br><span class=\"line\">&gt; 707\t34.939729\tcontroller\thost\tHCI_EVT\t9\tRcvd IO Capability Request</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - IO Capability Request</span><br><span class=\"line\">    Event Code: IO Capability Request (0x31)</span><br><span class=\"line\">    Parameter Total Length: 6</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\"></span><br><span class=\"line\">#回复当前设备的IO能力</span><br><span class=\"line\">&gt;708\t34.939897\thost\tcontroller\tHCI_CMD\t13\tSent IO Capability Request Reply</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - IO Capability Request Reply</span><br><span class=\"line\">    Command Opcode: IO Capability Request Reply (0x042b)</span><br><span class=\"line\">        0000 01.. .... .... = Opcode Group Field: Link Control Commands (0x01)</span><br><span class=\"line\">        .... ..00 0010 1011 = Opcode Command Field: IO Capability Request Reply (0x02b)</span><br><span class=\"line\">    Parameter Total Length: 9</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    IO Capability: Display Yes/No (1)</span><br><span class=\"line\">    OOB Data Present: OOB Authentication Data Not Present (0)</span><br><span class=\"line\">    Authentication Requirements: MITM Protection Required - Dedicated Bonding. Use IO Capability To Determine Procedure, No Secure Connection (3)</span><br><span class=\"line\">    [Response in frame: 709]</span><br><span class=\"line\">    [Command-Response Delta: 0.811ms]</span><br><span class=\"line\"></span><br><span class=\"line\">######其它参数同步</span><br><span class=\"line\"></span><br><span class=\"line\">#连接设备的IO能力，io能力参数为Display Yes/No (0x01)，需要用户确认</span><br><span class=\"line\">&gt; 737\t36.532369\tcontroller\thost\tHCI_EVT\t12\tRcvd IO Capability Response</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - IO Capability Response</span><br><span class=\"line\">    Event Code: IO Capability Response (0x32)</span><br><span class=\"line\">    Parameter Total Length: 9</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    IO Capability: Display Yes/No (0x01)</span><br><span class=\"line\">    OOB Data Present: OOB Authentication Data Not Present (0)</span><br><span class=\"line\">    Authentication Requirements: MITM Protection Required - Dedicated Bonding. Use IO Capability To Determine Procedure, No Secure Connection (3)</span><br><span class=\"line\"></span><br><span class=\"line\">#当前设备接收到配对码信息，Numeric Value就是显示的配对码</span><br><span class=\"line\">&gt; 738\t37.066181\tcontroller\thost\tHCI_EVT\t13\tRcvd User Confirmation Request</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - User Confirmation Request</span><br><span class=\"line\">    Event Code: User Confirmation Request (0x33)</span><br><span class=\"line\">    Parameter Total Length: 10</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Numeric Value: 446514</span><br><span class=\"line\"></span><br><span class=\"line\">#回复连接设备已接收到配对码信息</span><br><span class=\"line\">&gt; 739\t37.096306\thost\tcontroller\tHCI_CMD\t10\tSent User Confirmation Request Reply</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - User Confirmation Request Reply</span><br><span class=\"line\">    Command Opcode: User Confirmation Request Reply (0x042c)</span><br><span class=\"line\">        0000 01.. .... .... = Opcode Group Field: Link Control Commands (0x01)</span><br><span class=\"line\">        .... ..00 0010 1100 = Opcode Command Field: User Confirmation Request Reply (0x02c)</span><br><span class=\"line\">    Parameter Total Length: 6</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    [Response in frame: 740]</span><br><span class=\"line\">    [Command-Response Delta: 1.46ms]</span><br><span class=\"line\"></span><br><span class=\"line\">#连接设备SSP验证成功</span><br><span class=\"line\">&gt; 741\t39.215747\tcontroller\thost\tHCI_EVT\t10\tRcvd Simple Pairing Complete</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Simple Pairing Complete</span><br><span class=\"line\">    Event Code: Simple Pairing Complete (0x36)</span><br><span class=\"line\">    Parameter Total Length: 7</span><br><span class=\"line\">    Status: Success (0x00)</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\"></span><br><span class=\"line\">#连接设备的Link Key，需要保存，用于下次连接</span><br><span class=\"line\">&gt; 742\t39.226970\tcontroller\thost\tHCI_EVT\t26\tRcvd Link Key Notification</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Link Key Notification</span><br><span class=\"line\">    Event Code: Link Key Notification (0x18)</span><br><span class=\"line\">    Parameter Total Length: 23</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Link Key: bc31fb070e91eec2f2296fbf9bc8b518</span><br><span class=\"line\">    Key Type: Unknown (0x08)</span><br><span class=\"line\"></span><br><span class=\"line\">#验证完成</span><br><span class=\"line\">&gt; 743\t39.227309\tcontroller\thost\tHCI_EVT\t6\tRcvd Authentication Complete</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Authentication Complete</span><br><span class=\"line\">    Event Code: Authentication Complete (0x06)</span><br><span class=\"line\">    Parameter Total Length: 3</span><br><span class=\"line\">    Status: Success (0x00)</span><br><span class=\"line\">    Connection Handle: 0x0033</span><br><span class=\"line\">    [Command in frame: 697]</span><br><span class=\"line\">    [Pending in frame: 699]</span><br><span class=\"line\">    [Pending-Response Delta: 4290.777ms]</span><br><span class=\"line\">    [Command-Response Delta: 4291.694ms]</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h5 id=\"被配对\"><a href=\"#被配对\" class=\"headerlink\" title=\"被配对\"></a>被配对</h5><ul>\n<li><p><strong>Host</strong>:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LocalBluetoothManager.getInstance().getEventManager().registerCallback(<span class=\"keyword\">new</span> <span class=\"title class_\">BluetoothCallback</span>() &#123;</span><br><span class=\"line\">   \t\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onDeviceBondStateChanged</span><span class=\"params\">(CachedBluetoothDevice cachedDevice, <span class=\"type\">int</span> bondState)</span> &#123;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>Controller</strong>:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#请求ACL连接</span><br><span class=\"line\">&gt; 326\t21.946869\tcontroller\thost\tHCI_EVT\t13\tRcvd Connect Request</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Connect Request</span><br><span class=\"line\">    Event Code: Connect Request (0x04)</span><br><span class=\"line\">    Parameter Total Length: 10</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Class of Device: 0x5a020c (Phone:Smartphone - services: Networking Capturing ObjectTransfer Telephony)</span><br><span class=\"line\">    Link Type: ACL connection (Data Channels) (0x01)</span><br><span class=\"line\"></span><br><span class=\"line\">#允许ACL连接</span><br><span class=\"line\">&gt; 327\t21.947178\thost\tcontroller\tHCI_CMD\t11\tSent Accept Connection Request</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - Accept Connection Request</span><br><span class=\"line\">    Command Opcode: Accept Connection Request (0x0409)</span><br><span class=\"line\">    Parameter Total Length: 7</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Role: Remain the Slave for this connection. The LM will NOT perform the role switch. (0x01)</span><br><span class=\"line\">    [Pending in frame: 328]</span><br><span class=\"line\">    [Command-Pending Delta: 0.685ms]</span><br><span class=\"line\">    [Response in frame: 329]</span><br><span class=\"line\">    [Command-Response Delta: 4.432ms]</span><br><span class=\"line\"></span><br><span class=\"line\">#ACL连接成功</span><br><span class=\"line\">&gt; 329\t21.951610\tcontroller\thost\tHCI_EVT\t14\tRcvd Connect Complete</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Connect Complete</span><br><span class=\"line\">    Event Code: Connect Complete (0x03)</span><br><span class=\"line\">    Parameter Total Length: 11</span><br><span class=\"line\">    Status: Success (0x00)</span><br><span class=\"line\">    Connection Handle: 0x0033</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Link Type: ACL connection (Data Channels) (0x01)</span><br><span class=\"line\">    Encryption Mode: Encryption Disabled (0x00)</span><br><span class=\"line\">    [Command in frame: 327]</span><br><span class=\"line\">    [Pending in frame: 328]</span><br><span class=\"line\">    [Pending-Response Delta: 3.747ms]</span><br><span class=\"line\">    [Command-Response Delta: 4.432ms]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 370\t22.259461\tcontroller\thost\tHCI_EVT\t12\tRcvd IO Capability Response</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - IO Capability Response</span><br><span class=\"line\">    Event Code: IO Capability Response (0x32)</span><br><span class=\"line\">    Parameter Total Length: 9</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    IO Capability: Display Yes/No (0x01)</span><br><span class=\"line\">    OOB Data Present: OOB Authentication Data Not Present (0)</span><br><span class=\"line\">    Authentication Requirements: MITM Protection Required - Dedicated Bonding. Use IO Capability To Determine Procedure, No Secure Connection (3)</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 371\t22.259809\tcontroller\thost\tHCI_EVT\t9\tRcvd IO Capability Request</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - IO Capability Request</span><br><span class=\"line\">    Event Code: IO Capability Request (0x31)</span><br><span class=\"line\">    Parameter Total Length: 6</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 372\t22.259982\thost\tcontroller\tHCI_CMD\t13\tSent IO Capability Request Reply</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - IO Capability Request Reply</span><br><span class=\"line\">    Command Opcode: IO Capability Request Reply (0x042b)</span><br><span class=\"line\">    Parameter Total Length: 9</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    IO Capability: Display Yes/No (1)</span><br><span class=\"line\">    OOB Data Present: OOB Authentication Data Not Present (0)</span><br><span class=\"line\">    Authentication Requirements: MITM Protection Required - Dedicated Bonding. Use IO Capability To Determine Procedure, No Secure Connection (3)</span><br><span class=\"line\">    [Response in frame: 373]</span><br><span class=\"line\">    [Command-Response Delta: 0.619ms]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 374\t22.958223\tcontroller\thost\tHCI_EVT\t13\tRcvd User Confirmation Request</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - User Confirmation Request</span><br><span class=\"line\">    Event Code: User Confirmation Request (0x33)</span><br><span class=\"line\">    Parameter Total Length: 10</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Numeric Value: 804568</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 375\t23.069385\thost\tcontroller\tHCI_CMD\t10\tSent User Confirmation Request Reply</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - User Confirmation Request Reply</span><br><span class=\"line\">    Command Opcode: User Confirmation Request Reply (0x042c)</span><br><span class=\"line\">    Parameter Total Length: 6</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    [Response in frame: 376]</span><br><span class=\"line\">    [Command-Response Delta: 1.81ms]</span><br><span class=\"line\"></span><br><span class=\"line\">#连接设备SSP验证成功</span><br><span class=\"line\">&gt; 377\t26.919540\tcontroller\thost\tHCI_EVT\t10\tRcvd Simple Pairing Complete</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Simple Pairing Complete</span><br><span class=\"line\">    Event Code: Simple Pairing Complete (0x36)</span><br><span class=\"line\">    Parameter Total Length: 7</span><br><span class=\"line\">    Status: Success (0x00)</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\"></span><br><span class=\"line\">#连接设备的Link Key，需要保存，用于下次连接</span><br><span class=\"line\">&gt; 378\t26.926691\tcontroller\thost\tHCI_EVT\t26\tRcvd Link Key Notification</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Link Key Notification</span><br><span class=\"line\">    Event Code: Link Key Notification (0x18)</span><br><span class=\"line\">    Parameter Total Length: 23</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Link Key: 2160acf6b7403a97050f64de72570b1d</span><br><span class=\"line\">    Key Type: Unknown (0x08)</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"设备连接-1\"><a href=\"#设备连接-1\" class=\"headerlink\" title=\"设备连接\"></a>设备连接</h4><p><img src=\"https://s1.ax1x.com/2022/04/11/LV63vD.png\"></p>\n<h5 id=\"连接\"><a href=\"#连接\" class=\"headerlink\" title=\"连接\"></a>连接</h5><ul>\n<li><p><strong>Host</strong>:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CachedBluetoothDevice.conntect(<span class=\"literal\">true</span>);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>Controller</strong>:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 1214\t47.023224\thost\tcontroller\tHCI_CMD\t17\tSent Create Connection</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - Create Connection</span><br><span class=\"line\">    Command Opcode: Create Connection (0x0405)</span><br><span class=\"line\">    Parameter Total Length: 13</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Packet Type: 0xcc18, DH5, DM5, DH3, DM3, DH1, DM1</span><br><span class=\"line\">    Page Scan Repetition Mode: R1 (0x01)</span><br><span class=\"line\">    Page Scan Mode: Mandatory Page Scan Mode (0x00)</span><br><span class=\"line\">    .011 1001 0100 0100 = Clock Offset: 0x3944 (18325 msec)</span><br><span class=\"line\">    1... .... .... .... = Clock_Offset_Valid_Flag: true (1)</span><br><span class=\"line\">    Allow Role Switch: Local device may be master, or may become slave after accepting a master slave switch. (0x01)</span><br><span class=\"line\">    [Pending in frame: 1215]</span><br><span class=\"line\">    [Command-Pending Delta: 1.458ms]</span><br><span class=\"line\">    [Response in frame: 1217]</span><br><span class=\"line\">    [Command-Response Delta: 1630.81ms]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 1216\t48.646874\tcontroller\thost\tHCI_EVT\t11\tRcvd Role Change</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Role Change</span><br><span class=\"line\">    Event Code: Role Change (0x12)</span><br><span class=\"line\">    Parameter Total Length: 8</span><br><span class=\"line\">    Status: Success (0x00)</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Role: Currently the Slave for specified BD_ADDR (0x01)</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 1217\t48.654034\tcontroller\thost\tHCI_EVT\t14\tRcvd Connect Complete</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Connect Complete</span><br><span class=\"line\">    Event Code: Connect Complete (0x03)</span><br><span class=\"line\">    Parameter Total Length: 11</span><br><span class=\"line\">    Status: Success (0x00)</span><br><span class=\"line\">    Connection Handle: 0x0033</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Link Type: ACL connection (Data Channels) (0x01)</span><br><span class=\"line\">    Encryption Mode: Encryption Disabled (0x00)</span><br><span class=\"line\">    [Command in frame: 1214]</span><br><span class=\"line\">    [Pending in frame: 1215]</span><br><span class=\"line\">    [Pending-Response Delta: 1629.352ms]</span><br><span class=\"line\">    [Command-Response Delta: 1630.81ms]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 1278\t48.812485\thost\tcontroller\tHCI_CMD\t6\tSent Authentication Requested</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - Authentication Requested</span><br><span class=\"line\">    Command Opcode: Authentication Requested (0x0411)</span><br><span class=\"line\">    Parameter Total Length: 2</span><br><span class=\"line\">    Connection Handle: 0x0033</span><br><span class=\"line\">    [Pending in frame: 1279]</span><br><span class=\"line\">    [Command-Pending Delta: 0.945ms]</span><br><span class=\"line\">    [Response in frame: 1283]</span><br><span class=\"line\">    [Command-Response Delta: 16.693ms]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 1280\t48.813892\tcontroller\thost\tHCI_EVT\t9\tRcvd Link Key Request</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Link Key Request</span><br><span class=\"line\">    Event Code: Link Key Request (0x17)</span><br><span class=\"line\">    Parameter Total Length: 6</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 1281\t48.814039\thost\tcontroller\tHCI_CMD\t26\tSent Link Key Request Reply</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - Link Key Request Reply</span><br><span class=\"line\">    Command Opcode: Link Key Request Reply (0x040b)</span><br><span class=\"line\">    Parameter Total Length: 22</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Link Key: 2160acf6b7403a97050f64de72570b1d</span><br><span class=\"line\">    [Response in frame: 1282]</span><br><span class=\"line\">    [Command-Response Delta: 1.336ms]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 1282\t48.815375\tcontroller\thost\tHCI_EVT\t13\tRcvd Command Complete (Link Key Request Reply)</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Command Complete</span><br><span class=\"line\">    Event Code: Command Complete (0x0e)</span><br><span class=\"line\">    Parameter Total Length: 10</span><br><span class=\"line\">    Number of Allowed Command Packets: 1</span><br><span class=\"line\">    Command Opcode: Link Key Request Reply (0x040b)</span><br><span class=\"line\">    Status: Success (0x00)</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    [Command in frame: 1281]</span><br><span class=\"line\">    [Command-Response Delta: 1.336ms]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 1283\t48.829178\tcontroller\thost\tHCI_EVT\t6\tRcvd Authentication Complete</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Authentication Complete</span><br><span class=\"line\">    Event Code: Authentication Complete (0x06)</span><br><span class=\"line\">    Parameter Total Length: 3</span><br><span class=\"line\">    Status: Success (0x00)</span><br><span class=\"line\">    Connection Handle: 0x0033</span><br><span class=\"line\">    [Command in frame: 1278]</span><br><span class=\"line\">    [Pending in frame: 1279]</span><br><span class=\"line\">    [Pending-Response Delta: 15.748ms]</span><br><span class=\"line\">    [Command-Response Delta: 16.693ms]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h5 id=\"被连接\"><a href=\"#被连接\" class=\"headerlink\" title=\"被连接\"></a>被连接</h5><ul>\n<li><p><strong>Host</strong>:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LocalBluetoothManager.getInstance().getEventManager().registerCallback(<span class=\"keyword\">new</span> <span class=\"title class_\">BluetoothCallback</span>() &#123;</span><br><span class=\"line\">   \t\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onConnectionStateChanged</span><span class=\"params\">(CachedBluetoothDevice cachedDevice, <span class=\"type\">int</span> bondState)</span> &#123;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>Controller</strong>:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 1900\t62.151696\tcontroller\thost\tHCI_EVT\t13\tRcvd Connect Request</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Connect Request</span><br><span class=\"line\">    Event Code: Connect Request (0x04)</span><br><span class=\"line\">    Parameter Total Length: 10</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Class of Device: 0x5a020c (Phone:Smartphone - services: Networking Capturing ObjectTransfer Telephony)</span><br><span class=\"line\">    Link Type: ACL connection (Data Channels) (0x01)</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 1901\t62.152042\thost\tcontroller\tHCI_CMD\t11\tSent Accept Connection Request</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - Accept Connection Request</span><br><span class=\"line\">    Command Opcode: Accept Connection Request (0x0409)</span><br><span class=\"line\">    Parameter Total Length: 7</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Role: Remain the Slave for this connection. The LM will NOT perform the role switch. (0x01)</span><br><span class=\"line\">    [Pending in frame: 1902]</span><br><span class=\"line\">    [Command-Pending Delta: 0.748ms]</span><br><span class=\"line\">    [Response in frame: 1903]</span><br><span class=\"line\">    [Command-Response Delta: 4.455ms]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 1903\t62.156497\tcontroller\thost\tHCI_EVT\t14\tRcvd Connect Complete</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Connect Complete</span><br><span class=\"line\">    Event Code: Connect Complete (0x03)</span><br><span class=\"line\">    Parameter Total Length: 11</span><br><span class=\"line\">    Status: Success (0x00)</span><br><span class=\"line\">    Connection Handle: 0x0032</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Link Type: ACL connection (Data Channels) (0x01)</span><br><span class=\"line\">    Encryption Mode: Encryption Disabled (0x00)</span><br><span class=\"line\">    [Command in frame: 1901]</span><br><span class=\"line\">    [Pending in frame: 1902]</span><br><span class=\"line\">    [Pending-Response Delta: 3.707ms]</span><br><span class=\"line\">    [Command-Response Delta: 4.455ms]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 1968\t62.415419\tcontroller\thost\tHCI_EVT\t9\tRcvd Link Key Request</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Link Key Request</span><br><span class=\"line\">    Event Code: Link Key Request (0x17)</span><br><span class=\"line\">    Parameter Total Length: 6</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 1969\t62.415629\thost\tcontroller\tHCI_CMD\t26\tSent Link Key Request Reply</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - Link Key Request Reply</span><br><span class=\"line\">    Command Opcode: Link Key Request Reply (0x040b)</span><br><span class=\"line\">    Parameter Total Length: 22</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Link Key: 2160acf6b7403a97050f64de72570b1d</span><br><span class=\"line\">    [Response in frame: 1971]</span><br><span class=\"line\">    [Command-Response Delta: 0.934ms]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 1971\t62.416563\tcontroller\thost\tHCI_EVT\t13\tRcvd Command Complete (Link Key Request Reply)</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Command Complete</span><br><span class=\"line\">    Event Code: Command Complete (0x0e)</span><br><span class=\"line\">    Parameter Total Length: 10</span><br><span class=\"line\">    Number of Allowed Command Packets: 1</span><br><span class=\"line\">    Command Opcode: Link Key Request Reply (0x040b)</span><br><span class=\"line\">    Status: Success (0x00)</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    [Command in frame: 1969]</span><br><span class=\"line\">    [Command-Response Delta: 0.934ms]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"SCO\"><a href=\"#SCO\" class=\"headerlink\" title=\"SCO\"></a>SCO</h3><blockquote>\n<p>BLUETOOTH SPECIFICATION Version 4.2 [Vol 1, Part A] page 64  </p>\n<p>The synchronous connection-oriented (SCO) logical transport is a symmetric,<br>point-to-point transport between the master and a specific slave. The SCO<br>logical transport reserves slots on the physical channel and can therefore be<br>considered as a circuit-switched connection between the master and the slave.<br>SCO logical transports carry 64 kb&#x2F;s of information synchronized with the<br>piconet clock. Typically this information is an encoded voice stream. Three<br>different SCO configurations exist, offering a balance between robustness,<br>delay and bandwidth consumption.  </p>\n</blockquote>\n<p>SCO全称<strong>BR&#x2F;EDR Synchronous Connection-Oriented</strong>，利用保留时隙传送数据包。连接建立后，主设备和从设备可以不被选中就发送SCO数据包。SCO数据包既可以传送话音，也可以传送数据，但在传送数据时，只用于重发被损坏的那部分的数据。</p>\n<h3 id=\"L2CAP\"><a href=\"#L2CAP\" class=\"headerlink\" title=\"L2CAP\"></a>L2CAP</h3><blockquote>\n<p>BLUETOOTH SPECIFICATION Version 4.2 [Vol 3, Part A] page 30  </p>\n<p>L2CAP（Logical Link Control and Adaptation Protocol）：逻辑链路控制与适配协议，将ACL数据分组交换为便于高层应用的数据分组格式，并提供协议复用和服务质量交换等功能。</p>\n<p>通过协议多路复用、分段重组操作和组概念,向高层提供面向连接的和无连接的数据服务,L2CAP还屏蔽了低层传输协议中的很多特性，使得高层协议应用开发人员可以不必了解基层协议而进行开发。</p>\n</blockquote>\n<p><img src=\"https://s1.ax1x.com/2022/04/11/LV6sKg.png\"></p>\n<p>从架构图可以看出，L2CAP位于HCI与上层业务之间，在建立物理连接(ACL)之后，上层业务的通信和控制都由L2CAP协议与微微网(piconet )中其它蓝牙设备进行交互，类似HTTP协议的存在。</p>\n<p>下图概括了两个设备L2CAP之间的连接过程：</p>\n<p><img src=\"https://s1.ax1x.com/2022/04/11/LV6UUI.png\"></p>\n<h3 id=\"SDP\"><a href=\"#SDP\" class=\"headerlink\" title=\"SDP\"></a>SDP</h3><blockquote>\n<p>BLUETOOTH SPECIFICATION Version 4.2 [Vol 3, Part B] page 222  </p>\n<p>The service discovery mechanism provides the means for client applications to<br>discover the existence of services provided by server applications as well as<br>the attributes of those services. The attributes of a service include the type or<br>class of service offered and the mechanism or protocol information needed to<br>utilize the service.  </p>\n</blockquote>\n<p>全称是<strong>Service Discovery Protocol</strong>，服务发现协议，服务发现协议(SDP)为应用程序提供了一种方法来发现哪些服务可用，并确定这些可用服务的特征。</p>\n<p><img src=\"https://s1.ax1x.com/2022/04/11/LV66bj.png\"></p>\n<p>从上图可知蓝牙设备中同时存在一个Client和Server，通过L2CAP协议与别的设备时行交互，通过<code>Service Search Attribute Request   </code>命令查询对方设备支持的蓝牙服务，其工作流程如图：</p>\n<p><img src=\"https://s1.ax1x.com/2022/04/11/LV6a5t.png\"></p>\n<p>通过HCI可以看到发现蓝牙服务过过程中的数据：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 455\t22.824346\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tSDP\t29\tSent Service Search Attribute Request : L2CAP: Attribute Range (0x0000 - 0xffff) </span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Frame 455: 29 bytes on wire (232 bits), 29 bytes captured (232 bits)</span><br><span class=\"line\">Bluetooth</span><br><span class=\"line\">Bluetooth HCI H4</span><br><span class=\"line\">Bluetooth HCI ACL Packet</span><br><span class=\"line\">Bluetooth L2CAP Protocol</span><br><span class=\"line\">Bluetooth SDP Protocol</span><br><span class=\"line\">    PDU: Service Search Attribute Request (0x06)</span><br><span class=\"line\">    Transaction Id: 0x0000</span><br><span class=\"line\">    Parameter Length: 15</span><br><span class=\"line\">    Service Search Pattern: L2CAP</span><br><span class=\"line\">    Maximum Attribute Byte Count: 1008</span><br><span class=\"line\">    Attribute ID List</span><br><span class=\"line\">        Data Element: Sequence uint8 5 bytes</span><br><span class=\"line\">            0011 0... = Data Element Type: Sequence (6)</span><br><span class=\"line\">            .... .101 = Data Element Size: uint8 (5)</span><br><span class=\"line\">            Data Element Var Size: 5</span><br><span class=\"line\">            Data Value</span><br><span class=\"line\">                Data Element: Unsigned Integer 4 bytes</span><br><span class=\"line\">                    0000 1... = Data Element Type: Unsigned Integer (1)</span><br><span class=\"line\">                    .... .010 = Data Element Size: 4 bytes (2)</span><br><span class=\"line\">                    Data Value</span><br><span class=\"line\">                        Attribute Range: 0x0000ffff</span><br><span class=\"line\">                            Attribute Range From: 0x0000</span><br><span class=\"line\">                            Attribute Range To: 0xffff</span><br><span class=\"line\">    Continuation State: no (00)</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 471\t22.896191\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tSDP\t281\tRcvd Service Search Attribute Response</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Frame 471: 281 bytes on wire (2248 bits), 281 bytes captured (2248 bits)</span><br><span class=\"line\">Bluetooth</span><br><span class=\"line\">Bluetooth HCI H4</span><br><span class=\"line\">Bluetooth HCI ACL Packet</span><br><span class=\"line\">Bluetooth L2CAP Protocol</span><br><span class=\"line\">Bluetooth SDP Protocol</span><br><span class=\"line\">    PDU: Service Search Attribute Response (0x07)</span><br><span class=\"line\">    Transaction Id: 0x0001</span><br><span class=\"line\">    Parameter Length: 267</span><br><span class=\"line\">    Attribute List Byte Count: 264</span><br><span class=\"line\">    Data Fragment</span><br><span class=\"line\">    Continuation State: no (00)</span><br><span class=\"line\">    [Reassembled Attribute List]</span><br><span class=\"line\">        Attribute Lists [count = 14]</span><br><span class=\"line\">            Data Element: Sequence uint16 1269 bytes</span><br><span class=\"line\">                0011 0... = Data Element Type: Sequence (6)</span><br><span class=\"line\">                .... .110 = Data Element Size: uint16 (6)</span><br><span class=\"line\">                Data Element Var Size: 1269</span><br><span class=\"line\">                Data Value</span><br><span class=\"line\">                    Attribute List [count =  4] (Generic Attribute Profile)</span><br><span class=\"line\">                    Attribute List [count =  4] (Generic Access Profile)</span><br><span class=\"line\">                    Attribute List [count =  6] (Headset Audio Gateway)</span><br><span class=\"line\">                    Attribute List [count =  8] (Handsfree Audio Gateway)</span><br><span class=\"line\">                    Attribute List [count =  8] (A/V Remote Control Target)</span><br><span class=\"line\">                    Attribute List [count =  7] (Audio Source)</span><br><span class=\"line\">                    Attribute List [count = 11] (PAN NAP)</span><br><span class=\"line\">                    Attribute List [count =  9] (PAN PANU)</span><br><span class=\"line\">                    Attribute List [count =  7] (Phonebook Access Server)</span><br><span class=\"line\">                    Attribute List [count = 10] (Message Access Server)</span><br><span class=\"line\">                    Attribute List [count =  4] (Xiaomi Inc.)</span><br><span class=\"line\">                    Attribute List [count =  5] (CustomUUID: Unknown)</span><br><span class=\"line\">                    Attribute List [count =  8] (OBEX Object Push)</span><br><span class=\"line\">                    Attribute List [count =  4] (Unknown)</span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"蓝牙电话\"><a href=\"#蓝牙电话\" class=\"headerlink\" title=\"蓝牙电话\"></a>蓝牙电话</h1><h2 id=\"PBAP-RFCOMM-x2F-OBEX\"><a href=\"#PBAP-RFCOMM-x2F-OBEX\" class=\"headerlink\" title=\"PBAP(RFCOMM&#x2F;OBEX)\"></a>PBAP(RFCOMM&#x2F;OBEX)</h2><blockquote>\n<p>RFCOMM协议提供了对L2CAP协议上的串行端口的模拟。该协议基于ETSI标准GSM 07.10。</p>\n<p>OBEX：Object Exchange的简称，对象交换协议，来源于红外通讯协议，但又不局限于具体的传输方式，后来被蓝牙组织SIG吸纳其中部分并进行优化处理作为蓝牙协议中的OBEX层用于蓝牙设备间的文件数据传输，如蓝牙传输文件（OPP）、同步电话簿（PBAP）和同步短信（MAP）等场景下都是以OBEX协议组织相关数据进行传输的。</p>\n</blockquote>\n<p>PBAP: Phone Book Access Profile的简称，<strong>电话本访问协议</strong>，用于同步手机这些具有电话本功能设备上的通讯录和通话记录等。</p>\n<p>RFCOMM&#x2F;OBEX和协议不属于蓝牙定义的规范 ，只是被蓝牙采纳，而PBAP协议包在OBEX协议之上封装而成。</p>\n<h3 id=\"PBAP虚拟文件夹架构\"><a href=\"#PBAP虚拟文件夹架构\" class=\"headerlink\" title=\"PBAP虚拟文件夹架构\"></a>PBAP虚拟文件夹架构</h3><p>PBAP中通话数据文件是在虚拟文件夹架构下，访问通话数据时需要指定路径，下图为官方架构图：</p>\n<p><img src=\"https://s1.ax1x.com/2022/04/11/LV6yrQ.png\"></p>\n<p>其中vcf的文件名称意义如下：</p>\n<p><img src=\"https://s1.ax1x.com/2022/04/11/LV6gVs.png\"></p>\n<h3 id=\"建立连接-x2F-断开连接\"><a href=\"#建立连接-x2F-断开连接\" class=\"headerlink\" title=\"建立连接&#x2F;断开连接\"></a>建立连接&#x2F;断开连接</h3><p>只使用OBEX协议</p>\n<h4 id=\"连接-1\"><a href=\"#连接-1\" class=\"headerlink\" title=\"连接\"></a>连接</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 798\t23.907353\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t40\tSent Connect - Phone Book Access Profile</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Frame 798: 40 bytes on wire (320 bits), 40 bytes captured (320 bits)</span><br><span class=\"line\">Bluetooth</span><br><span class=\"line\">Bluetooth HCI H4</span><br><span class=\"line\">Bluetooth HCI ACL Packet</span><br><span class=\"line\">Bluetooth L2CAP Protocol</span><br><span class=\"line\">Bluetooth RFCOMM Protocol</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: ?]</span><br><span class=\"line\">    .000 0000 = Opcode: Connect (0x00)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 26</span><br><span class=\"line\">    [Response in Frame: 803]</span><br><span class=\"line\">    Version: 1.0 (0x10)</span><br><span class=\"line\">    Flags: 0x00</span><br><span class=\"line\">    Max. Packet Length: 65534</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Target: Phone Book Access Profile</span><br><span class=\"line\">            Header Id: Target (0x46)</span><br><span class=\"line\">            Length: 19</span><br><span class=\"line\">            Value: 796135f0f0c511d809660800200c9a66: Phone Book Access Profile</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 803\t23.917550\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t45\tRcvd Success - Phone Book Access Profile</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Frame 803: 45 bytes on wire (360 bits), 45 bytes captured (360 bits)</span><br><span class=\"line\">Bluetooth</span><br><span class=\"line\">Bluetooth HCI H4</span><br><span class=\"line\">Bluetooth HCI ACL Packet</span><br><span class=\"line\">Bluetooth L2CAP Protocol</span><br><span class=\"line\">Bluetooth RFCOMM Protocol</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /]</span><br><span class=\"line\">    .010 0000 = Response Code: Success (0x20)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 31</span><br><span class=\"line\">    [Request in Frame: 798]</span><br><span class=\"line\">    Version: 1.0 (0x10)</span><br><span class=\"line\">    Flags: 0x00</span><br><span class=\"line\">    Max. Packet Length: 65534</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\">        Who: Phone Book Access Profile</span><br><span class=\"line\">            Header Id: Who (0x4a)</span><br><span class=\"line\">            Length: 19</span><br><span class=\"line\">            Value: 796135f0f0c511d809660800200c9a66: Phone Book Access Profile</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"断开\"><a href=\"#断开\" class=\"headerlink\" title=\"断开\"></a>断开</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 1142\t58.752933\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t22\tSent Disconnect</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /]</span><br><span class=\"line\">    .000 0001 = Opcode: Disconnect (0x01)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 8</span><br><span class=\"line\">    [Response in Frame: 1164]</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 1164\t59.162598\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t22\tRcvd Success</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /]</span><br><span class=\"line\">    .010 0000 = Response Code: Success (0x20)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 8</span><br><span class=\"line\">    [Request in Frame: 1142]</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"设置访问虚拟文件夹路径\"><a href=\"#设置访问虚拟文件夹路径\" class=\"headerlink\" title=\"设置访问虚拟文件夹路径\"></a>设置访问虚拟文件夹路径</h3><p>在[PBAP协议规范]的<code>5.2 SetPhoneBook Function</code>章节，使用OBEX协议SetPath命令，通过obex.opcode&#x3D;<strong>0x05</strong>判断。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># $/</span><br><span class=\"line\">&gt; 808\t24.023528\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t27\tSent Set Path &quot;&quot;</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /]</span><br><span class=\"line\">    .000 0101 = Opcode: Set Path (0x05)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 13</span><br><span class=\"line\">    [Response in Frame: 810]</span><br><span class=\"line\">    Flags: 0x02</span><br><span class=\"line\">    .... ...0 = Go back one folder (../) first: False</span><br><span class=\"line\">    .... ..1. = Do not create folder, if not existing: True</span><br><span class=\"line\">    Constants: 0x00</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\">        Name: &quot;&quot;</span><br><span class=\"line\">            Header Id: Name (0x01)</span><br><span class=\"line\">            Length: 3</span><br><span class=\"line\">            Name: </span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 810\t24.065127\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t22\tRcvd Success</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /]</span><br><span class=\"line\">    .010 0000 = Response Code: Success (0x20)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 8</span><br><span class=\"line\">    [Request in Frame: 808]</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\"></span><br><span class=\"line\"># $/telecom/</span><br><span class=\"line\">&gt; 811\t24.078180\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t43\tSent Set Path &quot;telecom&quot;</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"获取通讯录数量\"><a href=\"#获取通讯录数量\" class=\"headerlink\" title=\"获取通讯录数量\"></a>获取通讯录数量</h3><p>在[PBAP协议规范]的<code>5.3 PullvCardListing Function</code>章节，通过obex.header&#x3D;**&lt;x-bt&#x2F;vcard-listing&gt;**判断。</p>\n<h4 id=\"手机\"><a href=\"#手机\" class=\"headerlink\" title=\"手机\"></a>手机</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 808\t24.023528\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t27\tSent Set Path &quot;&quot;</span><br><span class=\"line\">&gt; 811\t24.078180\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t43\tSent Set Path &quot;telecom&quot;</span><br><span class=\"line\"># $/telecom/pb/</span><br><span class=\"line\">&gt; 816\t24.118267\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t70\tSent Get final &quot;pb&quot;</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /telecom]</span><br><span class=\"line\">    .000 0011 = Opcode: Get (0x03)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 56</span><br><span class=\"line\">    [Response in Frame: 818]</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\">        Name: &quot;pb&quot;</span><br><span class=\"line\">            Header Id: Name (0x01)</span><br><span class=\"line\">            Length: 9</span><br><span class=\"line\">            Name: pb</span><br><span class=\"line\">        Type: &quot;x-bt/vcard-listing&quot;</span><br><span class=\"line\">            Header Id: Type (0x42)</span><br><span class=\"line\">            Length: 22</span><br><span class=\"line\">            Type: x-bt/vcard-listing</span><br><span class=\"line\">        Application Parameters</span><br><span class=\"line\">            Header Id: Application Parameters (0x4c)</span><br><span class=\"line\">            Length: 17</span><br><span class=\"line\">            Parameter: Order #排序规则: &#123; Alphabetical | Indexed | Phonetical &#125;</span><br><span class=\"line\">                Parameter Id: Order (0x01)</span><br><span class=\"line\">                Parameter Length: 1</span><br><span class=\"line\">                Max List Count: Indexed (0x00)</span><br><span class=\"line\">            Parameter: Search Attribute #搜索:  &#123;Name | Number | Sound &#125; 与 SearchValue配合，默认为Name</span><br><span class=\"line\">                Parameter Id: Search Attribute (0x03)</span><br><span class=\"line\">                Parameter Length: 1</span><br><span class=\"line\">                Search Attribute: Name (0x00)</span><br><span class=\"line\">            Parameter: Max List Count #最大条目数</span><br><span class=\"line\">                Parameter Id: Max List Count (0x04)</span><br><span class=\"line\">                Parameter Length: 2</span><br><span class=\"line\">                Max List Count: 0 (0x0000)</span><br><span class=\"line\">            Parameter: List Start Offset #偏移量</span><br><span class=\"line\">                Parameter Id: List Start Offset (0x05)</span><br><span class=\"line\">                Parameter Length: 2</span><br><span class=\"line\">                List Start Offset: 0 (0x0000)</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 818\t24.332995\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t29\tRcvd Success</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /telecom]</span><br><span class=\"line\">    .010 0000 = Response Code: Success (0x20)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 15</span><br><span class=\"line\">    [Request in Frame: 816]</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\">        Application Parameters</span><br><span class=\"line\">            Header Id: Application Parameters (0x4c)</span><br><span class=\"line\">            Length: 7</span><br><span class=\"line\">            Parameter: Phonebook Size</span><br><span class=\"line\">                Parameter Id: Phonebook Size (0x08)</span><br><span class=\"line\">                Parameter Length: 2</span><br><span class=\"line\">                Phonebook Size: 71 (0x0047)</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"SIM1\"><a href=\"#SIM1\" class=\"headerlink\" title=\"SIM1\"></a>SIM1</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 819\t24.336294\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t27\tSent Set Path &quot;&quot;</span><br><span class=\"line\">&gt; 822\t24.379640\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t27\tSent Set Path &quot;&quot;</span><br><span class=\"line\">&gt; 825\t24.430836\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t37\tSent Set Path &quot;SIM1&quot;</span><br><span class=\"line\">&gt; 828\t24.481559\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t43\tSent Set Path &quot;telecom&quot;</span><br><span class=\"line\"># $/SIM1/telecom/pb/</span><br><span class=\"line\">&gt; 831\t24.532312\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t70\tSent Get final &quot;pb&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 833\t24.578831\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t29\tRcvd Success</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /SIM1/telecom]</span><br><span class=\"line\">    .010 0000 = Response Code: Success (0x20)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 15</span><br><span class=\"line\">    [Request in Frame: 831]</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\">        Application Parameters</span><br><span class=\"line\">            Header Id: Application Parameters (0x4c)</span><br><span class=\"line\">            Length: 7</span><br><span class=\"line\">            Parameter: Phonebook Size</span><br><span class=\"line\">                Parameter Id: Phonebook Size (0x08)</span><br><span class=\"line\">                Parameter Length: 2</span><br><span class=\"line\">                Phonebook Size: 1 (0x0001)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"获取通讯录\"><a href=\"#获取通讯录\" class=\"headerlink\" title=\"获取通讯录\"></a>获取通讯录</h3><p>在[PBAP协议规范]的<code>5.3 PullvCardListing Function</code>章节，通过obex.header&#x3D;<strong>&lt;x-bt&#x2F;phonebook&gt;</strong> 判断，分页获取vCard格式。</p>\n<h4 id=\"手机-1\"><a href=\"#手机-1\" class=\"headerlink\" title=\"手机\"></a>手机</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 834\t24.580643\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t27\tSent Set Path &quot;&quot;</span><br><span class=\"line\">#分页请求获取通讯录，从第1条数据开始，每页最多50条</span><br><span class=\"line\">&gt; 837\t24.632264\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t97\tSent Get final &quot;telecom/pb.vcf&quot;</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /]</span><br><span class=\"line\">    .000 0011 = Opcode: Get (0x03)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 83</span><br><span class=\"line\">    [Response in Frame: 844]</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\">        Name: &quot;telecom/pb.vcf&quot;</span><br><span class=\"line\">            Header Id: Name (0x01)</span><br><span class=\"line\">            Length: 33</span><br><span class=\"line\">            Name: telecom/pb.vcf</span><br><span class=\"line\">        Type: &quot;x-bt/phonebook&quot;</span><br><span class=\"line\">            Header Id: Type (0x42)</span><br><span class=\"line\">            Length: 18</span><br><span class=\"line\">            Type: x-bt/phonebook</span><br><span class=\"line\">        Application Parameters</span><br><span class=\"line\">            Header Id: Application Parameters (0x4c)</span><br><span class=\"line\">            Length: 24</span><br><span class=\"line\">            Parameter: Max List Count #最大条目数,这里只读取50条</span><br><span class=\"line\">                Parameter Id: Max List Count (0x04)</span><br><span class=\"line\">                Parameter Length: 2</span><br><span class=\"line\">                Max List Count: 50 (0x0032)</span><br><span class=\"line\">            Parameter: List Start Offset #偏移量，这是从第1条开始读取</span><br><span class=\"line\">                Parameter Id: List Start Offset (0x05)</span><br><span class=\"line\">                Parameter Length: 2</span><br><span class=\"line\">                List Start Offset: 1 (0x0001)</span><br><span class=\"line\">            Parameter: Filter #用于指示所请求的vCard中包含的属性</span><br><span class=\"line\">                Parameter Id: Filter (0x06)</span><br><span class=\"line\">                Parameter Length: 8</span><br><span class=\"line\">                Filter: 0x00000000</span><br><span class=\"line\">                Filter: 0x008001af, vCard Version, Formatted Name, Structured Presentation of Name, Associated Image or Photo, Delivery Address, Telephone Number, Electronic Mail Address, Nickname</span><br><span class=\"line\">            Parameter: Format #vCard文件格式版本，这是3.0</span><br><span class=\"line\">                Parameter Id: Format (0x07)</span><br><span class=\"line\">                Parameter Length: 1</span><br><span class=\"line\">                Format: 3.0 (0x01)</span><br><span class=\"line\"></span><br><span class=\"line\">#传输数据片段</span><br><span class=\"line\">&gt; 839\t24.764415\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t1004\tRcvd OBEX fragment</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Frame 839: 1004 bytes on wire (8032 bits), 1004 bytes captured (8032 bits)</span><br><span class=\"line\">Bluetooth</span><br><span class=\"line\">Bluetooth HCI H4</span><br><span class=\"line\">Bluetooth HCI ACL Packet</span><br><span class=\"line\">Bluetooth L2CAP Protocol</span><br><span class=\"line\">Bluetooth RFCOMM Protocol</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /]</span><br><span class=\"line\">    [Reassembled OBEX in frame: 844]</span><br><span class=\"line\">    Data (990 bytes)</span><br><span class=\"line\"></span><br><span class=\"line\">...</span><br><span class=\"line\">#传输成功</span><br><span class=\"line\">&gt; 844\t24.794969\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t182\tRcvd Success (x-bt/phonebook)</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /]</span><br><span class=\"line\">    [6 OBEX Fragments (5117 bytes): #839(990), #840(990), #841(990), #842(990), #843(990), #844(167)] #6个数据片段，需要拼接对应Frame</span><br><span class=\"line\">    .010 0000 = Response Code: Success (0x20)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 5117</span><br><span class=\"line\">    [Request in Frame: 837]</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\">        End Of Body</span><br><span class=\"line\">            Header Id: End Of Body (0x49)</span><br><span class=\"line\">            Length: 5109</span><br><span class=\"line\">            Value: 424547494e3a56434152440d0a56455253494f4e3a332e300d0a4e3ae591a83be4baa6e6…</span><br><span class=\"line\">    Line-based text data: x-bt/phonebook (320 lines)</span><br><span class=\"line\">        BEGIN:VCARD\\r\\n</span><br><span class=\"line\">        VERSION:3.0\\r\\n</span><br><span class=\"line\">        N:张;三;;;\\r\\n</span><br><span class=\"line\">        FN:张三\\r\\n</span><br><span class=\"line\">        TEL;TYPE=CELL:22222222\\r\\n</span><br><span class=\"line\">        END:VCARD\\r\\n</span><br><span class=\"line\">        BEGIN:VCARD\\r\\n</span><br><span class=\"line\">        VERSION:3.0\\r\\n</span><br><span class=\"line\">        N:李四;;;;\\r\\n</span><br><span class=\"line\">        FN:李四\\r\\n</span><br><span class=\"line\">        TEL;TYPE=CELL:11111111\\r\\n</span><br><span class=\"line\">        END:VCARD\\r\\n</span><br><span class=\"line\"></span><br><span class=\"line\">#请求获取vCard 3.0格式，并从第51条数据开始，最多50条</span><br><span class=\"line\">&gt; 847\t24.875858\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t96\tSent Get final &quot;telecom/pb.vcf&quot;</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /]</span><br><span class=\"line\">    .000 0011 = Opcode: Get (0x03)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 83</span><br><span class=\"line\">    [Response in Frame: 850]</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\">        Name: &quot;telecom/pb.vcf&quot;</span><br><span class=\"line\">            Header Id: Name (0x01)</span><br><span class=\"line\">            Length: 33</span><br><span class=\"line\">            Name: telecom/pb.vcf</span><br><span class=\"line\">        Type: &quot;x-bt/phonebook&quot;</span><br><span class=\"line\">            Header Id: Type (0x42)</span><br><span class=\"line\">            Length: 18</span><br><span class=\"line\">            Type: x-bt/phonebook</span><br><span class=\"line\">        Application Parameters</span><br><span class=\"line\">            Header Id: Application Parameters (0x4c)</span><br><span class=\"line\">            Length: 24</span><br><span class=\"line\">            Parameter: Max List Count</span><br><span class=\"line\">                Parameter Id: Max List Count (0x04)</span><br><span class=\"line\">                Parameter Length: 2</span><br><span class=\"line\">                Max List Count: 50 (0x0032)</span><br><span class=\"line\">            Parameter: List Start Offset</span><br><span class=\"line\">                Parameter Id: List Start Offset (0x05)</span><br><span class=\"line\">                Parameter Length: 2</span><br><span class=\"line\">                List Start Offset: 51 (0x0033)</span><br><span class=\"line\">            Parameter: Filter</span><br><span class=\"line\">                Parameter Id: Filter (0x06)</span><br><span class=\"line\">                Parameter Length: 8</span><br><span class=\"line\">                Filter: 0x00000000</span><br><span class=\"line\">                Filter: 0x008001af, vCard Version, Formatted Name, Structured Presentation of Name, Associated Image or Photo, Delivery Address, Telephone Number, Electronic Mail Address, Nickname</span><br><span class=\"line\">            Parameter: Format</span><br><span class=\"line\">                Parameter Id: Format (0x07)</span><br><span class=\"line\">                Parameter Length: 1</span><br><span class=\"line\">                Format: 3.0 (0x01)</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 849\t24.953425\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t1004\tRcvd OBEX fragment</span><br><span class=\"line\"></span><br><span class=\"line\"># 刚刚通过`Sent Get final &quot;pb&quot;`获取手机通讯录只有71条，现在只剩下21，这次就可以传输完成。</span><br><span class=\"line\">&gt; 850\t24.960363\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t940\tRcvd Success (x-bt/phonebook)</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /]</span><br><span class=\"line\">    [2 OBEX Fragments (1915 bytes): #849(990), #850(925)]</span><br><span class=\"line\">    .010 0000 = Response Code: Success (0x20)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 1915</span><br><span class=\"line\">    [Request in Frame: 847]</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\">        End Of Body</span><br><span class=\"line\">            Header Id: End Of Body (0x49)</span><br><span class=\"line\">            Length: 1907</span><br><span class=\"line\">            Value: 424547494e3a56434152440d0a56455253494f4e3a332e300d0a4e3ae4bd993be4bf8ae7…</span><br><span class=\"line\">    Line-based text data: x-bt/phonebook (122 lines)</span><br><span class=\"line\">        BEGIN:VCARD\\r\\n</span><br><span class=\"line\">        VERSION:3.0\\r\\n</span><br><span class=\"line\">        N:张;三;;;\\r\\n</span><br><span class=\"line\">        FN:张三\\r\\n</span><br><span class=\"line\">        TEL;TYPE=CELL:22222222\\r\\n</span><br><span class=\"line\">        END:VCARD\\r\\n</span><br><span class=\"line\">        BEGIN:VCARD\\r\\n</span><br><span class=\"line\">        VERSION:3.0\\r\\n</span><br><span class=\"line\">        N:李四;;;;\\r\\n</span><br><span class=\"line\">        FN:李四\\r\\n</span><br><span class=\"line\">        TEL;TYPE=CELL:11111111\\r\\n</span><br><span class=\"line\">        END:VCARD\\r\\n</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"SIM1-1\"><a href=\"#SIM1-1\" class=\"headerlink\" title=\"SIM1\"></a>SIM1</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 866\t25.021131\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t107\tSent Get final &quot;SIM1/telecom/pb.vcf&quot;</span><br><span class=\"line\">#这里手机直接拒绝了</span><br><span class=\"line\">&gt; 868\t25.032728\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t25\tRcvd Success</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /]</span><br><span class=\"line\">    .010 0000 = Response Code: Success (0x20)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 11</span><br><span class=\"line\">    [Request in Frame: 866]</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\">        End Of Body</span><br><span class=\"line\">            Header Id: End Of Body (0x49)</span><br><span class=\"line\">            Length: 3</span><br><span class=\"line\">            Value: &lt;MISSING&gt;</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"获取通话记录\"><a href=\"#获取通话记录\" class=\"headerlink\" title=\"获取通话记录\"></a>获取通话记录</h3><p>在[PBAP协议规范]的<code>5.3 PullvCardListing Function</code>章节，通过obex.header&#x3D;<strong>&lt;x-bt&#x2F;phonebook&gt;</strong> 判断，分页获取vCard格式。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 869\t25.071027\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t27\tSent Set Path &quot;&quot;</span><br><span class=\"line\">&gt; 882\t25.125323\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t43\tSent Set Path &quot;telecom&quot;</span><br><span class=\"line\"># $/telecom/cch/</span><br><span class=\"line\">&gt; 887\t25.138796\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t72\tSent Get final &quot;cch&quot;</span><br><span class=\"line\">&gt; 895\t25.222650\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t29\tRcvd Success</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /telecom]</span><br><span class=\"line\">    .010 0000 = Response Code: Success (0x20)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 15</span><br><span class=\"line\">    [Request in Frame: 887]</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\">        Application Parameters</span><br><span class=\"line\">            Header Id: Application Parameters (0x4c)</span><br><span class=\"line\">            Length: 7</span><br><span class=\"line\">            Parameter: Phonebook Size</span><br><span class=\"line\">                Parameter Id: Phonebook Size (0x08)</span><br><span class=\"line\">                Parameter Length: 2</span><br><span class=\"line\">                Phonebook Size: 2177 (0x0881)</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 897\t25.225643\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t27\tSent Set Path &quot;&quot;</span><br><span class=\"line\">#分页获取通话记录，从第0条开始，每页最多50条</span><br><span class=\"line\">&gt; 919\t25.279427\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t85\tSent Get final &quot;telecom/cch.vcf&quot;</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /]</span><br><span class=\"line\">    .000 0011 = Opcode: Get (0x03)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 71</span><br><span class=\"line\">    [Response in Frame: 935]</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\">        Name: &quot;telecom/cch.vcf&quot;</span><br><span class=\"line\">            Header Id: Name (0x01)</span><br><span class=\"line\">            Length: 35</span><br><span class=\"line\">            Name: telecom/cch.vcf</span><br><span class=\"line\">        Type: &quot;x-bt/phonebook&quot;</span><br><span class=\"line\">            Header Id: Type (0x42)</span><br><span class=\"line\">            Length: 18</span><br><span class=\"line\">            Type: x-bt/phonebook</span><br><span class=\"line\">        Application Parameters</span><br><span class=\"line\">            Header Id: Application Parameters (0x4c)</span><br><span class=\"line\">            Length: 10</span><br><span class=\"line\">            Parameter: Max List Count</span><br><span class=\"line\">                Parameter Id: Max List Count (0x04)</span><br><span class=\"line\">                Parameter Length: 2</span><br><span class=\"line\">                Max List Count: 50 (0x0032)</span><br><span class=\"line\">            Parameter: Format</span><br><span class=\"line\">                Parameter Id: Format (0x07)</span><br><span class=\"line\">                Parameter Length: 1</span><br><span class=\"line\">                Format: 3.0 (0x01)</span><br><span class=\"line\">&gt; 935\t25.381127\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t132\tRcvd Success (x-bt/phonebook)</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /]</span><br><span class=\"line\">    [8 OBEX Fragments (7048 bytes): #926(990), #927(990), #928(990), #929(990), #930(990), #931(990), #934(990), #935(118)]</span><br><span class=\"line\">    .010 0000 = Response Code: Success (0x20)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 7048</span><br><span class=\"line\">    [Request in Frame: 919]</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\">        End Of Body</span><br><span class=\"line\">            Header Id: End Of Body (0x49)</span><br><span class=\"line\">            Length: 7040</span><br><span class=\"line\">            Value: 424547494e3a56434152440d0a56455253494f4e3a332e300d0a464e3a0d0a4e3a0d0a54…</span><br><span class=\"line\">    Line-based text data: x-bt/phonebook (350 lines)</span><br><span class=\"line\">        BEGIN:VCARD\\r\\n</span><br><span class=\"line\">        VERSION:3.0\\r\\n</span><br><span class=\"line\">        FN:\\r\\n</span><br><span class=\"line\">        N:\\r\\n</span><br><span class=\"line\">        TEL;TYPE=0:10086\\r\\n</span><br><span class=\"line\">        X-IRMC-CALL-DATETIME;TYPE=DIALED:20220317T161710\\r\\n</span><br><span class=\"line\">        END:VCARD\\r\\n</span><br><span class=\"line\">        BEGIN:VCARD\\r\\n</span><br><span class=\"line\">        VERSION:3.0\\r\\n</span><br><span class=\"line\">        FN:\\r\\n</span><br><span class=\"line\">        N:\\r\\n</span><br><span class=\"line\">        TEL;TYPE=0:02310050\\r\\n</span><br><span class=\"line\">        X-IRMC-CALL-DATETIME;TYPE=MISSED:20220316T160142\\r\\n</span><br><span class=\"line\">        END:VCARD\\r\\n</span><br><span class=\"line\"></span><br><span class=\"line\">#分页获取通话记录，从第50条开始，每页最多50条</span><br><span class=\"line\">936\t25.423573\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tOBEX\t89\tSent Get final &quot;telecom/cch.vcf&quot;</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">OBEX Protocol</span><br><span class=\"line\">    [Profile: PBAP (4)]</span><br><span class=\"line\">    [Current Path: /]</span><br><span class=\"line\">    .000 0011 = Opcode: Get (0x03)</span><br><span class=\"line\">    1... .... = Final Flag: True</span><br><span class=\"line\">    Packet Length: 75</span><br><span class=\"line\">    [Response in Frame: 947]</span><br><span class=\"line\">    Headers</span><br><span class=\"line\">        Connection Id: 1</span><br><span class=\"line\">            Header Id: Connection Id (0xcb)</span><br><span class=\"line\">            Connection ID: 1</span><br><span class=\"line\">        Name: &quot;telecom/cch.vcf&quot;</span><br><span class=\"line\">            Header Id: Name (0x01)</span><br><span class=\"line\">            Length: 35</span><br><span class=\"line\">            Name: telecom/cch.vcf</span><br><span class=\"line\">        Type: &quot;x-bt/phonebook&quot;</span><br><span class=\"line\">            Header Id: Type (0x42)</span><br><span class=\"line\">            Length: 18</span><br><span class=\"line\">            Type: x-bt/phonebook</span><br><span class=\"line\">        Application Parameters</span><br><span class=\"line\">            Header Id: Application Parameters (0x4c)</span><br><span class=\"line\">            Length: 14</span><br><span class=\"line\">            Parameter: Max List Count</span><br><span class=\"line\">                Parameter Id: Max List Count (0x04)</span><br><span class=\"line\">                Parameter Length: 2</span><br><span class=\"line\">                Max List Count: 50 (0x0032)</span><br><span class=\"line\">            Parameter: List Start Offset</span><br><span class=\"line\">                Parameter Id: List Start Offset (0x05)</span><br><span class=\"line\">                Parameter Length: 2</span><br><span class=\"line\">                List Start Offset: 50 (0x0032)</span><br><span class=\"line\">            Parameter: Format</span><br><span class=\"line\">                Parameter Id: Format (0x07)</span><br><span class=\"line\">                Parameter Length: 1</span><br><span class=\"line\">                Format: 3.0 (0x01)</span><br><span class=\"line\">&gt; 947\t25.516478\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tOBEX\t810\tRcvd Success (x-bt/phonebook)</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"HFP-RFCOMM\"><a href=\"#HFP-RFCOMM\" class=\"headerlink\" title=\"HFP(RFCOMM)\"></a>HFP(RFCOMM)</h2><blockquote>\n<p>HFP(Hands-free Profile)，让蓝牙设备可以控制电话，如接听、挂断、拒接、语音拨号等，拒接、语音拨号要视蓝牙耳机及电话是否支持。</p>\n<p>目前HFP的使用场景有车载蓝牙，耳机和PDA，定义了AG和HFP两种角色。<br>AG（Audio Gate）音频网关—音频设备输入输出网关<br>HF（Hands Free）免提—该设备作为音频网关的远程音频输入&#x2F;输出机制，并可提供若干遥控功能。</p>\n</blockquote>\n<p>在车载蓝牙中，<strong>手机侧是AG</strong>，<strong>车载蓝牙侧是HF</strong>，在android源代码中，将AG侧称为HFP&#x2F;AG，将HF侧称为HFPClient&#x2F;HF。</p>\n<h3 id=\"AT命令\"><a href=\"#AT命令\" class=\"headerlink\" title=\"AT命令\"></a>AT命令</h3><p>在HFP使用AT命令控制电话，其参考3GPP 27.007标准，命令规范为：</p>\n<ul>\n<li><p>每个命令行只有一个命令</p>\n</li>\n<li><p>AG侧默认不回显命令</p>\n</li>\n<li><p>AG使用冗长的格式返回结果</p>\n</li>\n<li><p>以下字符将被用于AT命令和返回结果格式中</p>\n<ul>\n<li><p><code>&lt;cr&gt;</code> 表示回车，也就是<code>\\r</code>字符</p>\n</li>\n<li><p><code> &lt;lf&gt;</code>表示换行，也就是<code>\\n</code>字符</p>\n</li>\n</ul>\n</li>\n<li><p>从HF发送到AG的命令格式是：<code>&lt;AT command&gt; &lt;cr&gt;</code></p>\n</li>\n<li><p>从AG返回给HF的OK命令格式是：<code>&lt;cr&gt;&lt;lf&gt;OK&lt;cr&gt;&lt;lf&gt;</code></p>\n</li>\n<li><p>从AG到HF的ERROR命令是：<code>&lt;cr&gt;&lt;lf&gt;ERROR&lt;cr&gt;&lt;lf&gt;</code></p>\n</li>\n<li><p>从AG到HF的结果命令格式是：<code>&lt;cr&gt;&lt;lf&gt;&lt;result code&gt;&lt;cr&gt;&lt;lf&gt;</code></p>\n</li>\n</ul>\n<p>HFP协议复用的AT命令：</p>\n<ul>\n<li><p>ATA：标准电话应答AT命令</p>\n</li>\n<li><p>ATDdd…dd;：用电话号码打电话</p>\n</li>\n<li><p>ATD&gt;nnn…;：ATD扩展命令，记忆拨号</p>\n</li>\n<li><p>ERROR：错误指示符，语法，格式或者通信过程出错。</p>\n</li>\n<li><p>OK：命令的成功应答。</p>\n</li>\n<li><p>NO CARRIER, BUSY, NO ANSWER, DELAYED, BLACKLISTED：AT扩展命令，AG返回给HF。</p>\n</li>\n<li><p>RING：来电</p>\n</li>\n<li><p>AT+CCWA：calling waiting notification AT命令。AT+CCWA&#x3D;<code>[&lt;n&gt;[,&lt;mode&gt;[,&lt;class&gt;]]]</code>，</p>\n</li>\n<li><p>+CCWA：Call Waiting notification返回结果码。只有<code>&lt;number&gt;</code>和<code>&lt;type&gt;</code>参数对HFP有意义，<code>&lt;number&gt;</code>是由双引号及其中的文本串组成。<code>&lt;type&gt;</code>是支持的电话格式，有如下值：</p>\n<ul>\n<li><p>128~143：国家或国际格式，</p>\n</li>\n<li><p>144~159：国际电话，包括国家码前缀。</p>\n</li>\n<li><p>160-175:国家码</p>\n</li>\n<li><p>AT+CHLD：通话保持，多方处理。AT+CHLD&#x3D;<code>&lt;n&gt;</code>中<code>&lt;n&gt;</code>值覆盖0, 1, 1<code>&lt;idx&gt;</code>, 2, 2<code>&lt;idx&gt;</code>, 3 and 4,说明：</p>\n<ul>\n<li>0：释放所有保持电话或者设置用户的忙等待</li>\n<li>1：释放正在通话的电话，接听保持或等待的电话</li>\n<li>1<code>&lt;idx&gt;</code>:释放<code>&lt;idx&gt;</code>标识的电话</li>\n<li>2：将所有活跃电话设置成保持并且接受其它电话。</li>\n<li>2<code>&lt;idx&gt;</code>:请求接受<code>&lt;idx&gt;</code>标识电话，让其它电话保持。</li>\n<li>3：增加一个保持电话到对话中</li>\n<li>4：连接连个电话并且断开两个电话的订阅。HF侧可选。</li>\n</ul>\n</li>\n<li><p>AT+CHLD&#x3D;?：查询AG侧保持和多方会话。</p>\n</li>\n</ul>\n</li>\n<li><p>AT+CHUP：标准的挂断命令。AG会结束通话，也可用于拒接来电。</p>\n</li>\n<li><p>AT+CIND：<code>AT+CIND?</code>获取AG indicators当前的状态,&#96;AT+CIND&#x3D;?获取AG支持的indicator以及它们的次序。</p>\n<ul>\n<li>service: Service availability indication:<ul>\n<li><code>&lt;value&gt;=0</code> implies no service. No Home&#x2F;Roam network available.</li>\n<li><code>&lt;value&gt;=1</code> implies presence of service. Home&#x2F;Roam network available.</li>\n</ul>\n</li>\n<li>call: Standard call status indicator:  <ul>\n<li><code>&lt;value&gt;=0 </code>means there are no calls in progress  </li>\n<li><code>&lt;value&gt;=1</code> means at least one call is in progress</li>\n</ul>\n</li>\n<li>callsetup: Bluetooth proprietary call set up status indicator4. Support for this indicator is optional<br>for the HF. When supported, this indicator shall be used in conjunction with, and as an extension<br>of the standard call indicator. Possible values are as follows:  <ul>\n<li><code>&lt;value&gt;=0</code> means not currently in call set up.  </li>\n<li><code>&lt;value&gt;=1</code> means an incoming call process ongoing.</li>\n<li><code>&lt;value&gt;=2</code> means an outgoing call set up is ongoing.  </li>\n<li><code>&lt;value&gt;=3</code> means remote party being alerted in an outgoing call.</li>\n</ul>\n</li>\n<li>callheld: Bluetooth proprietary call hold status indicator. Support for this indicator is mandatory for<br>the AG, optional for the HF. Possible values are as follows:  <ul>\n<li>0&#x3D; No calls held  </li>\n<li>1&#x3D; Call is placed on hold or active&#x2F;held calls swapped<br>(The AG has both an active AND a held call)  </li>\n<li>Call on hold, no active call</li>\n</ul>\n</li>\n<li>signal: Signal Strength indicator:  <ul>\n<li><code>&lt;value&gt;= </code>ranges from 0 to 5</li>\n</ul>\n</li>\n<li>roam: Roaming status indicator:  <ul>\n<li><code>&lt;value&gt;=0</code> means roaming is not active  </li>\n<li><code>&lt;value&gt;=1</code> means a roaming is active</li>\n</ul>\n</li>\n<li>battchg: Battery Charge indicator of AG:  <ul>\n<li><code>&lt;value&gt;=</code>ranges from 0 to 5</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>+CIND：当前indicator的列表</p>\n</li>\n<li><p>AT+CLCC：列出当前电话命令，</p>\n</li>\n<li><p>+CLCC：当前call结果码，支持参数是</p>\n<ul>\n<li><p>idx：表示建立连接顺序或者接听电话的数字（从1开始）。</p>\n</li>\n<li><p>dir：0（outgoing），1（incoming）</p>\n</li>\n<li><p>status：</p>\n<ul>\n<li><p>0&#x3D;Active</p>\n</li>\n<li><p>1&#x3D;Held</p>\n</li>\n<li><p>2&#x3D;Dialing（outgoing calls only）</p>\n</li>\n<li><p>3&#x3D;Alerting(outgoing calls only)</p>\n</li>\n<li><p>4&#x3D;Incoming(incoming calls only)</p>\n</li>\n<li><p>5&#x3D;Waiting(incoming calls only)</p>\n</li>\n<li><p>6 &#x3D; Call held by Response and Hold</p>\n</li>\n</ul>\n</li>\n<li><p>mode&#x3D; 0 (Voice), 1 (Data), 2 (FAX)</p>\n</li>\n<li><p>mpty&#x3D;</p>\n<ul>\n<li>0 - this call is NOT a member of a multi-party (conference) call</li>\n<li>1 - this call IS a member of a multi-party (conference) call</li>\n</ul>\n</li>\n<li><p>number (optional)</p>\n</li>\n<li><p>type (optional)</p>\n</li>\n</ul>\n</li>\n<li><p>AT+COPS: AT+COPS&#x3D;3,0将被HF发送给AG</p>\n</li>\n<li><p>AT+CMEE: 使能+CME ERROR: <err>结果码</p>\n</li>\n<li><p>+CME ERROR</p>\n<ul>\n<li>+CME ERROR: 0 – AG failure</li>\n</ul>\n</li>\n<li><p>AT+CLIP: Calling Line Identification notification 使能命令，It enables&#x2F;disables the Calling Line Identification notification unsolicited result code 。</p>\n</li>\n<li><p>+CLIP : Standard “Calling Line Identification notification” unsolicited result code.  </p>\n</li>\n<li><p>AT+CMER :Standard event reporting activation&#x2F;deactivation AT command.  </p>\n</li>\n<li><p>+CIEV: “indicator events reporting”结果码。<code>&lt;ind&gt;</code>,<code>&lt;value&gt;</code> result code ，对应AT+CIND 返回的列表中的参数和值。</p>\n</li>\n<li><p>AT+VTS: DTMF生成命令。</p>\n</li>\n<li><p>AT+CNUM: HF相应<code>+CNUM</code>命令</p>\n<ul>\n<li>AT+CNUM (Retrieve Subscriber Number Information)</li>\n<li>AT+CNUM&#x3D;? (Test Subscriber Number Information – Not Implemented)</li>\n</ul>\n</li>\n<li><p>+CNUM:  用于将“ Subscriber Number Information ”从AG发送到HF的标准响应。</p>\n</li>\n</ul>\n<p>HFP协议扩展的AT命令：</p>\n<ul>\n<li>AT+BIA (Bluetooth Indicators Activation)  </li>\n<li>AT+BINP (Bluetooth INPut)  </li>\n<li>AT+BLDN (Bluetooth Last Dialed Number)  </li>\n<li>AT+BVRA (Bluetooth Voice Recognition Activation)  </li>\n<li>+BVRA (Bluetooth Voice Recognition Activation)  </li>\n<li>AT+BRSF (Bluetooth Retrieve Supported Features)  </li>\n<li>+BRSF (Bluetooth Retrieve Supported Features)   </li>\n<li>AT+NREC (Noise Reduction and Echo Canceling)  </li>\n<li>AT+VGM (Gain of Microphone)  </li>\n<li>AT+VGS (Gain of Speaker)  </li>\n<li>+VGM (Gain of Microphone)  </li>\n<li>+VGS (Gain of Speaker)  </li>\n<li>+BSIR (Bluetooth Setting of In-band Ring tone)  </li>\n<li>AT+BTRH (Bluetooth Response and Hold Feature)  </li>\n<li>+BTRH (Bluetooth Response and Hold Feature)  </li>\n<li>AT+BCC (Bluetooth Codec Connection)  </li>\n<li>AT+BCS (Bluetooth Codec Selection)  </li>\n<li>+BCS (Bluetooth Codec Selection)  </li>\n<li>AT+BAC (Bluetooth Available Codecs)  </li>\n<li>AT+BIND (Bluetooth HF Indicators Feature)  </li>\n<li>+BIND (Bluetooth HF Indicators Feature)  </li>\n<li>AT+BIEV (Bluetooth HF Indicators Feature)</li>\n</ul>\n<h3 id=\"建立服务连接\"><a href=\"#建立服务连接\" class=\"headerlink\" title=\"建立服务连接\"></a>建立服务连接</h3><blockquote>\n<p>Upon a user action or an internal event, either the HF or the AG may initiate a <strong>Service Level Connection</strong><br><strong>establishment</strong> procedure.<br>A Service Level Connection establishment requires the existence of a RFCOMM connection, that is, a<br>RFCOMM data link channel between the HF and the AG.<br>Both the HF and the AG may initiate the RFCOMM connection establishment. If there is no RFCOMM<br>session between the AG and the HF, the initiating device shall first initialize RFCOMM.  </p>\n</blockquote>\n<p>连接过程如下：</p>\n<p><img src=\"https://s1.ax1x.com/2022/04/11/LV6DxS.png\"></p>\n<ol>\n<li><p>支持能力交换<br>首先HF发送AT+BRSF&#x3D;&lt; HF supported features &gt;给AG，目的是首先通知AG其具有的能力，其次接收AG返回的其自身的BRSF能力。</p>\n</li>\n<li><p>Codec协商<br>如果HF支持Codec Negotiation特征，其会查看AG返回的BRSF中是否也支持该特性，如果都支持该特性，则HF将发送AT+BAC&#x3D;&lt; HF available codecs &gt;命令给AG以告知其可用的codec。</p>\n</li>\n<li><p>AG Indicator<br>HF从AG接收到的BRSF，可以知道AG支持的Indicator，并按顺序拍好，这是因为根据3GPP 27.007规范，AG可以支持Hands-Free不支持的profile。HF使用AT+CIND&#x3D;?测试命令接收AG支持的indicator以及它们的次序。<br>当HF获得必须的Indicator和它们的次序，它将通过AT+CIND?命令取得AG端正在使用indicator的状态。<br>当HF取得AG的indicator后，HF会使用AT+CMER使能AG的indicator状态跟新功能，AG会返回OK作为应答。当service，call或者call建立状态发生时，AG将发送和indicator相关的+CIEV结果码给HF。HF根据收到的+CIEV码来跟新其自身内部的indicator。<br>AG侧会一直保持indicator状态跟新功能使能直到收到AT+CMER指示其关闭或者HF和AG端的Service Level Connection连接断开。<br>当HF使能AG的indicator状态跟新，如果AG和HF都支持呼叫等待（Call waiting）和3方通信（3-way calling）。HF将发送AT+CHLD&#x3D;?测试命令取得AG是如何支持这种功能的。如果HF或者AG其中之一不支持三方通信，AT+CHLD&#x3D;?命令不会被发送。</p>\n</li>\n<li><p>HF Indicator<br>如果HF支持HF indicator，其会查看AG是否支持HF indicator。<br>如果HF和AG支持HF indicator特性，HF将发送AT+BIND&#x3D;&lt; HF supported HF indicators &gt;通知HF侧支持的indicator，AG以OK应答。<br>当AG接收到HF告知的HF indicator特性，HF将发送AT+BIND&#x3D;?请求AG侧支持的HF indicator。AG将会以+BIND和以OK结尾的应答。<br>当HF接收到AG支持的HF indicator，HF将会发送AT+BIND?命令确定HF目前使能的HF indicator。AG将会一次或多次以+BIND应答和以OK结尾的应答。<br>至此HF可能发送AT+BIEV命令告知AG其使能的HF indicator发生变化。<br>AG可以使用+BIND使能或者禁止任何HF indicator。</p>\n</li>\n<li><p>End of Service Level Connection</p>\n<ul>\n<li><p>HF需要知道Service Level Connection被完全建立，这可以通过以下几个方式：</p>\n<ul>\n<li>当且仅当AG通过+BRSF命令告知HF其支持的<code>&quot;HF indicator&quot;</code>，在HF收到AG通过<strong>AT+BIND？</strong>命令发来的其支持的<code>&quot;HF indicator&quot;</code>可认为完全建立。</li>\n<li>当且仅当SDP服务发现AH和AG双方均支持<code>&quot;Call waiting and 3-way calling&quot;</code>，在HFAG通过<strong>AT+CHLD</strong>命令发来的其对呼叫等待和多方电话的支持，对这种情况，<code>&quot;HF indicator&quot;</code>不要设置该比特位，AG也不要在+BRSF命令中设置该比特位。</li>\n<li>在HF使用<strong>AT+CMER</strong>命令成功启用<code>“Indicator status update”</code>功能，对这种情况SDP服务不应该设置<code>“Call waiting and 3-way calling”</code>比特位。<br>如果HF收到AG通过indicator指示当前有电话时，HF查询AG的接听和保持状态来判断是否是未接听电话。</li>\n</ul>\n</li>\n<li><p>同样AG侧Service Level Connection完全建立也有几种情况：</p>\n<ul>\n<li><p>当且仅当HF indicator在HF被设置且AG侧支持的indicator已经通过+BRSF命令应答，则AG以**+BIND加OK结尾**的命令应答其使能的HF indicator时可认为Service Level Connection完全建立。</p>\n</li>\n<li><p>当且仅当<code>“Call waiting and 3-way calling”</code>比特在HF和AG的SDP服务中被置位，在AG通过**+CHLD加OK结尾**命令成功响应其对呼叫保持和多方电话支持时SLC会被完全建立。对这种情况，+BRSF不应该设置该HF indicator比特位。</p>\n</li>\n<li><p>AG已成功<strong>响应OK到AT + CMER</strong>命令（启用<code>“Indicator status update”</code>功能。）当<code>“Call waiting and 3-way calling”</code>位时，应适用这种情况未在支持的功能位图中设置为HF或AG，以及<code>“HF Indicators ”</code>对于通过+ BRSF交换的HF或AG的支持功能位图中未设置位的位图命令。</p>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#判断是否支持&quot;Call waiting and 3-way calling&quot;</span><br><span class=\"line\">#AG发现HF, hfP支持的协议,HF支持&quot;Call waiting and 3-way calling&quot;</span><br><span class=\"line\">&gt; 596\t17.850811\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tSDP\t36\tRcvd Service Search Attribute Request : Handsfree: [Service Class ID List 0x0001] [Protocol Descriptor List 0x0004] [Bluetooth Profile Descriptor List 0x0009] [(HFP HS) Supported Features 0x0311] </span><br><span class=\"line\">&gt; 597\t17.851437\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tSDP\t69\tSent Service Search Attribute Response </span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth SDP Protocol</span><br><span class=\"line\">    PDU: Service Search Attribute Response (0x07)</span><br><span class=\"line\">    Transaction Id: 0x0000</span><br><span class=\"line\">    Parameter Length: 55</span><br><span class=\"line\">    Attribute List Byte Count: 52</span><br><span class=\"line\">    Attribute Lists [count =  1]</span><br><span class=\"line\">        Data Element: Sequence uint8 50 bytes</span><br><span class=\"line\">            0011 0... = Data Element Type: Sequence (6)</span><br><span class=\"line\">            .... .101 = Data Element Size: uint8 (5)</span><br><span class=\"line\">            Data Element Var Size: 50</span><br><span class=\"line\">            Data Value</span><br><span class=\"line\">                Attribute List [count =  4] (Handsfree)</span><br><span class=\"line\">                    Data Element: Sequence uint16 47 bytes</span><br><span class=\"line\">                        0011 0... = Data Element Type: Sequence (6)</span><br><span class=\"line\">                        .... .110 = Data Element Size: uint16 (6)</span><br><span class=\"line\">                        Data Element Var Size: 47</span><br><span class=\"line\">                        Data Value</span><br><span class=\"line\">                            Service Attribute: Service Class ID List (0x1), value = Handsfree -&gt; Generic Audio</span><br><span class=\"line\">                            Service Attribute: Protocol Descriptor List (0x4), value = L2CAP -&gt; RFCOMM:2</span><br><span class=\"line\">                            Service Attribute: Bluetooth Profile Descriptor List (0x9), value = Handsfree 1.6</span><br><span class=\"line\">                            Service Attribute: (HFP HS) Supported Features (0x311), value = (EC and/or Nr Function) (Call Waiting or Three Way Calling) (CLI Presentation Capability) (Voice Recognition Activation) (Remote Volume Control) (Wide Band Speech) </span><br><span class=\"line\">    Continuation State: no (00)</span><br><span class=\"line\"></span><br><span class=\"line\">#HF发现AG, hfP支持的协议,AG不支持&quot;Call waiting and 3-way calling&quot;，只支持&quot;3-way calling&quot;</span><br><span class=\"line\">&gt; 637\t18.017460\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tSDP\t33\tSent Service Search Attribute Request : Handsfree Audio Gateway: [Service Class ID List 0x0001] [Bluetooth Profile Descriptor List 0x0009] [(HFP AG) Supported Features 0x0311] </span><br><span class=\"line\">&gt; 644\t18.024689\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tSDP\t52\tRcvd Service Search Attribute Response </span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth SDP Protocol</span><br><span class=\"line\">    PDU: Service Search Attribute Response (0x07)</span><br><span class=\"line\">    Transaction Id: 0x0000</span><br><span class=\"line\">    Parameter Length: 38</span><br><span class=\"line\">    Attribute List Byte Count: 35</span><br><span class=\"line\">    Attribute Lists [count =  1]</span><br><span class=\"line\">        Data Element: Sequence uint8 33 bytes</span><br><span class=\"line\">            0011 0... = Data Element Type: Sequence (6)</span><br><span class=\"line\">            .... .101 = Data Element Size: uint8 (5)</span><br><span class=\"line\">            Data Element Var Size: 33</span><br><span class=\"line\">            Data Value</span><br><span class=\"line\">                Attribute List [count =  3] (Handsfree Audio Gateway)</span><br><span class=\"line\">                    Data Element: Sequence uint16 30 bytes</span><br><span class=\"line\">                        0011 0... = Data Element Type: Sequence (6)</span><br><span class=\"line\">                        .... .110 = Data Element Size: uint16 (6)</span><br><span class=\"line\">                        Data Element Var Size: 30</span><br><span class=\"line\">                        Data Value</span><br><span class=\"line\">                            Service Attribute: Service Class ID List (0x1), value = Handsfree Audio Gateway -&gt; Generic Audio</span><br><span class=\"line\">                            Service Attribute: Bluetooth Profile Descriptor List (0x9), value = Handsfree 1.6</span><br><span class=\"line\">                            Service Attribute: (HFP AG) Supported Features (0x311), value = (Three Way Calling) (EC and/or Nr Function) (Voice Recognition Function) (Wide Band Speech) </span><br><span class=\"line\">    Continuation State: no (00)</span><br><span class=\"line\"></span><br><span class=\"line\">#HFP建立连接</span><br><span class=\"line\">#交换支持功能，AG和HF都不支持&quot;HF indicator&quot;</span><br><span class=\"line\">&gt; 634\t18.012482\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t26\tSent AT+BRSF=255</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HFP Profile</span><br><span class=\"line\">    [Role: HS - Headset (2)]</span><br><span class=\"line\">    AT Stream: AT+BRSF=255\\r</span><br><span class=\"line\">    Command 0: +BRSF</span><br><span class=\"line\">        Command Line Prefix: AT</span><br><span class=\"line\">        Command: +BRSF (Bluetooth Retrieve Supported Features)</span><br><span class=\"line\">        Type: Action Command (0x003d)</span><br><span class=\"line\">        Parameters</span><br><span class=\"line\">            HS supported features bitmask: 255</span><br><span class=\"line\">                .... .... .... .... .... .... .... ...1 = EC and/or NR function: True</span><br><span class=\"line\">                .... .... .... .... .... .... .... ..1. = Call waiting or 3-way calling: True</span><br><span class=\"line\">                .... .... .... .... .... .... .... .1.. = CLI Presentation: True</span><br><span class=\"line\">                .... .... .... .... .... .... .... 1... = Voice Recognition Activation: True</span><br><span class=\"line\">                .... .... .... .... .... .... ...1 .... = Remote Volume Control: True</span><br><span class=\"line\">                .... .... .... .... .... .... ..1. .... = Enhanced Call Status: True</span><br><span class=\"line\">                .... .... .... .... .... .... .1.. .... = Enhanced Call Control: True</span><br><span class=\"line\">                .... .... .... .... .... .... 1... .... = Codec Negotiation: True</span><br><span class=\"line\">                .... .... .... .... .... ...0 .... .... = HF Indicators: False</span><br><span class=\"line\">                .... .... .... .... .... ..0. .... .... = eSCO S4 (and T2) Settings Support: False</span><br><span class=\"line\">                0000 0000 0000 0000 0000 00.. .... .... = Reserved: 0x000000</span><br><span class=\"line\">&gt; 641\t18.022446\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t28\tRcvd   +BRSF: 871</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HFP Profile</span><br><span class=\"line\">    [Role: AG - Audio Gate (1)]</span><br><span class=\"line\">    AT Stream: \\r\\n+BRSF: 871\\r\\n</span><br><span class=\"line\">    Command 0: +BRSF</span><br><span class=\"line\">        Command: +BRSF (Bluetooth Retrieve Supported Features)</span><br><span class=\"line\">        Type: Response (0x003a)</span><br><span class=\"line\">        Parameters</span><br><span class=\"line\">            AG supported features bitmask: 871</span><br><span class=\"line\">                .... .... .... .... .... .... .... ...1 = Three Way Calling: True</span><br><span class=\"line\">                .... .... .... .... .... .... .... ..1. = EC and/or NR function: True</span><br><span class=\"line\">                .... .... .... .... .... .... .... .1.. = Voice Recognition Function: True</span><br><span class=\"line\">                .... .... .... .... .... .... .... 0... = In-band Ring Tone: False</span><br><span class=\"line\">                .... .... .... .... .... .... ...0 .... = Attach Number to Voice Tag: False</span><br><span class=\"line\">                .... .... .... .... .... .... ..1. .... = Ability to Reject a Call: True</span><br><span class=\"line\">                .... .... .... .... .... .... .1.. .... = Enhanced Call Status: True</span><br><span class=\"line\">                .... .... .... .... .... .... 0... .... = Enhanced Call Control: False</span><br><span class=\"line\">                .... .... .... .... .... ...1 .... .... = Extended Error Result Codes: True</span><br><span class=\"line\">                .... .... .... .... .... ..1. .... .... = Codec Negotiation: True</span><br><span class=\"line\">                .... .... .... .... .... .0.. .... .... = HF Indicators: False</span><br><span class=\"line\">                .... .... .... .... .... 0... .... .... = eSCO S4 (and T2) Settings Support: False</span><br><span class=\"line\">                0000 0000 0000 0000 0000 .... .... .... = Reserved: 0x00000</span><br><span class=\"line\"></span><br><span class=\"line\">#AG和HF都支持&quot;Codec Negotiation&quot;，HF告知AG其可用的Codec编码(CVSD)</span><br><span class=\"line\">&gt; 643\t18.023696\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t23\tSent AT+BAC=1</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HFP Profile</span><br><span class=\"line\">    [Role: HS - Headset (2)]</span><br><span class=\"line\">    AT Stream: AT+BAC=1\\r</span><br><span class=\"line\">    Command 0: +BAC</span><br><span class=\"line\">        Command Line Prefix: AT</span><br><span class=\"line\">        Command: +BAC (Bluetooth Available Codecs)</span><br><span class=\"line\">        Type: Action Command (0x003d)</span><br><span class=\"line\">        Parameters</span><br><span class=\"line\">            Codec: CVSD (1)</span><br><span class=\"line\"></span><br><span class=\"line\">#获取AG支持的indicator以及它们的次序</span><br><span class=\"line\">&gt; 649\t18.029340\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t24\tSent AT+CIND=? </span><br><span class=\"line\">&gt; 652\t18.035680\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t147\tRcvd   +CIND: (&quot;CALL&quot;,(0,1)),(&quot;CALLSETUP&quot;,(0-3)),(&quot;SERVICE&quot;,(0-1)),(&quot;SIGNAL&quot;,(0-5)),(&quot;ROAM&quot;,(0,1)),(&quot;BATTCHG&quot;,(0-5)),(&quot;CALLHELD&quot;,(0-2)) </span><br><span class=\"line\"></span><br><span class=\"line\">#获取AG indicators当前的状态</span><br><span class=\"line\">&gt; 654\t18.037547\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t23\tSent AT+CIND? </span><br><span class=\"line\">&gt; 656\t18.092460\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t38\tRcvd   +CIND: 0,0,1,5,0,2,0</span><br><span class=\"line\"></span><br><span class=\"line\">#标志HFP连接建立</span><br><span class=\"line\">#启用&quot;Indicator status update&quot;</span><br><span class=\"line\">&gt; 658\t18.093591\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t30\tSent AT+CMER=3,0,0,1</span><br><span class=\"line\">&gt; 660\t18.117156\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t20\tRcvd   OK  </span><br></pre></td></tr></table></figure>\n\n<h3 id=\"HF拨打-挂断电话\"><a href=\"#HF拨打-挂断电话\" class=\"headerlink\" title=\"HF拨打\\挂断电话\"></a>HF拨打\\挂断电话</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#HF拨打电话</span><br><span class=\"line\">&gt; 921\t29.433324\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t24\tSent ATD10086; </span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HFP Profile</span><br><span class=\"line\">    [Role: HS - Headset (2)]</span><br><span class=\"line\">    AT Stream: ATD10086;\\r</span><br><span class=\"line\">    Command 0: D</span><br><span class=\"line\">        Command Line Prefix: AT</span><br><span class=\"line\">        Command: D (Dial)</span><br><span class=\"line\">        [Expert Info (Warning/Protocol): Non mandatory type or command in this role]</span><br><span class=\"line\">        Parameters: No</span><br><span class=\"line\">&gt; 924\t30.778650\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t20\tRcvd   OK</span><br><span class=\"line\"></span><br><span class=\"line\">#挂断电话</span><br><span class=\"line\">&gt; 965\t37.723080\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t22\tSent AT+CHUP</span><br><span class=\"line\">&gt; 966\t37.752000\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t20\tRcvd   OK</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"HF获取通话电话列表\"><a href=\"#HF获取通话电话列表\" class=\"headerlink\" title=\"HF获取通话电话列表\"></a>HF获取通话电话列表</h3><p>会HF会轮询此命令</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 925\t30.779082\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t22\tSent AT+CLCC </span><br><span class=\"line\">&gt; 929\t30.820871\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t46\tRcvd   +CLCC: 1,0,2,0,0,&quot;10086&quot;,129 </span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HFP Profile</span><br><span class=\"line\">    [Role: AG - Audio Gate (1)]</span><br><span class=\"line\">    AT Stream: \\r\\n+CLCC: 1,0,2,0,0,&quot;10086&quot;,129\\r\\n</span><br><span class=\"line\">    Command 0: +CLCC</span><br><span class=\"line\">        Command: +CLCC (Current Calls)</span><br><span class=\"line\">        Type: Response (0x003a)</span><br><span class=\"line\">        Parameters</span><br><span class=\"line\">            ID: 1</span><br><span class=\"line\">            Direction: Mobile Originated (0)</span><br><span class=\"line\">            State: Dialing (2)</span><br><span class=\"line\">            Mode: Voice (0)</span><br><span class=\"line\">            Mpty: Call is not one of multiparty (conference) call parties (0)</span><br><span class=\"line\">            Number: &quot;10086&quot;</span><br><span class=\"line\">            Type: The phone number format may be a national or international format, and may contain prefix and/or escape digits. No changes on the number presentation are required. (129)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"AG下发通话状态\"><a href=\"#AG下发通话状态\" class=\"headerlink\" title=\"AG下发通话状态\"></a>AG下发通话状态</h3><p>在开启<code>&quot;Indicator status update&quot;</code>(AT+CMER)之后，AG会主动下发当前的通话状态，<code>Indicator Index</code>对应+CIND返回的参数列表，<code>Indicator &lt;idx&gt;</code>对应其值。</p>\n<h4 id=\"拨打电话\"><a href=\"#拨打电话\" class=\"headerlink\" title=\"拨打电话\"></a>拨打电话</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#CALLSETUP=2,拨号中</span><br><span class=\"line\">&gt; 1056\t66.689969\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t27\tRcvd   +CIEV: 2,2  </span><br></pre></td></tr></table></figure>\n\n<h4 id=\"无通话或者挂断\"><a href=\"#无通话或者挂断\" class=\"headerlink\" title=\"无通话或者挂断\"></a>无通话或者挂断</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#CALL=0,无通话</span><br><span class=\"line\">1106\t74.975552\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t27\tRcvd   +CIEV: 1,0  </span><br></pre></td></tr></table></figure>\n\n<h4 id=\"来电\"><a href=\"#来电\" class=\"headerlink\" title=\"来电\"></a>来电</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#CALLSETUP=1,来电中</span><br><span class=\"line\">&gt; 1056\t66.689969\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tHFP\t27\tRcvd   +CIEV: 2,1 </span><br></pre></td></tr></table></figure>\n<h3 id=\"建立SCO-x2F-eSCO连接\"><a href=\"#建立SCO-x2F-eSCO连接\" class=\"headerlink\" title=\"建立SCO&#x2F;eSCO连接\"></a>建立SCO&#x2F;eSCO连接</h3><p>蓝牙电话的音频数据由SCO&#x2F;eSCO协议传输，在HCI中无数据相关的日志。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#HF选择编解码格式</span><br><span class=\"line\">&gt; 900\t387.320548\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tHFP\t24\tRcvd   +BCS: 1  </span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HFP Profile</span><br><span class=\"line\">    [Role: AG - Audio Gate (1)]</span><br><span class=\"line\">    AT Stream: \\r\\n+BCS: 1\\r\\n</span><br><span class=\"line\">    Command 0: +BCS</span><br><span class=\"line\">        Command: +BCS (Bluetooth Codec Selection)</span><br><span class=\"line\">        Type: Response (0x003a)</span><br><span class=\"line\">        Parameters</span><br><span class=\"line\">            Codec: CVSD (1)</span><br><span class=\"line\">&gt; 903\t387.380459\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tHFP\t23\tSent AT+BCS=1 </span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HFP Profile</span><br><span class=\"line\">    [Role: HS - Headset (2)]</span><br><span class=\"line\">    AT Stream: AT+BCS=1\\r</span><br><span class=\"line\">    Command 0: +BCS</span><br><span class=\"line\">        Command Line Prefix: AT</span><br><span class=\"line\">        Command: +BCS (Bluetooth Codec Selection)</span><br><span class=\"line\">        Type: Action Command (0x003d)</span><br><span class=\"line\">        Parameters</span><br><span class=\"line\">            Codec: CVSD (1)</span><br><span class=\"line\"></span><br><span class=\"line\">#AG请求建立eSCO连接</span><br><span class=\"line\">&gt; 906\t387.530834\tcontroller\thost\tHCI_EVT\t13\tRcvd Connect Request</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Connect Request</span><br><span class=\"line\">    Event Code: Connect Request (0x04)</span><br><span class=\"line\">    Parameter Total Length: 10</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Class of Device: 0x001f00 (Uncategorized: device code not specified:Unknown - services:)</span><br><span class=\"line\">    Link Type: eSCO connection (Voice Channels) (0x02)</span><br><span class=\"line\"></span><br><span class=\"line\">#HF允许建立eSCO连接</span><br><span class=\"line\">&gt; 907\t387.531078\thost\tcontroller\tHCI_CMD\t67\tSent Enhanced Accept Synchronous Connection Request</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Command - Enhanced Accept Synchronous Connection Request</span><br><span class=\"line\">    Command Opcode: Enhanced Accept Synchronous Connection Request (0x043e)</span><br><span class=\"line\">        0000 01.. .... .... = Opcode Group Field: Link Control Commands (0x01)</span><br><span class=\"line\">        .... ..00 0011 1110 = Opcode Command Field: Enhanced Accept Synchronous Connection Request (0x03e)</span><br><span class=\"line\">    Parameter Total Length: 63</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Tx Bandwidth (bytes/s): 8000</span><br><span class=\"line\">    Rx Bandwidth (bytes/s): 8000</span><br><span class=\"line\">    Transmit Coding Format</span><br><span class=\"line\">    Receive Coding Format</span><br><span class=\"line\">    Transmit Codec Frame Size: 60</span><br><span class=\"line\">    Receive Codec Frame Size: 60</span><br><span class=\"line\">    Input Bandwidth: 16000</span><br><span class=\"line\">    Output Bandwidth: 16000</span><br><span class=\"line\">    Input Coding Format</span><br><span class=\"line\">    Output Coding Format</span><br><span class=\"line\">    Input Coded Data Size: 16</span><br><span class=\"line\">    Output Coded Data Size: 16</span><br><span class=\"line\">    Input PCM Data Format: 2&#x27;s complement (0x02)</span><br><span class=\"line\">    Output PCM Data Format: 2&#x27;s complement (0x02)</span><br><span class=\"line\">    Input PCM Sample Payload MSB Position: 0</span><br><span class=\"line\">    Output PCM Sample Payload MSB Position: 0</span><br><span class=\"line\">    Input Data Path: Vendor Specific</span><br><span class=\"line\">    Output Data Path: Vendor Specific</span><br><span class=\"line\">    Input Transport Unit Size: 16</span><br><span class=\"line\">    Output Transport Unit Size: 16</span><br><span class=\"line\">    Max. Latency (ms): 12</span><br><span class=\"line\">    Packet Type: 0x03bf, 3-EV5 may NOT be used, 2-EV5 may NOT be used, 3-EV3 may NOT be used, EV5 may be used, EV4 may be used, EV3 may be used, HV3 may be used, HV2 may be used, HV1 may be used</span><br><span class=\"line\">    Retransmission Effort: At least 1 retransmission, optimize for link quality (2)</span><br><span class=\"line\">    [Pending in frame: 909]</span><br><span class=\"line\">    [Command-Pending Delta: 1.38ms]</span><br><span class=\"line\">    [Response in frame: 910]</span><br><span class=\"line\">    [Command-Response Delta: 3.862ms]</span><br><span class=\"line\"></span><br><span class=\"line\">#eSCO连接成功</span><br><span class=\"line\">&gt; 910\t387.534940\tcontroller\thost\tHCI_EVT\t20\tRcvd Synchronous Connection Complete</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth HCI Event - Synchronous Connection Complete</span><br><span class=\"line\">    Event Code: Synchronous Connection Complete (0x2c)</span><br><span class=\"line\">    Parameter Total Length: 17</span><br><span class=\"line\">    Status: Success (0x00)</span><br><span class=\"line\">    Connection Handle: 0x0e00</span><br><span class=\"line\">    BD_ADDR: XiaomiCo_6e:38:c5 (00:00:00:00:00:00)</span><br><span class=\"line\">    Link Type: eSCO connection (0x02)</span><br><span class=\"line\">    Transmit Interval: 12 slots (7.5 msec)</span><br><span class=\"line\">    Retransmit Window: 2 slots (1.25 msec)</span><br><span class=\"line\">    Rx Packet Length: 60</span><br><span class=\"line\">    Tx Packet Length: 60</span><br><span class=\"line\">    Air Mode: CVSD (2)</span><br><span class=\"line\">    [Command in frame: 907]</span><br><span class=\"line\">    [Pending in frame: 909]</span><br><span class=\"line\">    [Pending-Response Delta: 2.482ms]</span><br><span class=\"line\">    [Command-Response Delta: 3.862ms]</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"蓝牙音乐\"><a href=\"#蓝牙音乐\" class=\"headerlink\" title=\"蓝牙音乐\"></a>蓝牙音乐</h1><h2 id=\"AVDTP\"><a href=\"#AVDTP\" class=\"headerlink\" title=\"AVDTP\"></a>AVDTP</h2><p><strong>AVDTP：AUDIO&#x2F;VIDEO DISTRIBUTION TRANSPORT PROTOCOL(音视频分配传输协议)</strong> ，用于音乐数据流的建立与传输控制。</p>\n<h3 id=\"建立连接\"><a href=\"#建立连接\" class=\"headerlink\" title=\"建立连接\"></a>建立连接</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 458\t11.574257\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tL2CAP\t17\tSent Connection Request (AVDTP, SCID: 0x0042)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"数据流传输\"><a href=\"#数据流传输\" class=\"headerlink\" title=\"数据流传输\"></a>数据流传输</h3><p>数据流的生命状态：</p>\n<p><img src=\"https://s1.ax1x.com/2022/04/11/LV6NVA.png\"></p>\n<h4 id=\"查找-Idle\"><a href=\"#查找-Idle\" class=\"headerlink\" title=\"查找(Idle)\"></a>查找(Idle)</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#查询AG的所有音源</span><br><span class=\"line\">&gt; 468\t11.652772\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tAVDTP\t11\tSent Command - Discover</span><br><span class=\"line\">&gt; 469\t11.722467\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tAVDTP\t15\tRcvd ResponseAccept - Discover - items: 2</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVDTP Protocol</span><br><span class=\"line\">    Signal: Discover (ResponseAccept)</span><br><span class=\"line\">    ACP SEP [1 - Audio Source] item 1/2</span><br><span class=\"line\">        0000 01.. = SEID: 1</span><br><span class=\"line\">        .... ..0. = In Use: False (0x0)</span><br><span class=\"line\">        .... ...0 = RFA0: 0x0</span><br><span class=\"line\">        0000 .... = Media Type: Audio (0x0)</span><br><span class=\"line\">        .... 0... = Type: Source (0x0)</span><br><span class=\"line\">        .... .000 = RFA1: 0x0</span><br><span class=\"line\">    ACP SEP [2 - Audio Source] item 2/2</span><br><span class=\"line\">        0000 10.. = SEID: 2</span><br><span class=\"line\">        .... ..0. = In Use: False (0x0)</span><br><span class=\"line\">        .... ...0 = RFA0: 0x0</span><br><span class=\"line\">        0000 .... = Media Type: Audio (0x0)</span><br><span class=\"line\">        .... 0... = Type: Source (0x0)</span><br><span class=\"line\">        .... .000 = RFA1: 0x0</span><br><span class=\"line\"></span><br><span class=\"line\">#获取音源详细信息</span><br><span class=\"line\">&gt; 470\t11.722896\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tAVDTP\t12\tSent Command - GetAllCapabilities - ACP SEID [1 - Audio Source]</span><br><span class=\"line\">&gt; 473\t11.728705\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tAVDTP\t23\tRcvd ResponseAccept - GetAllCapabilities - Audio SBC (44100 | Mono JointStereo | block: 4 8 12 16 | subbands: 8 | allocation: Loudness | bitpool: 2..53)</span><br><span class=\"line\">&gt; 474\t11.728960\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tAVDTP\t12\tSent Command - GetAllCapabilities - ACP SEID [2 - Audio Source]</span><br><span class=\"line\">&gt; 476\t11.734811\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tAVDTP\t25\tRcvd ResponseAccept - GetAllCapabilities - Audio MPEG-2,4 AAC</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVDTP Protocol</span><br><span class=\"line\">    Signal: GetAllCapabilities (ResponseAccept)</span><br><span class=\"line\">        0010 .... = Transaction: 0x2</span><br><span class=\"line\">        .... 00.. = Packet Type: Single (0x0)</span><br><span class=\"line\">        .... ..10 = Message Type: ResponseAccept (0x2)</span><br><span class=\"line\">        00.. .... = RFA: 0x0</span><br><span class=\"line\">        ..00 1100 = Signal: GetAllCapabilities (0x0c)</span><br><span class=\"line\">    Capabilities</span><br><span class=\"line\">        Service: Media Transport</span><br><span class=\"line\">        Service: Media Codec - Audio MPEG-2,4 AAC</span><br><span class=\"line\">        Service: Delay Reporting</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"设置-x2F-打开-Configured-x2F-Open\"><a href=\"#设置-x2F-打开-Configured-x2F-Open\" class=\"headerlink\" title=\"设置&#x2F;打开(Configured&#x2F;Open)\"></a>设置&#x2F;打开(Configured&#x2F;Open)</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#选择对应音源</span><br><span class=\"line\">&gt; 477\t11.735508\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tAVDTP\t25\tSent Command - SetConfiguration - ACP SEID [2 - Audio Source] - INT SEID [2 - Audio Source] - Audio MPEG-2,4 AAC</span><br><span class=\"line\">&gt; 479\t11.742210\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tAVDTP\t11\tRcvd ResponseAccept - SetConfiguration</span><br><span class=\"line\"></span><br><span class=\"line\">#打开音源</span><br><span class=\"line\">&gt; 480\t11.742538\tSANYOEle_62:35:bb (DEVICE)\tXiaomiCo_6e:38:c5 (PHONE)\tAVDTP\t12\tSent Command - Open - ACP SEID [2 - Audio Source]</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVDTP Protocol</span><br><span class=\"line\">    Signal: Open (Command)</span><br><span class=\"line\">    ACP SEID [2 - Audio Source]</span><br><span class=\"line\">&gt; 485\t11.747312\tXiaomiCo_6e:38:c5 (PHONE)\tSANYOEle_62:35:bb (DEVICE)\tAVDTP\t11\tRcvd ResponseAccept - Open</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"开始传输-Streaming\"><a href=\"#开始传输-Streaming\" class=\"headerlink\" title=\"开始传输(Streaming)\"></a>开始传输(Streaming)</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 601\t28.945727\tXiaomiCo_f2:31:c7 (PHONE)\tSANYOEle_71:7b:5c (DEVICE)\tAVDTP\t12\tRcvd Command - Start - ACP SEID [2 - Audio Sink]</span><br><span class=\"line\">&gt; 602\t28.946025\tSANYOEle_71:7b:5c (DEVICE)\tXiaomiCo_f2:31:c7 (PHONE)\tAVDTP\t11\tSent ResponseAccept - Start</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"传输-Streaming\"><a href=\"#传输-Streaming\" class=\"headerlink\" title=\"传输(Streaming)\"></a>传输(Streaming)</h4><p>使用RTP协议传输数据，AVDTP协议本身不处理数据流。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 612\t29.166322\tXiaomiCo_f2:31:c7 (PHONE)\tSANYOEle_71:7b:5c (DEVICE)\tRTP\t37\tPT=Unknown, SSRC=0x2, Seq=1, Time=0</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Frame 612: 37 bytes on wire (296 bits), 37 bytes captured (296 bits)</span><br><span class=\"line\">Bluetooth</span><br><span class=\"line\">Bluetooth HCI H4</span><br><span class=\"line\">Bluetooth HCI ACL Packet</span><br><span class=\"line\">Bluetooth L2CAP Protocol</span><br><span class=\"line\">Bluetooth A2DP Profile</span><br><span class=\"line\">    [ACP SEID: 2]</span><br><span class=\"line\">    [INT SEID: 2]</span><br><span class=\"line\">    [Codec: MPEG-2,4 AAC (0x02)]</span><br><span class=\"line\">    [Stream Start in Frame: 612]</span><br><span class=\"line\">    [Stream End in Frame: 22786]</span><br><span class=\"line\">    [Stream Number: 1]</span><br><span class=\"line\">Real-Time Transport Protocol</span><br><span class=\"line\">    [Stream setup by BT A2DP (frame 612)]</span><br><span class=\"line\">    10.. .... = Version: RFC 1889 Version (2)</span><br><span class=\"line\">    ..0. .... = Padding: False</span><br><span class=\"line\">    ...0 .... = Extension: False</span><br><span class=\"line\">    .... 0000 = Contributing source identifiers count: 0</span><br><span class=\"line\">    0... .... = Marker: False</span><br><span class=\"line\">    Payload type: Unknown (98)</span><br><span class=\"line\">    Sequence number: 1</span><br><span class=\"line\">    [Extended sequence number: 65537]</span><br><span class=\"line\">    Timestamp: 0</span><br><span class=\"line\">    Synchronization Source identifier: 0x00000002 (2)</span><br><span class=\"line\">Data (16 bytes)</span><br><span class=\"line\">    Data: 47fc0000b0908003000621100520a41c</span><br><span class=\"line\">    [Length: 16]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"暂停-Streaming\"><a href=\"#暂停-Streaming\" class=\"headerlink\" title=\"暂停(Streaming)\"></a>暂停(Streaming)</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 773\t23.510436\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVDTP\t11\tSent ResponseAccept - Suspend</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"释放-Closing\"><a href=\"#释放-Closing\" class=\"headerlink\" title=\"释放(Closing)\"></a>释放(Closing)</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 5692\t96.414176\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVDTP\t12\tSent Command - Close - ACP SEID [2 - Audio Source]</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"AVCTP\"><a href=\"#AVCTP\" class=\"headerlink\" title=\"AVCTP\"></a>AVCTP</h2><p>**AVCTP： Audio&#x2F;Video Control Transport Protocol(音频&#x2F;视频控制传输协议)**，用于蓝牙设备间音乐数据流功能的发现与控制，但是控制的具体功能逻辑不由AVCTP处理，其只发送命令。</p>\n<p>发现由SDP协议完成，然后发起L2CAP通道连接蓝牙设备之间的AVCTP服务，如下:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#发现</span><br><span class=\"line\">&gt; 134\t0.964749\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tSDP\t33\tSent Service Search Attribute Request : Audio Source: [Service Class ID List 0x0001] [Protocol Descriptor List 0x0004] [Bluetooth Profile Descriptor List 0x0009] </span><br><span class=\"line\">&gt; 139\t0.981837\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tSDP\t64\tRcvd Service Search Attribute Response </span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth SDP Protocol</span><br><span class=\"line\">    PDU: Service Search Attribute Response (0x07)</span><br><span class=\"line\">    Transaction Id: 0x0000</span><br><span class=\"line\">    Parameter Length: 50</span><br><span class=\"line\">    Attribute List Byte Count: 47</span><br><span class=\"line\">    Attribute Lists [count =  1]</span><br><span class=\"line\">        Data Element: Sequence uint8 45 bytes</span><br><span class=\"line\">            0011 0... = Data Element Type: Sequence (6)</span><br><span class=\"line\">            .... .101 = Data Element Size: uint8 (5)</span><br><span class=\"line\">            Data Element Var Size: 45</span><br><span class=\"line\">            Data Value</span><br><span class=\"line\">                Attribute List [count =  3] (Audio Source)</span><br><span class=\"line\">                    Data Element: Sequence uint16 42 bytes</span><br><span class=\"line\">                        0011 0... = Data Element Type: Sequence (6)</span><br><span class=\"line\">                        .... .110 = Data Element Size: uint16 (6)</span><br><span class=\"line\">                        Data Element Var Size: 42</span><br><span class=\"line\">                        Data Value</span><br><span class=\"line\">                            Service Attribute: Service Class ID List (0x1), value = Audio Source</span><br><span class=\"line\">                                Attribute ID: Service Class ID List</span><br><span class=\"line\">                                Value</span><br><span class=\"line\">                            Service Attribute: Protocol Descriptor List (0x4), value = L2CAP:25 -&gt; AVDTP (1.3)</span><br><span class=\"line\">                                Attribute ID: Protocol Descriptor List</span><br><span class=\"line\">                                Value</span><br><span class=\"line\">                            Service Attribute: Bluetooth Profile Descriptor List (0x9), value = Advanced Audio Distribution 1.3</span><br><span class=\"line\">                                Attribute ID: Bluetooth Profile Descriptor List</span><br><span class=\"line\">                                Value</span><br><span class=\"line\">    Continuation State: no (00)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#连接</span><br><span class=\"line\">&gt; 147\t1.006617\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tL2CAP\t17\tSent Connection Request (AVDTP, SCID: 0x0043)</span><br><span class=\"line\">&gt; 155\t1.017317\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tL2CAP\t21\tRcvd Connection Response - Success (SCID: 0x0043, DCID: 0x0042)</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"AVRCP\"><a href=\"#AVRCP\" class=\"headerlink\" title=\"AVRCP\"></a>AVRCP</h2><p>**AVRCP：Audio&#x2F;Video Remote Control Profile(音频&#x2F;视频远程控制配置文件)**，用于控制蓝牙音乐的标准接口。</p>\n<p>在AVRCP中，<strong>TG</strong>表示播放设备，<strong>CT</strong>表示控制设备。</p>\n<h3 id=\"命令格式\"><a href=\"#命令格式\" class=\"headerlink\" title=\"命令格式\"></a>命令格式</h3><p>命令分为两个类型：VENDOR DEPENDENT 与PASS THROUGH，</p>\n<ul>\n<li><p>VENDOR DEPENDENT：通过<code>Ctype</code>与<code>PDU ID</code>来区分功能，<code>Ctype</code>有<strong>Control, Status , Notify</strong>,ACCEPTED,REJECTED, CHANGED,INTERIM,IMPLEMENTED,STABLE等。</p>\n</li>\n<li><p>PASS THROUGH：是播放控制命令，<code>Ctype</code>只有<strong>Control</strong>。</p>\n</li>\n</ul>\n<p>其中请求命令<code>Ctype</code>为<strong>Notify</strong>，回复事件<code>Ctype</code>为<strong>Interim</strong>，事件通知<code>Ctype</code>为<strong>Changed</strong>。</p>\n<h3 id=\"获取TG播放器支持功能\"><a href=\"#获取TG播放器支持功能\" class=\"headerlink\" title=\"获取TG播放器支持功能\"></a>获取TG播放器支持功能</h3><p><code>PDU ID</code>：GetFolderItems，通过<code>Scope</code>来区分功能，用于<strong>TG</strong>可以播放器列表与每个播放器支持的功能。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 307\t1.551666\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t29\tSent Browsing: Command - GetFolderItems - Scope: MediaPlayerList, StartItem: 0x0000, EndItem: 0x0013</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    PDU ID: GetFolderItems (0x71)</span><br><span class=\"line\">    Parameter Length: 10</span><br><span class=\"line\">    Scope: MediaPlayerList (0x00)</span><br><span class=\"line\">    StartItem: 0</span><br><span class=\"line\">    EndItem: 19</span><br><span class=\"line\">    Attribute Count: All attributes are requested (0)</span><br><span class=\"line\">    Attribute List</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 326\t1.651062\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t67\tRcvd Browsing: OK - GetFolderItems - UidCounter: 0x0000, NumberOfItems: 1</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    PDU ID: GetFolderItems (0x71)</span><br><span class=\"line\">    Parameter Length: 48</span><br><span class=\"line\">    Status: OK (0x04)</span><br><span class=\"line\">    UID Counter: 0x0000</span><br><span class=\"line\">    Number Of Items: 1</span><br><span class=\"line\">    Player: Music Player</span><br><span class=\"line\">        Item Type: Media Player Item (0x01)</span><br><span class=\"line\">        Item Length: 40</span><br><span class=\"line\">        Player ID: 0</span><br><span class=\"line\">        Major Player Type: Unknown (0x01)</span><br><span class=\"line\">        Player SubType: Audio Book (0x00000001)</span><br><span class=\"line\">        Play Status: Stopped (0x00)</span><br><span class=\"line\">        Features</span><br><span class=\"line\">            Not Used Features</span><br><span class=\"line\">            .... ...1 = PASSTHROUGH Play: 0x1</span><br><span class=\"line\">            .... ..1. = PASSTHROUGH Stop: 0x1</span><br><span class=\"line\">            .... .1.. = PASSTHROUGH Pause: 0x1</span><br><span class=\"line\">            ...1 .... = PASSTHROUGH Rewind: 0x1</span><br><span class=\"line\">            ..1. .... = PASSTHROUGH FastForward: 0x1</span><br><span class=\"line\">            1... .... = PASSTHROUGH Forward: 0x1</span><br><span class=\"line\">            .... ...1 = PASSTHROUGH Backward: 0x1</span><br><span class=\"line\">            .... .1.. = Advanced Control Player: 0x1</span><br><span class=\"line\">        Character Set: UTF-8 (106)</span><br><span class=\"line\">        Displayable Name Length: 12</span><br><span class=\"line\">        Displayable Name: Music Player</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"获取TG支持事件\"><a href=\"#获取TG支持事件\" class=\"headerlink\" title=\"获取TG支持事件\"></a>获取TG支持事件</h3><p><code>PDU ID</code>：GetCapabilities，用于<strong>TG</strong>可以支持的事件。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 288\t1.233497\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t23\tSent Vendor dependent: Status - GetCapabilities(Events Supported)</span><br><span class=\"line\">&gt; 299\t1.252688\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t30\tRcvd Vendor dependent: Stable - GetCapabilities(Events Supported) - Count: 6</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    0000 .... = Reserved: 0x0</span><br><span class=\"line\">    .... 1100 = Ctype: Stable (0xc)</span><br><span class=\"line\">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class=\"line\">    .... .000 = Subunit ID: 0x0</span><br><span class=\"line\">    Opcode: Vendor dependent (0x00)</span><br><span class=\"line\">    Company ID: 00:19:58 (Bluetooth SIG, Inc.)</span><br><span class=\"line\">    PDU ID: GetCapabilities (0x10)</span><br><span class=\"line\">    0000 00.. = RFA: 0x00</span><br><span class=\"line\">    .... ..00 = Packet Type: Single (0x0)</span><br><span class=\"line\">    Parameter Length: 8</span><br><span class=\"line\">    Capability: Events Supported (0x03)</span><br><span class=\"line\">    Capability Count: 0x06</span><br><span class=\"line\">    Event ID: PlaybackStatusChanged (0x01)</span><br><span class=\"line\">    Event ID: TrackChanged (0x02)</span><br><span class=\"line\">    Event ID: PlaybackPositionChanged (0x05)</span><br><span class=\"line\">    Event ID: AvailablePlayersChanged (0x0a)</span><br><span class=\"line\">    Event ID: AddressedPlayerChanged (0x0b)</span><br><span class=\"line\">    Event ID: NowPlayingContentChanged (0x09)</span><br><span class=\"line\">    [Response Time: 19/1000ms]</span><br><span class=\"line\">    [Command in frame: 288]</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"播放器状态\"><a href=\"#播放器状态\" class=\"headerlink\" title=\"播放器状态\"></a>播放器状态</h3><p><strong>CT</strong>端获取<strong>TC</strong>端播放状态，<code>Play Status</code>的参数由<code>GetFolderItems</code>原语获取，通过<code>Ctype</code>来区分操作。</p>\n<h4 id=\"注册事件\"><a href=\"#注册事件\" class=\"headerlink\" title=\"注册事件\"></a>注册事件</h4><p><code>PDU ID</code>：RegisterNotification，<code>Event ID</code>为: PlaybackStatusChanged(<code>GetCapabilities</code>原语获取)。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 300\t1.252942\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t27\tSent Vendor dependent: Notify - RegisterNotification - PlaybackStatusChanged</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    0000 .... = Reserved: 0x0</span><br><span class=\"line\">    .... 0011 = Ctype: Notify (0x3)</span><br><span class=\"line\">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class=\"line\">    .... .000 = Subunit ID: 0x0</span><br><span class=\"line\">    Opcode: Vendor dependent (0x00)</span><br><span class=\"line\">    Company ID: 00:19:58 (Bluetooth SIG, Inc.)</span><br><span class=\"line\">    PDU ID: RegisterNotification (0x31)</span><br><span class=\"line\">    0000 00.. = RFA: 0x00</span><br><span class=\"line\">    .... ..00 = Packet Type: Single (0x0)</span><br><span class=\"line\">    Parameter Length: 5</span><br><span class=\"line\">    Event ID: PlaybackStatusChanged (0x01)</span><br><span class=\"line\">    Interval: 0</span><br><span class=\"line\">    [Response Time: 107/1000ms]</span><br><span class=\"line\">    [Response in frame: 324]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 324\t1.649874\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t24\tRcvd Vendor dependent: Interim - RegisterNotification - PlaybackStatusChanged - PlayStatus: Paused</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    0000 .... = Reserved: 0x0</span><br><span class=\"line\">    .... 1111 = Ctype: Interim (0xf)</span><br><span class=\"line\">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class=\"line\">    .... .000 = Subunit ID: 0x0</span><br><span class=\"line\">    Opcode: Vendor dependent (0x00)</span><br><span class=\"line\">    Company ID: 00:19:58 (Bluetooth SIG, Inc.)</span><br><span class=\"line\">    PDU ID: RegisterNotification (0x31)</span><br><span class=\"line\">    0000 00.. = RFA: 0x00</span><br><span class=\"line\">    .... ..00 = Packet Type: Single (0x0)</span><br><span class=\"line\">    Parameter Length: 2</span><br><span class=\"line\">    Event ID: PlaybackStatusChanged (0x01)</span><br><span class=\"line\">    Play Status: Paused (0x02)</span><br><span class=\"line\">    [Response Time: 107/1000ms]</span><br><span class=\"line\">    [Command in frame: 300]</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"事件通知\"><a href=\"#事件通知\" class=\"headerlink\" title=\"事件通知\"></a>事件通知</h4><p><code>PDU ID</code>：RegisterNotification，<code>Event ID</code>为: PlaybackStatusChanged，通过<code>Ctype</code>来区分功能。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 372\t2.461590\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t24\tRcvd Vendor dependent: Changed - RegisterNotification - PlaybackStatusChanged - PlayStatus: Stopped</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    0000 .... = Reserved: 0x0</span><br><span class=\"line\">    .... 1101 = Ctype: Changed (0xd)</span><br><span class=\"line\">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class=\"line\">    .... .000 = Subunit ID: 0x0</span><br><span class=\"line\">    Opcode: Vendor dependent (0x00)</span><br><span class=\"line\">    Company ID: 00:19:58 (Bluetooth SIG, Inc.)</span><br><span class=\"line\">    PDU ID: RegisterNotification (0x31)</span><br><span class=\"line\">    0000 00.. = RFA: 0x00</span><br><span class=\"line\">    .... ..00 = Packet Type: Single (0x0)</span><br><span class=\"line\">    Parameter Length: 2</span><br><span class=\"line\">    Event ID: PlaybackStatusChanged (0x01)</span><br><span class=\"line\">    Play Status: Stopped (0x00)</span><br><span class=\"line\">    [Response Time: 107/1000ms]</span><br><span class=\"line\">    [Command in frame: 300]</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"主动获取\"><a href=\"#主动获取\" class=\"headerlink\" title=\"主动获取\"></a>主动获取</h4><p><code>PDU ID</code>：GetPlayStatus，往往与<code>RegisterNotification-TrackChanged</code>命令配合使用。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 466\t18.051244\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t22\tSent Vendor dependent: Status - GetPlayStatus</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    0000 .... = Reserved: 0x0</span><br><span class=\"line\">    .... 0001 = Ctype: Status (0x1)</span><br><span class=\"line\">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class=\"line\">    .... .000 = Subunit ID: 0x0</span><br><span class=\"line\">    Opcode: Vendor dependent (0x00)</span><br><span class=\"line\">    Company ID: 00:19:58 (Bluetooth SIG, Inc.)</span><br><span class=\"line\">    PDU ID: GetPlayStatus (0x30)</span><br><span class=\"line\">    0000 00.. = RFA: 0x00</span><br><span class=\"line\">    .... ..00 = Packet Type: Single (0x0)</span><br><span class=\"line\">    Parameter Length: 0</span><br><span class=\"line\">    [Response Time: 40/1000ms]</span><br><span class=\"line\">    [Response in frame: 478]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 478\t18.091970\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t31\tRcvd Vendor dependent: Stable - GetPlayStatus PlayStatus: Playing, SongPosition: 6118ms, SongLength: 175000ms</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    0000 .... = Reserved: 0x0</span><br><span class=\"line\">    .... 1100 = Ctype: Stable (0xc)</span><br><span class=\"line\">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class=\"line\">    .... .000 = Subunit ID: 0x0</span><br><span class=\"line\">    Opcode: Vendor dependent (0x00)</span><br><span class=\"line\">    Company ID: 00:19:58 (Bluetooth SIG, Inc.)</span><br><span class=\"line\">    PDU ID: GetPlayStatus (0x30)</span><br><span class=\"line\">    0000 00.. = RFA: 0x00</span><br><span class=\"line\">    .... ..00 = Packet Type: Single (0x0)</span><br><span class=\"line\">    Parameter Length: 9</span><br><span class=\"line\">    Song Length: 175000</span><br><span class=\"line\">    Song Position: 6118</span><br><span class=\"line\">    Play Status: Playing (0x01)</span><br><span class=\"line\">    [Response Time: 40/1000ms]</span><br><span class=\"line\">    [Command in frame: 466]</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"播放进度\"><a href=\"#播放进度\" class=\"headerlink\" title=\"播放进度\"></a>播放进度</h3><p>使用<code>PDU ID</code>：GetPlayStatus，获取<strong>TG</strong>端播放进度，<strong>CT</strong>端轮循调用此命令。其中<code>Song Length</code>参数为音乐长度，<code>Song Position</code>为当前播放进度。日志参考<code>主动获取播放器</code>章节。</p>\n<h3 id=\"音轨状态\"><a href=\"#音轨状态\" class=\"headerlink\" title=\"音轨状态\"></a>音轨状态</h3><p><strong>CT</strong>端获取<strong>TC</strong>端播放器音轨状态，状态有下面两种：</p>\n<ul>\n<li>无音轨：<code>Identifier: 0xffffffffffffffff (NOT SELECTED)</code></li>\n<li>有音轨：<code>Identifier: 0x0000000000000000 (SELECTED)</code></li>\n</ul>\n<p><strong>音轨状态事件</strong>会在每次开始播放都会有事件，歌词就是通过发送<strong>音轨状态事件</strong>来完成的。</p>\n<h4 id=\"注册事件-1\"><a href=\"#注册事件-1\" class=\"headerlink\" title=\"注册事件\"></a>注册事件</h4><p><code>PDU ID</code>：RegisterNotification，<code>Event ID</code>为: TrackChanged(<code>GetCapabilities</code>原语获取)。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 323\t1.331254\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t27\tSent Vendor dependent: Notify - RegisterNotification - TrackChanged</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    0000 .... = Reserved: 0x0</span><br><span class=\"line\">    .... 0011 = Ctype: Notify (0x3)</span><br><span class=\"line\">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class=\"line\">    .... .000 = Subunit ID: 0x0</span><br><span class=\"line\">    Opcode: Vendor dependent (0x00)</span><br><span class=\"line\">    Company ID: 00:19:58 (Bluetooth SIG, Inc.)</span><br><span class=\"line\">    PDU ID: RegisterNotification (0x31)</span><br><span class=\"line\">    0000 00.. = RFA: 0x00</span><br><span class=\"line\">    .... ..00 = Packet Type: Single (0x0)</span><br><span class=\"line\">    Parameter Length: 5</span><br><span class=\"line\">    Event ID: TrackChanged (0x02)</span><br><span class=\"line\">    Interval: 0</span><br><span class=\"line\">    [Response Time: 35/1000ms]</span><br><span class=\"line\">    [Response in frame: 330]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 330\t1.366518\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t31\tRcvd Vendor dependent: Interim - RegisterNotification - TrackChanged - 0xFFFFFFFFFFFFFFFF (NOT SELECTED)</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    0000 .... = Reserved: 0x0</span><br><span class=\"line\">    .... 1111 = Ctype: Interim (0xf)</span><br><span class=\"line\">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class=\"line\">    .... .000 = Subunit ID: 0x0</span><br><span class=\"line\">    Opcode: Vendor dependent (0x00)</span><br><span class=\"line\">    Company ID: 00:19:58 (Bluetooth SIG, Inc.)</span><br><span class=\"line\">    PDU ID: RegisterNotification (0x31)</span><br><span class=\"line\">    0000 00.. = RFA: 0x00</span><br><span class=\"line\">    .... ..00 = Packet Type: Single (0x0)</span><br><span class=\"line\">    Parameter Length: 9</span><br><span class=\"line\">    Event ID: TrackChanged (0x02)</span><br><span class=\"line\">    Identifier: 0xffffffffffffffff (NOT SELECTED)</span><br><span class=\"line\">    [Response Time: 35/1000ms]</span><br><span class=\"line\">    [Command in frame: 323]</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"事件通知-1\"><a href=\"#事件通知-1\" class=\"headerlink\" title=\"事件通知\"></a>事件通知</h4><p><code>PDU ID</code>：RegisterNotification，<code>Event ID</code>为: TrackChanged，通过<code>Ctype</code>来区分功能。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 451\t18.026715\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t31\tRcvd Vendor dependent: Changed - RegisterNotification - TrackChanged - 0x0000000000000000 (SELECTED)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"获取播放音轨的属性\"><a href=\"#获取播放音轨的属性\" class=\"headerlink\" title=\"获取播放音轨的属性\"></a>获取播放音轨的属性</h3><p>获取当前音轨，播放音乐的属性，如标题、歌手等信息。<code>Attribute List</code>请查看<a href=\"%E5%8F%82%E8%80%83\">AVRCP协议规范</a>第26章节，往往与<code>RegisterNotification-TrackChanged</code>命令配合使用。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 465\t18.050915\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t59\tSent Vendor dependent: Status - GetElementAttributes - 0x0000000000000000 (PLAYING)</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    0000 .... = Reserved: 0x0</span><br><span class=\"line\">    .... 0001 = Ctype: Status (0x1)</span><br><span class=\"line\">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class=\"line\">    .... .000 = Subunit ID: 0x0</span><br><span class=\"line\">    Opcode: Vendor dependent (0x00)</span><br><span class=\"line\">    Company ID: 00:19:58 (Bluetooth SIG, Inc.)</span><br><span class=\"line\">    PDU ID: GetElementAttributes (0x20)</span><br><span class=\"line\">    0000 00.. = RFA: 0x00</span><br><span class=\"line\">    .... ..00 = Packet Type: Single (0x0)</span><br><span class=\"line\">    Parameter Length: 37</span><br><span class=\"line\">    Identifier: 0x0000000000000000</span><br><span class=\"line\">    Number of Attributes: 7</span><br><span class=\"line\">    Attribute List</span><br><span class=\"line\">        Attribute ID: Title (0x00000001)</span><br><span class=\"line\">        Attribute ID: Artist (0x00000002)</span><br><span class=\"line\">        Attribute ID: Album (0x00000003)</span><br><span class=\"line\">        Attribute ID: Media Number (0x00000004)</span><br><span class=\"line\">        Attribute ID: Total Number of Media (0x00000005)</span><br><span class=\"line\">        Attribute ID: Genre (0x00000006)</span><br><span class=\"line\">        Attribute ID: Playing Time (0x00000007)</span><br><span class=\"line\">    [Response Time: 3/1000ms]</span><br><span class=\"line\">    [Response in frame: 469]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 469\t18.054345\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t127\tRcvd Vendor dependent: Stable - GetElementAttributes - Title: &quot;Demons&quot;</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    0000 .... = Reserved: 0x0</span><br><span class=\"line\">    .... 1100 = Ctype: Stable (0xc)</span><br><span class=\"line\">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class=\"line\">    .... .000 = Subunit ID: 0x0</span><br><span class=\"line\">    Opcode: Vendor dependent (0x00)</span><br><span class=\"line\">    Company ID: 00:19:58 (Bluetooth SIG, Inc.)</span><br><span class=\"line\">    PDU ID: GetElementAttributes (0x20)</span><br><span class=\"line\">    0000 00.. = RFA: 0x00</span><br><span class=\"line\">    .... ..00 = Packet Type: Single (0x0)</span><br><span class=\"line\">    Parameter Length: 105</span><br><span class=\"line\">    Number of Attributes: 7</span><br><span class=\"line\">    Attribute Entries</span><br><span class=\"line\">        Attribute [                Title]: Demons</span><br><span class=\"line\">        Attribute [               Artist]: Imagine Dragons</span><br><span class=\"line\">        Attribute [                Album]: Continued Silence</span><br><span class=\"line\">        Attribute [         Media Number]: 10</span><br><span class=\"line\">        Attribute [Total Number of Media]: 18</span><br><span class=\"line\">        Attribute [                Genre]: </span><br><span class=\"line\">        Attribute [         Playing Time]: 175000</span><br><span class=\"line\">    [Response Time: 3/1000ms]</span><br><span class=\"line\">    [Command in frame: 465]</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"播放器控制\"><a href=\"#播放器控制\" class=\"headerlink\" title=\"播放器控制\"></a>播放器控制</h3><p><strong>CT</strong>控制<strong>TG</strong>播放器的相关命令，都是PASS THROUGH类型，通过<code>Operation ID</code>来区分功能，通过<code>Ctype</code>来区分操作。</p>\n<h4 id=\"播放\"><a href=\"#播放\" class=\"headerlink\" title=\"播放\"></a>播放</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 298\t1.252592\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t17\tSent Pass Through: Control - PLAY (Pushed)</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    0000 .... = Reserved: 0x0</span><br><span class=\"line\">    .... 0000 = Ctype: Control (0x0)</span><br><span class=\"line\">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class=\"line\">    .... .000 = Subunit ID: 0x0</span><br><span class=\"line\">    Opcode: Pass Through (0x7c)</span><br><span class=\"line\">    0... .... = State: Pushed (0x0)</span><br><span class=\"line\">    .100 0100 = Operation ID: PLAY (0x44)</span><br><span class=\"line\">    Data Length: 0x00</span><br><span class=\"line\">    [Response Time: 14/200ms]</span><br><span class=\"line\">    [Response in frame: 308]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt;308\t1.266992\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t17\tRcvd Pass Through: Accepted - PLAY (Pushed)</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"暂停\"><a href=\"#暂停\" class=\"headerlink\" title=\"暂停\"></a>暂停</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 430\t7.424245\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t17\tSent Pass Through: Control - PAUSE (Pushed)</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    0000 .... = Reserved: 0x0</span><br><span class=\"line\">    .... 0000 = Ctype: Control (0x0)</span><br><span class=\"line\">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class=\"line\">    .... .000 = Subunit ID: 0x0</span><br><span class=\"line\">    Opcode: Pass Through (0x7c)</span><br><span class=\"line\">    0... .... = State: Pushed (0x0)</span><br><span class=\"line\">    .100 0110 = Operation ID: PAUSE (0x46)</span><br><span class=\"line\">    Data Length: 0x00</span><br><span class=\"line\">    [Response Time: 70/200ms]</span><br><span class=\"line\">    [Response in frame: 434]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 434\t7.494377\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t17\tRcvd Pass Through: Accepted - PAUSE (Pushed)</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"下一曲\"><a href=\"#下一曲\" class=\"headerlink\" title=\"下一曲\"></a>下一曲</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 1163\t40.755874\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t17\tSent Pass Through: Control - BACKWARD (Pushed)</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    0000 .... = Reserved: 0x0</span><br><span class=\"line\">    .... 0000 = Ctype: Control (0x0)</span><br><span class=\"line\">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class=\"line\">    .... .000 = Subunit ID: 0x0</span><br><span class=\"line\">    Opcode: Pass Through (0x7c)</span><br><span class=\"line\">    0... .... = State: Pushed (0x0)</span><br><span class=\"line\">    .100 1100 = Operation ID: BACKWARD (0x4c)</span><br><span class=\"line\">    Data Length: 0x00</span><br><span class=\"line\">    [Response Time: 15/200ms]</span><br><span class=\"line\">    [Response in frame: 1168]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 1168\t40.771498\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t17\tRcvd Pass Through: Accepted - BACKWARD (Pushed)</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"上一曲\"><a href=\"#上一曲\" class=\"headerlink\" title=\"上一曲\"></a>上一曲</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 969\t37.736799\tlocalhost ()\tXiaomiCo_6e:38:c5 (PHONE)\tAVRCP\t17\tSent Pass Through: Control - FORWARD (Pushed)</span><br><span class=\"line\">---------------------------------------------------------------------------</span><br><span class=\"line\">Bluetooth AVRCP Profile</span><br><span class=\"line\">    0000 .... = Reserved: 0x0</span><br><span class=\"line\">    .... 0000 = Ctype: Control (0x0)</span><br><span class=\"line\">    0100 1... = Subunit Type: Panel (0x09)</span><br><span class=\"line\">    .... .000 = Subunit ID: 0x0</span><br><span class=\"line\">    Opcode: Pass Through (0x7c)</span><br><span class=\"line\">    0... .... = State: Pushed (0x0)</span><br><span class=\"line\">    .100 1011 = Operation ID: FORWARD (0x4b)</span><br><span class=\"line\">    Data Length: 0x00</span><br><span class=\"line\">    [Response Time: 25/200ms]</span><br><span class=\"line\">    [Response in frame: 976]</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; 976\t37.762691\tXiaomiCo_6e:38:c5 (PHONE)\tlocalhost ()\tAVRCP\t17\tRcvd Pass Through: Accepted - FORWARD (Pushed)</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><ul>\n<li>蓝牙核心协议规范<a href=\"https://www.bluetooth.org/DocMan/handlers/DownloadDoc.ashx?doc_id=286439\">Core_v4.2.pdf</a></li>\n<li>PBAP协议规范<a href=\"https://www.bluetooth.com/specifications/specs/phone-book-access-profile-1-2-3/\">PBAP_v1.2.3.pdf</a></li>\n<li>HFP协议规范<a href=\"https://www.bluetooth.com/specifications/specs/hands-free-profile-1-8/\">HFP_v1.8.pdf</a></li>\n<li>AVDTP协议规范<a href=\"https://www.bluetooth.com/specifications/specs/a-v-distribution-transport-protocol-1-3/\">AVDTP_SPEC_V13.pdf</a></li>\n<li>AVCTP协议规范<a href=\"https://www.bluetooth.com/specifications/specs/a-v-%e2%80%8b%e2%80%8bcontrol-transport-protocol-1-4/\">AVCTP_SPEC_V14.pdf</a></li>\n<li>AVRCP协议规范<a href=\"https://www.bluetooth.com/specifications/specs/a-v-remote-control-profile-1-6-2/\">AVRCP_v1.6.2.pdf</a></li>\n<li><a href=\"https://blog.csdn.net/wenzongliang/article/details/84689377\">蓝牙物理链路类型：SCO和ACL链路与A2DP</a></li>\n<li><a href=\"https://blog.csdn.net/XiaoXiaoPengBo/article/details/107792407\">安全简单配对</a></li>\n<li><a href=\"https://blog.csdn.net/u010657219/article/details/42192481\">在HCI层看蓝牙的连接过程</a></li>\n<li><a href=\"https://www.cnblogs.com/libs-liu/p/9498952.html\">蓝牙SDP协议概述 </a></li>\n<li><a href=\"https://blog.csdn.net/XiaoXiaoPengBo/article/details/108125755\">RFCOMM协议概念介绍</a></li>\n<li><a href=\"https://blog.51cto.com/u_2982693/3521456\">蓝牙的OBEX协议</a></li>\n<li><a href=\"https://blog.csdn.net/weixin_44260005/article/details/105223139\">蓝牙电话之PBAP协议分析</a></li>\n<li><a href=\"https://blog.csdn.net/shichaog/article/details/52123439\">蓝牙之八-HFP</a></li>\n<li><a href=\"https://blog.csdn.net/shichaog/article/details/52126415\">蓝牙之九-AT命令</a></li>\n</ul>\n"}],"PostAsset":[],"PostCategory":[],"PostTag":[],"Tag":[]}}